/* Создание таблицы результатов доступных действиям */

CREATE TABLE /*PREFIX*/ACTION_RESULTS
(
  ACTION_ID VARCHAR(32) NOT NULL,
  RESULT_ID VARCHAR(32) NOT NULL,
  PRIORITY INTEGER NOT NULL,
  PRIMARY KEY (ACTION_ID,RESULT_ID),
  FOREIGN KEY (ACTION_ID) REFERENCES /*PREFIX*/ACTIONS (ACTION_ID),
  FOREIGN KEY (RESULT_ID) REFERENCES /*PREFIX*/RESULTS (RESULT_ID)
)

--

/* Создание просмотра таблицы результатов доступных действиям */

CREATE VIEW /*PREFIX*/S_ACTION_RESULTS
AS
SELECT AR.*,
       A.NAME AS ACTION_NAME,
       A.PURPOSE, 
       R.NAME AS RESULT_NAME,
       R.ACTION_ID AS RESULT_ACTION_ID,
       A1.NAME AS RESULT_ACTION_NAME, 
       R.PERIOD,
       R.RESULT_TYPE,
       R.CHOICE_DATE,
       R.CHOICE_PERFORMER
  FROM /*PREFIX*/ACTION_RESULTS AR
  JOIN /*PREFIX*/ACTIONS A ON A.ACTION_ID=AR.ACTION_ID
  JOIN /*PREFIX*/RESULTS R ON R.RESULT_ID=AR.RESULT_ID	
  LEFT JOIN /*PREFIX*/ACTIONS A1 ON A1.ACTION_ID=R.ACTION_ID

--

/* Создание процедуры добавления результата действию */

CREATE PROCEDURE /*PREFIX*/I_ACTION_RESULT
  @ACTION_ID VARCHAR(32),
  @RESULT_ID VARCHAR(32),
  @PRIORITY INTEGER
AS
BEGIN
  INSERT INTO /*PREFIX*/ACTION_RESULTS (ACTION_ID,RESULT_ID,PRIORITY)
       VALUES (@ACTION_ID,@RESULT_ID,@PRIORITY);
END;

--

/* Создание процедуры изменения результата у действия */

CREATE PROCEDURE /*PREFIX*/U_ACTION_RESULT
  @ACTION_ID VARCHAR(32),
  @RESULT_ID VARCHAR(32),
  @PRIORITY INTEGER,
  @OLD_ACTION_ID VARCHAR(32),
  @OLD_RESULT_ID VARCHAR(32)
AS
BEGIN
  UPDATE /*PREFIX*/ACTION_RESULTS
     SET ACTION_ID=@ACTION_ID,
         RESULT_ID=@RESULT_ID,
         PRIORITY=@PRIORITY
   WHERE ACTION_ID=@OLD_ACTION_ID
     AND RESULT_ID=@OLD_RESULT_ID;
END;

--

/* Создание процедуры удаления результата у действия */

CREATE PROCEDURE /*PREFIX*/D_ACTION_RESULT
  @OLD_ACTION_ID VARCHAR(32),
  @OLD_RESULT_ID VARCHAR(32)
AS
BEGIN
  DELETE FROM /*PREFIX*/ACTION_RESULTS 
        WHERE ACTION_ID=@OLD_ACTION_ID
          AND RESULT_ID=@OLD_RESULT_ID;
END;

--