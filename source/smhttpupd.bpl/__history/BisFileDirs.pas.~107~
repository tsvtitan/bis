unit BisFileDirs;

interface

uses Windows, SysUtils, Contnrs;

type

  TBisFileDir=class(TObject)
  private
    FIsDir: Boolean;
    FName: String;
    FParent: TBisFileDir;
    FSize: Int64;
    FAttribute: Integer;
    FCreationTime: TDateTime;
    FLastAccessTime: TDateTime;
    FLastWriteTime: TDateTime;
  public
    property Name: String read FName;
    property IsDir: Boolean read FIsDir;
    property Parent: TBisFileDir read FParent;
    property Size: Int64 read FSize;
    property Attribute: Integer read FAttribute;
    property CreationTime: TDateTime read FCreationTime;
    property LastAccessTime: TDateTime read FLastAccessTime;
    property LastWriteTime: TDateTime read FLastWriteTime; 
  end;

  TBisFileDirs=class(TObjectList)
  private
    function AddFileDir(Name: String; IsDir: Boolean; FileInfo: TSearchRec; Parent: TBisFileDir): TBisFileDir;
  public
    procedure Refresh(const Dir: String; OneLevel: Boolean; Parent: TBisFileDir=nil); overload;
  end;


implementation

{ TBisFileDirs }

function TBisFileDirs.AddFileDir(Name: String; IsDir: Boolean; FileInfo: TSearchRec; Parent: TBisFileDir): TBisFileDir;

  function FileTimeToDateTime(FileTime: TFileTime): TDateTime;
  var
    LocalFileTime: TFileTime;
    TimeExt: Integer;
  begin
    FileTimeToLocalFileTime(FileTime,LocalFileTime);
    FileTimeToDosDateTime(LocalFileTime,LongRec(TimeExt).Hi, LongRec(TimeExt).Lo);
    Result:=FileDateToDateTime(TimeExt);
  end;

begin
  Result:=TBisFileDir.Create;
  Result.FName:=Name;
  Result.FIsDir:=IsDir;
  Result.FParent:=Parent;
  if FileInfo<>'' then begin
    Result.Size:=FileInfo.Size;
    Result.Attribute:=FileInfo.Attr;
    if FileInfo.FindData<>'' then begin
      Result.CreationTime:=FileTimeToDateTime(FileInfo.FindData.ftCreationTime);
      Result.LastAccessTime:=FileTimeToDateTime(FileInfo.FindData.ftLastAccessTime);
      Result.LastWriteTime:=FileTimeToDateTime(FileInfo.FindData.ftLastWriteTime);
    end;
  end;
  inherited Add(Result);
end;

procedure TBisFileDirs.Refresh(const Dir: String; OneLevel: Boolean; Parent: TBisFileDir=nil);
var
  AttrWord: Word;
  FMask: String;
  MaskPtr: PChar;
  Ptr: Pchar;
  FileInfo: TSearchRec;
  Item: TBisFileDir;
  S: string;
begin
  if not DirectoryExists(Dir) then exit;
  AttrWord:=faAnyFile+faReadOnly+faHidden+faSysFile+faVolumeID+faDirectory+faArchive;
  if SetCurrentDirectory(Pchar(Dir)) then begin
    FMask:='*.*';
    try
      MaskPtr:=PChar(FMask);
      while MaskPtr <> nil do begin
        Ptr:=StrScan(MaskPtr, ';');
        if Ptr <> nil then
          Ptr^ := #0;
        if FindFirst(MaskPtr,AttrWord,FileInfo) = 0 then  begin
          repeat
            S:=Dir+PathDelim+FileInfo.Name;
            if FileInfo.Attr and faDirectory <> 0 then begin
              if (FileInfo.Name<>'.') and (FileInfo.Name<>'..') then begin
                Item:=AddFileDir(S,true,FileInfo,Parent);
                if not OneLevel then
                  Refresh(S,OneLevel,Item);
              end;
            end else
              AddFileDir(S,false,FileInfo,Parent);
          until FindNext(FileInfo) <> 0;
          FindClose(FileInfo);
        end;
        if Ptr <> nil then begin
          Ptr^ := ';';
          Inc (Ptr);
        end;
        MaskPtr := Ptr;
      end;
    finally

    end;
  end;
end;

end.
