/* Создание процедуры обработки результата */

CREATE PROCEDURE /*PREFIX*/PROCESS_RESULT
(
  OLD_ORDER_ID VARCHAR(32),
  NEW_ORDER_ID VARCHAR(32),
  RESULT_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
RETURNS
(
  ORDER_ID VARCHAR(32)
)
AS
  DECLARE PROC_PROCESS VARCHAR(100);
  DECLARE NEXT_ID VARCHAR(100);
  DECLARE SQL VARCHAR(1000);
  DECLARE AORDER_ID VARCHAR(32);
BEGIN
  ORDER_ID=OLD_ORDER_ID;

  SELECT PROC_PROCESS, NEXT_ID
    FROM /*PREFIX*/RESULTS
   WHERE RESULT_ID=:RESULT_ID
    INTO :PROC_PROCESS, :NEXT_ID;

  UPDATE /*PREFIX*/ORDERS
     SET RESULT_ID=:RESULT_ID,
         DATE_END=CURRENT_TIMESTAMP
   WHERE ORDER_ID=:OLD_ORDER_ID;

  IF (NEXT_ID IS NOT NULL) THEN BEGIN

    EXECUTE PROCEDURE /*PREFIX*/CREATE_ORDER_HISTORY(OLD_ORDER_ID,NEW_ORDER_ID,ACCOUNT_ID,
                                                     NEXT_ID,NULL,0,NULL,1);
    ORDER_ID=NEW_ORDER_ID;
  END


  IF (TRIM(PROC_PROCESS)<>'') THEN BEGIN

    SQL='EXECUTE PROCEDURE '||PROC_PROCESS||'('''||ORDER_ID||''','''||ACCOUNT_ID||''');';
    EXECUTE STATEMENT SQL;

  END
END

--

/* Фиксация изменений */

COMMIT