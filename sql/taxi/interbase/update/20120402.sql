CREATE OR ALTER PROCEDURE GET_MENUS_TREE
(
  PARENT_ID VARCHAR(32),
  IN_LEVEL INTEGER,
  IN_SORT INTEGER
)
RETURNS
(
  MENU_ID VARCHAR(32),
  OUT_LEVEL INTEGER,
  OUT_SORT INTEGER
)
AS
DECLARE VARIABLE ID VARCHAR(32);
DECLARE VARIABLE L INTEGER;
DECLARE VARIABLE S INTEGER;
BEGIN

  IF (IN_LEVEL IS NULL) THEN
    L=0;
  ELSE
    L=IN_LEVEL;

  IF (IN_SORT IS NULL) THEN
    S=0;
  ELSE
    S=IN_SORT;

  IF (PARENT_ID IS NOT NULL) THEN BEGIN

    FOR SELECT MENU_ID
          FROM MENUS
         WHERE PARENT_ID=:PARENT_ID
         ORDER BY PRIORITY
          INTO :ID  DO BEGIN

      MENU_ID=ID;
      OUT_LEVEL=L;
      S=S+1;
      OUT_SORT=S;
      SUSPEND;

      FOR SELECT MENU_ID, OUT_LEVEL, OUT_SORT
           FROM GET_MENUS_TREE(:ID,:L+1,:S)
           INTO :ID, :OUT_LEVEL, :S DO BEGIN

        MENU_ID=ID;
        OUT_SORT=S;
        SUSPEND;

      END
    END

  END ELSE BEGIN

    FOR SELECT MENU_ID
          FROM MENUS
         WHERE PARENT_ID IS NULL
         ORDER BY PRIORITY
          INTO :ID  DO BEGIN

      MENU_ID=ID;
      OUT_LEVEL=L;
      S=S+1;
      OUT_SORT=S;
      SUSPEND;

      FOR SELECT MENU_ID, OUT_LEVEL, OUT_SORT
           FROM GET_MENUS_TREE(:ID,:L+1,:S)
           INTO :ID, :OUT_LEVEL, :S DO BEGIN

        MENU_ID=ID;
        OUT_SORT=S;
        SUSPEND;

      END
    END

  END
END

--

CREATE OR ALTER VIEW S_MENUS
AS
SELECT M.*,
       I.NAME AS INTERFACE_NAME,
       M1.NAME AS PARENT_NAME
  FROM GET_MENUS_TREE(NULL,1,0) GMT
  JOIN MENUS M ON M.MENU_ID=GMT.MENU_ID
  LEFT JOIN INTERFACES I ON I.INTERFACE_ID=M.INTERFACE_ID
  LEFT JOIN MENUS M1 ON M1.MENU_ID=M.PARENT_ID
  ORDER BY GMT.OUT_SORT

--

CREATE OR ALTER PROCEDURE GET_FIRMS_TREE
(
  PARENT_ID VARCHAR(32),
  IN_LEVEL INTEGER,
  IN_SORT INTEGER
)
RETURNS
(
  FIRM_ID VARCHAR(32),
  OUT_LEVEL INTEGER,
  OUT_SORT INTEGER
)
AS
DECLARE VARIABLE ID VARCHAR(32);
DECLARE VARIABLE L INTEGER;
DECLARE VARIABLE S INTEGER;
BEGIN

  IF (IN_LEVEL IS NULL) THEN
    L=0;
  ELSE
    L=IN_LEVEL;

  IF (IN_SORT IS NULL) THEN
    S=0;
  ELSE
    S=IN_SORT;

  IF (PARENT_ID IS NOT NULL) THEN BEGIN

    FOR SELECT FIRM_ID
          FROM FIRMS
         WHERE PARENT_ID=:PARENT_ID
         ORDER BY SMALL_NAME
          INTO :ID  DO BEGIN

      FIRM_ID=ID;
      OUT_LEVEL=L;
      S=S+1;
      OUT_SORT=S;
      SUSPEND;

      FOR SELECT FIRM_ID, OUT_LEVEL, OUT_SORT
           FROM GET_FIRMS_TREE(:ID,:L+1,:S)
           INTO :ID, :OUT_LEVEL, :S DO BEGIN

        FIRM_ID=ID;
        OUT_SORT=S;
        SUSPEND;

      END
    END

  END ELSE BEGIN

    FOR SELECT FIRM_ID
          FROM FIRMS
         WHERE PARENT_ID IS NULL
         ORDER BY SMALL_NAME
          INTO :ID  DO BEGIN

      FIRM_ID=ID;
      OUT_LEVEL=L;
      S=S+1;
      OUT_SORT=S;
      SUSPEND;

      FOR SELECT FIRM_ID, OUT_LEVEL, OUT_SORT
           FROM GET_FIRMS_TREE(:ID,:L+1,:S)
           INTO :ID, :OUT_LEVEL, :S DO BEGIN

        FIRM_ID=ID;
        OUT_SORT=S;
        SUSPEND;

      END
    END

  END
END

--

CREATE OR ALTER VIEW S_FIRMS
AS
  SELECT F.*,
         FT.NAME AS FIRM_TYPE_NAME,
         F1.SMALL_NAME AS PARENT_SMALL_NAME,
         S1.NAME AS STREET_LEGAL_NAME,
         S1.PREFIX AS STREET_LEGAL_PREFIX,
         L1.LOCALITY_ID AS LOCALITY_LEGAL_ID,
         L1.NAME AS LOCALITY_LEGAL_NAME,
         L1.PREFIX AS LOCALITY_LEGAL_PREFIX,
         S2.NAME AS STREET_POST_NAME,
         S2.PREFIX AS STREET_POST_PREFIX,
         L2.LOCALITY_ID AS LOCALITY_POST_ID,
         L2.NAME AS LOCALITY_POST_NAME,
         L2.PREFIX AS LOCALITY_POST_PREFIX
    FROM GET_FIRMS_TREE(NULL,1,0) GFT
    JOIN FIRMS F ON F.FIRM_ID=GFT.FIRM_ID
    JOIN FIRM_TYPES FT ON FT.FIRM_TYPE_ID=F.FIRM_TYPE_ID
    LEFT JOIN STREETS S1 ON S1.STREET_ID=F.STREET_LEGAL_ID
    LEFT JOIN LOCALITIES L1 ON L1.LOCALITY_ID=S1.LOCALITY_ID
    LEFT JOIN STREETS S2 ON S2.STREET_ID=F.STREET_POST_ID
    LEFT JOIN LOCALITIES L2 ON L2.LOCALITY_ID=S2.LOCALITY_ID
    LEFT JOIN FIRMS F1 ON F1.FIRM_ID=F.PARENT_ID
   ORDER BY GFT.OUT_SORT

--

CREATE OR ALTER PROCEDURE GET_ROLES_ACCOUNTS_TREE
RETURNS
(
  ACCOUNT_ID VARCHAR(32),
  PARENT_ID VARCHAR(32)
)
AS
DECLARE ROLE_ID VARCHAR(32);
BEGIN

  FOR SELECT ACCOUNT_ID, NULL
        FROM ACCOUNTS
       WHERE IS_ROLE=1
         AND LOCKED=0
       ORDER BY USER_NAME
        INTO :ROLE_ID, :PARENT_ID DO BEGIN

    ACCOUNT_ID=ROLE_ID;

    SUSPEND;

    FOR SELECT AR.ACCOUNT_ID
          FROM ACCOUNT_ROLES AR
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=AR.ACCOUNT_ID
         WHERE AR.ROLE_ID=:ROLE_ID
           AND A.LOCKED=0
         ORDER BY A.USER_NAME
          INTO :ACCOUNT_ID DO BEGIN

      PARENT_ID=ROLE_ID;

      SUSPEND;

    END

  END

  PARENT_ID=NULL;

  FOR SELECT ACCOUNT_ID
        FROM ACCOUNTS
       WHERE IS_ROLE=0
         AND LOCKED=0
         AND ACCOUNT_ID NOT IN (SELECT ACCOUNT_ID
                                  FROM ACCOUNT_ROLES)
       ORDER BY USER_NAME
        INTO :ACCOUNT_ID DO BEGIN

    SUSPEND;

  END

END

--

CREATE OR ALTER VIEW S_ROLES_ACCOUNTS
AS
SELECT GRAT.*,
       A.USER_NAME,
       A.NAME,
       A.SURNAME,
       A.PATRONYMIC,
       A.PHONE
  FROM GET_ROLES_ACCOUNTS_TREE GRAT
  LEFT JOIN ACCOUNTS A ON A.ACCOUNT_ID=GRAT.ACCOUNT_ID

--

CREATE OR ALTER VIEW S_EXCHANGES
AS
SELECT *
  FROM EXCHANGES
 ORDER BY PRIORITY

--

ALTER TABLE APPLICATIONS
ADD VERSION VARCHAR(50)

--

CREATE OR ALTER VIEW S_APPLICATIONS
AS
SELECT *
  FROM APPLICATIONS
 ORDER BY NAME

--

CREATE OR ALTER PROCEDURE I_APPLICATION
(
  APPLICATION_ID VARCHAR(32),
  NAME VARCHAR(100),
  DESCRIPTION VARCHAR(250),
  LOCKED INTEGER,
  VERSION VARCHAR(50)
)
AS
BEGIN
  INSERT INTO APPLICATIONS (APPLICATION_ID,NAME,DESCRIPTION,LOCKED,VERSION)
       VALUES (:APPLICATION_ID,:NAME,:DESCRIPTION,:LOCKED,:VERSION);
END

--

CREATE OR ALTER PROCEDURE U_APPLICATION
(
  APPLICATION_ID VARCHAR(32),
  NAME VARCHAR(100),
  DESCRIPTION VARCHAR(250),
  LOCKED INTEGER,
  VERSION VARCHAR(50),
  OLD_APPLICATION_ID VARCHAR(32)
)
AS
BEGIN
  UPDATE APPLICATIONS
     SET APPLICATION_ID=:APPLICATION_ID,
         NAME=:NAME,
         DESCRIPTION=:DESCRIPTION,
         LOCKED=:LOCKED,
         VERSION=:VERSION
   WHERE APPLICATION_ID=:OLD_APPLICATION_ID;
END

--

UPDATE APPLICATIONS
   SET VERSION='2.0'

--

ALTER TABLE TASKS
ADD OFFSET INTEGER

--

CREATE OR ALTER VIEW S_TASKS
AS
SELECT T.*,
       A.NAME AS APPLICATION_NAME,
       AC.USER_NAME,
       I.NAME AS INTERFACE_NAME
  FROM TASKS T
  JOIN APPLICATIONS A ON A.APPLICATION_ID=T.APPLICATION_ID
  LEFT JOIN ACCOUNTS AC ON AC.ACCOUNT_ID=T.ACCOUNT_ID
  LEFT JOIN INTERFACES I ON I.INTERFACE_ID=T.INTERFACE_ID
 ORDER BY T.DATE_BEGIN

--

CREATE OR ALTER PROCEDURE I_TASK
(
    SESSION_ID VARCHAR(32),
    TASK_ID VARCHAR(32),
    APPLICATION_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32),
    INTERFACE_ID VARCHAR(32),
    NAME VARCHAR(100),
    DESCRIPTION VARCHAR(250),
    DATE_BEGIN TIMESTAMP,
    OFFSET INTEGER,
    DATE_END TIMESTAMP,
    SCHEDULE INTEGER,
    PRIORITY INTEGER,
    ENABLED INTEGER,
    PROC_NAME VARCHAR(100),
    COMMAND_STRING VARCHAR(250),
    REPEAT_ENABLED INTEGER,
    REPEAT_TYPE INTEGER,
    REPEAT_VALUE INTEGER,
    REPEAT_COUNT INTEGER,
    DAY_FREQUENCY INTEGER,
    WEEK_FREQUENCY INTEGER,
    MONDAY INTEGER,
    TUESDAY INTEGER,
    WEDNESDAY INTEGER,
    THURSDAY INTEGER,
    FRIDAY INTEGER,
    SATURDAY INTEGER,
    SUNDAY INTEGER,
    MONTH_DAY INTEGER,
    JANUARY INTEGER,
    FEBRUARY INTEGER,
    MARCH INTEGER,
    APRIL INTEGER,
    MAY INTEGER,
    JUNE INTEGER,
    JULY INTEGER,
    AUGUST INTEGER,
    SEPTEMBER INTEGER,
    OCTOBER INTEGER,
    NOVEMBER INTEGER,
    DECEMBER INTEGER,
    DATE_EXECUTE TIMESTAMP,
    RESULT_STRING VARCHAR(250)
)
AS
BEGIN
  IN AUTONOMOUS TRANSACTION DO BEGIN
  
    INSERT INTO TASKS (TASK_ID,APPLICATION_ID,ACCOUNT_ID,INTERFACE_ID,NAME,DESCRIPTION,DATE_BEGIN,OFFSET,
                       DATE_END,SCHEDULE,PRIORITY,ENABLED,PROC_NAME,COMMAND_STRING,REPEAT_ENABLED,
                       REPEAT_TYPE,REPEAT_VALUE,REPEAT_COUNT,DAY_FREQUENCY,WEEK_FREQUENCY,
                       MONDAY,TUESDAY,WEDNESDAY,THURSDAY,FRIDAY,SATURDAY,SUNDAY,MONTH_DAY,
                       JANUARY,FEBRUARY,MARCH,APRIL,MAY,JUNE,JULY,AUGUST,SEPTEMBER,OCTOBER,NOVEMBER,DECEMBER,
                       DATE_EXECUTE,RESULT_STRING)
         VALUES (:TASK_ID,:APPLICATION_ID,:ACCOUNT_ID,:INTERFACE_ID,:NAME,:DESCRIPTION,:DATE_BEGIN,:OFFSET,
                 :DATE_END,:SCHEDULE,:PRIORITY,:ENABLED,:PROC_NAME,:COMMAND_STRING,:REPEAT_ENABLED,
                 :REPEAT_TYPE,:REPEAT_VALUE,:REPEAT_COUNT,:DAY_FREQUENCY,:WEEK_FREQUENCY,
                 :MONDAY,:TUESDAY,:WEDNESDAY,:THURSDAY,:FRIDAY,:SATURDAY,:SUNDAY,:MONTH_DAY,
                 :JANUARY,:FEBRUARY,:MARCH,:APRIL,:MAY,:JUNE,:JULY,:AUGUST,:SEPTEMBER,:OCTOBER,:NOVEMBER,:DECEMBER,
                 :DATE_EXECUTE,:RESULT_STRING);
  END

  EXECUTE PROCEDURE EVENT_REFRESH_TASKS(APPLICATION_ID,ACCOUNT_ID,SESSION_ID,0);

END

--

CREATE OR ALTER PROCEDURE U_TASK
(
    SESSION_ID VARCHAR(32),
    TASK_ID VARCHAR(32),
    APPLICATION_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32),
    INTERFACE_ID VARCHAR(32),
    NAME VARCHAR(100),
    DESCRIPTION VARCHAR(250),
    DATE_BEGIN TIMESTAMP,
    OFFSET INTEGER,
    DATE_END TIMESTAMP,
    SCHEDULE INTEGER,
    PRIORITY INTEGER,
    ENABLED INTEGER,
    PROC_NAME VARCHAR(100),
    COMMAND_STRING VARCHAR(250),
    REPEAT_ENABLED INTEGER,
    REPEAT_TYPE INTEGER,
    REPEAT_VALUE INTEGER,
    REPEAT_COUNT INTEGER,
    DAY_FREQUENCY INTEGER,
    WEEK_FREQUENCY INTEGER,
    MONDAY INTEGER,
    TUESDAY INTEGER,
    WEDNESDAY INTEGER,
    THURSDAY INTEGER,
    FRIDAY INTEGER,
    SATURDAY INTEGER,
    SUNDAY INTEGER,
    MONTH_DAY INTEGER,
    JANUARY INTEGER,
    FEBRUARY INTEGER,
    MARCH INTEGER,
    APRIL INTEGER,
    MAY INTEGER,
    JUNE INTEGER,
    JULY INTEGER,
    AUGUST INTEGER,
    SEPTEMBER INTEGER,
    OCTOBER INTEGER,
    NOVEMBER INTEGER,
    DECEMBER INTEGER,
    DATE_EXECUTE TIMESTAMP,
    RESULT_STRING VARCHAR(250),
    OLD_TASK_ID VARCHAR(32)
)
AS
DECLARE VARIABLE OLD_APPLICATION_ID VARCHAR(32);
DECLARE VARIABLE OLD_ACCOUNT_ID VARCHAR(32);
BEGIN

  SELECT APPLICATION_ID, ACCOUNT_ID
    FROM TASKS
   WHERE TASK_ID=:OLD_TASK_ID
    INTO :OLD_APPLICATION_ID, :OLD_ACCOUNT_ID;

  IN AUTONOMOUS TRANSACTION DO BEGIN

    UPDATE TASKS
       SET TASK_ID=:TASK_ID,
           APPLICATION_ID=:APPLICATION_ID,
           ACCOUNT_ID=:ACCOUNT_ID,
           INTERFACE_ID=:INTERFACE_ID,
           NAME=:NAME,
           DESCRIPTION=:DESCRIPTION,
           DATE_BEGIN=:DATE_BEGIN,
           OFFSET=:OFFSET,
           DATE_END=:DATE_END,
           SCHEDULE=:SCHEDULE,
           PRIORITY=:PRIORITY,
           ENABLED=:ENABLED,
           PROC_NAME=:PROC_NAME,
           COMMAND_STRING=:COMMAND_STRING,
           REPEAT_ENABLED=:REPEAT_ENABLED,
           REPEAT_TYPE=:REPEAT_TYPE,
           REPEAT_VALUE=:REPEAT_VALUE,
           REPEAT_COUNT=:REPEAT_COUNT,
           DAY_FREQUENCY=:DAY_FREQUENCY,
           WEEK_FREQUENCY=:WEEK_FREQUENCY,
           MONDAY=:MONDAY,
           TUESDAY=:TUESDAY,
           WEDNESDAY=:WEDNESDAY,
           THURSDAY=:THURSDAY,
           FRIDAY=:FRIDAY,
           SATURDAY=:SATURDAY,
           SUNDAY=:SUNDAY,
           MONTH_DAY=:MONTH_DAY,
           JANUARY=:JANUARY,
           FEBRUARY=:FEBRUARY,
           MARCH=:MARCH,
           APRIL=:APRIL,
           MAY=:MAY,
           JUNE=:JUNE,
           JULY=:JULY,
           AUGUST=:AUGUST,
           SEPTEMBER=:SEPTEMBER,
           OCTOBER=:OCTOBER,
           NOVEMBER=:NOVEMBER,
           DECEMBER=:DECEMBER,
           DATE_EXECUTE=:DATE_EXECUTE,
           RESULT_STRING=:RESULT_STRING
     WHERE TASK_ID=:OLD_TASK_ID;
     
  END

  EXECUTE PROCEDURE EVENT_REFRESH_TASKS(APPLICATION_ID,ACCOUNT_ID,SESSION_ID,0);
  
  IF ((OLD_APPLICATION_ID<>APPLICATION_ID) OR (OLD_ACCOUNT_ID<>ACCOUNT_ID)) THEN
    EXECUTE PROCEDURE EVENT_REFRESH_TASKS(OLD_APPLICATION_ID,OLD_ACCOUNT_ID,SESSION_ID,0);
  
END

--

CREATE OR ALTER PROCEDURE GET_CLIENT_GROUPS_TREE
(
  PARENT_ID VARCHAR(32),
  IN_LEVEL INTEGER,
  IN_SORT INTEGER
)
RETURNS
(
  CLIENT_GROUP_ID VARCHAR(32),
  OUT_LEVEL INTEGER,
  OUT_SORT INTEGER
)
AS
DECLARE VARIABLE ID VARCHAR(32);
DECLARE VARIABLE L INTEGER;
DECLARE VARIABLE S INTEGER;
BEGIN

  IF (IN_LEVEL IS NULL) THEN
    L=0;
  ELSE
    L=IN_LEVEL;

  IF (IN_SORT IS NULL) THEN
    S=0;
  ELSE
    S=IN_SORT;

  IF (PARENT_ID IS NOT NULL) THEN BEGIN

    FOR SELECT CLIENT_GROUP_ID
          FROM CLIENT_GROUPS
         WHERE PARENT_ID=:PARENT_ID
         ORDER BY PRIORITY
          INTO :ID  DO BEGIN

      CLIENT_GROUP_ID=ID;
      OUT_LEVEL=L;
      S=S+1;
      OUT_SORT=S;
      SUSPEND;

      FOR SELECT CLIENT_GROUP_ID, OUT_LEVEL, OUT_SORT
           FROM GET_CLIENT_GROUPS_TREE(:ID,:L+1,:S)
           INTO :ID, :OUT_LEVEL, :S DO BEGIN

        CLIENT_GROUP_ID=ID;
        OUT_SORT=S;
        SUSPEND;

      END
    END

  END ELSE BEGIN

    FOR SELECT CLIENT_GROUP_ID
          FROM CLIENT_GROUPS
         WHERE PARENT_ID IS NULL
         ORDER BY PRIORITY
          INTO :ID  DO BEGIN

      CLIENT_GROUP_ID=ID;
      OUT_LEVEL=L;
      S=S+1;
      OUT_SORT=S;
      SUSPEND;

      FOR SELECT CLIENT_GROUP_ID, OUT_LEVEL, OUT_SORT
           FROM GET_CLIENT_GROUPS_TREE(:ID,:L+1,:S)
           INTO :ID, :OUT_LEVEL, :S DO BEGIN

        CLIENT_GROUP_ID=ID;
        OUT_SORT=S;
        SUSPEND;

      END
    END

  END
END

--

CREATE OR ALTER VIEW S_CLIENT_GROUPS
AS
SELECT CG.*,
       CG1.NAME AS PARENT_NAME
  FROM GET_CLIENT_GROUPS_TREE(NULL,1,0) GCGT
  JOIN CLIENT_GROUPS CG ON CG.CLIENT_GROUP_ID=GCGT.CLIENT_GROUP_ID
  LEFT JOIN CLIENT_GROUPS CG1 ON CG1.CLIENT_GROUP_ID=CG.PARENT_ID
 ORDER BY GCGT.OUT_SORT

--

CREATE OR ALTER PROCEDURE GET_GROUPS_CLIENTS_TREE
(
  IN_PARENT_ID VARCHAR(32),
  IN_LEVEL INTEGER,
  IN_SORT INTEGER
)
RETURNS
(
  OUT_ID VARCHAR(32),
  OUT_PARENT_ID VARCHAR(32),
  OUT_LEVEL INTEGER,
  OUT_SORT INTEGER,
  IS_GROUP INTEGER
)
AS
DECLARE VARIABLE ID VARCHAR(32);
DECLARE TEMP_ID VARCHAR(32);
DECLARE VARIABLE L INTEGER;
DECLARE VARIABLE S INTEGER;
BEGIN

  IF (IN_LEVEL IS NULL) THEN
    L=0;
  ELSE
    L=IN_LEVEL;

  IF (IN_SORT IS NULL) THEN
    S=0;
  ELSE
    S=IN_SORT;

  OUT_SORT=S;

  IF (IN_PARENT_ID IS NOT NULL) THEN BEGIN

    FOR SELECT CLIENT_GROUP_ID, :IN_PARENT_ID, 1
          FROM CLIENT_GROUPS
         WHERE PARENT_ID=:IN_PARENT_ID
         ORDER BY PRIORITY
          INTO :TEMP_ID, :OUT_PARENT_ID, :IS_GROUP  DO BEGIN

      OUT_ID=TEMP_ID;
      OUT_LEVEL=L;
      OUT_SORT=OUT_SORT+1;

      SUSPEND;

      FOR SELECT OUT_ID, IS_GROUP, OUT_PARENT_ID, OUT_LEVEL, OUT_SORT
           FROM GET_GROUPS_CLIENTS_TREE(:TEMP_ID,:L+1,:OUT_SORT)
           INTO :OUT_ID, :IS_GROUP, :OUT_PARENT_ID, :OUT_LEVEL, :OUT_SORT DO BEGIN

        SUSPEND;

      END

      FOR SELECT C.CLIENT_ID, :TEMP_ID, 0
            FROM CLIENTS C
            JOIN ACCOUNTS A ON A.ACCOUNT_ID=C.CLIENT_ID
           WHERE C.CLIENT_GROUP_ID=:TEMP_ID
           ORDER BY A.USER_NAME
            INTO :OUT_ID, :OUT_PARENT_ID, :IS_GROUP DO BEGIN

        OUT_LEVEL=L+1;
        OUT_SORT=OUT_SORT+1;

        SUSPEND;

      END

    END

  END ELSE BEGIN

    FOR SELECT CLIENT_GROUP_ID, NULL, 1
          FROM CLIENT_GROUPS
         WHERE PARENT_ID IS NULL
         ORDER BY PRIORITY
          INTO :TEMP_ID, :OUT_PARENT_ID, :IS_GROUP  DO BEGIN

      OUT_ID=TEMP_ID;
      OUT_LEVEL=L;
      OUT_SORT=OUT_SORT+1;

      SUSPEND;

      FOR SELECT OUT_ID, IS_GROUP, OUT_PARENT_ID, OUT_LEVEL, OUT_SORT
           FROM GET_GROUPS_CLIENTS_TREE(:TEMP_ID,:L+1,:OUT_SORT)
           INTO :OUT_ID, :IS_GROUP, :OUT_PARENT_ID, :OUT_LEVEL, :OUT_SORT DO BEGIN

        SUSPEND;

      END

      FOR SELECT C.CLIENT_ID, :TEMP_ID, 0
            FROM CLIENTS C
            JOIN ACCOUNTS A ON A.ACCOUNT_ID=C.CLIENT_ID
           WHERE C.CLIENT_GROUP_ID=:TEMP_ID
           ORDER BY A.USER_NAME
            INTO :OUT_ID, :OUT_PARENT_ID, :IS_GROUP DO BEGIN

        OUT_LEVEL=L+1;
        OUT_SORT=OUT_SORT+1;

        SUSPEND;

      END

    END

    FOR SELECT C.CLIENT_ID, NULL, 0
          FROM CLIENTS C
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=C.CLIENT_ID
         WHERE C.CLIENT_GROUP_ID IS NULL
         ORDER BY A.USER_NAME
          INTO :OUT_ID, :OUT_PARENT_ID, :IS_GROUP DO BEGIN

      OUT_LEVEL=L;
      OUT_SORT=OUT_SORT+1;

      SUSPEND;

    END

  END
END

--

ALTER TABLE ACCOUNTS
ADD DATE_LOCK TIMESTAMP

--

ALTER TABLE ACCOUNTS
ADD REASON_LOCK VARCHAR(100)

--

CREATE OR ALTER VIEW S_GROUPS_CLIENTS
AS
SELECT GGCT.OUT_ID AS ID,
       GGCT.OUT_PARENT_ID AS PARENT_ID,
       GGCT.IS_GROUP,
       CASE
         WHEN GGCT.IS_GROUP=1 THEN CG.NAME
         ELSE A.USER_NAME
       END AS NEW_NAME,
       CASE
         WHEN GGCT.IS_GROUP=1 THEN CG.DESCRIPTION
         ELSE A.DESCRIPTION
       END AS DESCRIPTION,
       CG1.NAME AS PARENT_NAME, 
       CG.PRIORITY,
       C.*,
       A.PHONE,
       A."PASSWORD",
       A.DATE_CREATE,
       A.LOCKED,
       A.SURNAME,
       A.NAME,
       A.PATRONYMIC,
       A.FIRM_ID,
       A.JOB_TITLE,
       A.DATE_LOCK,
       A.REASON_LOCK,
       CL.NAME AS CALC_NAME,
       S.NAME AS SOURCE_NAME,
       M.NAME AS METHOD_NAME,
       F.SMALL_NAME AS FIRM_SMALL_NAME,
       S1.NAME AS STREET_NAME,
       S1.PREFIX AS STREET_PREFIX,
       L1.LOCALITY_ID AS LOCALITY_ID,
       L1.NAME AS LOCALITY_NAME,
       L1.PREFIX AS LOCALITY_PREFIX
  FROM GET_GROUPS_CLIENTS_TREE(NULL,1,0) GGCT
  LEFT JOIN CLIENT_GROUPS CG ON CG.CLIENT_GROUP_ID=GGCT.OUT_ID
  LEFT JOIN CLIENT_GROUPS CG1 ON CG1.CLIENT_GROUP_ID=GGCT.OUT_PARENT_ID
  LEFT JOIN CLIENTS C ON C.CLIENT_ID=GGCT.OUT_ID
  LEFT JOIN ACCOUNTS A ON A.ACCOUNT_ID=C.CLIENT_ID
  LEFT JOIN CALCS CL ON CL.CALC_ID=C.CALC_ID
  LEFT JOIN SOURCES S ON S.SOURCE_ID=C.SOURCE_ID
  LEFT JOIN METHODS M ON M.METHOD_ID=C.METHOD_ID
  LEFT JOIN FIRMS F ON F.FIRM_ID=A.FIRM_ID
  LEFT JOIN STREETS S1 ON S1.STREET_ID=C.STREET_ID
  LEFT JOIN LOCALITIES L1 ON L1.LOCALITY_ID=S1.LOCALITY_ID
 ORDER BY GGCT.OUT_SORT

--

CREATE OR ALTER VIEW S_OPERATORS
AS
SELECT *
  FROM OPERATORS
 ORDER BY PRIORITY

--

CREATE OR ALTER VIEW S_ACCOUNTS
AS
SELECT A.*, 
       F.SMALL_NAME AS FIRM_SMALL_NAME
  FROM ACCOUNTS A
  LEFT JOIN FIRMS F ON F.FIRM_ID=A.FIRM_ID
 ORDER BY A.USER_NAME

--

CREATE OR ALTER PROCEDURE I_ACCOUNT
(
  ACCOUNT_ID VARCHAR(32),
  FIRM_ID VARCHAR(32),
  DATE_CREATE TIMESTAMP,
  USER_NAME VARCHAR(100),
  "PASSWORD" VARCHAR(100),
  DESCRIPTION VARCHAR(250),
  DB_USER_NAME VARCHAR(100),
  DB_PASSWORD VARCHAR(100),
  IS_ROLE INTEGER,
  LOCKED INTEGER,
  AUTO_CREATED INTEGER,
  SURNAME VARCHAR(100),
  NAME VARCHAR(100),
  PATRONYMIC VARCHAR(100),
  PHONE VARCHAR(100),
  EMAIL VARCHAR(100),
  PHOTO BLOB,
  JOB_TITLE VARCHAR(250),
  PHONE_INTERNAL VARCHAR(100),
  DATE_LOCK TIMESTAMP, 
  REASON_LOCK VARCHAR(100)
)
AS
BEGIN
  INSERT INTO ACCOUNTS (ACCOUNT_ID,FIRM_ID,DATE_CREATE,USER_NAME,"PASSWORD",DESCRIPTION,DB_USER_NAME,DB_PASSWORD,
                        IS_ROLE,LOCKED,AUTO_CREATED,SURNAME,NAME,PATRONYMIC,PHONE,EMAIL,PHOTO,JOB_TITLE,
                        PHONE_INTERNAL,DATE_LOCK,REASON_LOCK)
       VALUES (:ACCOUNT_ID,:FIRM_ID,:DATE_CREATE,:USER_NAME,:"PASSWORD",:DESCRIPTION,:DB_USER_NAME,:DB_PASSWORD,
               :IS_ROLE,:LOCKED,:AUTO_CREATED,:SURNAME,:NAME,:PATRONYMIC,:PHONE,:EMAIL,:PHOTO,:JOB_TITLE,
               :PHONE_INTERNAL,:DATE_LOCK,:REASON_LOCK);
END

--

CREATE OR ALTER PROCEDURE U_ACCOUNT
(
  ACCOUNT_ID VARCHAR(32),
  FIRM_ID VARCHAR(32),
  DATE_CREATE TIMESTAMP,
  USER_NAME VARCHAR(100),
  "PASSWORD" VARCHAR(100),
  DESCRIPTION VARCHAR(250),
  DB_USER_NAME VARCHAR(100),
  DB_PASSWORD VARCHAR(100),
  IS_ROLE INTEGER,
  LOCKED INTEGER,
  AUTO_CREATED INTEGER,
  SURNAME VARCHAR(100),
  NAME VARCHAR(100),
  PATRONYMIC VARCHAR(100),
  PHONE VARCHAR(100),
  EMAIL VARCHAR(100),
  PHOTO BLOB,
  JOB_TITLE VARCHAR(250),
  PHONE_INTERNAL VARCHAR(100),
  DATE_LOCK TIMESTAMP, 
  REASON_LOCK VARCHAR(100),
  OLD_ACCOUNT_ID VARCHAR(32)
)
AS
BEGIN
  UPDATE ACCOUNTS
     SET ACCOUNT_ID=:ACCOUNT_ID,
         FIRM_ID=:FIRM_ID,
         DATE_CREATE=:DATE_CREATE,
         USER_NAME=:USER_NAME,
         "PASSWORD"=:"PASSWORD",
         DESCRIPTION=:DESCRIPTION,
         DB_USER_NAME=:DB_USER_NAME,
         DB_PASSWORD=:DB_PASSWORD,
         IS_ROLE=:IS_ROLE,
         LOCKED=:LOCKED,
         AUTO_CREATED=:AUTO_CREATED,
         SURNAME=:SURNAME,
         NAME=:NAME,
         PATRONYMIC=:PATRONYMIC,
         PHONE=:PHONE,
         EMAIL=:EMAIL,
         PHOTO=:PHOTO,
         JOB_TITLE=:JOB_TITLE,
         PHONE_INTERNAL=:PHONE_INTERNAL,
         DATE_LOCK=:DATE_LOCK,
         REASON_LOCK=:REASON_LOCK
   WHERE ACCOUNT_ID=:OLD_ACCOUNT_ID;
END

--

ALTER TABLE CARS
ADD PHOTO BLOB

--

CREATE OR ALTER VIEW S_CARS
AS
SELECT C.*
  FROM CARS C
 ORDER BY C.STATE_NUM

--

CREATE OR ALTER PROCEDURE I_CAR
(
  CAR_ID VARCHAR(32),
  STATE_NUM VARCHAR(50),
  CALLSIGN VARCHAR(10),
  DESCRIPTION VARCHAR(250),
  BRAND VARCHAR(100),
  COLOR VARCHAR(100),
  YEAR_CREATED INTEGER,
  PTS VARCHAR(250),
  PAYLOAD INTEGER,
  AMOUNT INTEGER,
  PHOTO BLOB
)
AS
BEGIN
  INSERT INTO CARS (CAR_ID,STATE_NUM,CALLSIGN,DESCRIPTION,
                    BRAND,COLOR,YEAR_CREATED,PTS,PAYLOAD,AMOUNT,PHOTO)
       VALUES (:CAR_ID,:STATE_NUM,:CALLSIGN,:DESCRIPTION,
               :BRAND,:COLOR,:YEAR_CREATED,:PTS,:PAYLOAD,:AMOUNT,:PHOTO);
END

--

CREATE OR ALTER PROCEDURE U_CAR
(
  CAR_ID VARCHAR(32),
  STATE_NUM VARCHAR(50),
  CALLSIGN VARCHAR(10),
  DESCRIPTION VARCHAR(250),
  BRAND VARCHAR(100),
  COLOR VARCHAR(100),
  YEAR_CREATED INTEGER,
  PTS VARCHAR(250),
  PAYLOAD INTEGER,
  AMOUNT INTEGER,
  PHOTO BLOB,
  OLD_CAR_ID VARCHAR(32)
)
AS
BEGIN
  UPDATE CARS
     SET CAR_ID=:CAR_ID,
         STATE_NUM=:STATE_NUM,
         CALLSIGN=:CALLSIGN,
         DESCRIPTION=:DESCRIPTION,
         BRAND=:BRAND,
         COLOR=:COLOR,
         YEAR_CREATED=:YEAR_CREATED,
         PTS=:PTS,
         PAYLOAD=:PAYLOAD,
         AMOUNT=:AMOUNT,
         PHOTO=:PHOTO
   WHERE CAR_ID=:OLD_CAR_ID;
END

--

CREATE OR ALTER PROCEDURE I_CLIENT
(
  CLIENT_ID VARCHAR(32),
  CLIENT_GROUP_ID VARCHAR(32),
  CALC_ID VARCHAR(32),
  SOURCE_ID VARCHAR(32),
  METHOD_ID VARCHAR(32),
  STREET_ID VARCHAR(32),
  "INDEX" VARCHAR(10),
  HOUSE VARCHAR(10),
  FLAT VARCHAR(10),
  SEX INTEGER,
  PASSPORT VARCHAR(250),
  DATE_BIRTH DATE,
  PLACE_BIRTH VARCHAR(250),
  MIN_BALANCE NUMERIC(15,2),
  PORCH VARCHAR(10),
  ADDRESS_DESC VARCHAR(250),
  PHONE VARCHAR(100),
  DESCRIPTION VARCHAR(250),
  USER_NAME VARCHAR(100),
  "PASSWORD" VARCHAR(100),
  LOCKED INTEGER,
  SURNAME VARCHAR(100),
  NAME VARCHAR(100),
  PATRONYMIC VARCHAR(100),
  FIRM_ID VARCHAR(32),
  JOB_TITLE VARCHAR(250),
  DATE_LOCK TIMESTAMP,
  REASON_LOCK VARCHAR(100)
)
AS
DECLARE VARIABLE ROLE_ID VARCHAR(32);
DECLARE VARIABLE CNT INTEGER;
BEGIN

  SELECT COUNT(*)
    FROM ACCOUNTS A
   WHERE UPPER(A.USER_NAME)=UPPER(:USER_NAME)
    INTO :CNT;

  IF (CNT>0) THEN
    EXCEPTION E 'Логин уже существует';


  INSERT INTO ACCOUNTS (ACCOUNT_ID,DATE_CREATE,USER_NAME,LOCKED,SURNAME,NAME,PATRONYMIC,
                                  IS_ROLE,PHONE,DESCRIPTION,FIRM_ID,JOB_TITLE,"PASSWORD",DATE_LOCK,REASON_LOCK)
                          VALUES (:CLIENT_ID,CURRENT_TIMESTAMP,:USER_NAME,:LOCKED,:SURNAME,:NAME,:PATRONYMIC,
                                  0,:PHONE,:DESCRIPTION,:FIRM_ID,:JOB_TITLE,:"PASSWORD",:DATE_LOCK,:REASON_LOCK);

  INSERT INTO CLIENTS (CLIENT_ID,CLIENT_GROUP_ID,CALC_ID,SOURCE_ID,METHOD_ID,STREET_ID,"INDEX",
                                 HOUSE,FLAT,SEX,PASSPORT,DATE_BIRTH,PLACE_BIRTH,MIN_BALANCE,
                                 PORCH,ADDRESS_DESC)
                         VALUES (:CLIENT_ID,:CLIENT_GROUP_ID,:CALC_ID,:SOURCE_ID,:METHOD_ID,:STREET_ID,:"INDEX",
                                 :HOUSE,:FLAT,:SEX,:PASSPORT,:DATE_BIRTH,:PLACE_BIRTH,:MIN_BALANCE,
                                 :PORCH,:ADDRESS_DESC);

  ROLE_ID='1D3BDEDD9A0B9EE84AEDC1FDED4F5A93'; /* Клиенты */
  INSERT INTO ACCOUNT_ROLES (ROLE_ID,ACCOUNT_ID)
       VALUES (:ROLE_ID,:CLIENT_ID);
END

--

CREATE OR ALTER PROCEDURE U_CLIENT
(
  CLIENT_ID VARCHAR(32),
  CLIENT_GROUP_ID VARCHAR(32),
  CALC_ID VARCHAR(32),
  SOURCE_ID VARCHAR(32),
  METHOD_ID VARCHAR(32),
  STREET_ID VARCHAR(32),
  "INDEX" VARCHAR(10),
  HOUSE VARCHAR(10),
  FLAT VARCHAR(10),
  SEX INTEGER,
  PASSPORT VARCHAR(250),
  DATE_BIRTH DATE,
  PLACE_BIRTH VARCHAR(250),
  MIN_BALANCE NUMERIC(15,2),
  PORCH VARCHAR(10),
  ADDRESS_DESC VARCHAR(250),
  PHONE VARCHAR(100),
  DESCRIPTION VARCHAR(250),
  USER_NAME VARCHAR(100),
  "PASSWORD" VARCHAR(100),
  LOCKED INTEGER,
  SURNAME VARCHAR(100),
  NAME VARCHAR(100),
  PATRONYMIC VARCHAR(100),
  FIRM_ID VARCHAR(32),
  JOB_TITLE VARCHAR(250),
  DATE_LOCK TIMESTAMP,
  REASON_LOCK VARCHAR(100),
  OLD_CLIENT_ID VARCHAR(32)
)
AS
DECLARE VARIABLE CNT INTEGER;
BEGIN

  SELECT COUNT(*)
    FROM ACCOUNTS A
   WHERE UPPER(A.USER_NAME)=UPPER(:USER_NAME)
     AND A.ACCOUNT_ID<>:CLIENT_ID
    INTO :CNT;

  IF (CNT>0) THEN
    EXCEPTION E 'Логин уже существует';


  UPDATE ACCOUNTS
     SET ACCOUNT_ID=:CLIENT_ID,
         USER_NAME=:USER_NAME,
         LOCKED=:LOCKED,
         SURNAME=:SURNAME,
         NAME=:NAME,
         PATRONYMIC=:PATRONYMIC,
         IS_ROLE=0,
         PHONE=:PHONE,
         DESCRIPTION=:DESCRIPTION,
         FIRM_ID=:FIRM_ID,
         JOB_TITLE=:JOB_TITLE,
         "PASSWORD"=:"PASSWORD",
         DATE_LOCK=:DATE_LOCK,
         REASON_LOCK=:REASON_LOCK
   WHERE ACCOUNT_ID=:OLD_CLIENT_ID;

  UPDATE CLIENTS
     SET CLIENT_ID=:CLIENT_ID,
         CLIENT_GROUP_ID=:CLIENT_GROUP_ID,
         CALC_ID=:CALC_ID,
         SOURCE_ID=:SOURCE_ID,
         METHOD_ID=:METHOD_ID,
         STREET_ID=:STREET_ID,
         "INDEX"=:"INDEX",
         HOUSE=:HOUSE,
         FLAT=:FLAT,
         SEX=:SEX,
         PASSPORT=:PASSPORT,
         DATE_BIRTH=:DATE_BIRTH,
         PLACE_BIRTH=:PLACE_BIRTH,
         MIN_BALANCE=:MIN_BALANCE,
         PORCH=:PORCH,
         ADDRESS_DESC=:ADDRESS_DESC
   WHERE CLIENT_ID=:OLD_CLIENT_ID;

END

--

CREATE TABLE CLIENT_DRIVERS
(
  CLIENT_ID VARCHAR(32) NOT NULL,
  DRIVER_ID VARCHAR(32) NOT NULL,
  DATE_CREATE TIMESTAMP NOT NULL,
  KIND INTEGER NOT NULL,
  PRIORITY INTEGER,
  DESCRIPTION VARCHAR(250),
  PRIMARY KEY (CLIENT_ID,DRIVER_ID),
  FOREIGN KEY (CLIENT_ID) REFERENCES CLIENTS (CLIENT_ID),
  FOREIGN KEY (DRIVER_ID) REFERENCES DRIVERS (DRIVER_ID)
)

--

CREATE OR ALTER VIEW S_CLIENT_DRIVERS
AS
SELECT CD.*,
       A1.USER_NAME AS CLIENT_USER_NAME,
       A1.SURNAME AS CLIENT_SURNAME,
       A1.NAME AS CLIENT_NAME,
       A1.PATRONYMIC AS CLIENT_PATRONYMIC,
       A2.USER_NAME AS DRIVER_USER_NAME,
       A2.SURNAME AS DRIVER_SURNAME,
       A2.NAME AS DRIVER_NAME,
       A2.PATRONYMIC AS DRIVER_PATRONYMIC
  FROM CLIENT_DRIVERS CD
  JOIN CLIENTS C ON C.CLIENT_ID=CD.CLIENT_ID
  JOIN ACCOUNTS A1 ON A1.ACCOUNT_ID=CD.CLIENT_ID
  JOIN DRIVERS D ON D.DRIVER_ID=CD.DRIVER_ID
  JOIN ACCOUNTS A2 ON A2.ACCOUNT_ID=CD.DRIVER_ID
 ORDER BY CD.DATE_CREATE, A1.USER_NAME, A2.USER_NAME

--

CREATE OR ALTER PROCEDURE I_CLIENT_DRIVER
(
  CLIENT_ID VARCHAR(32),
  DRIVER_ID VARCHAR(32),
  DATE_CREATE TIMESTAMP,
  KIND INTEGER,
  PRIORITY INTEGER,
  DESCRIPTION VARCHAR(250)
)
AS
BEGIN
  INSERT INTO CLIENT_DRIVERS (CLIENT_ID,DRIVER_ID,DATE_CREATE,KIND,PRIORITY,DESCRIPTION)
       VALUES (:CLIENT_ID,:DRIVER_ID,:DATE_CREATE,:KIND,:PRIORITY,:DESCRIPTION);
END

--

CREATE OR ALTER PROCEDURE U_CLIENT_DRIVER
(
  CLIENT_ID VARCHAR(32),
  DRIVER_ID VARCHAR(32),
  DATE_CREATE TIMESTAMP,
  KIND INTEGER,
  PRIORITY INTEGER,
  DESCRIPTION VARCHAR(250),
  OLD_CLIENT_ID VARCHAR(32),
  OLD_DRIVER_ID VARCHAR(32)
)
AS
BEGIN
  UPDATE CLIENT_DRIVERS
     SET CLIENT_ID=:CLIENT_ID,
         DRIVER_ID=:DRIVER_ID,
         DATE_CREATE=:DATE_CREATE,
         KIND=:KIND,
         PRIORITY=:PRIORITY,
         DESCRIPTION=:DESCRIPTION
   WHERE CLIENT_ID=:OLD_CLIENT_ID
     AND DRIVER_ID=:OLD_DRIVER_ID;
END;

--

CREATE OR ALTER PROCEDURE D_CLIENT_DRIVER
(
  OLD_CLIENT_ID VARCHAR(32),
  OLD_DRIVER_ID VARCHAR(32)
)
AS
BEGIN
  DELETE FROM CLIENT_DRIVERS
        WHERE CLIENT_ID=:OLD_CLIENT_ID
          AND DRIVER_ID=:OLD_DRIVER_ID;
END;

--

CREATE OR ALTER PROCEDURE D_CLIENT
(
  OLD_CLIENT_ID VARCHAR(32)
)
AS
BEGIN
  DELETE FROM CLIENT_CHILDS
        WHERE CLIENT_ID=:OLD_CLIENT_ID;

  DELETE FROM CLIENT_PHONES
        WHERE CLIENT_ID=:OLD_CLIENT_ID;

  DELETE FROM CLIENT_DRIVERS
        WHERE CLIENT_ID=:OLD_CLIENT_ID;

  DELETE FROM CLIENTS
        WHERE CLIENT_ID=:OLD_CLIENT_ID;

  DELETE FROM ACCOUNT_ROLES
        WHERE ACCOUNT_ID=:OLD_CLIENT_ID;

  DELETE FROM ACCOUNTS
        WHERE ACCOUNT_ID=:OLD_CLIENT_ID;
END

--

CREATE OR ALTER VIEW S_CLIENT_PHONES
AS
SELECT CP.*,
       S1.LOCALITY_ID,
       C.STREET_ID,
       C.HOUSE,
       C.FLAT,
       C.PORCH,
       C.ADDRESS_DESC,
       A.PHONE AS CLIENT_PHONE,
       A.USER_NAME,
       A.SURNAME,
       A.NAME,
       A.PATRONYMIC,
       A.LOCKED,
       F.SMALL_NAME AS FIRM_SMALL_NAME,
       M.NAME AS METHOD_NAME,
       S1.NAME AS STREET_NAME,
       S1.PREFIX AS STREET_PREFIX,
       L1.NAME AS LOCALITY_NAME,
       L1.PREFIX AS LOCALITY_PREFIX
  FROM CLIENT_PHONES CP
  JOIN CLIENTS C ON C.CLIENT_ID=CP.CLIENT_ID
  JOIN ACCOUNTS A ON A.ACCOUNT_ID=C.CLIENT_ID
  LEFT JOIN FIRMS F ON F.FIRM_ID=A.FIRM_ID
  LEFT JOIN METHODS M ON M.METHOD_ID=CP.METHOD_ID
  LEFT JOIN STREETS S1 ON S1.STREET_ID=C.STREET_ID
  LEFT JOIN LOCALITIES L1 ON L1.LOCALITY_ID=S1.LOCALITY_ID
 ORDER BY A.USER_NAME

--

CREATE TABLE DRIVER_TYPES
(
  DRIVER_TYPE_ID VARCHAR(32) NOT NULL,
  NAME VARCHAR(100) NOT NULL,
  DESCRIPTION VARCHAR(250),
  VISIBLE INTEGER NOT NULL,
  PRIORITY INTEGER,
  PRIMARY KEY (DRIVER_TYPE_ID)
)

--

CREATE OR ALTER VIEW S_DRIVER_TYPES
AS
SELECT *
  FROM DRIVER_TYPES
 ORDER BY PRIORITY

--

CREATE OR ALTER PROCEDURE I_DRIVER_TYPE
(
  DRIVER_TYPE_ID VARCHAR(32),
  NAME VARCHAR(100),
  DESCRIPTION VARCHAR(250),
  VISIBLE INTEGER,
  PRIORITY INTEGER
)
AS
BEGIN
  INSERT INTO DRIVER_TYPES (DRIVER_TYPE_ID,NAME,DESCRIPTION,VISIBLE,PRIORITY)
       VALUES (:DRIVER_TYPE_ID,:NAME,:DESCRIPTION,:VISIBLE,:PRIORITY);
END;

--

CREATE OR ALTER PROCEDURE U_DRIVER_TYPE
(
  DRIVER_TYPE_ID VARCHAR(32),
  NAME VARCHAR(100),
  DESCRIPTION VARCHAR(250),
  VISIBLE INTEGER,
  PRIORITY INTEGER,
  OLD_DRIVER_TYPE_ID VARCHAR(32)
)
AS
BEGIN
  UPDATE DRIVER_TYPES
     SET DRIVER_TYPE_ID=:DRIVER_TYPE_ID,
         NAME=:NAME,
         DESCRIPTION=:DESCRIPTION,
         VISIBLE=:VISIBLE,
         PRIORITY=:PRIORITY
   WHERE DRIVER_TYPE_ID=:OLD_DRIVER_TYPE_ID;
END;

--

CREATE PROCEDURE D_DRIVER_TYPE
(
  OLD_DRIVER_TYPE_ID VARCHAR(32)
)
AS
BEGIN
  DELETE FROM DRIVER_TYPES
        WHERE DRIVER_TYPE_ID=:OLD_DRIVER_TYPE_ID;
END;

--

CREATE OR ALTER VIEW S_DISCOUNT_TYPES
AS
SELECT *
  FROM DISCOUNT_TYPES
 ORDER BY PRIORITY

--

CREATE TABLE RATINGS
(
  RATING_ID VARCHAR(32) NOT NULL,
  NAME VARCHAR(100) NOT NULL,
  DESCRIPTION VARCHAR(250),
  TYPE_RATING INTEGER NOT NULL,
  VISIBLE INTEGER NOT NULL,
  PRIORITY INTEGER,
  SCORE INTEGER,
  PRIMARY KEY (RATING_ID)
)

--

CREATE OR ALTER VIEW S_RATINGS
AS
SELECT *
  FROM RATINGS
 ORDER BY PRIORITY

--

CREATE OR ALTER PROCEDURE I_RATING
(
  RATING_ID VARCHAR(32),
  NAME VARCHAR(100),
  DESCRIPTION VARCHAR(250),
  TYPE_RATING INTEGER,
  VISIBLE INTEGER,
  PRIORITY INTEGER,
  SCORE INTEGER
)
AS
BEGIN
  INSERT INTO RATINGS (RATING_ID,NAME,DESCRIPTION,TYPE_RATING,VISIBLE,PRIORITY,SCORE)
       VALUES (:RATING_ID,:NAME,:DESCRIPTION,:TYPE_RATING,:VISIBLE,:PRIORITY,:SCORE);
END;

--

CREATE OR ALTER PROCEDURE U_RATING
(
  RATING_ID VARCHAR(32),
  NAME VARCHAR(100),
  DESCRIPTION VARCHAR(250),
  TYPE_RATING INTEGER,
  VISIBLE INTEGER,
  PRIORITY INTEGER,
  SCORE INTEGER,
  OLD_RATING_ID VARCHAR(32)
)
AS
BEGIN
  UPDATE RATINGS
     SET RATING_ID=:RATING_ID,
         NAME=:NAME,
         DESCRIPTION=:DESCRIPTION,
         TYPE_RATING=:TYPE_RATING,
         VISIBLE=:VISIBLE,
         PRIORITY=:PRIORITY,
         SCORE=:SCORE
   WHERE RATING_ID=:OLD_RATING_ID;
END;

--

CREATE PROCEDURE D_RATING
(
  OLD_RATING_ID VARCHAR(32)
)
AS
BEGIN
  DELETE FROM RATINGS
        WHERE RATING_ID=:OLD_RATING_ID;
END;

--

ALTER TABLE DRIVERS
ADD DATE_APPEAR DATE

--

ALTER TABLE DRIVERS
ADD TYPE_SCHEDULE INTEGER

--

ALTER TABLE DRIVERS
ADD REST_DAYS INTEGER

--

ALTER TABLE DRIVERS
ADD WORK_DAYS INTEGER

--

ALTER TABLE DRIVERS
ADD DRIVER_TYPE_ID VARCHAR(32)

--

ALTER TABLE DRIVERS
ADD FOREIGN KEY (DRIVER_TYPE_ID) REFERENCES DRIVER_TYPES (DRIVER_TYPE_ID)

--

CREATE OR ALTER VIEW S_DRIVERS
AS
SELECT D.*,
       A.PHONE,
       A.DESCRIPTION,
       A.USER_NAME,
       A.DATE_CREATE,
       A.LOCKED,
       A.SURNAME,
       A.NAME,
       A.PATRONYMIC,
       A.FIRM_ID,
       A.PHOTO,
       A.DATE_LOCK,
       A.REASON_LOCK,
       CR.STATE_NUM AS CAR_STATE_NUM,
       CR.BRAND AS CAR_BRAND,
       CR.COLOR AS CAR_COLOR,
       CR.CALLSIGN AS CAR_CALLSIGN,
       CL.NAME AS CALC_NAME,
       M.NAME AS METHOD_NAME,
       F.SMALL_NAME AS FIRM_SMALL_NAME,
       DT.NAME AS DRIVER_TYPE_NAME
  FROM DRIVERS D
  JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
  JOIN CARS CR ON CR.CAR_ID=D.CAR_ID
  LEFT JOIN CALCS CL ON CL.CALC_ID=D.CALC_ID
  LEFT JOIN METHODS M ON M.METHOD_ID=D.METHOD_ID
  LEFT JOIN FIRMS F ON F.FIRM_ID=A.FIRM_ID
  LEFT JOIN DRIVER_TYPES DT ON DT.DRIVER_TYPE_ID=D.DRIVER_TYPE_ID
 ORDER BY A.SURNAME, A.NAME, A.PATRONYMIC


--

CREATE OR ALTER PROCEDURE I_DRIVER
(
  DRIVER_ID VARCHAR(32),
  CALC_ID VARCHAR(32),
  CAR_ID VARCHAR(32),
  METHOD_ID VARCHAR(32),
  PHONE VARCHAR(100),
  PHONE_HOME VARCHAR(100),
  LICENSE VARCHAR(250),
  CATEGORIES VARCHAR(100),
  INSURANCE VARCHAR(250),
  HEALTH_CERT VARCHAR(250),
  DESCRIPTION VARCHAR(250),
  ADDICT_CERT VARCHAR(250),
  PASSPORT VARCHAR(250),
  PLACE_BIRTH VARCHAR(250),
  DATE_BIRTH DATE,
  ADDRESS_RESIDENCE VARCHAR(250),
  ADDRESS_ACTUAL VARCHAR(250),
  MIN_BALANCE NUMERIC(15,2),
  PRIORITY INTEGER,
  DATE_PRIORITY DATE,
  MIN_HOURS INTEGER,
  DATE_SCHEDULE DATE,
  DATE_CREATE TIMESTAMP,
  USER_NAME VARCHAR(100),
  LOCKED INTEGER,
  SURNAME VARCHAR(100),
  NAME VARCHAR(100),
  PATRONYMIC VARCHAR(100),
  FIRM_ID VARCHAR(32),
  DRIVER_TYPE_ID VARCHAR(32),
  DATE_APPEAR DATE,
  TYPE_SCHEDULE INTEGER,
  REST_DAYS INTEGER,
  WORK_DAYS INTEGER,
  PHOTO BLOB,
  DATE_LOCK TIMESTAMP,
  REASON_LOCK VARCHAR(100)
)
AS
DECLARE VARIABLE ROLE_ID VARCHAR(32);
DECLARE VARIABLE CNT INTEGER;
BEGIN

  SELECT COUNT(*)
    FROM ACCOUNTS A
   WHERE UPPER(A.USER_NAME)=UPPER(:USER_NAME)
    INTO :CNT;

  IF (CNT>0) THEN
    EXCEPTION E 'Логин уже существует';

  INSERT INTO ACCOUNTS (ACCOUNT_ID,FIRM_ID,DATE_CREATE,USER_NAME,LOCKED,SURNAME,NAME,PATRONYMIC,
                        IS_ROLE,PHONE,DESCRIPTION,PHOTO,DATE_LOCK,REASON_LOCK)
                VALUES (:DRIVER_ID,:FIRM_ID,:DATE_CREATE,:USER_NAME,:LOCKED,:SURNAME,:NAME,:PATRONYMIC,
                        0,:PHONE,:DESCRIPTION,:PHOTO,:DATE_LOCK,:REASON_LOCK);

  INSERT INTO DRIVERS (DRIVER_ID,CALC_ID,CAR_ID,METHOD_ID,PHONE_HOME,LICENSE,
                       CATEGORIES,INSURANCE,HEALTH_CERT,ADDICT_CERT,
                       PASSPORT,PLACE_BIRTH,DATE_BIRTH,ADDRESS_RESIDENCE,ADDRESS_ACTUAL,
                       MIN_BALANCE,PRIORITY,DATE_PRIORITY,MIN_HOURS,DATE_SCHEDULE,
                       DRIVER_TYPE_ID,TYPE_SCHEDULE,REST_DAYS,WORK_DAYS)
       VALUES (:DRIVER_ID,:CALC_ID,:CAR_ID,:METHOD_ID,:PHONE_HOME,:LICENSE,
               :CATEGORIES,:INSURANCE,:HEALTH_CERT,:ADDICT_CERT,
               :PASSPORT,:PLACE_BIRTH,:DATE_BIRTH,:ADDRESS_RESIDENCE,:ADDRESS_ACTUAL,
               :MIN_BALANCE,:PRIORITY,:DATE_PRIORITY,:MIN_HOURS,:DATE_SCHEDULE,
               :DRIVER_TYPE_ID,:TYPE_SCHEDULE,:REST_DAYS,:WORK_DAYS);

  ROLE_ID='3EBE04F48C07BAB246324FBA8551FEF1'; /* Водители */
  INSERT INTO ACCOUNT_ROLES (ROLE_ID,ACCOUNT_ID)
       VALUES (:ROLE_ID,:DRIVER_ID);
END

--

CREATE OR ALTER PROCEDURE U_DRIVER
(
  DRIVER_ID VARCHAR(32),
  CALC_ID VARCHAR(32),
  CAR_ID VARCHAR(32),
  METHOD_ID VARCHAR(32),
  PHONE VARCHAR(100),
  PHONE_HOME VARCHAR(100),
  LICENSE VARCHAR(250),
  CATEGORIES VARCHAR(100),
  INSURANCE VARCHAR(250),
  HEALTH_CERT VARCHAR(250),
  DESCRIPTION VARCHAR(250),
  ADDICT_CERT VARCHAR(250),
  PASSPORT VARCHAR(250),
  PLACE_BIRTH VARCHAR(250),
  DATE_BIRTH DATE,
  ADDRESS_RESIDENCE VARCHAR(250),
  ADDRESS_ACTUAL VARCHAR(250),
  MIN_BALANCE NUMERIC(15,2),
  PRIORITY INTEGER,
  DATE_PRIORITY DATE,
  MIN_HOURS INTEGER,
  DATE_SCHEDULE DATE,
  USER_NAME VARCHAR(100),
  LOCKED INTEGER,
  SURNAME VARCHAR(100),
  NAME VARCHAR(100),
  PATRONYMIC VARCHAR(100),
  FIRM_ID VARCHAR(32),
  DRIVER_TYPE_ID VARCHAR(32),
  DATE_APPEAR DATE,
  TYPE_SCHEDULE INTEGER,
  REST_DAYS INTEGER,
  WORK_DAYS INTEGER,
  PHOTO BLOB,
  DATE_LOCK TIMESTAMP,
  REASON_LOCK VARCHAR(100),
  OLD_DRIVER_ID VARCHAR(32)
)
AS
DECLARE VARIABLE CNT INTEGER;
BEGIN

  SELECT COUNT(*)
    FROM ACCOUNTS A
   WHERE UPPER(A.USER_NAME)=UPPER(:USER_NAME)
     AND A.ACCOUNT_ID<>:DRIVER_ID
    INTO :CNT;

  IF (CNT>0) THEN
    EXCEPTION E 'Логин уже существует';

  UPDATE ACCOUNTS
     SET ACCOUNT_ID=:DRIVER_ID,
         FIRM_ID=:FIRM_ID,
         USER_NAME=:USER_NAME,
         LOCKED=:LOCKED,
         SURNAME=:SURNAME,
         NAME=:NAME,
         PATRONYMIC=:PATRONYMIC,
         IS_ROLE=0,
         PHONE=:PHONE,
         DESCRIPTION=:DESCRIPTION,
         PHOTO=:PHOTO,
         DATE_LOCK=:DATE_LOCK,
         REASON_LOCK=:REASON_LOCK
   WHERE ACCOUNT_ID=:OLD_DRIVER_ID;

  UPDATE DRIVERS
     SET DRIVER_ID=:DRIVER_ID,
         CALC_ID=:CALC_ID,
         CAR_ID=:CAR_ID,
         METHOD_ID=:METHOD_ID,
         PHONE_HOME=:PHONE_HOME,
         LICENSE=:LICENSE,
         CATEGORIES=:CATEGORIES,
         INSURANCE=:INSURANCE,
         HEALTH_CERT=:HEALTH_CERT,
         ADDICT_CERT=:ADDICT_CERT,
         PASSPORT=:PASSPORT,
         PLACE_BIRTH=:PLACE_BIRTH,
         DATE_BIRTH=:DATE_BIRTH,
         ADDRESS_RESIDENCE=:ADDRESS_RESIDENCE,
         ADDRESS_ACTUAL=:ADDRESS_ACTUAL,
         MIN_BALANCE=:MIN_BALANCE,
         PRIORITY=:PRIORITY,
         DATE_PRIORITY=:DATE_PRIORITY,
         MIN_HOURS=:MIN_HOURS,
         DATE_SCHEDULE=:DATE_SCHEDULE,
         DRIVER_TYPE_ID=:DRIVER_TYPE_ID,
         DATE_APPEAR=:DATE_APPEAR,
         TYPE_SCHEDULE=:TYPE_SCHEDULE,
         REST_DAYS=:REST_DAYS,
         WORK_DAYS=:WORK_DAYS
   WHERE DRIVER_ID=:OLD_DRIVER_ID;

END

--

CREATE TABLE SCORES
(
  SCORE_ID VARCHAR(32) NOT NULL,
  RATING_ID VARCHAR(32) NOT NULL,
  DRIVER_ID VARCHAR(32) NOT NULL,
  CREATOR_ID VARCHAR(32) NOT NULL,
  DATE_CREATE TIMESTAMP NOT NULL,
  AMOUNT INTEGER NOT NULL,
  DESCRIPTION VARCHAR(250),
  PRIMARY KEY (SCORE_ID),
  FOREIGN KEY (RATING_ID) REFERENCES RATINGS (RATING_ID),
  FOREIGN KEY (DRIVER_ID) REFERENCES DRIVERS (DRIVER_ID),
  FOREIGN KEY (CREATOR_ID) REFERENCES ACCOUNTS (ACCOUNT_ID)
)

--

CREATE OR ALTER VIEW S_SCORES
AS
SELECT S.*,
       A1.USER_NAME AS DRIVER_USER_NAME,
       R.NAME AS RATING_NAME,
       A2.USER_NAME AS CREATOR_USER_NAME
  FROM SCORES S
  JOIN DRIVERS D ON D.DRIVER_ID=S.DRIVER_ID
  JOIN ACCOUNTS A1 ON A1.ACCOUNT_ID=S.DRIVER_ID
  JOIN RATINGS R ON R.RATING_ID=S.RATING_ID
  JOIN ACCOUNTS A2 ON A2.ACCOUNT_ID=S.CREATOR_ID
 ORDER BY S.DATE_CREATE

--

CREATE OR ALTER PROCEDURE I_SCORE
(
  SCORE_ID VARCHAR(32),
  RATING_ID VARCHAR(32),
  DRIVER_ID VARCHAR(32),
  CREATOR_ID VARCHAR(32),
  DATE_CREATE TIMESTAMP,
  AMOUNT INTEGER,
  DESCRIPTION VARCHAR(250)
)
AS
BEGIN
  INSERT INTO SCORES (SCORE_ID,RATING_ID,DRIVER_ID,CREATOR_ID,DATE_CREATE,AMOUNT,DESCRIPTION)
       VALUES (:SCORE_ID,:RATING_ID,:DRIVER_ID,:CREATOR_ID,:DATE_CREATE,:AMOUNT,:DESCRIPTION);
END;

--

CREATE OR ALTER PROCEDURE U_SCORE
(
  SCORE_ID VARCHAR(32),
  RATING_ID VARCHAR(32),
  DRIVER_ID VARCHAR(32),
  CREATOR_ID VARCHAR(32),
  DATE_CREATE TIMESTAMP,
  AMOUNT INTEGER,
  DESCRIPTION VARCHAR(250),
  OLD_SCORE_ID VARCHAR(32)
)
AS
BEGIN
  UPDATE SCORES
     SET SCORE_ID=:SCORE_ID,
         RATING_ID=:RATING_ID,
         DRIVER_ID=:DRIVER_ID,
         CREATOR_ID=:CREATOR_ID,
         DATE_CREATE=:DATE_CREATE,
         AMOUNT=:AMOUNT,
         DESCRIPTION=:DESCRIPTION
   WHERE SCORE_ID=:OLD_SCORE_ID;
END;

--

CREATE PROCEDURE D_SCORE
(
  OLD_SCORE_ID VARCHAR(32)
)
AS
BEGIN
  DELETE FROM SCORES
        WHERE SCORE_ID=:OLD_SCORE_ID;
END;

--

CREATE TABLE DRIVER_DAY_SCHEDULES
(
  DRIVER_ID VARCHAR(32) NOT NULL,
  WORK_DAY INTEGER NOT NULL,
  DAY_HOUR INTEGER NOT NULL,
  PRIMARY KEY (DRIVER_ID,WORK_DAY,DAY_HOUR),
  FOREIGN KEY (DRIVER_ID) REFERENCES DRIVERS (DRIVER_ID)
)

--

CREATE OR ALTER VIEW S_DRIVER_DAY_SCHEDULES
AS
SELECT DS.*,
       A.USER_NAME AS DRIVER_NAME,
       A.PHONE AS DRIVER_PHONE
  FROM DRIVER_DAY_SCHEDULES DS
  JOIN DRIVERS D ON D.DRIVER_ID=DS.DRIVER_ID
  JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID

--

CREATE OR ALTER PROCEDURE I_DRIVER_DAY_SCHEDULE
(
  DRIVER_ID VARCHAR(32),
  WORK_DAY INTEGER,
  DAY_HOUR INTEGER
)
AS
BEGIN
  INSERT INTO DRIVER_DAY_SCHEDULES (DRIVER_ID,WORK_DAY,DAY_HOUR)
       VALUES (:DRIVER_ID,:WORK_DAY,:DAY_HOUR);
END;

--

CREATE OR ALTER PROCEDURE U_DRIVER_DAY_SCHEDULE
(
  DRIVER_ID VARCHAR(32),
  WORK_DAY INTEGER,
  DAY_HOUR INTEGER,
  OLD_DRIVER_ID VARCHAR(32),
  OLD_WORK_DAY INTEGER,
  OLD_DAY_HOUR INTEGER
)
AS
BEGIN
  UPDATE DRIVER_DAY_SCHEDULES
     SET DRIVER_ID=:DRIVER_ID,
         WORK_DAY=:WORK_DAY,
         DAY_HOUR=:DAY_HOUR
   WHERE DRIVER_ID=:OLD_DRIVER_ID
     AND WORK_DAY=:OLD_WORK_DAY
     AND DAY_HOUR=:OLD_DAY_HOUR;
END;

--

CREATE OR ALTER PROCEDURE D_DRIVER_DAY_SCHEDULE
(
  OLD_DRIVER_ID VARCHAR(32),
  OLD_WORK_DAY INTEGER,
  OLD_DAY_HOUR INTEGER
)
AS
BEGIN
  DELETE FROM DRIVER_DAY_SCHEDULES
        WHERE DRIVER_ID=:OLD_DRIVER_ID
          AND WORK_DAY=:OLD_WORK_DAY
          AND DAY_HOUR=:OLD_DAY_HOUR;
END;

--

CREATE OR ALTER PROCEDURE C_DRIVER_DAY_SCHEDULE
(
  DRIVER_ID VARCHAR(32),
  WORK_DAY INTEGER
)
AS
BEGIN
  IF (WORK_DAY IS NOT NULL) THEN

    DELETE FROM DRIVER_DAY_SCHEDULES
          WHERE DRIVER_ID=:DRIVER_ID
            AND WORK_DAY=:WORK_DAY;

  ELSE

    DELETE FROM DRIVER_DAY_SCHEDULES
          WHERE DRIVER_ID=:DRIVER_ID;


END;

--

CREATE OR ALTER PROCEDURE C_DRIVER_WEEK_SCHEDULE
(
  DRIVER_ID VARCHAR(32),
  WEEK_DAY INTEGER
)
AS
BEGIN
  IF (WEEK_DAY IS NOT NULL) THEN

    DELETE FROM DRIVER_WEEK_SCHEDULES
          WHERE DRIVER_ID=:DRIVER_ID
            AND WEEK_DAY=:WEEK_DAY;

  ELSE

    DELETE FROM DRIVER_WEEK_SCHEDULES
          WHERE DRIVER_ID=:DRIVER_ID;


END;

--

CREATE OR ALTER PROCEDURE GET_DRIVER_WEEK_SHCHEDULES
RETURNS
(
  WEEK_DAY INTEGER,
  DAY_HOUR INTEGER,
  DRIVER_COUNT INTEGER
)
AS
BEGIN
  FOR SELECT DWS.WEEK_DAY,
             DWS.DAY_HOUR,
             COUNT(*)
        FROM DRIVER_WEEK_SCHEDULES DWS
        JOIN ACCOUNTS A ON A.ACCOUNT_ID=DWS.DRIVER_ID
        JOIN DRIVERS D ON D.DRIVER_ID=DWS.DRIVER_ID
       WHERE A.LOCKED<>1
       GROUP BY WEEK_DAY, DAY_HOUR
       ORDER BY WEEK_DAY, DAY_HOUR
        INTO :WEEK_DAY, :DAY_HOUR, :DRIVER_COUNT DO BEGIN
    SUSPEND;
  END
END

--

CREATE OR ALTER PROCEDURE GET_DRIVER_DAY_SHCHEDULES
RETURNS
(
  WORK_DAY INTEGER,
  DAY_HOUR INTEGER,
  DRIVER_COUNT INTEGER
)
AS
BEGIN
  FOR SELECT DDS.WORK_DAY,
             DDS.DAY_HOUR,
             COUNT(*)
        FROM DRIVER_DAY_SCHEDULES DDS
        JOIN ACCOUNTS A ON A.ACCOUNT_ID=DDS.DRIVER_ID
       WHERE A.LOCKED<>1
       GROUP BY WORK_DAY, DAY_HOUR
       ORDER BY WORK_DAY, DAY_HOUR
        INTO :WORK_DAY, :DAY_HOUR, :DRIVER_COUNT DO BEGIN
    SUSPEND;
  END
END

--

CREATE OR ALTER PROCEDURE GET_DRIVER_SCHEDULES
(
  DATE_BEGIN TIMESTAMP,
  DATE_END TIMESTAMP,
  DRIVER_ID VARCHAR(32)
)
RETURNS
(
  DAY_DATE DATE,
  DAY_HOUR INTEGER,
  DRIVER_COUNT INTEGER
)
AS
DECLARE WEEK_DAY INTEGER;
DECLARE TEMP_DRIVER_ID VARCHAR(32);
DECLARE TYPE_SCHEDULE INTEGER;
DECLARE DATE_SCHEDULE DATE;
DECLARE DAYS INTEGER;
DECLARE CNT INTEGER;
BEGIN
  DELETE FROM TMP_HOURS;
  INSERT INTO TMP_HOURS (DATE_HOUR,DAY_HOUR)
  SELECT DATE_HOUR,
         DAY_HOUR
    FROM GET_HOURS(:DATE_BEGIN,:DATE_END);

  FOR SELECT TH.DATE_HOUR, TH.DAY_HOUR,
             CASE
               WHEN EXTRACT(WEEKDAY FROM TH.DATE_HOUR)=0 THEN 6
               ELSE EXTRACT(WEEKDAY FROM TH.DATE_HOUR)-1
             END
        FROM TMP_HOURS TH
       ORDER BY TH.DATE_HOUR, TH.DAY_HOUR
        INTO :DAY_DATE,:DAY_HOUR,:WEEK_DAY DO BEGIN

    DRIVER_COUNT=0;

    FOR SELECT D.DRIVER_ID, D.TYPE_SCHEDULE, D.DATE_SCHEDULE,
               D.WORK_DAYS+D.REST_DAYS
          FROM DRIVERS D
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
         WHERE A.LOCKED=0
           AND D.DATE_SCHEDULE IS NOT NULL
           AND D.TYPE_SCHEDULE IN (1,2)
           AND D.DATE_SCHEDULE<=:DAY_DATE
           AND D.DRIVER_ID<>:DRIVER_ID
          INTO :TEMP_DRIVER_ID, :TYPE_SCHEDULE, :DATE_SCHEDULE,
               :DAYS DO BEGIN

      IF (TYPE_SCHEDULE=1) THEN BEGIN

        SELECT COUNT(*)
          FROM DRIVER_WEEK_SCHEDULES DWS
         WHERE DWS.DRIVER_ID=:TEMP_DRIVER_ID
           AND DWS.DAY_HOUR=:DAY_HOUR
           AND DWS.WEEK_DAY=:WEEK_DAY
          INTO :CNT;

      END ELSE BEGIN

        IF (DAYS>0) THEN BEGIN

          DAYS=MOD(DATEDIFF(DAY,DATE_SCHEDULE,DAY_DATE),DAYS);

          SELECT COUNT(*)
            FROM DRIVER_DAY_SCHEDULES DDS
           WHERE DDS.DRIVER_ID=:TEMP_DRIVER_ID
             AND DDS.DAY_HOUR=:DAY_HOUR
             AND DDS.WORK_DAY=:DAYS
            INTO :CNT;

        END

      END

      DRIVER_COUNT=DRIVER_COUNT+CNT;

    END

    IF (DRIVER_COUNT>0) THEN
      SUSPEND;
  END
END

--

CREATE OR ALTER PROCEDURE SEND_EVENT
(
    SORTING INTEGER,
    FIRST_RECORD INTEGER,
    APPLICATION_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32),
    INCLUDE_SESSION_ID VARCHAR(32),
    EXCLUDE_SESSION_ID VARCHAR(32),
    PROTOCOL INTEGER,
    NAME VARCHAR(100),
    IN_PARAMS BLOB
)
RETURNS
(
    SUCCESS INTEGER,
    OUT_PARAMS BLOB
)
AS
DECLARE TEMP BLOB;
DECLARE SESSION_ID VARCHAR(32);
DECLARE IP VARCHAR(20);
DECLARE PORT VARCHAR(10);
DECLARE HOST VARCHAR(100);
DECLARE PATH VARCHAR(100);
DECLARE USE_CRYPTER INTEGER;
DECLARE CRYPTER_ALGORITHM INTEGER;
DECLARE CRYPTER_MODE INTEGER;
DECLARE CRYPTER_KEY VARCHAR(100);
DECLARE USE_COMPRESSOR INTEGER;
DECLARE COMPRESSOR_LEVEL INTEGER;
DECLARE RND VARCHAR(4000);
BEGIN

  IF (PROTOCOL=0) THEN
    RND=RANDOM_STRING(32);
  ELSE
    RND=RANDOM_STRING(1024*3); /* for fast reaction */

  FOR SELECT SESSION_ID, IP, PORT, HOST, PATH,
             USE_CRYPTER, CRYPTER_ALGORITHM, CRYPTER_MODE, CRYPTER_KEY,
             USE_COMPRESSOR, COMPRESSOR_LEVEL
        FROM GET_EVENT_SESSIONS(:SORTING,:APPLICATION_ID,:ACCOUNT_ID,:PROTOCOL)
       WHERE ((:EXCLUDE_SESSION_ID IS NULL) OR (SESSION_ID<>:EXCLUDE_SESSION_ID))
         AND ((:INCLUDE_SESSION_ID IS NULL) OR (SESSION_ID=:INCLUDE_SESSION_ID))
        INTO :SESSION_ID, :IP, :PORT, :HOST, :PATH,
             :USE_CRYPTER, :CRYPTER_ALGORITHM, :CRYPTER_MODE, :CRYPTER_KEY,
             :USE_COMPRESSOR, :COMPRESSOR_LEVEL DO BEGIN

    SUCCESS=0;

    TEMP=CONFIG_WRITE(IN_PARAMS,NAME,'rnd',RND);
    TEMP=CONFIG_WRITE(TEMP,NAME,'SessionId',SESSION_ID);

    IF (USE_COMPRESSOR=1) THEN
      TEMP=COMPRESS_BLOB(TEMP,COMPRESSOR_LEVEL);

    IF (USE_CRYPTER=1) THEN
      TEMP=ENCODE_BLOB(TEMP,CRYPTER_KEY,CRYPTER_ALGORITHM,CRYPTER_MODE);

    IF (PROTOCOL=0) THEN BEGIN

      OUT_PARAMS=UDP(IP,PORT,TEMP);

      IF ((OUT_PARAMS IS NULL) OR (TRIM(OUT_PARAMS)='')) THEN
        SUCCESS=1;

    END ELSE BEGIN
   /*   OUT_PARAMS=HTTP_POST(IP,PORT,PATH,TEMP); */

      IF (USE_CRYPTER=1) THEN
        OUT_PARAMS=DECODE_BLOB(OUT_PARAMS,CRYPTER_KEY,CRYPTER_ALGORITHM,CRYPTER_MODE);

      IF (USE_COMPRESSOR=1) THEN
        OUT_PARAMS=DECOMPRESS_BLOB(OUT_PARAMS);

      IF (OUT_PARAMS IS NOT NULL) THEN
        SUCCESS=CAST(CONFIG_READ(OUT_PARAMS,NAME,'Success','0') AS INTEGER);

    END

    SUSPEND;

    IF (FIRST_RECORD=1) THEN
      BREAK;

  END

END

--

DROP EXTERNAL FUNCTION HTTP_POST

--

DECLARE EXTERNAL FUNCTION HTTP_POST
    CSTRING(32767),
    CSTRING(100),
    CSTRING(32767),
    CSTRING(100),
    CSTRING(100),
    BLOB,
    BLOB,
    INTEGER
RETURNS PARAMETER 7
ENTRY_POINT 'HTTP_POST' MODULE_NAME 'udfibase.dll';

--

DECLARE EXTERNAL FUNCTION SERVER_EXISTS
    CSTRING(32767),
    CSTRING(32767),
    INTEGER
RETURNS INTEGER BY VALUE
ENTRY_POINT 'SERVER_EXISTS' MODULE_NAME 'udfibase.dll';

--

CREATE OR ALTER PROCEDURE SEND_EVENT
(
    SORTING INTEGER,
    FIRST_RECORD INTEGER,
    APPLICATION_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32),
    INCLUDE_SESSION_ID VARCHAR(32),
    EXCLUDE_SESSION_ID VARCHAR(32),
    PROTOCOL INTEGER,
    NAME VARCHAR(100),
    IN_PARAMS BLOB
)
RETURNS
(
    SUCCESS INTEGER,
    OUT_PARAMS BLOB
)
AS
DECLARE TEMP BLOB;
DECLARE SESSION_ID VARCHAR(32);
DECLARE IP VARCHAR(20);
DECLARE PORT VARCHAR(10);
DECLARE HOST VARCHAR(100);
DECLARE PATH VARCHAR(100);
DECLARE USE_CRYPTER INTEGER;
DECLARE CRYPTER_ALGORITHM INTEGER;
DECLARE CRYPTER_MODE INTEGER;
DECLARE CRYPTER_KEY VARCHAR(100);
DECLARE USE_COMPRESSOR INTEGER;
DECLARE COMPRESSOR_LEVEL INTEGER;
DECLARE RND VARCHAR(4000);
BEGIN

  IF (PROTOCOL=0) THEN
    RND=RANDOM_STRING(32);
  ELSE
    RND=RANDOM_STRING(1024*3); /* for fast reaction */

  FOR SELECT SESSION_ID, IP, PORT, HOST, PATH,
             USE_CRYPTER, CRYPTER_ALGORITHM, CRYPTER_MODE, CRYPTER_KEY,
             USE_COMPRESSOR, COMPRESSOR_LEVEL
        FROM GET_EVENT_SESSIONS(:SORTING,:APPLICATION_ID,:ACCOUNT_ID,:PROTOCOL)
       WHERE ((:EXCLUDE_SESSION_ID IS NULL) OR (SESSION_ID<>:EXCLUDE_SESSION_ID))
         AND ((:INCLUDE_SESSION_ID IS NULL) OR (SESSION_ID=:INCLUDE_SESSION_ID))
        INTO :SESSION_ID, :IP, :PORT, :HOST, :PATH,
             :USE_CRYPTER, :CRYPTER_ALGORITHM, :CRYPTER_MODE, :CRYPTER_KEY,
             :USE_COMPRESSOR, :COMPRESSOR_LEVEL DO BEGIN

    SUCCESS=0;

    TEMP=CONFIG_WRITE(IN_PARAMS,NAME,'rnd',RND);
    TEMP=CONFIG_WRITE(TEMP,NAME,'SessionId',SESSION_ID);

    IF (USE_COMPRESSOR=1) THEN
      TEMP=COMPRESS_BLOB(TEMP,COMPRESSOR_LEVEL);

    IF (USE_CRYPTER=1) THEN
      TEMP=ENCODE_BLOB(TEMP,CRYPTER_KEY,CRYPTER_ALGORITHM,CRYPTER_MODE);

    IF (PROTOCOL=0) THEN BEGIN

      OUT_PARAMS=UDP(IP,PORT,TEMP);

      IF ((OUT_PARAMS IS NULL) OR (TRIM(OUT_PARAMS)='')) THEN
        SUCCESS=1;

    END ELSE BEGIN
      IF (SERVER_EXISTS(IP,PORT,100)=1) THEN BEGIN

        OUT_PARAMS=HTTP_POST(IP,PORT,PATH,'','',TEMP,5000);

        IF (USE_CRYPTER=1) THEN
          OUT_PARAMS=DECODE_BLOB(OUT_PARAMS,CRYPTER_KEY,CRYPTER_ALGORITHM,CRYPTER_MODE);

        IF (USE_COMPRESSOR=1) THEN
          OUT_PARAMS=DECOMPRESS_BLOB(OUT_PARAMS);

        IF (OUT_PARAMS IS NOT NULL) THEN
          SUCCESS=CAST(CONFIG_READ(OUT_PARAMS,NAME,'Success','0') AS INTEGER);
      END

    END

    SUSPEND;

    IF (FIRST_RECORD=1) THEN
      BREAK;

  END

END

--

CREATE OR ALTER PROCEDURE GET_ROUTE_DISTANCE
(
    LAT1 DOUBLE PRECISION,
    LON1 DOUBLE PRECISION,
    LAT2 DOUBLE PRECISION,
    LON2 DOUBLE PRECISION
)
RETURNS (
    DISTANCE DOUBLE PRECISION) 
AS
DECLARE RET BLOB;
DECLARE S VARCHAR(100);
DECLARE PARAMS VARCHAR(250);
DECLARE DIST DOUBLE PRECISION;
BEGIN
  DISTANCE=0.0;

  PARAMS='?Lat1='||CAST(CAST(LAT1 AS NUMERIC(12,9)) AS VARCHAR(30))||
         '&Lon1='||CAST(CAST(LON1 AS NUMERIC(12,9)) AS VARCHAR(30))||
         '&Lat2='||CAST(CAST(LAT2 AS NUMERIC(12,9)) AS VARCHAR(30))||
         '&Lon2='||CAST(CAST(LON2 AS NUMERIC(12,9)) AS VARCHAR(30));

/*  RET=HTTP_GET('192.168.0.7','55508','/ingitmap',PARAMS); */

  IF (RET IS NOT NULL) THEN BEGIN

    S=SUBSTRING(RET FROM 1 FOR 100);

    DISTANCE=CAST(S AS NUMERIC(15,2));

    PARAMS='?Lat1='||CAST(CAST(LAT2 AS NUMERIC(12,9)) AS VARCHAR(30))||
           '&Lon1='||CAST(CAST(LON2 AS NUMERIC(12,9)) AS VARCHAR(30))||
           '&Lat2='||CAST(CAST(LAT1 AS NUMERIC(12,9)) AS VARCHAR(30))||
           '&Lon2='||CAST(CAST(LON1 AS NUMERIC(12,9)) AS VARCHAR(30));

/*    RET=HTTP_GET('192.168.0.7','55508','/ingitmap',PARAMS); */
    S=SUBSTRING(RET FROM 1 FOR 100);
    DIST=CAST(S AS NUMERIC(15,2));

    DISTANCE = IIF(DISTANCE < DIST, DISTANCE, DIST);

  END

END

--

DROP EXTERNAL FUNCTION HTTP_GET

--

DECLARE EXTERNAL FUNCTION HTTP_GET
    CSTRING(32767),
    CSTRING(100),
    CSTRING(32767),
    CSTRING(100),
    CSTRING(100),
    CSTRING(32767),
    BLOB,
    INTEGER
RETURNS PARAMETER 7
ENTRY_POINT 'HTTP_GET' MODULE_NAME 'udfibase.dll';

--

CREATE OR ALTER PROCEDURE GET_ROUTE_DISTANCE
(
    LAT1 DOUBLE PRECISION,
    LON1 DOUBLE PRECISION,
    LAT2 DOUBLE PRECISION,
    LON2 DOUBLE PRECISION
)
RETURNS (
    DISTANCE DOUBLE PRECISION) 
AS
DECLARE RET BLOB;
DECLARE S VARCHAR(100);
DECLARE PARAMS VARCHAR(250);
DECLARE DIST DOUBLE PRECISION;
DECLARE HOST VARCHAR(50)='192.168.0.7';
DECLARE PORT VARCHAR(10)='55508';
BEGIN
  DISTANCE=0.0;

  IF ((LAT1 IS NOT NULL) AND
      (LON1 IS NOT NULL) AND
      (LAT2 IS NOT NULL) AND
      (LON2 IS NOT NULL) AND
      (SERVER_EXISTS(HOST,PORT,500)=1)) THEN BEGIN

    PARAMS='?Lat1='||CAST(CAST(LAT1 AS NUMERIC(12,9)) AS VARCHAR(30))||
           '&Lon1='||CAST(CAST(LON1 AS NUMERIC(12,9)) AS VARCHAR(30))||
           '&Lat2='||CAST(CAST(LAT2 AS NUMERIC(12,9)) AS VARCHAR(30))||
           '&Lon2='||CAST(CAST(LON2 AS NUMERIC(12,9)) AS VARCHAR(30));

    RET=HTTP_GET(HOST,PORT,'/ingitmap','','',PARAMS,5000);

    IF (RET IS NOT NULL) THEN BEGIN

      S=SUBSTRING(RET FROM 1 FOR 100);

      DISTANCE=CAST(S AS NUMERIC(15,2));

      PARAMS='?Lat1='||CAST(CAST(LAT2 AS NUMERIC(12,9)) AS VARCHAR(30))||
             '&Lon1='||CAST(CAST(LON2 AS NUMERIC(12,9)) AS VARCHAR(30))||
             '&Lat2='||CAST(CAST(LAT1 AS NUMERIC(12,9)) AS VARCHAR(30))||
             '&Lon2='||CAST(CAST(LON1 AS NUMERIC(12,9)) AS VARCHAR(30));

      RET=HTTP_GET(HOST,PORT,'/ingitmap','','',PARAMS,5000);
      S=SUBSTRING(RET FROM 1 FOR 100);
      DIST=CAST(S AS NUMERIC(15,2));

      DISTANCE = IIF(DISTANCE < DIST, DISTANCE, DIST);

    END

  END

END

--

DROP VIEW S_DRIVER_FREE

--

DROP VIEW S_DRIVER_PARK_FREE

--

CREATE OR ALTER VIEW S_DRIVERS_EX
AS
SELECT D.*,
       A.PHONE,
       A.DESCRIPTION,
       A.USER_NAME,
       A.DATE_CREATE,
       A.LOCKED,
       A.SURNAME,
       A.NAME,
       A.PATRONYMIC,
       A.FIRM_ID,
       A.PHOTO,
       A.DATE_LOCK,
       A.REASON_LOCK,
       CR.STATE_NUM AS CAR_STATE_NUM,
       CR.BRAND AS CAR_BRAND,
       CR.COLOR AS CAR_COLOR,
       CR.CALLSIGN AS CAR_CALLSIGN,
       CL.NAME AS CALC_NAME,
       M.NAME AS METHOD_NAME,
       F.SMALL_NAME AS FIRM_SMALL_NAME,
       DT.NAME AS DRIVER_TYPE_NAME,
       (CASE WHEN SAC.SUM_CHARGE IS NULL THEN 0.0 ELSE SAC.SUM_CHARGE END) SUM_CHARGE,
       (CASE WHEN SAR.SUM_RECEIPT IS NULL THEN 0.0 ELSE SAR.SUM_RECEIPT END) SUM_RECEIPT,
       ((CASE WHEN SAR.SUM_RECEIPT IS NULL THEN 0.0 ELSE SAR.SUM_RECEIPT END)-
        (CASE WHEN SAC.SUM_CHARGE IS NULL THEN 0.0 ELSE SAC.SUM_CHARGE END)) AS ACTUAL_BALANCE
  FROM DRIVERS D
  JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
  JOIN CARS CR ON CR.CAR_ID=D.CAR_ID
  LEFT JOIN CALCS CL ON CL.CALC_ID=D.CALC_ID
  LEFT JOIN METHODS M ON M.METHOD_ID=D.METHOD_ID
  LEFT JOIN FIRMS F ON F.FIRM_ID=A.FIRM_ID
  LEFT JOIN DRIVER_TYPES DT ON DT.DRIVER_TYPE_ID=D.DRIVER_TYPE_ID
  LEFT JOIN (SELECT ACCOUNT_ID, SUM(SUM_CHARGE) AS SUM_CHARGE
               FROM CHARGES
              GROUP BY ACCOUNT_ID) SAC ON SAC.ACCOUNT_ID=D.DRIVER_ID
  LEFT JOIN (SELECT ACCOUNT_ID, SUM(SUM_RECEIPT) AS SUM_RECEIPT
               FROM RECEIPTS
              GROUP BY ACCOUNT_ID) SAR ON SAR.ACCOUNT_ID=D.DRIVER_ID

--

CREATE OR ALTER VIEW S_DRIVER_PARK_FREE
AS
SELECT *
  FROM S_DRIVERS_EX
 WHERE DRIVER_ID IN (SELECT ACCOUNT_ID FROM SHIFTS
                      WHERE DATE_END IS NULL)
   AND DRIVER_ID NOT IN (SELECT DRIVER_ID FROM PARK_STATES
                          WHERE DATE_OUT IS NULL)
   AND LOCKED=0
   AND ((MIN_BALANCE IS NULL) OR (ACTUAL_BALANCE>MIN_BALANCE))

--

CREATE OR ALTER VIEW S_DRIVER_FREE
AS
SELECT *
  FROM S_DRIVERS_EX
 WHERE DRIVER_ID NOT IN (SELECT ACCOUNT_ID FROM SHIFTS
                          WHERE DATE_END IS NULL)
   AND LOCKED=0
   AND ((MIN_BALANCE IS NULL) OR (ACTUAL_BALANCE>MIN_BALANCE))

--

DROP VIEW S_ACCOUNT_CHARGES

--

DROP VIEW S_ACCOUNT_RECEIPTS

--

CREATE OR ALTER PROCEDURE WAIT_FOR
(
  PERIOD INTEGER, 
  TIMEOUT INTEGER
)
AS
DECLARE I INTEGER=0;
DECLARE MAXI INTEGER=0;
BEGIN
  MAXI=PERIOD/TIMEOUT;
  WHILE (I<MAXI) DO BEGIN
   SLEEP(TIMEOUT);
   I=I+1;
  END
END

--

CREATE OR ALTER PROCEDURE GET_CALL_INFO
(
  CALL_INFO VARCHAR(100)
)
RETURNS
(
  CALL_ACCOUNT_ID VARCHAR(32),
  CALL_NAME VARCHAR(100),
  CALL_REAL_NAME VARCHAR(100),
  CALL_GROUP VARCHAR(4000),
  CALL_DESCRIPTION VARCHAR(250),
  CALL_NAME_DESCRIPTION VARCHAR(250),
  CALL_LINE_NAME VARCHAR(100)
)
AS
DECLARE CALL_ID VARCHAR(32);
DECLARE OPERATOR_ID VARCHAR(32);
DECLARE CALL_PHONE VARCHAR(100);
DECLARE CALLER_DIVERSION VARCHAR(100);
DECLARE IN_CHANNEL VARCHAR(100);
DECLARE PHONE VARCHAR(100);
DECLARE USER_NAME VARCHAR(100);
DECLARE SURNAME VARCHAR(100);
DECLARE NAME VARCHAR(100);
DECLARE PATRONYMIC VARCHAR(100);
DECLARE FIRM_SMALL_NAME VARCHAR(250);
DECLARE CLIENT_GROUP_ID VARCHAR(32);
DECLARE CALL_KIND INTEGER;
DECLARE S VARCHAR(250);
DECLARE L INTEGER;
DECLARE RANGE_MIN BIGINT;
DECLARE RANGE_MAX BIGINT;
DECLARE PHONE_NUM BIGINT;
BEGIN
  CALL_ACCOUNT_ID=NULL;
  CALL_REAL_NAME='Номер скрыт';
  CALL_GROUP='Неизвестно';
  CALL_DESCRIPTION=NULL;
  CALL_KIND=0; /* Unknown */
  CALL_NAME_DESCRIPTION=NULL;
  CALL_LINE_NAME=NULL;

  SELECT C.CALL_ID, C.CALLER_ID, C.CALLER_PHONE,
         C.CALLER_DIVERSION, C.IN_CHANNEL, O.NAME
    FROM CALLS C
    LEFT JOIN OPERATORS O ON O.OPERATOR_ID=C.OPERATOR_ID
   WHERE CALL_ID=:CALL_INFO
    INTO :CALL_ID, :CALL_ACCOUNT_ID, :CALL_PHONE,
         :CALLER_DIVERSION, :IN_CHANNEL, :CALL_NAME_DESCRIPTION;

  IF (CALL_ID IS NOT NULL) THEN BEGIN

    IF (IN_CHANNEL IS NOT NULL) THEN BEGIN

      IN_CHANNEL=SUB_STRING(IN_CHANNEL,STRING_LENGTH('CallServerSipChannel')+1,STRING_LENGTH(IN_CHANNEL));

      CALL_LINE_NAME=IN_CHANNEL;

    END

    IF (CALLER_DIVERSION IS NOT NULL) THEN BEGIN

      IF (CALLER_DIVERSION='3912777787') THEN
        CALL_LINE_NAME='2777787';

      IF (CALLER_DIVERSION='3912550550') THEN
        CALL_LINE_NAME='2550550';

      IF (CALLER_DIVERSION='3912550550') THEN
        CALL_LINE_NAME='2550550';

    END

    IF (CALL_LINE_NAME IS NOT NULL) THEN
      CALL_LINE_NAME=''||CALL_LINE_NAME;

  END ELSE BEGIN

    EXECUTE PROCEDURE GET_OPERATOR(CALL_INFO)
     RETURNING_VALUES OPERATOR_ID, RANGE_MIN, RANGE_MAX, PHONE_NUM;

    IF (OPERATOR_ID IS NOT NULL) THEN
      SELECT NAME
        FROM OPERATORS
       WHERE OPERATOR_ID=:OPERATOR_ID
        INTO :CALL_NAME_DESCRIPTION;

  END

  IF (CALL_ACCOUNT_ID IS NULL) THEN BEGIN

    IF (CALL_PHONE IS NULL) THEN
      CALL_PHONE=:CALL_INFO;

    FOR SELECT A.ACCOUNT_ID
          FROM CLIENTS C
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=C.CLIENT_ID
          LEFT JOIN CLIENT_PHONES CP ON CP.CLIENT_ID=C.CLIENT_ID
         WHERE CP.PHONE=:CALL_PHONE
            OR A.PHONE=:CALL_PHONE
          INTO :CALL_ACCOUNT_ID DO BEGIN
      CALL_KIND=1; /* Client */
      BREAK;
    END

    IF (CALL_ACCOUNT_ID IS NULL) THEN BEGIN

      FOR SELECT A.ACCOUNT_ID
            FROM ACCOUNTS A
            JOIN DRIVERS D ON D.DRIVER_ID=A.ACCOUNT_ID
           WHERE A.PHONE=:CALL_PHONE
            INTO :CALL_ACCOUNT_ID DO BEGIN
        CALL_KIND=2; /* Driver */
        BREAK;
      END

      IF (CALL_ACCOUNT_ID IS NULL) THEN BEGIN

        FOR SELECT A.ACCOUNT_ID
              FROM ACCOUNTS A
              JOIN DISPATCHERS D ON D.DISPATCHER_ID=A.ACCOUNT_ID
             WHERE A.PHONE=:CALL_PHONE
              INTO :CALL_ACCOUNT_ID DO BEGIN
          CALL_KIND=3; /* Dispatcher */
          BREAK;
        END

        IF (CALL_ACCOUNT_ID IS NULL) THEN BEGIN

          FOR SELECT A.ACCOUNT_ID
                FROM ACCOUNTS A
               WHERE A.PHONE=:CALL_PHONE
              INTO :CALL_ACCOUNT_ID DO BEGIN
            CALL_KIND=4; /* Account */
            BREAK;
          END

        END

      END

    END

  END

  CALL_REAL_NAME=TRIM(CALL_PHONE);

  L=STRING_LENGTH(CALL_REAL_NAME);
  IF (L=7) THEN BEGIN
    CALL_NAME=SUB_STRING(CALL_REAL_NAME,1,3)||' '||
              SUB_STRING(CALL_REAL_NAME,4,2)||' '||
              SUB_STRING(CALL_REAL_NAME,6,2);
  END ELSE BEGIN
    IF (L=12) THEN BEGIN
      CALL_NAME=SUB_STRING(CALL_REAL_NAME,1,2)||' '||
                SUB_STRING(CALL_REAL_NAME,3,3)||' '||
                SUB_STRING(CALL_REAL_NAME,5,3)||' '||
                SUB_STRING(CALL_REAL_NAME,8,2)||' '||
                SUB_STRING(CALL_REAL_NAME,10,2);
    END
  END

  IF (CALL_ACCOUNT_ID IS NOT NULL) THEN BEGIN

    IF (CALL_KIND=0) THEN BEGIN

      SELECT CASE
               WHEN C.CLIENT_ID IS NOT NULL THEN 1 /* Client */
               WHEN D1.DRIVER_ID IS NOT NULL THEN 2 /* Driver */
               WHEN D2.DISPATCHER_ID IS NOT NULL THEN 3 /* Dispatcher */
               ELSE 4
             END
        FROM ACCOUNTS A
        LEFT JOIN CLIENTS C ON C.CLIENT_ID=A.ACCOUNT_ID
        LEFT JOIN DRIVERS D1 ON D1.DRIVER_ID=A.ACCOUNT_ID
        LEFT JOIN DISPATCHERS D2 ON D2.DISPATCHER_ID=A.ACCOUNT_ID
       WHERE A.ACCOUNT_ID=:CALL_ACCOUNT_ID
        INTO :CALL_KIND;

    END

    FOR SELECT A.USER_NAME, A.SURNAME, A.NAME,
               A.PATRONYMIC, F.SMALL_NAME
          FROM ACCOUNTS A
          LEFT JOIN FIRMS F ON F.FIRM_ID=A.FIRM_ID
         WHERE A.ACCOUNT_ID=:CALL_ACCOUNT_ID
          INTO :USER_NAME, :SURNAME, :NAME,
               :PATRONYMIC, :FIRM_SMALL_NAME DO BEGIN
      BREAK;
    END

    CALL_DESCRIPTION=NULL;
    IF (NAME IS NOT NULL) THEN
      CALL_DESCRIPTION=TRIM(NAME);
    IF (PATRONYMIC IS NOT NULL) THEN
      CALL_DESCRIPTION=CALL_DESCRIPTION||' '||TRIM(PATRONYMIC);
    IF (USER_NAME IS NOT NULL) THEN
      CALL_DESCRIPTION=TRIM(USER_NAME)||' - '||CALL_DESCRIPTION;
    IF (FIRM_SMALL_NAME IS NOT NULL) THEN
      CALL_DESCRIPTION=CALL_DESCRIPTION||' ['||TRIM(FIRM_SMALL_NAME)||']';

    IF (CALL_KIND=1) THEN BEGIN

      FOR SELECT LOWER(CP.DESCRIPTION)
            FROM CLIENT_PHONES CP
           WHERE CP.PHONE=:CALL_PHONE
             AND CP.CLIENT_ID=:CALL_ACCOUNT_ID
            INTO :S DO BEGIN

        CALL_NAME_DESCRIPTION=TRIM(S||' '||CALL_NAME_DESCRIPTION);
        BREAK;
      END

      CLIENT_GROUP_ID=NULL;

      SELECT CLIENT_GROUP_ID
        FROM CLIENTS
       WHERE CLIENT_ID=:CALL_ACCOUNT_ID
        INTO :CLIENT_GROUP_ID;

      IF (CLIENT_GROUP_ID IS NOT NULL) THEN BEGIN

        CALL_GROUP=NULL;

        EXECUTE PROCEDURE GET_CLIENT_GROUP_PATH(CLIENT_GROUP_ID,'/')
         RETURNING_VALUES CALL_GROUP;

      END

      IF (CALL_GROUP IS NOT NULL) THEN
        CALL_GROUP='Клиенты/'||CALL_GROUP;
      ELSE
        CALL_GROUP='Клиенты';


    END ElSE BEGIN

      IF (CALL_KIND=2) THEN BEGIN

        CALL_GROUP='Водители';

      END ELSE BEGIN

        IF (CALL_KIND=3) THEN
          CALL_GROUP='Диспетчеры';
        ElSE
          CALL_GROUP='Учетные записи';

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE IU_SAMPLE_VOICE
(
  SAMPLE_TEXT VARCHAR(1000),
  VOICE_DATA BLOB,
  TYPE_SAMPLE INTEGER,
  DESCRIPTION VARCHAR(250),
  PRIORITY INTEGER
)
AS
DECLARE SAMPLE_VOICE_ID VARCHAR(32)=NULL;
BEGIN

  SELECT FIRST 1
         SAMPLE_VOICE_ID
    FROM SAMPLE_VOICES
   WHERE TYPE_SAMPLE=:TYPE_SAMPLE
     AND UPPER(SAMPLE_TEXT)=UPPER(:SAMPLE_TEXT)
    INTO :SAMPLE_VOICE_ID;

  IF (SAMPLE_VOICE_ID IS NULL) THEN

    INSERT INTO SAMPLE_VOICES (SAMPLE_VOICE_ID,SAMPLE_TEXT,VOICE_DATA,TYPE_SAMPLE,DESCRIPTION,PRIORITY)
         VALUES (GET_UNIQUE_ID(),:SAMPLE_TEXT,:VOICE_DATA,:TYPE_SAMPLE,:DESCRIPTION,:PRIORITY);

  ELSE

    UPDATE SAMPLE_VOICES
       SET SAMPLE_TEXT=:SAMPLE_TEXT,
           VOICE_DATA=:VOICE_DATA,
           TYPE_SAMPLE=:TYPE_SAMPLE,
           DESCRIPTION=:DESCRIPTION,
           PRIORITY=:PRIORITY
     WHERE SAMPLE_VOICE_ID=:SAMPLE_VOICE_ID;

END

--

CREATE GLOBAL TEMPORARY TABLE TMP_DRIVER_TIMES
(
  ID VARCHAR(32) NOT NULL,
  NAME VARCHAR(250) NOT NULL,
  DATE_BEGIN TIMESTAMP NOT NULL,
  DATE_END TIMESTAMP,
  USED INTEGER NOT NULL,
  VALID INTEGER NOT NULL,
  TIME_TYPE INTEGER NOT NULL,
  SUM_CHARGE NUMERIC(15,2),
  PRIMARY KEY (ID)
) ON COMMIT DELETE ROWS;

--

CREATE OR ALTER PROCEDURE GET_DRIVER_TIMES
(
    DRIVER_ID VARCHAR(32),
    SHIFT_BEGIN TIMESTAMP,
    SHIFT_END TIMESTAMP,
    ABSENCE_COST NUMERIC(5,2),
    MAX_LUNCH_TIME NUMERIC(5,2),
    MAX_AIRPORT_TIME NUMERIC(5,2),
    MAX_ABSENCE_TIME NUMERIC(4,2),
    USE_INVALID INTEGER
)
RETURNS (
    NAME VARCHAR(250),
    DATE_BEGIN TIMESTAMP,
    DATE_END TIMESTAMP,
    MINUTES NUMERIC(15,2),
    TIME_TYPE INTEGER,
    USED INTEGER,
    VALID INTEGER,
    SUM_CHARGE NUMERIC(15,2))
AS
DECLARE SHIFT_SECONDS INTEGER;
DECLARE ITEMP NUMERIC(15,2);
DECLARE D1 TIMESTAMP;
DECLARE D2 TIMESTAMP;
DECLARE DTEMP1 TIMESTAMP;
DECLARE DTEMP2 TIMESTAMP;
DECLARE LUNCH_CODE_MESSAGE_ID VARCHAR(32) = 'C7FE57F03AFB9C234E5A06430014D0EF';
DECLARE CRASH_CODE_MESSAGE_ID VARCHAR(32) = '01048369872CABF847C5BF24E44DAB62';
DECLARE INCIDENT_CODE_MESSAGE_ID VARCHAR(32) = 'F009084F05778ED547A4285A65D20FFB';
DECLARE FREE_CODE_MESSAGE_ID VARCHAR(32) = '446D510C3E7889F44D52DE0EFCB06768';
DECLARE AIRPORT_STREET_ID VARCHAR(32) = 'CE097743BBC095D44A1B61E8B461481F';
DECLARE ORDER_ID VARCHAR(32);
DECLARE ORDER_NUM VARCHAR(10);
DECLARE RESULT_NAME VARCHAR(100);
DECLARE PARK_NAME VARCHAR(100);
DECLARE PARK_DESC VARCHAR(250);
DECLARE ID VARCHAR(32);
DECLARE PRIOR_ID VARCHAR(32);
DECLARE PRIOR_TIME_TYPE INTEGER;
DECLARE MAX_LUNCH_COUNT INTEGER;
DECLARE AIRPORT_DIRECTION INTEGER;
DECLARE LUNCH_COUNT INTEGER;
DECLARE S1 VARCHAR(100);
DECLARE S2 VARCHAR(100);
BEGIN

  SHIFT_SECONDS=DATEDIFF(SECOND,SHIFT_BEGIN,SHIFT_END);

  IF ((SHIFT_SECONDS IS NOT NULL) AND (SHIFT_SECONDS>0.0)) THEN BEGIN

    DELETE FROM TMP_DRIVER_TIMES;

    MAX_LUNCH_COUNT=(SHIFT_SECONDS/60.0)/480; /* 480 - 8 hours */

    DTEMP2=SHIFT_BEGIN;
    NAME='Отсутствие на смене';

    /* shift absence time */

    FOR SELECT DATE_BEGIN, DATE_END
          FROM SHIFTS
         WHERE ((DATE_BEGIN<=:SHIFT_BEGIN AND (DATE_END IS NULL OR DATE_END>=:SHIFT_BEGIN)) OR DATE_BEGIN>:SHIFT_BEGIN)
           AND ((DATE_BEGIN<=DATE_END AND DATE_END IS NOT NULL) OR DATE_END IS NULL)
           AND ACCOUNT_ID=:DRIVER_ID
         ORDER BY DATE_BEGIN
          INTO :D1, :D2 DO BEGIN

      IF (D1<SHIFT_BEGIN) THEN
        D1=SHIFT_BEGIN;

      IF (D2>SHIFT_END) THEN
        D2=SHIFT_END;

      IF (D1>DTEMP2) THEN
        INSERT INTO TMP_DRIVER_TIMES (ID,NAME,DATE_BEGIN,DATE_END,USED,VALID,TIME_TYPE)
                              VALUES (GET_UNIQUE_ID(),:NAME,:DTEMP2,:D1,1,1,0);

      IF (D2=SHIFT_END) THEN
        BREAK;

      DTEMP2=D2;

    END

    /* Orders time */

    DTEMP2=NULL;
    
    FOR SELECT O.ORDER_ID, O1.DATE_BEGIN, O.DATE_END, O.ORDER_NUM, R.NAME, Z1.NAME, Z2.NAME,
               CASE
                /* WHEN O.STREET_ID=:AIRPORT_STREET_ID THEN 1 */
                 WHEN RO.STREET_ID=:AIRPORT_STREET_ID THEN 2
                 ELSE 0
                END AS AIRPORT_DIRECTION,
               CASE
                 WHEN O.RESULT_ID='6DD8DFDC671DB9A742E418FD268E7DC4' THEN O.COST_FACT
                 ELSE NULL
                END
          FROM ORDERS O
          JOIN (SELECT PARENT_ID,
                       MIN(DATE_BEGIN) AS DATE_BEGIN
                  FROM ORDERS
                 WHERE DRIVER_ID=:DRIVER_ID
                   AND DATE_HISTORY IS NOT NULL
                 GROUP BY PARENT_ID) O1 ON O1.PARENT_ID=O.ORDER_ID   
          LEFT JOIN ZONES Z1 ON Z1.ZONE_ID=O.ZONE_ID
          LEFT JOIN RESULTS R ON R.RESULT_ID=O.RESULT_ID
          LEFT JOIN ROUTES RO ON RO.ORDER_ID=O.ORDER_ID AND 
                                 RO.PRIORITY=(SELECT MAX(PRIORITY)
                                                FROM ROUTES
                                               WHERE ORDER_ID=O.ORDER_ID)
          LEFT JOIN ZONES Z2 ON Z2.ZONE_ID=RO.ZONE_ID
         WHERE O.DRIVER_ID=:DRIVER_ID
           AND O.FINISHED=1
           AND O.DATE_HISTORY IS NULL
           AND O1.DATE_BEGIN>=:SHIFT_BEGIN
           AND O1.DATE_BEGIN<=:SHIFT_END
           AND O.RESULT_ID NOT IN ('5F54734558C5857445839E8800947005',
                                   '25236D63D02FA50F4D39DF1A2F86B6F6',
                                   'D442C437F10AA16447252BE436C90807',
                                   'CCBAB9B83127B43F44F0B5C2708ECF46',
                                   '44A2C4905136BCFE4C99C718E7FB0052',
                                   '3C1737139C50A9A84FA5183FEAAEDE8E')
         ORDER BY O1.DATE_BEGIN
          INTO :ORDER_ID, :D1, :D2, :ORDER_NUM, :RESULT_NAME, :S1, :S2,
               :AIRPORT_DIRECTION, :SUM_CHARGE DO BEGIN

      IF (DTEMP2 IS NOT NULL) THEN
        IF (D1<DTEMP2) THEN
          D1=DTEMP2;

      SELECT CASE
               WHEN (COUNT(*)>0) OR (:D1>=:D2) THEN 0
               ELSE 1
              END
        FROM TMP_DRIVER_TIMES
       WHERE DATE_BEGIN<=:D1
         AND DATE_END>=:D2
         AND TIME_TYPE<>2
        INTO :VALID;

      /*  IF (AIRPORT_DIRECTION=1) THEN BEGIN

          NAME='Подача в аэропорт';
          INSERT INTO TMP_DRIVER_TIMES (ID,NAME,DATE_BEGIN,DATE_END,USED,TIME_TYPE)
                                VALUES (GET_UNIQUE_ID(),:NAME,:D1,NULL,0,4);

        END */

      NAME='Заказ #'||CAST(ORDER_NUM AS VARCHAR(10));

      IF ((S1 IS NOT NULL) OR (S2 IS NOT NULL)) THEN BEGIN

        IF (S1 IS NULL) THEN
          S1='?';

        IF (S2 IS NULL) THEN
          S2='?';

        NAME=NAME||' | '||S1||' > '||S2;

      END

      IF (RESULT_NAME IS NOT NULL) THEN
        NAME=NAME||' ('||RESULT_NAME||')';

      INSERT INTO TMP_DRIVER_TIMES (ID,NAME,DATE_BEGIN,DATE_END,USED,VALID,TIME_TYPE,SUM_CHARGE)
                            VALUES (GET_UNIQUE_ID(),:NAME,:D1,:D2,0,:VALID,2,:SUM_CHARGE);

      /* from */
      IF (AIRPORT_DIRECTION=2) THEN BEGIN

        NAME='Возвращение из аэропорта';
        INSERT INTO TMP_DRIVER_TIMES (ID,NAME,DATE_BEGIN,DATE_END,USED,VALID,TIME_TYPE)
                              VALUES (GET_UNIQUE_ID(),:NAME,:D1,NULL,0,:VALID,1);

      END


      DTEMP2=D2;

    END

    /* Parks time */

    FOR SELECT PS.DATE_IN, PS.DATE_OUT, P.NAME, P.DESCRIPTION
          FROM PARK_STATES PS
          JOIN PARKS P ON P.PARK_ID=PS.PARK_ID
         WHERE PS.DRIVER_ID=:DRIVER_ID
           AND PS.DATE_IN>=:SHIFT_BEGIN
           AND PS.DATE_IN<=:SHIFT_END
          INTO :D1, :D2, :PARK_NAME, :PARK_DESC DO BEGIN

      IF (D2 IS NULL) THEN
        D2=SHIFT_END;

      SELECT CASE
               WHEN (COUNT(*)>0) OR (:D1>=:D2) THEN 0
               ELSE 1
              END
        FROM TMP_DRIVER_TIMES
       WHERE DATE_BEGIN<=:D1
         AND DATE_END>=:D2
        INTO :VALID;

      NAME='Стоянка '||PARK_NAME;

      IF (PARK_DESC IS NOT NULL) THEN
        NAME=NAME||' - '||PARK_DESC||'';

      INSERT INTO TMP_DRIVER_TIMES (ID,NAME,DATE_BEGIN,DATE_END,USED,VALID,TIME_TYPE)
                            VALUES (GET_UNIQUE_ID(),:NAME,:D1,:D2,0,:VALID,5);

    END

    /* Lunch time */

    NAME='Обед';

    FOR SELECT DATE_IN
          FROM IN_MESSAGES
         WHERE CODE_MESSAGE_ID=:LUNCH_CODE_MESSAGE_ID
           AND DATE_IN>=:SHIFT_BEGIN
           AND DATE_IN<=:SHIFT_END
           AND SENDER_ID=:DRIVER_ID
          INTO :D1 DO BEGIN

      INSERT INTO TMP_DRIVER_TIMES (ID,NAME,DATE_BEGIN,DATE_END,USED,VALID,TIME_TYPE)
                            VALUES (GET_UNIQUE_ID(),:NAME,:D1,NULL,0,1,6);

    END

    /* Crash, incident, free time */

    FOR SELECT DATE_IN,
               CASE
                 WHEN CODE_MESSAGE_ID=:CRASH_CODE_MESSAGE_ID THEN 'Поломка'
                 WHEN CODE_MESSAGE_ID=:INCIDENT_CODE_MESSAGE_ID THEN 'Черезвычайное проишествие'
                 WHEN CODE_MESSAGE_ID=:FREE_CODE_MESSAGE_ID THEN 'Свободная посадка'
                END AS NAME,
               CASE
                 WHEN CODE_MESSAGE_ID=:FREE_CODE_MESSAGE_ID THEN 1
                 ELSE 0
                END AS USED
          FROM IN_MESSAGES
         WHERE CODE_MESSAGE_ID IN (:CRASH_CODE_MESSAGE_ID,
                                   :INCIDENT_CODE_MESSAGE_ID,
                                   :FREE_CODE_MESSAGE_ID)
           AND DATE_IN>=:SHIFT_BEGIN
           AND DATE_IN<=:SHIFT_END
           AND SENDER_ID=:DRIVER_ID
         ORDER BY DATE_IN
          INTO :D1, :NAME, :USED DO BEGIN

      INSERT INTO TMP_DRIVER_TIMES (ID,NAME,DATE_BEGIN,DATE_END,USED,VALID,TIME_TYPE)
                            VALUES (GET_UNIQUE_ID(),:NAME,:D1,NULL,:USED,1,7);
    END
    
    /* Align times */

    PRIOR_ID=NULL;
    DTEMP1=NULL;
    DTEMP2=NULL;
    PRIOR_TIME_TYPE=NULL;
    NAME='Отсутствие на стоянке';
    LUNCH_COUNT=0;

    FOR SELECT ID, DATE_BEGIN, DATE_END, TIME_TYPE
          FROM TMP_DRIVER_TIMES
         WHERE VALID=(CASE
                        WHEN :USE_INVALID=1 THEN 0
                        ELSE 1
                       END)
            OR VALID=1
         ORDER BY DATE_BEGIN ASC, TIME_TYPE DESC
          INTO :ID, :D1, :D2, :TIME_TYPE DO BEGIN

      IF (D1<SHIFT_BEGIN) THEN BEGIN

        D1=SHIFT_BEGIN;

        UPDATE TMP_DRIVER_TIMES
           SET DATE_BEGIN=:D1
         WHERE ID=:ID;

      END

      IF (D2>SHIFT_END) THEN BEGIN

        D2=SHIFT_END;

        UPDATE TMP_DRIVER_TIMES
           SET DATE_END=:D2
         WHERE ID=:ID;

      END

      IF (DTEMP2 IS NOT NULL) THEN BEGIN

        IF (D1<=DTEMP2) THEN BEGIN

          D1=DTEMP2;

          UPDATE TMP_DRIVER_TIMES
             SET DATE_BEGIN=:D1
           WHERE ID=:ID;

        END ELSE BEGIN

          INSERT INTO TMP_DRIVER_TIMES (ID,NAME,DATE_BEGIN,DATE_END,USED,VALID,TIME_TYPE)
                                VALUES (GET_UNIQUE_ID(),:NAME,:DTEMP2,:D1,1,1,99);

        END

      END ELSE BEGIN

        IF (PRIOR_TIME_TYPE=1) THEN BEGIN

          ITEMP=DATEDIFF(MILLISECOND,DTEMP1,D1)/(1000*60.0);

          IF (ITEMP<=MAX_AIRPORT_TIME) THEN BEGIN

            UPDATE TMP_DRIVER_TIMES
               SET DATE_END=:D1
             WHERE ID=:PRIOR_ID;

          END ELSE BEGIN

            DTEMP1=DATEADD(MINUTE,MAX_AIRPORT_TIME,DTEMP1);
          
            UPDATE TMP_DRIVER_TIMES
               SET DATE_END=:DTEMP1
             WHERE ID=:PRIOR_ID;

            INSERT INTO TMP_DRIVER_TIMES (ID,NAME,DATE_BEGIN,DATE_END,USED,VALID,TIME_TYPE)
                                  VALUES (GET_UNIQUE_ID(),:NAME,:DTEMP1,:D1,1,1,99);
          END

        END

        IF (PRIOR_TIME_TYPE=6) THEN BEGIN

          IF (LUNCH_COUNT<MAX_LUNCH_COUNT) THEN BEGIN

            LUNCH_COUNT=LUNCH_COUNT+1;

            ITEMP=DATEDIFF(MILLISECOND,DTEMP1,D1)/(1000*60.0);

            IF (ITEMP<=MAX_LUNCH_TIME) THEN BEGIN

              UPDATE TMP_DRIVER_TIMES
                 SET DATE_END=:D1
               WHERE ID=:PRIOR_ID;

            END ELSE BEGIN

              DTEMP1=DATEADD(MINUTE,MAX_LUNCH_TIME,DTEMP1);

              UPDATE TMP_DRIVER_TIMES
                 SET DATE_END=:DTEMP1
               WHERE ID=:PRIOR_ID;

              INSERT INTO TMP_DRIVER_TIMES (ID,NAME,DATE_BEGIN,DATE_END,USED,VALID,TIME_TYPE)
                                    VALUES (GET_UNIQUE_ID(),:NAME,:DTEMP1,:D1,1,1,99);
            END

          END ELSE BEGIN

            UPDATE TMP_DRIVER_TIMES
               SET NAME=:NAME,
                   DATE_END=:D1,
                   USED=1,
                   VALID=1,
                   TIME_TYPE=99
             WHERE ID=:PRIOR_ID;

          END

        END

      END

      IF (PRIOR_TIME_TYPE=7) THEN BEGIN

        UPDATE TMP_DRIVER_TIMES
           SET DATE_END=:D1
        WHERE ID=:PRIOR_ID;

      END

      PRIOR_ID=ID;
      DTEMP1=D1;
      DTEMP2=D2;
      PRIOR_TIME_TYPE=TIME_TYPE;
    END

    /* Align last time */

    FOR SELECT ID, DATE_END
          FROM TMP_DRIVER_TIMES
         ORDER BY DATE_BEGIN DESC
          INTO :ID, :D2 DO BEGIN

      IF (D2 IS NOT NULL) THEN BEGIN

        IF (D2<SHIFT_END) THEN BEGIN

          INSERT INTO TMP_DRIVER_TIMES (ID,NAME,DATE_BEGIN,DATE_END,USED,VALID,TIME_TYPE)
                                VALUES (GET_UNIQUE_ID(),:NAME,:D2,:SHIFT_END,1,1,99);

        END

      END ELSE BEGIN

         UPDATE TMP_DRIVER_TIMES
            SET DATE_END=:SHIFT_END
          WHERE ID=:ID;

      END

      BREAK;
    END

    /* Output */
    
    FOR SELECT T.NAME, T.DATE_BEGIN, T.DATE_END, T.MINUTES, T.USED, T.TIME_TYPE, T.VALID,
               CASE
                 WHEN (T.USED=1) AND (T.VALID=1) AND (T.MINUTES>:MAX_ABSENCE_TIME) THEN T.MINUTES*:ABSENCE_COST
                 WHEN (T.USED=0) AND (T.SUM_CHARGE IS NOT NULL) THEN T.SUM_CHARGE
                 ELSE NULL
               END AS SUM_CHARGE
          FROM (SELECT NAME, DATE_BEGIN, DATE_END, USED, TIME_TYPE, VALID, SUM_CHARGE,
                       DATEDIFF(MILLISECOND,DATE_BEGIN,DATE_END)/(1000.0*60.0) AS MINUTES
                  FROM TMP_DRIVER_TIMES
                 ORDER BY DATE_BEGIN) T
         WHERE T.VALID=(CASE
                        WHEN :USE_INVALID=1 THEN 0
                        ELSE 1
                       END)
            OR T.VALID=1
          INTO :NAME, :DATE_BEGIN, :DATE_END, :MINUTES, :USED, :TIME_TYPE, :VALID, :SUM_CHARGE DO BEGIN
      SUSPEND;
    END

  END

END

--

INSERT INTO ACCOUNTS (ACCOUNT_ID,USER_NAME,DATE_CREATE)
              VALUES ('077D307B5B4D85754003331FE72C94B8','Сервер Оповещений',CURRENT_TIMESTAMP)

--

CREATE OR ALTER PROCEDURE INCOMING_CALL_CHECK
(
  CALLER_PHONE VARCHAR(100),
  CALLER_DIVERSION VARCHAR(100),
  CHANNEL VARCHAR(100)
)
RETURNS (
  ACCOUNT_ID VARCHAR(32),
  NAME VARCHAR(100),
  PATRONYMIC VARCHAR(100),
  PHONE VARCHAR(100),
  OPERATOR_ID VARCHAR(32),
  FIRM_ID VARCHAR(32),
  SCENARIO_NAME VARCHAR(100),
  CHECKED INTEGER
)
AS
DECLARE CNT INTEGER;
DECLARE RANGE_MIN BIGINT;
DECLARE RANGE_MAX BIGINT;
DECLARE PHONE_NUM BIGINT;
DECLARE L INTEGER;
DECLARE CLIENT_APP_ID VARCHAR(32)='A35F5701A7AA920E40812A71A690910D';
DECLARE DISPATCHERS_ROLE_ID VARCHAR(32)='FF7F332564F795C8411BF28652B22BEA';
DECLARE ALARM_ACCOUNT_ID VARCHAR(32)='077D307B5B4D85754003331FE72C94B8';
BEGIN
  CHECKED=0;

  FIRM_ID='C49DF004D660BBAF434839044848F5B8'; /* АТАКСИ */

  SCENARIO_NAME='2777787';

  IF (CALLER_DIVERSION IS NOT NULL) THEN BEGIN

    IF (CALLER_DIVERSION='3912550550') THEN
      SCENARIO_NAME='2550550';

  END

  IF ((CALLER_PHONE IS NOT NULL) /*AND (CALLER_PHONE<>'Anonymous')*/) THEN BEGIN

    PHONE=CALLER_PHONE;

    EXECUTE PROCEDURE TRANSFORM_PHONE (PHONE)
     RETURNING_VALUES PHONE;

    EXECUTE PROCEDURE CONVERT_PHONE(PHONE,1)
     RETURNING_VALUES PHONE;

    EXECUTE PROCEDURE GET_OPERATOR (PHONE)
     RETURNING_VALUES OPERATOR_ID, RANGE_MIN, RANGE_MAX, PHONE_NUM;


    FOR SELECT A.ACCOUNT_ID, A.NAME, A.PATRONYMIC
          FROM CLIENTS C
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=C.CLIENT_ID
          LEFT JOIN CLIENT_PHONES CP ON CP.CLIENT_ID=C.CLIENT_ID
         WHERE CP.PHONE=:PHONE
            OR A.PHONE=:PHONE
          INTO :ACCOUNT_ID, :NAME, :PATRONYMIC DO BEGIN
      BREAK;
    END

    IF (ACCOUNT_ID IS NULL) THEN BEGIN

      FOR SELECT A.ACCOUNT_ID, A.NAME, A.PATRONYMIC
            FROM ACCOUNTS A
           WHERE A.PHONE=:PHONE
            INTO :ACCOUNT_ID, :NAME, :PATRONYMIC DO BEGIN
        BREAK;
      END

    END

    SELECT COUNT(*)
      FROM BLACKS
     WHERE PHONE=:PHONE
      INTO :CNT;

    IF (CNT=0) THEN BEGIN

      CHECKED=1;

      SELECT COUNT(*)
        FROM SESSIONS
       WHERE APPLICATION_ID=:CLIENT_APP_ID /* Такси клиент*/
         AND ACCOUNT_ID IN (SELECT ACCOUNT_ID
                              FROM ACCOUNT_ROLES
                             WHERE ROLE_ID=:DISPATCHERS_ROLE_ID)
         AND CAST(CONFIG_READ(PARAMS,'TaxiPhoneForm','Enabled','0') AS INTEGER)=1
        INTO :CNT;

      IF (CNT = 0) THEN BEGIN

        IN AUTONOMOUS TRANSACTION DO BEGIN

          INSERT INTO ALARMS (ALARM_ID,SENDER_ID,RECIPIENT_ID,TYPE_ALARM,
                              DATE_BEGIN,DATE_END,
                              CAPTION,TEXT_ALARM)
                      VALUES (GET_UNIQUE_ID(),:ALARM_ACCOUNT_ID,:DISPATCHERS_ROLE_ID,1,
                              CURRENT_TIMESTAMP,DATEADD(SECOND,10,CURRENT_TIMESTAMP),
                              'Включите софтфон!','Идут входящие вызовы. Включите софтфон!');
        END

        EXECUTE PROCEDURE EVENT_ALARM(:CLIENT_APP_ID,NULL,NULL,0)
         RETURNING_VALUES :CNT;

      END

    END

  END

END

--

DROP PROCEDURE TASK_CHECK_DISPATCHER

--

CREATE OR ALTER PROCEDURE GET_EVENT_PARAMS
(
  SESSION_ID VARCHAR(32),
  PROTOCOL INTEGER
)
RETURNS
(
  ACCOUNT_ID VARCHAR(32),
  IP VARCHAR(20),
  PORT VARCHAR(10),
  HOST VARCHAR(100),
  PATH VARCHAR(100),
  USE_CRYPTER INTEGER,
  CRYPTER_ALGORITHM INTEGER,
  CRYPTER_MODE INTEGER,
  CRYPTER_KEY VARCHAR(100),
  USE_COMPRESSOR INTEGER,
  COMPRESSOR_LEVEL INTEGER
)
AS
DECLARE PARAMS BLOB;
DECLARE SECTION VARCHAR(100);
DECLARE S VARCHAR(1000);
BEGIN
  SELECT ACCOUNT_ID, PARAMS
    FROM SESSIONS
   WHERE SESSION_ID=:SESSION_ID
    INTO :ACCOUNT_ID, :PARAMS;

  IF ((PROTOCOL=0) OR (PROTOCOL IS NULL)) THEN
    SECTION='ExternalUdpEventServer';
  ELSE
    SECTION='FirstHttpServerHandlerEvent';

  IF (CONFIG_EXISTS(PARAMS,SECTION)=1) THEN BEGIN

    S=CONFIG_READ(PARAMS,SECTION,'IP','');
    IP=SUB_STRING(CASE WHEN POSITION(';',S)>0 THEN SUBSTRING(S FROM 1 FOR POSITION(';',S)-1) ELSE S END,1,20);
    S=CONFIG_READ(PARAMS,SECTION,'Port','');
    PORT=SUB_STRING(CASE WHEN POSITION(';',S)>0 THEN SUBSTRING(S FROM 1 FOR POSITION(';',S)-1) ELSE S END,1,10);
    HOST=SUB_STRING(CONFIG_READ(PARAMS,SECTION,'Host',''),1,100);
    PATH=SUB_STRING(CONFIG_READ(PARAMS,SECTION,'Path',''),1,100);
    USE_CRYPTER=CAST(CONFIG_READ(PARAMS,SECTION,'UseCrypter','0') AS INTEGER);
    CRYPTER_ALGORITHM=CAST(CONFIG_READ(PARAMS,SECTION,'CrypterAlgorithm','0') AS INTEGER);
    CRYPTER_MODE=CAST(CONFIG_READ(PARAMS,SECTION,'CrypterMode','0') AS INTEGER);
    CRYPTER_KEY=CONFIG_READ(PARAMS,SECTION,'CrypterKey','');
    USE_COMPRESSOR=CAST(CONFIG_READ(PARAMS,SECTION,'UseCompressor','0') AS INTEGER);
    COMPRESSOR_LEVEL=CAST(CONFIG_READ(PARAMS,SECTION,'CompressorLevel','0') AS INTEGER);

  END

END

--

CREATE OR ALTER PROCEDURE GET_EVENT_SESSIONS
(
  SORTING INTEGER,
  IN_APPLICATION_ID VARCHAR(32),
  IN_ACCOUNT_ID VARCHAR(32),
  PROTOCOL INTEGER
)
RETURNS
(
  SESSION_ID VARCHAR(32),
  APPLICATION_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  DATE_CHANGE TIMESTAMP,
  IP VARCHAR(20),
  PORT VARCHAR(10),
  HOST VARCHAR(100),
  PATH VARCHAR(100),
  USE_CRYPTER INTEGER,
  CRYPTER_ALGORITHM INTEGER,
  CRYPTER_MODE INTEGER,
  CRYPTER_KEY VARCHAR(100),
  USE_COMPRESSOR INTEGER,
  COMPRESSOR_LEVEL INTEGER
)
AS
DECLARE SQL VARCHAR(2000);
BEGIN

  SQL='SELECT SESSION_ID, APPLICATION_ID, DATE_CHANGE FROM SESSIONS WHERE ';

  IF (IN_APPLICATION_ID IS NULL) THEN
    SQL=SQL||'APPLICATION_ID IS NOT NULL ';
  ELSE
    SQL=SQL||'APPLICATION_ID='''||IN_APPLICATION_ID||''' ';

  IF (IN_ACCOUNT_ID IS NULL) THEN
    SQL=SQL||'AND ACCOUNT_ID IS NOT NULL ';
  ELSE BEGIN
    SQL=SQL||'AND (ACCOUNT_ID='''||IN_ACCOUNT_ID||''' OR ';
    SQL=SQL||'ACCOUNT_ID IN (SELECT ACCOUNT_ID FROM ACCOUNT_ROLES WHERE ROLE_ID='''||IN_ACCOUNT_ID||''')) ';
  END

  IF (SORTING=0) THEN
    SQL=SQL||'ORDER BY DATE_CHANGE DESC';

  IF (SORTING=1) THEN
    SQL=SQL||'ORDER BY DATE_CHANGE ASC';

  FOR EXECUTE STATEMENT SQL
                   INTO :SESSION_ID, :APPLICATION_ID, :DATE_CHANGE DO BEGIN

    EXECUTE PROCEDURE GET_EVENT_PARAMS (SESSION_ID,PROTOCOL)
     RETURNING_VALUES ACCOUNT_ID, IP, PORT, HOST, PATH,
                      USE_CRYPTER, CRYPTER_ALGORITHM, CRYPTER_MODE, CRYPTER_KEY,
                      USE_COMPRESSOR, COMPRESSOR_LEVEL;

    IF (IP IS NOT NULL) THEN
      SUSPEND;

  END

END

--

CREATE OR ALTER VIEW S_CODE_MESSAGES
AS
SELECT *
  FROM CODE_MESSAGES
 ORDER BY CODE

--

CREATE OR ALTER VIEW S_CALL_RESULTS
AS
SELECT *
  FROM CALL_RESULTS
 ORDER BY PRIORITY

--

CREATE OR ALTER  PROCEDURE TRANSFORM_PHONE
(
  IN_PHONE VARCHAR(100)
)
RETURNS
(
  OUT_PHONE VARCHAR(100)
)
AS
DECLARE VARIABLE PREFIX VARCHAR(100);
DECLARE VARIABLE L INTEGER;
BEGIN
  OUT_PHONE=IN_PHONE;

  IF (IN_PHONE IS NOT NULL) THEN BEGIN

    L=STRING_LENGTH(IN_PHONE);

    IF (L>7) THEN BEGIN

      IF (L<=12) THEN BEGIN

        IF (L=12) THEN BEGIN

          PREFIX=SUB_STRING(IN_PHONE,1,2);

          IF (PREFIX='+7') THEN
            OUT_PHONE=IN_PHONE;

        END ELSE BEGIN

          IF (L>=10) THEN BEGIN

            IF (L=10) THEN BEGIN

              PREFIX=SUB_STRING(IN_PHONE,1,4);

              IF (PREFIX='3912') THEN
                OUT_PHONE=SUB_STRING(IN_PHONE,4,L);
              ELSE
               OUT_PHONE='+7'||IN_PHONE;

            END ELSE BEGIN

              PREFIX=SUB_STRING(IN_PHONE,1,5);

              IF (PREFIX='83912') THEN
                OUT_PHONE=SUB_STRING(IN_PHONE,5,L);
              ELSE BEGIN

               PREFIX=SUB_STRING(IN_PHONE,1,2);
               IF (PREFIX='89') THEN
                 OUT_PHONE='+7'||SUB_STRING(IN_PHONE,2,L);
               ELSE BEGIN

                 PREFIX=SUB_STRING(IN_PHONE,1,1);
                 IF (PREFIX='7') THEN
                   OUT_PHONE='+'||IN_PHONE;
                 ELSE
                   OUT_PHONE=IN_PHONE;

               END

              END

            END

          END

        END

      END

    END ELSE BEGIN

      IF (L=7) THEN
        OUT_PHONE=IN_PHONE;
      ELSE BEGIN
        IF (L=6) THEN
          OUT_PHONE='2'||IN_PHONE;
      END


    END

  END

END

--

ALTER TABLE MAP_OBJECTS
ADD DATE_CREATE TIMESTAMP

--

CREATE OR ALTER VIEW S_MAP_OBJECTS
AS
SELECT MO.*,
       S.NAME AS STREET_NAME,
       S.PREFIX AS STREET_PREFIX,
       L.LOCALITY_ID,
       L.NAME AS LOCALITY_NAME,
       L.PREFIX AS LOCALITY_PREFIX
  FROM MAP_OBJECTS MO
  JOIN STREETS S ON S.STREET_ID=MO.STREET_ID
  JOIN LOCALITIES L ON L.LOCALITY_ID=S.LOCALITY_ID

--

CREATE OR ALTER PROCEDURE I_MAP_OBJECT
(
  STREET_ID VARCHAR(32),
  HOUSE VARCHAR(10),
  LAT DOUBLE PRECISION,
  LON DOUBLE PRECISION,
  DATE_CREATE TIMESTAMP
)
AS
BEGIN
  INSERT INTO MAP_OBJECTS (STREET_ID,HOUSE,LAT,LON,DATE_CREATE)
       VALUES (:STREET_ID,:HOUSE,:LAT,:LON,:DATE_CREATE);
END

--

CREATE OR ALTER PROCEDURE U_MAP_OBJECT
(
  STREET_ID VARCHAR(32),
  HOUSE VARCHAR(10),
  LAT DOUBLE PRECISION,
  LON DOUBLE PRECISION,
  DATE_CREATE TIMESTAMP,
  OLD_STREET_ID VARCHAR(32),
  OLD_HOUSE VARCHAR(10)
)
AS
BEGIN
  UPDATE MAP_OBJECTS
     SET STREET_ID=:STREET_ID,
         HOUSE=:HOUSE,
         LAT=:LAT,
         LON=:LON,
         DATE_CREATE=:DATE_CREATE
   WHERE STREET_ID=:OLD_STREET_ID
     AND HOUSE=:OLD_HOUSE;
END

--

CREATE TABLE MAP_ROUTES
(
  FROM_STREET_ID VARCHAR(32) NOT NULL,
  FROM_HOUSE VARCHAR(10) NOT NULL,
  TO_STREET_ID VARCHAR(32) NOT NULL,
  TO_HOUSE VARCHAR(10) NOT NULL,
  DISTANCE INTEGER,
  DURATION INTEGER,
  DATE_CREATE TIMESTAMP,
  PRIMARY KEY (FROM_STREET_ID,FROM_HOUSE,TO_STREET_ID,TO_HOUSE),
  FOREIGN KEY (FROM_STREET_ID) REFERENCES STREETS (STREET_ID),
  FOREIGN KEY (TO_STREET_ID) REFERENCES STREETS (STREET_ID)
)

--

CREATE OR ALTER VIEW S_MAP_ROUTES
AS
SELECT MR.*,
       S1.NAME AS FROM_STREET_NAME,
       S1.PREFIX AS FROM_STREET_PREFIX,
       L1.LOCALITY_ID AS FROM_LOCALITY_ID,
       L1.NAME AS FROM_LOCALITY_NAME,
       L1.PREFIX AS FROM_LOCALITY_PREFIX,
       S2.NAME AS TO_STREET_NAME,
       S2.PREFIX AS TO_STREET_PREFIX,
       L2.LOCALITY_ID AS TO_LOCALITY_ID,
       L2.NAME AS TO_LOCALITY_NAME,
       L2.PREFIX AS TO_LOCALITY_PREFIX
  FROM MAP_ROUTES MR
  JOIN STREETS S1 ON S1.STREET_ID=MR.FROM_STREET_ID
  JOIN LOCALITIES L1 ON L1.LOCALITY_ID=S1.LOCALITY_ID
  JOIN STREETS S2 ON S2.STREET_ID=MR.TO_STREET_ID
  JOIN LOCALITIES L2 ON L2.LOCALITY_ID=S2.LOCALITY_ID

--

CREATE OR ALTER PROCEDURE I_MAP_ROUTE
(
  FROM_STREET_ID VARCHAR(32),
  FROM_HOUSE VARCHAR(10),
  TO_STREET_ID VARCHAR(32),
  TO_HOUSE VARCHAR(10),
  DISTANCE INTEGER,
  DURATION INTEGER,
  DATE_CREATE TIMESTAMP
)
AS
BEGIN
  INSERT INTO MAP_ROUTES (FROM_STREET_ID,FROM_HOUSE,
                          TO_STREET_ID,TO_HOUSE,
                          DISTANCE,DURATION,DATE_CREATE)
                  VALUES (:FROM_STREET_ID,:FROM_HOUSE,
                          :TO_STREET_ID,:TO_HOUSE,
                          :DISTANCE,:DURATION,:DATE_CREATE);
END

--

CREATE OR ALTER PROCEDURE U_MAP_ROUTE
(
  FROM_STREET_ID VARCHAR(32),
  FROM_HOUSE VARCHAR(10),
  TO_STREET_ID VARCHAR(32),
  TO_HOUSE VARCHAR(10),
  DISTANCE INTEGER,
  DURATION INTEGER,
  DATE_CREATE TIMESTAMP,
  OLD_FROM_STREET_ID VARCHAR(32),
  OLD_FROM_HOUSE VARCHAR(10),
  OLD_TO_STREET_ID VARCHAR(32),
  OLD_TO_HOUSE VARCHAR(10)
)
AS
BEGIN
  UPDATE MAP_ROUTES
     SET FROM_STREET_ID=:FROM_STREET_ID,
         FROM_HOUSE=:FROM_HOUSE,
         TO_STREET_ID=:TO_STREET_ID,
         TO_HOUSE=:TO_HOUSE,
         DISTANCE=:DISTANCE,
         DURATION=:DURATION,
         DATE_CREATE=:DATE_CREATE
   WHERE FROM_STREET_ID=:OLD_FROM_STREET_ID
     AND FROM_HOUSE=:OLD_FROM_HOUSE
     AND TO_STREET_ID=:OLD_TO_STREET_ID
     AND TO_HOUSE=:OLD_TO_HOUSE;
END

--

CREATE OR ALTER PROCEDURE D_MAP_ROUTE
(
  OLD_FROM_STREET_ID VARCHAR(32),
  OLD_FROM_HOUSE VARCHAR(10),
  OLD_TO_STREET_ID VARCHAR(32),
  OLD_TO_HOUSE VARCHAR(10)
)
AS
BEGIN
  DELETE FROM MAP_ROUTES
        WHERE FROM_STREET_ID=:OLD_FROM_STREET_ID
          AND FROM_HOUSE=:OLD_FROM_HOUSE
          AND TO_STREET_ID=:OLD_TO_STREET_ID
          AND TO_HOUSE=:OLD_TO_HOUSE;
END

--

CREATE OR ALTER PROCEDURE GET_STREET_LOCATION
(
  STREET_ID VARCHAR(32),
  HOUSE VARCHAR(10)
)
RETURNS
(
  LAT DOUBLE PRECISION,
  LON DOUBLE PRECISION
)
AS
DECLARE HOST VARCHAR(50) = '192.168.1.3';
DECLARE PORT VARCHAR(10) = '50000';
DECLARE USERNAME VARCHAR(30)='1';
DECLARE PASS VARCHAR(30)='2';
DECLARE PATH VARCHAR(100)='/onlinemap/geocode';
DECLARE COUNTRY VARCHAR(10)='Россия';
DECLARE REGION VARCHAR(50)='Красноярский край';
DECLARE LOCALITY VARCHAR(100);
DECLARE STREET VARCHAR(100);
DECLARE PARAMS VARCHAR(1000);
DECLARE RESULT BLOB;
DECLARE SECTION VARCHAR(50)='Result';
DECLARE PLATITUDE VARCHAR(50)='Latitude';
DECLARE PLONGITUDE VARCHAR(50)='Longitude';
DECLARE S VARCHAR(100);
BEGIN
  LAT=NULL;
  LON=NULL;

  IF ((STREET_ID IS NOT NULL) AND (HOUSE IS NOT NULL) AND
      (SERVER_EXISTS(HOST,PORT,500)=1)) THEN BEGIN

    LOCALITY=NULL;

    SELECT L.NAME, S.NAME
      FROM STREETS S
      JOIN LOCALITIES L ON L.LOCALITY_ID=S.LOCALITY_ID
     WHERE STREET_ID=:STREET_ID
      INTO :LOCALITY, :STREET;

    IF ((LOCALITY IS NOT NULL) AND (STREET IS NOT NULL)) THEN BEGIN


      PARAMS='?contry='||COUNTRY||'&region='||REGION||
             '&locality='||LOCALITY||'&street='||STREET||'&house='||HOUSE;

      RESULT=HTTP_GET(HOST,PORT,PATH,USERNAME,PASS,PARAMS,2000);

      S=CONFIG_READ(RESULT,SECTION,PLATITUDE,'');
      IF (S<>'') THEN BEGIN
        LAT=CAST(S AS NUMERIC(18,15));
        LAT=CAST(LAT AS NUMERIC(8,4));
      END

      S=CONFIG_READ(RESULT,SECTION,PLONGITUDE,'');
      IF (S<>'') THEN BEGIN
        LON=CAST(S AS NUMERIC(18,15));
        LON=CAST(LON AS NUMERIC(8,4));
      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE GET_DISTANCE_FROM_OLD_SERVER
(
  FROM_LAT DOUBLE PRECISION,
  FROM_LON DOUBLE PRECISION,
  TO_LAT DOUBLE PRECISION,
  TO_LON DOUBLE PRECISION
)
RETURNS
(
  DISTANCE INTEGER
)
AS
DECLARE LAT1 VARCHAR(20);
DECLARE LON1 VARCHAR(20);
DECLARE LAT2 VARCHAR(20);
DECLARE LON2 VARCHAR(20);
DECLARE HOST VARCHAR(50) = '109.234.128.18';
DECLARE PORT VARCHAR(10) = '4443';
DECLARE PATH VARCHAR(100)='/ingitmap';
DECLARE USERNAME VARCHAR(30)='1';
DECLARE PASS VARCHAR(30)='2';
DECLARE PARAMS VARCHAR(1000);
DECLARE RESULT BLOB;
DECLARE S VARCHAR(100);
BEGIN
  DISTANCE=NULL;

  IF ((FROM_LAT IS NOT NULL) AND
      (FROM_LON IS NOT NULL) AND
      (TO_LAT IS NOT NULL) AND
      (TO_LON IS NOT NULL)) THEN BEGIN

    LAT1=CAST(CAST(FROM_LAT AS NUMERIC(8,4)) AS VARCHAR(20));
    LON1=CAST(CAST(FROM_LON AS NUMERIC(8,4)) AS VARCHAR(20));
    LAT2=CAST(CAST(TO_LAT AS NUMERIC(8,4)) AS VARCHAR(20));
    LON2=CAST(CAST(TO_LON AS NUMERIC(8,4)) AS VARCHAR(20));

    IF (SERVER_EXISTS(HOST,PORT,500)=1) THEN BEGIN

      PARAMS='?lat1='||LAT1||'&lon1='||LON1||'&lat2='||LAT2||'&lon2='||LON2;

      RESULT=HTTP_GET(HOST,PORT,PATH,USERNAME,PASS,PARAMS,2000);

      S=SUBSTRING(RESULT FROM 1 FOR 100);

      IF (S<>'') THEN
        DISTANCE=CAST(S AS INTEGER);

    END

  END

END

--

CREATE OR ALTER PROCEDURE GET_ROUTE_BY_COORDINATES
(
  FROM_LAT DOUBLE PRECISION,
  FROM_LON DOUBLE PRECISION,
  TO_LAT DOUBLE PRECISION,
  TO_LON DOUBLE PRECISION,
  TRAFFIC INTEGER
)
RETURNS
(
  DISTANCE INTEGER,
  DURATION INTEGER
)
AS
DECLARE LAT1 VARCHAR(20);
DECLARE LON1 VARCHAR(20);
DECLARE LAT2 VARCHAR(20);
DECLARE LON2 VARCHAR(20);
DECLARE HOST VARCHAR(50) = '192.168.1.3';
DECLARE PORT VARCHAR(10) = '50000';
DECLARE USERNAME VARCHAR(30)='1';
DECLARE PASS VARCHAR(30)='2';
DECLARE PATH VARCHAR(100)='/onlinemap/route';
DECLARE PARAMS VARCHAR(1000);
DECLARE RESULT BLOB;
DECLARE SECTION VARCHAR(50)='Result';
DECLARE PDISTANCE VARCHAR(50)='Distance';
DECLARE PDURATION VARCHAR(50)='Duration';
DECLARE S VARCHAR(100);
BEGIN
  DISTANCE=NULL;
  DURATION=NULL;

  IF ((FROM_LAT IS NOT NULL) AND
      (FROM_LON IS NOT NULL) AND
      (TO_LAT IS NOT NULL) AND
      (TO_LON IS NOT NULL)) THEN BEGIN

    LAT1=CAST(CAST(FROM_LAT AS NUMERIC(8,4)) AS VARCHAR(20));
    LON1=CAST(CAST(FROM_LON AS NUMERIC(8,4)) AS VARCHAR(20));
    LAT2=CAST(CAST(TO_LAT AS NUMERIC(8,4)) AS VARCHAR(20));
    LON2=CAST(CAST(TO_LON AS NUMERIC(8,4)) AS VARCHAR(20));

    IF (SERVER_EXISTS(HOST,PORT,500)=1) THEN BEGIN

      PARAMS='?lat1='||LAT1||'&lon1='||LON1||'&lat2='||LAT2||'&lon2='||LON2;

      IF (TRAFFIC=1) THEN
        PARAMS=PARAMS||'&traffic=1';

      RESULT=HTTP_GET(HOST,PORT,PATH,USERNAME,PASS,PARAMS,2000);

      S=CONFIG_READ(RESULT,SECTION,PDISTANCE,'');
      IF (S<>'') THEN
        DISTANCE=CAST(S AS INTEGER);

      S=CONFIG_READ(RESULT,SECTION,PDURATION,'');
      IF (S<>'') THEN
        DURATION=CAST(S AS INTEGER);

    END

    IF (DISTANCE IS NULL) THEN

      EXECUTE PROCEDURE GET_DISTANCE_FROM_OLD_SERVER(FROM_LAT,FROM_LON,TO_LAT,TO_LON)
       RETURNING_VALUES DISTANCE;



  END

END

--

CREATE OR ALTER PROCEDURE GET_ROUTE_BY_STREETS
(
  FROM_STREET_ID VARCHAR(32),
  FROM_HOUSE VARCHAR(10),
  TO_STREET_ID VARCHAR(32),
  TO_HOUSE VARCHAR(10),
  PRIOR_CHECK INTEGER,
  WITH_SAVE INTEGER
)
RETURNS
(
  DISTANCE INTEGER,
  DURATION INTEGER
)
AS
DECLARE DIS INTEGER;
DECLARE DUR INTEGER;
DECLARE ROUTE_EXISTS INTEGER;
DECLARE FROM_LAT DOUBLE PRECISION;
DECLARE FROM_LON DOUBLE PRECISION;
DECLARE FROM_EXISTS INTEGER;
DECLARE TO_LAT DOUBLE PRECISION;
DECLARE TO_LON DOUBLE PRECISION;
DECLARE TO_EXISTS INTEGER;
BEGIN
  DISTANCE=NULL;
  DURATION=NULL;
  ROUTE_EXISTS=0;
  DIS=NULL;
  DUR=NULL;

  IF (PRIOR_CHECK=1) THEN

    FOR SELECT DISTANCE, DURATION
          FROM MAP_ROUTES
         WHERE FROM_STREET_ID=:FROM_STREET_ID
           AND FROM_HOUSE=:FROM_HOUSE
           AND TO_STREET_ID=:TO_STREET_ID
           AND TO_HOUSE=:TO_HOUSE
          INTO :DIS, :DUR DO BEGIN
      ROUTE_EXISTS=1;
      BREAK;
    END

  IF ((DIS IS NULL) OR (DUR IS NULL)) THEN BEGIN

    FROM_LAT=NULL;
    FROM_LON=NULL;
    FROM_EXISTS=0;

    FOR SELECT LAT, LON
          FROM MAP_OBJECTS
         WHERE STREET_ID=:FROM_STREET_ID
           AND HOUSE=:FROM_HOUSE
          INTO :FROM_LAT, :FROM_LON DO BEGIN
      FROM_EXISTS=1;
      BREAK;
    END

    IF ((FROM_LAT IS NULL) OR (FROM_LON IS NULL)) THEN BEGIN

      EXECUTE PROCEDURE GET_STREET_LOCATION(FROM_STREET_ID,FROM_HOUSE)
       RETURNING_VALUES FROM_LAT, FROM_LON;

      IF ((WITH_SAVE=1) AND (FROM_LAT IS NOT NULL) AND (FROM_LON IS NOT NULL)) THEN BEGIN

        IF (FROM_EXISTS=0) THEN

          INSERT INTO MAP_OBJECTS (STREET_ID,HOUSE,LAT,LON,DATE_CREATE)
                           VALUES (:FROM_STREET_ID,:FROM_HOUSE,:FROM_LAT,:FROM_LON,CURRENT_TIMESTAMP);

        ELSE

          UPDATE MAP_OBJECTS
             SET LAT=:FROM_LAT,
                 LON=:FROM_LON,
                 DATE_CREATE=CURRENT_TIMESTAMP
           WHERE STREET_ID=:FROM_STREET_ID
             AND HOUSE=:FROM_HOUSE;

      END

    END

    TO_LAT=NULL;
    TO_LON=NULL;
    TO_EXISTS=0;

    FOR SELECT LAT, LON
          FROM MAP_OBJECTS
         WHERE STREET_ID=:TO_STREET_ID
           AND HOUSE=:TO_HOUSE
          INTO :TO_LAT, :TO_LON DO BEGIN
      TO_EXISTS=1;
      BREAK;
    END

    IF ((TO_LAT IS NULL) OR (TO_LON IS NULL)) THEN BEGIN

      EXECUTE PROCEDURE GET_STREET_LOCATION(TO_STREET_ID,TO_HOUSE)
       RETURNING_VALUES TO_LAT, TO_LON;

      IF ((WITH_SAVE=1) AND (TO_LAT IS NOT NULL) AND (TO_LON IS NOT NULL)) THEN BEGIN

        IF (TO_EXISTS=0) THEN

          INSERT INTO MAP_OBJECTS (STREET_ID,HOUSE,LAT,LON,DATE_CREATE)
                           VALUES (:TO_STREET_ID,:TO_HOUSE,:TO_LAT,:TO_LON,CURRENT_TIMESTAMP);

        ELSE

          UPDATE MAP_OBJECTS
             SET LAT=:TO_LAT,
                 LON=:TO_LON,
                 DATE_CREATE=CURRENT_TIMESTAMP
           WHERE STREET_ID=:TO_STREET_ID
             AND HOUSE=:TO_HOUSE;

      END

    END

    IF ((FROM_LAT IS NOT NULL) AND (FROM_LON IS NOT NULL) AND
        (TO_LAT IS NOT NULL) AND (TO_LON IS NOT NULL)) THEN BEGIN

      EXECUTE PROCEDURE GET_ROUTE_BY_COORDINATES(FROM_LAT,FROM_LON,TO_LAT,TO_LON,0)
       RETURNING_VALUES DIS, DUR;

      IF ((WITH_SAVE=1) AND ((DIS IS NOT NULL) OR (DUR IS NOT NULL))) THEN BEGIN


        IF (ROUTE_EXISTS=0) THEN

          INSERT INTO MAP_ROUTES (FROM_STREET_ID,FROM_HOUSE,TO_STREET_ID,TO_HOUSE,
                                  DISTANCE,DURATION,DATE_CREATE)
                          VALUES (:FROM_STREET_ID,:FROM_HOUSE,:TO_STREET_ID,:TO_HOUSE,
                                  :DIS,:DUR,CURRENT_TIMESTAMP);

        ELSE

          UPDATE MAP_ROUTES
             SET DISTANCE=:DIS,
                 DURATION=:DUR,
                 DATE_CREATE=CURRENT_TIMESTAMP
           WHERE FROM_STREET_ID=:FROM_STREET_ID
             AND FROM_HOUSE=:FROM_HOUSE
             AND TO_STREET_ID=:TO_STREET_ID
             AND TO_HOUSE=:TO_HOUSE;

      END

    END


  END

  DISTANCE=DIS;
  DURATION=DUR;

END

--

CREATE OR ALTER PROCEDURE GET_ROUTE_MAX_BY_STREETS
(
  FROM_STREET_ID VARCHAR(32),
  FROM_HOUSE VARCHAR(10),
  TO_STREET_ID VARCHAR(32),
  TO_HOUSE VARCHAR(10)
)
RETURNS
(
  DISTANCE INTEGER,
  DURATION INTEGER
)
AS
DECLARE DIS1 INTEGER;
DECLARE DUR1 INTEGER;
DECLARE DIS2 INTEGER;
DECLARE DUR2 INTEGER;
BEGIN
  DISTANCE=NULL;
  DURATION=NULL;

  EXECUTE PROCEDURE GET_ROUTE_BY_STREETS(FROM_STREET_ID,FROM_HOUSE,TO_STREET_ID,TO_HOUSE,1,1)
   RETURNING_VALUES DIS1, DUR1;

  EXECUTE PROCEDURE GET_ROUTE_BY_STREETS(TO_STREET_ID,TO_HOUSE,FROM_STREET_ID,FROM_HOUSE,1,1)
   RETURNING_VALUES DIS2, DUR2;

  IF (DIS2 IS NULL) THEN
    DISTANCE=DIS1;
  ELSE
    DISTANCE=IIF(DIS1>DIS2,DIS1,DIS2);

  IF (DUR2 IS NULL) THEN
    DURATION=DUR1;
  ELSE
    DURATION=IIF(DUR1>DUR2,DUR1,DUR2);

END

--

CREATE OR ALTER PROCEDURE PR_FULL_CALC
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE COST_RATE NUMERIC(15,2);
DECLARE COST_FACT NUMERIC(15,2);
DECLARE NON_CASH NUMERIC(15,2);
DECLARE PARENT_SUM NUMERIC(15,2);
DECLARE PHONE VARCHAR(100);
DECLARE PASSW VARCHAR(100);
DECLARE DRIVER_ID VARCHAR(32);
DECLARE SUM_CHARGE NUMERIC(15,2);
DECLARE SUM_RECEIPT NUMERIC(15,2);
DECLARE BALANCE NUMERIC(15,2);
DECLARE MIN_BALANCE NUMERIC(15,2);
DECLARE CHARGE_TYPE_ID VARCHAR(32);
DECLARE RECEIPT_TYPE_ID VARCHAR(32);
DECLARE CLIENT_ID VARCHAR(32);
DECLARE PARENT_ID VARCHAR(32);
DECLARE CALC_ID VARCHAR(32);
DECLARE S VARCHAR(1000);
DECLARE CODE VARCHAR(100);
DECLARE CNT INTEGER;
DECLARE DESCRIPTION VARCHAR(250);
DECLARE USER_NAME VARCHAR(100);
DECLARE CLIENT_TYPE_MESSAGE INTEGER;
DECLARE DRIVER_TYPE_MESSAGE INTEGER;
DECLARE CLIENT_DEST_PORT INTEGER;
DECLARE DRIVER_DEST_PORT INTEGER;
DECLARE IN_MESSAGE_ID VARCHAR(32);
DECLARE FIRM_ID VARCHAR(32);
DECLARE DRIVER_FIRM_ID VARCHAR(32);
DECLARE CLI VARCHAR(32);
DECLARE IS_CODE_PARK SMALLINT;
BEGIN

  DRIVER_FIRM_ID=NULL;
  IS_CODE_PARK = 0;

  SELECT PHONE, DRIVER_ID, COST_RATE, COST_FACT, CLIENT_ID, FIRM_ID
    FROM ORDERS
   WHERE ORDER_ID=:ORDER_ID
    INTO :PHONE, :DRIVER_ID, :COST_RATE, :COST_FACT, :CLIENT_ID, :FIRM_ID;

  IF (DRIVER_ID IS NOT NULL) THEN BEGIN

    SELECT FIRM_ID
      FROM ACCOUNTS
     WHERE ACCOUNT_ID=:DRIVER_ID
      INTO :DRIVER_FIRM_ID;

    FOR SELECT IN_MESSAGE_ID, TYPE_MESSAGE
          FROM IN_MESSAGES
         WHERE ORDER_ID=:ORDER_ID
           AND CODE_MESSAGE_ID='0388BCC17DE1A1754B566F18AEEED771' /* Клиент рассчитался полностью */
           AND SENDER_ID=:DRIVER_ID
           AND DESCRIPTION IS NULL
          INTO :IN_MESSAGE_ID, :DRIVER_TYPE_MESSAGE DO BEGIN

      UPDATE IN_MESSAGES
         SET DESCRIPTION=:ORDER_ID
       WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID;

      BREAK;
    END

  END

  IF ((COST_FACT IS NULL) OR (COST_FACT<=0.0))  THEN
    COST_FACT=:COST_RATE;

  IF (COST_FACT<=0.0) THEN BEGIN

    IF (DRIVER_ID IS NOT NULL) THEN BEGIN

      SELECT CONST_VALUE FROM GET_CONST_VALUE('4BB5C780923E872D436DA3DA31C9E0B0') INTO :S;

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,DRIVER_TYPE_MESSAGE)
       RETURNING_VALUES DRIVER_TYPE_MESSAGE, DRIVER_DEST_PORT;

      IF ((S IS NOT NULL) AND (DRIVER_TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        SELECT PHONE
          FROM ACCOUNTS
         WHERE ACCOUNT_ID=:DRIVER_ID
          INTO :PHONE;

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                  PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID, message_id, source)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                  :S,NULL,:DRIVER_TYPE_MESSAGE,:PHONE,NULL,
                                  2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DRIVER_DEST_PORT,:DRIVER_FIRM_ID, null, null);
      END

    END

    EXECUTE PROCEDURE PR_MANUAL(SESSION_ID,ORDER_ID,ACCOUNT_ID);

  END ELSE BEGIN

    UPDATE ORDERS
       SET FINISHED=1,
           DATE_END=CURRENT_TIMESTAMP,
           WHO_PROCESS_ID=:ACCOUNT_ID,
           COST_FACT=:COST_FACT
     WHERE ORDER_ID=:ORDER_ID;

    EXECUTE PROCEDURE CREATE_ROUTE_HISTORY(ORDER_ID);

    IF (DRIVER_ID IS NOT NULL) THEN BEGIN

      CALC_ID=NULL;

      IF (CLIENT_ID IS NOT NULL) THEN BEGIN

        SELECT C.CALC_ID, A.USER_NAME
          FROM CLIENTS C
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=C.CLIENT_ID
         WHERE CLIENT_ID=:CLIENT_ID
          INTO :CALC_ID, :USER_NAME;

        SELECT COUNT(*)
          FROM CLIENT_CHILDS
         WHERE CHILD_ID=:CLIENT_ID
          INTO :CNT;

        IF (CNT>0) THEN BEGIN

          PARENT_SUM=2.0;

          IF ((COST_FACT>150.0) AND (COST_FACT<=250.0)) THEN
            PARENT_SUM=5.0;

          IF ((COST_FACT>250.0) AND (COST_FACT<=350.0)) THEN
            PARENT_SUM=10.0;

          IF (COST_FACT>350.0) THEN
            PARENT_SUM=20.0;

          SUM_RECEIPT=PARENT_SUM/CNT;

          FOR SELECT CLIENT_ID
                FROM CLIENT_CHILDS

               WHERE CHILD_ID=:CLIENT_ID
                INTO :PARENT_ID DO BEGIN

           RECEIPT_TYPE_ID='9958D6ED64ADAAB94AEF470DA7B5F4F7'; /* Поездка дочернего клиента */

           DESCRIPTION=USER_NAME;

           INSERT INTO RECEIPTS (RECEIPT_ID,RECEIPT_TYPE_ID,ACCOUNT_ID,WHO_CREATE_ID,
                                 SUM_RECEIPT,DATE_RECEIPT,DATE_CREATE,DESCRIPTION,ORDER_ID,FIRM_ID)
                         VALUES (GET_UNIQUE_ID(),:RECEIPT_TYPE_ID,:PARENT_ID,:ACCOUNT_ID,
                                :SUM_RECEIPT,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,:DESCRIPTION,:ORDER_ID,:DRIVER_FIRM_ID);

          END
        END

      END

      BALANCE=NULL;

      IF (CALC_ID IS NOT NULL) THEN BEGIN

        EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:CLIENT_ID)
         RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

      END

      NON_CASH=NULL;

      IF ((BALANCE IS NOT NULL) AND (BALANCE<>0.0)) THEN BEGIN

        IF (BALANCE>=COST_FACT) THEN BEGIN
          NON_CASH=COST_FACT;
          BALANCE=BALANCE-NON_CASH;
        END ELSE BEGIN
          NON_CASH=BALANCE;
          BALANCE=0.0;
        END

      END

      IF (NON_CASH IS NOT NULL) THEN BEGIN

        CHARGE_TYPE_ID='757B9CAF2D3CA5144A7E2A23472990E5'; /* Поездка */

        SUM_CHARGE=NON_CASH;

        INSERT INTO CHARGES (CHARGE_ID,WHO_CREATE_ID,CHARGE_TYPE_ID,ACCOUNT_ID,
                             SUM_CHARGE,DATE_CHARGE,DATE_CREATE,DESCRIPTION,ORDER_ID,FIRM_ID)
                     VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:CHARGE_TYPE_ID,:CLIENT_ID,
                             :SUM_CHARGE,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,NULL,:ORDER_ID,:DRIVER_FIRM_ID);


      END

      IF (SUBSTR(PHONE,1,3)='+79')  THEN BEGIN

        IF (NON_CASH IS NOT NULL) THEN BEGIN

          SELECT CONST_VALUE FROM GET_CONST_VALUE('56140344A440BE774C9007D49CD574E9') INTO :S;

        END ELSE BEGIN

          SELECT CONST_VALUE FROM GET_CONST_VALUE('05B75340B170BF5141FC63F5CDF7FCD6') INTO :S;

        END

        EXECUTE PROCEDURE GET_TYPE_MESSAGE(CLIENT_ID,NULL)
         RETURNING_VALUES CLIENT_TYPE_MESSAGE, CLIENT_DEST_PORT;

        IF ((S IS NOT NULL) AND (CLIENT_TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

          S=REPLACE_STRING(S,'%BALANCE',CAST(CAST(BALANCE AS NUMERIC(15,0)) AS VARCHAR(30)));

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                    PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:CLIENT_ID,CURRENT_TIMESTAMP,
                                    :S,NULL,:CLIENT_TYPE_MESSAGE,:PHONE,NULL,
                                    2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:CLIENT_DEST_PORT,:FIRM_ID);
        END

        SELECT CONST_VALUE FROM GET_CONST_VALUE('E9FFA9589ABD8C174474572B72017BCC') INTO :S; /* РЕГИСТРИРУЙТЕСЬ на: ataxi24.ru */
        SELECT FIRST 1 "PASSWORD" FROM accounts where PHONE = :PHONE INTO :PASSW;

        IF ((S IS NOT NULL) AND (CLIENT_TYPE_MESSAGE IS NOT NULL) AND (PASSW IS NULL)) THEN BEGIN

          /* если нет логина - отпр смс с адресом */
          SELECT CLIENT_ID FROM GET_CLIENT_BY_PHONE(:PHONE) into :cli;
          IF (CLI IS NULL) THEN 
          BEGIN
            SELECT CONST_VALUE FROM GET_CONST_VALUE('+7B36886B6DA3A22E447F67594942BEBA') INTO :S;
                IF (S IS NOT NULL) THEN
                    BEGIN
                      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:CLIENT_ID,CURRENT_TIMESTAMP,
                                                :S,NULL,:CLIENT_TYPE_MESSAGE,:PHONE,NULL,
                                                2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:CLIENT_DEST_PORT,:FIRM_ID);
                    END
          END
        END

      END

      CHARGE_TYPE_ID='E1BC9789DA9DB2B041C0784EBE92BFC9'; /* Выполнение заказа */

      SELECT RET_SUM
        FROM GET_DRIVER_SUM(:DRIVER_ID,:COST_FACT)
        INTO :SUM_CHARGE;

        INSERT INTO CHARGES (CHARGE_ID,WHO_CREATE_ID,CHARGE_TYPE_ID,ACCOUNT_ID,
                             SUM_CHARGE,DATE_CHARGE,DATE_CREATE,DESCRIPTION,ORDER_ID,FIRM_ID)
                     VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:CHARGE_TYPE_ID,:DRIVER_ID,
                             :SUM_CHARGE,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,NULL,:ORDER_ID,:FIRM_ID);

      IF (NON_CASH IS NOT NULL) THEN BEGIN

        RECEIPT_TYPE_ID='3F91C48D888F81974941D256C0815B03'; /* Компенсация за поездку */

        SUM_RECEIPT=NON_CASH;

        INSERT INTO RECEIPTS (RECEIPT_ID,RECEIPT_TYPE_ID,ACCOUNT_ID,WHO_CREATE_ID,
                              SUM_RECEIPT,DATE_RECEIPT,DATE_CREATE,DESCRIPTION,ORDER_ID,FIRM_ID)
                      VALUES (GET_UNIQUE_ID(),:RECEIPT_TYPE_ID,:DRIVER_ID,:ACCOUNT_ID,
                              :SUM_RECEIPT,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,NULL,:ORDER_ID,:DRIVER_FIRM_ID);

      END

      EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:DRIVER_ID)
       RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

      SELECT MIN_BALANCE
        FROM DRIVERS
       WHERE DRIVER_ID=:DRIVER_ID
        INTO :MIN_BALANCE;

      IF ((MIN_BALANCE IS NULL) OR ((MIN_BALANCE IS NOT NULL) AND (BALANCE>MIN_BALANCE))) THEN BEGIN

        SELECT CONST_VALUE FROM GET_CONST_VALUE('16835607B30CA79F4CE883B53AFE972D') INTO :S;

      END ELSE BEGIN

        UPDATE SHIFTS
           SET DATE_END=CURRENT_TIMESTAMP
         WHERE ACCOUNT_ID=:DRIVER_ID
           AND DATE_END IS NULL;

        SELECT CONST_VALUE FROM GET_CONST_VALUE('634880F305E9AA434245E3E596697001') INTO :S;

      END

      SELECT PHONE
        FROM ACCOUNTS
       WHERE ACCOUNT_ID=:DRIVER_ID
        INTO :PHONE;

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,DRIVER_TYPE_MESSAGE)
       RETURNING_VALUES DRIVER_TYPE_MESSAGE, DRIVER_DEST_PORT;

      IF ((S IS NOT NULL) AND (DRIVER_TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        S=REPLACE_STRING(S,'%BALANCE',CAST(BALANCE AS VARCHAR(30)));

        IF (NON_CASH IS NULL) THEN
          NON_CASH=0.0;

        S=REPLACE_STRING(S,'%NON_CASH',CAST(CAST(NON_CASH AS NUMERIC(15,0)) AS VARCHAR(30)));

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                  PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                  :S,NULL,:DRIVER_TYPE_MESSAGE,:PHONE,NULL,
                                  2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DRIVER_DEST_PORT,:DRIVER_FIRM_ID);
      END

      FOR SELECT TRIM(SUB_STRING(IM.TEXT_IN,2,100))
            FROM IN_MESSAGES IM
            JOIN CODE_MESSAGES CM ON CM.CODE_MESSAGE_ID=IM.CODE_MESSAGE_ID
           WHERE IM.SENDER_ID=:DRIVER_ID
             AND IM.ORDER_ID=:ORDER_ID
             AND IM.CODE_MESSAGE_ID='0388BCC17DE1A1754B566F18AEEED771' /* Клиент рассчитался полностью */
             AND CM.ENABLED=1
           ORDER BY IM.DATE_IN DESC
            INTO :CODE DO BEGIN

        SELECT COUNT(*)
          FROM CODE_MESSAGES
         WHERE CODE=:CODE
          INTO :CNT;

        IF (CNT=1) THEN BEGIN
          IS_CODE_PARK = 1;
          EXECUTE PROCEDURE TRY_PARK_IN(SESSION_ID,ORDER_ID,ACCOUNT_ID,DRIVER_ID,CODE,DRIVER_TYPE_MESSAGE);

        END ELSE BEGIN

          EXECUTE PROCEDURE QUERY_PARK_STATES (ORDER_ID,ACCOUNT_ID,DRIVER_ID,PHONE,DRIVER_TYPE_MESSAGE);

        END

        BREAK;
      END

          if (:IS_CODE_PARK = 0 and :driver_id = 'BE5A2674A78DAEFA4BBBBE6F18B67B1B') then
          begin
              EXECUTE PROCEDURE TRY_PARK_IN_AFTER_FULL(ORDER_ID, DRIVER_ID, DRIVER_TYPE_MESSAGE, BALANCE, ACCOUNT_ID, DRIVER_DEST_PORT);
          end

      /* Обработка скидок, виртуальных начислений */
      EXECUTE PROCEDURE CLIENT_DISCOUNT(:ORDER_ID);

    END

  END
END

--

CREATE OR ALTER PROCEDURE GET_ROUTE_DISTANCE
(
  FROM_STREET_ID VARCHAR(32),
  FROM_HOUSE VARCHAR(10),
  TO_STREET_ID VARCHAR(32),
  TO_HOUSE VARCHAR(10)
)
RETURNS
(
  DISTANCE DOUBLE PRECISION
)
AS
DECLARE DURATION INTEGER;
BEGIN
  DISTANCE=0.0;

  EXECUTE PROCEDURE GET_ROUTE_MAX_BY_STREETS(FROM_STREET_ID,FROM_HOUSE,TO_STREET_ID,TO_HOUSE)
   RETURNING_VALUES DISTANCE, DURATION;

  IF (DISTANCE IS NOT NULL) THEN
    DISTANCE=CAST((DISTANCE/1000) AS NUMERIC(15,4));

END

--

CREATE OR ALTER PROCEDURE PR_ARRIVAL_DRIVER
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE PHONE VARCHAR(100);
DECLARE DRIVER_ID VARCHAR(32);
DECLARE CAR_ID VARCHAR(32);
DECLARE PARK_ID VARCHAR(32);
DECLARE PRIORITY INTEGER;
DECLARE PARK_STREET_ID VARCHAR(32);
DECLARE PARK_HOUSE VARCHAR(10);
DECLARE FROM_STREET_ID VARCHAR(32);
DECLARE FROM_HOUSE VARCHAR(10);
DECLARE RECEIPT_TYPE_ID VARCHAR(32);
DECLARE COST_RATE NUMERIC(15,2);
DECLARE COST_CASH NUMERIC(15,2);
DECLARE COLOR VARCHAR(100);
DECLARE BRAND VARCHAR(100);
DECLARE STATE_NUM VARCHAR(50);
DECLARE PREFIX VARCHAR(10);
DECLARE STREET VARCHAR(100);
DECLARE HOUSE VARCHAR(10);
DECLARE FLAT VARCHAR(10);
DECLARE PORCH VARCHAR(10);
DECLARE LOCALITY VARCHAR(100);
DECLARE CLIENT_ID VARCHAR(32);
DECLARE CALC_ID VARCHAR(32);
DECLARE SUM_CHARGE NUMERIC(15,2);
DECLARE SUM_RECEIPT NUMERIC(15,2);
DECLARE BALANCE NUMERIC(15,2);
DECLARE S VARCHAR(1000);
DECLARE S1 VARCHAR(1000);
DECLARE ADDRESS VARCHAR(1000);
DECLARE NUM INTEGER;
DECLARE CNT INTEGER;
DECLARE FLAG INTEGER;
DECLARE D TIMESTAMP;
DECLARE ROUTE_DISTANCE DOUBLE PRECISION;
DECLARE DISTANCE NUMERIC(15,2);
DECLARE CLIENT_TYPE_MESSAGE INTEGER;
DECLARE DRIVER_TYPE_MESSAGE INTEGER;
DECLARE IN_MESSAGE_ID VARCHAR(32);
DECLARE CLIENT_DEST_PORT INTEGER;
DECLARE DRIVER_DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
DECLARE DRIVER_FIRM_ID VARCHAR(32);
BEGIN

  SELECT O.PHONE, O.DRIVER_ID, O.PARK_ID, O.FIRM_ID,
         O.STREET_ID, O.HOUSE,
         O.COST_RATE, O.CLIENT_ID,
         C.COLOR, C.BRAND, C.STATE_NUM
    FROM ORDERS O
    LEFT JOIN DRIVERS D ON D.DRIVER_ID=O.DRIVER_ID
    LEFT JOIN CARS C ON C.CAR_ID=D.CAR_ID
   WHERE ORDER_ID=:ORDER_ID
    INTO :PHONE, :DRIVER_ID, :PARK_ID, :FIRM_ID,
         :FROM_STREET_ID, :FROM_HOUSE,
         :COST_RATE, :CLIENT_ID,
         :COLOR, :BRAND, :STATE_NUM;

  UPDATE ORDERS
     SET DATE_BEGIN=CURRENT_TIMESTAMP
   WHERE ORDER_ID=:ORDER_ID;

  CALC_ID=NULL;

  IF (CLIENT_ID IS NOT NULL) THEN BEGIN

    SELECT CALC_ID
      FROM CLIENTS
     WHERE CLIENT_ID=:CLIENT_ID
      INTO :CALC_ID;

  END

  BALANCE=NULL;

  IF (CALC_ID IS NOT NULL) THEN BEGIN

    EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:CLIENT_ID)
     RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

  END

  FLAG=0;

  FOR SELECT STREET_ID, HOUSE
        FROM ROUTES
       WHERE ORDER_ID=:ORDER_ID
       ORDER BY PRIORITY
        INTO :STREET, :HOUSE DO BEGIN

    IF ((STREET IS NOT NULL) AND (HOUSE IS NOT NULL)) THEN BEGIN

    END ELSE BEGIN

      FLAG=1;

    END
  END

  COST_CASH=NULL;

  IF ((COST_RATE>0.0) AND (FLAG=0)) THEN BEGIN

    IF (BALANCE IS NOT NULL) THEN BEGIN

      IF (BALANCE>=COST_RATE) THEN
        COST_CASH=0.0;
      ELSE
        COST_CASH=COST_RATE-BALANCE;

    END

  END

  IF (SUBSTR(PHONE,1,3)='+79')  THEN BEGIN

    IF ((COST_RATE>0.0) AND (FLAG=0)) THEN BEGIN

      IF (COST_CASH IS NULL) THEN

        SELECT CONST_VALUE FROM GET_CONST_VALUE('8D9E6C9F4852AD8142205F027B2A5288') INTO :S;

      ELSE

        SELECT CONST_VALUE FROM GET_CONST_VALUE('9CA9F2761D2BBE974791906824C3C31A') INTO :S;

    END ELSE BEGIN

      SELECT CONST_VALUE FROM GET_CONST_VALUE('93EBB0171E37A0884313759C0DA1EB3D') INTO :S;

    END

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(CLIENT_ID,NULL)
     RETURNING_VALUES CLIENT_TYPE_MESSAGE, CLIENT_DEST_PORT;

    IF ((S IS NOT NULL) AND (CLIENT_TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      S=REPLACE_STRING(S,'%COLOR',COLOR);
      S=REPLACE_STRING(S,'%BRAND',BRAND);
      S=REPLACE_STRING(S,'%STATE_NUM',STATE_NUM);
      S=REPLACE_STRING(S,'%COST_RATE',CAST(CAST(COST_RATE AS NUMERIC(15,0)) AS VARCHAR(30)));
      S=REPLACE_STRING(S,'%COST_CASH',CAST(CAST(COST_CASH AS NUMERIC(15,0)) AS VARCHAR(30)));

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:CLIENT_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:CLIENT_TYPE_MESSAGE,:PHONE,NULL,
                                0,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:CLIENT_DEST_PORT,:FIRM_ID);

    END

    SELECT CONST_VALUE FROM GET_CONST_VALUE('F4384929079999BB47A895BFCA5BB382') INTO :S;

    IF ((S IS NOT NULL) AND (CLIENT_TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:CLIENT_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:CLIENT_TYPE_MESSAGE,:PHONE,NULL,
                                0,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:CLIENT_DEST_PORT,:FIRM_ID);

    END

  END

  IF (DRIVER_ID IS NOT NULL) THEN BEGIN

    FOR SELECT IN_MESSAGE_ID, TYPE_MESSAGE
          FROM IN_MESSAGES
         WHERE ORDER_ID=:ORDER_ID
           AND CODE_MESSAGE_ID='618A0B399123BEEA474944099929C541' /* Водитель прибыл */
           AND SENDER_ID=:DRIVER_ID
           AND DESCRIPTION IS NULL
          INTO :IN_MESSAGE_ID, :DRIVER_TYPE_MESSAGE DO BEGIN

      UPDATE IN_MESSAGES
         SET DESCRIPTION=:ORDER_ID
       WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID;

      BREAK;
    END

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,DRIVER_TYPE_MESSAGE)
     RETURNING_VALUES DRIVER_TYPE_MESSAGE, DRIVER_DEST_PORT;

    SELECT PHONE, FIRM_ID
      FROM ACCOUNTS
     WHERE ACCOUNT_ID=:DRIVER_ID
      INTO :PHONE, :DRIVER_FIRM_ID;

    FLAG=0;
    NUM=0;

    SELECT COUNT(*)
      FROM ROUTES
     WHERE ORDER_ID=:ORDER_ID
      INTO :CNT;

    D=CURRENT_TIMESTAMP;

    FOR SELECT S.PREFIX, S.NAME, R.HOUSE, R.FLAT, R.PORCH, L.NAME
          FROM ROUTES R
          LEFT JOIN STREETS S ON S.STREET_ID=R.STREET_ID
          LEFT JOIN LOCALITIES L ON L.LOCALITY_ID=S.LOCALITY_ID
         WHERE R.ORDER_ID=:ORDER_ID
         ORDER BY R.PRIORITY
          INTO :PREFIX, :STREET, :HOUSE, :FLAT, :PORCH, :LOCALITY DO BEGIN

      ADDRESS='';
      S=NULL;

      IF ((STREET IS NOT NULL) AND (HOUSE IS NOT NULL)) THEN BEGIN

        IF (PREFIX IS NOT NULL) THEN
          ADDRESS=PREFIX||' ';

        IF (STREET IS NOT NULL) THEN
          ADDRESS=ADDRESS||STREET;

        IF (HOUSE IS NOT NULL) THEN
          ADDRESS=ADDRESS||' '||HOUSE;

        IF (FLAT IS NOT NULL) THEN
          ADDRESS=ADDRESS||'-'||FLAT;

        IF (PORCH IS NOT NULL) THEN
          ADDRESS=ADDRESS||' п.'||PORCH;

        IF ((LOCALITY IS NOT NULL) AND (LOCALITY<>'Красноярск')) THEN
          ADDRESS=ADDRESS||', '||LOCALITY;

        SELECT CONST_VALUE FROM GET_CONST_VALUE('92009DB6C3EAA9E74B80D333538FE40D') INTO :S;

      END ELSE BEGIN

        FLAG=1;

        SELECT CONST_VALUE FROM GET_CONST_VALUE('7ED5E8A8BBD9870A411517B54D9EB973') INTO :S;

      END

      IF (S IS NOT NULL) THEN BEGIN

        NUM=NUM+1;

        S=REPLACE_STRING(S,'%NUM',NUM);
        S=REPLACE_STRING(S,'%COUNT',CNT);
        S=REPLACE_STRING(S,'%ADDRESS',ADDRESS);

        IF (NUM=CNT) THEN BEGIN

          IF ((FLAG=0) AND (COST_RATE>0.0)) THEN BEGIN

            IF (COST_CASH IS NULL) THEN

              SELECT CONST_VALUE FROM GET_CONST_VALUE('9C8BC7D14DAEAE5C4DC8C1C91B20BCC2') INTO :S1;

            ELSE

              SELECT CONST_VALUE FROM GET_CONST_VALUE('A468782967A1A4D347F85F33D39E348A') INTO :S1;

          END ELSE

            SELECT CONST_VALUE FROM GET_CONST_VALUE('D3F68032AD999D004140A480A8AAF749') INTO :S1;

        END ELSE

          S1=S;


        IF ((S1 IS NOT NULL) AND (DRIVER_TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

          S1=REPLACE_STRING(S1,'%ADDRESS',S);
          S1=REPLACE_STRING(S1,'%COST_RATE',CAST(CAST(COST_RATE AS NUMERIC(15,0)) AS VARCHAR(30)));
          S1=REPLACE_STRING(S1,'%COST_CASH',CAST(CAST(COST_CASH AS NUMERIC(15,0)) AS VARCHAR(30)));

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                    PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                    :S1,NULL,:DRIVER_TYPE_MESSAGE,:PHONE,NULL,
                                    2,NULL,:D,:ORDER_ID,:DRIVER_DEST_PORT,:DRIVER_FIRM_ID);

          D=D+1*(1e0/24/60/60);

        END

      END

    END

    SELECT d.priority, d.car_id
      FROM drivers d
     WHERE d.driver_id = :DRIVER_ID
      INTO :PRIORITY, :CAR_ID;

    IF ((PARK_ID IS NOT NULL) AND ((PRIORITY<>-1)
    and (:CAR_ID not in (select car_id from car_in_types where car_type_id = '2FC1A2E9B900A144441F4B342A432950'))))  THEN BEGIN

      SELECT STREET_ID, HOUSE
        FROM PARKS
       WHERE PARK_ID=:PARK_ID
        INTO :PARK_STREET_ID, :PARK_HOUSE;

      IF ((PARK_STREET_ID IS NOT NULL) AND (PARK_HOUSE IS NOT NULL)) THEN BEGIN

        IF ((FROM_STREET_ID IS NOT NULL) AND (FROM_HOUSE IS NOT NULL)) THEN BEGIN

          EXECUTE PROCEDURE GET_ROUTE_DISTANCE(PARK_STREET_ID,PARK_HOUSE,FROM_STREET_ID,FROM_HOUSE)
             RETURNING_VALUES ROUTE_DISTANCE;

          IF (ROUTE_DISTANCE>0.0) THEN BEGIN

            IF (DISTANCE>4.0) THEN BEGIN

              DISTANCE=DISTANCE-4.0;

              RECEIPT_TYPE_ID='2448E302595392064D9DF67BDD05C7DB'; /* Компенсация за прогон */

              SUM_RECEIPT=DISTANCE*3.0;

              INSERT INTO RECEIPTS (RECEIPT_ID,RECEIPT_TYPE_ID,ACCOUNT_ID,WHO_CREATE_ID,
                                    SUM_RECEIPT,DATE_RECEIPT,DATE_CREATE,DESCRIPTION,ORDER_ID,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:RECEIPT_TYPE_ID,:DRIVER_ID,:ACCOUNT_ID,
                                    :SUM_RECEIPT,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,NULL,:ORDER_ID,:FIRM_ID);

              SELECT CONST_VALUE FROM GET_CONST_VALUE('6905163E6105BE12488DAF7AAFA32810') INTO :S;

              IF ((S IS NOT NULL) AND (DRIVER_TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

                S=REPLACE_STRING(S,'%DISTANCE',CAST(DISTANCE AS VARCHAR(30)));
                S=REPLACE_STRING(S,'%SUM_RECEIPT',CAST(SUM_RECEIPT AS VARCHAR(30)));

                INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                          TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                          PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                                  VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                          :S,NULL,:DRIVER_TYPE_MESSAGE,:PHONE,NULL,
                                          2,NULL,:D,:ORDER_ID,:DRIVER_DEST_PORT,:DRIVER_FIRM_ID);


              END

            END

          END

        END

      END

    END

  END

END

--

ALTER TABLE RATES
ADD ROUND_UP NUMERIC(5,2)

--

CREATE OR ALTER VIEW S_RATES
AS
SELECT * FROM RATES

--

CREATE OR ALTER PROCEDURE I_RATE
(
  RATE_ID VARCHAR(32),
  NAME VARCHAR(100),
  DESCRIPTION VARCHAR(250),
  TYPE_RATE INTEGER,
  PROC_NAME VARCHAR(100),
  RATE_SUM NUMERIC(15,2),
  PERIOD INTEGER,
  PRIORITY INTEGER,
  ROUND_UP NUMERIC(5,2))
AS
BEGIN
  INSERT INTO RATES (RATE_ID,NAME,DESCRIPTION,TYPE_RATE,
                     PROC_NAME,RATE_SUM,PERIOD,PRIORITY,ROUND_UP)
       VALUES (:RATE_ID,:NAME,:DESCRIPTION,:TYPE_RATE,
               :PROC_NAME,:RATE_SUM,:PERIOD,:PRIORITY,:ROUND_UP);
END

--

CREATE OR ALTER PROCEDURE U_RATE
(
  RATE_ID VARCHAR(32),
  NAME VARCHAR(100),
  DESCRIPTION VARCHAR(250),
  TYPE_RATE INTEGER,
  PROC_NAME VARCHAR(100),
  RATE_SUM NUMERIC(15,2),
  PERIOD INTEGER,
  PRIORITY INTEGER,
  ROUND_UP NUMERIC(5,2),
  OLD_RATE_ID VARCHAR(32)
)
AS
BEGIN
  UPDATE RATES
     SET RATE_ID=:RATE_ID,
         NAME=:NAME,
         DESCRIPTION=:DESCRIPTION,
         TYPE_RATE=:TYPE_RATE,
         PROC_NAME=:PROC_NAME,
         RATE_SUM=:RATE_SUM,
         PERIOD=:PERIOD,
         PRIORITY=:PRIORITY,
         ROUND_UP=:ROUND_UP
   WHERE RATE_ID=:OLD_RATE_ID;
END

--

UPDATE RATES
   SET ROUND_UP=10.0

--

CREATE OR ALTER PROCEDURE GET_COST_MAP21
(
  ORDER_ID VARCHAR(32),
  STREET_ID VARCHAR(32),
  ZONE_ID VARCHAR(32),
  CAR_ID VARCHAR(32),
  RATE_ID VARCHAR(32),
  CAR_TYPE_ID VARCHAR(32),
  FIRM_ID VARCHAR(32),
  PARK_ID VARCHAR(32),
  DRIVER_ID VARCHAR(32),
  SOURCE_ID VARCHAR(32),
  DISCOUNT_ID VARCHAR(32),
  HOUSE VARCHAR(10),
  FLAT VARCHAR(10),
  PORCH VARCHAR(10),
  PHONE VARCHAR(100),
  CUSTOMER VARCHAR(250),
  ORDER_NUM VARCHAR(10),
  BASE_COST NUMERIC(15,2),
  BASE_DISTANCE NUMERIC(15,2),
  BASE_PERIOD INTEGER,
  DATE_ARRIVAL TIMESTAMP
)
RETURNS
(
  COST NUMERIC(15,2)
)
AS
DECLARE TEMP NUMERIC(15,2);
DECLARE CWD INTEGER;
BEGIN
  COST=0.0;

  IF (BASE_DISTANCE<=3) THEN BEGIN

    IF (BASE_DISTANCE>0.0) THEN
      COST=100.0;

  END ELSE BEGIN

    IF (BASE_DISTANCE<=4) THEN
      COST=110;

    ELSE BEGIN

      IF (BASE_DISTANCE<=4.5) THEN
        COST=120;

      ELSE BEGIN

        IF (BASE_DISTANCE<=5) THEN
           COST=130;

        ELSE BEGIN

          IF (BASE_DISTANCE<=6) THEN
            COST=140;

          ELSE BEGIN

            IF (BASE_DISTANCE<=6.5) THEN
              COST=BASE_DISTANCE*BASE_COST;

            ELSE BEGIN

              COST=6.5*BASE_COST;

              IF (BASE_DISTANCE<=10) THEN
                COST=COST+(BASE_DISTANCE-6.5)*0.65*BASE_COST;

              ELSE BEGIN

                COST=COST+(10-6.5)*0.65*BASE_COST;

                IF (BASE_DISTANCE<=15) THEN
                  COST=COST+(BASE_DISTANCE-10)*0.6*BASE_COST;

                ELSE BEGIN

                  COST=COST+(15-10)*0.6*BASE_COST;

                  COST=COST+(BASE_DISTANCE-15)*0.65*BASE_COST;

                END

              END

            END

          END

        END

      END

    END

  END

  CWD = CAST(EXTRACT(WEEKDAY FROM :DATE_ARRIVAL) AS INTEGER);

  IF ((:CWD != 0 AND :CWD != 6) AND
      ((:DATE_ARRIVAL >= FORMAT_DATETIME('dd.mm.yyyy 16:30:00', :DATE_ARRIVAL) AND
        :DATE_ARRIVAL <= FORMAT_DATETIME('dd.mm.yyyy 20:00:00', :DATE_ARRIVAL)) OR
       (:DATE_ARRIVAL >= FORMAT_DATETIME('dd.mm.yyyy 07:30:00', :DATE_ARRIVAL) AND
        :DATE_ARRIVAL <= FORMAT_DATETIME('dd.mm.yyyy 10:30:00', :DATE_ARRIVAL)))) THEN
    COST=COST*1.1;

/*  COST=CAST(CAST((COST/10) AS NUMERIC(15,1)) AS NUMERIC(15,0))*10; */

END

--

CREATE OR ALTER PROCEDURE GET_COST_MAP22
(
  ORDER_ID VARCHAR(32),
  STREET_ID VARCHAR(32),
  ZONE_ID VARCHAR(32),
  CAR_ID VARCHAR(32),
  RATE_ID VARCHAR(32),
  CAR_TYPE_ID VARCHAR(32),
  FIRM_ID VARCHAR(32),
  PARK_ID VARCHAR(32),
  DRIVER_ID VARCHAR(32),
  SOURCE_ID VARCHAR(32),
  DISCOUNT_ID VARCHAR(32),
  HOUSE VARCHAR(10),
  FLAT VARCHAR(10),
  PORCH VARCHAR(10),
  PHONE VARCHAR(100),
  CUSTOMER VARCHAR(250),
  ORDER_NUM VARCHAR(10),
  BASE_COST NUMERIC(15,2),
  BASE_DISTANCE NUMERIC(15,2),
  BASE_PERIOD INTEGER,
  DATE_ARRIVAL TIMESTAMP
)
RETURNS
(
  COST NUMERIC(15,2)
)
AS
DECLARE TEMP NUMERIC(15,2);
DECLARE CWD INTEGER;
BEGIN
  COST=0.0;

  IF (BASE_DISTANCE<=3) THEN BEGIN

    IF (BASE_DISTANCE>0.0) THEN
      COST=100.0;

  END ELSE BEGIN

    IF (BASE_DISTANCE<=4) THEN
      COST=110;

    ELSE BEGIN

      IF (BASE_DISTANCE<=4.5) THEN
        COST=120;

      ELSE BEGIN

        IF (BASE_DISTANCE<=5) THEN
           COST=130;

        ELSE BEGIN

          IF (BASE_DISTANCE<=6) THEN
            COST=140;

          ELSE BEGIN

            IF (BASE_DISTANCE<=6.5) THEN
              COST=BASE_DISTANCE*BASE_COST;

            ELSE BEGIN

              COST=6.5*BASE_COST;

              IF (BASE_DISTANCE<=10) THEN
                COST=COST+(BASE_DISTANCE-6.5)*0.65*BASE_COST;

              ELSE BEGIN

                COST=COST+(10-6.5)*0.65*BASE_COST;

                IF (BASE_DISTANCE<=15) THEN
                  COST=COST+(BASE_DISTANCE-10)*0.6*BASE_COST;

                ELSE BEGIN

                  COST=COST+(15-10)*0.6*BASE_COST;

                  COST=COST+(BASE_DISTANCE-15)*0.65*BASE_COST;

                END

              END

            END

          END

        END

      END

    END

  END

  COST=COST*1.1;

  CWD = CAST(EXTRACT(WEEKDAY FROM :DATE_ARRIVAL) AS INTEGER);

  IF ((:CWD != 0 AND :CWD != 6) AND
      ((:DATE_ARRIVAL >= FORMAT_DATETIME('dd.mm.yyyy 16:30:00', :DATE_ARRIVAL) AND
        :DATE_ARRIVAL <= FORMAT_DATETIME('dd.mm.yyyy 20:00:00', :DATE_ARRIVAL)) OR
       (:DATE_ARRIVAL >= FORMAT_DATETIME('dd.mm.yyyy 07:30:00', :DATE_ARRIVAL) AND
        :DATE_ARRIVAL <= FORMAT_DATETIME('dd.mm.yyyy 10:30:00', :DATE_ARRIVAL)))) THEN
    COST=COST*1.1;

/*  COST=CAST(CAST((COST/10) AS NUMERIC(15,1)) AS NUMERIC(15,0))*10; */

END

--

CREATE OR ALTER PROCEDURE I_OUT_MESSAGE_BY_ACCOUNT
(
   OUT_MESSAGE_ID VARCHAR(32),
   ACCOUNT_ID VARCHAR(32),
   TEXT_OUT VARCHAR(4000),
   TYPE_MESSAGE INTEGER,
   CONTACT VARCHAR(100),
   SOURCE VARCHAR(100),
   DESCRIPTION VARCHAR(250),
   DATE_BEGIN TIMESTAMP,
   DATE_END TIMESTAMP
)
RETURNS
(
   SUCCESS INTEGER
)
AS
DECLARE BALANCE NUMERIC(15,2);
DECLARE SUM_CHARGE NUMERIC(15,2);
DECLARE SUM_RECEIPT NUMERIC(15,2);
BEGIN
  SUCCESS=0;

  EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(ACCOUNT_ID)
   RETURNING_VALUES SUM_CHARGE, SUM_RECEIPT, BALANCE;

  IF (BALANCE>=0.0) THEN BEGIN

    IF (DATE_BEGIN IS NULL) THEN
      DATE_BEGIN=CURRENT_TIMESTAMP;

    IF (TYPE_MESSAGE IS NULL) THEN
      TYPE_MESSAGE=0;

    INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                              TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                              PRIORITY,DATE_BEGIN,DATE_END,ORDER_ID,CHANNEL,
                              DELIVERY,DATE_DELIVERY,FLASH,DEST_PORT,FIRM_ID,OPERATOR_ID,
                              MESSAGE_ID,SOURCE)
                      VALUES (:OUT_MESSAGE_ID,:ACCOUNT_ID,NULL,CURRENT_TIMESTAMP,
                              :TEXT_OUT,NULL,:TYPE_MESSAGE,:CONTACT,:DESCRIPTION,
                              2,:DATE_BEGIN,:DATE_END,NULL,NULL,
                              0,NULL,0,NULL,NULL,NULL,
                              NULL,:SOURCE);
    SUCCESS=1;

  END

END

--

ALTER TABLE METHODS
ADD DEST_PORT INTEGER

--

CREATE OR ALTER VIEW S_METHODS
AS
SELECT * FROM METHODS

--

CREATE OR ALTER PROCEDURE I_METHOD
(
  METHOD_ID VARCHAR(32),
  NAME VARCHAR(100),
  DESCRIPTION VARCHAR(250),
  PRIORITY INTEGER,
  IN_MESSAGE INTEGER,
  IN_QUERY INTEGER,
  IN_CALL INTEGER,
  OUTGOING INTEGER,
  DEST_PORT INTEGER
)
AS
BEGIN
  INSERT INTO METHODS (METHOD_ID,NAME,DESCRIPTION,PRIORITY,
                       IN_MESSAGE,IN_QUERY,IN_CALL,OUTGOING,DEST_PORT)
       VALUES (:METHOD_ID,:NAME,:DESCRIPTION,:PRIORITY,
               :IN_MESSAGE,:IN_QUERY,:IN_CALL,:OUTGOING,:DEST_PORT);
END

--

CREATE OR ALTER PROCEDURE U_METHOD
(
  METHOD_ID VARCHAR(32),
  NAME VARCHAR(100),
  DESCRIPTION VARCHAR(250),
  PRIORITY INTEGER,
  IN_MESSAGE INTEGER,
  IN_QUERY INTEGER,
  IN_CALL INTEGER,
  OUTGOING INTEGER,
  DEST_PORT INTEGER,
  OLD_METHOD_ID VARCHAR(32)
)
AS
BEGIN
  UPDATE METHODS
     SET METHOD_ID=:METHOD_ID,
         NAME=:NAME,
         DESCRIPTION=:DESCRIPTION,
         PRIORITY=:PRIORITY,
         IN_MESSAGE=:IN_MESSAGE,
         IN_QUERY=:IN_QUERY,
         IN_CALL=:IN_CALL,
         OUTGOING=:OUTGOING,
         DEST_PORT=:DEST_PORT
   WHERE METHOD_ID=:OLD_METHOD_ID;
END

--

UPDATE METHODS
SET DEST_PORT=55555

--

CREATE OR ALTER PROCEDURE GET_TYPE_MESSAGE
(
  ACCOUNT_ID VARCHAR(32),
  DEFAULT_TYPE INTEGER,
  CONTACT VARCHAR(100)
)
RETURNS
(
  TYPE_MESSAGE INTEGER,
  DEST_PORT INTEGER
)
AS
DECLARE CNT INTEGER;
DECLARE OUTGOING INTEGER;
DECLARE NEED_CHECK INTEGER;
BEGIN
  TYPE_MESSAGE=DEFAULT_TYPE;
  OUTGOING=NULL;
  DEST_PORT=NULL;

  SELECT COUNT(*)
    FROM DRIVERS
   WHERE DRIVER_ID=:ACCOUNT_ID
    INTO :CNT;

  IF (CNT>0) THEN BEGIN

    SELECT M.OUTGOING, M.DEST_PORT
      FROM DRIVERS D
      LEFT JOIN METHODS M ON M.METHOD_ID=D.METHOD_ID
     WHERE D.DRIVER_ID=:ACCOUNT_ID
      INTO :OUTGOING, :DEST_PORT;

  END ELSE BEGIN

    SELECT COUNT(*)
      FROM CLIENTS
     WHERE CLIENT_ID=:ACCOUNT_ID
      INTO :CNT;

    IF (CNT>0) THEN BEGIN

    END

  END

  NEED_CHECK=0;

  IF (OUTGOING IS NOT NULL) THEN BEGIN

    IF (OUTGOING=0) THEN
      TYPE_MESSAGE=NULL;

    IF (OUTGOING=1) THEN BEGIN
      TYPE_MESSAGE=DEFAULT_TYPE;
      IF (TYPE_MESSAGE IS NULL) THEN
        NEED_CHECK=1;
    END

    IF (OUTGOING=2) THEN
      TYPE_MESSAGE=0;

    IF (OUTGOING=3) THEN
      TYPE_MESSAGE=1;

    IF (OUTGOING=4) THEN
      TYPE_MESSAGE=2;

  END ELSE BEGIN

    IF (TYPE_MESSAGE IS NULL) THEN
      NEED_CHECK=1;

  END

  IF (NEED_CHECK=1) THEN BEGIN

    IF (STRING_LENGTH(CONTACT)=7) THEN
      TYPE_MESSAGE=2;

    IF (STRING_LENGTH(CONTACT)=12) THEN
      TYPE_MESSAGE=0;

  END

END

--

CREATE OR ALTER PROCEDURE ALERT_CALL_CLIENT 
(
    SESSION_ID VARCHAR(32),
    IN_MESSAGE_ID VARCHAR(32))
AS
DECLARE VARIABLE ACCOUNT_ID VARCHAR(32);
DECLARE VARIABLE CONTACT VARCHAR(100);
DECLARE VARIABLE SENDER_ID VARCHAR(32);
DECLARE VARIABLE TEXT_IN VARCHAR(4000);
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE SUM_CHARGE NUMERIC(15,2);
DECLARE VARIABLE SUM_RECEIPT NUMERIC(15,2);
DECLARE VARIABLE BALANCE NUMERIC(15,2);
DECLARE VARIABLE MIN_BALANCE NUMERIC(15,2);
DECLARE VARIABLE USER_NAME VARCHAR(100);
DECLARE VARIABLE S VARCHAR(250);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE SURNAME VARCHAR(100);
DECLARE VARIABLE NAME VARCHAR(100);
DECLARE VARIABLE PATRONYMIC VARCHAR(100);
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE SUCCESS INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN
  SELECT IM.CONTACT, IM.SENDER_ID, IM.TEXT_IN, IM.TYPE_MESSAGE
    FROM IN_MESSAGES IM
    LEFT JOIN CODE_MESSAGES CM ON CM.CODE_MESSAGE_ID=IM.CODE_MESSAGE_ID
   WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, :TEXT_IN, :TYPE_MESSAGE;

  SELECT ACCOUNT_ID
    FROM SESSIONS
   WHERE SESSION_ID=:SESSION_ID
    INTO :ACCOUNT_ID;

  IF ((CONTACT IS NOT NULL) AND (SENDER_ID IS NOT NULL) AND (TEXT_IN IS NOT NULL)) THEN BEGIN

    SELECT COUNT(*)
      FROM DRIVERS D
      JOIN  ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
     WHERE D.DRIVER_ID=:SENDER_ID
       AND A.LOCKED<>1
      INTO :CNT;

    IF (CNT>0) THEN BEGIN

      EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:SENDER_ID)
       RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

      SELECT D.MIN_BALANCE, A.USER_NAME, A.SURNAME, A.NAME, A.PATRONYMIC, A.FIRM_ID
        FROM DRIVERS D
        JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
        JOIN CARS C ON C.CAR_ID=D.CAR_ID
       WHERE D.DRIVER_ID=:SENDER_ID
        INTO :MIN_BALANCE, :USER_NAME, :SURNAME, :NAME, :PATRONYMIC, :FIRM_ID;

      SELECT COUNT(*)
        FROM SHIFTS
       WHERE ACCOUNT_ID=:SENDER_ID
         AND DATE_END IS NULL
        INTO :CNT;

      IF ((CNT>0) AND ((MIN_BALANCE IS NULL) OR ((MIN_BALANCE IS NOT NULL) AND (BALANCE>MIN_BALANCE)))) THEN BEGIN

        S=USER_NAME||' - ';
        IF (SURNAME IS NOT NULL) THEN
          S=S||' '||SURNAME;
        IF (NAME IS NOT NULL) THEN
          S=S||' '||NAME;
        IF (PATRONYMIC IS NOT NULL) THEN
          S=S||' '||PATRONYMIC;

        IN AUTONOMOUS TRANSACTION DO BEGIN

          INSERT INTO ALARMS (ALARM_ID,SENDER_ID,RECIPIENT_ID,TYPE_ALARM,
                              DATE_BEGIN,DATE_END,CAPTION,TEXT_ALARM)
                      VALUES (GET_UNIQUE_ID(),'CA25F4C3A6DA8C334D20D3C4F2A2EF62',NULL,0,
                              CURRENT_TIMESTAMP,CURRENT_TIMESTAMP+5*(1e0/24/60),'Отзвонитесь клиенту!',:S);
        END

        EXECUTE PROCEDURE EVENT_ALARM('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0)
         RETURNING_VALUES SUCCESS;

        IF (SUCCESS=1) THEN BEGIN

          SELECT CONST_VALUE FROM GET_CONST_VALUE('AB84E2116D3485A847EEE59DB47CE27B') INTO :S;

          EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE,CONTACT)
           RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

          IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

            S=REPLACE_STRING(S,'%CODE',TEXT_IN);

            INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                      TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                      LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                              VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                      :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                      NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
          END

        END

      END

    END

  END
END

--

CREATE OR ALTER PROCEDURE CODE_CLIENT_BALANCE 
(
    ACCOUNT_ID VARCHAR(32),
    IN_MESSAGE_ID VARCHAR(32))
AS
DECLARE VARIABLE CONTACT VARCHAR(100);
DECLARE VARIABLE SENDER_ID VARCHAR(32);
DECLARE VARIABLE S VARCHAR(70);
DECLARE VARIABLE SUM_CHARGE NUMERIC(15,2);
DECLARE VARIABLE SUM_RECEIPT NUMERIC(15,2);
DECLARE VARIABLE BALANCE NUMERIC(15,2);
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE CHARGE_TYPE_ID VARCHAR(32);
DECLARE VARIABLE CONST_VALUE VARCHAR(4000);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN
  SELECT CONTACT, SENDER_ID, TYPE_MESSAGE
    FROM IN_MESSAGES
   WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, :TYPE_MESSAGE;

  IF ((CONTACT IS NOT NULL) AND (SENDER_ID IS NOT NULL)) THEN BEGIN

    EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:SENDER_ID)
     RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

    SELECT COUNT(*)
      FROM CLIENTS C
      JOIN ACCOUNTS A ON A.ACCOUNT_ID=C.CLIENT_ID
     WHERE C.CLIENT_ID=:SENDER_ID
       AND A.LOCKED<>1
      INTO :CNT;

    IF (CNT>0) THEN BEGIN

      SELECT CONST_VALUE FROM GET_CONST_VALUE('2031AA8F2E4B959248967F2838DC5F19') INTO :S;

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE,CONTACT)
       RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

      IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        S=REPLACE_STRING(S,'%BALANCE',CAST(BALANCE AS VARCHAR(30)));

        FIRM_ID=NULL; /* Не понятно чьё сообщение */

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                  LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                  :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                  NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
      END

    END

  END
END

--

CREATE OR ALTER PROCEDURE CODE_CLIENT_NO_EXIT 
(
    SESSION_ID VARCHAR(32),
    IN_MESSAGE_ID VARCHAR(32))
AS
DECLARE VARIABLE ACCOUNT_ID VARCHAR(32);
DECLARE VARIABLE CONTACT VARCHAR(100);
DECLARE VARIABLE SENDER_ID VARCHAR(32);
DECLARE VARIABLE TEXT_IN VARCHAR(4000);
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE SUM_CHARGE NUMERIC(15,2);
DECLARE VARIABLE SUM_RECEIPT NUMERIC(15,2);
DECLARE VARIABLE BALANCE NUMERIC(15,2);
DECLARE VARIABLE MIN_BALANCE NUMERIC(15,2);
DECLARE VARIABLE USER_NAME VARCHAR(100);
DECLARE VARIABLE S VARCHAR(250);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE SURNAME VARCHAR(100);
DECLARE VARIABLE NAME VARCHAR(100);
DECLARE VARIABLE PATRONYMIC VARCHAR(100);
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE SUCCESS INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN
  SELECT IM.CONTACT, IM.SENDER_ID, IM.TEXT_IN, IM.TYPE_MESSAGE
    FROM IN_MESSAGES IM
    LEFT JOIN CODE_MESSAGES CM ON CM.CODE_MESSAGE_ID=IM.CODE_MESSAGE_ID
   WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, :TEXT_IN, :TYPE_MESSAGE;

  SELECT ACCOUNT_ID
    FROM SESSIONS
   WHERE SESSION_ID=:SESSION_ID
    INTO :ACCOUNT_ID;

  IF ((CONTACT IS NOT NULL) AND (SENDER_ID IS NOT NULL) AND (TEXT_IN IS NOT NULL)) THEN BEGIN

    SELECT COUNT(*)
      FROM DRIVERS D
      JOIN  ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
     WHERE D.DRIVER_ID=:SENDER_ID
       AND A.LOCKED<>1
      INTO :CNT;

    IF (CNT>0) THEN BEGIN

      EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:SENDER_ID)
       RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

      SELECT D.MIN_BALANCE, A.USER_NAME, A.SURNAME, A.NAME, A.PATRONYMIC, A.FIRM_ID
        FROM DRIVERS D
        JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
        JOIN CARS C ON C.CAR_ID=D.CAR_ID
       WHERE D.DRIVER_ID=:SENDER_ID
        INTO :MIN_BALANCE, :USER_NAME, :SURNAME, :NAME, :PATRONYMIC, :FIRM_ID;

      SELECT COUNT(*)
        FROM SHIFTS
       WHERE ACCOUNT_ID=:SENDER_ID
         AND DATE_END IS NULL
        INTO :CNT;

      IF ((CNT>0) AND ((MIN_BALANCE IS NULL) OR ((MIN_BALANCE IS NOT NULL) AND (BALANCE>MIN_BALANCE)))) THEN BEGIN

        S=USER_NAME||' - ';
        IF (SURNAME IS NOT NULL) THEN
          S=S||' '||SURNAME;
        IF (NAME IS NOT NULL) THEN
          S=S||' '||NAME;
        IF (PATRONYMIC IS NOT NULL) THEN
          S=S||' '||PATRONYMIC;

        IN AUTONOMOUS TRANSACTION DO BEGIN

          INSERT INTO ALARMS (ALARM_ID,SENDER_ID,RECIPIENT_ID,TYPE_ALARM,
                              DATE_BEGIN,DATE_END,CAPTION,TEXT_ALARM)
                      VALUES (GET_UNIQUE_ID(),'CA25F4C3A6DA8C334D20D3C4F2A2EF62','FF7F332564F795C8411BF28652B22BEA',0,
                              CURRENT_TIMESTAMP,CURRENT_TIMESTAMP+5*(1e0/24/60),'Клиент не вышел! Отзвонитесь клиенту!',:S);
        END

        EXECUTE PROCEDURE EVENT_ALARM('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0)
         RETURNING_VALUES SUCCESS;

        IF (SUCCESS=1) THEN BEGIN

          SELECT CONST_VALUE FROM GET_CONST_VALUE('D59DEF0FF100BC3443817BAEF5B1B555') INTO :S;

          EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE,CONTACT)
           RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

          IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

            S=REPLACE_STRING(S,'%CODE',TEXT_IN);

            INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                      TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                      LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                              VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                      :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                      NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
          END

        END

      END

    END

  END
END

--

CREATE OR ALTER PROCEDURE CODE_DRIVER_BALANCE 
(
    ACCOUNT_ID VARCHAR(32),
    IN_MESSAGE_ID VARCHAR(32))
AS
DECLARE VARIABLE CONTACT VARCHAR(100);
DECLARE VARIABLE SENDER_ID VARCHAR(32);
DECLARE VARIABLE S VARCHAR(70);
DECLARE VARIABLE SUM_CHARGE NUMERIC(15,2);
DECLARE VARIABLE SUM_RECEIPT NUMERIC(15,2);
DECLARE VARIABLE BALANCE NUMERIC(15,2);
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE CHARGE_TYPE_ID VARCHAR(32);
DECLARE VARIABLE CONST_VALUE VARCHAR(4000);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN
  SELECT IM.CONTACT, IM.SENDER_ID, IM.TYPE_MESSAGE, A.FIRM_ID
    FROM IN_MESSAGES IM
    LEFT JOIN ACCOUNTS A ON A.ACCOUNT_ID=IM.SENDER_ID
   WHERE IM.IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, :TYPE_MESSAGE, :FIRM_ID;

  IF ((CONTACT IS NOT NULL) AND (SENDER_ID IS NOT NULL)) THEN BEGIN

    EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:SENDER_ID)
     RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

    SELECT COUNT(*)
      FROM DRIVERS D
      JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
     WHERE D.DRIVER_ID=:SENDER_ID
       AND A.LOCKED<>1
      INTO :CNT;

    IF (CNT>0) THEN BEGIN

      SELECT CONST_VALUE FROM GET_CONST_VALUE('2031AA8F2E4B959248967F2838DC5F19') INTO :S;

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE,CONTACT)
       RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

      IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        S=REPLACE_STRING(S,'%BALANCE',CAST(BALANCE AS VARCHAR(30)));

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                  LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                  :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                  NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
      END

    END

  END
END

--

CREATE OR ALTER PROCEDURE CODE_FREE_ORDER 
(
    SESSION_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32),
    IN_MESSAGE_ID VARCHAR(32))
AS
DECLARE VARIABLE CONTACT VARCHAR(100);
DECLARE VARIABLE SENDER_ID VARCHAR(32);
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE PARK_NAME VARCHAR(100);
DECLARE VARIABLE PARK_STATE_ID VARCHAR(32);
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE D TIMESTAMP;
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
DECLARE VARIABLE DRIVER_USERNAME VARCHAR(50);
DECLARE VARIABLE DRIVER_FAMILY VARCHAR(50);
DECLARE VARIABLE SUCCESS INTEGER;
DECLARE VARIABLE CODE VARCHAR(10);
DECLARE VARIABLE IS_PARK INTEGER;
DECLARE VARIABLE TT VARCHAR(200);
DECLARE VARIABLE DRIVER_ID VARCHAR(32);
BEGIN

  SELECT IM.CONTACT, IM.SENDER_ID, IM.TYPE_MESSAGE, A.FIRM_ID, TRIM(SUB_STRING(IM.TEXT_IN,3,100))
    FROM IN_MESSAGES IM
    LEFT JOIN ACCOUNTS A ON A.ACCOUNT_ID=IM.SENDER_ID
   WHERE IM.IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, :TYPE_MESSAGE, :FIRM_ID, :CODE;

    SELECT COUNT(*)
      FROM CODE_MESSAGES
     WHERE CODE=:CODE
      INTO :IS_PARK;

    SELECT FIRST 1 DRIVER_ID
      FROM DRIVERS
     WHERE DRIVER_ID=:SENDER_ID
      INTO :DRIVER_ID;

  /* need check */
  IF (:DRIVER_ID IS NOT NULL) THEN
  BEGIN

  IF ((CONTACT IS NOT NULL) AND (SENDER_ID IS NOT NULL)) THEN BEGIN

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,TYPE_MESSAGE,CONTACT)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

  if (
    (CURRENT_TIMESTAMP >= cast('16:30' as time) AND
     CURRENT_TIMESTAMP <= cast('19:30' as time)) OR
    (CURRENT_TIMESTAMP >= cast('07:30' as time) AND
     CURRENT_TIMESTAMP <= cast('09:30' as time))) then
  begin

    insert into del values (GET_UNIQUE_ID(), 'picktime');

            SELECT CONST_VALUE FROM GET_CONST_VALUE('E57358A4CA12AC324FA779A886533692') INTO :S;
            if (:S is not null) then
            begin
            INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                      TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                      LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                              VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                      :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                      NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
            end
  end  ELSE BEGIN

    SELECT COUNT(*)
      FROM DRIVERS D
      JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
     WHERE D.DRIVER_ID=:DRIVER_ID
       AND A.LOCKED<>1
      INTO :CNT;

    SELECT A.USER_NAME, A.SURNAME
      FROM DRIVERS D
      JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
     WHERE D.DRIVER_ID=:DRIVER_ID
       AND A.LOCKED<>1
      INTO :DRIVER_USERNAME, :DRIVER_FAMILY;

    IF (CNT>0) THEN BEGIN



      SELECT COUNT(*)
        FROM ORDERS
       WHERE DRIVER_ID=:DRIVER_ID
         AND PARENT_ID IS NULL
         AND DATE_HISTORY IS NULL
         AND FINISHED<>1
        INTO :CNT;

      IF (CNT>0) THEN BEGIN

        SELECT CONST_VALUE FROM GET_CONST_VALUE('7E75E7A3DA4FAB8D443F2D7384B3DF46') INTO :S;

        IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                    LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                    :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                    NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
        END

      END ELSE BEGIN

       /* FOR SELECT P.NAME, PS.PARK_STATE_ID
              FROM PARK_STATES PS
              JOIN PARKS P ON P.PARK_ID=PS.PARK_ID
             WHERE PS.DRIVER_ID=:DRIVER_ID
               AND PS.DATE_OUT IS NULL
              INTO :PARK_NAME, :PARK_STATE_ID DO  */
              BEGIN

          D=CURRENT_TIMESTAMP;

          UPDATE PARK_STATES
             SET DATE_OUT=:D
           WHERE DRIVER_ID = :DRIVER_ID AND DATE_OUT IS NULL;

          SELECT CONST_VALUE FROM GET_CONST_VALUE('0556D496EDF1B51A41D6A833C5D69DB9') INTO :S;

          IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        /*    S=REPLACE_STRING(S,'%PARK_NAME',PARK_NAME);
            S=REPLACE_STRING(S,'%TIME_DATE',FORMAT_DATETIME('hh:nn:ss dd.mm.yyyy',D)); */

            INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                      TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                      LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                              VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                      :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                      NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
          END

          IF (:IS_PARK > 0) THEN
          BEGIN
            TT = ' Освобождение на стоянке ' || :CODE;
          END ELSE
          BEGIN
            TT = '';
          END

          IN AUTONOMOUS TRANSACTION DO BEGIN

            INSERT INTO ALARMS (ALARM_ID,SENDER_ID,RECIPIENT_ID,TYPE_ALARM,
                          DATE_BEGIN,DATE_END,CAPTION,
                          TEXT_ALARM)
                 VALUES (GET_UNIQUE_ID(), 'CA25F4C3A6DA8C334D20D3C4F2A2EF62', NULL,
                   0, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP+0.5*(1e0/24/60), 'Свободная посадка',
                   :DRIVER_USERNAME || ' - ' || :DRIVER_FAMILY || ' Свободная посадка.' || :TT);

          END

          EXECUTE PROCEDURE EVENT_ALARM('A35F5701A7AA920E40812A71A690910D', NULL, NULL, 0)
           RETURNING_VALUES SUCCESS;

         /* BREAK; */

        END

        EXECUTE PROCEDURE event_refresh_park_states('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

      END

    END

  end

  END

  END

END

--

CREATE OR ALTER PROCEDURE CODE_FREE_ORDERS 
(
    ACCOUNT_ID VARCHAR(32),
    IN_MESSAGE_ID VARCHAR(32))
AS
DECLARE VARIABLE CONTACT VARCHAR(100);
DECLARE VARIABLE SENDER_ID VARCHAR(32);
DECLARE VARIABLE ZONE_ID VARCHAR(32);
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE S1 VARCHAR(1000);
DECLARE VARIABLE F VARCHAR(1000);
DECLARE VARIABLE PARK_ID VARCHAR(32);
DECLARE VARIABLE PARK_NAME VARCHAR(100);
DECLARE VARIABLE SUM_CHARGE NUMERIC(15,2);
DECLARE VARIABLE SUM_RECEIPT NUMERIC(15,2);
DECLARE VARIABLE BALANCE NUMERIC(15,2);
DECLARE VARIABLE MIN_BALANCE NUMERIC(15,2);
DECLARE VARIABLE DRIVER_COUNT INTEGER;
DECLARE VARIABLE ORDER_COUNT INTEGER;
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN
  SELECT IM.CONTACT, IM.SENDER_ID, IM.TYPE_MESSAGE, A.FIRM_ID
    FROM IN_MESSAGES IM
    LEFT JOIN ACCOUNTS A ON A.ACCOUNT_ID=IM.SENDER_ID
   WHERE IM.IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, :TYPE_MESSAGE, :FIRM_ID;

  IF ((CONTACT IS NOT NULL) AND (SENDER_ID IS NOT NULL)) THEN BEGIN

    SELECT COUNT(*)
      FROM DRIVERS D
      JOIN  ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
     WHERE D.DRIVER_ID=:SENDER_ID
       AND A.LOCKED<>1
      INTO :DRIVER_COUNT;

    IF (DRIVER_COUNT>0) THEN BEGIN

      EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:SENDER_ID)
       RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

      SELECT MIN_BALANCE
        FROM DRIVERS
       WHERE DRIVER_ID=:SENDER_ID
        INTO :MIN_BALANCE;

      IF ((MIN_BALANCE IS NULL) OR ((MIN_BALANCE IS NOT NULL) AND (BALANCE>MIN_BALANCE))) THEN BEGIN
 
        S='';

        SELECT CONST_VALUE FROM GET_CONST_VALUE('C34718E32AF1B4264975480EE24B7A8D') INTO :F;

        IF (F IS NOT NULL) THEN BEGIN

          FOR SELECT ZONE_ID
                FROM ZONES
               ORDER BY PRIORITY
                INTO :ZONE_ID DO BEGIN

            PARK_NAME=NULL;

            FOR SELECT ZP.PARK_ID, P.NAME
                  FROM ZONE_PARKS ZP
                  JOIN PARKS P ON P.PARK_ID=ZP.PARK_ID
                 WHERE ZP.ZONE_ID=:ZONE_ID
                 ORDER BY ZP.DISTANCE, ZP.PERIOD
                  INTO :PARK_ID, :PARK_NAME DO BEGIN
              BREAK;
            END

            IF (PARK_ID IS NOT NULL) THEN BEGIN

              SELECT COUNT(*)
               FROM PARK_STATES
              WHERE DATE_OUT IS NULL
                AND PARK_ID=:PARK_ID
               INTO :DRIVER_COUNT;

              IF (PARK_NAME IS NOT NULL) THEN BEGIN

                SELECT COUNT(*)
                  FROM ORDERS
                 WHERE ZONE_ID=:ZONE_ID
                   AND PARENT_ID IS NULL
                   AND FINISHED=0
                   AND CURRENT_TIMESTAMP>=(DATE_ARRIVAL-(BEFORE_PERIOD*(1e0/24/60)))
                   AND DRIVER_ID IS NULL
                  INTO :ORDER_COUNT;

                IF (ORDER_COUNT>DRIVER_COUNT) THEN BEGIN

                  ORDER_COUNT=ORDER_COUNT-DRIVER_COUNT;

                  S1=F;
                  S1=REPLACE_STRING(S1,'%PARK_NAME',PARK_NAME);
                  S1=REPLACE_STRING(S1,'%COUNT',CAST(ORDER_COUNT AS VARCHAR(10)));

                  S=S||S1;
                END

              END

            END

          END

          IF (S='') THEN BEGIN

            S=NULL;

            SELECT CONST_VALUE FROM GET_CONST_VALUE('015792E550DCA1544E8E5F0773FEBA3D') INTO :S;

          END

          EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE,CONTACT)
           RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

          IF ((S IS NOT NULL) AND (S<>'') AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

            INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                      TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                      LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                              VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                      :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                      NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
          END


        END

      END

    END

  END
END

--

CREATE OR ALTER PROCEDURE CODE_GET_LOGINS 
(
    ACCOUNT_ID VARCHAR(32),
    IN_MESSAGE_ID VARCHAR(32))
AS
DECLARE VARIABLE CONTACT VARCHAR(100);
DECLARE VARIABLE USER_NAME VARCHAR(100);
DECLARE VARIABLE SENDER_ID VARCHAR(32);
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN
  SELECT IM.CONTACT, IM.SENDER_ID, IM.TYPE_MESSAGE, A.FIRM_ID, A.USER_NAME
    FROM IN_MESSAGES IM
    LEFT JOIN ACCOUNTS A ON A.ACCOUNT_ID=IM.SENDER_ID
   WHERE IM.IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, :TYPE_MESSAGE, :FIRM_ID, :USER_NAME;

  IF ((CONTACT IS NOT NULL) AND (SENDER_ID IS NOT NULL)) THEN BEGIN

    S=:USER_NAME;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE,CONTACT)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      SELECT COUNT(*)
        FROM DRIVERS
       WHERE DRIVER_ID=:SENDER_ID
        INTO :CNT;

      IF (CNT>0) THEN
        S=S||' http://ataxi24.ru/files/taxi.jar';

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,
                                2,NULL,CURRENT_TIMESTAMP,NULL,:DEST_PORT,:FIRM_ID);

    END

  END

END

--

CREATE OR ALTER PROCEDURE CODE_HELP 
(
    SESSION_ID VARCHAR(32),
    IN_MESSAGE_ID VARCHAR(32))
AS
DECLARE VARIABLE ACCOUNT_ID VARCHAR(32);
DECLARE VARIABLE CONTACT VARCHAR(100);
DECLARE VARIABLE SENDER_ID VARCHAR(32);
DECLARE VARIABLE TEXT_IN VARCHAR(4000);
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE SUM_CHARGE NUMERIC(15,2);
DECLARE VARIABLE SUM_RECEIPT NUMERIC(15,2);
DECLARE VARIABLE BALANCE NUMERIC(15,2);
DECLARE VARIABLE MIN_BALANCE NUMERIC(15,2);
DECLARE VARIABLE USER_NAME VARCHAR(100);
DECLARE VARIABLE S VARCHAR(250);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE SURNAME VARCHAR(100);
DECLARE VARIABLE NAME VARCHAR(100);
DECLARE VARIABLE PATRONYMIC VARCHAR(100);
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE SUCCESS INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN
  SELECT IM.CONTACT, IM.SENDER_ID, IM.TEXT_IN, IM.TYPE_MESSAGE
    FROM IN_MESSAGES IM
    LEFT JOIN CODE_MESSAGES CM ON CM.CODE_MESSAGE_ID=IM.CODE_MESSAGE_ID
   WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, :TEXT_IN, :TYPE_MESSAGE;

  SELECT ACCOUNT_ID
    FROM SESSIONS
   WHERE SESSION_ID=:SESSION_ID
    INTO :ACCOUNT_ID;

  IF ((CONTACT IS NOT NULL) AND (SENDER_ID IS NOT NULL) AND (TEXT_IN IS NOT NULL)) THEN BEGIN

    SELECT COUNT(*)
      FROM DRIVERS D
      JOIN  ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
     WHERE D.DRIVER_ID=:SENDER_ID
       AND A.LOCKED<>1
      INTO :CNT;

    IF (CNT>0) THEN BEGIN

      EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:SENDER_ID)
       RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

      SELECT D.MIN_BALANCE, A.USER_NAME, A.SURNAME, A.NAME, A.PATRONYMIC, A.FIRM_ID
        FROM DRIVERS D
        JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
        JOIN CARS C ON C.CAR_ID=D.CAR_ID
       WHERE D.DRIVER_ID=:SENDER_ID
        INTO :MIN_BALANCE, :USER_NAME, :SURNAME, :NAME, :PATRONYMIC, :FIRM_ID;

      SELECT COUNT(*)
        FROM SHIFTS
       WHERE ACCOUNT_ID=:SENDER_ID
         AND DATE_END IS NULL
        INTO :CNT;

      IF ((CNT>0) AND ((MIN_BALANCE IS NULL) OR ((MIN_BALANCE IS NOT NULL) AND (BALANCE>MIN_BALANCE)))) THEN BEGIN

        S=USER_NAME||' - ';
        IF (SURNAME IS NOT NULL) THEN
          S=S||' '||SURNAME;
        IF (NAME IS NOT NULL) THEN
          S=S||' '||NAME;
        IF (PATRONYMIC IS NOT NULL) THEN
          S=S||' '||PATRONYMIC;

        IN AUTONOMOUS TRANSACTION DO BEGIN

          INSERT INTO ALARMS (ALARM_ID,SENDER_ID,RECIPIENT_ID,TYPE_ALARM,
                              DATE_BEGIN,DATE_END,CAPTION,TEXT_ALARM)
                      VALUES (GET_UNIQUE_ID(),'CA25F4C3A6DA8C334D20D3C4F2A2EF62','FF7F332564F795C8411BF28652B22BEA',0,
                              CURRENT_TIMESTAMP,CURRENT_TIMESTAMP+5*(1e0/24/60),'Требуется помощь диспетчера!',:S);
        END

        EXECUTE PROCEDURE EVENT_ALARM('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0)
         RETURNING_VALUES SUCCESS;

        IF (SUCCESS=1) THEN BEGIN

          SELECT CONST_VALUE FROM GET_CONST_VALUE('AB84E2116D3485A847EEE59DB47CE27B') INTO :S;

          EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE,CONTACT)
           RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

          IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

            S=REPLACE_STRING(S,'%CODE',TEXT_IN);

            INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                      TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                      LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                              VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                      :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                      NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
          END

        END

      END

    END

  END
END

--

CREATE OR ALTER PROCEDURE CODE_INCIDENT 
(
    SESSION_ID VARCHAR(32),
    IN_MESSAGE_ID VARCHAR(32))
AS
DECLARE VARIABLE ACCOUNT_ID VARCHAR(100);
DECLARE VARIABLE CONTACT VARCHAR(100);
DECLARE VARIABLE SENDER_ID VARCHAR(32);
DECLARE VARIABLE TEXT_IN VARCHAR(4000);
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE SUM_CHARGE NUMERIC(15,2);
DECLARE VARIABLE SUM_RECEIPT NUMERIC(15,2);
DECLARE VARIABLE BALANCE NUMERIC(15,2);
DECLARE VARIABLE MIN_BALANCE NUMERIC(15,2);
DECLARE VARIABLE USER_NAME VARCHAR(100);
DECLARE VARIABLE S VARCHAR(250);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE SURNAME VARCHAR(100);
DECLARE VARIABLE NAME VARCHAR(100);
DECLARE VARIABLE PATRONYMIC VARCHAR(100);
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE SUCCESS INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN
  SELECT IM.CONTACT, IM.SENDER_ID, IM.TEXT_IN, IM.TYPE_MESSAGE
    FROM IN_MESSAGES IM
    LEFT JOIN CODE_MESSAGES CM ON CM.CODE_MESSAGE_ID=IM.CODE_MESSAGE_ID
   WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, :TEXT_IN, :TYPE_MESSAGE;

  SELECT ACCOUNT_ID
    FROM SESSIONS
   WHERE SESSION_ID=:SESSION_ID
    INTO :ACCOUNT_ID;

  IF ((CONTACT IS NOT NULL) AND (SENDER_ID IS NOT NULL) AND (TEXT_IN IS NOT NULL)) THEN BEGIN

    SELECT COUNT(*)
      FROM DRIVERS D
      JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
     WHERE D.DRIVER_ID=:SENDER_ID
       AND A.LOCKED<>1
      INTO :CNT;

    IF (CNT>0) THEN BEGIN

      EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:SENDER_ID)
       RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

      SELECT D.MIN_BALANCE, A.USER_NAME, A.SURNAME, A.NAME, A.PATRONYMIC, A.FIRM_ID
        FROM DRIVERS D
        JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
        JOIN CARS C ON C.CAR_ID=D.CAR_ID
       WHERE D.DRIVER_ID=:SENDER_ID
        INTO :MIN_BALANCE, :USER_NAME, :SURNAME, :NAME, :PATRONYMIC, :FIRM_ID;
        
      SELECT COUNT(*)
        FROM SHIFTS
       WHERE ACCOUNT_ID=:SENDER_ID
         AND DATE_END IS NULL
        INTO :CNT;

      IF ((CNT>0) AND ((MIN_BALANCE IS NULL) OR ((MIN_BALANCE IS NOT NULL) AND (BALANCE>MIN_BALANCE)))) THEN BEGIN

        S=USER_NAME||' - ';
        IF (SURNAME IS NOT NULL) THEN
          S=S||' '||SURNAME;
        IF (NAME IS NOT NULL) THEN
          S=S||' '||NAME;
        IF (PATRONYMIC IS NOT NULL) THEN
          S=S||' '||PATRONYMIC;

        IN AUTONOMOUS TRANSACTION DO BEGIN

          INSERT INTO ALARMS (ALARM_ID,SENDER_ID,RECIPIENT_ID,TYPE_ALARM,
                              DATE_BEGIN,DATE_END,
                              CAPTION,TEXT_ALARM)
                      VALUES (GET_UNIQUE_ID(),'CA25F4C3A6DA8C334D20D3C4F2A2EF62',NULL,1,
                              CURRENT_TIMESTAMP,CURRENT_TIMESTAMP+5*(1e0/24/60),
                              'Черезвычайное проишествие',:S);
        END

        EXECUTE PROCEDURE EVENT_ALARM('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0)
         RETURNING_VALUES SUCCESS;

        IF (SUCCESS=1) THEN BEGIN

          SELECT CONST_VALUE FROM GET_CONST_VALUE('7B7B35D636E1B840426877D1EB07428F') INTO :S;

          EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE,CONTACT)
           RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

          IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

            S=REPLACE_STRING(S,'%CODE',TEXT_IN);

            INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                      TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                      LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                              VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                      :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,0,
                                      NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
          END

        END

      END

    END

  END
END

--

CREATE OR ALTER PROCEDURE CODE_LOSE 
(
    SESSION_ID VARCHAR(32),
    IN_MESSAGE_ID VARCHAR(32))
AS
DECLARE VARIABLE ACCOUNT_ID VARCHAR(32);
DECLARE VARIABLE CONTACT VARCHAR(100);
DECLARE VARIABLE SENDER_ID VARCHAR(32);
DECLARE VARIABLE TEXT_IN VARCHAR(4000);
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE SUM_CHARGE NUMERIC(15,2);
DECLARE VARIABLE SUM_RECEIPT NUMERIC(15,2);
DECLARE VARIABLE BALANCE NUMERIC(15,2);
DECLARE VARIABLE MIN_BALANCE NUMERIC(15,2);
DECLARE VARIABLE USER_NAME VARCHAR(100);
DECLARE VARIABLE S VARCHAR(250);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE SURNAME VARCHAR(100);
DECLARE VARIABLE NAME VARCHAR(100);
DECLARE VARIABLE PATRONYMIC VARCHAR(100);
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE SUCCESS INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN
  SELECT IM.CONTACT, IM.SENDER_ID, IM.TEXT_IN, IM.TYPE_MESSAGE
    FROM IN_MESSAGES IM
    LEFT JOIN CODE_MESSAGES CM ON CM.CODE_MESSAGE_ID=IM.CODE_MESSAGE_ID
   WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, :TEXT_IN, :TYPE_MESSAGE;

  SELECT ACCOUNT_ID
    FROM SESSIONS
   WHERE SESSION_ID=:SESSION_ID
    INTO :ACCOUNT_ID;

  IF ((CONTACT IS NOT NULL) AND (SENDER_ID IS NOT NULL) AND (TEXT_IN IS NOT NULL)) THEN BEGIN

    SELECT COUNT(*)
      FROM DRIVERS D
      JOIN  ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
     WHERE D.DRIVER_ID=:SENDER_ID
       AND A.LOCKED<>1
      INTO :CNT;

    IF (CNT>0) THEN BEGIN

      EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:SENDER_ID)
       RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

      SELECT D.MIN_BALANCE, A.USER_NAME, A.SURNAME, A.NAME, A.PATRONYMIC, A.FIRM_ID
        FROM DRIVERS D
        JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
        JOIN CARS C ON C.CAR_ID=D.CAR_ID
       WHERE D.DRIVER_ID=:SENDER_ID
        INTO :MIN_BALANCE, :USER_NAME, :SURNAME, :NAME, :PATRONYMIC, :FIRM_ID;

      SELECT COUNT(*)
        FROM SHIFTS
       WHERE ACCOUNT_ID=:SENDER_ID
         AND DATE_END IS NULL
        INTO :CNT;

      IF ((CNT>0) AND ((MIN_BALANCE IS NULL) OR ((MIN_BALANCE IS NOT NULL) AND (BALANCE>MIN_BALANCE)))) THEN BEGIN

        S=USER_NAME||' - ';
        IF (SURNAME IS NOT NULL) THEN
          S=S||' '||SURNAME;
        IF (NAME IS NOT NULL) THEN
          S=S||' '||NAME;
        IF (PATRONYMIC IS NOT NULL) THEN
          S=S||' '||PATRONYMIC;

        IN AUTONOMOUS TRANSACTION DO BEGIN

          INSERT INTO ALARMS (ALARM_ID,SENDER_ID,RECIPIENT_ID,TYPE_ALARM,
                              DATE_BEGIN,DATE_END,CAPTION,TEXT_ALARM)
                      VALUES (GET_UNIQUE_ID(),'CA25F4C3A6DA8C334D20D3C4F2A2EF62','FF7F332564F795C8411BF28652B22BEA',0,
                              CURRENT_TIMESTAMP,CURRENT_TIMESTAMP+5*(1e0/24/60),'Водитель заблудился',:S);
        END

        EXECUTE PROCEDURE EVENT_ALARM('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0)
         RETURNING_VALUES SUCCESS;

        IF (SUCCESS=1) THEN BEGIN

          SELECT CONST_VALUE FROM GET_CONST_VALUE('AB84E2116D3485A847EEE59DB47CE27B') INTO :S;

          EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE,CONTACT)
           RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

          IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

            S=REPLACE_STRING(S,'%CODE',TEXT_IN);

            INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                      TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                      LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                              VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                      :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                      NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
          END

        END

      END

    END

  END
END

--

CREATE OR ALTER PROCEDURE CODE_MAKE_ORDER 
(
    SESSION_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32),
    IN_MESSAGE_ID VARCHAR(32))
AS
DECLARE VARIABLE CONTACT VARCHAR(100);
DECLARE VARIABLE SENDER_ID VARCHAR(32);
DECLARE VARIABLE S VARCHAR(70);
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE CONST_VALUE VARCHAR(4000);
DECLARE VARIABLE ORDER_NUM VARCHAR(10);
DECLARE VARIABLE ACTION_ID VARCHAR(32);
DECLARE VARIABLE RATE_ID VARCHAR(32);
DECLARE VARIABLE CAR_TYPE_ID VARCHAR(32);
DECLARE VARIABLE CLIENT_ID VARCHAR(32);
DECLARE VARIABLE STREET_ID VARCHAR(32);
DECLARE VARIABLE HOUSE VARCHAR(10);
DECLARE VARIABLE FLAT VARCHAR(10);
DECLARE VARIABLE PORCH VARCHAR(10);
DECLARE VARIABLE ADDRESS_DESC VARCHAR(250);
DECLARE VARIABLE LOCKED INTEGER;
DECLARE VARIABLE ORDER_ID VARCHAR(32);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
DECLARE VARIABLE RND INTEGER;
DECLARE VARIABLE TYPE_ACCEPT INTEGER;
DECLARE VARIABLE DISCOUNT_ID VARCHAR(32);
DECLARE VARIABLE L INTEGER;
DECLARE VARIABLE LL INTEGER;
BEGIN
  SELECT CONTACT, SENDER_ID, TYPE_MESSAGE
    FROM IN_MESSAGES
   WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, TYPE_MESSAGE;

  SELECT COUNT(*)
    FROM BLACKS
   WHERE UPPER(PHONE)=UPPER(:CONTACT)
    INTO :CNT;

  /* need check */
  SELECT COUNT(PHONE) FROM S_ORDERS_NOW WHERE PHONE = :CONTACT INTO :L;
  SELECT COUNT(PHONE) FROM S_ORDERS_PRE WHERE PHONE = :CONTACT INTO :LL;

  IF ((CONTACT IS NOT NULL) AND (CNT=0) AND (:L = 0 AND :LL = 0)) THEN BEGIN

    SELECT LOCKED, CLIENT_ID, STREET_ID, HOUSE, FLAT, PORCH, ADDRESS_DESC
      FROM CLIENTS C
      JOIN ACCOUNTS A ON A.ACCOUNT_ID=C.CLIENT_ID
     WHERE C.CLIENT_ID=:SENDER_ID
      INTO :LOCKED, :CLIENT_ID, :STREET_ID, :HOUSE, :FLAT, :PORCH, :ADDRESS_DESC;

    IF ((CLIENT_ID IS NULL) OR ((CLIENT_ID IS NOT NULL) AND (LOCKED<>1))) THEN BEGIN

      SELECT CONST_VALUE FROM GET_CONST_VALUE('CB66FC06A78BB69D430EB7BD1AFA13FA') INTO :S;

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE,CONTACT)
       RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

      IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        STREET_ID='FA27330C653381FA4EDE11ECF0959DD6';  /* Красноярск - .*/
        HOUSE=NULL;
        FLAT=NULL;
        PORCH=NULL;
        ADDRESS_DESC=NULL;

        EXECUTE PROCEDURE GET_ORDER_NUM
         RETURNING_VALUES :ORDER_NUM;

        ACTION_ID='E019DBDE7D55BEC34D12A709EE3FEB0B'; /* Создание */

        RATE_ID=NULL;
        FOR SELECT RATE_ID
             FROM RATES
            ORDER BY PRIORITY
             INTO :RATE_ID DO BEGIN
          BREAK;
        END

        CAR_TYPE_ID=NULL;
        FOR SELECT CAR_TYPE_ID
              FROM CAR_TYPES
             ORDER BY PRIORITY
              INTO :CAR_TYPE_ID DO BEGIN
          BREAK;
        END

        IF ((RATE_ID IS NOT NULL) AND (CAR_TYPE_ID IS NOT NULL)) THEN BEGIN

          ORDER_ID=GET_UNIQUE_ID();

          FIRM_ID='C49DF004D660BBAF434839044848F5B8'; /* АТакси */

          /* RND=RANDOM(10);

          IF (RND>=5) THEN
            FIRM_ID='81DCAB751C23A5C942A41C19FE3FC78E';  Прорыв */
            
          TYPE_ACCEPT=0;
          IF (TYPE_MESSAGE IN (0,1)) THEN
            TYPE_ACCEPT=1;


          DISCOUNT_ID = NULL;
          FOR SELECT D.DISCOUNT_ID
                FROM DISCOUNTS D
               WHERE D.CLIENT_ID = :CLIENT_ID
                 AND D.DATE_END IS NULL
               ORDER BY D.PRIORITY DESC
                INTO :DISCOUNT_ID DO BEGIN
            BREAK;
          END

          INSERT INTO ORDERS (ORDER_ID,ACTION_ID,RATE_ID,CAR_TYPE_ID,WHO_ACCEPT_ID,
                              CLIENT_ID,STREET_ID,HOUSE,FLAT,PORCH,DESCRIPTION,
                              ORDER_NUM,PHONE,DATE_ACCEPT,DATE_ARRIVAL,TYPE_ACCEPT,
                              TYPE_PROCESS,BEFORE_PERIOD,DATE_BEGIN,FINISHED,FIRM_ID,DISCOUNT_ID)
                      VALUES (:ORDER_ID,:ACTION_ID,:RATE_ID,:CAR_TYPE_ID,:ACCOUNT_ID,
                              :CLIENT_ID,:STREET_ID,:HOUSE,:FLAT,:PORCH,:ADDRESS_DESC,
                              :ORDER_NUM,:CONTACT,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,:TYPE_ACCEPT,
                              1,30,CURRENT_TIMESTAMP,0,:FIRM_ID,:DISCOUNT_ID);

          UPDATE IN_MESSAGES
             SET ORDER_ID=:ORDER_ID
           WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID;

          S=REPLACE_STRING(S,'%ORDER_NUM',ORDER_NUM);

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                    PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID, Message_id, source)
                            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                    :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,
                                    1,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID, null, null);

        END

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE CODE_PARK_OUT 
(
    SESSION_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32),
    IN_MESSAGE_ID VARCHAR(32))
AS
DECLARE VARIABLE CONTACT VARCHAR(100);
DECLARE VARIABLE SENDER_ID VARCHAR(32);
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE PARK_NAME VARCHAR(100);
DECLARE VARIABLE PARK_STATE_ID VARCHAR(32);
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE D TIMESTAMP;
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN

  SELECT IM.CONTACT, IM.SENDER_ID, IM.TYPE_MESSAGE, A.FIRM_ID
    FROM IN_MESSAGES IM
    LEFT JOIN ACCOUNTS A ON A.ACCOUNT_ID=IM.SENDER_ID
   WHERE IM.IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, :TYPE_MESSAGE, :FIRM_ID;

  /* need check */
  IF ((CONTACT IS NOT NULL) AND (SENDER_ID IS NOT NULL)) THEN BEGIN

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE,CONTACT)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

  if (
    (CURRENT_TIMESTAMP >= cast('16:30' as time) AND
     CURRENT_TIMESTAMP <= cast('19:30' as time)) OR
    (CURRENT_TIMESTAMP >= cast('07:30' as time) AND
     CURRENT_TIMESTAMP <= cast('09:30' as time))) then
  begin
            SELECT CONST_VALUE FROM GET_CONST_VALUE('C5E070699030B7D94E1656DAC12EAE8B') INTO :S;
            if (:S is not null) then
            begin
            INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                      TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                      LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                              VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                      :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                      NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
            end
  end  ELSE BEGIN

    SELECT COUNT(*)
      FROM DRIVERS D
      JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
     WHERE D.DRIVER_ID=:SENDER_ID
       AND A.LOCKED<>1
      INTO :CNT;

    IF (CNT>0) THEN BEGIN

      SELECT COUNT(*)
        FROM ORDERS
       WHERE DRIVER_ID=:SENDER_ID
         AND PARENT_ID IS NULL
         AND DATE_HISTORY IS NULL
         AND FINISHED<>1
        INTO :CNT;

      IF (CNT>0) THEN BEGIN

        SELECT CONST_VALUE FROM GET_CONST_VALUE('7E75E7A3DA4FAB8D443F2D7384B3DF46') INTO :S;

        IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                    LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                    :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                    NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
        END

      END ELSE BEGIN

        FOR SELECT P.NAME, PS.PARK_STATE_ID
              FROM PARK_STATES PS
              JOIN PARKS P ON P.PARK_ID=PS.PARK_ID
             WHERE PS.DRIVER_ID=:SENDER_ID
               AND PS.DATE_OUT IS NULL
              INTO :PARK_NAME, :PARK_STATE_ID DO BEGIN

          D=CURRENT_TIMESTAMP;

          UPDATE PARK_STATES
             SET DATE_OUT=:D
           WHERE PARK_STATE_ID=:PARK_STATE_ID;

          SELECT CONST_VALUE FROM GET_CONST_VALUE('F5FAEFF5369FA2E2496554FFACF900A3') INTO :S;

          IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

            S=REPLACE_STRING(S,'%PARK_NAME',PARK_NAME);
            S=REPLACE_STRING(S,'%TIME_DATE',FORMAT_DATETIME('hh:nn:ss dd.mm.yyyy',D));

            INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                      TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                      LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                              VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                      :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                      NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
          END

          BREAK;

        END

        EXECUTE PROCEDURE event_refresh_park_states('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

      END

    END

  end

  END

END

--

CREATE OR ALTER PROCEDURE CODE_PARK_QUEUE 
(
    ACCOUNT_ID VARCHAR(32),
    IN_MESSAGE_ID VARCHAR(32))
AS
DECLARE VARIABLE CONTACT VARCHAR(100);
DECLARE VARIABLE SENDER_ID VARCHAR(32);
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE D TIMESTAMP;
DECLARE VARIABLE DATE_IN TIMESTAMP;
DECLARE VARIABLE DRIVER_ID VARCHAR(32);
DECLARE VARIABLE PARK_NAME VARCHAR(100);
DECLARE VARIABLE PARK_ID VARCHAR(32);
DECLARE VARIABLE SUM_CHARGE NUMERIC(15,2);
DECLARE VARIABLE SUM_RECEIPT NUMERIC(15,2);
DECLARE VARIABLE BALANCE NUMERIC(15,2);
DECLARE VARIABLE MIN_BALANCE NUMERIC(15,2);
DECLARE VARIABLE MINUTES INTEGER;
DECLARE VARIABLE COUNTER INTEGER;
DECLARE VARIABLE PRIORITY INTEGER;
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN
  SELECT IM.CONTACT, IM.SENDER_ID, IM.TYPE_MESSAGE, A.FIRM_ID
    FROM IN_MESSAGES IM
    LEFT JOIN ACCOUNTS A ON A.ACCOUNT_ID=IM.SENDER_ID
   WHERE IM.IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, :TYPE_MESSAGE, :FIRM_ID;

  IF ((CONTACT IS NOT NULL) AND (SENDER_ID IS NOT NULL)) THEN BEGIN

    SELECT COUNT(*)
      FROM DRIVERS D
      JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
     WHERE D.DRIVER_ID=:SENDER_ID
       AND A.LOCKED<>1
      INTO :CNT;

    IF (CNT>0) THEN BEGIN

      EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:SENDER_ID)
       RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

      SELECT MIN_BALANCE
        FROM DRIVERS
       WHERE DRIVER_ID=:SENDER_ID
        INTO :MIN_BALANCE;

      IF ((MIN_BALANCE IS NULL) OR ((MIN_BALANCE IS NOT NULL) AND (BALANCE>MIN_BALANCE))) THEN BEGIN

        PARK_ID=NULL;
        PARK_NAME=NULL;

        FOR SELECT PS.PARK_ID, P.NAME
              FROM PARK_STATES PS
              JOIN PARKS P ON P.PARK_ID=PS.PARK_ID
             WHERE DRIVER_ID=:SENDER_ID
               AND DATE_OUT IS NULL
              INTO :PARK_ID, :PARK_NAME DO BEGIN
          BREAK;
        END

        IF (PARK_ID IS NOT NULL) THEN BEGIN

          D=NULL;
          COUNTER=0;

          FOR SELECT DATE_IN, DRIVER_ID
                FROM PARK_STATES
               WHERE DATE_OUT IS NULL
                 AND PARK_ID=:PARK_ID
               ORDER BY DATE_IN
                INTO :DATE_IN, :DRIVER_ID DO BEGIN

            COUNTER=COUNTER+1;

            IF (DRIVER_ID=SENDER_ID) THEN BEGIN
              D=CURRENT_TIMESTAMP;
              MINUTES=CAST((D-DATE_IN)*(1e0*24*60) AS INTEGER);
              PRIORITY=COUNTER;
            END

          END

          IF (D IS NOT NULL) THEN BEGIN

            SELECT CONST_VALUE FROM GET_CONST_VALUE('A92208254FCBA05643224EB1F4508300') INTO :S;

            EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE,CONTACT)
             RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

            IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

              S=REPLACE_STRING(S,'%PRIORITY',CAST(PRIORITY AS VARCHAR(10)));
              S=REPLACE_STRING(S,'%COUNTER',CAST(COUNTER AS VARCHAR(10)));
              S=REPLACE_STRING(S,'%PARK_NAME',PARK_NAME);
              S=REPLACE_STRING(S,'%MINUTES',CAST(MINUTES AS VARCHAR(10)));

              INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                        TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                        LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                                VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                        :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                        NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
            END

          END

        END

      END

    END

  END
END

--

CREATE OR ALTER PROCEDURE CODE_SHIFT_CLOSE 
(
    SESSION_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32),
    IN_MESSAGE_ID VARCHAR(32))
AS
DECLARE VARIABLE CONTACT VARCHAR(100);
DECLARE VARIABLE SENDER_ID VARCHAR(32);
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE D TIMESTAMP;
DECLARE VARIABLE DATE_BEGIN TIMESTAMP;
DECLARE VARIABLE SHIFT_ID VARCHAR(32);
DECLARE VARIABLE HOURS NUMERIC(10,1);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN
  SELECT IM.CONTACT, IM.SENDER_ID, IM.TYPE_MESSAGE, A.FIRM_ID
    FROM IN_MESSAGES IM
    LEFT JOIN ACCOUNTS A ON A.ACCOUNT_ID=IM.SENDER_ID
   WHERE IM.IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO CONTACT, SENDER_ID, :TYPE_MESSAGE, :FIRM_ID;

  IF ((CONTACT IS NOT NULL) AND (SENDER_ID IS NOT NULL)) THEN BEGIN

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE,CONTACT)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    SELECT COUNT(*)
      FROM DRIVERS
     WHERE DRIVER_ID=:SENDER_ID
      INTO :CNT;

    IF (CNT>0) THEN BEGIN

      SELECT COUNT(*)
        FROM ORDERS
       WHERE DRIVER_ID=:SENDER_ID
         AND PARENT_ID IS NULL
         AND DATE_HISTORY IS NULL
         AND FINISHED<>1
        INTO :CNT;

      IF (CNT>0) THEN BEGIN

        SELECT CONST_VALUE FROM GET_CONST_VALUE('0A2F3602D3FD9A0E476E367410F37492') INTO :S;

        IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                    LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                             VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                     :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                     NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
        END

      END ELSE BEGIN

        FOR SELECT DATE_BEGIN, SHIFT_ID
              FROM SHIFTS
             WHERE ACCOUNT_ID=:SENDER_ID
               AND DATE_END IS NULL
              INTO :DATE_BEGIN, :SHIFT_ID DO BEGIN

          D=CURRENT_TIMESTAMP;

          UPDATE PARK_STATES
             SET DATE_OUT=:D
           WHERE DRIVER_ID=:SENDER_ID
             AND DATE_OUT IS NULL;

          UPDATE SHIFTS
             SET DATE_END=:D
           WHERE SHIFT_ID=:SHIFT_ID
             AND DATE_END IS NULL;

          HOURS=CAST((D-DATE_BEGIN)*(1e0*24) AS NUMERIC(10,1));

          SELECT CONST_VALUE FROM GET_CONST_VALUE('5D8701DF0DEDB7A6491181074CE5A88D') INTO :S;

          IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

            S=REPLACE_STRING(S,'%TIME_DATE',FORMAT_DATETIME('hh:nn:ss dd.mm.yyyy',D));
            S=REPLACE_STRING(S,'%HOURS',CAST(HOURS AS VARCHAR(30)));

            INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                      TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                      LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                              VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                      :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                      NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
          END

        END

        EXECUTE PROCEDURE EVENT_REFRESH_SHIFTS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

        EXECUTE PROCEDURE EVENT_REFRESH_PARK_STATES('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

      END

    END

  END
END

--

CREATE OR ALTER PROCEDURE CODE_TEST 
(
    ACCOUNT_ID VARCHAR(32),
    IN_MESSAGE_ID VARCHAR(32))
AS
DECLARE VARIABLE CONTACT VARCHAR(100);
DECLARE VARIABLE SENDER_ID VARCHAR(32);
DECLARE VARIABLE S VARCHAR(70);
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE MSEC BIGINT;
DECLARE VARIABLE DAYS INTEGER;
DECLARE VARIABLE HOURS INTEGER;
DECLARE VARIABLE MINUTES INTEGER;
DECLARE VARIABLE SECONDS INTEGER;
DECLARE VARIABLE D TIMESTAMP;
DECLARE VARIABLE UPTIME VARCHAR(100);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN
  SELECT IM.CONTACT, IM.SENDER_ID, IM.TYPE_MESSAGE, A.FIRM_ID
    FROM IN_MESSAGES IM
    LEFT JOIN ACCOUNTS A ON A.ACCOUNT_ID=IM.SENDER_ID
   WHERE IM.IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, :TYPE_MESSAGE, :FIRM_ID;

  IF ((CONTACT IS NOT NULL) AND (SENDER_ID IS NOT NULL)) THEN BEGIN

    SELECT COUNT(*)
      FROM ACCOUNT_ROLES
     WHERE ROLE_ID IN ('3AC5EA48DEA3A72A4380D9CC5923471F','FF7F332564F795C8411BF28652B22BEA') /* Администраторы, Диспетчеры */
       AND ACCOUNT_ID=:SENDER_ID
      INTO CNT;

    IF (CNT>0) THEN BEGIN

      SELECT CONST_VALUE FROM GET_CONST_VALUE('DD5F7C07EB2CBC6B4CE52043B3BF395D') INTO :S;

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE,CONTACT)
       RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

      IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        MSEC=SYSTEM_UPTIME();
        DAYS=MSEC/(1000*60*60*24);
        MSEC=MSEC-(DAYS*1000*60*60*24);
        HOURS=MSEC/(1000*60*60);
        MSEC=MSEC-(HOURS*1000*60*60);
        MINUTES=MSEC/(1000*60);
        MSEC=MSEC-(MINUTES*1000*60);
        SECONDS=MSEC/1000;
        D=CAST((CAST(HOURS AS VARCHAR(2))||':'||CAST(MINUTES AS VARCHAR(2))||':'||CAST(SECONDS AS VARCHAR(2))) AS TIME);

        UPTIME=CAST(DAYS AS VARCHAR(10))||'-'||FORMAT_DATETIME('hh:nn:ss',D);

        S=REPLACE_STRING(S,'%UPTIME',UPTIME);

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                  LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                  :S,NULL,0,:CONTACT,NULL,0,
                                  NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
      END
    END

  END

END

--

CREATE OR ALTER PROCEDURE CREATE_PAYMENT (
    RECEIPT_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32),
    WHO_CREATE_ID VARCHAR(32),
    SUM_RECEIPT NUMERIC(15,2),
    DATE_RECEIPT TIMESTAMP,
    DESCRIPTION VARCHAR(250))
RETURNS (
    PAYMENT_EXISTS INTEGER)
AS
DECLARE VARIABLE S VARCHAR(70);
DECLARE VARIABLE RECEIPT_TYPE_ID VARCHAR(32);
DECLARE VARIABLE CHARGE_TYPE_ID VARCHAR(32);
DECLARE VARIABLE DATE_CREATE TIMESTAMP;
DECLARE VARIABLE ASUM_CHARGE NUMERIC(15,2);
DECLARE VARIABLE ASUM_RECEIPT NUMERIC(15,2);
DECLARE VARIABLE BALANCE NUMERIC(15,2);
DECLARE VARIABLE PHONE VARCHAR(100);
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE SUM_CHARGE NUMERIC(15,2);
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN
  PAYMENT_EXISTS=0;

  RECEIPT_TYPE_ID='2E0EEFF564858A6F48C8BE486202114A'; /* Наличными через платежку */

  FIRM_ID='C49DF004D660BBAF434839044848F5B8'; /* АТакси */

  SELECT COUNT(*)
    FROM RECEIPTS
   WHERE ACCOUNT_ID=:ACCOUNT_ID
     AND WHO_CREATE_ID=:WHO_CREATE_ID
     AND RECEIPT_TYPE_ID=:RECEIPT_TYPE_ID
     AND DESCRIPTION=:DESCRIPTION
    INTO :CNT;

  IF (CNT=0) THEN BEGIN

    DATE_CREATE=CURRENT_TIMESTAMP;
    DATE_RECEIPT=DATE_RECEIPT+8*60*60*(1e0/24/60/60);  /* Stupid difference between krasplat and our server */

    INSERT INTO RECEIPTS (RECEIPT_ID,RECEIPT_TYPE_ID,ACCOUNT_ID,WHO_CREATE_ID,
                          SUM_RECEIPT,DATE_RECEIPT,DATE_CREATE,DESCRIPTION,FIRM_ID)
         VALUES (:RECEIPT_ID,:RECEIPT_TYPE_ID,:ACCOUNT_ID,:WHO_CREATE_ID,
                 :SUM_RECEIPT,:DATE_RECEIPT,:DATE_CREATE,:DESCRIPTION,:FIRM_ID);

    CHARGE_TYPE_ID='E49F54CE241196A946067CD38FCB502B'; /* Удержание за Платежку */

    SUM_CHARGE=SUM_RECEIPT*0.15;

    INSERT INTO CHARGES (CHARGE_ID,CHARGE_TYPE_ID,ACCOUNT_ID,WHO_CREATE_ID,
                         SUM_CHARGE,DATE_CHARGE,DATE_CREATE,DESCRIPTION,FIRM_ID)
       VALUES (GET_UNIQUE_ID(),:CHARGE_TYPE_ID,:ACCOUNT_ID,:WHO_CREATE_ID,
               :SUM_CHARGE,:DATE_RECEIPT,:DATE_CREATE,NULL,:FIRM_ID);

    EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:ACCOUNT_ID)
     RETURNING_VALUES :ASUM_CHARGE, :ASUM_RECEIPT, :BALANCE;

    BALANCE=ASUM_RECEIPT-ASUM_CHARGE;

    SELECT PHONE, FIRM_ID
      FROM ACCOUNTS
     WHERE ACCOUNT_ID=:ACCOUNT_ID
      INTO :PHONE, :FIRM_ID;

    SELECT COUNT(*)
      FROM CLIENTS
     WHERE CLIENT_ID=:ACCOUNT_ID
      INTO :CNT;

    IF (CNT>0) THEN
      FIRM_ID=NULL; /* Не понятно чьё сообщение */

    SELECT CONST_VALUE FROM GET_CONST_VALUE('2031AA8F2E4B959248967F2838DC5F19') INTO :S;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(ACCOUNT_ID,NULL,PHONE)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      S=REPLACE_STRING(S,'%BALANCE',CAST(BALANCE AS VARCHAR(30)));

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:WHO_CREATE_ID,:ACCOUNT_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,2,
                                NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
    END

  END ELSE BEGIN

    PAYMENT_EXISTS=1;

  END

END

--

CREATE OR ALTER PROCEDURE D_DRIVER_PARK 
(
    SESSION_ID VARCHAR(32),
    DRIVER_ID VARCHAR(32),
    PARK_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32),
    DATE_OUT TIMESTAMP)
AS
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE PARK_NAME VARCHAR(100);
DECLARE VARIABLE CONTACT VARCHAR(100);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN

  UPDATE PARK_STATES
     SET DATE_OUT=:DATE_OUT
   WHERE DRIVER_ID=:DRIVER_ID
     AND PARK_ID=:PARK_ID
     AND DATE_OUT IS NULL;

  /* need check */
  EXECUTE PROCEDURE EVENT_REFRESH_SHIFTS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

  SELECT PHONE, FIRM_ID
    FROM ACCOUNTS
   WHERE ACCOUNT_ID=:DRIVER_ID
    INTO :CONTACT, :FIRM_ID;

  SELECT CONST_VALUE FROM GET_CONST_VALUE('C0B2DFF0FD07BC1C43047D31AECDC8A2') INTO :S;

  EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL,CONTACT)
   RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

  IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

    SELECT NAME
      FROM PARKS
     WHERE PARK_ID=:PARK_ID
      INTO :PARK_NAME;

    S=REPLACE_STRING(S,'%PARK_NAME',PARK_NAME);
    S=REPLACE_STRING(S,'%TIME_DATE',FORMAT_DATETIME('hh:nn:ss dd.mm.yyyy',DATE_OUT));

/*    S=REPLACE(S,'%PARK_NAME',PARK_NAME);
    S=REPLACE(S,'%TIME_DATE',FORMAT_DATETIME('hh:nn:ss dd.mm.yyyy',DATE_OUT));*/

    INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                              TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                              LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                      VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                              :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                              NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
  END

END

--

CREATE OR ALTER PROCEDURE D_DRIVER_SHIFT 
(
    SESSION_ID VARCHAR(32),
    SHIFT_ID VARCHAR(32),
    DRIVER_ID VARCHAR(32),
    PARK_ID VARCHAR(32),
    DATE_END TIMESTAMP,
    ACCOUNT_ID VARCHAR(32),
    LOCKED INTEGER)
AS
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE CONTACT VARCHAR(100);
DECLARE VARIABLE HOURS NUMERIC(10,1);
DECLARE VARIABLE D TIMESTAMP;
DECLARE VARIABLE DATE_BEGIN TIMESTAMP;
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN

  SELECT PHONE, FIRM_ID
    FROM ACCOUNTS
   WHERE ACCOUNT_ID=:DRIVER_ID
    INTO :CONTACT, :FIRM_ID;

  UPDATE ACCOUNTS
     SET LOCKED=:LOCKED
   WHERE ACCOUNT_ID=:DRIVER_ID;

  UPDATE SHIFTS
     SET DATE_END=:DATE_END
   WHERE ACCOUNT_ID=:DRIVER_ID
     AND SHIFT_ID=:SHIFT_ID;

  /* need check */
  EXECUTE PROCEDURE EVENT_REFRESH_SHIFTS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

  IF (PARK_ID IS NOT NULL) THEN BEGIN

    UPDATE PARK_STATES
       SET DATE_OUT=:DATE_END
     WHERE DRIVER_ID=:DRIVER_ID
       AND PARK_ID=:PARK_ID
       AND DATE_OUT IS NULL;

  END ELSE BEGIN

    UPDATE PARK_STATES
       SET DATE_OUT=:DATE_END
     WHERE DRIVER_ID=:DRIVER_ID
       AND DATE_OUT IS NULL;

  END

  /* need check if it's happend on client */
  EXECUTE PROCEDURE EVENT_REFRESH_PARK_STATES('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

  SELECT DATE_BEGIN
    FROM SHIFTS
   WHERE SHIFT_ID=:SHIFT_ID
    INTO :DATE_BEGIN;

  D=CURRENT_TIMESTAMP;

  HOURS=CAST((D-DATE_BEGIN)*(1e0*24) AS NUMERIC(10,1));

  SELECT CONST_VALUE FROM GET_CONST_VALUE('7032584355F3A3C44394DAA17D8A9BA9') INTO :S;

  EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL,CONTACT)
   RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

  IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

    S=REPLACE_STRING(S,'%TIME_DATE',FORMAT_DATETIME('hh:nn:ss dd.mm.yyyy',D));
    S=REPLACE_STRING(S,'%HOURS',CAST(HOURS AS VARCHAR(30)));

/*    S=REPLACE(S,'%TIME_DATE',FORMAT_DATETIME('hh:nn:ss dd.mm.yyyy',D));
    S=REPLACE(S,'%HOURS',CAST(HOURS AS VARCHAR(30)));*/

    INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                              TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                              LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                      VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                              :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                              NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
  END

END

--

CREATE OR ALTER PROCEDURE I_DRIVER_PARK 
(
    SESSION_ID VARCHAR(32),
    DRIVER_ID VARCHAR(32),
    PARK_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32),
    DATE_IN TIMESTAMP)
AS
DECLARE VARIABLE SUM_CHARGE NUMERIC(15,2);
DECLARE VARIABLE SUM_RECEIPT NUMERIC(15,2);
DECLARE VARIABLE BALANCE NUMERIC(15,2);
DECLARE VARIABLE MIN_BALANCE NUMERIC(15,2);
DECLARE VARIABLE CONTACT VARCHAR(100);
DECLARE VARIABLE PARK_NAME VARCHAR(100);
DECLARE VARIABLE PARK_DESCRIPTION VARCHAR(250);
DECLARE VARIABLE PRIORITY INTEGER;
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
DECLARE VARIABLE DRIVER_PRIORITY INTEGER;
BEGIN

  EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:DRIVER_ID)
   RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

  SELECT MIN_BALANCE, PRIORITY
    FROM DRIVERS
   WHERE DRIVER_ID=:DRIVER_ID
    INTO :MIN_BALANCE, :DRIVER_PRIORITY;

  IF ((MIN_BALANCE IS NULL) OR ((MIN_BALANCE IS NOT NULL) AND (BALANCE>MIN_BALANCE))) THEN BEGIN

    SELECT PHONE, FIRM_ID
      FROM ACCOUNTS
     WHERE ACCOUNT_ID=:DRIVER_ID
      INTO :CONTACT, :FIRM_ID;

    INSERT INTO PARK_STATES(PARK_STATE_ID,DRIVER_ID,PARK_ID,DATE_IN)
         VALUES (GET_UNIQUE_ID(),:DRIVER_ID,:PARK_ID,:DATE_IN);

    /* need check */
    EXECUTE PROCEDURE EVENT_REFRESH_PARK_STATES('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

    /* need check */
    SELECT COUNT(*)
      FROM PARK_STATES PAS
      JOIN DRIVERS DRS ON DRS.DRIVER_ID = PAS.DRIVER_ID
      JOIN CAR_IN_TYPES CIT ON CIT.CAR_ID = DRS.CAR_ID
     WHERE PAS.PARK_ID=:PARK_ID
       AND PAS.DATE_OUT IS NULL
       AND DRS.PRIORITY <= :DRIVER_PRIORITY
       AND CIT.CAR_TYPE_ID != '2FC1A2E9B900A144441F4B342A432950'
      INTO :PRIORITY;

    SELECT CONST_VALUE FROM GET_CONST_VALUE('D98222D30163A3FE4B647ABF4A2C179F') INTO :S;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL,CONTACT)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      SELECT NAME, DESCRIPTION
        FROM PARKS
       WHERE PARK_ID=:PARK_ID
        INTO :PARK_NAME, :PARK_DESCRIPTION;

      S=REPLACE_STRING(S,'%PRIORITY',CAST(PRIORITY AS VARCHAR(10)));
      S=REPLACE_STRING(S,'%PARK_NAME',PARK_NAME);
      S=REPLACE_STRING(S,'%PARK_DESCRIPTION',PARK_DESCRIPTION);
      S=REPLACE_STRING(S,'%BALANCE',CAST(BALANCE AS VARCHAR(30)));

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
    END

  END
END

--

CREATE OR ALTER PROCEDURE I_DRIVER_SHIFT 
(
    SESSION_ID VARCHAR(32),
    SHIFT_ID VARCHAR(32),
    DRIVER_ID VARCHAR(32),
    PARK_ID VARCHAR(32),
    DATE_BEGIN TIMESTAMP,
    ACCOUNT_ID VARCHAR(32))
AS
DECLARE VARIABLE SUM_CHARGE NUMERIC(15,2);
DECLARE VARIABLE SUM_RECEIPT NUMERIC(15,2);
DECLARE VARIABLE BALANCE NUMERIC(15,2);
DECLARE VARIABLE MIN_BALANCE NUMERIC(15,2);
DECLARE VARIABLE PARK_NAME VARCHAR(100);
DECLARE VARIABLE PARK_DESCRIPTION VARCHAR(250);
DECLARE VARIABLE PRIORITY INTEGER;
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE CONTACT VARCHAR(100);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
DECLARE VARIABLE DRIVER_PRIORITY INTEGER;
BEGIN

  SELECT D.MIN_BALANCE, D.PRIORITY, A.PHONE, A.FIRM_ID
    FROM DRIVERS D
    JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
   WHERE DRIVER_ID=:DRIVER_ID
    INTO :MIN_BALANCE, :DRIVER_PRIORITY, :CONTACT, :FIRM_ID;
    
  EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL,CONTACT)
   RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

  EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:DRIVER_ID)
   RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

  IF ((MIN_BALANCE IS NULL) OR ((MIN_BALANCE IS NOT NULL) AND (BALANCE>MIN_BALANCE))) THEN BEGIN

    INSERT INTO SHIFTS (SHIFT_ID,ACCOUNT_ID,DATE_BEGIN)
         VALUES (:SHIFT_ID,:DRIVER_ID,:DATE_BEGIN);

    /* need check */
    EXECUTE PROCEDURE event_refresh_shifts('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

    IF (PARK_ID IS NOT NULL) THEN BEGIN

      UPDATE PARK_STATES
         SET DATE_OUT=:DATE_BEGIN
       WHERE DRIVER_ID=:DRIVER_ID
         AND DATE_OUT IS NULL;

      INSERT INTO PARK_STATES(PARK_STATE_ID,DRIVER_ID,PARK_ID,DATE_IN)
           VALUES (GET_UNIQUE_ID(),:DRIVER_ID,:PARK_ID,:DATE_BEGIN);

      /* need check */
      EXECUTE PROCEDURE event_refresh_park_states('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

      /* need check */
      SELECT COUNT(*)
        FROM PARK_STATES PAS
        JOIN DRIVERS DRS ON DRS.DRIVER_ID = PAS.DRIVER_ID
        JOIN CAR_IN_TYPES CIT ON CIT.CAR_ID = DRS.CAR_ID
       WHERE PAS.PARK_ID=:PARK_ID
         AND PAS.DATE_OUT IS NULL
         AND DRS.PRIORITY <= :DRIVER_PRIORITY
         AND CIT.CAR_TYPE_ID != '2FC1A2E9B900A144441F4B342A432950'
        INTO PRIORITY;

      SELECT CONST_VALUE FROM GET_CONST_VALUE('D98222D30163A3FE4B647ABF4A2C179F') INTO :S;

      IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        SELECT NAME, DESCRIPTION
          FROM PARKS
         WHERE PARK_ID=:PARK_ID
          INTO :PARK_NAME, :PARK_DESCRIPTION;

        S=REPLACE_STRING(S,'%PRIORITY',CAST(PRIORITY AS VARCHAR(10)));
        S=REPLACE_STRING(S,'%PARK_NAME',PARK_NAME);
        S=REPLACE_STRING(S,'%PARK_DESCRIPTION',PARK_DESCRIPTION);
        S=REPLACE_STRING(S,'%BALANCE',CAST(BALANCE AS VARCHAR(30)));

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                  LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                  :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,0,
                                  NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
      END

    END ELSE BEGIN

      SELECT CONST_VALUE FROM GET_CONST_VALUE('C83CCF38CF6CAB374FAB6FA49754B07F') INTO :S;

      IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        S=REPLACE_STRING(S,'%BALANCE',CAST(BALANCE AS VARCHAR(30)));

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                  LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                  :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,0,
                                  NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE I_OUT_MESSAGE 
(
    OUT_MESSAGE_ID VARCHAR(32),
    CREATOR_ID VARCHAR(32),
    RECIPIENT_ID VARCHAR(32),
    DATE_CREATE TIMESTAMP,
    TEXT_OUT VARCHAR(4000),
    DATE_OUT TIMESTAMP,
    TYPE_MESSAGE INTEGER,
    CONTACT VARCHAR(100),
    DESCRIPTION VARCHAR(250),
    PRIORITY INTEGER,
    LOCKED VARCHAR(32),
    DATE_BEGIN TIMESTAMP,
    DATE_END TIMESTAMP,
    ORDER_ID VARCHAR(32),
    CHANNEL VARCHAR(100),
    DELIVERY INTEGER,
    DATE_DELIVERY TIMESTAMP,
    FLASH INTEGER,
    DEST_PORT INTEGER,
    FIRM_ID VARCHAR(32),
    OPERATOR_ID VARCHAR(32),
    MESSAGE_ID VARCHAR(100),
    SOURCE VARCHAR(100))
AS
DECLARE VARIABLE TM INTEGER;
DECLARE VARIABLE DP INTEGER;
BEGIN

  TM=TYPE_MESSAGE;
  DP=DEST_PORT;

  if (DEST_PORT IS NULL) then
    EXECUTE PROCEDURE GET_TYPE_MESSAGE(:RECIPIENT_ID,TM,CONTACT)
     RETURNING_VALUES TM, DP;

  INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                            TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                            PRIORITY,DATE_BEGIN,DATE_END,ORDER_ID,CHANNEL,
                            DELIVERY,DATE_DELIVERY,FLASH,DEST_PORT,FIRM_ID,OPERATOR_ID,
                            MESSAGE_ID,SOURCE)
       VALUES (:OUT_MESSAGE_ID,:CREATOR_ID,:RECIPIENT_ID,:DATE_CREATE,
               :TEXT_OUT,:DATE_OUT,:TM,:CONTACT,:DESCRIPTION,
               :PRIORITY,:DATE_BEGIN,:DATE_END,:ORDER_ID,:CHANNEL,
               :DELIVERY,:DATE_DELIVERY,:FLASH,:DP,:FIRM_ID,:OPERATOR_ID,
               :MESSAGE_ID,:SOURCE);
END

--

CREATE OR ALTER PROCEDURE I_RECEIPT 
(
    RECEIPT_ID VARCHAR(32),
    RECEIPT_TYPE_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32),
    WHO_CREATE_ID VARCHAR(32),
    SUM_RECEIPT NUMERIC(15,2),
    DATE_RECEIPT TIMESTAMP,
    DATE_CREATE TIMESTAMP,
    DESCRIPTION VARCHAR(250),
    ORDER_ID VARCHAR(32),
    FIRM_ID VARCHAR(32))
AS
DECLARE VARIABLE S VARCHAR(70);
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE ASUM_CHARGE NUMERIC(15,2);
DECLARE VARIABLE ASUM_RECEIPT NUMERIC(15,2);
DECLARE VARIABLE BALANCE NUMERIC(15,2);
DECLARE VARIABLE PHONE VARCHAR(100);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE OUT_MESSAGE_FIRM_ID VARCHAR(32);
BEGIN
  INSERT INTO RECEIPTS (RECEIPT_ID,RECEIPT_TYPE_ID,ACCOUNT_ID,WHO_CREATE_ID,
                        SUM_RECEIPT,DATE_RECEIPT,DATE_CREATE,DESCRIPTION,ORDER_ID,FIRM_ID)
       VALUES (:RECEIPT_ID,:RECEIPT_TYPE_ID,:ACCOUNT_ID,:WHO_CREATE_ID,
               :SUM_RECEIPT,:DATE_RECEIPT,:DATE_CREATE,:DESCRIPTION,:ORDER_ID,:FIRM_ID);

  EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(ACCOUNT_ID)
   RETURNING_VALUES ASUM_CHARGE, ASUM_RECEIPT, BALANCE;

  SELECT PHONE, FIRM_ID
    FROM ACCOUNTS
   WHERE ACCOUNT_ID=:ACCOUNT_ID
    INTO :PHONE, :OUT_MESSAGE_FIRM_ID;

  SELECT COUNT(*)
    FROM CLIENTS
   WHERE CLIENT_ID=:ACCOUNT_ID
    INTO :CNT;

  IF (CNT>0) THEN
    OUT_MESSAGE_FIRM_ID=NULL; /* Не понятно чьё сообщение */

  IF (PHONE IS NOT NULL) THEN BEGIN

    SELECT CONST_VALUE FROM GET_CONST_VALUE('2031AA8F2E4B959248967F2838DC5F19') INTO :S;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(ACCOUNT_ID,NULL,PHONE)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      S=REPLACE_STRING(S,'%BALANCE',CAST(BALANCE AS VARCHAR(30)));

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:WHO_CREATE_ID,:ACCOUNT_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,2,
                                NULL,CURRENT_TIMESTAMP,:DEST_PORT,:OUT_MESSAGE_FIRM_ID);
    END
  END

END

--

CREATE OR ALTER PROCEDURE PR_ALERT_CALL_CLIENT 
(
    SESSION_ID VARCHAR(32),
    ORDER_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32))
AS
DECLARE VARIABLE PHONE VARCHAR(100);
DECLARE VARIABLE DRIVER_ID VARCHAR(32);
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE IN_MESSAGE_ID VARCHAR(32);
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN

  SELECT DRIVER_ID
    FROM ORDERS
   WHERE ORDER_ID=:ORDER_ID
    INTO :DRIVER_ID;

  UPDATE ORDERS
     SET DATE_BEGIN=CURRENT_TIMESTAMP
   WHERE ORDER_ID=:ORDER_ID;

  IF (DRIVER_ID IS NOT NULL) THEN BEGIN

    FOR SELECT IN_MESSAGE_ID, TYPE_MESSAGE
          FROM IN_MESSAGES
         WHERE ORDER_ID=:ORDER_ID
           AND CODE_MESSAGE_ID='5335BFA564BD9F4046823B68D1A238C9' /* Отзвонитесь клиенту */
           AND SENDER_ID=:DRIVER_ID
           AND DESCRIPTION IS NULL
          INTO :IN_MESSAGE_ID, :TYPE_MESSAGE DO BEGIN

      UPDATE IN_MESSAGES
         SET DESCRIPTION=:ORDER_ID
       WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID;

      BREAK;
    END

    SELECT PHONE, FIRM_ID
      FROM ACCOUNTS
     WHERE ACCOUNT_ID=:DRIVER_ID
      INTO :PHONE, :FIRM_ID;

    SELECT CONST_VALUE FROM GET_CONST_VALUE('620D357394B89B18454EB58DD5CE9F19') INTO :S;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,TYPE_MESSAGE,PHONE)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
    END

  END

END

--

CREATE OR ALTER PROCEDURE PR_ANOTHER_DRIVER 
(
    SESSION_ID VARCHAR(32),
    ORDER_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32))
AS
DECLARE VARIABLE PHONE VARCHAR(100);
DECLARE VARIABLE DRIVER_ID VARCHAR(32);
DECLARE VARIABLE PARK_ID VARCHAR(32);
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN

  SELECT DRIVER_ID
    FROM ORDERS
   WHERE ORDER_ID=:ORDER_ID
    INTO :DRIVER_ID;

  PARK_ID=NULL;

  FOR SELECT PARK_ID
        FROM ORDERS
       WHERE PARENT_ID=:ORDER_ID
       ORDER BY DATE_HISTORY
        INTO :PARK_ID DO BEGIN
    BREAK;
  END

  UPDATE ORDERS
     SET TYPE_PROCESS=0,
         DATE_END=CURRENT_TIMESTAMP,
         WHO_PROCESS_ID=:ACCOUNT_ID,
         PARK_ID=:PARK_ID,
         DRIVER_ID=NULL,
         CAR_ID=NULL
   WHERE ORDER_ID=:ORDER_ID;

  IF (DRIVER_ID IS NOT NULL) THEN BEGIN

    SELECT PHONE, FIRM_ID
      FROM ACCOUNTS
     WHERE ACCOUNT_ID=:DRIVER_ID
      INTO :PHONE, :FIRM_ID;

    SELECT CONST_VALUE FROM GET_CONST_VALUE('A82FFC060D399C82436CB3D669239B0B') INTO :S;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL,PHONE)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                0,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
    END

  END

END

--

CREATE OR ALTER PROCEDURE PR_ARRIVAL_DRIVER 
(
    SESSION_ID VARCHAR(32),
    ORDER_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32))
AS
DECLARE VARIABLE PHONE VARCHAR(100);
DECLARE VARIABLE DRIVER_ID VARCHAR(32);
DECLARE VARIABLE CAR_ID VARCHAR(32);
DECLARE VARIABLE PARK_ID VARCHAR(32);
DECLARE VARIABLE PRIORITY INTEGER;
DECLARE VARIABLE PARK_STREET_ID VARCHAR(32);
DECLARE VARIABLE PARK_HOUSE VARCHAR(10);
DECLARE VARIABLE FROM_STREET_ID VARCHAR(32);
DECLARE VARIABLE FROM_HOUSE VARCHAR(10);
DECLARE VARIABLE RECEIPT_TYPE_ID VARCHAR(32);
DECLARE VARIABLE COST_RATE NUMERIC(15,2);
DECLARE VARIABLE COST_CASH NUMERIC(15,2);
DECLARE VARIABLE COLOR VARCHAR(100);
DECLARE VARIABLE BRAND VARCHAR(100);
DECLARE VARIABLE STATE_NUM VARCHAR(50);
DECLARE VARIABLE PREFIX VARCHAR(10);
DECLARE VARIABLE STREET VARCHAR(100);
DECLARE VARIABLE HOUSE VARCHAR(10);
DECLARE VARIABLE FLAT VARCHAR(10);
DECLARE VARIABLE PORCH VARCHAR(10);
DECLARE VARIABLE LOCALITY VARCHAR(100);
DECLARE VARIABLE CLIENT_ID VARCHAR(32);
DECLARE VARIABLE CALC_ID VARCHAR(32);
DECLARE VARIABLE SUM_CHARGE NUMERIC(15,2);
DECLARE VARIABLE SUM_RECEIPT NUMERIC(15,2);
DECLARE VARIABLE BALANCE NUMERIC(15,2);
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE S1 VARCHAR(1000);
DECLARE VARIABLE ADDRESS VARCHAR(1000);
DECLARE VARIABLE NUM INTEGER;
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE FLAG INTEGER;
DECLARE VARIABLE D TIMESTAMP;
DECLARE VARIABLE ROUTE_DISTANCE DOUBLE PRECISION;
DECLARE VARIABLE DISTANCE NUMERIC(15,2);
DECLARE VARIABLE CLIENT_TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DRIVER_TYPE_MESSAGE INTEGER;
DECLARE VARIABLE IN_MESSAGE_ID VARCHAR(32);
DECLARE VARIABLE CLIENT_DEST_PORT INTEGER;
DECLARE VARIABLE DRIVER_DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
DECLARE VARIABLE DRIVER_FIRM_ID VARCHAR(32);
BEGIN

  SELECT O.PHONE, O.DRIVER_ID, O.PARK_ID, O.FIRM_ID,
         O.STREET_ID, O.HOUSE,
         O.COST_RATE, O.CLIENT_ID,
         C.COLOR, C.BRAND, C.STATE_NUM
    FROM ORDERS O
    LEFT JOIN DRIVERS D ON D.DRIVER_ID=O.DRIVER_ID
    LEFT JOIN CARS C ON C.CAR_ID=D.CAR_ID
   WHERE ORDER_ID=:ORDER_ID
    INTO :PHONE, :DRIVER_ID, :PARK_ID, :FIRM_ID,
         :FROM_STREET_ID, :FROM_HOUSE,
         :COST_RATE, :CLIENT_ID,
         :COLOR, :BRAND, :STATE_NUM;

  UPDATE ORDERS
     SET DATE_BEGIN=CURRENT_TIMESTAMP
   WHERE ORDER_ID=:ORDER_ID;

  CALC_ID=NULL;

  IF (CLIENT_ID IS NOT NULL) THEN BEGIN

    SELECT CALC_ID
      FROM CLIENTS
     WHERE CLIENT_ID=:CLIENT_ID
      INTO :CALC_ID;

  END

  BALANCE=NULL;

  IF (CALC_ID IS NOT NULL) THEN BEGIN

    EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:CLIENT_ID)
     RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

  END

  FLAG=0;

  FOR SELECT STREET_ID, HOUSE
        FROM ROUTES
       WHERE ORDER_ID=:ORDER_ID
       ORDER BY PRIORITY
        INTO :STREET, :HOUSE DO BEGIN

    IF ((STREET IS NOT NULL) AND (HOUSE IS NOT NULL)) THEN BEGIN

    END ELSE BEGIN

      FLAG=1;

    END
  END

  COST_CASH=NULL;

  IF ((COST_RATE>0.0) AND (FLAG=0)) THEN BEGIN

    IF (BALANCE IS NOT NULL) THEN BEGIN

      IF (BALANCE>=COST_RATE) THEN
        COST_CASH=0.0;
      ELSE
        COST_CASH=COST_RATE-BALANCE;

    END

  END

/*  IF (SUBSTR(PHONE,1,3)='+79')  THEN BEGIN */

  IF (PHONE IS NOT NULL)  THEN BEGIN

    IF ((COST_RATE>0.0) AND (FLAG=0)) THEN BEGIN

      IF (COST_CASH IS NULL) THEN

        SELECT CONST_VALUE FROM GET_CONST_VALUE('8D9E6C9F4852AD8142205F027B2A5288') INTO :S;

      ELSE

        SELECT CONST_VALUE FROM GET_CONST_VALUE('9CA9F2761D2BBE974791906824C3C31A') INTO :S;

    END ELSE BEGIN

      SELECT CONST_VALUE FROM GET_CONST_VALUE('93EBB0171E37A0884313759C0DA1EB3D') INTO :S;

    END

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(CLIENT_ID,NULL,PHONE)
     RETURNING_VALUES CLIENT_TYPE_MESSAGE, CLIENT_DEST_PORT;

    IF ((S IS NOT NULL) AND (CLIENT_TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      S=REPLACE_STRING(S,'%COLOR',COLOR);
      S=REPLACE_STRING(S,'%BRAND',BRAND);
      S=REPLACE_STRING(S,'%STATE_NUM',STATE_NUM);
      S=REPLACE_STRING(S,'%COST_RATE',CAST(CAST(COST_RATE AS NUMERIC(15,0)) AS VARCHAR(30)));
      S=REPLACE_STRING(S,'%COST_CASH',CAST(CAST(COST_CASH AS NUMERIC(15,0)) AS VARCHAR(30)));

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:CLIENT_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:CLIENT_TYPE_MESSAGE,:PHONE,NULL,
                                0,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:CLIENT_DEST_PORT,:FIRM_ID);

    END

    SELECT CONST_VALUE FROM GET_CONST_VALUE('F4384929079999BB47A895BFCA5BB382') INTO :S;

    IF ((S IS NOT NULL) AND (CLIENT_TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:CLIENT_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:CLIENT_TYPE_MESSAGE,:PHONE,NULL,
                                0,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:CLIENT_DEST_PORT,:FIRM_ID);

    END

  END

  IF (DRIVER_ID IS NOT NULL) THEN BEGIN

    FOR SELECT IN_MESSAGE_ID, TYPE_MESSAGE
          FROM IN_MESSAGES
         WHERE ORDER_ID=:ORDER_ID
           AND CODE_MESSAGE_ID='618A0B399123BEEA474944099929C541' /* Водитель прибыл */
           AND SENDER_ID=:DRIVER_ID
           AND DESCRIPTION IS NULL
          INTO :IN_MESSAGE_ID, :DRIVER_TYPE_MESSAGE DO BEGIN

      UPDATE IN_MESSAGES
         SET DESCRIPTION=:ORDER_ID
       WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID;

      BREAK;
    END

    SELECT PHONE, FIRM_ID
      FROM ACCOUNTS
     WHERE ACCOUNT_ID=:DRIVER_ID
      INTO :PHONE, :DRIVER_FIRM_ID;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,DRIVER_TYPE_MESSAGE,PHONE)
     RETURNING_VALUES DRIVER_TYPE_MESSAGE, DRIVER_DEST_PORT;

    FLAG=0;
    NUM=0;

    SELECT COUNT(*)
      FROM ROUTES
     WHERE ORDER_ID=:ORDER_ID
      INTO :CNT;

    D=CURRENT_TIMESTAMP;

    FOR SELECT S.PREFIX, S.NAME, R.HOUSE, R.FLAT, R.PORCH, L.NAME
          FROM ROUTES R
          LEFT JOIN STREETS S ON S.STREET_ID=R.STREET_ID
          LEFT JOIN LOCALITIES L ON L.LOCALITY_ID=S.LOCALITY_ID
         WHERE R.ORDER_ID=:ORDER_ID
         ORDER BY R.PRIORITY
          INTO :PREFIX, :STREET, :HOUSE, :FLAT, :PORCH, :LOCALITY DO BEGIN

      ADDRESS='';
      S=NULL;

      IF ((STREET IS NOT NULL) AND (HOUSE IS NOT NULL)) THEN BEGIN

        IF (PREFIX IS NOT NULL) THEN
          ADDRESS=PREFIX||' ';

        IF (STREET IS NOT NULL) THEN
          ADDRESS=ADDRESS||STREET;

        IF (HOUSE IS NOT NULL) THEN
          ADDRESS=ADDRESS||' '||HOUSE;

        IF (FLAT IS NOT NULL) THEN
          ADDRESS=ADDRESS||'-'||FLAT;

        IF (PORCH IS NOT NULL) THEN
          ADDRESS=ADDRESS||' п.'||PORCH;

        IF ((LOCALITY IS NOT NULL) AND (LOCALITY<>'Красноярск')) THEN
          ADDRESS=ADDRESS||', '||LOCALITY;

        SELECT CONST_VALUE FROM GET_CONST_VALUE('92009DB6C3EAA9E74B80D333538FE40D') INTO :S;

      END ELSE BEGIN

        FLAG=1;

        SELECT CONST_VALUE FROM GET_CONST_VALUE('7ED5E8A8BBD9870A411517B54D9EB973') INTO :S;

      END

      IF (S IS NOT NULL) THEN BEGIN

        NUM=NUM+1;

        S=REPLACE_STRING(S,'%NUM',NUM);
        S=REPLACE_STRING(S,'%COUNT',CNT);
        S=REPLACE_STRING(S,'%ADDRESS',ADDRESS);

        IF (NUM=CNT) THEN BEGIN

          IF ((FLAG=0) AND (COST_RATE>0.0)) THEN BEGIN

            IF (COST_CASH IS NULL) THEN

              SELECT CONST_VALUE FROM GET_CONST_VALUE('9C8BC7D14DAEAE5C4DC8C1C91B20BCC2') INTO :S1;

            ELSE

              SELECT CONST_VALUE FROM GET_CONST_VALUE('A468782967A1A4D347F85F33D39E348A') INTO :S1;

          END ELSE

            SELECT CONST_VALUE FROM GET_CONST_VALUE('D3F68032AD999D004140A480A8AAF749') INTO :S1;

        END ELSE

          S1=S;


        IF ((S1 IS NOT NULL) AND (DRIVER_TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

          S1=REPLACE_STRING(S1,'%ADDRESS',S);
          S1=REPLACE_STRING(S1,'%COST_RATE',CAST(CAST(COST_RATE AS NUMERIC(15,0)) AS VARCHAR(30)));
          S1=REPLACE_STRING(S1,'%COST_CASH',CAST(CAST(COST_CASH AS NUMERIC(15,0)) AS VARCHAR(30)));

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                    PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                    :S1,NULL,:DRIVER_TYPE_MESSAGE,:PHONE,NULL,
                                    2,NULL,:D,:ORDER_ID,:DRIVER_DEST_PORT,:DRIVER_FIRM_ID);

          D=D+1*(1e0/24/60/60);

        END

      END

    END

    /* need check */
    SELECT d.priority, d.car_id
      FROM drivers d
     WHERE d.driver_id = :DRIVER_ID
      INTO :PRIORITY, :CAR_ID;

    IF ((PARK_ID IS NOT NULL) AND ((PRIORITY<>-1)
    and (:CAR_ID not in (select car_id from car_in_types where car_type_id = '2FC1A2E9B900A144441F4B342A432950'))))  THEN BEGIN

      SELECT STREET_ID, HOUSE
        FROM PARKS
       WHERE PARK_ID=:PARK_ID
        INTO :PARK_STREET_ID, :PARK_HOUSE;

      IF ((PARK_STREET_ID IS NOT NULL) AND (PARK_HOUSE IS NOT NULL)) THEN BEGIN

        IF ((FROM_STREET_ID IS NOT NULL) AND (FROM_HOUSE IS NOT NULL)) THEN BEGIN

          EXECUTE PROCEDURE GET_ROUTE_DISTANCE(PARK_STREET_ID,PARK_HOUSE,FROM_STREET_ID,FROM_HOUSE)
             RETURNING_VALUES ROUTE_DISTANCE;

          IF (ROUTE_DISTANCE>0.0) THEN BEGIN

            IF (DISTANCE>4.0) THEN BEGIN

              DISTANCE=DISTANCE-4.0;

              RECEIPT_TYPE_ID='2448E302595392064D9DF67BDD05C7DB'; /* Компенсация за прогон */

              SUM_RECEIPT=DISTANCE*3.0;

              INSERT INTO RECEIPTS (RECEIPT_ID,RECEIPT_TYPE_ID,ACCOUNT_ID,WHO_CREATE_ID,
                                    SUM_RECEIPT,DATE_RECEIPT,DATE_CREATE,DESCRIPTION,ORDER_ID,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:RECEIPT_TYPE_ID,:DRIVER_ID,:ACCOUNT_ID,
                                    :SUM_RECEIPT,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,NULL,:ORDER_ID,:FIRM_ID);

              SELECT CONST_VALUE FROM GET_CONST_VALUE('6905163E6105BE12488DAF7AAFA32810') INTO :S;

              IF ((S IS NOT NULL) AND (DRIVER_TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

                S=REPLACE_STRING(S,'%DISTANCE',CAST(DISTANCE AS VARCHAR(30)));
                S=REPLACE_STRING(S,'%SUM_RECEIPT',CAST(SUM_RECEIPT AS VARCHAR(30)));

                INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                          TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                          PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                                  VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                          :S,NULL,:DRIVER_TYPE_MESSAGE,:PHONE,NULL,
                                          2,NULL,:D,:ORDER_ID,:DRIVER_DEST_PORT,:DRIVER_FIRM_ID);


              END

            END

          END

        END

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE PR_CHANGE_ROUTE 
(
    SESSION_ID VARCHAR(32),
    ORDER_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32))
AS
DECLARE VARIABLE PHONE VARCHAR(100);
DECLARE VARIABLE DRIVER_ID VARCHAR(32);
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE IN_MESSAGE_ID VARCHAR(32);
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN

  SELECT DRIVER_ID
    FROM ORDERS
   WHERE ORDER_ID=:ORDER_ID
    INTO :DRIVER_ID;

  UPDATE ORDERS
     SET TYPE_PROCESS=1,
         DATE_END=CURRENT_TIMESTAMP,
         WHO_PROCESS_ID=:ACCOUNT_ID
   WHERE ORDER_ID=:ORDER_ID;

  IF (DRIVER_ID IS NOT NULL) THEN BEGIN

    FOR SELECT IN_MESSAGE_ID, TYPE_MESSAGE
          FROM IN_MESSAGES
         WHERE ORDER_ID=:ORDER_ID
           AND CODE_MESSAGE_ID='F42D57842950B923481A9B2D02B925CB' /* Клиент хочет сменить маршрут */
           AND SENDER_ID=:DRIVER_ID
           AND DESCRIPTION IS NULL
          INTO :IN_MESSAGE_ID, :TYPE_MESSAGE DO BEGIN

      UPDATE IN_MESSAGES
         SET DESCRIPTION=:ORDER_ID
       WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID;

      BREAK;
    END

    SELECT PHONE, FIRM_ID
      FROM ACCOUNTS
     WHERE ACCOUNT_ID=:DRIVER_ID
      INTO :PHONE, :FIRM_ID;

    SELECT CONST_VALUE FROM GET_CONST_VALUE('2A7354AFB1FDB1D041F8FB2D06FFBC70') INTO :S;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,TYPE_MESSAGE,PHONE)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
    END

  END

END

--

CREATE OR ALTER PROCEDURE PR_CLIENT_IN_CAR 
(
    SESSION_ID VARCHAR(32),
    ORDER_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32))
AS
DECLARE VARIABLE PHONE VARCHAR(100);
DECLARE VARIABLE DRIVER_ID VARCHAR(32);
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE IN_MESSAGE_ID VARCHAR(32);
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN

  SELECT DRIVER_ID
    FROM ORDERS
   WHERE ORDER_ID=:ORDER_ID
    INTO :DRIVER_ID;

  UPDATE ORDERS
     SET DATE_BEGIN=CURRENT_TIMESTAMP
   WHERE ORDER_ID=:ORDER_ID;

  IF (DRIVER_ID IS NOT NULL) THEN BEGIN

    FOR SELECT IN_MESSAGE_ID, TYPE_MESSAGE
          FROM IN_MESSAGES
         WHERE ORDER_ID=:ORDER_ID
           AND CODE_MESSAGE_ID='3FD0D3ABD5E0B697483FF8520EDDBD6D' /* Клиент сел в машину */
           AND SENDER_ID=:DRIVER_ID
           AND DESCRIPTION IS NULL
          INTO :IN_MESSAGE_ID, :TYPE_MESSAGE DO BEGIN

      UPDATE IN_MESSAGES
         SET DESCRIPTION=:ORDER_ID
       WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID;

      BREAK;
    END

    SELECT PHONE, FIRM_ID
      FROM ACCOUNTS
     WHERE ACCOUNT_ID=:DRIVER_ID
      INTO :PHONE, :FIRM_ID;

    SELECT CONST_VALUE FROM GET_CONST_VALUE('620D357394B89B18454EB58DD5CE9F19') INTO :S;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,TYPE_MESSAGE,PHONE)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
    END

  END

END

--

CREATE OR ALTER PROCEDURE TRY_PARK_IN 
(
    SESSION_ID VARCHAR(32),
    ORDER_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32),
    DRIVER_ID VARCHAR(32),
    CODE VARCHAR(100),
    TYPE_MESSAGE INTEGER)
AS
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE PHONE VARCHAR(100);
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE SUM_CHARGE NUMERIC(15,2);
DECLARE VARIABLE SUM_RECEIPT NUMERIC(15,2);
DECLARE VARIABLE BALANCE NUMERIC(15,2);
DECLARE VARIABLE MIN_BALANCE NUMERIC(15,2);
DECLARE VARIABLE D TIMESTAMP;
DECLARE VARIABLE PARK_ID VARCHAR(32);
DECLARE VARIABLE PARK_NAME VARCHAR(100);
DECLARE VARIABLE PARK_DESCRIPTION VARCHAR(250);
DECLARE VARIABLE PRIORITY INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
DECLARE VARIABLE PARK_ID_TEMP VARCHAR(32);
DECLARE VARIABLE DRIVER_PRIORITY INTEGER;
BEGIN

  IF ((DRIVER_ID IS NOT NULL) AND (CODE IS NOT NULL)) THEN BEGIN

    SELECT A.PHONE, A.FIRM_ID, D.PRIORITY
      FROM DRIVERS D
      JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
     WHERE D.DRIVER_ID=:DRIVER_ID
       AND A.LOCKED<>1
      INTO :PHONE, :FIRM_ID, :DRIVER_PRIORITY;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,TYPE_MESSAGE,PHONE)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    IF (PHONE IS NOT NULL) THEN BEGIN

      EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:DRIVER_ID)
       RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

      SELECT MIN_BALANCE
        FROM DRIVERS
       WHERE DRIVER_ID=:DRIVER_ID
        INTO :MIN_BALANCE;

      IF ((MIN_BALANCE IS NULL) OR ((MIN_BALANCE IS NOT NULL) AND (BALANCE>MIN_BALANCE))) THEN BEGIN

        SELECT COUNT(*)
          FROM ORDERS
         WHERE DRIVER_ID=:DRIVER_ID
           AND PARENT_ID IS NULL
           AND DATE_HISTORY IS NULL
           AND FINISHED<>1
          INTO :CNT;

        IF (CNT>0) THEN BEGIN

          SELECT CONST_VALUE FROM GET_CONST_VALUE('764B2BA8498AB18345852AA2FE39F4D9') INTO :S;

          IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

            INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                      TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                      PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                              VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                      :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                      2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
          END

        END ELSE BEGIN

          /* select first 1 park_id from park_states where driver_id=:driver_id and date_out is null order by date_out desc into :PARK_ID_TEMP; */

          UPDATE PARK_STATES
             SET DATE_OUT=CURRENT_TIMESTAMP
           WHERE DRIVER_ID=:DRIVER_ID
             AND DATE_OUT IS NULL;

          EXECUTE PROCEDURE event_refresh_park_states('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

          SELECT COUNT(*)
            FROM SHIFTS
           WHERE ACCOUNT_ID=:DRIVER_ID
             AND DATE_END IS NULL
            INTO :CNT;

          D=CURRENT_TIMESTAMP;

          IF (CNT=0) THEN BEGIN

            INSERT INTO SHIFTS (SHIFT_ID,ACCOUNT_ID,DATE_BEGIN,DATE_END)
                        VALUES (GET_UNIQUE_ID(),:DRIVER_ID,:D,NULL);

            EXECUTE PROCEDURE event_refresh_shifts('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

          END

          PARK_ID=NULL;
          PARK_NAME=NULL;

          FOR SELECT P.PARK_ID, P.NAME, P.DESCRIPTION
                FROM PARKS P
               WHERE (((P.MAX_COUNT IS NOT NULL) AND
                       (P.MAX_COUNT> (SELECT COUNT(*)
                                        FROM PARK_STATES
                                       WHERE DATE_OUT IS NULL
                                         AND PARK_ID=P.PARK_ID)))
                       OR (P.MAX_COUNT IS NULL))
                 AND P.NAME=:CODE
                INTO :PARK_ID, :PARK_NAME, :PARK_DESCRIPTION  DO BEGIN
            BREAK;
          END

          IF (PARK_ID IS NOT NULL) THEN BEGIN

            INSERT INTO PARK_STATES (PARK_STATE_ID,PARK_ID,DRIVER_ID,DATE_IN,DATE_OUT)
                             VALUES (GET_UNIQUE_ID(),:PARK_ID,:DRIVER_ID,:D,NULL);

            SELECT COUNT(*)
              FROM PARK_STATES PAS
              JOIN DRIVERS DRS ON DRS.DRIVER_ID = PAS.DRIVER_ID
              JOIN CAR_IN_TYPES CIT ON CIT.CAR_ID = DRS.CAR_ID
             WHERE PAS.PARK_ID=:PARK_ID
               AND PAS.DATE_OUT IS NULL
               AND DRS.PRIORITY <= :DRIVER_PRIORITY
               AND CIT.CAR_TYPE_ID != '2FC1A2E9B900A144441F4B342A432950'
              INTO PRIORITY;

            SELECT CONST_VALUE FROM GET_CONST_VALUE('80627FCA459EA3574F6BA8730F32946F') INTO :S;

            IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

              S=REPLACE_STRING(S,'%PRIORITY',CAST(PRIORITY AS VARCHAR(10)));
              S=REPLACE_STRING(S,'%PARK_NAME',PARK_NAME);
              S=REPLACE_STRING(S,'%PARK_DESCRIPTION',PARK_DESCRIPTION);
              S=REPLACE_STRING(S,'%BALANCE',CAST(BALANCE AS VARCHAR(30)));

              INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                        TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                        PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                                VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                        :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                        1,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
            END

          END ELSE BEGIN

            /* INSERT INTO PARK_STATES (PARK_STATE_ID,PARK_ID,DRIVER_ID,DATE_IN,DATE_OUT)
                             VALUES (GET_UNIQUE_ID(),:PARK_ID_TEMP,:DRIVER_ID,CURRENT_TIMESTAMP,NULL); */

            SELECT CONST_VALUE FROM GET_CONST_VALUE('18B1E217D3789DDF4BCE1EEE9C7AB7A5') INTO :S;

            IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

              INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                        TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                        PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                                VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                        :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                        1,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
            END

          END

        END

      END ELSE BEGIN

        SELECT CONST_VALUE FROM GET_CONST_VALUE('0690BD9649C89DD8472558C3270F35D6') INTO :S;

        IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                    PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                    :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                    1,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
        END

      END

    END

  END
END

--

CREATE OR ALTER PROCEDURE QUERY_PARK_STATES 
(
    ORDER_ID VARCHAR(32),
    CREATOR_ID VARCHAR(32),
    RECIPIENT_ID VARCHAR(32),
    CONTACT VARCHAR(100),
    TYPE_MESSAGE INTEGER)
AS
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE F VARCHAR(1000);
DECLARE VARIABLE S1 VARCHAR(1000);
DECLARE VARIABLE PARK_NAME VARCHAR(100);
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN
  IF ((CREATOR_ID IS NOT NULL) AND (CONTACT IS NOT NULL)) THEN BEGIN

    S='';

    SELECT CONST_VALUE FROM GET_CONST_VALUE('A3D890F68FF0BDCC4B42C3135174ABEF') INTO :F;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(RECIPIENT_ID,TYPE_MESSAGE,CONTACT)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    IF ((F IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      FOR SELECT P.NAME,
                 (SELECT COUNT(*)
                    FROM PARK_STATES PS
                   WHERE PS.DATE_OUT IS NULL
                     AND PS.PARK_ID=P.PARK_ID)
            FROM PARKS P
           ORDER BY P.PRIORITY
            INTO :PARK_NAME, :CNT DO BEGIN

        S1=F;
        S1=REPLACE_STRING(S1,'%PARK_NAME',:PARK_NAME);
        S1=REPLACE_STRING(S1,'%COUNT',CAST(CNT AS VARCHAR(10)));
        S=S||S1;

      END

      SELECT FIRM_ID
        FROM ACCOUNTS
       WHERE ACCOUNT_ID=:RECIPIENT_ID
        INTO :FIRM_ID;

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:CREATOR_ID,:RECIPIENT_ID,CURRENT_TIMESTAMP,
                               :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,
                               1,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
    END

  END

END

--

CREATE OR ALTER PROCEDURE PR_FULL_CALC 
(
    SESSION_ID VARCHAR(32),
    ORDER_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32))
AS
DECLARE VARIABLE COST_RATE NUMERIC(15,2);
DECLARE VARIABLE COST_FACT NUMERIC(15,2);
DECLARE VARIABLE NON_CASH NUMERIC(15,2);
DECLARE VARIABLE PARENT_SUM NUMERIC(15,2);
DECLARE VARIABLE PHONE VARCHAR(100);
DECLARE VARIABLE DRIVER_PHONE VARCHAR(100);
DECLARE VARIABLE PASSW VARCHAR(100);
DECLARE VARIABLE DRIVER_ID VARCHAR(32);
DECLARE VARIABLE SUM_CHARGE NUMERIC(15,2);
DECLARE VARIABLE SUM_RECEIPT NUMERIC(15,2);
DECLARE VARIABLE BALANCE NUMERIC(15,2);
DECLARE VARIABLE MIN_BALANCE NUMERIC(15,2);
DECLARE VARIABLE CHARGE_TYPE_ID VARCHAR(32);
DECLARE VARIABLE RECEIPT_TYPE_ID VARCHAR(32);
DECLARE VARIABLE CLIENT_ID VARCHAR(32);
DECLARE VARIABLE PARENT_ID VARCHAR(32);
DECLARE VARIABLE CALC_ID VARCHAR(32);
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE CODE VARCHAR(100);
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE DESCRIPTION VARCHAR(250);
DECLARE VARIABLE USER_NAME VARCHAR(100);
DECLARE VARIABLE CLIENT_TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DRIVER_TYPE_MESSAGE INTEGER;
DECLARE VARIABLE CLIENT_DEST_PORT INTEGER;
DECLARE VARIABLE DRIVER_DEST_PORT INTEGER;
DECLARE VARIABLE IN_MESSAGE_ID VARCHAR(32);
DECLARE VARIABLE FIRM_ID VARCHAR(32);
DECLARE VARIABLE DRIVER_FIRM_ID VARCHAR(32);
DECLARE VARIABLE CLI VARCHAR(32);
DECLARE VARIABLE IS_CODE_PARK SMALLINT;
BEGIN

  DRIVER_FIRM_ID=NULL;
  IS_CODE_PARK = 0;

  SELECT PHONE, DRIVER_ID, COST_RATE, COST_FACT, CLIENT_ID, FIRM_ID
    FROM ORDERS
   WHERE ORDER_ID=:ORDER_ID
    INTO :PHONE, :DRIVER_ID, :COST_RATE, :COST_FACT, :CLIENT_ID, :FIRM_ID;

  IF (DRIVER_ID IS NOT NULL) THEN BEGIN

    SELECT FIRM_ID
      FROM ACCOUNTS
     WHERE ACCOUNT_ID=:DRIVER_ID
      INTO :DRIVER_FIRM_ID;

    FOR SELECT IN_MESSAGE_ID, TYPE_MESSAGE
          FROM IN_MESSAGES
         WHERE ORDER_ID=:ORDER_ID
           AND CODE_MESSAGE_ID='0388BCC17DE1A1754B566F18AEEED771' /* Клиент рассчитался полностью */
           AND SENDER_ID=:DRIVER_ID
           AND DESCRIPTION IS NULL
          INTO :IN_MESSAGE_ID, :DRIVER_TYPE_MESSAGE DO BEGIN

      UPDATE IN_MESSAGES
         SET DESCRIPTION=:ORDER_ID
       WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID;

      BREAK;
    END

  END

  IF ((COST_FACT IS NULL) OR (COST_FACT<=0.0))  THEN
    COST_FACT=:COST_RATE;

  IF (COST_FACT<=0.0) THEN BEGIN

    IF (DRIVER_ID IS NOT NULL) THEN BEGIN

      SELECT CONST_VALUE FROM GET_CONST_VALUE('4BB5C780923E872D436DA3DA31C9E0B0') INTO :S;

      SELECT PHONE
        FROM ACCOUNTS
       WHERE ACCOUNT_ID=:DRIVER_ID
        INTO :DRIVER_PHONE;

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,DRIVER_TYPE_MESSAGE,DRIVER_PHONE)
       RETURNING_VALUES DRIVER_TYPE_MESSAGE, DRIVER_DEST_PORT;

      IF ((S IS NOT NULL) AND (DRIVER_TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                  PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID, message_id, source)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                  :S,NULL,:DRIVER_TYPE_MESSAGE,:DRIVER_PHONE,NULL,
                                  2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DRIVER_DEST_PORT,:DRIVER_FIRM_ID, null, null);
      END

    END

    EXECUTE PROCEDURE PR_MANUAL(SESSION_ID,ORDER_ID,ACCOUNT_ID);

  END ELSE BEGIN

    UPDATE ORDERS
       SET FINISHED=1,
           DATE_END=CURRENT_TIMESTAMP,
           WHO_PROCESS_ID=:ACCOUNT_ID,
           COST_FACT=:COST_FACT
     WHERE ORDER_ID=:ORDER_ID;

    EXECUTE PROCEDURE CREATE_ROUTE_HISTORY(ORDER_ID);

    IF (DRIVER_ID IS NOT NULL) THEN BEGIN

      CALC_ID=NULL;

      IF (CLIENT_ID IS NOT NULL) THEN BEGIN

        SELECT C.CALC_ID, A.USER_NAME
          FROM CLIENTS C
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=C.CLIENT_ID
         WHERE CLIENT_ID=:CLIENT_ID
          INTO :CALC_ID, :USER_NAME;

        SELECT COUNT(*)
          FROM CLIENT_CHILDS
         WHERE CHILD_ID=:CLIENT_ID
          INTO :CNT;

        IF (CNT>0) THEN BEGIN

          PARENT_SUM=2.0;

          IF ((COST_FACT>150.0) AND (COST_FACT<=250.0)) THEN
            PARENT_SUM=5.0;

          IF ((COST_FACT>250.0) AND (COST_FACT<=350.0)) THEN
            PARENT_SUM=10.0;

          IF (COST_FACT>350.0) THEN
            PARENT_SUM=20.0;

          SUM_RECEIPT=PARENT_SUM/CNT;

          FOR SELECT CLIENT_ID
                FROM CLIENT_CHILDS

               WHERE CHILD_ID=:CLIENT_ID
                INTO :PARENT_ID DO BEGIN

           RECEIPT_TYPE_ID='9958D6ED64ADAAB94AEF470DA7B5F4F7'; /* Поездка дочернего клиента */

           DESCRIPTION=USER_NAME;

           INSERT INTO RECEIPTS (RECEIPT_ID,RECEIPT_TYPE_ID,ACCOUNT_ID,WHO_CREATE_ID,
                                 SUM_RECEIPT,DATE_RECEIPT,DATE_CREATE,DESCRIPTION,ORDER_ID,FIRM_ID)
                         VALUES (GET_UNIQUE_ID(),:RECEIPT_TYPE_ID,:PARENT_ID,:ACCOUNT_ID,
                                :SUM_RECEIPT,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,:DESCRIPTION,:ORDER_ID,:DRIVER_FIRM_ID);

          END
        END

      END

      BALANCE=NULL;

      IF (CALC_ID IS NOT NULL) THEN BEGIN

        EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:CLIENT_ID)
         RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

      END

      NON_CASH=NULL;

      IF ((BALANCE IS NOT NULL) AND (BALANCE<>0.0)) THEN BEGIN

        IF (BALANCE>=COST_FACT) THEN BEGIN
          NON_CASH=COST_FACT;
          BALANCE=BALANCE-NON_CASH;
        END ELSE BEGIN
          NON_CASH=BALANCE;
          BALANCE=0.0;
        END

      END

      IF (NON_CASH IS NOT NULL) THEN BEGIN

        CHARGE_TYPE_ID='757B9CAF2D3CA5144A7E2A23472990E5'; /* Поездка */

        SUM_CHARGE=NON_CASH;

        INSERT INTO CHARGES (CHARGE_ID,WHO_CREATE_ID,CHARGE_TYPE_ID,ACCOUNT_ID,
                             SUM_CHARGE,DATE_CHARGE,DATE_CREATE,DESCRIPTION,ORDER_ID,FIRM_ID)
                     VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:CHARGE_TYPE_ID,:CLIENT_ID,
                             :SUM_CHARGE,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,NULL,:ORDER_ID,:DRIVER_FIRM_ID);


      END

     /* IF (SUBSTR(PHONE,1,3)='+79')  THEN BEGIN */
      IF (PHONE IS NOT NULL)  THEN BEGIN

        IF (NON_CASH IS NOT NULL) THEN BEGIN

          SELECT CONST_VALUE FROM GET_CONST_VALUE('56140344A440BE774C9007D49CD574E9') INTO :S;

        END ELSE BEGIN

          SELECT CONST_VALUE FROM GET_CONST_VALUE('05B75340B170BF5141FC63F5CDF7FCD6') INTO :S;

        END

        EXECUTE PROCEDURE GET_TYPE_MESSAGE(CLIENT_ID,NULL,PHONE)
         RETURNING_VALUES CLIENT_TYPE_MESSAGE, CLIENT_DEST_PORT;

        IF ((S IS NOT NULL) AND (CLIENT_TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

          S=REPLACE_STRING(S,'%BALANCE',CAST(CAST(BALANCE AS NUMERIC(15,0)) AS VARCHAR(30)));

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                    PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:CLIENT_ID,CURRENT_TIMESTAMP,
                                    :S,NULL,:CLIENT_TYPE_MESSAGE,:PHONE,NULL,
                                    2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:CLIENT_DEST_PORT,:FIRM_ID);
        END

        /*  need check */
        SELECT CONST_VALUE FROM GET_CONST_VALUE('E9FFA9589ABD8C174474572B72017BCC') INTO :S; /* РЕГИСТРИРУЙТЕСЬ на: ataxi24.ru */
        SELECT FIRST 1 "PASSWORD" FROM accounts where PHONE = :PHONE INTO :PASSW;

        IF ((S IS NOT NULL) AND (CLIENT_TYPE_MESSAGE IS NOT NULL) AND (PASSW IS NULL)) THEN BEGIN

          /* если нет логина - отпр смс с адресом */
          SELECT CLIENT_ID FROM GET_CLIENT_BY_PHONE(:PHONE) into :cli;
          IF (CLI IS NULL) THEN 
          BEGIN
            SELECT CONST_VALUE FROM GET_CONST_VALUE('+7B36886B6DA3A22E447F67594942BEBA') INTO :S;
                IF (S IS NOT NULL) THEN
                    BEGIN
                      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:CLIENT_ID,CURRENT_TIMESTAMP,
                                                :S,NULL,:CLIENT_TYPE_MESSAGE,:PHONE,NULL,
                                                2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:CLIENT_DEST_PORT,:FIRM_ID);
                    END
          END
        END

      END

      CHARGE_TYPE_ID='E1BC9789DA9DB2B041C0784EBE92BFC9'; /* Выполнение заказа */

      SELECT RET_SUM
        FROM GET_DRIVER_SUM(:DRIVER_ID,:COST_FACT)
        INTO :SUM_CHARGE;

        INSERT INTO CHARGES (CHARGE_ID,WHO_CREATE_ID,CHARGE_TYPE_ID,ACCOUNT_ID,
                             SUM_CHARGE,DATE_CHARGE,DATE_CREATE,DESCRIPTION,ORDER_ID,FIRM_ID)
                     VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:CHARGE_TYPE_ID,:DRIVER_ID,
                             :SUM_CHARGE,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,NULL,:ORDER_ID,:FIRM_ID);

      IF (NON_CASH IS NOT NULL) THEN BEGIN

        RECEIPT_TYPE_ID='3F91C48D888F81974941D256C0815B03'; /* Компенсация за поездку */

        SUM_RECEIPT=NON_CASH;

        INSERT INTO RECEIPTS (RECEIPT_ID,RECEIPT_TYPE_ID,ACCOUNT_ID,WHO_CREATE_ID,
                              SUM_RECEIPT,DATE_RECEIPT,DATE_CREATE,DESCRIPTION,ORDER_ID,FIRM_ID)
                      VALUES (GET_UNIQUE_ID(),:RECEIPT_TYPE_ID,:DRIVER_ID,:ACCOUNT_ID,
                              :SUM_RECEIPT,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,NULL,:ORDER_ID,:DRIVER_FIRM_ID);

      END

      EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:DRIVER_ID)
       RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

      SELECT MIN_BALANCE
        FROM DRIVERS
       WHERE DRIVER_ID=:DRIVER_ID
        INTO :MIN_BALANCE;

      IF ((MIN_BALANCE IS NULL) OR ((MIN_BALANCE IS NOT NULL) AND (BALANCE>MIN_BALANCE))) THEN BEGIN

        SELECT CONST_VALUE FROM GET_CONST_VALUE('16835607B30CA79F4CE883B53AFE972D') INTO :S;

      END ELSE BEGIN

        UPDATE SHIFTS
           SET DATE_END=CURRENT_TIMESTAMP
         WHERE ACCOUNT_ID=:DRIVER_ID
           AND DATE_END IS NULL;

        SELECT CONST_VALUE FROM GET_CONST_VALUE('634880F305E9AA434245E3E596697001') INTO :S;

      END

      SELECT PHONE
        FROM ACCOUNTS
       WHERE ACCOUNT_ID=:DRIVER_ID
        INTO :DRIVER_PHONE;

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,DRIVER_TYPE_MESSAGE,DRIVER_PHONE)
       RETURNING_VALUES DRIVER_TYPE_MESSAGE, DRIVER_DEST_PORT;

      IF ((S IS NOT NULL) AND (DRIVER_TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        S=REPLACE_STRING(S,'%BALANCE',CAST(BALANCE AS VARCHAR(30)));

        IF (NON_CASH IS NULL) THEN
          NON_CASH=0.0;

        S=REPLACE_STRING(S,'%NON_CASH',CAST(CAST(NON_CASH AS NUMERIC(15,0)) AS VARCHAR(30)));

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                  PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                  :S,NULL,:DRIVER_TYPE_MESSAGE,:DRIVER_PHONE,NULL,
                                  2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DRIVER_DEST_PORT,:DRIVER_FIRM_ID);
      END

      FOR SELECT TRIM(SUB_STRING(IM.TEXT_IN,2,100))
            FROM IN_MESSAGES IM
            JOIN CODE_MESSAGES CM ON CM.CODE_MESSAGE_ID=IM.CODE_MESSAGE_ID
           WHERE IM.SENDER_ID=:DRIVER_ID
             AND IM.ORDER_ID=:ORDER_ID
             AND IM.CODE_MESSAGE_ID='0388BCC17DE1A1754B566F18AEEED771' /* Клиент рассчитался полностью */
             AND CM.ENABLED=1
           ORDER BY IM.DATE_IN DESC
            INTO :CODE DO BEGIN

        SELECT COUNT(*)
          FROM CODE_MESSAGES
         WHERE CODE=:CODE
          INTO :CNT;

        IF (CNT=1) THEN BEGIN
          IS_CODE_PARK = 1;
          EXECUTE PROCEDURE TRY_PARK_IN(SESSION_ID,ORDER_ID,ACCOUNT_ID,DRIVER_ID,CODE,DRIVER_TYPE_MESSAGE);

        END ELSE BEGIN

          EXECUTE PROCEDURE QUERY_PARK_STATES (ORDER_ID,ACCOUNT_ID,DRIVER_ID,PHONE,DRIVER_TYPE_MESSAGE);

        END

        BREAK;
      END

          if (:IS_CODE_PARK = 0 and :driver_id = 'BE5A2674A78DAEFA4BBBBE6F18B67B1B') then
          begin
              EXECUTE PROCEDURE TRY_PARK_IN_AFTER_FULL(ORDER_ID, DRIVER_ID, DRIVER_TYPE_MESSAGE, BALANCE, ACCOUNT_ID, DRIVER_DEST_PORT);
          end

      /* Обработка скидок, виртуальных начислений */
      EXECUTE PROCEDURE CLIENT_DISCOUNT(:ORDER_ID);

    END

  END
END

--

CREATE OR ALTER PROCEDURE PR_PARTY_CALC 
(
    SESSION_ID VARCHAR(32),
    ORDER_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32))
AS
DECLARE VARIABLE PHONE VARCHAR(100);
DECLARE VARIABLE DRIVER_ID VARCHAR(32);
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE IN_MESSAGE_ID VARCHAR(32);
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN

  SELECT DRIVER_ID
    FROM ORDERS
   WHERE ORDER_ID=:ORDER_ID
    INTO :DRIVER_ID;

  UPDATE ORDERS
     SET TYPE_PROCESS=1,
         DATE_END=CURRENT_TIMESTAMP,
         WHO_PROCESS_ID=:ACCOUNT_ID
   WHERE ORDER_ID=:ORDER_ID;

  IF (DRIVER_ID IS NOT NULL) THEN BEGIN

    FOR SELECT IN_MESSAGE_ID, TYPE_MESSAGE
          FROM IN_MESSAGES
         WHERE ORDER_ID=:ORDER_ID
           AND CODE_MESSAGE_ID='E0D06394F6BC81BA481D1F94D12B3FB4' /* Клиент отказался платить */
           AND SENDER_ID=:DRIVER_ID
           AND DESCRIPTION IS NULL
          INTO :IN_MESSAGE_ID, :TYPE_MESSAGE DO BEGIN

      UPDATE IN_MESSAGES
         SET DESCRIPTION=:ORDER_ID
       WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID;

      BREAK;
    END

    SELECT PHONE, FIRM_ID
      FROM ACCOUNTS
     WHERE ACCOUNT_ID=:DRIVER_ID
      INTO :PHONE, :FIRM_ID;

    SELECT CONST_VALUE FROM GET_CONST_VALUE('8B477D56F777966345EBC1130AF01C55') INTO :S;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,TYPE_MESSAGE,PHONE)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
    END

  END

END

--

CREATE OR ALTER PROCEDURE PR_REFUSE_CLIENT_COME_OUT 
(
    SESSION_ID VARCHAR(32),
    ORDER_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32))
AS
DECLARE VARIABLE DRIVER_ID VARCHAR(32);
DECLARE VARIABLE PARK_ID VARCHAR(32);
DECLARE VARIABLE PARK_NAME VARCHAR(100);
DECLARE VARIABLE PHONE VARCHAR(100);
DECLARE VARIABLE PARK_STATE_ID VARCHAR(32);
DECLARE VARIABLE DATE_IN TIMESTAMP;
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE IN_MESSAGE_ID VARCHAR(32);
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN

  SELECT DRIVER_ID, PARK_ID
    FROM ORDERS
   WHERE ORDER_ID=:ORDER_ID
    INTO :DRIVER_ID, :PARK_ID;

  UPDATE ORDERS
     SET DATE_END=CURRENT_TIMESTAMP,
         WHO_PROCESS_ID=:ACCOUNT_ID,
         FINISHED=1
   WHERE ORDER_ID=:ORDER_ID;

  IF (DRIVER_ID IS NOT NULL) THEN BEGIN

    FOR SELECT IN_MESSAGE_ID, TYPE_MESSAGE
          FROM IN_MESSAGES
         WHERE ORDER_ID=:ORDER_ID
           AND CODE_MESSAGE_ID='9273E67428E797614B153E4C799D6F48' /* Клиент отказался от заказа */
           AND SENDER_ID=:DRIVER_ID
           AND DESCRIPTION IS NULL
          INTO :IN_MESSAGE_ID, :TYPE_MESSAGE DO BEGIN

      UPDATE IN_MESSAGES
         SET DESCRIPTION=:ORDER_ID
       WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID;

      BREAK;
    END

    IF (PARK_ID IS NOT NULL) THEN BEGIN

      FOR SELECT PS.PARK_STATE_ID, P.NAME, PS.DATE_IN
            FROM PARK_STATES PS
            JOIN PARKS P ON P.PARK_ID=PS.PARK_ID
           WHERE PS.PARK_ID=:PARK_ID
             AND PS.DATE_OUT IS NULL
           ORDER BY PS.DATE_IN
            INTO :PARK_STATE_ID, :PARK_NAME, :DATE_IN DO BEGIN

        DATE_IN=DATE_IN-1*(1e0/24/60/60);

        INSERT INTO PARK_STATES (PARK_STATE_ID,DRIVER_ID,PARK_ID,DATE_IN,DATE_OUT)
                         VALUES (GET_UNIQUE_ID(),:DRIVER_ID,:PARK_ID,:DATE_IN,NULL);

        BREAK;
      END

      IF (PARK_NAME IS NULL) THEN BEGIN

        INSERT INTO PARK_STATES (PARK_STATE_ID,DRIVER_ID,PARK_ID,DATE_IN,DATE_OUT)
                         VALUES (GET_UNIQUE_ID(),:DRIVER_ID,:PARK_ID,CURRENT_TIMESTAMP,NULL);

        SELECT NAME
          FROM PARKS
         WHERE PARK_ID=:PARK_ID
          INTO :PARK_NAME;

      END

      SELECT PHONE, FIRM_ID
        FROM ACCOUNTS
       WHERE ACCOUNT_ID=:DRIVER_ID
        INTO :PHONE, :FIRM_ID;

      SELECT CONST_VALUE FROM GET_CONST_VALUE('13D70B96F52BBE8D4E115CCC194F3B10') INTO :S;

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,TYPE_MESSAGE,PHONE)
       RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

      IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        S=REPLACE_STRING(S,'%PARK_NAME',PARK_NAME);

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                  PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                  :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                  2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
      END

    END ELSE BEGIN

      SELECT PHONE, FIRM_ID
        FROM ACCOUNTS
       WHERE ACCOUNT_ID=:DRIVER_ID
        INTO :PHONE, :FIRM_ID;

      SELECT CONST_VALUE FROM GET_CONST_VALUE('13D70B96F52BBE8D4E115CCC194F3B10') INTO :S;

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL,PHONE)
       RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

      IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                  PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                  :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                  0,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
      END

    END


  END

END

--

CREATE OR ALTER PROCEDURE PR_REFUSE_CLIENT_CONFIRM 
(
    SESSION_ID VARCHAR(32),
    ORDER_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32))
AS
DECLARE VARIABLE DRIVER_ID VARCHAR(32);
DECLARE VARIABLE PHONE VARCHAR(100);
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN

  SELECT DRIVER_ID
    FROM ORDERS
   WHERE ORDER_ID=:ORDER_ID
    INTO :DRIVER_ID;

  UPDATE ORDERS
     SET DATE_END=CURRENT_TIMESTAMP,
         WHO_PROCESS_ID=:ACCOUNT_ID,
         FINISHED=1
   WHERE ORDER_ID=:ORDER_ID;

  IF (DRIVER_ID IS NOT NULL) THEN BEGIN

    SELECT PHONE, FIRM_ID
      FROM ACCOUNTS
     WHERE ACCOUNT_ID=:DRIVER_ID
      INTO :PHONE, :FIRM_ID;

    SELECT CONST_VALUE FROM GET_CONST_VALUE('C40297F408B0AF3A45776489F11FC512') INTO :S;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL,PHONE)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                0,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
    END

  END

END

--

CREATE OR ALTER PROCEDURE PR_REFUSE_CLIENT_DRIVE_OUT 
(
    SESSION_ID VARCHAR(32),
    ORDER_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32))
AS
DECLARE VARIABLE DRIVER_ID VARCHAR(32);
DECLARE VARIABLE PARK_ID VARCHAR(32);
DECLARE VARIABLE PARK_NAME VARCHAR(100);
DECLARE VARIABLE PHONE VARCHAR(100);
DECLARE VARIABLE PARK_STATE_ID VARCHAR(32);
DECLARE VARIABLE DATE_IN TIMESTAMP;
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN

  SELECT DRIVER_ID, PARK_ID
    FROM ORDERS
   WHERE ORDER_ID=:ORDER_ID
    INTO :DRIVER_ID, :PARK_ID;

  UPDATE ORDERS
     SET DATE_END=CURRENT_TIMESTAMP,
         WHO_PROCESS_ID=:ACCOUNT_ID,
         FINISHED=1
   WHERE ORDER_ID=:ORDER_ID;

  IF (DRIVER_ID IS NOT NULL) THEN BEGIN

    IF (PARK_ID IS NOT NULL) THEN begin

      FOR SELECT PS.PARK_STATE_ID, P.NAME, PS.DATE_IN
            FROM PARK_STATES PS
            JOIN PARKS P ON P.PARK_ID=PS.PARK_ID
           WHERE PS.PARK_ID=:PARK_ID
             AND PS.DATE_OUT IS NULL
           ORDER BY PS.DATE_IN
            INTO :PARK_STATE_ID, :PARK_NAME, :DATE_IN DO BEGIN

        DATE_IN=DATE_IN-1*(1e0/24/60/60);

        INSERT INTO PARK_STATES (PARK_STATE_ID,DRIVER_ID,PARK_ID,DATE_IN,DATE_OUT)
                         VALUES (GET_UNIQUE_ID(),:DRIVER_ID,:PARK_ID,:DATE_IN,NULL);

        BREAK;
      END

      IF (PARK_NAME IS NULL) THEN BEGIN

        INSERT INTO PARK_STATES (PARK_STATE_ID,DRIVER_ID,PARK_ID,DATE_IN,DATE_OUT)
                         VALUES (GET_UNIQUE_ID(),:DRIVER_ID,:PARK_ID,CURRENT_TIMESTAMP,NULL);

        SELECT NAME
          FROM PARKS
         WHERE PARK_ID=:PARK_ID
          INTO :PARK_NAME;

      END

      SELECT PHONE, FIRM_ID
        FROM ACCOUNTS
       WHERE ACCOUNT_ID=:DRIVER_ID
        INTO :PHONE, :FIRM_ID;

      SELECT CONST_VALUE FROM GET_CONST_VALUE('7604B1762FDB97EC406174FB54FA13EA') INTO :S;

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL,PHONE)
       RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

      IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                  PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                  :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                  0,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
      END

    END ELSE BEGIN

      SELECT PHONE, FIRM_ID
        FROM ACCOUNTS
       WHERE ACCOUNT_ID=:DRIVER_ID
        INTO :PHONE, :FIRM_ID;

      SELECT CONST_VALUE FROM GET_CONST_VALUE('35143E992503828F472EF385B1FCF3C3') INTO :S;

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL,PHONE)
       RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

      IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                  PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                  :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                  0,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
      END
    END

  END

END

--

CREATE OR ALTER PROCEDURE PR_REFUSE_DRIVER_COME_OUT 
(
    SESSION_ID VARCHAR(32),
    ORDER_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32))
AS
DECLARE VARIABLE DRIVER_ID VARCHAR(32);
DECLARE VARIABLE PHONE VARCHAR(100);
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE IN_MESSAGE_ID VARCHAR(32);
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN

  SELECT DRIVER_ID
    FROM ORDERS
   WHERE ORDER_ID=:ORDER_ID
    INTO :DRIVER_ID;

  UPDATE ORDERS
     SET TYPE_PROCESS=1,
         DATE_END=CURRENT_TIMESTAMP,
         WHO_PROCESS_ID=:ACCOUNT_ID
   WHERE ORDER_ID=:ORDER_ID;

  IF (DRIVER_ID IS NOT NULL) THEN BEGIN


    FOR SELECT IN_MESSAGE_ID, TYPE_MESSAGE
          FROM IN_MESSAGES
         WHERE ORDER_ID=:ORDER_ID
           AND CODE_MESSAGE_ID='2D41BEAE73EE84B04F4E6210C399BB63' /* Водитель отказалася от заказа */
           AND SENDER_ID=:DRIVER_ID
           AND DESCRIPTION IS NULL
          INTO :IN_MESSAGE_ID, :TYPE_MESSAGE DO BEGIN

      UPDATE IN_MESSAGES
         SET DESCRIPTION=:ORDER_ID
       WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID;

      BREAK;
    END

    SELECT PHONE, FIRM_ID
      FROM ACCOUNTS
     WHERE ACCOUNT_ID=:DRIVER_ID
      INTO :PHONE, :FIRM_ID;

    SELECT CONST_VALUE FROM GET_CONST_VALUE('2C0BBC7EF7418D934C32D8969D7F2D8C') INTO :S;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,TYPE_MESSAGE,PHONE)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
    END

  END

END

--

CREATE OR ALTER PROCEDURE PR_REFUSE_DRIVER_CONFIRM 
(
    SESSION_ID VARCHAR(32),
    ORDER_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32))
AS
DECLARE VARIABLE DRIVER_ID VARCHAR(32);
DECLARE VARIABLE PARK_ID VARCHAR(32);
DECLARE VARIABLE PHONE VARCHAR(100);
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE IN_MESSAGE_ID VARCHAR(32);
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN

  SELECT DRIVER_ID
    FROM ORDERS
   WHERE ORDER_ID=:ORDER_ID
    INTO :DRIVER_ID;

  PARK_ID=NULL;

  FOR SELECT PARK_ID
        FROM ORDERS
       WHERE PARENT_ID=:ORDER_ID
       ORDER BY DATE_HISTORY
        INTO :PARK_ID DO BEGIN
    BREAK;
  END

  UPDATE ORDERS
     SET DATE_BEGIN=CURRENT_TIMESTAMP,
         PARK_ID=:PARK_ID,
         DRIVER_ID=NULL,
         CAR_ID=NULL
   WHERE ORDER_ID=:ORDER_ID;

  IF (DRIVER_ID IS NOT NULL) THEN BEGIN

    FOR SELECT IN_MESSAGE_ID, TYPE_MESSAGE
          FROM IN_MESSAGES
         WHERE ORDER_ID=:ORDER_ID
           AND CODE_MESSAGE_ID='2D41BEAE73EE84B04F4E6210C399BB63' /* Водитель отказалася от заказа */
           AND SENDER_ID=:DRIVER_ID
           AND DESCRIPTION IS NULL
          INTO :IN_MESSAGE_ID, :TYPE_MESSAGE DO BEGIN

      UPDATE IN_MESSAGES
         SET DESCRIPTION=:ORDER_ID
       WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID;

      BREAK;
    END

    UPDATE PARK_STATES
       SET DATE_OUT=CURRENT_TIMESTAMP
     WHERE DATE_OUT IS NULL
       AND DRIVER_ID=:DRIVER_ID;

    SELECT PHONE, FIRM_ID
      FROM ACCOUNTS
     WHERE ACCOUNT_ID=:DRIVER_ID
      INTO :PHONE, :FIRM_ID;

    SELECT CONST_VALUE FROM GET_CONST_VALUE('14AB0F225BEFBBB14E0A5296BEB471A3') INTO :S;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,TYPE_MESSAGE,PHONE)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
    END

  END

END

--

CREATE OR ALTER PROCEDURE PR_REFUSE_DRIVER_DRIVE_OUT 
(
    SESSION_ID VARCHAR(32),
    ORDER_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32))
AS
DECLARE VARIABLE DRIVER_ID VARCHAR(32);
DECLARE VARIABLE PARK_ID VARCHAR(32);
DECLARE VARIABLE PHONE VARCHAR(100);
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE IN_MESSAGE_ID VARCHAR(32);
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN

  SELECT DRIVER_ID
    FROM ORDERS
   WHERE ORDER_ID=:ORDER_ID
    INTO :DRIVER_ID;

  PARK_ID=NULL;

  FOR SELECT PARK_ID
        FROM ORDERS
       WHERE PARENT_ID=:ORDER_ID
       ORDER BY DATE_HISTORY
        INTO :PARK_ID DO BEGIN
    BREAK;
  END

  UPDATE ORDERS
     SET DATE_BEGIN=CURRENT_TIMESTAMP,
         PARK_ID=:PARK_ID,
         DRIVER_ID=NULL,
         CAR_ID=NULL
   WHERE ORDER_ID=:ORDER_ID;

  IF (DRIVER_ID IS NOT NULL) THEN BEGIN

    FOR SELECT IN_MESSAGE_ID, TYPE_MESSAGE
          FROM IN_MESSAGES
         WHERE ORDER_ID=:ORDER_ID
           AND CODE_MESSAGE_ID='2D41BEAE73EE84B04F4E6210C399BB63' /* Водитель отказалася от заказа */
           AND SENDER_ID=:DRIVER_ID
           AND DESCRIPTION IS NULL
          INTO :IN_MESSAGE_ID, :TYPE_MESSAGE DO BEGIN

      UPDATE IN_MESSAGES
         SET DESCRIPTION=:ORDER_ID
       WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID;

      BREAK;
    END

    SELECT PHONE, FIRM_ID
      FROM ACCOUNTS
     WHERE ACCOUNT_ID=:DRIVER_ID
      INTO :PHONE, :FIRM_ID;

    SELECT CONST_VALUE FROM GET_CONST_VALUE('7D5B6BED096187764ECE40FC7D5CB943') INTO :S;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,TYPE_MESSAGE,PHONE)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
    END

  END

END

--

CREATE OR ALTER PROCEDURE PR_SELECT_DRIVER 
(
    SESSION_ID VARCHAR(32),
    ORDER_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32))
AS
DECLARE VARIABLE DRIVER_ID VARCHAR(32);
DECLARE VARIABLE CAR_ID VARCHAR(32);
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE ADDRESS VARCHAR(1000);
DECLARE VARIABLE PREFIX VARCHAR(10);
DECLARE VARIABLE STREET VARCHAR(100);
DECLARE VARIABLE HOUSE VARCHAR(10);
DECLARE VARIABLE FLAT VARCHAR(10);
DECLARE VARIABLE PORCH VARCHAR(10);
DECLARE VARIABLE LOCALITY VARCHAR(100);
DECLARE VARIABLE PHONE VARCHAR(100);
DECLARE VARIABLE DATE_ACCEPT TIMESTAMP;
DECLARE VARIABLE DATE_ARRIVAL TIMESTAMP;
DECLARE VARIABLE DATE_BEGIN TIMESTAMP;
DECLARE VARIABLE BEFORE_PERIOD INTEGER;
DECLARE VARIABLE ACTION_ID VARCHAR(32);
DECLARE VARIABLE D TIMESTAMP;
DECLARE VARIABLE DESCRIPTION VARCHAR(250);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN

  SELECT O.DRIVER_ID,
         S.PREFIX, S.NAME, O.HOUSE, O.FLAT, O.PORCH, L.NAME,
         O.DATE_ACCEPT, O.DATE_ARRIVAL, O.BEFORE_PERIOD,
         O.ACTION_ID, O.DATE_BEGIN, O.DESCRIPTION
    FROM ORDERS O
    JOIN STREETS S ON S.STREET_ID=O.STREET_ID
    JOIN LOCALITIES L ON L.LOCALITY_ID=S.LOCALITY_ID
   WHERE O.ORDER_ID=:ORDER_ID
    INTO :DRIVER_ID,
         :PREFIX, :STREET, :HOUSE, :FLAT, :PORCH, :LOCALITY,
         :DATE_ACCEPT, :DATE_ARRIVAL, :BEFORE_PERIOD,
         :ACTION_ID, :DATE_BEGIN, :DESCRIPTION;

  IF (DRIVER_ID IS NOT NULL) THEN BEGIN

    CNT=0;

    SELECT COUNT(*)
      FROM OUT_MESSAGES
     WHERE RECIPIENT_ID=:DRIVER_ID
       AND ORDER_ID=:ORDER_ID
       AND DESCRIPTION=:ACTION_ID
       AND TYPE_MESSAGE=0
       AND DATE_OUT IS NULL
       AND DATE_CREATE>=:DATE_BEGIN
      INTO CNT;

    IF (CNT=0) THEN BEGIN

      SELECT D.CAR_ID, A.PHONE, A.FIRM_ID
        FROM DRIVERS D
        JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
       WHERE D.DRIVER_ID=:DRIVER_ID
        INTO :CAR_ID, :PHONE, :FIRM_ID;

      D=CURRENT_TIMESTAMP;

      UPDATE ORDERS
         SET DRIVER_ID=:DRIVER_ID,
             CAR_ID=:CAR_ID,
             DATE_END=:D,
             WHO_PROCESS_ID=:ACCOUNT_ID
       WHERE ORDER_ID=:ORDER_ID;

      ADDRESS='';

      IF (PREFIX IS NOT NULL) THEN
        ADDRESS=PREFIX||' ';

      ADDRESS=ADDRESS||STREET||' '||HOUSE;

      IF (FLAT IS NOT NULL) THEN
        ADDRESS=ADDRESS||'-'||FLAT;

      IF (PORCH IS NOT NULL) THEN
        ADDRESS=ADDRESS||' п.'||PORCH;

      IF ((LOCALITY IS NOT NULL) AND (LOCALITY<>'Красноярск')) THEN
        ADDRESS=ADDRESS||', '||LOCALITY;

      IF (DATE_ACCEPT<DATE_ARRIVAL) THEN BEGIN

        IF ((DATE_ACCEPT+(BEFORE_PERIOD*(1e0/24/60)))<DATE_ARRIVAL) THEN BEGIN

          SELECT CONST_VALUE FROM GET_CONST_VALUE('2A773F389AD895B94010252F1DC6D3CC') INTO :S;

        END ELSE BEGIN

          SELECT CONST_VALUE FROM GET_CONST_VALUE('051BE1C8C28F9DB34EAA8DD46E0DA3B4') INTO :S;

        END

      END ELSE BEGIN

        SELECT CONST_VALUE FROM GET_CONST_VALUE('CD5055A23D04B51641F3211814253430') INTO :S;

      END

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL,PHONE)
       RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

      IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        S=REPLACE_STRING(S,'%TIME',FORMAT_DATETIME('hh:nn',DATE_ARRIVAL));
        S=REPLACE_STRING(S,'%ADDRESS',ADDRESS);

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                  PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,:D,
                                  :S,NULL,:TYPE_MESSAGE,:PHONE,:ACTION_ID,
                                  0,NULL,:D,:ORDER_ID,:DEST_PORT,:FIRM_ID);

        IF ((DESCRIPTION IS NOT NULL) AND (TRIM(DESCRIPTION)<>'')) THEN BEGIN

          S=DESCRIPTION;

          D=D+1*(1e0/24/60/60);

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                    PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,:D,
                                    :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                    0,NULL,:D,:ORDER_ID,:DEST_PORT,:FIRM_ID);
        END

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE TASK_0_PRIORITY 
(
    TASK_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32))
AS
DECLARE VARIABLE DRIVER_ID VARCHAR(32);
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE CHARGE_SUM NUMERIC(15,2);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE PHONE VARCHAR(50);
DECLARE VARIABLE S VARCHAR(200);
DECLARE VARIABLE D TIMESTAMP;
BEGIN

    /* need check */
    D = CURRENT_TIMESTAMP;

    SELECT SUM_CHARGE FROM CHARGE_TYPES WHERE CHARGE_TYPE_ID = '616900A226EB9D2F43B8156F96B589AC' INTO :CHARGE_SUM;

    FOR SELECT ACS.ACCOUNT_ID, ACS.PHONE
    FROM DRIVERS DRS
    LEFT JOIN ACCOUNTS ACS ON ACS.ACCOUNT_ID = DRS.DRIVER_ID
    WHERE                               /*баринов*/                       /*богданов*/                     /*сахаров*/                              /*суханов*/
        drs.driver_id in ('0256ABEEB873B082417F2E86A3A7D08F', 'BEA1F434D65383804128BA44071D2540', 'EF75FC4E2F56B0854BF3A2EB9DBA7A48', '638C674CDAE9914D4DA591CD53ED0D5A')
    GROUP BY ACS.ACCOUNT_ID, ACS.PHONE
    INTO :DRIVER_ID, :PHONE
    DO
    BEGIN

        CNT = 0;

        SELECT count(os.order_id)
            FROM orders os
            WHERE os.date_accept >= FORMAT_DATETIME('dd.mm.yyyy 00:00:00', DATEADD(-1 DAY TO CURRENT_TIMESTAMP)) AND
                os.date_accept <= FORMAT_DATETIME('dd.mm.yyyy 23:59:59', DATEADD(-1 DAY TO CURRENT_TIMESTAMP)) AND
                os.finished = 1 and
                os.RESULT_ID IN ('6DD8DFDC671DB9A742E418FD268E7DC4','E03D43E2E5B4AEEE4416B997D888FC71','B01126058AE48A354BBF0472888819A3') and
                os.driver_id = :driver_id
            INTO :CNT;

        if (:cnt > 0)
        THEN
        BEGIN
            SELECT CONST_VALUE FROM GET_CONST_VALUE('FBAF260BCD7CA22743039F71F26E1D19') INTO :S;

            if (:CHARGE_SUM IS NOT NULL) then
            begin

                INSERT INTO CHARGES (CHARGE_ID,WHO_CREATE_ID,CHARGE_TYPE_ID,ACCOUNT_ID,
                                     SUM_CHARGE,DATE_CHARGE,DATE_CREATE,DESCRIPTION,ORDER_ID,FIRM_ID)
                             VALUES (GET_UNIQUE_ID(), :ACCOUNT_ID, '616900A226EB9D2F43B8156F96B589AC', :driver_id,
                                     :CHARGE_SUM, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, NULL, NULL, 'C49DF004D660BBAF434839044848F5B8');

                EXECUTE PROCEDURE GET_TYPE_MESSAGE(:DRIVER_ID,NULL,PHONE)
                    RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

                IF (TYPE_MESSAGE IS NOT NULL) THEN
                BEGIN

                    S=REPLACE_STRING(:S, '%SUM', cast(:CHARGE_SUM as integer));
                    S=REPLACE_STRING(:S, '%COU', cast(:CNT as integer));

                    INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                              TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                              LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                                VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                        :S,CURRENT_TIMESTAMP,:TYPE_MESSAGE,:PHONE,NULL,2,
                                        NULL,:D,:DEST_PORT, 'C49DF004D660BBAF434839044848F5B8');


                    D=D+5*(1e0/24/60/60);

                END
            END
        end
    end

END

--

CREATE OR ALTER PROCEDURE TASK_BALANCE_REMINDER 
(
    TASK_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32))
AS
DECLARE VARIABLE DRIVER_ID VARCHAR(32);
DECLARE VARIABLE PRIORITY VARCHAR(32);
DECLARE VARIABLE PHONE VARCHAR(100);
DECLARE VARIABLE NAME VARCHAR(100);
DECLARE VARIABLE PATRONYMIC VARCHAR(100);
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE S1 VARCHAR(1000);
DECLARE VARIABLE D TIMESTAMP;
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE SUM_CHARGE NUMERIC(15,2);
DECLARE VARIABLE SUM_RECEIPT NUMERIC(15,2);
DECLARE VARIABLE BALANCE NUMERIC(15,2);
DECLARE VARIABLE MIN_BALANCE NUMERIC(15,2);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN

  SELECT CONST_VALUE FROM GET_CONST_VALUE('F0532713CEE09A984B2D52D050A58EF0') INTO :S;

  SELECT priority
    FROM drivers
   WHERE driver_id = :DRIVER_ID
    INTO :PRIORITY;

  IF ((S IS NOT NULL) and (PRIORITY > -1)) THEN BEGIN

    D=CURRENT_TIMESTAMP;

    FOR SELECT D.DRIVER_ID, A.PHONE, A.NAME, A.PATRONYMIC, A.FIRM_ID
          FROM DRIVERS D
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
         WHERE A.LOCKED<>1
          INTO :DRIVER_ID, :PHONE, :NAME, :PATRONYMIC, :FIRM_ID DO BEGIN

      EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:DRIVER_ID)
       RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

      IF (BALANCE<0) THEN BEGIN

        EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL,PHONE)
         RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

        IF (TYPE_MESSAGE IS NOT NULL) THEN BEGIN
        
          S1=S;
          S1=REPLACE_STRING(S1,'%BALANCE',CAST(BALANCE AS VARCHAR(30)));
          S1=REPLACE_STRING(S1,'-','');

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                    LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                    :S1,NULL,:TYPE_MESSAGE,:PHONE,NULL,2,
                                    NULL,:D,:DEST_PORT,:FIRM_ID);

          D=D+5*(1e0/24/60/60);
        END

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE TASK_CHANGE_PRIORITY 
(
    TASK_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32))
AS
DECLARE VARIABLE DRIVER_ID VARCHAR(32);
DECLARE VARIABLE PHONE VARCHAR(100);
DECLARE VARIABLE NAME VARCHAR(100);
DECLARE VARIABLE PATRONYMIC VARCHAR(100);
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE S1 VARCHAR(1000);
DECLARE VARIABLE D TIMESTAMP;
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE NEW_PRIORITY INTEGER;
DECLARE VARIABLE PRIORITY INTEGER;
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN

  SELECT CONST_VALUE FROM GET_CONST_VALUE('6C5F5E35B4F0B54A470F466044C8EB3F') INTO :S;

  IF (S IS NOT NULL) THEN BEGIN

    D=CURRENT_TIMESTAMP;

    FOR SELECT D.DRIVER_ID, D.PRIORITY,
               A.PHONE, A.NAME, A.PATRONYMIC, A.FIRM_ID
          FROM DRIVERS D
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
         WHERE A.LOCKED<>1
           AND D.DATE_PRIORITY IS NOT NULL
           AND D.DATE_PRIORITY<=CURRENT_DATE
          INTO :DRIVER_ID, :PRIORITY,
               :PHONE, :NAME, :PATRONYMIC, :FIRM_ID DO BEGIN

      SELECT COUNT(*)
        FROM ORDERS
       WHERE DRIVER_ID=:DRIVER_ID
         AND FINISHED=1
         AND PARENT_ID IS NULL
         AND RESULT_ID IN ('6DD8DFDC671DB9A742E418FD268E7DC4','E03D43E2E5B4AEEE4416B997D888FC71','B01126058AE48A354BBF0472888819A3')
         AND DATE_ACCEPT>=(CURRENT_TIMESTAMP-7*24*60*60*(1e0/24/60/60))
        INTO :CNT;

      IF ((CNT>=0) AND (CNT<=30)) THEN
        NEW_PRIORITY=2;

      IF (CNT>30) THEN
        NEW_PRIORITY=1;

      IF (PRIORITY<>NEW_PRIORITY) THEN BEGIN

        PRIORITY=NEW_PRIORITY;

        UPDATE DRIVERS
           SET PRIORITY=:PRIORITY
         WHERE DRIVER_ID=:DRIVER_ID;


        EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL,PHONE)
         RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

        IF (TYPE_MESSAGE IS NOT NULL) THEN BEGIN

          S1=S;
          S1=REPLACE_STRING(S1,'%PRIORITY',PRIORITY);
          S1=REPLACE_STRING(S1,'%ORDER_COUNT',CNT);

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                    LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                    :S1,NULL,:TYPE_MESSAGE,:PHONE,NULL,2,
                                    NULL,:D,:DEST_PORT,:FIRM_ID);
          D=D+5*(1e0/24/60/60);
          
        END

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE TASK_DRIVER_LOCK 
(
    TASK_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32))
AS
DECLARE VARIABLE DRIVER_ID VARCHAR(32);
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE S1 VARCHAR(1000);
DECLARE VARIABLE D TIMESTAMP;
DECLARE VARIABLE DATE_END TIMESTAMP;
DECLARE VARIABLE PHONE VARCHAR(100);
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN

  SELECT CONST_VALUE FROM GET_CONST_VALUE('2D1BA9876918B7CE42515B204A6020AB') INTO :S;

  IF (S IS NOT NULL) THEN BEGIN

    D=CURRENT_TIMESTAMP;

    FOR SELECT D.DRIVER_ID, A.PHONE, A.FIRM_ID
          FROM DRIVERS D
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
         WHERE A.LOCKED<>1
          INTO :DRIVER_ID, :PHONE, :FIRM_ID DO BEGIN

      SELECT MAX(DATE_END)
        FROM SHIFTS
       WHERE ACCOUNT_ID=:DRIVER_ID
        INTO :DATE_END;

      SELECT COUNT(*)
        FROM SHIFTS
       WHERE ACCOUNT_ID=:DRIVER_ID
         AND DATE_END IS NULL
        INTO :CNT;

      IF ((CNT=0) AND (DATE_END IS NOT NULL) AND
          (DATE_END<(CURRENT_TIMESTAMP-7*24*60*60*(1e0/24/60/60)))) THEN BEGIN

        UPDATE ACCOUNTS
           SET LOCKED=1
         WHERE ACCOUNT_ID=:DRIVER_ID;

        EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL,PHONE)
         RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

        IF (TYPE_MESSAGE IS NOT NULL) THEN BEGIN

          S1=S;

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                    LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                    :S1,NULL,:TYPE_MESSAGE,:PHONE,NULL,2,
                                    NULL,:D,:DEST_PORT,:FIRM_ID);
          D=D+5*(1e0/24/60/60);
          
        END

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE TASK_DRIVER_NOORDER 
(
    TASK_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32))
AS
DECLARE VARIABLE DRIVER_ID VARCHAR(32);
DECLARE VARIABLE DRIVER_SURNAME VARCHAR(100);
DECLARE VARIABLE DRIVER_NAME VARCHAR(100);
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE S1 VARCHAR(1000);
DECLARE VARIABLE D TIMESTAMP;
DECLARE VARIABLE SHIFT_BEGIN TIMESTAMP;
DECLARE VARIABLE PARK_IN TIMESTAMP;
DECLARE VARIABLE PARK_ID VARCHAR(32);
DECLARE VARIABLE PARK_DESCRIPT VARCHAR(250);
DECLARE VARIABLE ORDER_IN TIMESTAMP;
DECLARE VARIABLE PHONE VARCHAR(100);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
DECLARE VARIABLE SUCCESS INTEGER;
begin 

  /* need check */

  select CONST_VALUE 
  from GET_CONST_VALUE('1F1BA9876918B7CE42515B204A6020AB')
  into :S;

  if (S is not null) then
  begin 

    D = current_timestamp;

    for select D.DRIVER_ID, A.PHONE, A.FIRM_ID, A.surname, A.name
        from DRIVERS D 
        join ACCOUNTS A on A.ACCOUNT_ID = D.DRIVER_ID 
        where A.LOCKED <> 1 and
              D.priority < 0
        into :DRIVER_ID, :PHONE, :FIRM_ID, :Driver_surname, :Driver_name
    do
    begin 

      select max(DATE_BEGIN) 
      from SHIFTS 
      where ACCOUNT_ID = :DRIVER_ID and
            DATE_END is null
      into :SHIFT_BEGIN;

      select max(DATE_IN), max(PARK_ID)
      from PARK_STATES
      where DRIVER_ID = :DRIVER_ID and
            DATE_OUT is null
      into :PARK_IN, :PARK_ID;

      select p.description
      from parks p
      where p.park_id = :Park_ID
      into :PARK_DESCRIPT;

      select max(DATE_ACCEPT)
      from ORDERS
      where DRIVER_ID = :DRIVER_ID and
            finished=0 and
            date_history is null
      into :ORDER_IN;

      if (SHIFT_BEGIN is not null and
        ORDER_IN is null and
        PARK_IN < (current_timestamp + 10 * 60 * (1E0 / 24 / 60 / 60))
      ) then
      begin 

          S1 = 'Водитель (' || Driver_surname || ' ' || Driver_name ||  ') стоит на стоянке (' || PARK_DESCRIPT || ') более 10 минут.';

    IN AUTONOMOUS TRANSACTION DO BEGIN

      INSERT INTO ALARMS (ALARM_ID, SENDER_ID, RECIPIENT_ID, TYPE_ALARM,
                    DATE_BEGIN, DATE_END, CAPTION, TEXT_ALARM)
           VALUES (GET_UNIQUE_ID(), 'CA25F4C3A6DA8C334D20D3C4F2A2EF62', '22E88F4DA4D3A08B42691A0F0370F0EB', 0,
                    CURRENT_TIMESTAMP, CURRENT_TIMESTAMP+0.5*(1e0/24/60), 'Водитель простаивает более 10 минут', :S1 );

    END

        EXECUTE PROCEDURE EVENT_ALARM('A35F5701A7AA920E40812A71A690910D', NULL, NULL, 0)
         RETURNING_VALUES SUCCESS;

      end

    end 

  end 

end

--

CREATE OR ALTER PROCEDURE TASK_DRIVER_NOPARK 
(
    TASK_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32))
AS
DECLARE VARIABLE DRIVER_ID VARCHAR(32);
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE S1 VARCHAR(1000);
DECLARE VARIABLE D TIMESTAMP;
DECLARE VARIABLE SHIFT_BEGIN TIMESTAMP;
DECLARE VARIABLE PARK_IN TIMESTAMP;
DECLARE VARIABLE ORDER_IN TIMESTAMP;
DECLARE VARIABLE ORDER_END TIMESTAMP;
DECLARE VARIABLE PHONE VARCHAR(100);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
begin 

  /* need check */

  select CONST_VALUE 
  from GET_CONST_VALUE('1D1BA9876918B7CE42515B204A6020AB') 
  into :S;

  if (S is not null) then
  begin 

    D = current_timestamp;

    for select D.DRIVER_ID, A.PHONE, A.FIRM_ID 
        from DRIVERS D 
        join ACCOUNTS A on A.ACCOUNT_ID = D.DRIVER_ID 
        where A.LOCKED <> 1 and
              D.PRIORITY < 0
        into :DRIVER_ID, :PHONE, :FIRM_ID 
    do
    begin 

      select max(DATE_BEGIN) 
      from SHIFTS 
      where ACCOUNT_ID = :DRIVER_ID and
            DATE_END is null
      into :SHIFT_BEGIN;

      select max(DATE_IN) 
      from PARK_STATES 
      where DRIVER_ID = :DRIVER_ID and
            DATE_OUT is null 
      into :PARK_IN;

      select max(DATE_ACCEPT)
      from ORDERS
      where DRIVER_ID = :DRIVER_ID and
            finished=0 and
            date_history is null
      into :ORDER_IN;

      select max(DATE_END) 
      from ORDERS 
      where DRIVER_ID = :DRIVER_ID
      into :ORDER_END;

      if (SHIFT_BEGIN is not null and
          PARK_IN is null and
          ORDER_IN is null and
          ORDER_END < (current_timestamp + 10 * 60 * (1E0 / 24 / 60 / 60))
      ) then
      begin 

        execute procedure GET_TYPE_MESSAGE(DRIVER_ID, null,PHONE)
            returning_values TYPE_MESSAGE, DEST_PORT;

        if (TYPE_MESSAGE is not null) then
        begin 

          S1 = S;

          insert into OUT_MESSAGES (OUT_MESSAGE_ID, CREATOR_ID, RECIPIENT_ID, DATE_CREATE, TEXT_OUT, DATE_OUT,
                                    TYPE_MESSAGE, CONTACT, DESCRIPTION, PRIORITY, LOCKED, DATE_BEGIN, DEST_PORT,
                                    FIRM_ID) 
          values (GET_UNIQUE_ID(), :ACCOUNT_ID, :DRIVER_ID, current_timestamp, :S1, null, :TYPE_MESSAGE, :PHONE, null,
                                2, null, :D, :DEST_PORT, :FIRM_ID);
          D = D + 5 * (1E0 / 24 / 60 / 60);

        end 

      end 

    end 

  end 

end

--

CREATE OR ALTER PROCEDURE TASK_HAPPY_BIRTHDAY 
(
    TASK_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32))
AS
DECLARE VARIABLE RECIPIENT_ID VARCHAR(32);
DECLARE VARIABLE PHONE VARCHAR(100);
DECLARE VARIABLE NAME VARCHAR(100);
DECLARE VARIABLE PATRONYMIC VARCHAR(100);
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE S1 VARCHAR(1000);
DECLARE VARIABLE D TIMESTAMP;
DECLARE VARIABLE CURRENT_DAY INTEGER;
DECLARE VARIABLE CURRENT_MONTH INTEGER;
DECLARE VARIABLE RECEIPT_TYPE_ID VARCHAR(32);
DECLARE VARIABLE SUM_RECEIPT NUMERIC(15,0);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN

  D=CURRENT_TIMESTAMP;

  CURRENT_DAY=EXTRACT(DAY FROM D);
  CURRENT_MONTH=EXTRACT(MONTH FROM D);

  SELECT CONST_VALUE FROM GET_CONST_VALUE('8CDCC7F96A988CA2432AA812964351F3') INTO :S;

  IF (S IS NOT NULL) THEN BEGIN

    FOR SELECT A.ACCOUNT_ID, A.PHONE, A.NAME, A.PATRONYMIC, A.FIRM_ID
          FROM DISPATCHERS D
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DISPATCHER_ID
         WHERE A.LOCKED<>1
           AND A.PHONE IS NOT NULL
           AND EXTRACT(DAY FROM D.DATE_BIRTH)=:CURRENT_DAY
           AND EXTRACT(MONTH FROM D.DATE_BIRTH)=:CURRENT_MONTH
          INTO :RECIPIENT_ID, :PHONE, :NAME, :PATRONYMIC, :FIRM_ID DO BEGIN


      EXECUTE PROCEDURE GET_TYPE_MESSAGE(RECIPIENT_ID,NULL,PHONE)
       RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

      IF (TYPE_MESSAGE IS NOT NULL) THEN BEGIN

        S1=S;
        S1=REPLACE_STRING(S1,'%NAME',NAME);
        S1=REPLACE_STRING(S1,'%PATRONYMIC',PATRONYMIC);

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                  LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:RECIPIENT_ID,CURRENT_TIMESTAMP,
                                  :S1,NULL,:TYPE_MESSAGE,:PHONE,NULL,2,
                                  NULL,:D,:DEST_PORT,:FIRM_ID);

        D=D+5*(1e0/24/60/60);
        
      END
    END

  END

  SELECT CONST_VALUE FROM GET_CONST_VALUE('AF2D42CDBD398AFC4E0A988E3C57EF84') INTO :S;

  RECEIPT_TYPE_ID='771A20E1595D97694D7905B0A3D70FF9'; /* День рождения водителя */

  SELECT SUM_RECEIPT
    FROM RECEIPT_TYPES
   WHERE RECEIPT_TYPE_ID=:RECEIPT_TYPE_ID
    INTO :SUM_RECEIPT;

  IF ((S IS NOT NULL) AND (SUM_RECEIPT IS NOT NULL)) THEN BEGIN

    FOR SELECT A.ACCOUNT_ID, A.PHONE, A.NAME, A.PATRONYMIC, A.FIRM_ID
          FROM DRIVERS D
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
         WHERE A.LOCKED<>1
           AND A.PHONE IS NOT NULL
           AND EXTRACT(DAY FROM D.DATE_BIRTH)=:CURRENT_DAY
           AND EXTRACT(MONTH FROM D.DATE_BIRTH)=:CURRENT_MONTH
          INTO :RECIPIENT_ID, :PHONE, :NAME, :PATRONYMIC, :FIRM_ID DO BEGIN

     INSERT INTO RECEIPTS (RECEIPT_ID,RECEIPT_TYPE_ID,ACCOUNT_ID,WHO_CREATE_ID,
                           SUM_RECEIPT,DATE_RECEIPT,DATE_CREATE,DESCRIPTION,FIRM_ID)
                   VALUES (GET_UNIQUE_ID(),:RECEIPT_TYPE_ID,:RECIPIENT_ID,:ACCOUNT_ID,
                           :SUM_RECEIPT,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,NULL,:FIRM_ID);

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(RECIPIENT_ID,NULL,PHONE)
       RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

      IF (TYPE_MESSAGE IS NOT NULL) THEN BEGIN

        S1=S;
        S1=REPLACE_STRING(S1,'%NAME',NAME);
        S1=REPLACE_STRING(S1,'%PATRONYMIC',PATRONYMIC);
        S1=REPLACE_STRING(S1,'%SUM_RECEIPT',SUM_RECEIPT);

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                  LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:RECIPIENT_ID,CURRENT_TIMESTAMP,
                                  :S1,NULL,:TYPE_MESSAGE,:PHONE,NULL,2,
                                  NULL,:D,:DEST_PORT,:FIRM_ID);

        D=D+5*(1e0/24/60/60);
      END

    END

  END

  SELECT CONST_VALUE FROM GET_CONST_VALUE('3796835EECA2A1024C539A9BC0DAAD01') INTO :S;
    
  IF (S IS NOT NULL) THEN BEGIN

    FOR SELECT A.ACCOUNT_ID, A.PHONE, A.NAME, A.PATRONYMIC
          FROM CLIENTS C
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=C.CLIENT_ID
         WHERE A.LOCKED<>1
           AND A.PHONE IS NOT NULL
           AND EXTRACT(DAY FROM C.DATE_BIRTH)=:CURRENT_DAY
           AND EXTRACT(MONTH FROM C.DATE_BIRTH)=:CURRENT_MONTH
          INTO :RECIPIENT_ID, :PHONE, :NAME, :PATRONYMIC DO BEGIN

      FIRM_ID=NULL; /* Кто будет начислять непонятно */

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(RECIPIENT_ID,NULL,PHONE)
       RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

      IF (TYPE_MESSAGE IS NOT NULL) THEN BEGIN

        S1=S;
        S1=REPLACE_STRING(S1,'%NAME',NAME);
        S1=REPLACE_STRING(S1,'%PATRONYMIC',PATRONYMIC);

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                  LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:RECIPIENT_ID,CURRENT_TIMESTAMP,
                                  :S1,NULL,:TYPE_MESSAGE,:PHONE,NULL,2,
                                  NULL,:D,:DEST_PORT,:FIRM_ID);

        D=D+5*(1e0/24/60/60);

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE TASK_MOTIV_DRIVERS 
(
    TASK_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32))
AS
DECLARE VARIABLE DRIVER_ID VARCHAR(32);
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE CHARGE_SUM NUMERIC(15,2);
DECLARE VARIABLE PRIOR INTEGER;
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE PHONE VARCHAR(50);
DECLARE VARIABLE S VARCHAR(200);
DECLARE VARIABLE D TIMESTAMP;
DECLARE VARIABLE CHARGE NUMERIC(15,2);
BEGIN

    /* need check */

    D = CURRENT_TIMESTAMP;

    SELECT SUM_CHARGE FROM CHARGE_TYPES WHERE CHARGE_TYPE_ID = 'BD14FC0C9E2A9C394E0B31156E3DE412' INTO :CHARGE_SUM;

    FOR SELECT ACS.ACCOUNT_ID, DRS.PRIORITY, ACS.PHONE, COUNT(OS.ORDER_ID)
    FROM DRIVERS DRS
    LEFT JOIN ORDERS OS ON
        OS.DRIVER_ID = DRS.DRIVER_ID AND
        OS.PARENT_ID IS NULL AND
        OS.FINISHED = 1 AND
        OS.DATE_ACCEPT >= DATEADD(-6 DAY TO CURRENT_TIMESTAMP) AND
        os.RESULT_ID IN ('6DD8DFDC671DB9A742E418FD268E7DC4','E03D43E2E5B4AEEE4416B997D888FC71','B01126058AE48A354BBF0472888819A3')
    LEFT JOIN ACCOUNTS ACS ON ACS.ACCOUNT_ID = DRS.DRIVER_ID
    JOIN CAR_IN_TYPES CIT ON CIT.CAR_ID = DRS.CAR_ID AND CIT.CAR_TYPE_ID != '2FC1A2E9B900A144441F4B342A432950'
    WHERE
        (DRS.DATE_PRIORITY <= CURRENT_TIMESTAMP AND DRS.DATE_PRIORITY IS NOT NULL) AND
        ACS.LOCKED = 0
    GROUP BY ACS.ACCOUNT_ID, DRS.PRIORITY, ACS.PHONE
    HAVING (COUNT(OS.ORDER_ID) < 40 AND DRS.PRIORITY = 0) OR (COUNT(OS.ORDER_ID) < 30 AND DRS.PRIORITY = 1)
    INTO :DRIVER_ID, :PRIOR, :PHONE, :CNT
    DO
    BEGIN
        if ((:prior = 0 AND :cnt < 40) or
           (:prior = 1 AND :cnt < 30))
        THEN
        BEGIN
            SELECT CONST_VALUE FROM GET_CONST_VALUE('137D755E538085F34AC78D86BDD58C74') INTO :S;
            if (:S IS NOT NULL) then
            begin
            CHARGE = NULL;
            if (:PRIOR = 0 AND :CNT < 40) then
            begin
              CHARGE = (40 - :CNT) * :CHARGE_SUM;
              S = REPLACE_STRING(:S, '%COUNT', 40 - :CNT);
              S = REPLACE_STRING(:S, '%PLAN', 40);
            end else
            if (:PRIOR = 1 AND :CNT < 30) then
            begin
              CHARGE = (30 - :CNT) * :CHARGE_SUM;
              S = REPLACE_STRING(:S, '%COUNT', 30 - :CNT);
              S = REPLACE_STRING(:S, '%PLAN', 30);
            end

            if (:CHARGE IS NOT NULL) then
            begin
                EXECUTE PROCEDURE GET_TYPE_MESSAGE(:DRIVER_ID,NULL,PHONE)
                    RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

                IF (TYPE_MESSAGE IS NOT NULL) THEN
                BEGIN

                 /*   INSERT INTO CHARGES (CHARGE_ID,WHO_CREATE_ID,CHARGE_TYPE_ID,ACCOUNT_ID,
                                         SUM_CHARGE,DATE_CHARGE,DATE_CREATE,DESCRIPTION,ORDER_ID,FIRM_ID)
                                 VALUES (GET_UNIQUE_ID(), :ACCOUNT_ID, 'BD14FC0C9E2A9C394E0B31156E3DE412', :driver_id,
                                         :CHARGE, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, NULL, NULL, 'C49DF004D660BBAF434839044848F5B8');
                   */

                    S=REPLACE_STRING(:S, '%SUMM', cast(:CHARGE as integer));

                    INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                              TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                              LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                                VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                        :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,2,
                                        NULL,:D,:DEST_PORT, 'C49DF004D660BBAF434839044848F5B8');


                    D=D+5*(1e0/24/60/60);

                END
            END
            END
        end
    end

END

--

CREATE OR ALTER PROCEDURE TASK_SHIFT_CHARGE 
(
    TASK_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32))
AS
DECLARE VARIABLE DRIVER_ID VARCHAR(32);
DECLARE VARIABLE PHONE VARCHAR(100);
DECLARE VARIABLE NAME VARCHAR(100);
DECLARE VARIABLE PATRONYMIC VARCHAR(100);
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE S1 VARCHAR(1000);
DECLARE VARIABLE D TIMESTAMP;
DECLARE VARIABLE DAY_HOUR INTEGER;
DECLARE VARIABLE WEEK_DAY INTEGER;
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE SUM_CHARGE NUMERIC(15,2);
DECLARE VARIABLE CHARGE_TYPE_ID VARCHAR(32);
DECLARE VARIABLE SUM_RECEIPT NUMERIC(15,2);
DECLARE VARIABLE BALANCE NUMERIC(15,2);
DECLARE VARIABLE MIN_BALANCE NUMERIC(15,2);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN

  SELECT CONST_VALUE FROM GET_CONST_VALUE('118C2CC432E5B9B44A9BF94757EC2EDE') INTO :S;

  IF (S IS NOT NULL) THEN BEGIN

    D=CURRENT_TIMESTAMP;

    FOR SELECT D.DRIVER_ID, A.PHONE, A.NAME, A.PATRONYMIC,
               D.MIN_BALANCE, A.FIRM_ID
          FROM DRIVERS D
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
         WHERE A.LOCKED<>1
           AND D.DATE_SCHEDULE IS NOT NULL
           AND D.DATE_SCHEDULE<=CURRENT_DATE
          INTO :DRIVER_ID, :PHONE, :NAME, :PATRONYMIC,
               :MIN_BALANCE, :FIRM_ID DO BEGIN

      WEEK_DAY=EXTRACT(WEEKDAY FROM CURRENT_TIMESTAMP)-1;
      IF (WEEK_DAY<0) THEN
        WEEK_DAY=6;

      DAY_HOUR=EXTRACT(HOUR FROM CURRENT_TIMESTAMP);

      SELECT COUNT(*)
        FROM DRIVER_WEEK_SCHEDULES
       WHERE WEEK_DAY=:WEEK_DAY
         AND DAY_HOUR=:DAY_HOUR
         AND DRIVER_ID=:DRIVER_ID
        INTO :CNT;

      IF (CNT>0) THEN BEGIN

        SELECT COUNT(*)
          FROM SHIFTS
         WHERE DATE_END IS NULL
           AND ACCOUNT_ID=:DRIVER_ID
           AND DATE_BEGIN<=CURRENT_TIMESTAMP
          INTO :CNT;

        IF (CNT=0) THEN BEGIN

          EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:DRIVER_ID)
           RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

          IF ((MIN_BALANCE IS NULL) OR ((MIN_BALANCE IS NOT NULL) AND (BALANCE>MIN_BALANCE))) THEN BEGIN

            SUM_CHARGE=NULL;
            CHARGE_TYPE_ID='CF012E53C5C9A03E4A7F03194B84DA49'; /* Не выполнение графика */

            SELECT SUM_CHARGE
              FROM CHARGE_TYPES
             WHERE CHARGE_TYPE_ID=:CHARGE_TYPE_ID
              INTO :SUM_CHARGE;

            EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL,PHONE)
             RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

            IF ((SUM_CHARGE IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

              INSERT INTO CHARGES (CHARGE_ID,WHO_CREATE_ID,CHARGE_TYPE_ID,ACCOUNT_ID,
                                   SUM_CHARGE,DATE_CHARGE,DATE_CREATE,DESCRIPTION,FIRM_ID)
                           VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:CHARGE_TYPE_ID,:DRIVER_ID,
                                   :SUM_CHARGE,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,NULL,:FIRM_ID);

              S1=S;
              S1=REPLACE_STRING(S1,'%SUM_CHARGE',CAST(SUM_CHARGE AS VARCHAR(30)));

              INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                        TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                        PRIORITY,LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                                VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                        :S1,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                        1,NULL,:D,:DEST_PORT,:FIRM_ID);

              D=D+5*(1e0/24/60/60);

            END

          END

        END

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE TASK_SHIFT_CLOSE 
(
    SESSION_ID VARCHAR(32),
    TASK_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32))
AS
DECLARE VARIABLE DRIVER_ID VARCHAR(32);
DECLARE VARIABLE PHONE VARCHAR(100);
DECLARE VARIABLE NAME VARCHAR(100);
DECLARE VARIABLE PATRONYMIC VARCHAR(100);
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE S1 VARCHAR(1000);
DECLARE VARIABLE D TIMESTAMP;
DECLARE VARIABLE D1 TIMESTAMP;
DECLARE VARIABLE SHIFT_BEGIN TIMESTAMP;
DECLARE VARIABLE PARK_IN TIMESTAMP;
DECLARE VARIABLE PARK_OUT TIMESTAMP;
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE DATE_END TIMESTAMP;
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN

  SELECT CONST_VALUE FROM GET_CONST_VALUE('4D39D8318FB6B77F42241D2B1336B192') INTO :S;

  IF (S IS NOT NULL) THEN BEGIN

    D=CURRENT_TIMESTAMP;

    FOR SELECT D.DRIVER_ID, A.PHONE, A.NAME, A.PATRONYMIC, A.FIRM_ID
          FROM DRIVERS D
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
         WHERE A.LOCKED<>1
          INTO :DRIVER_ID, :PHONE, :NAME, :PATRONYMIC, :FIRM_ID DO BEGIN

      SELECT MAX(DATE_BEGIN)
        FROM SHIFTS
       WHERE DATE_END IS NULL
         AND ACCOUNT_ID=:DRIVER_ID
        INTO :SHIFT_BEGIN;

      IF (SHIFT_BEGIN IS NOT NULL) THEN BEGIN

        D1=CURRENT_TIMESTAMP-90*60*(1e0/24/60/60);

        SELECT MAX(DATE_IN), MAX(DATE_OUT)
          FROM PARK_STATES
         WHERE DRIVER_ID=:DRIVER_ID
          INTO :PARK_IN, :PARK_OUT;

        IF (PARK_IN IS NULL) THEN BEGIN
          PARK_IN=SHIFT_BEGIN;
          PARK_OUT=PARK_IN;
        END

        SELECT COUNT(*)
          FROM PARK_STATES
         WHERE DRIVER_ID=:DRIVER_ID
           AND DATE_OUT IS NULL
          INTO :CNT;
                                 
        IF ((CNT=0) AND (D1>PARK_IN) AND (D1>PARK_OUT) AND (D1>SHIFT_BEGIN)) THEN BEGIN

          SELECT COUNT(*)
            FROM ORDERS
           WHERE DRIVER_ID=:DRIVER_ID
             AND FINISHED<>1
             AND PARENT_ID IS NULL
            INTO :CNT;

          IF (CNT=0) THEN BEGIN

            SELECT MAX(DATE_END)
              FROM ORDERS
             WHERE DRIVER_ID=:DRIVER_ID
               AND FINISHED=1
               AND PARENT_ID IS NULL
               AND DATE_END IS NOT NULL
              INTO :DATE_END;

            IF (DATE_END IS NULL) THEN
              DATE_END=SHIFT_BEGIN;

            IF (D1>DATE_END) THEN BEGIN

              UPDATE SHIFTS
                 SET DATE_END=CURRENT_TIMESTAMP
               WHERE DATE_END IS NULL
                 AND ACCOUNT_ID=:DRIVER_ID;

              EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL,PHONE)
               RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

              IF (TYPE_MESSAGE IS NOT NULL) THEN BEGIN
                S1=S;

                INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                          TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                          LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                                  VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                          :S1,NULL,:TYPE_MESSAGE,:PHONE,NULL,2,
                                          NULL,:D,:DEST_PORT,:FIRM_ID);

                D=D+5*(1e0/24/60/60);
              END

            END

          END

        END

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE TASK_SHIFT_LOCK 
(
    TASK_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32))
AS
DECLARE VARIABLE DRIVER_ID VARCHAR(32);
DECLARE VARIABLE PHONE VARCHAR(100);
DECLARE VARIABLE NAME VARCHAR(100);
DECLARE VARIABLE PATRONYMIC VARCHAR(100);
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE S1 VARCHAR(1000);
DECLARE VARIABLE D TIMESTAMP;
DECLARE VARIABLE DAY_HOUR INTEGER;
DECLARE VARIABLE WEEK_DAY INTEGER;
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN

  SELECT CONST_VALUE FROM GET_CONST_VALUE('21EF7AF84E37B7D64BAA8AE4CA871855') INTO :S;

  IF (S IS NOT NULL) THEN BEGIN

    D=CURRENT_TIMESTAMP;

    FOR SELECT D.DRIVER_ID, A.PHONE, A.NAME, A.PATRONYMIC, A.FIRM_ID
          FROM DRIVERS D
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
         WHERE A.LOCKED<>1
           AND D.DATE_SCHEDULE IS NOT NULL
           AND D.DATE_SCHEDULE<=CURRENT_DATE
          INTO :DRIVER_ID, :PHONE, :NAME, :PATRONYMIC, :FIRM_ID DO BEGIN

      WEEK_DAY=EXTRACT(WEEKDAY FROM CURRENT_TIMESTAMP)-1;
      IF (WEEK_DAY<0) THEN
        WEEK_DAY=6;

      DAY_HOUR=EXTRACT(HOUR FROM CURRENT_TIMESTAMP);

      SELECT COUNT(*)
        FROM DRIVER_WEEK_SCHEDULES
       WHERE WEEK_DAY=:WEEK_DAY
         AND DAY_HOUR=:DAY_HOUR
         AND DRIVER_ID=:DRIVER_ID
        INTO :CNT;

      IF (CNT>0) THEN BEGIN

        SELECT COUNT(*)
          FROM SHIFTS
         WHERE DATE_END IS NULL
           AND ACCOUNT_ID=:DRIVER_ID
           AND DATE_BEGIN<=CURRENT_TIMESTAMP
          INTO :CNT;

        EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL,PHONE)
         RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

        IF ((CNT=0) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

          UPDATE ACCOUNTS
             SET LOCKED=1
           WHERE ACCOUNT_ID=:DRIVER_ID;

          S1=S;

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                    PRIORITY,LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                    :S1,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                    1,NULL,:D,:DEST_PORT,:FIRM_ID);

          D=D+5*(1e0/24/60/60);

        END

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE TASK_SHIFT_REMINDER 
(
    TASK_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32))
AS
DECLARE VARIABLE DRIVER_ID VARCHAR(32);
DECLARE VARIABLE PHONE VARCHAR(100);
DECLARE VARIABLE NAME VARCHAR(100);
DECLARE VARIABLE PATRONYMIC VARCHAR(100);
DECLARE VARIABLE S VARCHAR(1000);
DECLARE VARIABLE S1 VARCHAR(1000);
DECLARE VARIABLE D TIMESTAMP;
DECLARE VARIABLE DTIME TIMESTAMP;
DECLARE VARIABLE DAY_HOUR INTEGER;
DECLARE VARIABLE WEEK_DAY INTEGER;
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE SUM_CHARGE NUMERIC(15,2);
DECLARE VARIABLE SUM_RECEIPT NUMERIC(15,2);
DECLARE VARIABLE BALANCE NUMERIC(15,2);
DECLARE VARIABLE MIN_BALANCE NUMERIC(15,2);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
DECLARE VARIABLE FIRM_ID VARCHAR(32);
BEGIN

  SELECT CONST_VALUE FROM GET_CONST_VALUE('FDBF450952CB8E8A40A38BD5122034B3') INTO :S;

  IF (S IS NOT NULL) THEN BEGIN

    D=CURRENT_TIMESTAMP;

    FOR SELECT D.DRIVER_ID, A.PHONE, A.NAME, A.PATRONYMIC, D.MIN_BALANCE, A.FIRM_ID
          FROM DRIVERS D
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
         WHERE A.LOCKED<>1
           AND D.DATE_SCHEDULE IS NOT NULL
           AND D.DATE_SCHEDULE<=CURRENT_DATE
          INTO :DRIVER_ID, :PHONE, :NAME, :PATRONYMIC, :MIN_BALANCE, :FIRM_ID DO BEGIN

      WEEK_DAY=EXTRACT(WEEKDAY FROM CURRENT_TIMESTAMP)-1;
      IF (WEEK_DAY<0) THEN
        WEEK_DAY=6;

      DAY_HOUR=EXTRACT(HOUR FROM CURRENT_TIMESTAMP)+1;
      IF (DAY_HOUR>23) THEN BEGIN
        DAY_HOUR=0;
        WEEK_DAY=WEEK_DAY+1;
        IF (WEEK_DAY>6) THEN
          WEEK_DAY=0;
      END

      SELECT COUNT(*)
        FROM DRIVER_WEEK_SCHEDULES
       WHERE WEEK_DAY=:WEEK_DAY
         AND DAY_HOUR=:DAY_HOUR
         AND DRIVER_ID=:DRIVER_ID
        INTO :CNT;

      IF (CNT>0) THEN BEGIN

        SELECT COUNT(*)
          FROM SHIFTS
         WHERE DATE_END IS NULL
           AND ACCOUNT_ID=:DRIVER_ID
           AND DATE_BEGIN<=CURRENT_TIMESTAMP
          INTO :CNT;

        IF (CNT=0) THEN BEGIN

          EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(DRIVER_ID)
           RETURNING_VALUES SUM_CHARGE, SUM_RECEIPT, BALANCE;

          EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL,PHONE)
           RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

          IF (((MIN_BALANCE IS NULL) OR ((MIN_BALANCE IS NOT NULL) AND (BALANCE>MIN_BALANCE))) AND
             (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

            DTIME=CAST((CAST(DAY_HOUR AS VARCHAR(2))||':00') AS TIME);

            S1=S;
            S1=REPLACE_STRING(S1,'%NAME',NAME);
            S1=REPLACE_STRING(S1,'%PATRONYMIC',PATRONYMIC);
            S1=REPLACE_STRING(S1,'%TIME',FORMAT_DATETIME('hh:nn',DTIME));

            INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                      TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                      LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                              VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                      :S1,NULL,:TYPE_MESSAGE,:PHONE,NULL,1,
                                      NULL,:D,:DEST_PORT,:FIRM_ID);

            D=D+5*(1e0/24/60/60);

          END

        END

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE U_ORDER 
(
    SESSION_ID VARCHAR(32),
    ORDER_ID VARCHAR(32),
    ACTION_ID VARCHAR(32),
    RATE_ID VARCHAR(32),
    CAR_TYPE_ID VARCHAR(32),
    WHO_ACCEPT_ID VARCHAR(32),
    STREET_ID VARCHAR(32),
    ZONE_ID VARCHAR(32),
    PARENT_ID VARCHAR(32),
    CAR_ID VARCHAR(32),
    WHO_PROCESS_ID VARCHAR(32),
    RESULT_ID VARCHAR(32),
    PARK_ID VARCHAR(32),
    SOURCE_ID VARCHAR(32),
    DISCOUNT_ID VARCHAR(32),
    DRIVER_ID VARCHAR(32),
    ORDER_NUM VARCHAR(10),
    PHONE VARCHAR(100),
    HOUSE VARCHAR(10),
    FLAT VARCHAR(10),
    PORCH VARCHAR(10),
    DATE_ACCEPT TIMESTAMP,
    DATE_ARRIVAL TIMESTAMP,
    DATE_BEGIN TIMESTAMP,
    DATE_END TIMESTAMP,
    CUSTOMER VARCHAR(250),
    DESCRIPTION VARCHAR(250),
    COST_RATE NUMERIC(18,2),
    COST_FACT NUMERIC(18,2),
    TYPE_ACCEPT INTEGER,
    TYPE_PROCESS INTEGER,
    DATE_HISTORY TIMESTAMP,
    WHO_HISTORY_ID VARCHAR(32),
    BEFORE_PERIOD INTEGER,
    FINISHED INTEGER,
    LOCKED VARCHAR(32),
    CLIENT_ID VARCHAR(32),
    COST_GROSS NUMERIC(18,2),
    FIRM_ID VARCHAR(32),
    OLD_ORDER_ID VARCHAR(32))
AS
DECLARE VARIABLE RECIPIENT_ID VARCHAR(32);
DECLARE VARIABLE OLD_COST_RATE NUMERIC(15,2);
DECLARE VARIABLE S VARCHAR(70);
DECLARE VARIABLE TYPE_MESSAGE INTEGER;
DECLARE VARIABLE DEST_PORT INTEGER;
BEGIN
  UPDATE ORDERS
     SET ORDER_ID=:ORDER_ID,
         ACTION_ID=:ACTION_ID,
         RATE_ID=:RATE_ID,
         CAR_TYPE_ID=:CAR_TYPE_ID,
         WHO_ACCEPT_ID=:WHO_ACCEPT_ID,
         STREET_ID=:STREET_ID,
         ZONE_ID=:ZONE_ID,
         PARENT_ID=:PARENT_ID,
         CAR_ID=:CAR_ID,
         WHO_PROCESS_ID=:WHO_PROCESS_ID,
         RESULT_ID=:RESULT_ID,
         PARK_ID=:PARK_ID,
         SOURCE_ID=:SOURCE_ID,
         DISCOUNT_ID=:DISCOUNT_ID,
         DRIVER_ID=:DRIVER_ID,
         ORDER_NUM=:ORDER_NUM,
         PHONE=:PHONE,
         HOUSE=:HOUSE,
         FLAT=:FLAT,
         PORCH=:PORCH,
         DATE_ACCEPT=:DATE_ACCEPT,
         DATE_ARRIVAL=:DATE_ARRIVAL,
         DATE_BEGIN=:DATE_BEGIN,
         DATE_END=:DATE_END,
         CUSTOMER=:CUSTOMER,
         DESCRIPTION=:DESCRIPTION,
         COST_RATE=:COST_RATE,
         COST_FACT=:COST_FACT,
         TYPE_ACCEPT=:TYPE_ACCEPT,
         TYPE_PROCESS=:TYPE_PROCESS,
         DATE_HISTORY=:DATE_HISTORY,
         WHO_HISTORY_ID=:WHO_HISTORY_ID,
         BEFORE_PERIOD=:BEFORE_PERIOD,
         FINISHED=:FINISHED,
         LOCKED=:LOCKED,
         CLIENT_ID=:CLIENT_ID,
         COST_GROSS=:COST_GROSS,
         FIRM_ID=:FIRM_ID
   WHERE ORDER_ID=:OLD_ORDER_ID;

  OLD_COST_RATE=NULL;

  FOR SELECT COST_RATE
        FROM ORDERS
       WHERE PARENT_ID=:OLD_ORDER_ID
         AND DATE_HISTORY IS NOT NULL
       ORDER BY DATE_HISTORY DESC
        INTO :OLD_COST_RATE DO BEGIN

    IF (OLD_COST_RATE IS NOT NULL) THEN
      BREAK;

  END

  IF ((COST_RATE IS NOT NULL) AND (OLD_COST_RATE<>COST_RATE) AND (WHO_PROCESS_ID IS NOT NULL)) THEN BEGIN

    /*IF (SUBSTR(PHONE,1,3)='+79')  THEN BEGIN */

    IF (PHONE IS NOT NULL)  THEN BEGIN

      RECIPIENT_ID=NULL;

      FOR SELECT ACCOUNT_ID
            FROM ACCOUNTS
           WHERE PHONE=:PHONE
            INTO :RECIPIENT_ID DO BEGIN

        IF (RECIPIENT_ID IS NOT NULL) THEN
          BREAK;
      END

      SELECT CONST_VALUE FROM GET_CONST_VALUE('6F6E5F38806C896B43AC16E69914EFFA') INTO :S;

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(RECIPIENT_ID,NULL,PHONE)
       RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

      IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        S=REPLACE_STRING(S,'%COST_RATE',CAST(COST_RATE AS VARCHAR(30)));

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                  PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:WHO_PROCESS_ID,:RECIPIENT_ID,CURRENT_TIMESTAMP,
                                  :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                  1,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
      END

    END

    SELECT PHONE
      FROM ACCOUNTS A
     WHERE A.ACCOUNT_ID=:DRIVER_ID
      INTO :PHONE;

  /*  IF (SUBSTR(PHONE,1,3)='+79')  THEN BEGIN */

    IF (PHONE IS NOT NULL) THEN BEGIN

      SELECT CONST_VALUE FROM GET_CONST_VALUE('10E46E5108A9AB374B14C0AA98FDC830') INTO :S;

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL,PHONE)
       RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

      IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        S=REPLACE_STRING(S,'%COST_RATE',CAST(COST_RATE AS VARCHAR(30)));

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                  PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:WHO_PROCESS_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                  :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                  1,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);

      END
    END

  END

END

--

ALTER TABLE CONSTS
ADD ENABLED INTEGER

--

CREATE OR ALTER VIEW S_CONSTS
AS
SELECT * FROM CONSTS

--

CREATE OR ALTER PROCEDURE I_CONST
(
  NAME VARCHAR(100),
  DESCRIPTION VARCHAR(250),
  "VALUE" BLOB,
  ENABLED INTEGER
)
AS
BEGIN
  INSERT INTO CONSTS (NAME,DESCRIPTION,"VALUE",ENABLED)
       VALUES (:NAME,:DESCRIPTION,:"VALUE",:ENABLED);
END

--

CREATE OR ALTER PROCEDURE U_CONST
(
  NAME VARCHAR(100),
  DESCRIPTION VARCHAR(250),
  "VALUE" BLOB,
  ENABLED INTEGER,
  OLD_NAME VARCHAR(100)
)
AS
BEGIN
  UPDATE CONSTS
     SET NAME=:NAME,
         DESCRIPTION=:DESCRIPTION,
         "VALUE"=:"VALUE",
         ENABLED=:ENABLED
   WHERE NAME=:OLD_NAME;
END

--

CREATE OR ALTER PROCEDURE GET_CONST_VALUE
(
  CONST_NAME VARCHAR(100)
)
RETURNS
(
  CONST_VALUE VARCHAR(4000)
)
AS
BEGIN
  CONST_VALUE=NULL;
  FOR SELECT SUBSTRING("VALUE" FROM 1 FOR 1000)
        FROM CONSTS
       WHERE UPPER(NAME)=UPPER(:CONST_NAME)
         AND ENABLED=1
        INTO :CONST_VALUE DO BEGIN
    BREAK;
  END
  SUSPEND;
END

--

UPDATE CONSTS
SET ENABLED=1

--

CREATE OR ALTER PROCEDURE INCOMING_GRANTED
(
    ACCOUNT_ID VARCHAR(32),
    TYPE_MESSAGE INTEGER
)
RETURNS (
    GRANTED INTEGER)
AS
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE IN_MESSAGE INTEGER;
DECLARE VARIABLE IN_QUERY INTEGER;
DECLARE VARIABLE IN_CALL INTEGER;
BEGIN
  GRANTED=1;

  SELECT COUNT(*)
    FROM DRIVERS
   WHERE DRIVER_ID=:ACCOUNT_ID
    INTO :CNT;

  IF (CNT>0) THEN BEGIN

    SELECT M.IN_MESSAGE, M.IN_QUERY, M.IN_CALL
      FROM DRIVERS D
      LEFT JOIN METHODS M ON M.METHOD_ID=D.METHOD_ID
     WHERE D.DRIVER_ID=:ACCOUNT_ID
      INTO :IN_MESSAGE, :IN_QUERY, :IN_CALL;

    IF ((TYPE_MESSAGE=0) AND (IN_MESSAGE IS NOT NULL)) THEN
      GRANTED=IN_MESSAGE;

    IF ((TYPE_MESSAGE=1) AND (IN_QUERY IS NOT NULL)) THEN
      GRANTED=IN_QUERY;

    IF ((TYPE_MESSAGE=2) AND (IN_CALL IS NOT NULL)) THEN
      GRANTED=IN_CALL;

  END ELSE BEGIN

    SELECT COUNT(*)
      FROM CLIENTS
     WHERE CLIENT_ID=:ACCOUNT_ID
      INTO :CNT;

    IF (CNT>0) THEN BEGIN

      SELECT M.IN_MESSAGE, M.IN_QUERY, M.IN_CALL
        FROM CLIENTS C
        LEFT JOIN METHODS M ON M.METHOD_ID=C.METHOD_ID
       WHERE C.CLIENT_ID=:ACCOUNT_ID
        INTO :IN_MESSAGE, :IN_QUERY, :IN_CALL;

      IF ((TYPE_MESSAGE=0) AND (IN_MESSAGE IS NOT NULL)) THEN
        GRANTED=IN_MESSAGE;

      IF ((TYPE_MESSAGE=1) AND (IN_QUERY IS NOT NULL)) THEN
        GRANTED=IN_QUERY;

      IF ((TYPE_MESSAGE=2) AND (IN_CALL IS NOT NULL)) THEN
        GRANTED=IN_CALL;

    END

  END

END

--

CREATE OR ALTER PROCEDURE CONVERT_PHONE 
(
    IN_PHONE VARCHAR(100),
    KIND INTEGER)
RETURNS (
    OUT_PHONE VARCHAR(100))
AS
DECLARE VARIABLE S1 VARCHAR(100);
DECLARE VARIABLE L2 INTEGER;
DECLARE VARIABLE S2 VARCHAR(100);
DECLARE VARIABLE S3 VARCHAR(100);
DECLARE VARIABLE IN_PHONE_NUM BIGINT;
DECLARE VARIABLE CONVERSIONS VARCHAR(32000);
DECLARE VARIABLE CONVERSION VARCHAR(1000);
DECLARE VARIABLE CONVERSION_FIRST VARCHAR(100);
DECLARE VARIABLE CONVERSION_SECOND VARCHAR(100);
DECLARE VARIABLE POS INTEGER;
DECLARE VARIABLE POS2 INTEGER;
DECLARE VARIABLE RANGE_MIN BIGINT;
DECLARE VARIABLE RANGE_MAX BIGINT;
DECLARE VARIABLE FLAG INTEGER;
BEGIN

  OUT_PHONE=IN_PHONE;
  FLAG=0;

  IF (IN_PHONE IS NOT NULL) THEN BEGIN
    IN_PHONE=TRIM(REPLACE_STRING(IN_PHONE,'+',''));
    IN_PHONE_NUM=CAST(IN_PHONE AS BIGINT);

    FOR SELECT CAST(BLOB_TO_STRING(CONVERSIONS,1,32000) AS VARCHAR(32000))
          FROM OPERATORS
         WHERE ENABLED=1
         ORDER BY PRIORITY
          INTO :CONVERSIONS DO BEGIN

      IF (CONVERSIONS IS NOT NULL) THEN BEGIN

        POS=-1;
        WHILE (POS<>0) DO BEGIN

          POS=POSITION(CHR(13)||CHR(10),CONVERSIONS);
          IF (POS>0) THEN BEGIN
            CONVERSION=SUB_STRING(CONVERSIONS,1,POS-1);
            CONVERSIONS=SUB_STRING(CONVERSIONS,POS+2,32000);
          END ELSE
            CONVERSION=SUB_STRING(CONVERSIONS,1,1000);

          POS2=POSITION('=',CONVERSION);
          IF (POS2>0) THEN BEGIN
            CONVERSION_FIRST=SUB_STRING(CONVERSION,1,POS2-1);
            CONVERSION_SECOND=SUB_STRING(CONVERSION,POS2+1,100);

            IF ((CONVERSION_FIRST IS NOT NULL) AND
                (TRIM(CONVERSION_FIRST)<>'') AND
                (CONVERSION_SECOND IS NOT NULL) AND
                (TRIM(CONVERSION_SECOND)<>'')) THEN BEGIN

              IF (KIND=0) THEN
                CONVERSION=CONVERSION_SECOND;
              ELSE
                CONVERSION=CONVERSION_FIRST;

              EXECUTE PROCEDURE GET_RANGE(CONVERSION)
               RETURNING_VALUES RANGE_MIN, RANGE_MAX;

              IF ((IN_PHONE_NUM>=RANGE_MIN) AND (IN_PHONE_NUM<=RANGE_MAX)) THEN BEGIN

                FLAG=1;

                IF (KIND=0) THEN
                  OUT_PHONE=CONVERSION_FIRST;
                ELSE
                  OUT_PHONE=CONVERSION_SECOND;

                S1=REVERSE(OUT_PHONE);
                S2=REVERSE(IN_PHONE);
                L2=STRING_LENGTH(S2);
                S3='';

                POS2=-1;
                WHILE (POS2<>0) DO BEGIN

                  POS2=POSITION('*',S1);
                  IF ((POS2>0) AND (POS2<=L2)) THEN BEGIN
                    S3=S3||SUB_STRING(S2,POS2,1);
                    S1=S3||SUB_STRING(S1,POS2+1,100);
                  END ELSE
                    BREAK;

                END

                OUT_PHONE=REVERSE(S1);

                BREAK;
              END

            END

          END

        END

      END

      IF (FLAG=1) THEN BEGIN
        BREAK;
      END

    END

  END
END

--

CREATE OR ALTER PROCEDURE INCOMING_CALL_CHECK 
(
    CALLER_PHONE VARCHAR(100),
    CALLER_DIVERSION VARCHAR(100),
    CHANNEL VARCHAR(100))
RETURNS (
    ACCOUNT_ID VARCHAR(32),
    NAME VARCHAR(100),
    PATRONYMIC VARCHAR(100),
    PHONE VARCHAR(100),
    OPERATOR_ID VARCHAR(32),
    FIRM_ID VARCHAR(32),
    SCENARIO_NAME VARCHAR(100),
    CHECKED INTEGER)
AS
DECLARE CNT INTEGER;
DECLARE RANGE_MIN BIGINT;
DECLARE RANGE_MAX BIGINT;
DECLARE PHONE_NUM BIGINT;
DECLARE L INTEGER;
DECLARE CLIENT_APP_ID VARCHAR(32) = 'A35F5701A7AA920E40812A71A690910D';
DECLARE DISPATCHERS_ROLE_ID VARCHAR(32) = 'FF7F332564F795C8411BF28652B22BEA';
DECLARE ALARM_ACCOUNT_ID VARCHAR(32) = '077D307B5B4D85754003331FE72C94B8';
BEGIN
  CHECKED=0;

  FIRM_ID='C49DF004D660BBAF434839044848F5B8'; /* АТАКСИ */

  SCENARIO_NAME='2777787';

  IF (CALLER_DIVERSION IS NOT NULL) THEN BEGIN

    IF (CALLER_DIVERSION='3912550550') THEN
      SCENARIO_NAME='2550550';

  END

  IF ((CALLER_PHONE IS NOT NULL) /*AND (CALLER_PHONE<>'Anonymous')*/) THEN BEGIN

    PHONE=CALLER_PHONE;

    EXECUTE PROCEDURE TRANSFORM_PHONE (PHONE)
     RETURNING_VALUES PHONE;

    EXECUTE PROCEDURE CONVERT_PHONE(PHONE,0)
     RETURNING_VALUES PHONE;

    EXECUTE PROCEDURE GET_OPERATOR (PHONE)
     RETURNING_VALUES OPERATOR_ID, RANGE_MIN, RANGE_MAX, PHONE_NUM;


    FOR SELECT A.ACCOUNT_ID, A.NAME, A.PATRONYMIC
          FROM CLIENTS C
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=C.CLIENT_ID
          LEFT JOIN CLIENT_PHONES CP ON CP.CLIENT_ID=C.CLIENT_ID
         WHERE CP.PHONE=:PHONE
            OR A.PHONE=:PHONE
          INTO :ACCOUNT_ID, :NAME, :PATRONYMIC DO BEGIN
      BREAK;
    END

    IF (ACCOUNT_ID IS NULL) THEN BEGIN

      FOR SELECT A.ACCOUNT_ID, A.NAME, A.PATRONYMIC
            FROM ACCOUNTS A
           WHERE A.PHONE=:PHONE
            INTO :ACCOUNT_ID, :NAME, :PATRONYMIC DO BEGIN
        BREAK;
      END

    END

    SELECT COUNT(*)
      FROM BLACKS
     WHERE PHONE=:PHONE
      INTO :CNT;

    IF (CNT=0) THEN BEGIN

      CHECKED=1;

      SELECT COUNT(*)
        FROM SESSIONS
       WHERE APPLICATION_ID=:CLIENT_APP_ID /* Такси клиент*/
         AND ACCOUNT_ID IN (SELECT ACCOUNT_ID
                              FROM ACCOUNT_ROLES
                             WHERE ROLE_ID=:DISPATCHERS_ROLE_ID)
         AND CAST(CONFIG_READ(PARAMS,'TaxiPhoneForm','Enabled','0') AS INTEGER)=1
        INTO :CNT;

      IF (CNT = 0) THEN BEGIN

        IN AUTONOMOUS TRANSACTION DO BEGIN

          INSERT INTO ALARMS (ALARM_ID,SENDER_ID,RECIPIENT_ID,TYPE_ALARM,
                              DATE_BEGIN,DATE_END,
                              CAPTION,TEXT_ALARM)
                      VALUES (GET_UNIQUE_ID(),:ALARM_ACCOUNT_ID,:DISPATCHERS_ROLE_ID,1,
                              CURRENT_TIMESTAMP,DATEADD(SECOND,10,CURRENT_TIMESTAMP),
                              'Включите софтфон!','Идут входящие вызовы. Включите софтфон!');
        END

        EXECUTE PROCEDURE EVENT_ALARM(:CLIENT_APP_ID,NULL,NULL,0)
         RETURNING_VALUES :CNT;

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE OUTGOING_CALL_CHECK 
(
    CALLER_ID VARCHAR(32),
    ACCEPTOR_PHONE VARCHAR(100))
RETURNS (
    ACCOUNT_ID VARCHAR(32),
    PHONE VARCHAR(100),
    OPERATOR_ID VARCHAR(32),
    FIRM_ID VARCHAR(32),
    CHECKED INTEGER)
AS
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE RANGE_MIN BIGINT;
DECLARE VARIABLE RANGE_MAX BIGINT;
DECLARE VARIABLE PHONE_NUM BIGINT;
BEGIN
  CHECKED=0;

  SELECT FIRST 1
         FIRM_ID
    FROM ACCOUNTS
   WHERE ACCOUNT_ID=:CALLER_ID
    INTO :FIRM_ID;

  IF (ACCEPTOR_PHONE IS NOT NULL) THEN BEGIN

    PHONE=ACCEPTOR_PHONE;

    EXECUTE PROCEDURE TRANSFORM_PHONE (PHONE)
     RETURNING_VALUES PHONE;

    EXECUTE PROCEDURE CONVERT_PHONE (PHONE,1)
     RETURNING_VALUES PHONE;

    EXECUTE PROCEDURE GET_OPERATOR (PHONE)
     RETURNING_VALUES OPERATOR_ID, RANGE_MIN, RANGE_MAX, PHONE_NUM;

    SELECT FIRST 1
           ACCOUNT_ID
      FROM ACCOUNTS
     WHERE PHONE=:PHONE
      INTO :ACCOUNT_ID;

    IF (ACCOUNT_ID IS NULL) THEN BEGIN

      SELECT FIRST 1
             CLIENT_ID
        FROM CLIENT_PHONES
       WHERE PHONE=:PHONE
        INTO :ACCOUNT_ID;

    END

    CHECKED=1;

  END

END

--

UPDATE OPERATORS
   SET ENABLED=0
 WHERE OPERATOR_ID='364187C713159CEB432F057FE034FBA6'

--

CREATE OR ALTER PROCEDURE LOCK_OUT_MESSAGES
(
  MAX_COUNT INTEGER,
  LOCKED VARCHAR(32),
  TYPE_MESSAGE INTEGER,
  PERIOD INTEGER,
  CHANNEL VARCHAR(100),
  OPERATOR_ID VARCHAR(32)
)
RETURNS
(
  LOCK_COUNT INTEGER
)
AS
DECLARE OUT_MESSAGE_ID VARCHAR(32);
DECLARE CONTACT VARCHAR(100);
DECLARE NEW_OPERATOR_ID VARCHAR(32);
DECLARE LCONTACT INTEGER;
DECLARE FLAG INTEGER;
DECLARE FEDERAL INTEGER=12;
DECLARE LOCAL INTEGER=7;
BEGIN
  LOCK_COUNT=0;

  IF (TYPE_MESSAGE IN (0,2)) THEN BEGIN

    DELETE FROM TMP_OPERATORS;
    INSERT INTO TMP_OPERATORS (RANGE_MIN,RANGE_MAX,OPERATOR_ID)
    SELECT RANGE_MIN,RANGE_MAX,OPERATOR_ID
      FROM GET_OPERATORS;

    FOR SELECT DISTINCT(T2.OUT_MESSAGE_ID), T2.OPERATOR_ID, T2.CONTACT, T2.LCONTACT
          FROM (SELECT T.OUT_MESSAGE_ID, O.OPERATOR_ID, T.CONTACT, T.LCONTACT
                  FROM (SELECT OUT_MESSAGE_ID,
                               CAST(TRIM(REPLACE_STRING(CONTACT,'+','')) AS BIGINT) AS NUM,
                               CONTACT,
                               STRING_LENGTH(CONTACT) AS LCONTACT
                          FROM OUT_MESSAGES
                         WHERE DATE_OUT IS NULL
                           AND LOCKED IS NULL
                           AND TYPE_MESSAGE=:TYPE_MESSAGE
                           AND DATE_BEGIN<=CURRENT_TIMESTAMP
                           AND ((DATE_END IS NOT NULL AND DATE_END>=CURRENT_TIMESTAMP) OR
                                (DATE_END IS NULL AND DATEADD(SECOND,:PERIOD,DATE_BEGIN)>=CURRENT_TIMESTAMP))
                         ORDER BY PRIORITY, DATE_BEGIN) T
                  LEFT JOIN TMP_OPERATORS O ON O.RANGE_MIN<=T.NUM AND O.RANGE_MAX>=T.NUM) T2
         WHERE (T2.OPERATOR_ID=:OPERATOR_ID AND :OPERATOR_ID IS NOT NULL)
            OR (T2.OPERATOR_ID IS NULL AND :OPERATOR_ID IS NULL)
            OR (T2.OPERATOR_ID IS NOT NULL AND :OPERATOR_ID IS NULL)
          ROWS :MAX_COUNT
          INTO :OUT_MESSAGE_ID, :NEW_OPERATOR_ID, :CONTACT, :LCONTACT DO BEGIN

      FLAG=0;

      IF (TYPE_MESSAGE=0) THEN BEGIN

        IF (LCONTACT=LOCAL) THEN BEGIN

          EXECUTE PROCEDURE CONVERT_PHONE(CONTACT,0)
           RETURNING_VALUES CONTACT;

          LCONTACT=STRING_LENGTH(CONTACT);

        END

        IF ((LCONTACT=FEDERAL) AND (SUB_STRING(CONTACT,1,3)='+79')) THEN
          FLAG=1;

      END

      IF (TYPE_MESSAGE=2) THEN BEGIN

        IF (LCONTACT=FEDERAL) THEN BEGIN

          EXECUTE PROCEDURE CONVERT_PHONE(CONTACT,1)
           RETURNING_VALUES CONTACT;

          LCONTACT=STRING_LENGTH(CONTACT);
        END

        IF ((LCONTACT=LOCAL) AND (SUB_STRING(CONTACT,1,1)='2')) THEN
          FLAG=1;

      END

      IF (FLAG=1) THEN BEGIN

        UPDATE OUT_MESSAGES
           SET LOCKED=:LOCKED,
               CHANNEL=:CHANNEL,
               OPERATOR_ID=:NEW_OPERATOR_ID
         WHERE OUT_MESSAGE_ID=:OUT_MESSAGE_ID;

        LOCK_COUNT=LOCK_COUNT+1;
      END

    END
  END
END

--

CREATE OR ALTER PROCEDURE GET_CALL_INFO 
(
    CALL_INFO VARCHAR(100))
RETURNS (
    CALL_ACCOUNT_ID VARCHAR(32),
    CALL_NAME VARCHAR(100),
    CALL_REAL_NAME VARCHAR(100),
    CALL_GROUP VARCHAR(4000),
    CALL_DESCRIPTION VARCHAR(250),
    CALL_NAME_DESCRIPTION VARCHAR(250),
    CALL_LINE_NAME VARCHAR(100))
AS
DECLARE VARIABLE CALL_ID VARCHAR(32);
DECLARE VARIABLE OPERATOR_ID VARCHAR(32);
DECLARE VARIABLE CALL_PHONE VARCHAR(100);
DECLARE VARIABLE CALLER_DIVERSION VARCHAR(100);
DECLARE VARIABLE IN_CHANNEL VARCHAR(100);
DECLARE VARIABLE PHONE VARCHAR(100);
DECLARE VARIABLE USER_NAME VARCHAR(100);
DECLARE VARIABLE SURNAME VARCHAR(100);
DECLARE VARIABLE NAME VARCHAR(100);
DECLARE VARIABLE PATRONYMIC VARCHAR(100);
DECLARE VARIABLE FIRM_SMALL_NAME VARCHAR(250);
DECLARE VARIABLE CLIENT_GROUP_ID VARCHAR(32);
DECLARE VARIABLE CALL_KIND INTEGER;
DECLARE VARIABLE S VARCHAR(250);
DECLARE VARIABLE L INTEGER;
DECLARE VARIABLE RANGE_MIN BIGINT;
DECLARE VARIABLE RANGE_MAX BIGINT;
DECLARE VARIABLE PHONE_NUM BIGINT;
BEGIN
  CALL_ACCOUNT_ID=NULL;
  CALL_REAL_NAME='Номер скрыт';
  CALL_GROUP='Неизвестно';
  CALL_DESCRIPTION=NULL;
  CALL_KIND=0; /* Unknown */
  CALL_NAME_DESCRIPTION=NULL;
  CALL_LINE_NAME=NULL;

  SELECT C.CALL_ID, C.CALLER_ID, C.CALLER_PHONE,
         C.CALLER_DIVERSION, C.IN_CHANNEL, O.NAME
    FROM CALLS C
    LEFT JOIN OPERATORS O ON O.OPERATOR_ID=C.OPERATOR_ID
   WHERE CALL_ID=:CALL_INFO
    INTO :CALL_ID, :CALL_ACCOUNT_ID, :CALL_PHONE,
         :CALLER_DIVERSION, :IN_CHANNEL, :CALL_NAME_DESCRIPTION;

  IF (CALL_ID IS NOT NULL) THEN BEGIN

    IF (IN_CHANNEL IS NOT NULL) THEN BEGIN

      IN_CHANNEL=SUB_STRING(IN_CHANNEL,STRING_LENGTH('CallServerSipChannel')+1,STRING_LENGTH(IN_CHANNEL));

      CALL_LINE_NAME=IN_CHANNEL;

    END

    IF (CALLER_DIVERSION IS NOT NULL) THEN BEGIN

      IF (CALLER_DIVERSION='3912777787') THEN
        CALL_LINE_NAME='2777787';

      IF (CALLER_DIVERSION='3912550550') THEN
        CALL_LINE_NAME='2550550';

      IF (CALLER_DIVERSION='3912550550') THEN
        CALL_LINE_NAME='2550550';

    END

    IF (CALL_LINE_NAME IS NOT NULL) THEN
      CALL_LINE_NAME=''||CALL_LINE_NAME;

  END ELSE BEGIN

    EXECUTE PROCEDURE GET_OPERATOR(CALL_INFO)
     RETURNING_VALUES OPERATOR_ID, RANGE_MIN, RANGE_MAX, PHONE_NUM;

    IF (OPERATOR_ID IS NOT NULL) THEN
      SELECT NAME
        FROM OPERATORS
       WHERE OPERATOR_ID=:OPERATOR_ID
        INTO :CALL_NAME_DESCRIPTION;

  END

  IF (CALL_ACCOUNT_ID IS NULL) THEN BEGIN

    IF (CALL_PHONE IS NULL) THEN
      CALL_PHONE=:CALL_INFO;

    FOR SELECT A.ACCOUNT_ID
          FROM CLIENTS C
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=C.CLIENT_ID
          LEFT JOIN CLIENT_PHONES CP ON CP.CLIENT_ID=C.CLIENT_ID
         WHERE CP.PHONE=:CALL_PHONE
            OR A.PHONE=:CALL_PHONE
          INTO :CALL_ACCOUNT_ID DO BEGIN
      CALL_KIND=1; /* Client */
      BREAK;
    END

    IF (CALL_ACCOUNT_ID IS NULL) THEN BEGIN

      FOR SELECT A.ACCOUNT_ID
            FROM ACCOUNTS A
            JOIN DRIVERS D ON D.DRIVER_ID=A.ACCOUNT_ID
           WHERE A.PHONE=:CALL_PHONE
            INTO :CALL_ACCOUNT_ID DO BEGIN
        CALL_KIND=2; /* Driver */
        BREAK;
      END

      IF (CALL_ACCOUNT_ID IS NULL) THEN BEGIN

        FOR SELECT A.ACCOUNT_ID
              FROM ACCOUNTS A
              JOIN DISPATCHERS D ON D.DISPATCHER_ID=A.ACCOUNT_ID
             WHERE A.PHONE=:CALL_PHONE
              INTO :CALL_ACCOUNT_ID DO BEGIN
          CALL_KIND=3; /* Dispatcher */
          BREAK;
        END

        IF (CALL_ACCOUNT_ID IS NULL) THEN BEGIN

          FOR SELECT A.ACCOUNT_ID
                FROM ACCOUNTS A
               WHERE A.PHONE=:CALL_PHONE
              INTO :CALL_ACCOUNT_ID DO BEGIN
            CALL_KIND=4; /* Account */
            BREAK;
          END

        END

      END

    END

  END

  CALL_REAL_NAME=TRIM(CALL_PHONE);

  L=STRING_LENGTH(CALL_REAL_NAME);
  IF (L=7) THEN BEGIN
    CALL_NAME=SUB_STRING(CALL_REAL_NAME,1,3)||' '||
              SUB_STRING(CALL_REAL_NAME,4,2)||' '||
              SUB_STRING(CALL_REAL_NAME,6,2);
  END ELSE BEGIN
    IF (L=12) THEN BEGIN
      CALL_NAME=SUB_STRING(CALL_REAL_NAME,1,2)||' '||
                SUB_STRING(CALL_REAL_NAME,3,3)||' '||
                SUB_STRING(CALL_REAL_NAME,6,3)||' '||
                SUB_STRING(CALL_REAL_NAME,9,2)||' '||
                SUB_STRING(CALL_REAL_NAME,11,2);
    END
  END

  IF (CALL_ACCOUNT_ID IS NOT NULL) THEN BEGIN

    IF (CALL_KIND=0) THEN BEGIN

      SELECT CASE
               WHEN C.CLIENT_ID IS NOT NULL THEN 1 /* Client */
               WHEN D1.DRIVER_ID IS NOT NULL THEN 2 /* Driver */
               WHEN D2.DISPATCHER_ID IS NOT NULL THEN 3 /* Dispatcher */
               ELSE 4
             END
        FROM ACCOUNTS A
        LEFT JOIN CLIENTS C ON C.CLIENT_ID=A.ACCOUNT_ID
        LEFT JOIN DRIVERS D1 ON D1.DRIVER_ID=A.ACCOUNT_ID
        LEFT JOIN DISPATCHERS D2 ON D2.DISPATCHER_ID=A.ACCOUNT_ID
       WHERE A.ACCOUNT_ID=:CALL_ACCOUNT_ID
        INTO :CALL_KIND;

    END

    FOR SELECT A.USER_NAME, A.SURNAME, A.NAME,
               A.PATRONYMIC, F.SMALL_NAME
          FROM ACCOUNTS A
          LEFT JOIN FIRMS F ON F.FIRM_ID=A.FIRM_ID
         WHERE A.ACCOUNT_ID=:CALL_ACCOUNT_ID
          INTO :USER_NAME, :SURNAME, :NAME,
               :PATRONYMIC, :FIRM_SMALL_NAME DO BEGIN
      BREAK;
    END

    CALL_DESCRIPTION=NULL;
    IF (NAME IS NOT NULL) THEN
      CALL_DESCRIPTION=TRIM(NAME);
    IF (PATRONYMIC IS NOT NULL) THEN
      CALL_DESCRIPTION=CALL_DESCRIPTION||' '||TRIM(PATRONYMIC);
    IF (USER_NAME IS NOT NULL) THEN
      CALL_DESCRIPTION=TRIM(USER_NAME)||' - '||CALL_DESCRIPTION;
    IF (FIRM_SMALL_NAME IS NOT NULL) THEN
      CALL_DESCRIPTION=CALL_DESCRIPTION||' ['||TRIM(FIRM_SMALL_NAME)||']';

    IF (CALL_KIND=1) THEN BEGIN

      FOR SELECT LOWER(CP.DESCRIPTION)
            FROM CLIENT_PHONES CP
           WHERE CP.PHONE=:CALL_PHONE
             AND CP.CLIENT_ID=:CALL_ACCOUNT_ID
            INTO :S DO BEGIN

        CALL_NAME_DESCRIPTION=TRIM(S||' '||CALL_NAME_DESCRIPTION);
        BREAK;
      END

      CLIENT_GROUP_ID=NULL;

      SELECT CLIENT_GROUP_ID
        FROM CLIENTS
       WHERE CLIENT_ID=:CALL_ACCOUNT_ID
        INTO :CLIENT_GROUP_ID;

      IF (CLIENT_GROUP_ID IS NOT NULL) THEN BEGIN

        CALL_GROUP=NULL;

        EXECUTE PROCEDURE GET_CLIENT_GROUP_PATH(CLIENT_GROUP_ID,'/')
         RETURNING_VALUES CALL_GROUP;

      END

      IF (CALL_GROUP IS NOT NULL) THEN
        CALL_GROUP='Клиенты/'||CALL_GROUP;
      ELSE
        CALL_GROUP='Клиенты';


    END ElSE BEGIN

      IF (CALL_KIND=2) THEN BEGIN

        CALL_GROUP='Водители';

      END ELSE BEGIN

        IF (CALL_KIND=3) THEN
          CALL_GROUP='Диспетчеры';
        ElSE
          CALL_GROUP='Учетные записи';

      END

    END

  END

END

--

ALTER TABLE OUT_MESSAGES
ADD ATTEMPTS INTEGER

--

CREATE OR ALTER VIEW S_OUT_MESSAGES
AS
SELECT OM.*,
       A1.USER_NAME AS CREATOR_NAME,
       A2.USER_NAME AS RECIPIENT_USER_NAME,
       A2.SURNAME AS RECIPIENT_SURNAME,
       A2.NAME AS RECIPIENT_NAME,
       A2.PATRONYMIC AS RECIPIENT_PATRONYMIC,
       A2.PHONE AS RECIPIENT_PHONE,
       A2.EMAIL AS RECIPIENT_EMAIL,
       F.SMALL_NAME AS FIRM_SMALL_NAME,
       O.NAME AS OPERATOR_NAME
  FROM OUT_MESSAGES OM
  JOIN ACCOUNTS A1 ON A1.ACCOUNT_ID=OM.CREATOR_ID
  LEFT JOIN ACCOUNTS A2 ON A2.ACCOUNT_ID=OM.RECIPIENT_ID
  LEFT JOIN FIRMS F ON F.FIRM_ID=OM.FIRM_ID
  LEFT JOIN OPERATORS O ON O.OPERATOR_ID=OM.OPERATOR_ID

--

CREATE OR ALTER VIEW S_DRIVER_OUT_MESSAGES
AS
SELECT OM.*,
       A1.USER_NAME AS CREATOR_NAME,
       A2.USER_NAME AS RECIPIENT_USER_NAME,
       A2.SURNAME AS RECIPIENT_SURNAME,
       A2.NAME AS RECIPIENT_NAME,
       A2.PATRONYMIC AS RECIPIENT_PATRONYMIC,
       A2.PHONE AS RECIPIENT_PHONE,
       A2.EMAIL AS RECIPIENT_EMAIL,
       CR.STATE_NUM AS CAR_STATE_NUM,
       CR.BRAND AS CAR_BRAND,
       CR.COLOR AS CAR_COLOR,
       CR.CALLSIGN AS CAR_CALLSIGN,
       F.SMALL_NAME AS FIRM_SMALL_NAME,
       O.NAME AS OPERATOR_NAME
  FROM OUT_MESSAGES OM
  JOIN DRIVERS D ON D.DRIVER_ID=OM.RECIPIENT_ID
  JOIN CARS CR ON CR.CAR_ID=D.CAR_ID
  JOIN ACCOUNTS A1 ON A1.ACCOUNT_ID=OM.CREATOR_ID
  LEFT JOIN ACCOUNTS A2 ON A2.ACCOUNT_ID=OM.RECIPIENT_ID
  LEFT JOIN FIRMS F ON F.FIRM_ID=OM.FIRM_ID
  LEFT JOIN OPERATORS O ON O.OPERATOR_ID=OM.OPERATOR_ID

--

CREATE OR ALTER PROCEDURE I_OUT_MESSAGE
(
    OUT_MESSAGE_ID VARCHAR(32),
    CREATOR_ID VARCHAR(32),
    RECIPIENT_ID VARCHAR(32),
    DATE_CREATE TIMESTAMP,
    TEXT_OUT VARCHAR(4000),
    DATE_OUT TIMESTAMP,
    TYPE_MESSAGE INTEGER,
    CONTACT VARCHAR(100),
    DESCRIPTION VARCHAR(250),
    PRIORITY INTEGER,
    LOCKED VARCHAR(32),
    DATE_BEGIN TIMESTAMP,
    DATE_END TIMESTAMP,
    ORDER_ID VARCHAR(32),
    CHANNEL VARCHAR(100),
    DELIVERY INTEGER,
    DATE_DELIVERY TIMESTAMP,
    FLASH INTEGER,
    DEST_PORT INTEGER,
    FIRM_ID VARCHAR(32),
    OPERATOR_ID VARCHAR(32),
    MESSAGE_ID VARCHAR(100),
    SOURCE VARCHAR(100),
    ATTEMPTS INTEGER
)
AS
DECLARE TM INTEGER;
DECLARE DP INTEGER;
BEGIN

  TM=TYPE_MESSAGE;
  DP=DEST_PORT;

  if (DEST_PORT IS NULL) then
    EXECUTE PROCEDURE GET_TYPE_MESSAGE(:RECIPIENT_ID,TM,CONTACT)
     RETURNING_VALUES TM, DP;

  INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                            TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                            PRIORITY,DATE_BEGIN,DATE_END,ORDER_ID,CHANNEL,
                            DELIVERY,DATE_DELIVERY,FLASH,DEST_PORT,FIRM_ID,OPERATOR_ID,
                            MESSAGE_ID,SOURCE,ATTEMPTS)
       VALUES (:OUT_MESSAGE_ID,:CREATOR_ID,:RECIPIENT_ID,:DATE_CREATE,
               :TEXT_OUT,:DATE_OUT,:TM,:CONTACT,:DESCRIPTION,
               :PRIORITY,:DATE_BEGIN,:DATE_END,:ORDER_ID,:CHANNEL,
               :DELIVERY,:DATE_DELIVERY,:FLASH,:DP,:FIRM_ID,:OPERATOR_ID,
               :MESSAGE_ID,:SOURCE,:ATTEMPTS);
END

--

CREATE OR ALTER PROCEDURE U_OUT_MESSAGE
(
    OUT_MESSAGE_ID VARCHAR(32),
    CREATOR_ID VARCHAR(32),
    RECIPIENT_ID VARCHAR(32),
    DATE_CREATE TIMESTAMP,
    TEXT_OUT VARCHAR(4000),
    DATE_OUT TIMESTAMP,
    TYPE_MESSAGE INTEGER,
    CONTACT VARCHAR(100),
    DESCRIPTION VARCHAR(250),
    PRIORITY INTEGER,
    LOCKED VARCHAR(32),
    DATE_BEGIN TIMESTAMP,
    DATE_END TIMESTAMP,
    ORDER_ID VARCHAR(32),
    CHANNEL VARCHAR(100),
    DELIVERY INTEGER,
    DATE_DELIVERY TIMESTAMP,
    FLASH INTEGER,
    DEST_PORT INTEGER,
    FIRM_ID VARCHAR(32),
    OPERATOR_ID VARCHAR(32),
    MESSAGE_ID VARCHAR(100),
    SOURCE VARCHAR(100),
    ATTEMPTS INTEGER,
    OLD_OUT_MESSAGE_ID VARCHAR(32)
)
AS
BEGIN
  UPDATE OUT_MESSAGES
     SET OUT_MESSAGE_ID=:OUT_MESSAGE_ID,
         CREATOR_ID=:CREATOR_ID,
         RECIPIENT_ID=:RECIPIENT_ID,
         DATE_CREATE=:DATE_CREATE,
         TEXT_OUT=:TEXT_OUT,
         DATE_OUT=:DATE_OUT,
         TYPE_MESSAGE=:TYPE_MESSAGE,
         CONTACT=:CONTACT,
         DESCRIPTION=:DESCRIPTION,
         PRIORITY=:PRIORITY,
         LOCKED=:LOCKED,
         DATE_BEGIN=:DATE_BEGIN,
         DATE_END=:DATE_END,
         ORDER_ID=:ORDER_ID,
         CHANNEL=:CHANNEL,
         DELIVERY=:DELIVERY,
         DATE_DELIVERY=:DATE_DELIVERY,
         FLASH=:FLASH,
         DEST_PORT=:DEST_PORT,
         FIRM_ID=:FIRM_ID,
         OPERATOR_ID=:OPERATOR_ID,
         MESSAGE_ID=:MESSAGE_ID,
         SOURCE=:SOURCE,
         ATTEMPTS=:ATTEMPTS
   WHERE OUT_MESSAGE_ID=:OLD_OUT_MESSAGE_ID;
END

--

CREATE OR ALTER PROCEDURE LOCK_OUT_MESSAGES
(
    MAX_COUNT INTEGER,
    LOCKED VARCHAR(32),
    TYPE_MESSAGE INTEGER,
    PERIOD INTEGER,
    CHANNEL VARCHAR(100),
    OPERATOR_ID VARCHAR(32)
)
RETURNS (
    LOCK_COUNT INTEGER)
AS
DECLARE OUT_MESSAGE_ID VARCHAR(32);
DECLARE CONTACT VARCHAR(100);
DECLARE NEW_OPERATOR_ID VARCHAR(32);
DECLARE LCONTACT INTEGER;
DECLARE FLAG INTEGER;
DECLARE FEDERAL INTEGER = 12;
DECLARE LOCAL INTEGER = 7;
DECLARE MAX_ATTEMPTS INTEGER = 3;
DECLARE ATTEMPTS INTEGER;
DECLARE NEW_ATTEMPTS INTEGER;
BEGIN
  LOCK_COUNT=0;

  IF (TYPE_MESSAGE IN (0,2)) THEN BEGIN

    DELETE FROM TMP_OPERATORS;
    INSERT INTO TMP_OPERATORS (RANGE_MIN,RANGE_MAX,OPERATOR_ID)
    SELECT RANGE_MIN,RANGE_MAX,OPERATOR_ID
      FROM GET_OPERATORS;

    FOR SELECT DISTINCT(T2.OUT_MESSAGE_ID), T2.OPERATOR_ID, T2.CONTACT, T2.LCONTACT, T2.ATTEMPTS
          FROM (SELECT T.OUT_MESSAGE_ID, O.OPERATOR_ID, T.CONTACT, T.LCONTACT, T.ATTEMPTS
                  FROM (SELECT OUT_MESSAGE_ID,
                               CAST(TRIM(REPLACE_STRING(CONTACT,'+','')) AS BIGINT) AS NUM,
                               CONTACT,
                               STRING_LENGTH(CONTACT) AS LCONTACT,
                               ATTEMPTS
                          FROM OUT_MESSAGES
                         WHERE DATE_OUT IS NULL
                           AND LOCKED IS NULL
                           AND TYPE_MESSAGE=:TYPE_MESSAGE
                           AND DATE_BEGIN<=CURRENT_TIMESTAMP
                           AND ((DATE_END IS NOT NULL AND DATE_END>=CURRENT_TIMESTAMP) OR
                                (DATE_END IS NULL AND DATEADD(SECOND,:PERIOD,DATE_BEGIN)>=CURRENT_TIMESTAMP))
                           AND (ATTEMPTS IS NULL OR ATTEMPTS>0)
                         ORDER BY PRIORITY, DATE_BEGIN) T
                  LEFT JOIN TMP_OPERATORS O ON O.RANGE_MIN<=T.NUM AND O.RANGE_MAX>=T.NUM) T2
         WHERE (T2.OPERATOR_ID=:OPERATOR_ID AND :OPERATOR_ID IS NOT NULL)
            OR (T2.OPERATOR_ID IS NULL AND :OPERATOR_ID IS NULL)
            OR (T2.OPERATOR_ID IS NOT NULL AND :OPERATOR_ID IS NULL)
          ROWS :MAX_COUNT
          INTO :OUT_MESSAGE_ID, :NEW_OPERATOR_ID, :CONTACT, :LCONTACT, :ATTEMPTS DO BEGIN

      FLAG=0;

      IF (TYPE_MESSAGE=0) THEN BEGIN

        IF (LCONTACT=LOCAL) THEN BEGIN

          EXECUTE PROCEDURE CONVERT_PHONE(CONTACT,0)
           RETURNING_VALUES CONTACT;

          LCONTACT=STRING_LENGTH(CONTACT);

        END

        IF ((LCONTACT=FEDERAL) AND (SUB_STRING(CONTACT,1,3)='+79')) THEN
          FLAG=1;

      END

      IF (TYPE_MESSAGE=2) THEN BEGIN

        IF (LCONTACT=FEDERAL) THEN BEGIN

          EXECUTE PROCEDURE CONVERT_PHONE(CONTACT,1)
           RETURNING_VALUES CONTACT;

          LCONTACT=STRING_LENGTH(CONTACT);
        END

      /*  IF ((LCONTACT=LOCAL) AND (SUB_STRING(CONTACT,1,1)='2')) THEN */
          FLAG=1;

      END

      IF (FLAG=1) THEN BEGIN

        IF (ATTEMPTS IS NULL) THEN
          NEW_ATTEMPTS=MAX_ATTEMPTS-1;
        ELSE
          NEW_ATTEMPTS=ATTEMPTS-1;

        UPDATE OUT_MESSAGES
           SET LOCKED=:LOCKED,
               CHANNEL=:CHANNEL,
               OPERATOR_ID=:NEW_OPERATOR_ID,
               ATTEMPTS=:NEW_ATTEMPTS
         WHERE OUT_MESSAGE_ID=:OUT_MESSAGE_ID;

        LOCK_COUNT=LOCK_COUNT+1;
      END

    END
  END
END

--

CREATE OR ALTER PROCEDURE U_CALL
(
    CALL_ID VARCHAR(32),
    LINE_ID VARCHAR(32),
    DIRECTION INTEGER,
    OPERATOR_ID VARCHAR(32),
    CALL_RESULT_ID VARCHAR(32),
    FIRM_ID VARCHAR(32),
    CREATOR_ID VARCHAR(32),
    DATE_CREATE TIMESTAMP,
    CALLER_ID VARCHAR(32),
    CALLER_PHONE VARCHAR(100),
    CALLER_DIVERSION VARCHAR(100),
    ACCEPTOR_ID VARCHAR(32),
    ACCEPTOR_PHONE VARCHAR(100),
    DATE_FOUND TIMESTAMP,
    DATE_BEGIN TIMESTAMP,
    DATE_END TIMESTAMP,
    TYPE_END INTEGER,
    CALLER_AUDIO BLOB,
    ACCEPTOR_AUDIO BLOB,
    IN_CHANNEL VARCHAR(100),
    OUT_CHANNEL VARCHAR(100),
    OLD_CALL_ID VARCHAR(32)
)
AS
DECLARE PATH VARCHAR(50) = 'd:\audio\';
DECLARE S1 VARCHAR(32);
DECLARE S2 VARCHAR(32);
DECLARE TEMP_CALLER_AUDIO BLOB;
DECLARE TEMP_ACCEPTOR_AUDIO BLOB;
BEGIN

  SELECT FIRST 1
         BLOB_TO_STRING(C.CALLER_AUDIO,1,32),
         BLOB_TO_STRING(C.ACCEPTOR_AUDIO,1,32)
    FROM CALLS C
   WHERE CALL_ID=:OLD_CALL_ID
    INTO :S1, S2;

  IF ((S1 IS NULL) OR (S1='')) THEN
    S1=GET_UNIQUE_ID();

  TEMP_CALLER_AUDIO=NULL;
  IF (BLOB_LENGTH(CALLER_AUDIO)>0) THEN BEGIN
    IF (SAVE_BLOB(CALLER_AUDIO,PATH||S1)=0) THEN
      TEMP_CALLER_AUDIO=STRING_TO_BLOB(S1);
  END ELSE
    DELETE_FILE(PATH||S1);

  IF ((S2 IS NULL) OR (S2='')) THEN
    S2=GET_UNIQUE_ID();

  TEMP_ACCEPTOR_AUDIO=NULL;
  IF (BLOB_LENGTH(ACCEPTOR_AUDIO)>0) THEN BEGIN
    IF (SAVE_BLOB(ACCEPTOR_AUDIO,PATH||S2)=0) THEN
      TEMP_ACCEPTOR_AUDIO=STRING_TO_BLOB(S2);
  END ELSE
    DELETE_FILE(PATH||S2);

  UPDATE CALLS
     SET CALL_ID=:CALL_ID,
         LINE_ID=:LINE_ID,
         DIRECTION=:DIRECTION,
         OPERATOR_ID=:OPERATOR_ID,
         CALL_RESULT_ID=:CALL_RESULT_ID,
         FIRM_ID=:FIRM_ID,
         CREATOR_ID=:CREATOR_ID,
         DATE_CREATE=:DATE_CREATE,
         CALLER_ID=:CALLER_ID,
         CALLER_PHONE=:CALLER_PHONE,
         CALLER_DIVERSION=:CALLER_DIVERSION,
         ACCEPTOR_ID=:ACCEPTOR_ID,
         ACCEPTOR_PHONE=:ACCEPTOR_PHONE,
         DATE_FOUND=:DATE_FOUND,
         DATE_BEGIN=:DATE_BEGIN,
         DATE_END=:DATE_END,
         TYPE_END=:TYPE_END,
         CALLER_AUDIO=:TEMP_CALLER_AUDIO,
         ACCEPTOR_AUDIO=:TEMP_ACCEPTOR_AUDIO,
         IN_CHANNEL=:IN_CHANNEL,
         OUT_CHANNEL=:OUT_CHANNEL
   WHERE CALL_ID=:OLD_CALL_ID;


END

--

CREATE OR ALTER PROCEDURE INCOMING_CALL_CHECK
(
  CALLER_PHONE VARCHAR(100),
  CALLER_DIVERSION VARCHAR(100),
  CHANNEL VARCHAR(100)
)
RETURNS (
    ACCOUNT_ID VARCHAR(32),
    NAME VARCHAR(100),
    PATRONYMIC VARCHAR(100),
    PHONE VARCHAR(100),
    OPERATOR_ID VARCHAR(32),
    FIRM_ID VARCHAR(32),
    SCENARIO_NAME VARCHAR(100),
    CHECKED INTEGER)
AS
DECLARE CNT INTEGER;
DECLARE RANGE_MIN BIGINT;
DECLARE RANGE_MAX BIGINT;
DECLARE PHONE_NUM BIGINT;
DECLARE CLIENT_APP_ID VARCHAR(32) = 'A35F5701A7AA920E40812A71A690910D'; /* Такси клиент*/
DECLARE DISPATCHERS_ROLE_ID VARCHAR(32) = 'FF7F332564F795C8411BF28652B22BEA';
DECLARE ALARM_ACCOUNT_ID VARCHAR(32) = '077D307B5B4D85754003331FE72C94B8';
BEGIN
  CHECKED=0;

  FIRM_ID='C49DF004D660BBAF434839044848F5B8'; /* АТАКСИ */

  SCENARIO_NAME='2777787';

  IF (CALLER_DIVERSION IS NOT NULL) THEN BEGIN

    IF (CALLER_DIVERSION='3912550550') THEN
      SCENARIO_NAME='2550550';

  END

  IF ((CALLER_PHONE IS NOT NULL) /*AND (CALLER_PHONE<>'Anonymous')*/) THEN BEGIN

    PHONE=CALLER_PHONE;

    EXECUTE PROCEDURE TRANSFORM_PHONE (PHONE)
     RETURNING_VALUES PHONE;

    EXECUTE PROCEDURE CONVERT_PHONE(PHONE,0)
     RETURNING_VALUES PHONE;

    EXECUTE PROCEDURE GET_OPERATOR (PHONE)
     RETURNING_VALUES OPERATOR_ID, RANGE_MIN, RANGE_MAX, PHONE_NUM;


    FOR SELECT A.ACCOUNT_ID, A.NAME, A.PATRONYMIC
          FROM CLIENTS C
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=C.CLIENT_ID
          LEFT JOIN CLIENT_PHONES CP ON CP.CLIENT_ID=C.CLIENT_ID
         WHERE CP.PHONE=:PHONE
            OR A.PHONE=:PHONE
          INTO :ACCOUNT_ID, :NAME, :PATRONYMIC DO BEGIN
      BREAK;
    END

    IF (ACCOUNT_ID IS NULL) THEN BEGIN

      FOR SELECT A.ACCOUNT_ID, A.NAME, A.PATRONYMIC
            FROM ACCOUNTS A
           WHERE A.PHONE=:PHONE
            INTO :ACCOUNT_ID, :NAME, :PATRONYMIC DO BEGIN
        BREAK;
      END

    END

    IF (NAME IS NOT NULL) THEN BEGIN

      SELECT COUNT(*)
        FROM GET_SAMPLE_VOICES(:NAME)
        INTO :CNT;

      IF (CNT<>1) THEN
        NAME=NULL;

    END

    IF (NAME IS NULL) THEN
      PATRONYMIC=NULL;

    IF (PATRONYMIC IS NOT NULL) THEN BEGIN

      SELECT COUNT(*)
        FROM GET_SAMPLE_VOICES(:PATRONYMIC)
        INTO :CNT;

      IF (CNT<>1) THEN
        PATRONYMIC=NULL;

    END

    SELECT COUNT(*)
      FROM BLACKS
     WHERE PHONE=:PHONE
      INTO :CNT;

    IF (CNT=0) THEN BEGIN

      CHECKED=1;

      SELECT COUNT(*)
        FROM SESSIONS
       WHERE APPLICATION_ID=:CLIENT_APP_ID
         AND ACCOUNT_ID IN (SELECT ACCOUNT_ID
                              FROM ACCOUNT_ROLES
                             WHERE ROLE_ID=:DISPATCHERS_ROLE_ID)
         AND CAST(CONFIG_READ(PARAMS,'TaxiPhoneForm','Enabled','0') AS INTEGER)=1
        INTO :CNT;

      IF (CNT = 0) THEN BEGIN

        IN AUTONOMOUS TRANSACTION DO BEGIN

          INSERT INTO ALARMS (ALARM_ID,SENDER_ID,RECIPIENT_ID,TYPE_ALARM,
                              DATE_BEGIN,DATE_END,
                              CAPTION,TEXT_ALARM)
                      VALUES (GET_UNIQUE_ID(),:ALARM_ACCOUNT_ID,:DISPATCHERS_ROLE_ID,1,
                              CURRENT_TIMESTAMP,DATEADD(SECOND,10,CURRENT_TIMESTAMP),
                              'Включите софтфон!','Идут входящие вызовы. Включите софтфон!');
        END

        EXECUTE PROCEDURE EVENT_ALARM(:CLIENT_APP_ID,NULL,NULL,0)
         RETURNING_VALUES :CNT;

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE GET_CODE_MESSAGE
(
  TEXT_IN VARCHAR(4000)
)
RETURNS
(
  CODE_MESSAGE_ID VARCHAR(32),
  CODE VARCHAR(100),
  PROC_NAME VARCHAR(100),
  COMMAND_STRING VARCHAR(250),
  ANSWER VARCHAR(4000)
)
AS
DECLARE CODE_POS INTEGER;
DECLARE CODE_TEMP VARCHAR(100);
DECLARE S VARCHAR(100);
DECLARE TEMP VARCHAR(100);
DECLARE TEMP_NEXT VARCHAR(1);
DECLARE L INTEGER;
DECLARE FLAG INTEGER;
BEGIN

  FLAG=0;
  FOR SELECT CODE_MESSAGE_ID, CODE, PROC_NAME, COMMAND_STRING, ANSWER
        FROM CODE_MESSAGES
       WHERE ENABLED=1
        INTO :CODE_MESSAGE_ID, :CODE, :PROC_NAME, :COMMAND_STRING, :ANSWER DO BEGIN

    CODE_TEMP=CODE;

    CODE_POS=-1;
    WHILE (CODE_POS<>0) DO BEGIN

      CODE_POS=POSITION(';',CODE_TEMP);
      IF (CODE_POS>0) THEN BEGIN
        S=SUB_STRING(CODE_TEMP,1,CODE_POS-1);
        CODE_TEMP=SUB_STRING(CODE_TEMP,CODE_POS+1,100);
      END ELSE
        S=CODE_TEMP;

      L=STRING_LENGTH(S);

      TEMP=SUB_STRING(TEXT_IN,1,L);

      IF (UPPER(TEMP)=UPPER(S)) THEN BEGIN

        TEMP_NEXT=SUB_STRING(TEXT_IN,L+1,1);

        IF (TEMP_NEXT IN (':','=','-',' ')) THEN BEGIN
          FLAG=1;
          CODE=S;
          BREAK;
        END

      END

    END

    IF (FLAG=1) THEN BEGIN
      SUSPEND;
      BREAK;
    END

  END

END

--

CREATE OR ALTER PROCEDURE EXECUTE_IN_MESSAGE
(
  SESSION_ID VARCHAR(32),
  IN_MESSAGE_ID VARCHAR(32)
)
AS
DECLARE ACCOUNT_ID VARCHAR(32);
DECLARE PROC_NAME VARCHAR(100);
DECLARE SQL VARCHAR(1000);
DECLARE CNT INTEGER;
BEGIN

  SELECT CM.PROC_NAME
    FROM IN_MESSAGES IM
    JOIN CODE_MESSAGES CM ON CM.CODE_MESSAGE_ID=IM.CODE_MESSAGE_ID
   WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :PROC_NAME;

  IF ((PROC_NAME IS NOT NULL) AND (TRIM(PROC_NAME)<>'')) THEN BEGIN

    SELECT ACCOUNT_ID
      FROM SESSIONS
     WHERE SESSION_ID=:SESSION_ID
      INTO :ACCOUNT_ID;

    SELECT COUNT(*)
      FROM RDB$PROCEDURE_PARAMETERS
     WHERE RDB$PROCEDURE_NAME=:PROC_NAME
       AND RDB$PARAMETER_NAME='SESSION_ID'
      INTO :CNT;

    IF (CNT>0) THEN

      SQL='EXECUTE PROCEDURE '||PROC_NAME||'('''||SESSION_ID||''','''||ACCOUNT_ID||''','''||IN_MESSAGE_ID||''');';

    ELSE

      SQL='EXECUTE PROCEDURE '||PROC_NAME||'('''||ACCOUNT_ID||''','''||IN_MESSAGE_ID||''');';

    EXECUTE STATEMENT SQL;

  END

END

--

CREATE OR ALTER PROCEDURE CODE_TEST
(
  SESSION_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  IN_MESSAGE_ID VARCHAR(32)
)
AS
DECLARE CONTACT VARCHAR(100);
DECLARE SENDER_ID VARCHAR(32);
DECLARE S VARCHAR(70);
DECLARE CNT INTEGER;
DECLARE MSEC BIGINT;
DECLARE DAYS INTEGER;
DECLARE HOURS INTEGER;
DECLARE MINUTES INTEGER;
DECLARE SECONDS INTEGER;
DECLARE D TIMESTAMP;
DECLARE UPTIME VARCHAR(100);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN
  SELECT IM.CONTACT, IM.SENDER_ID, IM.TYPE_MESSAGE, A.FIRM_ID
    FROM IN_MESSAGES IM
    LEFT JOIN ACCOUNTS A ON A.ACCOUNT_ID=IM.SENDER_ID
   WHERE IM.IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, :TYPE_MESSAGE, :FIRM_ID;

  IF ((CONTACT IS NOT NULL) AND (SENDER_ID IS NOT NULL)) THEN BEGIN

    SELECT COUNT(*)
      FROM ACCOUNT_ROLES
     WHERE ROLE_ID IN ('3AC5EA48DEA3A72A4380D9CC5923471F','FF7F332564F795C8411BF28652B22BEA') /* Администраторы, Диспетчеры */
       AND ACCOUNT_ID=:SENDER_ID
      INTO CNT;

    IF (CNT>0) THEN BEGIN

      SELECT CONST_VALUE FROM GET_CONST_VALUE('DD5F7C07EB2CBC6B4CE52043B3BF395D') INTO :S;

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE,CONTACT)
       RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

      IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        MSEC=SYSTEM_UPTIME();
        DAYS=MSEC/(1000*60*60*24);
        MSEC=MSEC-(DAYS*1000*60*60*24);
        HOURS=MSEC/(1000*60*60);
        MSEC=MSEC-(HOURS*1000*60*60);
        MINUTES=MSEC/(1000*60);
        MSEC=MSEC-(MINUTES*1000*60);
        SECONDS=MSEC/1000;
        D=CAST((CAST(HOURS AS VARCHAR(2))||':'||CAST(MINUTES AS VARCHAR(2))||':'||CAST(SECONDS AS VARCHAR(2))) AS TIME);

        UPTIME=CAST(DAYS AS VARCHAR(10))||'-'||FORMAT_DATETIME('hh:nn:ss',D);

        S=REPLACE_STRING(S,'%UPTIME',UPTIME);

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                  LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                  :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,0,
                                  NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
      END
    END

  END

END

--

CREATE OR ALTER PROCEDURE PROCESS_IN_MESSAGE
(
  SESSION_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  CONTACT VARCHAR(100),
  TEXT_IN VARCHAR(4000),
  TYPE_MESSAGE INTEGER,
  CHANNEL VARCHAR(100),
  FIRM_ID VARCHAR(32),
  OPERATOR_ID VARCHAR(32),
  LOCKED VARCHAR(32)
)
RETURNS
(
  CODE_MESSAGE_ID VARCHAR(32),
  CODE VARCHAR(100),
  PROC_NAME VARCHAR(100),
  COMMAND_STRING VARCHAR(250),
  ANSWER VARCHAR(4000),
  IN_MESSAGE_ID VARCHAR(32),
  LOCK_COUNT INTEGER
)
AS
DECLARE GRANTED INTEGER;
DECLARE OUT_MESSAGE_ID VARCHAR(32);
DECLARE MAX_ATTEMPTS INTEGER = 3;
DECLARE ATTEMPTS INTEGER;
DECLARE NEW_ATTEMPTS INTEGER;
DECLARE DATE_IN TIMESTAMP;
BEGIN

  LOCK_COUNT=0;

  EXECUTE PROCEDURE GET_CODE_MESSAGE(TEXT_IN)
   RETURNING_VALUES CODE_MESSAGE_ID,CODE,PROC_NAME,COMMAND_STRING,ANSWER;

  GRANTED=1;

  IF (ACCOUNT_ID IS NOT NULL) THEN

    EXECUTE PROCEDURE INCOMING_GRANTED(ACCOUNT_ID,TYPE_MESSAGE)
     RETURNING_VALUES GRANTED;

  IF (GRANTED=1) THEN BEGIN

    IN_MESSAGE_ID=GET_UNIQUE_ID();

    DATE_IN=CURRENT_TIMESTAMP;

    INSERT INTO IN_MESSAGES (IN_MESSAGE_ID,SENDER_ID,CODE_MESSAGE_ID,DATE_SEND,TEXT_IN,DATE_IN,
                             TYPE_MESSAGE,CONTACT,ORDER_ID,CHANNEL,DESCRIPTION,FIRM_ID,OPERATOR_ID)
                     VALUES (:IN_MESSAGE_ID,:ACCOUNT_ID,:CODE_MESSAGE_ID,CURRENT_TIMESTAMP,:TEXT_IN,:DATE_IN,
                             :TYPE_MESSAGE,:CONTACT,NULL,:CHANNEL,NULL,:FIRM_ID,:OPERATOR_ID);

    EXECUTE PROCEDURE EXECUTE_IN_MESSAGE(SESSION_ID,IN_MESSAGE_ID);

    FOR SELECT OUT_MESSAGE_ID, ATTEMPTS
          FROM OUT_MESSAGES
         WHERE RECIPIENT_ID=:ACCOUNT_ID
           AND CONTACT=:CONTACT
           AND DATE_OUT IS NULL
           AND LOCKED IS NULL
           AND TYPE_MESSAGE=:TYPE_MESSAGE
           AND DATE_CREATE>=:DATE_IN
           AND ((DATE_END IS NOT NULL AND DATE_END>=CURRENT_TIMESTAMP) OR DATE_END IS NULL)
           AND (ATTEMPTS IS NULL OR ATTEMPTS>0)
          INTO :OUT_MESSAGE_ID, :ATTEMPTS DO BEGIN

      IF (ATTEMPTS IS NULL) THEN
        NEW_ATTEMPTS=MAX_ATTEMPTS-1;
      ELSE
        NEW_ATTEMPTS=ATTEMPTS-1;

      UPDATE OUT_MESSAGES
         SET LOCKED=:LOCKED,
             CHANNEL=:CHANNEL,
             OPERATOR_ID=:OPERATOR_ID,
             ATTEMPTS=:NEW_ATTEMPTS
       WHERE OUT_MESSAGE_ID=:OUT_MESSAGE_ID;

      LOCK_COUNT=LOCK_COUNT+1;

    END

  END

END

--

CREATE OR ALTER PROCEDURE REFUSE_ORDER_BY_CLIENT
(
  SESSION_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  OLD_ORDER_ID VARCHAR(32)
)
RETURNS
(
  NEW_ORDER_ID VARCHAR(32)
)
AS
DECLARE RESULT_ID VARCHAR(32);
DECLARE TYPE_PROCESS INTEGER;
BEGIN

  FOR SELECT CASE ACTION_ID
               WHEN 'E019DBDE7D55BEC34D12A709EE3FEB0B' THEN 'E9A07EA55CA9AC0649CEC68317677537'
               WHEN '2E483437E3D197AD4CD8EBF05CF8A512' THEN '56B225DAA61EBF284A3149D32FDB0256'
               WHEN '4C529D9690E2AE594444E57727C8A396' THEN '15AB7FD3EF0FA8A94BB23F1FEC9C83E5'
               WHEN '06BCBCF12E74BC434436F24EE5F6521C' THEN '32C41E16517589F2419AD631D453438F'
               WHEN '83BB49032FBC8D50464A62C061B37C7C' THEN 'E9D6764577A5932544C0A0439569765D'
               ELSE NULL
             END AS RESULT_ID,
             TYPE_PROCESS
        FROM ORDERS
       WHERE ORDER_ID=:OLD_ORDER_ID
        INTO :RESULT_ID, :TYPE_PROCESS DO BEGIN

    IF (RESULT_ID IS NOT NULL) THEN BEGIN

      EXECUTE PROCEDURE PROCESS_RESULT(SESSION_ID,OLD_ORDER_ID,GET_UNIQUE_ID(),
                                       RESULT_ID,ACCOUNT_ID,TYPE_PROCESS,0)
       RETURNING_VALUES NEW_ORDER_ID;

    END

    BREAK;
  END

END

--

CREATE PROCEDURE GET_ADDRESS
(
  STREET_ID VARCHAR(32),
  HOUSE VARCHAR(10),
  FLAT VARCHAR(10),
  PORCH VARCHAR(10)
)
RETURNS
(
  ADDRESS VARCHAR(1000)
)
AS
DECLARE STREET_NAME VARCHAR(100);
DECLARE STREET_PREFIX VARCHAR(10);
DECLARE LOCALITY_NAME VARCHAR(100);
DECLARE LOCALITY_PREFIX VARCHAR(10);
BEGIN

  ADDRESS='';

  FOR SELECT S.NAME, S.PREFIX, L.NAME, L.PREFIX
        FROM STREETS S
        JOIN LOCALITIES L ON L.LOCALITY_ID=S.LOCALITY_ID
       WHERE STREET_ID=:STREET_ID
        INTO :STREET_NAME, :STREET_PREFIX, :LOCALITY_NAME, :LOCALITY_PREFIX DO BEGIN


    IF (STREET_PREFIX IS NOT NULL) THEN
      ADDRESS=STREET_PREFIX||' ';

    IF (STREET_NAME IS NOT NULL) THEN
      ADDRESS=ADDRESS||STREET_NAME;

    IF (HOUSE IS NOT NULL) THEN
      ADDRESS=ADDRESS||' '||HOUSE;

    IF (FLAT IS NOT NULL) THEN
      ADDRESS=ADDRESS||'-'||FLAT;

    IF (PORCH IS NOT NULL) THEN
      ADDRESS=ADDRESS||' п.'||PORCH;

    IF ((LOCALITY_NAME IS NOT NULL) AND (LOCALITY_NAME<>'Красноярск')) THEN BEGIN

      IF (LOCALITY_PREFIX IS NOT NULL) THEN
        ADDRESS=ADDRESS||', '||LOCALITY_PREFIX||' '||LOCALITY_NAME;

    END

    BREAK;
  END

END

--

CREATE OR ALTER PROCEDURE CODE_REFUSE_ORDER
(
  SESSION_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  IN_MESSAGE_ID VARCHAR(32)
)
AS
DECLARE CONTACT VARCHAR(100);
DECLARE SENDER_ID VARCHAR(32);
DECLARE S1 VARCHAR(250);
DECLARE S2 VARCHAR(250);
DECLARE S3 VARCHAR(250);
DECLARE S4 VARCHAR(1250);
DECLARE S5 VARCHAR(250);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE CNT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
DECLARE ORDER_ID VARCHAR(32);
DECLARE ORDER_NUM VARCHAR(10);
DECLARE DISPATCHERS_ID VARCHAR(32) = 'FF7F332564F795C8411BF28652B22BEA';
DECLARE APPLICATION_ID VARCHAR(32) = 'A35F5701A7AA920E40812A71A690910D';
DECLARE SUCCESS INTEGER;
DECLARE STREET_ID VARCHAR(32);
DECLARE HOUSE VARCHAR(10);
DECLARE FLAT VARCHAR(10);
DECLARE PORCH VARCHAR(10);
DECLARE ACTION_ID VARCHAR(32);
DECLARE USER_NAME VARCHAR(100);
DECLARE ADDRESS VARCHAR(1000);
BEGIN
  SELECT CONTACT, SENDER_ID, TYPE_MESSAGE
    FROM IN_MESSAGES
   WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, :TYPE_MESSAGE;

  IF (CONTACT IS NOT NULL) THEN BEGIN
  
    SELECT CONST_VALUE FROM GET_CONST_VALUE('3F24C5A1359196CF433FE116223EB2B3') INTO :S1;

    SELECT CONST_VALUE FROM GET_CONST_VALUE('F213E7AA323484464EECA9D5A5FF4133') INTO :S2;

    SELECT CONST_VALUE FROM GET_CONST_VALUE('D0A0EEA55ED698F348C167CA56E6FDF2') INTO :S3;
    
    EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE,CONTACT)
      RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;
      
    FOR SELECT O.ORDER_ID, O.ORDER_NUM, O.FIRM_ID, O.ACTION_ID,
               O.STREET_ID, O.HOUSE, O.FLAT, O.PORCH, A.USER_NAME
          FROM ORDERS O
          LEFT JOIN CLIENTS C ON C.CLIENT_ID=O.CLIENT_ID
          LEFT JOIN ACCOUNTS A ON A.ACCOUNT_ID=C.CLIENT_ID
         WHERE O.PHONE=:CONTACT
           AND O.FINISHED=0
           AND O.DATE_HISTORY IS NULL
          INTO :ORDER_ID, :ORDER_NUM, :FIRM_ID, :ACTION_ID,
               :STREET_ID, :HOUSE, :FLAT, :PORCH, :USER_NAME DO BEGIN


      EXECUTE PROCEDURE REFUSE_ORDER_BY_CLIENT(SESSION_ID,ACCOUNT_ID,ORDER_ID)
       RETURNING_VALUES ORDER_ID;
       
      S4=S2;
      
      IF ((S1 IS NOT NULL) AND (S4 IS NOT NULL)) THEN BEGIN
      
        EXECUTE PROCEDURE GET_ADDRESS(STREET_ID,HOUSE,FLAT,PORCH)
         RETURNING_VALUES ADDRESS;
         
        S4=REPLACE_STRING(S4,'%USER_NAME',USER_NAME);
        S4=REPLACE_STRING(S4,'%PHONE',CONTACT);
        S4=REPLACE_STRING(S4,'%ADDRESS',ADDRESS);
        
        IN AUTONOMOUS TRANSACTION DO BEGIN

          INSERT INTO ALARMS (ALARM_ID,SENDER_ID,RECIPIENT_ID,TYPE_ALARM,
                              DATE_BEGIN,DATE_END,CAPTION,TEXT_ALARM)
                      VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DISPATCHERS_ID,0,
                              CURRENT_TIMESTAMP,DATEADD(MINUTE,5,CURRENT_TIMESTAMP),:S1,:S4);
                              
        END

        EXECUTE PROCEDURE EVENT_ALARM(APPLICATION_ID,DISPATCHERS_ID,SESSION_ID,0)
         RETURNING_VALUES SUCCESS;
        
      END

      S5=S3;
      
      IF ((S5 IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN
      
        S5=REPLACE_STRING(S5,'%ORDER_NUM',ORDER_NUM);
      
        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                  PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                  :S5,NULL,:TYPE_MESSAGE,:CONTACT,NULL,
                                  2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
                                  
      END
      
    END
    
  END

END

--

CREATE OR ALTER PROCEDURE GET_CONST_VALUE_TYPE_MESSAGE
(
  CONST_NAME VARCHAR(100),
  TYPE_MESSAGE INTEGER
)
RETURNS
(
  CONST_VALUE VARCHAR(4000)
)
AS
DECLARE RET_POS INTEGER;
DECLARE DELIM_POS INTEGER;
DECLARE S VARCHAR(4000);
DECLARE TEMP VARCHAR(4000);
DECLARE STYPE_MESSAGE VARCHAR(4000);
BEGIN
  CONST_VALUE=NULL;
  FOR SELECT SUBSTRING("VALUE" FROM 1 FOR 1000)
        FROM CONSTS
       WHERE UPPER(NAME)=UPPER(:CONST_NAME)
         AND ENABLED=1
        INTO :CONST_VALUE DO BEGIN

    TEMP=CONST_VALUE;
    RET_POS=-1;
    WHILE (RET_POS<>0) DO BEGIN

      RET_POS=POSITION(CHR(13)||CHR(10),TEMP);
      IF (RET_POS>0) THEN BEGIN
        S=SUB_STRING(TEMP,1,RET_POS-1);
        TEMP=SUB_STRING(TEMP,RET_POS+2,4000);
      END ELSE
        S=TEMP;

      IF (S IS NOT NULL) THEN BEGIN

        STYPE_MESSAGE=NULL;
        DELIM_POS=-1;
        WHILE (DELIM_POS<>0) DO BEGIN

          DELIM_POS=POSITION('|',S);
          IF (DELIM_POS>0) THEN BEGIN
            STYPE_MESSAGE=SUB_STRING(S,1,DELIM_POS-1);
            S=SUB_STRING(S,DELIM_POS+1,4000);
          END

          BREAK;
        END

        IF ((TYPE_MESSAGE IN (0,1,2)) AND (STYPE_MESSAGE IS NOT NULL)) THEN BEGIN

          DELIM_POS=POSITION(CAST(TYPE_MESSAGE AS VARCHAR(1)),STYPE_MESSAGE);
          IF (DELIM_POS>0) THEN BEGIN
            CONST_VALUE=S;
            BREAK;
          END

        END ELSE BEGIN
          CONST_VALUE=S;
          BREAK;
        END
      END

    END

    BREAK;
  END

  SUSPEND;
END

--

DECLARE EXTERNAL FUNCTION NUMBER_TO_WORDS
    DOUBLE PRECISION,
    INTEGER,
    CSTRING(32767)
RETURNS PARAMETER 3
ENTRY_POINT 'NUMBER_TO_WORDS' MODULE_NAME 'udfibase.dll';

--

CREATE OR ALTER PROCEDURE GET_ORDER_NUM
RETURNS
(
  ORDER_NUM VARCHAR(10)
)
AS
BEGIN
  SELECT GEN_ID(GEN_ORDER_NUM,1)
    FROM RDB$DATABASE
    INTO :ORDER_NUM;
END

--

CREATE OR ALTER PROCEDURE CODE_MAKE_ORDER
(
  SESSION_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  IN_MESSAGE_ID VARCHAR(32)
)
AS
DECLARE CONTACT VARCHAR(100);
DECLARE SENDER_ID VARCHAR(32);
DECLARE S VARCHAR(1000);
DECLARE CNT INTEGER;
DECLARE CONST_VALUE VARCHAR(4000);
DECLARE ORDER_NUM VARCHAR(1000);
DECLARE ACTION_ID VARCHAR(32);
DECLARE RATE_ID VARCHAR(32);
DECLARE CAR_TYPE_ID VARCHAR(32);
DECLARE CLIENT_ID VARCHAR(32);
DECLARE STREET_ID VARCHAR(32);
DECLARE HOUSE VARCHAR(10);
DECLARE FLAT VARCHAR(10);
DECLARE PORCH VARCHAR(10);
DECLARE ADDRESS_DESC VARCHAR(250);
DECLARE LOCKED INTEGER;
DECLARE ORDER_ID VARCHAR(32);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32)='C49DF004D660BBAF434839044848F5B8'; /* АТакси */
DECLARE RND INTEGER;
DECLARE TYPE_ACCEPT INTEGER;
DECLARE DISCOUNT_ID VARCHAR(32);
BEGIN
  SELECT CONTACT, SENDER_ID, TYPE_MESSAGE
    FROM IN_MESSAGES
   WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, :TYPE_MESSAGE;

  SELECT COUNT(*)
    FROM BLACKS
   WHERE UPPER(PHONE)=UPPER(:CONTACT)
    INTO :CNT;

  IF ((CONTACT IS NOT NULL) AND (CNT=0)) THEN BEGIN

    SELECT FIRST 1
           ORDER_ID
      FROM ORDERS
     WHERE FINISHED=0
       AND PHONE=:CONTACT
       AND TYPE_PROCESS=1
       AND DATE_HISTORY IS NULL
       AND DATE_ACCEPT>=DATEADD(MINUTE,-30,CURRENT_TIMESTAMP)
      INTO :ORDER_ID;

    IF (ORDER_ID IS NOT NULL) THEN BEGIN

      UPDATE IN_MESSAGES
         SET ORDER_ID=:ORDER_ID
       WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID;

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE,CONTACT)
       RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

      SELECT CONST_VALUE FROM GET_CONST_VALUE_TYPE_MESSAGE('B19E95F747A3A0F5477326231BB3A053',:TYPE_MESSAGE) INTO :S;

      IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                  PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID,MESSAGE_ID,SOURCE)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                  :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,
                                  1,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID,NULL,NULL);

      END


    END ELSE BEGIN

      SELECT LOCKED, CLIENT_ID, STREET_ID, HOUSE, FLAT, PORCH, ADDRESS_DESC
        FROM CLIENTS C
        JOIN ACCOUNTS A ON A.ACCOUNT_ID=C.CLIENT_ID
       WHERE C.CLIENT_ID=:SENDER_ID
        INTO :LOCKED, :CLIENT_ID, :STREET_ID, :HOUSE, :FLAT, :PORCH, :ADDRESS_DESC;

      IF ((CLIENT_ID IS NULL) OR ((CLIENT_ID IS NOT NULL) AND (LOCKED<>1))) THEN BEGIN

        EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE,CONTACT)
         RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

        SELECT CONST_VALUE FROM GET_CONST_VALUE_TYPE_MESSAGE('CB66FC06A78BB69D430EB7BD1AFA13FA',:TYPE_MESSAGE) INTO :S;

        IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

          RATE_ID=NULL;
          FOR SELECT RATE_ID
                FROM RATES
               ORDER BY PRIORITY
                INTO :RATE_ID DO BEGIN
            BREAK;
          END

          CAR_TYPE_ID=NULL;
          FOR SELECT CAR_TYPE_ID
                FROM CAR_TYPES
               ORDER BY PRIORITY
                INTO :CAR_TYPE_ID DO BEGIN
            BREAK;
          END

          IF ((RATE_ID IS NOT NULL) AND (CAR_TYPE_ID IS NOT NULL)) THEN BEGIN

            ORDER_ID=GET_UNIQUE_ID();
            STREET_ID='FA27330C653381FA4EDE11ECF0959DD6';  /* Красноярск - .*/
            HOUSE=NULL;
            FLAT=NULL;
            PORCH=NULL;
            ADDRESS_DESC=NULL;

            EXECUTE PROCEDURE GET_ORDER_NUM
              RETURNING_VALUES :ORDER_NUM;

            ACTION_ID='E019DBDE7D55BEC34D12A709EE3FEB0B'; /* Создание */

            TYPE_ACCEPT=0;
            IF (TYPE_MESSAGE IN (0,1)) THEN
              TYPE_ACCEPT=1;

            DISCOUNT_ID = NULL;
            FOR SELECT D.DISCOUNT_ID
                  FROM DISCOUNTS D
                 WHERE D.CLIENT_ID = :CLIENT_ID
                   AND D.DATE_END IS NULL
                 ORDER BY D.PRIORITY DESC
                  INTO :DISCOUNT_ID DO BEGIN
              BREAK;
            END

            INSERT INTO ORDERS (ORDER_ID,ACTION_ID,RATE_ID,CAR_TYPE_ID,WHO_ACCEPT_ID,
                                CLIENT_ID,STREET_ID,HOUSE,FLAT,PORCH,DESCRIPTION,
                                ORDER_NUM,PHONE,DATE_ACCEPT,DATE_ARRIVAL,TYPE_ACCEPT,
                                TYPE_PROCESS,BEFORE_PERIOD,DATE_BEGIN,FINISHED,FIRM_ID,DISCOUNT_ID)
                        VALUES (:ORDER_ID,:ACTION_ID,:RATE_ID,:CAR_TYPE_ID,:ACCOUNT_ID,
                                :CLIENT_ID,:STREET_ID,:HOUSE,:FLAT,:PORCH,:ADDRESS_DESC,
                                :ORDER_NUM,:CONTACT,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,:TYPE_ACCEPT,
                                1,30,CURRENT_TIMESTAMP,0,:FIRM_ID,:DISCOUNT_ID);

            UPDATE IN_MESSAGES
               SET ORDER_ID=:ORDER_ID
             WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID;

            IF (TYPE_MESSAGE=2) THEN
              ORDER_NUM=NUMBER_TO_WORDS(CAST(ORDER_NUM AS INTEGER),1);

            S=REPLACE_STRING(S,'%ORDER_NUM',ORDER_NUM);

            INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                      TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                      PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID,MESSAGE_ID,SOURCE)
                              VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                      :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,
                                      1,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID,NULL,NULL);

          END

        END

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE CODE_REFUSE_ORDER
(
  SESSION_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  IN_MESSAGE_ID VARCHAR(32)
)
AS
DECLARE CONTACT VARCHAR(100);
DECLARE SENDER_ID VARCHAR(32);
DECLARE S1 VARCHAR(250);
DECLARE S2 VARCHAR(250);
DECLARE S3 VARCHAR(250);
DECLARE S4 VARCHAR(1250);
DECLARE S5 VARCHAR(1250);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE CNT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
DECLARE ORDER_ID VARCHAR(32);
DECLARE ORDER_NUM VARCHAR(1000);
DECLARE DISPATCHERS_ID VARCHAR(32) = 'FF7F332564F795C8411BF28652B22BEA';
DECLARE APPLICATION_ID VARCHAR(32) = 'A35F5701A7AA920E40812A71A690910D';
DECLARE SUCCESS INTEGER;
DECLARE STREET_ID VARCHAR(32);
DECLARE HOUSE VARCHAR(10);
DECLARE FLAT VARCHAR(10);
DECLARE PORCH VARCHAR(10);
DECLARE ACTION_ID VARCHAR(32);
DECLARE USER_NAME VARCHAR(100);
DECLARE ADDRESS VARCHAR(1000);
BEGIN
  SELECT CONTACT, SENDER_ID, TYPE_MESSAGE
    FROM IN_MESSAGES
   WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, :TYPE_MESSAGE;

  IF (CONTACT IS NOT NULL) THEN BEGIN
  
    SELECT CONST_VALUE FROM GET_CONST_VALUE('3F24C5A1359196CF433FE116223EB2B3') INTO :S1;

    SELECT CONST_VALUE FROM GET_CONST_VALUE('F213E7AA323484464EECA9D5A5FF4133') INTO :S2;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE,CONTACT)
      RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;
      
    SELECT CONST_VALUE FROM GET_CONST_VALUE_TYPE_MESSAGE('D0A0EEA55ED698F348C167CA56E6FDF2',:TYPE_MESSAGE) INTO :S3;
    
    FOR SELECT O.ORDER_ID, O.ORDER_NUM, O.FIRM_ID, O.ACTION_ID,
               O.STREET_ID, O.HOUSE, O.FLAT, O.PORCH, A.USER_NAME
          FROM ORDERS O
          LEFT JOIN CLIENTS C ON C.CLIENT_ID=O.CLIENT_ID
          LEFT JOIN ACCOUNTS A ON A.ACCOUNT_ID=C.CLIENT_ID
         WHERE O.PHONE=:CONTACT
           AND O.FINISHED=0
           AND O.DATE_HISTORY IS NULL
          INTO :ORDER_ID, :ORDER_NUM, :FIRM_ID, :ACTION_ID,
               :STREET_ID, :HOUSE, :FLAT, :PORCH, :USER_NAME DO BEGIN


      EXECUTE PROCEDURE REFUSE_ORDER_BY_CLIENT(SESSION_ID,ACCOUNT_ID,ORDER_ID)
       RETURNING_VALUES ORDER_ID;
       
      S4=S2;
      
      IF ((S1 IS NOT NULL) AND (S4 IS NOT NULL)) THEN BEGIN
      
        EXECUTE PROCEDURE GET_ADDRESS(STREET_ID,HOUSE,FLAT,PORCH)
         RETURNING_VALUES ADDRESS;
         
        S4=REPLACE_STRING(S4,'%USER_NAME',USER_NAME);
        S4=REPLACE_STRING(S4,'%PHONE',CONTACT);
        S4=REPLACE_STRING(S4,'%ADDRESS',ADDRESS);
        
        IN AUTONOMOUS TRANSACTION DO BEGIN

          INSERT INTO ALARMS (ALARM_ID,SENDER_ID,RECIPIENT_ID,TYPE_ALARM,
                              DATE_BEGIN,DATE_END,CAPTION,TEXT_ALARM)
                      VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DISPATCHERS_ID,0,
                              CURRENT_TIMESTAMP,DATEADD(MINUTE,5,CURRENT_TIMESTAMP),:S1,:S4);
                              
        END

        EXECUTE PROCEDURE EVENT_ALARM(APPLICATION_ID,DISPATCHERS_ID,SESSION_ID,0)
         RETURNING_VALUES SUCCESS;
        
      END

      S5=S3;
      
      IF ((S5 IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN
      
        IF (TYPE_MESSAGE=2) THEN
          ORDER_NUM=NUMBER_TO_WORDS(CAST(ORDER_NUM AS INTEGER),1);

        S5=REPLACE_STRING(S5,'%ORDER_NUM',ORDER_NUM);
      
        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                  PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                  :S5,NULL,:TYPE_MESSAGE,:CONTACT,NULL,
                                  2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
                                  
      END
      
    END
    
  END

END

--

CREATE INDEX IDX_SAMPLE_VOICES_PRIORITY
ON SAMPLE_VOICES (PRIORITY)

--

CREATE INDEX IDX_SAMPLE_VOICES_SAMPLE_TEXT
ON SAMPLE_VOICES COMPUTED BY (UPPER(SAMPLE_TEXT))

--

CREATE OR ALTER PROCEDURE GET_SAMPLE_VOICES 
(
  IN_TEXT VARCHAR(1000)
)
RETURNS 
(
  SAMPLE_TEXT VARCHAR(1000),
  VOICE_DATA BLOB,
  TYPE_SAMPLE INTEGER
)
AS
DECLARE L INTEGER;
DECLARE LORIGIN INTEGER;
DECLARE POS INTEGER;
DECLARE NOT_USED_COUNT INTEGER;
DECLARE S1 VARCHAR(1000);
DECLARE S2 VARCHAR(1000);
DECLARE USED_EXISTS INTEGER;
BEGIN

  DELETE FROM TMP_SAMPLE_VOICES;

  L=1;
  LORIGIN=STRING_LENGTH(IN_TEXT);
  WHILE (L<=LORIGIN) DO BEGIN
    INSERT INTO TMP_SAMPLE_VOICES (POS,SAMPLE_TEXT,VOICE_DATA,TYPE_SAMPLE,USED)
                           VALUES (:L,SUB_STRING(:IN_TEXT,:L,1),NULL,0,0);
    L=L+1;
  END

  IN_TEXT=UPPER(IN_TEXT);
  L=1;
  FOR SELECT SAMPLE_TEXT, VOICE_DATA, TYPE_SAMPLE
        FROM SAMPLE_VOICES
       WHERE POSITION(UPPER(SAMPLE_TEXT),:IN_TEXT)>0
       ORDER BY TYPE_SAMPLE DESC, PRIORITY
        INTO :SAMPLE_TEXT, :VOICE_DATA, :TYPE_SAMPLE DO BEGIN

    SELECT COUNT(*)
      FROM TMP_SAMPLE_VOICES
     WHERE USED=0
      INTO :NOT_USED_COUNT;

    IF (NOT_USED_COUNT>0) THEN BEGIN

      S1=UPPER(SAMPLE_TEXT);
      S2=IN_TEXT;
      L=STRING_LENGTH(S1);
      POS=1;

      WHILE (POS>0) DO BEGIN
        POS=POSITION(S1,S2,POS);
        IF (POS>0) THEN BEGIN

          SELECT USED
            FROM TMP_SAMPLE_VOICES
           WHERE POS=:POS
            INTO :USED_EXISTS;

          IF (USED_EXISTS=0) THEN BEGIN

            UPDATE TMP_SAMPLE_VOICES
               SET SAMPLE_TEXT=:SAMPLE_TEXT,
                   VOICE_DATA=:VOICE_DATA,
                   TYPE_SAMPLE=:TYPE_SAMPLE,
                   USED=1
             WHERE POS=:POS;

            UPDATE TMP_SAMPLE_VOICES
               SET USED=2
             WHERE POS>:POS
               AND POS<=(:POS+:L-1);

          END

          POS=POS+L;

        END
      END

    END ELSE
      BREAK;

  END

  FOR SELECT SAMPLE_TEXT, VOICE_DATA, TYPE_SAMPLE
        FROM TMP_SAMPLE_VOICES
       WHERE USED=1
        INTO :SAMPLE_TEXT, :VOICE_DATA, :TYPE_SAMPLE DO BEGIN
    SUSPEND;
  END
END

--

CREATE OR ALTER PROCEDURE I_DRIVER_SHIFT
(
  SESSION_ID VARCHAR(32),
  SHIFT_ID VARCHAR(32),
  DRIVER_ID VARCHAR(32),
  PARK_ID VARCHAR(32),
  DATE_BEGIN TIMESTAMP,
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE SUM_CHARGE NUMERIC(15,2);
DECLARE SUM_RECEIPT NUMERIC(15,2);
DECLARE BALANCE NUMERIC(15,2);
DECLARE MIN_BALANCE NUMERIC(15,2);
DECLARE PARK_NAME VARCHAR(100);
DECLARE PARK_DESCRIPTION VARCHAR(250);
DECLARE PRIORITY INTEGER;
DECLARE S VARCHAR(1000);
DECLARE CONTACT VARCHAR(100);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
DECLARE CNT INTEGER;
BEGIN

  SELECT D.MIN_BALANCE, A.PHONE, A.FIRM_ID
    FROM DRIVERS D
    JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
   WHERE DRIVER_ID=:DRIVER_ID
    INTO :MIN_BALANCE, :CONTACT, :FIRM_ID;

  EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL,CONTACT)
   RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

  EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:DRIVER_ID)
   RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

  IF ((MIN_BALANCE IS NULL) OR ((MIN_BALANCE IS NOT NULL) AND (BALANCE>MIN_BALANCE))) THEN BEGIN

    INSERT INTO SHIFTS (SHIFT_ID,ACCOUNT_ID,DATE_BEGIN)
         VALUES (:SHIFT_ID,:DRIVER_ID,:DATE_BEGIN);

    EXECUTE PROCEDURE EVENT_REFRESH_SHIFTS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

    IF (PARK_ID IS NOT NULL) THEN BEGIN

      UPDATE PARK_STATES
         SET DATE_OUT=:DATE_BEGIN
       WHERE DRIVER_ID=:DRIVER_ID
         AND DATE_OUT IS NULL;

      INSERT INTO PARK_STATES(PARK_STATE_ID,DRIVER_ID,PARK_ID,DATE_IN)
           VALUES (GET_UNIQUE_ID(),:DRIVER_ID,:PARK_ID,:DATE_BEGIN);

      EXECUTE PROCEDURE EVENT_REFRESH_PARK_STATES('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

      SELECT COUNT(*)
        FROM DRIVERS
       WHERE CAR_ID NOT IN (SELECT CAR_ID FROM CAR_IN_TYPES WHERE CAR_TYPE_ID='3ABB8D734F5E91C84D73CB136150304B') /* не Комфорт */
         AND DRIVER_ID=:DRIVER_ID
        INTO :CNT;

      IF (CNT>0) THEN

        PRIORITY=1;

      ELSE BEGIN

        SELECT COUNT(*)
          FROM PARK_STATES P
          JOIN DRIVERS D ON D.DRIVER_ID = P.DRIVER_ID
         WHERE P.PARK_ID=:PARK_ID
           AND P.DATE_OUT IS NULL
           AND D.CAR_ID IN (SELECT CAR_ID FROM CAR_IN_TYPES WHERE CAR_TYPE_ID='3ABB8D734F5E91C84D73CB136150304B') /* Комфорт */
          INTO :PRIORITY;

      END

      SELECT CONST_VALUE FROM GET_CONST_VALUE('D98222D30163A3FE4B647ABF4A2C179F') INTO :S;

      IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        SELECT NAME, DESCRIPTION
          FROM PARKS
         WHERE PARK_ID=:PARK_ID
          INTO :PARK_NAME, :PARK_DESCRIPTION;

        S=REPLACE_STRING(S,'%PRIORITY',CAST(PRIORITY AS VARCHAR(10)));
        S=REPLACE_STRING(S,'%PARK_NAME',PARK_NAME);
        S=REPLACE_STRING(S,'%PARK_DESCRIPTION',PARK_DESCRIPTION);
        S=REPLACE_STRING(S,'%BALANCE',CAST(BALANCE AS VARCHAR(30)));

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                  LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                  :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,0,
                                  NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
      END

    END ELSE BEGIN

      SELECT CONST_VALUE FROM GET_CONST_VALUE('C83CCF38CF6CAB374FAB6FA49754B07F') INTO :S;

      IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        S=REPLACE_STRING(S,'%BALANCE',CAST(BALANCE AS VARCHAR(30)));

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                  LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                  :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,0,
                                  NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE I_DRIVER_PARK
(
  SESSION_ID VARCHAR(32),
  DRIVER_ID VARCHAR(32),
  PARK_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  DATE_IN TIMESTAMP
)
AS
DECLARE SUM_CHARGE NUMERIC(15,2);
DECLARE SUM_RECEIPT NUMERIC(15,2);
DECLARE BALANCE NUMERIC(15,2);
DECLARE MIN_BALANCE NUMERIC(15,2);
DECLARE CONTACT VARCHAR(100);
DECLARE PARK_NAME VARCHAR(100);
DECLARE PARK_DESCRIPTION VARCHAR(250);
DECLARE PRIORITY INTEGER;
DECLARE S VARCHAR(1000);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
DECLARE CNT INTEGER;
BEGIN

  SELECT D.MIN_BALANCE, A.PHONE, A.FIRM_ID
    FROM DRIVERS D
    JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
   WHERE DRIVER_ID=:DRIVER_ID
    INTO :MIN_BALANCE, :CONTACT, :FIRM_ID;

  EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:DRIVER_ID)
   RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

  IF ((MIN_BALANCE IS NULL) OR ((MIN_BALANCE IS NOT NULL) AND (BALANCE>MIN_BALANCE))) THEN BEGIN

    INSERT INTO PARK_STATES(PARK_STATE_ID,DRIVER_ID,PARK_ID,DATE_IN)
         VALUES (GET_UNIQUE_ID(),:DRIVER_ID,:PARK_ID,:DATE_IN);

    EXECUTE PROCEDURE EVENT_REFRESH_PARK_STATES('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

    SELECT COUNT(*)
      FROM DRIVERS
     WHERE CAR_ID NOT IN (SELECT CAR_ID FROM CAR_IN_TYPES WHERE CAR_TYPE_ID='3ABB8D734F5E91C84D73CB136150304B') /* ia Eiioi?o */
       AND DRIVER_ID=:DRIVER_ID
      INTO :CNT;

    IF (CNT>0) THEN

      PRIORITY=1;

    ELSE BEGIN

      SELECT COUNT(*)
        FROM PARK_STATES P
        JOIN DRIVERS D ON D.DRIVER_ID = P.DRIVER_ID
       WHERE P.PARK_ID=:PARK_ID
         AND P.DATE_OUT IS NULL
         AND D.CAR_ID IN (SELECT CAR_ID FROM CAR_IN_TYPES WHERE CAR_TYPE_ID='3ABB8D734F5E91C84D73CB136150304B') /* Eiioi?o */
        INTO :PRIORITY;

    END

    SELECT CONST_VALUE FROM GET_CONST_VALUE('D98222D30163A3FE4B647ABF4A2C179F') INTO :S;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL,CONTACT)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      SELECT NAME, DESCRIPTION
        FROM PARKS
       WHERE PARK_ID=:PARK_ID
        INTO :PARK_NAME, :PARK_DESCRIPTION;

      S=REPLACE_STRING(S,'%PRIORITY',CAST(PRIORITY AS VARCHAR(10)));
      S=REPLACE_STRING(S,'%PARK_NAME',PARK_NAME);
      S=REPLACE_STRING(S,'%PARK_DESCRIPTION',PARK_DESCRIPTION);
      S=REPLACE_STRING(S,'%BALANCE',CAST(BALANCE AS VARCHAR(30)));

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
    END

  END
END

--

CREATE OR ALTER PROCEDURE TRY_PARK_IN
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  DRIVER_ID VARCHAR(32),
  CODE VARCHAR(100),
  TYPE_MESSAGE INTEGER
)
AS
DECLARE S VARCHAR(1000);
DECLARE PHONE VARCHAR(100);
DECLARE CNT INTEGER;
DECLARE SUM_CHARGE NUMERIC(15,2);
DECLARE SUM_RECEIPT NUMERIC(15,2);
DECLARE BALANCE NUMERIC(15,2);
DECLARE MIN_BALANCE NUMERIC(15,2);
DECLARE D TIMESTAMP;
DECLARE PARK_ID VARCHAR(32);
DECLARE PARK_NAME VARCHAR(100);
DECLARE PARK_DESCRIPTION VARCHAR(250);
DECLARE PRIORITY INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
DECLARE PARK_ID_TEMP VARCHAR(32);
BEGIN

  IF ((DRIVER_ID IS NOT NULL) AND (CODE IS NOT NULL)) THEN BEGIN

    SELECT D.MIN_BALANCE, A.PHONE, A.FIRM_ID
      FROM DRIVERS D
      JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
     WHERE D.DRIVER_ID=:DRIVER_ID
       AND A.LOCKED<>1
      INTO :MIN_BALANCE, :PHONE, :FIRM_ID;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,TYPE_MESSAGE,PHONE)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    IF (PHONE IS NOT NULL) THEN BEGIN

      EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:DRIVER_ID)
       RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

      IF ((MIN_BALANCE IS NULL) OR ((MIN_BALANCE IS NOT NULL) AND (BALANCE>MIN_BALANCE))) THEN BEGIN

        SELECT COUNT(*)
          FROM ORDERS
         WHERE DRIVER_ID=:DRIVER_ID
           AND PARENT_ID IS NULL
           AND DATE_HISTORY IS NULL
           AND FINISHED<>1
          INTO :CNT;

        IF (CNT>0) THEN BEGIN

          SELECT CONST_VALUE FROM GET_CONST_VALUE('764B2BA8498AB18345852AA2FE39F4D9') INTO :S;

          IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

            INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                      TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                      PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                              VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                      :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                      2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
          END

        END ELSE BEGIN

          UPDATE PARK_STATES
             SET DATE_OUT=CURRENT_TIMESTAMP
           WHERE DRIVER_ID=:DRIVER_ID
             AND DATE_OUT IS NULL;

          EXECUTE PROCEDURE EVENT_REFRESH_PARK_STATES('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

          SELECT COUNT(*)
            FROM SHIFTS
           WHERE ACCOUNT_ID=:DRIVER_ID
             AND DATE_END IS NULL
            INTO :CNT;

          D=CURRENT_TIMESTAMP;

          IF (CNT=0) THEN BEGIN

            INSERT INTO SHIFTS (SHIFT_ID,ACCOUNT_ID,DATE_BEGIN,DATE_END)
                        VALUES (GET_UNIQUE_ID(),:DRIVER_ID,:D,NULL);

            EXECUTE PROCEDURE EVENT_REFRESH_SHIFTS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

          END

          PARK_ID=NULL;
          PARK_NAME=NULL;

          FOR SELECT P.PARK_ID, P.NAME, P.DESCRIPTION
                FROM PARKS P
               WHERE (((P.MAX_COUNT IS NOT NULL) AND
                       (P.MAX_COUNT> (SELECT COUNT(*)
                                        FROM PARK_STATES
                                       WHERE DATE_OUT IS NULL
                                         AND PARK_ID=P.PARK_ID)))
                       OR (P.MAX_COUNT IS NULL))
                 AND P.NAME=:CODE
                INTO :PARK_ID, :PARK_NAME, :PARK_DESCRIPTION  DO BEGIN
            BREAK;
          END

          IF (PARK_ID IS NOT NULL) THEN BEGIN

            INSERT INTO PARK_STATES (PARK_STATE_ID,PARK_ID,DRIVER_ID,DATE_IN,DATE_OUT)
                             VALUES (GET_UNIQUE_ID(),:PARK_ID,:DRIVER_ID,:D,NULL);

            SELECT COUNT(*)
              FROM DRIVERS
             WHERE CAR_ID NOT IN (SELECT CAR_ID FROM CAR_IN_TYPES WHERE CAR_TYPE_ID='3ABB8D734F5E91C84D73CB136150304B') /* не Комфорт */
               AND DRIVER_ID=:DRIVER_ID
              INTO :CNT;

            IF (CNT>0) THEN

              PRIORITY=1;

            ELSE BEGIN

              SELECT COUNT(*)
                FROM PARK_STATES P
                JOIN DRIVERS D ON D.DRIVER_ID = P.DRIVER_ID
               WHERE P.PARK_ID=:PARK_ID
                 AND P.DATE_OUT IS NULL
                 AND D.CAR_ID IN (SELECT CAR_ID FROM CAR_IN_TYPES WHERE CAR_TYPE_ID='3ABB8D734F5E91C84D73CB136150304B') /* Комфорт */
                INTO :PRIORITY;

            END


            SELECT CONST_VALUE FROM GET_CONST_VALUE('80627FCA459EA3574F6BA8730F32946F') INTO :S;

            IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

              S=REPLACE_STRING(S,'%PRIORITY',CAST(PRIORITY AS VARCHAR(10)));
              S=REPLACE_STRING(S,'%PARK_NAME',PARK_NAME);
              S=REPLACE_STRING(S,'%PARK_DESCRIPTION',PARK_DESCRIPTION);
              S=REPLACE_STRING(S,'%BALANCE',CAST(BALANCE AS VARCHAR(30)));

              INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                        TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                        PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                                VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                        :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                        1,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
            END

          END ELSE BEGIN

            SELECT CONST_VALUE FROM GET_CONST_VALUE('18B1E217D3789DDF4BCE1EEE9C7AB7A5') INTO :S;

            IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

              INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                        TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                        PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                                VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                        :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                        1,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
            END

          END

        END

      END ELSE BEGIN

        SELECT CONST_VALUE FROM GET_CONST_VALUE('0690BD9649C89DD8472558C3270F35D6') INTO :S;

        IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                    PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                    :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                    1,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
        END

      END

    END

  END
END

--

CREATE OR ALTER PROCEDURE QUERY_PARK_STATES
(
  ORDER_ID VARCHAR(32),
  CREATOR_ID VARCHAR(32),
  RECIPIENT_ID VARCHAR(32),
  CONTACT VARCHAR(100),
  TYPE_MESSAGE INTEGER
)
AS
DECLARE S VARCHAR(1000);
DECLARE F VARCHAR(1000);
DECLARE S1 VARCHAR(1000);
DECLARE PARK_NAME VARCHAR(100);
DECLARE CNT INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN
  IF ((CREATOR_ID IS NOT NULL) AND (CONTACT IS NOT NULL)) THEN BEGIN

    S='';

    SELECT CONST_VALUE FROM GET_CONST_VALUE('A3D890F68FF0BDCC4B42C3135174ABEF') INTO :F;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(RECIPIENT_ID,TYPE_MESSAGE,CONTACT)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    IF ((F IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      SELECT COUNT(*)
        FROM DRIVERS
       WHERE CAR_ID NOT IN (SELECT CAR_ID FROM CAR_IN_TYPES WHERE CAR_TYPE_ID='3ABB8D734F5E91C84D73CB136150304B') /* ia Eiioi?o */
         AND DRIVER_ID=:RECIPIENT_ID
        INTO :CNT;

      IF (CNT>0) THEN BEGIN

        FOR SELECT P.NAME, 0
              FROM PARKS P
             ORDER BY P.PRIORITY
              INTO :PARK_NAME, :CNT DO BEGIN

          S1=F;
          S1=REPLACE_STRING(S1,'%PARK_NAME',:PARK_NAME);
          S1=REPLACE_STRING(S1,'%COUNT',CAST(CNT AS VARCHAR(10)));
          S=S||S1;

        END

      END ELSE BEGIN

        FOR SELECT P.NAME,
                   (
                    SELECT COUNT(*)
                      FROM PARK_STATES PS
                      JOIN DRIVERS D ON D.DRIVER_ID = PS.DRIVER_ID
                     WHERE PS.DATE_OUT IS NULL
                       AND PS.PARK_ID=P.PARK_ID
                       AND D.CAR_ID IN (SELECT CAR_ID FROM CAR_IN_TYPES WHERE CAR_TYPE_ID='3ABB8D734F5E91C84D73CB136150304B') /* Eiioi?o */
                    )
              FROM PARKS P
             ORDER BY P.PRIORITY
              INTO :PARK_NAME, :CNT DO BEGIN

          S1=F;
          S1=REPLACE_STRING(S1,'%PARK_NAME',:PARK_NAME);
          S1=REPLACE_STRING(S1,'%COUNT',CAST(CNT AS VARCHAR(10)));
          S=S||S1;

        END

      END

      SELECT FIRM_ID
        FROM ACCOUNTS
       WHERE ACCOUNT_ID=:RECIPIENT_ID
        INTO :FIRM_ID;

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:CREATOR_ID,:RECIPIENT_ID,CURRENT_TIMESTAMP,
                               :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,
                               1,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
    END

  END

END

--

CREATE OR ALTER PROCEDURE CODE_REFUSE_ORDER
(
  SESSION_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  IN_MESSAGE_ID VARCHAR(32)
)
AS
DECLARE CONTACT VARCHAR(100);
DECLARE SENDER_ID VARCHAR(32);
DECLARE S1 VARCHAR(250);
DECLARE S2 VARCHAR(250);
DECLARE S3 VARCHAR(250);
DECLARE S4 VARCHAR(1250);
DECLARE S5 VARCHAR(1250);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE CNT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
DECLARE ORDER_ID VARCHAR(32);
DECLARE ORDER_NUM VARCHAR(1000);
DECLARE DISPATCHERS_ID VARCHAR(32) = 'FF7F332564F795C8411BF28652B22BEA';
DECLARE APPLICATION_ID VARCHAR(32) = 'A35F5701A7AA920E40812A71A690910D';
DECLARE SUCCESS INTEGER;
DECLARE STREET_ID VARCHAR(32);
DECLARE HOUSE VARCHAR(10);
DECLARE FLAT VARCHAR(10);
DECLARE PORCH VARCHAR(10);
DECLARE ACTION_ID VARCHAR(32);
DECLARE USER_NAME VARCHAR(100);
DECLARE ADDRESS VARCHAR(1000);
BEGIN
  SELECT CONTACT, SENDER_ID, TYPE_MESSAGE, FIRM_ID
    FROM IN_MESSAGES
   WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, :TYPE_MESSAGE, :FIRM_ID;

  IF (CONTACT IS NOT NULL) THEN BEGIN
  
    EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE,CONTACT)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    SELECT COUNT(*)
      FROM ORDERS
     WHERE PHONE=:CONTACT
       AND FINISHED=0
       AND DATE_HISTORY IS NULL
      INTO :CNT;

    IF (CNT=0) THEN BEGIN

      SELECT CONST_VALUE FROM GET_CONST_VALUE_TYPE_MESSAGE('3811EDCE61B287C04002E9EE763AB7A8',:TYPE_MESSAGE) INTO :S5;

      IF ((S5 IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                  PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID,MESSAGE_ID,SOURCE)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                  :S5,NULL,:TYPE_MESSAGE,:CONTACT,NULL,
                                  2,NULL,CURRENT_TIMESTAMP,NULL,:DEST_PORT,:FIRM_ID,NULL,NULL);

      END

    END ELSE BEGIN

      SELECT CONST_VALUE FROM GET_CONST_VALUE('3F24C5A1359196CF433FE116223EB2B3') INTO :S1;

      SELECT CONST_VALUE FROM GET_CONST_VALUE('F213E7AA323484464EECA9D5A5FF4133') INTO :S2;

      SELECT CONST_VALUE FROM GET_CONST_VALUE_TYPE_MESSAGE('D0A0EEA55ED698F348C167CA56E6FDF2',:TYPE_MESSAGE) INTO :S3;
    
      FOR SELECT O.ORDER_ID, O.ORDER_NUM, O.FIRM_ID, O.ACTION_ID,
                 O.STREET_ID, O.HOUSE, O.FLAT, O.PORCH, A.USER_NAME
            FROM ORDERS O
            LEFT JOIN CLIENTS C ON C.CLIENT_ID=O.CLIENT_ID
            LEFT JOIN ACCOUNTS A ON A.ACCOUNT_ID=C.CLIENT_ID
           WHERE O.PHONE=:CONTACT
             AND O.FINISHED=0
             AND O.DATE_HISTORY IS NULL
            INTO :ORDER_ID, :ORDER_NUM, :FIRM_ID, :ACTION_ID,
                 :STREET_ID, :HOUSE, :FLAT, :PORCH, :USER_NAME DO BEGIN


        EXECUTE PROCEDURE REFUSE_ORDER_BY_CLIENT(SESSION_ID,ACCOUNT_ID,ORDER_ID)
         RETURNING_VALUES ORDER_ID;
       
        S4=S2;
      
        IF ((S1 IS NOT NULL) AND (S4 IS NOT NULL)) THEN BEGIN
      
          EXECUTE PROCEDURE GET_ADDRESS(STREET_ID,HOUSE,FLAT,PORCH)
           RETURNING_VALUES ADDRESS;
         
          S4=REPLACE_STRING(S4,'%USER_NAME',USER_NAME);
          S4=REPLACE_STRING(S4,'%PHONE',CONTACT);
          S4=REPLACE_STRING(S4,'%ADDRESS',ADDRESS);
        
          IN AUTONOMOUS TRANSACTION DO BEGIN

            INSERT INTO ALARMS (ALARM_ID,SENDER_ID,RECIPIENT_ID,TYPE_ALARM,
                                DATE_BEGIN,DATE_END,CAPTION,TEXT_ALARM)
                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DISPATCHERS_ID,0,
                                CURRENT_TIMESTAMP,DATEADD(MINUTE,5,CURRENT_TIMESTAMP),:S1,:S4);

          END

          EXECUTE PROCEDURE EVENT_ALARM(APPLICATION_ID,DISPATCHERS_ID,SESSION_ID,0)
           RETURNING_VALUES SUCCESS;
        
        END

        S5=S3;
      
        IF ((S5 IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN
      
          IF (TYPE_MESSAGE=2) THEN
            ORDER_NUM=NUMBER_TO_WORDS(CAST(ORDER_NUM AS INTEGER),1);

          S5=REPLACE_STRING(S5,'%ORDER_NUM',ORDER_NUM);
      
          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                    PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                    :S5,NULL,:TYPE_MESSAGE,:CONTACT,NULL,
                                    2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
                                  
        END

      END
      
    END
    
  END

END

--

CREATE INDEX IDX_ORDERS_PHONE
ON ORDERS (PHONE)

--

CREATE OR ALTER PROCEDURE BREAK_STRING
(
  IN_STRING VARCHAR(1000),
  FROM_POSITION INTEGER,
  FROM_LENGTH INTEGER,
  DELIM VARCHAR(10),
  SYMBOL_COUNT INTEGER
)
RETURNS
(
  OUT_STRING VARCHAR(2000)
)
AS
DECLARE L INTEGER;
DECLARE TEMP VARCHAR(2000);
DECLARE S VARCHAR(1000);
DECLARE POS INTEGER;
BEGIN
  OUT_STRING=IN_STRING;
  IF (IN_STRING IS NOT NULL) THEN BEGIN

    L=STRING_LENGTH(IN_STRING);

    IF (FROM_POSITION IS NULL) THEN
      FROM_POSITION=1;

    IF (FROM_LENGTH IS NULL) THEN
      FROM_LENGTH=L;

    IF (DELIM IS NULL) THEN
      DELIM=' ';

    IF (SYMBOL_COUNT IS NULL) THEN
      SYMBOL_COUNT=1;

    IF ((FROM_POSITION<L) AND (SYMBOL_COUNT>0)) THEN BEGIN

      TEMP=SUB_STRING(IN_STRING,FROM_POSITION,FROM_LENGTH);
      OUT_STRING='';
      POS=0;
      WHILE (POS<FROM_LENGTH) DO BEGIN

        POS=POS+1;

        OUT_STRING=OUT_STRING||SUB_STRING(TEMP,POS,1);

        IF ((MOD(POS,SYMBOL_COUNT)=0) AND (POS<FROM_LENGTH)) THEN
          OUT_STRING=OUT_STRING||DELIM;
      END

      S=SUB_STRING(IN_STRING,1,FROM_POSITION-1);
      IF (STRING_LENGTH(S)>0) THEN
        S=S||DELIM;

      OUT_STRING=S||OUT_STRING;

      S=SUB_STRING(IN_STRING,FROM_POSITION+FROM_LENGTH,L-(FROM_POSITION+FROM_LENGTH-1));
      IF (STRING_LENGTH(S)>0) THEN
        S=DELIM||S;

      OUT_STRING=OUT_STRING||S;

    END

  END
END

--

CREATE OR ALTER PROCEDURE BREAK_PHONE
(
  IN_PHONE VARCHAR(100)
)
RETURNS
(
  OUT_PHONE VARCHAR(100)
)
AS
DECLARE L INTEGER;
DECLARE TEMP VARCHAR(100);
BEGIN
  OUT_PHONE=IN_PHONE;
  IF (IN_PHONE IS NOT NULL) THEN BEGIN

    TEMP=REPLACE_STRING(IN_PHONE,' ','');

    L=STRING_LENGTH(TEMP);

    IF (L=7) THEN BEGIN

      /* 2932332 => 2 932 332 */

      EXECUTE PROCEDURE BREAK_STRING(TEMP,2,6,' ',3)
       RETURNING_VALUES OUT_PHONE;

    END

    IF (L=12) THEN BEGIN

      /* +79029232332 => +7 902 923 2332 */

      EXECUTE PROCEDURE BREAK_STRING(TEMP,3,6,' ',3)
       RETURNING_VALUES TEMP;

      /* +7 902 923 2332 => +7 902 923 23 32 */

      EXECUTE PROCEDURE BREAK_STRING(TEMP,12,4,' ',2)
       RETURNING_VALUES OUT_PHONE;


    END

  END
END

--

CREATE OR ALTER PROCEDURE GET_CALL_INFO 
(
  CALL_INFO VARCHAR(100)
)
RETURNS
(
  CALL_ACCOUNT_ID VARCHAR(32),
  CALL_NAME VARCHAR(100),
  CALL_REAL_NAME VARCHAR(100),
  CALL_GROUP VARCHAR(4000),
  CALL_DESCRIPTION VARCHAR(250),
  CALL_NAME_DESCRIPTION VARCHAR(250),
  CALL_LINE_NAME VARCHAR(100)
)
AS
DECLARE CALL_ID VARCHAR(32);
DECLARE OPERATOR_ID VARCHAR(32);
DECLARE CALL_PHONE VARCHAR(100);
DECLARE CALLER_DIVERSION VARCHAR(100);
DECLARE IN_CHANNEL VARCHAR(100);
DECLARE PHONE VARCHAR(100);
DECLARE USER_NAME VARCHAR(100);
DECLARE SURNAME VARCHAR(100);
DECLARE NAME VARCHAR(100);
DECLARE PATRONYMIC VARCHAR(100);
DECLARE FIRM_SMALL_NAME VARCHAR(250);
DECLARE CLIENT_GROUP_ID VARCHAR(32);
DECLARE CALL_KIND INTEGER;
DECLARE S VARCHAR(250);
DECLARE L INTEGER;
DECLARE RANGE_MIN BIGINT;
DECLARE RANGE_MAX BIGINT;
DECLARE PHONE_NUM BIGINT;
BEGIN
  CALL_ACCOUNT_ID=NULL;
  CALL_REAL_NAME='Номер скрыт';
  CALL_GROUP='Неизвестно';
  CALL_DESCRIPTION=NULL;
  CALL_KIND=0; /* Unknown */
  CALL_NAME_DESCRIPTION=NULL;
  CALL_LINE_NAME=NULL;

  SELECT C.CALL_ID, C.CALLER_ID, C.CALLER_PHONE,
         C.CALLER_DIVERSION, C.IN_CHANNEL, O.NAME
    FROM CALLS C
    LEFT JOIN OPERATORS O ON O.OPERATOR_ID=C.OPERATOR_ID
   WHERE CALL_ID=:CALL_INFO
    INTO :CALL_ID, :CALL_ACCOUNT_ID, :CALL_PHONE,
         :CALLER_DIVERSION, :IN_CHANNEL, :CALL_NAME_DESCRIPTION;

  IF (CALL_ID IS NOT NULL) THEN BEGIN

    IF (IN_CHANNEL IS NOT NULL) THEN BEGIN

      IN_CHANNEL=SUB_STRING(IN_CHANNEL,STRING_LENGTH('CallServerSipChannel')+1,STRING_LENGTH(IN_CHANNEL));

      CALL_LINE_NAME=IN_CHANNEL;

    END

    IF (CALLER_DIVERSION IS NOT NULL) THEN BEGIN

      IF (CALLER_DIVERSION='3912777787') THEN
        CALL_LINE_NAME='2777787';

      IF (CALLER_DIVERSION='3912550550') THEN
        CALL_LINE_NAME='2550550';

      IF (CALLER_DIVERSION='3912550550') THEN
        CALL_LINE_NAME='2550550';

    END

    IF (CALL_LINE_NAME IS NOT NULL) THEN
      CALL_LINE_NAME=''||CALL_LINE_NAME;

  END ELSE BEGIN

    EXECUTE PROCEDURE GET_OPERATOR(CALL_INFO)
     RETURNING_VALUES OPERATOR_ID, RANGE_MIN, RANGE_MAX, PHONE_NUM;

    IF (OPERATOR_ID IS NOT NULL) THEN
      SELECT NAME
        FROM OPERATORS
       WHERE OPERATOR_ID=:OPERATOR_ID
        INTO :CALL_NAME_DESCRIPTION;

  END

  IF (CALL_ACCOUNT_ID IS NULL) THEN BEGIN

    IF (CALL_PHONE IS NULL) THEN
      CALL_PHONE=:CALL_INFO;

    FOR SELECT A.ACCOUNT_ID
          FROM CLIENTS C
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=C.CLIENT_ID
          LEFT JOIN CLIENT_PHONES CP ON CP.CLIENT_ID=C.CLIENT_ID
         WHERE CP.PHONE=:CALL_PHONE
            OR A.PHONE=:CALL_PHONE
          INTO :CALL_ACCOUNT_ID DO BEGIN
      CALL_KIND=1; /* Client */
      BREAK;
    END

    IF (CALL_ACCOUNT_ID IS NULL) THEN BEGIN

      FOR SELECT A.ACCOUNT_ID
            FROM ACCOUNTS A
            JOIN DRIVERS D ON D.DRIVER_ID=A.ACCOUNT_ID
           WHERE A.PHONE=:CALL_PHONE
            INTO :CALL_ACCOUNT_ID DO BEGIN
        CALL_KIND=2; /* Driver */
        BREAK;
      END

      IF (CALL_ACCOUNT_ID IS NULL) THEN BEGIN

        FOR SELECT A.ACCOUNT_ID
              FROM ACCOUNTS A
              JOIN DISPATCHERS D ON D.DISPATCHER_ID=A.ACCOUNT_ID
             WHERE A.PHONE=:CALL_PHONE
              INTO :CALL_ACCOUNT_ID DO BEGIN
          CALL_KIND=3; /* Dispatcher */
          BREAK;
        END

        IF (CALL_ACCOUNT_ID IS NULL) THEN BEGIN

          FOR SELECT A.ACCOUNT_ID
                FROM ACCOUNTS A
               WHERE A.PHONE=:CALL_PHONE
              INTO :CALL_ACCOUNT_ID DO BEGIN
            CALL_KIND=4; /* Account */
            BREAK;
          END

        END

      END

    END

  END

  IF (CALL_PHONE IS NOT NULL) THEN BEGIN

    CALL_REAL_NAME=TRIM(CALL_PHONE);

    EXECUTE PROCEDURE BREAK_PHONE(CALL_REAL_NAME)
     RETURNING_VALUES CALL_REAL_NAME;

  END ELSE
    CALL_REAL_NAME=TRIM(CALL_PHONE);


  IF (CALL_ACCOUNT_ID IS NOT NULL) THEN BEGIN

    IF (CALL_KIND=0) THEN BEGIN

      SELECT CASE
               WHEN C.CLIENT_ID IS NOT NULL THEN 1 /* Client */
               WHEN D1.DRIVER_ID IS NOT NULL THEN 2 /* Driver */
               WHEN D2.DISPATCHER_ID IS NOT NULL THEN 3 /* Dispatcher */
               ELSE 4
             END
        FROM ACCOUNTS A
        LEFT JOIN CLIENTS C ON C.CLIENT_ID=A.ACCOUNT_ID
        LEFT JOIN DRIVERS D1 ON D1.DRIVER_ID=A.ACCOUNT_ID
        LEFT JOIN DISPATCHERS D2 ON D2.DISPATCHER_ID=A.ACCOUNT_ID
       WHERE A.ACCOUNT_ID=:CALL_ACCOUNT_ID
        INTO :CALL_KIND;

    END

    FOR SELECT A.USER_NAME, A.SURNAME, A.NAME,
               A.PATRONYMIC, F.SMALL_NAME
          FROM ACCOUNTS A
          LEFT JOIN FIRMS F ON F.FIRM_ID=A.FIRM_ID
         WHERE A.ACCOUNT_ID=:CALL_ACCOUNT_ID
          INTO :USER_NAME, :SURNAME, :NAME,
               :PATRONYMIC, :FIRM_SMALL_NAME DO BEGIN
      BREAK;
    END

    CALL_DESCRIPTION=NULL;
    IF (NAME IS NOT NULL) THEN
      CALL_DESCRIPTION=TRIM(NAME);
    IF (PATRONYMIC IS NOT NULL) THEN
      CALL_DESCRIPTION=CALL_DESCRIPTION||' '||TRIM(PATRONYMIC);
    IF (USER_NAME IS NOT NULL) THEN
      CALL_DESCRIPTION=TRIM(USER_NAME)||' - '||CALL_DESCRIPTION;
    IF (FIRM_SMALL_NAME IS NOT NULL) THEN
      CALL_DESCRIPTION=CALL_DESCRIPTION||' ['||TRIM(FIRM_SMALL_NAME)||']';

    IF (CALL_KIND=1) THEN BEGIN

      FOR SELECT LOWER(CP.DESCRIPTION)
            FROM CLIENT_PHONES CP
           WHERE CP.PHONE=:CALL_PHONE
             AND CP.CLIENT_ID=:CALL_ACCOUNT_ID
            INTO :S DO BEGIN

        CALL_NAME_DESCRIPTION=TRIM(S||' '||CALL_NAME_DESCRIPTION);
        BREAK;
      END

      CLIENT_GROUP_ID=NULL;

      SELECT CLIENT_GROUP_ID
        FROM CLIENTS
       WHERE CLIENT_ID=:CALL_ACCOUNT_ID
        INTO :CLIENT_GROUP_ID;

      IF (CLIENT_GROUP_ID IS NOT NULL) THEN BEGIN

        CALL_GROUP=NULL;

        EXECUTE PROCEDURE GET_CLIENT_GROUP_PATH(CLIENT_GROUP_ID,'/')
         RETURNING_VALUES CALL_GROUP;

      END

      IF (CALL_GROUP IS NOT NULL) THEN
        CALL_GROUP='Клиенты/'||CALL_GROUP;
      ELSE
        CALL_GROUP='Клиенты';


    END ElSE BEGIN

      IF (CALL_KIND=2) THEN BEGIN

        CALL_GROUP='Водители';

      END ELSE BEGIN

        IF (CALL_KIND=3) THEN
          CALL_GROUP='Диспетчеры';
        ElSE
          CALL_GROUP='Учетные записи';

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE STRING_AS_TABLE
(
  IN_STRING VARCHAR(32000),
  DELIM VARCHAR(100)
)
RETURNS
(
  OUT_STRING VARCHAR(32000)
)
AS
DECLARE POS INTEGER;
DECLARE TEMP VARCHAR(32000);
DECLARE L INTEGER;
BEGIN
  IF (DELIM IS NULL) THEN BEGIN

    OUT_STRING=IN_STRING;
    SUSPEND;

  END ELSE BEGIN

    IF (IN_STRING IS NOT NULL) THEN BEGIN

      L=STRING_LENGTH(DELIM);
      TEMP=IN_STRING;
      POS=-1;
      WHILE (POS<>0) DO BEGIN

        POS=POSITION(DELIM,TEMP);
        IF (POS>0) THEN BEGIN

          OUT_STRING=SUB_STRING(TEMP,1,POS-1);
          TEMP=SUB_STRING(TEMP,POS+L,STRING_LENGTH(TEMP));

        END ELSE
          OUT_STRING=TEMP;

        SUSPEND;

      END

    END

  END
END

--

DECLARE EXTERNAL FUNCTION STRING_TO_NUMBER
    CSTRING(32767),
    DOUBLE PRECISION
RETURNS DOUBLE PRECISION BY VALUE
ENTRY_POINT 'STRING_TO_NUMBER' MODULE_NAME 'udfibase.dll';

--

CREATE OR ALTER PROCEDURE GET_STRING_NUMBER
(
  IN_STRING VARCHAR(1000)
)
RETURNS
(
  OUT_STRING VARCHAR(1000)
)
AS
DECLARE N DOUBLE PRECISION;
DECLARE L INTEGER;
DECLARE DEF DOUBLE PRECISION;
DECLARE TEMP VARCHAR(1000);
DECLARE POS INTEGER;
DECLARE SYMBOL VARCHAR(1);
DECLARE S VARCHAR(1000);
BEGIN
  OUT_STRING=IN_STRING;

  IF (IN_STRING IS NOT NULL) THEN BEGIN

    TEMP=TRIM(IN_STRING);
    TEMP=REPLACE_STRING(TEMP,' ','');
    L=STRING_LENGTH(TEMP);

    DEF=RANDOM(-1000);
    N=STRING_TO_NUMBER(TEMP,DEF);

    IF (N<>DEF) THEN BEGIN

      S='';
      POS=0;

      WHILE (POS<=L) DO BEGIN

        POS=POS+1;
        SYMBOL=SUB_STRING(TEMP,POS,1);

        IF (SYMBOL='0') THEN BEGIN

          N=STRING_TO_NUMBER(SYMBOL,0);
          S=S||' '||NUMBER_TO_WORDS(N,0);
          S=TRIM(S);

        END ELSE BEGIN

          TEMP=SUB_STRING(TEMP,POS,L);
          BREAK;

        END

      END

      S=TRIM(S);
      L=STRING_LENGTH(S);

      N=STRING_TO_NUMBER(TEMP,0);
      TEMP=NUMBER_TO_WORDS(N,1);

      OUT_STRING=S||IIF(L>0,' ','')||TEMP;
      OUT_STRING=TRIM(OUT_STRING);

    END

  END

END

--

CREATE OR ALTER PROCEDURE PREPARE_CAR_STATE_NUM
(
  IN_STATE_NUM VARCHAR(100),
  TYPE_MESSAGE INTEGER
)
RETURNS
(
  OUT_STATE_NUM VARCHAR(1000)
)
AS
DECLARE TEMP VARCHAR(1000);
DECLARE S VARCHAR(1000);
DECLARE L INTEGER;
BEGIN
  OUT_STATE_NUM=IN_STATE_NUM;

  IF (IN_STATE_NUM IS NULL) THEN BEGIN

    SELECT CONST_VALUE FROM GET_CONST_VALUE('313A576ED5608B9C48AF41BBCF4615B4') INTO :TEMP;

    IF (TEMP IS NOT NULL) THEN
      OUT_STATE_NUM=TEMP;

  END ELSE BEGIN

    /* а123бв => а сто двадцать три бв */

    TEMP=TRIM(IN_STATE_NUM);
    TEMP=REPLACE_STRING(TEMP,' ','');

    IF (TYPE_MESSAGE=2) THEN BEGIN

      L=STRING_LENGTH(TEMP);

      IF (L=6) THEN BEGIN

        S=SUB_STRING(TEMP,2,3);

        EXECUTE PROCEDURE GET_STRING_NUMBER(S)
         RETURNING_VALUES S;

        L=STRING_LENGTH(S);

        OUT_STATE_NUM=SUB_STRING(TEMP,1,1)||
                      IIF(L=0,' ','')||
                      S||
                      IIF(L=0,' ','')||
                      SUB_STRING(TEMP,5,2);

        OUT_STATE_NUM=TRIM(OUT_STATE_NUM);

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE PREPARE_ORDER_NUM
(
  IN_ORDER_NUM VARCHAR(10),
  TYPE_MESSAGE INTEGER
)
RETURNS
(
  OUT_ORDER_NUM VARCHAR(1000)
)
AS
DECLARE TEMP VARCHAR(1000);
DECLARE ORDER_NUM INTEGER;
DECLARE FLAG INTEGER;
BEGIN
  OUT_ORDER_NUM=IN_ORDER_NUM;
  IF (IN_ORDER_NUM IS NOT NULL) THEN BEGIN

    IF (TYPE_MESSAGE=2) THEN BEGIN

      /* 123456 => сто двадцать три четыреста пятьдесят шесть */

      EXECUTE PROCEDURE BREAK_STRING(IN_ORDER_NUM,1,NULL,' ',3)
       RETURNING_VALUES TEMP;

      OUT_ORDER_NUM='';
      FLAG=1;
      FOR SELECT OUT_STRING
            FROM STRING_AS_TABLE(:TEMP,' ')
            INTO :TEMP DO BEGIN

        ORDER_NUM=CAST(STRING_TO_NUMBER(TEMP,-1) AS INTEGER);

        IF (ORDER_NUM>-1) THEN BEGIN

          EXECUTE PROCEDURE GET_STRING_NUMBER(TEMP)
           RETURNING_VALUES TEMP;

          IF (FLAG=1) THEN BEGIN
            FLAG=0;
            OUT_ORDER_NUM=TEMP;
          END ELSE
            OUT_ORDER_NUM=TRIM(OUT_ORDER_NUM||' '||TEMP);
        END

      END

      OUT_ORDER_NUM=TRIM(OUT_ORDER_NUM);

    END

  END
END

--

CREATE OR ALTER PROCEDURE PREPARE_ORDER_COST
(
  IN_COST NUMERIC(15,2),
  TYPE_MESSAGE INTEGER
)
RETURNS
(
  OUT_COST VARCHAR(1000)
)
AS
DECLARE EMPTY_COST VARCHAR(1000);
BEGIN
  OUT_COST=CAST(CAST(IN_COST AS NUMERIC(15,0)) AS VARCHAR(30));

  IF ((IN_COST IS NULL) OR (IN_COST=0.0)) THEN BEGIN

    SELECT CONST_VALUE FROM GET_CONST_VALUE('5E8B0718844B97D344933425747269D7') INTO :EMPTY_COST;

    IF (EMPTY_COST IS NOT NULL) THEN
      OUT_COST=EMPTY_COST;

  END ELSE BEGIN

    IF (TYPE_MESSAGE=2) THEN BEGIN

      /* 123 => сто двадцать три рубля */

      OUT_COST=NUMBER_TO_WORDS(CAST(IN_COST AS NUMERIC(15,0)),4);

      OUT_COST=TRIM(OUT_COST);

    END

  END

END

--

CREATE OR ALTER PROCEDURE PREPARE_CAR_BRAND
(
  IN_BRAND VARCHAR(100),
  TYPE_MESSAGE INTEGER
)
RETURNS
(
  OUT_BRAND VARCHAR(1000)
)
AS
DECLARE TEMP1 VARCHAR(1000);
DECLARE TEMP2 VARCHAR(1000);
DECLARE FLAG1 INTEGER;
DECLARE FLAG2 INTEGER;
BEGIN
  OUT_BRAND=IN_BRAND;

  IF (IN_BRAND IS NOT NULL) THEN BEGIN

    IF (TYPE_MESSAGE=2) THEN BEGIN

      /* ЛАДА 21012 => ЛАДА двадцать один ноль двенадцать */

      FLAG2=1;
      OUT_BRAND='';

      FOR SELECT OUT_STRING
            FROM STRING_AS_TABLE(:IN_BRAND,' ')
            INTO :TEMP1 DO BEGIN

        FLAG1=STRING_TO_NUMBER(TEMP1,-1);

        IF (FLAG1>-1) THEN BEGIN

          EXECUTE PROCEDURE BREAK_STRING(TEMP1,1,2,' ',2)
           RETURNING_VALUES TEMP1;

          FLAG1=1;
          TEMP2=TEMP1;
          TEMP1='';

          FOR SELECT OUT_STRING
                FROM STRING_AS_TABLE(:TEMP2,' ')
                INTO :TEMP2 DO BEGIN

            EXECUTE PROCEDURE GET_STRING_NUMBER(TEMP2)
             RETURNING_VALUES TEMP2;

            IF (FLAG1=1) THEN BEGIN

              FLAG1=0;
              TEMP1=TEMP2;

            END ELSE
              TEMP1=TEMP1||' '||TEMP2;

          END

        END

        IF (FLAG2=1) THEN BEGIN

          FLAG2=0;
          OUT_BRAND=TEMP1;

        END ELSE
          OUT_BRAND=OUT_BRAND||' '||TEMP1;

      END

      OUT_BRAND=TRIM(OUT_BRAND);

    END

  END

END

--

CREATE OR ALTER PROCEDURE CODE_DETAIL_ORDER
(
  SESSION_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  IN_MESSAGE_ID VARCHAR(32)
)
AS
DECLARE CONTACT VARCHAR(100);
DECLARE SENDER_ID VARCHAR(32);
DECLARE TEXT_OUT VARCHAR(4000);
DECLARE S VARCHAR(4000);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE CNT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
DECLARE ORDER_ID VARCHAR(32);
DECLARE ORDER_NUM VARCHAR(1000);
DECLARE COLOR VARCHAR(100);
DECLARE BRAND VARCHAR(1000);
DECLARE STATE_NUM VARCHAR(1000);
DECLARE COST_RATE NUMERIC(15,2);
DECLARE SCOST_RATE VARCHAR(1000);
BEGIN
  SELECT CONTACT, SENDER_ID, TYPE_MESSAGE, FIRM_ID
    FROM IN_MESSAGES
   WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, :TYPE_MESSAGE, :FIRM_ID;

  IF (CONTACT IS NOT NULL) THEN BEGIN
  
    EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE,CONTACT)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    SELECT COUNT(*)
      FROM ORDERS
     WHERE PHONE=:CONTACT
       AND FINISHED=0
       AND DATE_HISTORY IS NULL
      INTO :CNT;

    IF (CNT=0) THEN BEGIN

      SELECT CONST_VALUE FROM GET_CONST_VALUE_TYPE_MESSAGE('3811EDCE61B287C04002E9EE763AB7A8',:TYPE_MESSAGE) INTO :TEXT_OUT;

      IF ((TEXT_OUT IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                  PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID,MESSAGE_ID,SOURCE)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                  :TEXT_OUT,NULL,:TYPE_MESSAGE,:CONTACT,NULL,
                                  2,NULL,CURRENT_TIMESTAMP,NULL,:DEST_PORT,:FIRM_ID,NULL,NULL);

      END

    END ELSE BEGIN

      SELECT CONST_VALUE FROM GET_CONST_VALUE_TYPE_MESSAGE('44881AE3C593B0DE40AB0651B86A0EC0',:TYPE_MESSAGE) INTO :TEXT_OUT;
    
      FOR SELECT O.ORDER_ID, O.ORDER_NUM, O.FIRM_ID, O.COST_RATE,
                 C.COLOR, C.BRAND, C.STATE_NUM
            FROM ORDERS O
            LEFT JOIN DRIVERS D ON D.DRIVER_ID=O.DRIVER_ID
            LEFT JOIN CARS C ON C.CAR_ID=D.CAR_ID
           WHERE O.PHONE=:CONTACT
             AND O.FINISHED=0
             AND O.DATE_HISTORY IS NULL
            INTO :ORDER_ID, :ORDER_NUM, :FIRM_ID, :COST_RATE,
                 :COLOR, :BRAND, :STATE_NUM DO BEGIN

        S=TEXT_OUT;

        IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

          EXECUTE PROCEDURE PREPARE_ORDER_NUM(ORDER_NUM,TYPE_MESSAGE)
           RETURNING_VALUES ORDER_NUM;

          EXECUTE PROCEDURE PREPARE_ORDER_COST(COST_RATE,TYPE_MESSAGE)
           RETURNING_VALUES SCOST_RATE;

          EXECUTE PROCEDURE PREPARE_CAR_BRAND(BRAND,TYPE_MESSAGE)
           RETURNING_VALUES BRAND;

          EXECUTE PROCEDURE PREPARE_CAR_STATE_NUM(STATE_NUM,TYPE_MESSAGE)
           RETURNING_VALUES STATE_NUM;

          S=REPLACE_STRING(S,'%ORDER_NUM',ORDER_NUM);
          S=REPLACE_STRING(S,'%COLOR',COLOR);
          S=REPLACE_STRING(S,'%BRAND',BRAND);
          S=REPLACE_STRING(S,'%STATE_NUM',STATE_NUM);
          S=REPLACE_STRING(S,'%COST_RATE',SCOST_RATE);

          IF (COLOR IS NULL) THEN
            S=REPLACE_STRING(S,'  ',' ');

          IF (BRAND IS NULL) THEN
            S=REPLACE_STRING(S,'  ',' ');

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                    PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                    :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,
                                    2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
                                  
        END

      END
      
    END
    
  END

END

--

CREATE OR ALTER PROCEDURE PROCESS_IN_MESSAGE
(
  SESSION_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  CONTACT VARCHAR(100),
  TEXT_IN VARCHAR(4000),
  TYPE_MESSAGE INTEGER,
  CHANNEL VARCHAR(100),
  FIRM_ID VARCHAR(32),
  OPERATOR_ID VARCHAR(32),
  LOCKED VARCHAR(32)
)
RETURNS (
    CODE_MESSAGE_ID VARCHAR(32),
    CODE VARCHAR(100),
    PROC_NAME VARCHAR(100),
    COMMAND_STRING VARCHAR(250),
    ANSWER VARCHAR(4000),
    IN_MESSAGE_ID VARCHAR(32),
    LOCK_COUNT INTEGER)
AS
DECLARE VARIABLE GRANTED INTEGER;
DECLARE VARIABLE OUT_MESSAGE_ID VARCHAR(32);
DECLARE VARIABLE MAX_ATTEMPTS INTEGER = 3;
DECLARE VARIABLE ATTEMPTS INTEGER;
DECLARE VARIABLE NEW_ATTEMPTS INTEGER;
DECLARE VARIABLE DATE_IN TIMESTAMP;
BEGIN

  LOCK_COUNT=0;

  EXECUTE PROCEDURE GET_CODE_MESSAGE(TEXT_IN)
   RETURNING_VALUES CODE_MESSAGE_ID,CODE,PROC_NAME,COMMAND_STRING,ANSWER;

  GRANTED=1;

  IF (ACCOUNT_ID IS NOT NULL) THEN

    EXECUTE PROCEDURE INCOMING_GRANTED(ACCOUNT_ID,TYPE_MESSAGE)
     RETURNING_VALUES GRANTED;

  IF (GRANTED=1) THEN BEGIN

    IN_MESSAGE_ID=GET_UNIQUE_ID();

    DATE_IN=CURRENT_TIMESTAMP;

    INSERT INTO IN_MESSAGES (IN_MESSAGE_ID,SENDER_ID,CODE_MESSAGE_ID,DATE_SEND,TEXT_IN,DATE_IN,
                             TYPE_MESSAGE,CONTACT,ORDER_ID,CHANNEL,DESCRIPTION,FIRM_ID,OPERATOR_ID)
                     VALUES (:IN_MESSAGE_ID,:ACCOUNT_ID,:CODE_MESSAGE_ID,CURRENT_TIMESTAMP,:TEXT_IN,:DATE_IN,
                             :TYPE_MESSAGE,:CONTACT,NULL,:CHANNEL,NULL,:FIRM_ID,:OPERATOR_ID);

    EXECUTE PROCEDURE EXECUTE_IN_MESSAGE(SESSION_ID,IN_MESSAGE_ID);

    FOR SELECT OUT_MESSAGE_ID, ATTEMPTS
          FROM OUT_MESSAGES
         WHERE ((RECIPIENT_ID IS NULL) OR (RECIPIENT_ID IS NOT NULL AND RECIPIENT_ID=:ACCOUNT_ID))
           AND CONTACT=:CONTACT
           AND DATE_OUT IS NULL
           AND LOCKED IS NULL
           AND TYPE_MESSAGE=:TYPE_MESSAGE
           AND DATE_CREATE>=:DATE_IN
           AND ((DATE_END IS NOT NULL AND DATE_END>=CURRENT_TIMESTAMP) OR DATE_END IS NULL)
           AND (ATTEMPTS IS NULL OR ATTEMPTS>0)
          INTO :OUT_MESSAGE_ID, :ATTEMPTS DO BEGIN

      IF (ATTEMPTS IS NULL) THEN
        NEW_ATTEMPTS=MAX_ATTEMPTS-1;
      ELSE
        NEW_ATTEMPTS=ATTEMPTS-1;

      UPDATE OUT_MESSAGES
         SET LOCKED=:LOCKED,
             CHANNEL=:CHANNEL,
             OPERATOR_ID=:OPERATOR_ID,
             ATTEMPTS=:NEW_ATTEMPTS
       WHERE OUT_MESSAGE_ID=:OUT_MESSAGE_ID;

      LOCK_COUNT=LOCK_COUNT+1;

    END

  END

END

--

CREATE OR ALTER PROCEDURE CHECK_SMS_OUTS
AS
DECLARE COU INTEGER;
DECLARE SS VARCHAR(1);
DECLARE OU SMALLINT;
BEGIN

  SELECT CONST_VALUE FROM GET_CONST_VALUE('BD93F18230F19238484EA5185725CD91') INTO :SS;

  IF (SS = '0') THEN BEGIN

    OU=0;

    FOR SELECT COUNT(S.OUT_MESSAGE_ID)
          FROM OUT_MESSAGES S, CONSTS Q
         WHERE Q.NAME = 'F6A8F09E1A9E80CA47857C44D07E5E5F'
           AND S.DATE_BEGIN >= CAST(Q."VALUE" AS TIMESTAMP)
           AND S.CHANNEL LIKE '%COM%'
         GROUP BY S.CHANNEL
          INTO :COU DO BEGIN

      IF (COU > 4700) THEN
        OU=1;

    END

    IF (OU = 1) THEN BEGIN


      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,LOCKED,DATE_BEGIN,DATE_END,ORDER_ID,
                                CHANNEL,DELIVERY,DATE_DELIVERY,FLASH,DEST_PORT,FIRM_ID,OPERATOR_ID,MESSAGE_ID,SOURCE,ATTEMPTS)
                        VALUES (GET_UNIQUE_ID(),'100603219B01A5F249B0D0E412152398','C6E25C10AA8085A54325222657DD40C5',CURRENT_TIMESTAMP,
                                'Надо симки поменять',NULL,0,'+79831593190','smsm',2,NULL,CURRENT_TIMESTAMP,NULL,NULL,
                                NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL);

      UPDATE CONSTS
         SET "VALUE" = '1'
       WHERE NAME = 'BD93F18230F19238484EA5185725CD91';

    END

  END

END

--

CREATE OR ALTER PROCEDURE CODE_GET_SMS_COUNT
(
  ACCOUNT_ID VARCHAR(32),
  IN_MESSAGE_ID VARCHAR(32)
)
RETURNS
(
  RESULT VARCHAR(1000),
  SS VARCHAR(50)
)
AS
DECLARE CONTACT VARCHAR(100);
DECLARE CHANNEL VARCHAR(15);
DECLARE C INTEGER;
DECLARE S VARCHAR(50);
BEGIN

  SELECT IM.CONTACT, IM.TEXT_IN
    FROM IN_MESSAGES IM
   WHERE IM.IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SS;

  RESULT='';
  S='';
  SS=SUB_STRING(:SS,5,30);

  IF (CONTACT IS NOT NULL) THEN BEGIN

    FOR SELECT CHANNEL, COUNT(*)
          FROM OUT_MESSAGES
         WHERE DATE_BEGIN >= :SS
         GROUP BY CHANNEL INTO :CHANNEL, :C DO BEGIN

      IF (CHANNEL IS NULL) THEN
        S = 'wait';
      ELSE
        S = :CHANNEL;

      RESULT = :RESULT || :S || ' ' || :C || '; ';
    END

    SUSPEND;


    INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                              TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,LOCKED,DATE_BEGIN,DATE_END,ORDER_ID,
                              CHANNEL,DELIVERY,DATE_DELIVERY,FLASH,DEST_PORT,FIRM_ID,OPERATOR_ID,MESSAGE_ID,SOURCE,ATTEMPTS)
                      VALUES (GET_UNIQUE_ID(),'100603219B01A5F249B0D0E412152398','C6E25C10AA8085A54325222657DD40C5',CURRENT_TIMESTAMP,
                              :RESULT,NULL,0,'+79831593190','smsm',2,NULL,CURRENT_TIMESTAMP,NULL,NULL,
                              NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL);


  END

END

--

DROP PROCEDURE TASK_MAKE_ORDER

--

DROP PROCEDURE CALL_MAKE_ORDER

--

CREATE OR ALTER PROCEDURE CLIENT_DISCOUNT
(
  ORDER_ID VARCHAR(32)
)
AS
DECLARE CLIENT_ID VARCHAR(32);
DECLARE SUM_CHARGE NUMERIC(15,2);
DECLARE SUM_RECEIPT NUMERIC(15,2);
DECLARE SUM_ORDERS NUMERIC(15,2);
DECLARE CR NUMERIC(15,2);
DECLARE PHONE VARCHAR(100);
DECLARE RECEIPT_TYPE_ID VARCHAR(32);
DECLARE DISCOUNT INTEGER;
DECLARE DI VARCHAR(32);
DECLARE DTI VARCHAR(32);
DECLARE I INTEGER;
DECLARE S VARCHAR(200);
DECLARE DISCOUNT_OLD INTEGER;
BEGIN

  SELECT CLIENT_ID, COST_RATE, PHONE
    FROM ORDERS
   WHERE ORDER_ID=:ORDER_ID
    INTO :CLIENT_ID, :CR, :PHONE;

  IF (CLIENT_ID IS NOT NULL) THEN  BEGIN

    EXECUTE PROCEDURE GET_ACCOUNT_VIRTUAL_BALANCE(:CLIENT_ID)
     RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :SUM_ORDERS;

    RECEIPT_TYPE_ID = 'C2BD0E1274BBBB7E467BD89BFCA3E2DB';

    IN AUTONOMOUS TRANSACTION DO BEGIN

      INSERT INTO RECEIPTS (RECEIPT_ID,RECEIPT_TYPE_ID,ACCOUNT_ID,WHO_CREATE_ID,
                            SUM_RECEIPT,DATE_RECEIPT,DATE_CREATE,DESCRIPTION,ORDER_ID,FIRM_ID)
                    VALUES (GET_UNIQUE_ID(), :RECEIPT_TYPE_ID, :CLIENT_ID, :CLIENT_ID,
                            :CR, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, 'Бонус - виртуальный', :ORDER_ID, 'C49DF004D660BBAF434839044848F5B8');

    END

    IF ((:SUM_ORDERS < 1000 AND :SUM_ORDERS + :CR >= 1000) OR
        (:SUM_ORDERS < 3000 AND :SUM_ORDERS + :CR >= 3000) OR
        (:SUM_ORDERS < 7000 AND :SUM_ORDERS + :CR >= 7000)) THEN BEGIN

      EXECUTE PROCEDURE GET_DISCOUNT_BY_SUM(:SUM_ORDERS)
       RETURNING_VALUES :DISCOUNT_OLD;

      EXECUTE PROCEDURE GET_DISCOUNT_BY_SUM(:SUM_ORDERS + :CR)
       RETURNING_VALUES :DISCOUNT;

      SELECT FIRST 1 DISCOUNT_ID
        FROM DISCOUNTS DS
       WHERE DS.CLIENT_ID = :CLIENT_ID
         AND (DS.DISCOUNT_TYPE_ID = 'C91E19E66E109DB84AE90EF193F7F713' OR
              DS.DISCOUNT_TYPE_ID = 'E4A4BB909AE9891442617653273F1C80')
         AND DS.DATE_END IS NULL
        INTO :DI;

      IF (:DI IS NULL) THEN BEGIN

        FOR SELECT DS.DISCOUNT_ID
              FROM DISCOUNTS DS, DISCOUNT_TYPES DTS
             WHERE DTS.DISCOUNT_TYPE_ID = DS.DISCOUNT_TYPE_ID
               AND DS.CLIENT_ID = :CLIENT_ID
               AND DTS.TYPE_CALC = 0
               AND DTS.PERCENT <= :DISCOUNT_OLD
               AND DS.DATE_END IS NULL
              INTO :DI DO BEGIN

          UPDATE DISCOUNTS
             SET DATE_END = CURRENT_TIMESTAMP
           WHERE DISCOUNT_ID = :DI;

        END

        DTI = NULL;

        IF (:DISCOUNT = 5) THEN
          DTI = '60E4F5763AAAAF00421A3FAFCFC4F028';
        ELSE
          IF (:DISCOUNT = 7) THEN
            DTI = '6DA9D68ACF20B2294CF4AF96FB6339DF';
          ELSE
            IF (:DISCOUNT = 10) THEN
              DTI = 'CDEE6335FCE488B54D14D05D4A73BE0B';


        IF (DTI IS NOT NULL) THEN BEGIN

          SELECT COUNT(DISCOUNT_ID)
            FROM DISCOUNTS
           WHERE CLIENT_ID = :CLIENT_ID
            INTO :I;

          INSERT INTO DISCOUNTS (DISCOUNT_ID,DISCOUNT_TYPE_ID,CLIENT_ID,NUM,DATE_BEGIN,DATE_END,PRIORITY)
                         VALUES (GET_UNIQUE_ID(),:DTI,:CLIENT_ID,:I,CURRENT_TIMESTAMP,NULL,-:I);

          SELECT CONST_VALUE FROM GET_CONST_VALUE('78819D8ED21FB5AA4D2FE8E1FA8B9177') INTO :S;

          S=REPLACE_STRING(:S, '%PERCENT%',CAST(:DISCOUNT AS VARCHAR(30)));

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,LOCKED,DATE_BEGIN,DATE_END,ORDER_ID,
                                    CHANNEL,DELIVERY,DATE_DELIVERY,FLASH,DEST_PORT,FIRM_ID,OPERATOR_ID,MESSAGE_ID,SOURCE,ATTEMPTS)
                            VALUES (GET_UNIQUE_ID(),'100603219B01A5F249B0D0E412152398',:CLIENT_ID,CURRENT_TIMESTAMP,
                                    :S,NULL,0,:PHONE,'Бонус',2,NULL,CURRENT_TIMESTAMP,NULL,NULL,
                                    NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL);

        END

      END

    END

  END

END

--

DROP PROCEDURE PR_NO_FREE_CARS_CL

--

CREATE OR ALTER PROCEDURE SEND_REG_MES
(
  CLIENT_ID VARCHAR(32),
  PHONE VARCHAR(100),
  LOGIN VARCHAR(100),
  PASS VARCHAR(100)
)
AS
DECLARE S VARCHAR(1000);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
BEGIN

  SELECT CONST_VALUE FROM GET_CONST_VALUE('DB382F91F4A9B9734F5993450ECF174B') INTO :S;

  EXECUTE PROCEDURE GET_TYPE_MESSAGE(CLIENT_ID,TYPE_MESSAGE,PHONE)
           RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

  IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

    S=REPLACE_STRING(S,'%LOGIN',LOGIN);
    S=REPLACE_STRING(S,'%PASS',PASS);


    INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                              TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,LOCKED,DATE_BEGIN,DATE_END,ORDER_ID,
                              CHANNEL,DELIVERY,DATE_DELIVERY,FLASH,DEST_PORT,FIRM_ID,OPERATOR_ID,MESSAGE_ID,SOURCE,ATTEMPTS)
                      VALUES (GET_UNIQUE_ID(),'100603219B01A5F249B0D0E412152398',:CLIENT_ID,CURRENT_TIMESTAMP,
                              :S,NULL,:TYPE_MESSAGE,:PHONE,'Регистрация на сайте',2,NULL,CURRENT_TIMESTAMP,NULL,NULL,
                              NULL,NULL,NULL,NULL,:DEST_PORT,NULL,NULL,NULL,NULL,NULL);


  END
END

--

CREATE OR ALTER PROCEDURE PR_FULL_CALC
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE COST_RATE NUMERIC(15,2);
DECLARE COST_FACT NUMERIC(15,2);
DECLARE NON_CASH NUMERIC(15,2);
DECLARE PARENT_SUM NUMERIC(15,2);
DECLARE PHONE VARCHAR(100);
DECLARE DRIVER_PHONE VARCHAR(100);
DECLARE PASSW VARCHAR(100);
DECLARE DRIVER_ID VARCHAR(32);
DECLARE SUM_CHARGE NUMERIC(15,2);
DECLARE SUM_RECEIPT NUMERIC(15,2);
DECLARE BALANCE NUMERIC(15,2);
DECLARE MIN_BALANCE NUMERIC(15,2);
DECLARE CHARGE_TYPE_ID VARCHAR(32);
DECLARE RECEIPT_TYPE_ID VARCHAR(32);
DECLARE CLIENT_ID VARCHAR(32);
DECLARE PARENT_ID VARCHAR(32);
DECLARE CALC_ID VARCHAR(32);
DECLARE S VARCHAR(1000);
DECLARE CODE VARCHAR(100);
DECLARE CNT INTEGER;
DECLARE DESCRIPTION VARCHAR(250);
DECLARE USER_NAME VARCHAR(100);
DECLARE CLIENT_TYPE_MESSAGE INTEGER;
DECLARE DRIVER_TYPE_MESSAGE INTEGER;
DECLARE CLIENT_DEST_PORT INTEGER;
DECLARE DRIVER_DEST_PORT INTEGER;
DECLARE IN_MESSAGE_ID VARCHAR(32);
DECLARE FIRM_ID VARCHAR(32);
DECLARE DRIVER_FIRM_ID VARCHAR(32);
DECLARE CLI VARCHAR(32);
BEGIN

  DRIVER_FIRM_ID=NULL;

  SELECT PHONE, DRIVER_ID, COST_RATE, COST_FACT, CLIENT_ID, FIRM_ID
    FROM ORDERS
   WHERE ORDER_ID=:ORDER_ID
    INTO :PHONE, :DRIVER_ID, :COST_RATE, :COST_FACT, :CLIENT_ID, :FIRM_ID;

  IF (DRIVER_ID IS NOT NULL) THEN BEGIN

    SELECT FIRM_ID
      FROM ACCOUNTS
     WHERE ACCOUNT_ID=:DRIVER_ID
      INTO :DRIVER_FIRM_ID;

    FOR SELECT IN_MESSAGE_ID, TYPE_MESSAGE
          FROM IN_MESSAGES
         WHERE ORDER_ID=:ORDER_ID
           AND CODE_MESSAGE_ID='0388BCC17DE1A1754B566F18AEEED771' /* Клиент рассчитался полностью */
           AND SENDER_ID=:DRIVER_ID
           AND DESCRIPTION IS NULL
          INTO :IN_MESSAGE_ID, :DRIVER_TYPE_MESSAGE DO BEGIN

      UPDATE IN_MESSAGES
         SET DESCRIPTION=:ORDER_ID
       WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID;

      BREAK;
    END

  END

  IF ((COST_FACT IS NULL) OR (COST_FACT<=0.0))  THEN
    COST_FACT=:COST_RATE;

  IF (COST_FACT<=0.0) THEN BEGIN

    IF (DRIVER_ID IS NOT NULL) THEN BEGIN

      SELECT CONST_VALUE FROM GET_CONST_VALUE('4BB5C780923E872D436DA3DA31C9E0B0') INTO :S;

      SELECT PHONE
        FROM ACCOUNTS
       WHERE ACCOUNT_ID=:DRIVER_ID
        INTO :DRIVER_PHONE;

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,DRIVER_TYPE_MESSAGE,DRIVER_PHONE)
       RETURNING_VALUES DRIVER_TYPE_MESSAGE, DRIVER_DEST_PORT;

      IF ((S IS NOT NULL) AND (DRIVER_TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                  PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID, message_id, source)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                  :S,NULL,:DRIVER_TYPE_MESSAGE,:DRIVER_PHONE,NULL,
                                  2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DRIVER_DEST_PORT,:DRIVER_FIRM_ID, null, null);
      END

    END

    EXECUTE PROCEDURE PR_MANUAL(SESSION_ID,ORDER_ID,ACCOUNT_ID);

  END ELSE BEGIN

    UPDATE ORDERS
       SET FINISHED=1,
           DATE_END=CURRENT_TIMESTAMP,
           WHO_PROCESS_ID=:ACCOUNT_ID,
           COST_FACT=:COST_FACT
     WHERE ORDER_ID=:ORDER_ID;

    EXECUTE PROCEDURE CREATE_ROUTE_HISTORY(ORDER_ID);

    IF (DRIVER_ID IS NOT NULL) THEN BEGIN

      CALC_ID=NULL;

      IF (CLIENT_ID IS NOT NULL) THEN BEGIN

        SELECT C.CALC_ID, A.USER_NAME
          FROM CLIENTS C
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=C.CLIENT_ID
         WHERE CLIENT_ID=:CLIENT_ID
          INTO :CALC_ID, :USER_NAME;

        SELECT COUNT(*)
          FROM CLIENT_CHILDS
         WHERE CHILD_ID=:CLIENT_ID
          INTO :CNT;

        IF (CNT>0) THEN BEGIN

          PARENT_SUM=2.0;

          IF ((COST_FACT>150.0) AND (COST_FACT<=250.0)) THEN
            PARENT_SUM=5.0;

          IF ((COST_FACT>250.0) AND (COST_FACT<=350.0)) THEN
            PARENT_SUM=10.0;

          IF (COST_FACT>350.0) THEN
            PARENT_SUM=20.0;

          SUM_RECEIPT=PARENT_SUM/CNT;

          FOR SELECT CLIENT_ID
                FROM CLIENT_CHILDS

               WHERE CHILD_ID=:CLIENT_ID
                INTO :PARENT_ID DO BEGIN

           RECEIPT_TYPE_ID='9958D6ED64ADAAB94AEF470DA7B5F4F7'; /* Поездка дочернего клиента */

           DESCRIPTION=USER_NAME;

           INSERT INTO RECEIPTS (RECEIPT_ID,RECEIPT_TYPE_ID,ACCOUNT_ID,WHO_CREATE_ID,
                                 SUM_RECEIPT,DATE_RECEIPT,DATE_CREATE,DESCRIPTION,ORDER_ID,FIRM_ID)
                         VALUES (GET_UNIQUE_ID(),:RECEIPT_TYPE_ID,:PARENT_ID,:ACCOUNT_ID,
                                :SUM_RECEIPT,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,:DESCRIPTION,:ORDER_ID,:DRIVER_FIRM_ID);

          END
        END

      END

      BALANCE=NULL;

      IF (CALC_ID IS NOT NULL) THEN BEGIN

        EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:CLIENT_ID)
         RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

      END

      NON_CASH=NULL;

      IF ((BALANCE IS NOT NULL) AND (BALANCE<>0.0)) THEN BEGIN

        IF (BALANCE>=COST_FACT) THEN BEGIN
          NON_CASH=COST_FACT;
          BALANCE=BALANCE-NON_CASH;
        END ELSE BEGIN
          NON_CASH=BALANCE;
          BALANCE=0.0;
        END

      END

      IF (NON_CASH IS NOT NULL) THEN BEGIN

        CHARGE_TYPE_ID='757B9CAF2D3CA5144A7E2A23472990E5'; /* Поездка */

        SUM_CHARGE=NON_CASH;

        INSERT INTO CHARGES (CHARGE_ID,WHO_CREATE_ID,CHARGE_TYPE_ID,ACCOUNT_ID,
                             SUM_CHARGE,DATE_CHARGE,DATE_CREATE,DESCRIPTION,ORDER_ID,FIRM_ID)
                     VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:CHARGE_TYPE_ID,:CLIENT_ID,
                             :SUM_CHARGE,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,NULL,:ORDER_ID,:DRIVER_FIRM_ID);


      END

     /* IF (SUBSTR(PHONE,1,3)='+79')  THEN BEGIN */
      IF (PHONE IS NOT NULL)  THEN BEGIN

        IF (NON_CASH IS NOT NULL) THEN BEGIN

          SELECT CONST_VALUE FROM GET_CONST_VALUE('56140344A440BE774C9007D49CD574E9') INTO :S;

        END ELSE BEGIN

          SELECT CONST_VALUE FROM GET_CONST_VALUE('05B75340B170BF5141FC63F5CDF7FCD6') INTO :S;

        END

        EXECUTE PROCEDURE GET_TYPE_MESSAGE(CLIENT_ID,NULL,PHONE)
         RETURNING_VALUES CLIENT_TYPE_MESSAGE, CLIENT_DEST_PORT;

        IF ((S IS NOT NULL) AND (CLIENT_TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

          S=REPLACE_STRING(S,'%BALANCE',CAST(CAST(BALANCE AS NUMERIC(15,0)) AS VARCHAR(30)));

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                    PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:CLIENT_ID,CURRENT_TIMESTAMP,
                                    :S,NULL,:CLIENT_TYPE_MESSAGE,:PHONE,NULL,
                                    2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:CLIENT_DEST_PORT,:FIRM_ID);
        END

        /*  need check */
        SELECT CONST_VALUE FROM GET_CONST_VALUE('E9FFA9589ABD8C174474572B72017BCC') INTO :S; /* РЕГИСТРИРУЙТЕСЬ на: ataxi24.ru */
        SELECT FIRST 1 "PASSWORD" FROM accounts where PHONE = :PHONE INTO :PASSW;

        IF ((S IS NOT NULL) AND (CLIENT_TYPE_MESSAGE IS NOT NULL) AND (PASSW IS NULL)) THEN BEGIN

          /* если нет логина - отпр смс с адресом */
          SELECT CLIENT_ID FROM GET_CLIENT_BY_PHONE(:PHONE) into :cli;
          IF (CLI IS NULL) THEN 
          BEGIN
            SELECT CONST_VALUE FROM GET_CONST_VALUE('+7B36886B6DA3A22E447F67594942BEBA') INTO :S;
                IF (S IS NOT NULL) THEN
                    BEGIN
                      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:CLIENT_ID,CURRENT_TIMESTAMP,
                                                :S,NULL,:CLIENT_TYPE_MESSAGE,:PHONE,NULL,
                                                2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:CLIENT_DEST_PORT,:FIRM_ID);
                    END
          END
        END

      END

      CHARGE_TYPE_ID='E1BC9789DA9DB2B041C0784EBE92BFC9'; /* Выполнение заказа */

      SELECT RET_SUM
        FROM GET_DRIVER_SUM(:DRIVER_ID,:COST_FACT)
        INTO :SUM_CHARGE;

        INSERT INTO CHARGES (CHARGE_ID,WHO_CREATE_ID,CHARGE_TYPE_ID,ACCOUNT_ID,
                             SUM_CHARGE,DATE_CHARGE,DATE_CREATE,DESCRIPTION,ORDER_ID,FIRM_ID)
                     VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:CHARGE_TYPE_ID,:DRIVER_ID,
                             :SUM_CHARGE,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,NULL,:ORDER_ID,:FIRM_ID);

      IF (NON_CASH IS NOT NULL) THEN BEGIN

        RECEIPT_TYPE_ID='3F91C48D888F81974941D256C0815B03'; /* Компенсация за поездку */

        SUM_RECEIPT=NON_CASH;

        INSERT INTO RECEIPTS (RECEIPT_ID,RECEIPT_TYPE_ID,ACCOUNT_ID,WHO_CREATE_ID,
                              SUM_RECEIPT,DATE_RECEIPT,DATE_CREATE,DESCRIPTION,ORDER_ID,FIRM_ID)
                      VALUES (GET_UNIQUE_ID(),:RECEIPT_TYPE_ID,:DRIVER_ID,:ACCOUNT_ID,
                              :SUM_RECEIPT,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,NULL,:ORDER_ID,:DRIVER_FIRM_ID);

      END

      EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:DRIVER_ID)
       RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

      SELECT MIN_BALANCE
        FROM DRIVERS
       WHERE DRIVER_ID=:DRIVER_ID
        INTO :MIN_BALANCE;

      IF ((MIN_BALANCE IS NULL) OR ((MIN_BALANCE IS NOT NULL) AND (BALANCE>MIN_BALANCE))) THEN BEGIN

        SELECT CONST_VALUE FROM GET_CONST_VALUE('16835607B30CA79F4CE883B53AFE972D') INTO :S;

      END ELSE BEGIN

        UPDATE SHIFTS
           SET DATE_END=CURRENT_TIMESTAMP
         WHERE ACCOUNT_ID=:DRIVER_ID
           AND DATE_END IS NULL;

        SELECT CONST_VALUE FROM GET_CONST_VALUE('634880F305E9AA434245E3E596697001') INTO :S;

      END

      SELECT PHONE
        FROM ACCOUNTS
       WHERE ACCOUNT_ID=:DRIVER_ID
        INTO :DRIVER_PHONE;

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,DRIVER_TYPE_MESSAGE,DRIVER_PHONE)
       RETURNING_VALUES DRIVER_TYPE_MESSAGE, DRIVER_DEST_PORT;

      IF ((S IS NOT NULL) AND (DRIVER_TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        S=REPLACE_STRING(S,'%BALANCE',CAST(BALANCE AS VARCHAR(30)));

        IF (NON_CASH IS NULL) THEN
          NON_CASH=0.0;

        S=REPLACE_STRING(S,'%NON_CASH',CAST(CAST(NON_CASH AS NUMERIC(15,0)) AS VARCHAR(30)));

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                  PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                  :S,NULL,:DRIVER_TYPE_MESSAGE,:DRIVER_PHONE,NULL,
                                  2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DRIVER_DEST_PORT,:DRIVER_FIRM_ID);
      END

      FOR SELECT TRIM(SUB_STRING(IM.TEXT_IN,2,100))
            FROM IN_MESSAGES IM
            JOIN CODE_MESSAGES CM ON CM.CODE_MESSAGE_ID=IM.CODE_MESSAGE_ID
           WHERE IM.SENDER_ID=:DRIVER_ID
             AND IM.ORDER_ID=:ORDER_ID
             AND IM.CODE_MESSAGE_ID='0388BCC17DE1A1754B566F18AEEED771' /* Клиент рассчитался полностью */
             AND CM.ENABLED=1
           ORDER BY IM.DATE_IN DESC
            INTO :CODE DO BEGIN

        SELECT COUNT(*)
          FROM CODE_MESSAGES
         WHERE CODE=:CODE
          INTO :CNT;

        IF (CNT=1) THEN BEGIN

          EXECUTE PROCEDURE TRY_PARK_IN(SESSION_ID,ORDER_ID,ACCOUNT_ID,DRIVER_ID,CODE,DRIVER_TYPE_MESSAGE);

        END ELSE BEGIN

          EXECUTE PROCEDURE QUERY_PARK_STATES (ORDER_ID,ACCOUNT_ID,DRIVER_ID,PHONE,DRIVER_TYPE_MESSAGE);

        END

        BREAK;
      END

      EXECUTE PROCEDURE CLIENT_DISCOUNT(:ORDER_ID); /* Обработка скидок, виртуальных начислений */

    END

  END

END

--

DROP PROCEDURE TRY_PARK_IN_AFTER_FULL

--

CREATE OR ALTER PROCEDURE PR_TIME_OUT
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE NEED INTEGER;
DECLARE S VARCHAR(250);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE CLIENT_ID VARCHAR(32);
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
DECLARE PHONE VARCHAR(100);
BEGIN

  FOR SELECT CASE
               WHEN RESULT_ID IN ('8C3D01A86184B5A840062ECB145F51B2',
                                  '02911E47B99F83DE4976000938DAE2C6') THEN 1
               ELSE 0
             END AS NEED, CLIENT_ID, FIRM_ID, PHONE
        FROM ORDERS
       WHERE ORDER_ID=:ORDER_ID
        INTO :NEED, :CLIENT_ID, :FIRM_ID, :PHONE DO BEGIN
    BREAK;
  END

  SELECT CONST_VALUE FROM GET_CONST_VALUE('3EC13775CE06861A44C6DD6F3A4BF5C4') INTO :S;

  EXECUTE PROCEDURE GET_TYPE_MESSAGE(CLIENT_ID,NULL,PHONE)
    RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

  IF ((NEED=1) AND (S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN
      
    INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                              TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                              PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                      VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:CLIENT_ID,CURRENT_TIMESTAMP,
                              :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                              2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);

  END

  EXECUTE PROCEDURE PR_MANUAL(SESSION_ID,ORDER_ID,ACCOUNT_ID);

END

--

DROP PROCEDURE TASK_SHIFT_CHARGE_

--

CREATE OR ALTER PROCEDURE TASK_FAILURE_SCHEDULE
(
    TASK_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE DRIVER_ID VARCHAR(32);
DECLARE PHONE VARCHAR(100);
DECLARE NAME VARCHAR(100);
DECLARE PATRONYMIC VARCHAR(100);
DECLARE S VARCHAR(1000);
DECLARE S1 VARCHAR(1000);
DECLARE D TIMESTAMP;
DECLARE DAY_HOUR INTEGER;
DECLARE WEEK_DAY INTEGER;
DECLARE CNT INTEGER;
DECLARE SUM_CHARGE NUMERIC(15,2);
DECLARE CHARGE_TYPE_ID VARCHAR(32);
DECLARE SUM_RECEIPT NUMERIC(15,2);
DECLARE BALANCE NUMERIC(15,2);
DECLARE MIN_BALANCE NUMERIC(15,2);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN

  SELECT CONST_VALUE FROM GET_CONST_VALUE('118C2CC432E5B9B44A9BF94757EC2EDE') INTO :S;

  IF (S IS NOT NULL) THEN BEGIN

    D=CURRENT_TIMESTAMP;

    FOR SELECT D.DRIVER_ID, A.PHONE, A.NAME, A.PATRONYMIC,
               D.MIN_BALANCE, A.FIRM_ID
          FROM DRIVERS D
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
         WHERE A.LOCKED<>1
           AND D.DATE_SCHEDULE IS NOT NULL
           AND D.DATE_SCHEDULE<=CURRENT_DATE
          INTO :DRIVER_ID, :PHONE, :NAME, :PATRONYMIC,
               :MIN_BALANCE, :FIRM_ID DO BEGIN

      WEEK_DAY=EXTRACT(WEEKDAY FROM CURRENT_TIMESTAMP)-1;
      IF (WEEK_DAY<0) THEN
        WEEK_DAY=6;

      DAY_HOUR=EXTRACT(HOUR FROM CURRENT_TIMESTAMP);

      SELECT COUNT(*)
        FROM DRIVER_WEEK_SCHEDULES
       WHERE WEEK_DAY=:WEEK_DAY
         AND DAY_HOUR=:DAY_HOUR
         AND DRIVER_ID=:DRIVER_ID
        INTO :CNT;

      IF (CNT>0) THEN BEGIN

        SELECT COUNT(*)
          FROM SHIFTS
         WHERE DATE_END IS NULL
           AND ACCOUNT_ID=:DRIVER_ID
           AND DATE_BEGIN<=CURRENT_TIMESTAMP
          INTO :CNT;

        IF (CNT=0) THEN BEGIN

          EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:DRIVER_ID)
           RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

          IF ((MIN_BALANCE IS NULL) OR ((MIN_BALANCE IS NOT NULL) AND (BALANCE>MIN_BALANCE))) THEN BEGIN

            SUM_CHARGE=NULL;
            CHARGE_TYPE_ID='CF012E53C5C9A03E4A7F03194B84DA49'; /* Не выполнение графика */

            SELECT SUM_CHARGE
              FROM CHARGE_TYPES
             WHERE CHARGE_TYPE_ID=:CHARGE_TYPE_ID
              INTO :SUM_CHARGE;

            EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL,PHONE)
             RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

            IF ((SUM_CHARGE IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

              INSERT INTO CHARGES (CHARGE_ID,WHO_CREATE_ID,CHARGE_TYPE_ID,ACCOUNT_ID,
                                   SUM_CHARGE,DATE_CHARGE,DATE_CREATE,DESCRIPTION,FIRM_ID)
                           VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:CHARGE_TYPE_ID,:DRIVER_ID,
                                   :SUM_CHARGE,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,NULL,:FIRM_ID);

              S1=S;
              S1=REPLACE_STRING(S1,'%SUM_CHARGE',CAST(SUM_CHARGE AS VARCHAR(30)));

              INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                        TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                        PRIORITY,LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                                VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                        :S1,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                        1,NULL,:D,:DEST_PORT,:FIRM_ID);

              D=D+5*(1e0/24/60/60);

            END

          END

        END

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE CODE_DINNER
(
    SESSION_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32),
    IN_MESSAGE_ID VARCHAR(32)
)
AS
DECLARE CONTACT VARCHAR(100);
DECLARE SENDER_ID VARCHAR(32);
DECLARE S VARCHAR(1000);
DECLARE S1 VARCHAR(1000);
DECLARE GO INTEGER;
DECLARE PARK_NAME VARCHAR(100);
DECLARE PARK_STATE_ID VARCHAR(32);
DECLARE CNT INTEGER;
DECLARE DRIVER_SURNAME VARCHAR(100);
DECLARE DRIVER_NAME VARCHAR(100);
DECLARE DINNER_SMS TIMESTAMP;
DECLARE DINNER_SHOW VARCHAR(32);
DECLARE D TIMESTAMP;
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
DECLARE SUCCESS INTEGER;
DECLARE PRIORITY INTEGER;
BEGIN
D = CURRENT_TIMESTAMP;
/*DINNER_TIME = 40 * 60 * (1E0 / 24 / 60 / 60);
DINNER_RANGE = 12 * 60 * 60 * (1E0 / 24 / 60 / 60); */
DINNER_SHOW = extract(hour from (D + 40 * 60 * (1E0 / 24 / 60 / 60))) || ':' || extract(minute from (D + 40 * 60 * (1E0 / 24 / 60 / 60)));

  SELECT IM.CONTACT, IM.SENDER_ID, IM.TYPE_MESSAGE, A.FIRM_ID, A.SURNAME, A.NAME
    FROM IN_MESSAGES IM
    LEFT JOIN ACCOUNTS A ON A.ACCOUNT_ID=IM.SENDER_ID
   WHERE IM.IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, :TYPE_MESSAGE, :FIRM_ID, :DRIVER_SURNAME, :DRIVER_NAME ;

  IF ((CONTACT IS NOT NULL) AND (SENDER_ID IS NOT NULL)) THEN BEGIN

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE,CONTACT)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

  select first 1 priority
    from drivers
   where driver_id = :SENDER_ID
    into :PRIORITY;

  if (:PRIORITY > -1) then begin


    execute procedure CODE_PARK_OUT(SESSION_ID,ACCOUNT_ID,IN_MESSAGE_ID);

/*            INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                      TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                      LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                              VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
            'Обед предусмотрен только для (-1) приоритета.',NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                      NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
                                      */
  end ELSE BEGIN

  if ( /* D is null */
    (CURRENT_TIMESTAMP >= cast('07:30' as time) AND
     CURRENT_TIMESTAMP <= cast('22:00' as time))
/*    (CURRENT_TIMESTAMP >= cast('16:30' as time) AND
     CURRENT_TIMESTAMP <= cast('19:30' as time)) OR
    (CURRENT_TIMESTAMP >= cast('07:30' as time) AND
     CURRENT_TIMESTAMP <= cast('09:30' as time))*/
    ) then begin

        SELECT CONST_VALUE FROM GET_CONST_VALUE('D60DEF0FF100BC3443817BAEF5B1B500') INTO :S;

        if (:S is not null) then begin
            INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                      TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                      LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                              VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                      :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                      NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
        end
    end ELSE BEGIN

      SELECT max(O.DATE_OUT) /* ИСПРАВИТЬ НА DATE_OUT */
        FROM out_messages O
       WHERE O.contact=:CONTACT and
             O.text_out like '%Вы на обеде до %'
        INTO :DINNER_SMS;

        IF (DINNER_SMS is null or (DINNER_SMS + 12 * 60 * 60 * (1E0 / 24 / 60 / 60)) < current_timestamp)
        THEN BEGIN

    SELECT COUNT(*)
      FROM DRIVERS D
      JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
     WHERE D.DRIVER_ID=:SENDER_ID
       AND A.LOCKED<>1
      INTO :CNT;

    IF (CNT>0) THEN BEGIN

      SELECT COUNT(*)
        FROM ORDERS
       WHERE DRIVER_ID=:SENDER_ID
         AND PARENT_ID IS NULL
         AND DATE_HISTORY IS NULL
         AND FINISHED<>1
        INTO :CNT;

      IF (CNT>0) THEN BEGIN

        SELECT CONST_VALUE FROM GET_CONST_VALUE('7E75E7A3DA4FAB8D443F2D7384B3DF46') INTO :S; /* Вы на заказе. Снятие невозможно */

        IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                    LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                    :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                    NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
        END

      END ELSE BEGIN

        FOR SELECT P.NAME, PS.PARK_STATE_ID
              FROM PARK_STATES PS
              JOIN PARKS P ON P.PARK_ID=PS.PARK_ID
             WHERE PS.DRIVER_ID=:SENDER_ID
               AND PS.DATE_OUT IS NULL
              INTO :PARK_NAME, :PARK_STATE_ID DO BEGIN

          SELECT CONST_VALUE FROM GET_CONST_VALUE('F5FAEFF5369FA2E2496554FFACF900A3') INTO :S; /* Вы сняты со стоянки %PARK_NAME. */
          S=:S || ('. Вы на обеде до ' || DINNER_SHOW);

                   IF ((S IS NOT NULL) AND
            (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN
            
          UPDATE PARK_STATES
             SET DATE_OUT=:D
           WHERE PARK_STATE_ID=:PARK_STATE_ID;

            S=REPLACE_STRING(S,'%PARK_NAME',PARK_NAME);
            S=REPLACE_STRING(S,'%TIME_DATE',FORMAT_DATETIME('hh:nn:ss dd.mm.yyyy',D));
            
            GO=1;
            INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                      TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                      LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                              VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                      :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                      NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);

          END

          BREAK;

        END

        EXECUTE PROCEDURE event_refresh_park_states('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

      END

      if (PARK_NAME is null) then BEGIN

        S='Вы на обеде до ' || DINNER_SHOW ;
        GO=1;
        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                      TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                      LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                              VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                      :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                      NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                      TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                      LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                              VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                      'Ваш обед заканчивается через 5 минут',NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                      NULL,(CURRENT_TIMESTAMP + 35 * 60 * (1E0 / 24 / 60 / 60)),:DEST_PORT,:FIRM_ID);
        END

    END

end else begin
DINNER_SHOW = extract(hour from (DINNER_SMS + 12 * 60 * 60 * (1E0 / 24 / 60 / 60))) || ':'
           || extract(minute from (DINNER_SMS + 12 * 60 * 60 * (1E0 / 24 / 60 / 60)));
S='Следующий обед вы можете взять не ранее ' || DINNER_SHOW;

    if (:S is not null) then begin

            INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                      TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                      LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                              VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                      :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                      NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
                             end
          end


    if (TYPE_MESSAGE is not null AND GO=1) then begin
        S1='Водитель (' || Driver_surname || ' ' || Driver_name ||  ') на обеде до ' || DINNER_SHOW;
            IN AUTONOMOUS TRANSACTION DO BEGIN

      INSERT INTO ALARMS (ALARM_ID, SENDER_ID, RECIPIENT_ID, TYPE_ALARM,
                    DATE_BEGIN, DATE_END, CAPTION, TEXT_ALARM)
           VALUES (GET_UNIQUE_ID(), 'CA25F4C3A6DA8C334D20D3C4F2A2EF62', '22E88F4DA4D3A08B42691A0F0370F0EB', 0,
                    CURRENT_TIMESTAMP, CURRENT_TIMESTAMP+0.5*(1e0/24/60), 'Ушел на обед', :S1 );

                END

        EXECUTE PROCEDURE EVENT_ALARM('A35F5701A7AA920E40812A71A690910D', NULL, NULL, 0)
        RETURNING_VALUES SUCCESS;

    end

    END

  END

 END

END

--

CREATE OR ALTER PROCEDURE CODE_BREAKAGE
(
    SESSION_ID VARCHAR(32),
    ACCOUNT_ID VARCHAR(32),
    IN_MESSAGE_ID VARCHAR(32)
)
AS
DECLARE CONTACT VARCHAR(100);
DECLARE SENDER_ID VARCHAR(32);
DECLARE S VARCHAR(1000);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
DECLARE DRIVER_SURNAME VARCHAR(100);
DECLARE DRIVER_NAME VARCHAR(100);
DECLARE SUCCESS INTEGER;
begin

  SELECT IM.CONTACT, IM.SENDER_ID, IM.TYPE_MESSAGE, A.FIRM_ID, A.SURNAME, A.NAME
    FROM IN_MESSAGES IM
    LEFT JOIN ACCOUNTS A ON A.ACCOUNT_ID=IM.SENDER_ID
   WHERE IM.IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, :TYPE_MESSAGE, :FIRM_ID, :DRIVER_SURNAME, :DRIVER_NAME ;

  IF ((CONTACT IS NOT NULL) AND (SENDER_ID IS NOT NULL)) THEN BEGIN

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE,CONTACT)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;


    SELECT CONST_VALUE FROM GET_CONST_VALUE('7DD5E8A8BBD9870A411517B54D9EB973') INTO :S;

        IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);

        END
    END

        if (TYPE_MESSAGE is not null) then begin
        S='Водитель (' || Driver_surname || ' ' || Driver_name ||  ') сломался.';
            IN AUTONOMOUS TRANSACTION DO BEGIN

      INSERT INTO ALARMS (ALARM_ID, SENDER_ID, RECIPIENT_ID, TYPE_ALARM,
                    DATE_BEGIN, DATE_END, CAPTION, TEXT_ALARM)
           VALUES (GET_UNIQUE_ID(), 'CA25F4C3A6DA8C334D20D3C4F2A2EF62', '22E88F4DA4D3A08B42691A0F0370F0EB', 0,
                    CURRENT_TIMESTAMP, CURRENT_TIMESTAMP+0.5*(1e0/24/60), 'Поломка', :S );

                END

        EXECUTE PROCEDURE EVENT_ALARM('A35F5701A7AA920E40812A71A690910D', NULL, NULL, 0)
        RETURNING_VALUES SUCCESS;

    end

end

--

CREATE OR ALTER PROCEDURE PR_ARRIVAL_DRIVER
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE PHONE VARCHAR(100);
DECLARE DRIVER_ID VARCHAR(32);
DECLARE CAR_ID VARCHAR(32);
DECLARE PARK_ID VARCHAR(32);
DECLARE PRIORITY INTEGER;
DECLARE PARK_STREET_ID VARCHAR(32);
DECLARE PARK_HOUSE VARCHAR(10);
DECLARE FROM_STREET_ID VARCHAR(32);
DECLARE FROM_HOUSE VARCHAR(10);
DECLARE RECEIPT_TYPE_ID VARCHAR(32);
DECLARE COST_RATE NUMERIC(15,2);
DECLARE COST_CASH NUMERIC(15,2);
DECLARE COLOR VARCHAR(100);
DECLARE BRAND VARCHAR(100);
DECLARE STATE_NUM VARCHAR(50);
DECLARE PREFIX VARCHAR(10);
DECLARE STREET VARCHAR(100);
DECLARE STREET_ID VARCHAR(32);
DECLARE HOUSE VARCHAR(10);
DECLARE FLAT VARCHAR(10);
DECLARE PORCH VARCHAR(10);
DECLARE LOCALITY VARCHAR(100);
DECLARE CLIENT_ID VARCHAR(32);
DECLARE CALC_ID VARCHAR(32);
DECLARE SUM_CHARGE NUMERIC(15,2);
DECLARE SUM_RECEIPT NUMERIC(15,2);
DECLARE BALANCE NUMERIC(15,2);
DECLARE S VARCHAR(1000);
DECLARE S1 VARCHAR(1000);
DECLARE ADDRESS VARCHAR(1000);
DECLARE NUM INTEGER;
DECLARE CNT INTEGER;
DECLARE FLAG INTEGER;
DECLARE D TIMESTAMP;
DECLARE ROUTE_DISTANCE DOUBLE PRECISION;
DECLARE DISTANCE NUMERIC(15,2);
DECLARE CLIENT_TYPE_MESSAGE INTEGER;
DECLARE DRIVER_TYPE_MESSAGE INTEGER;
DECLARE IN_MESSAGE_ID VARCHAR(32);
DECLARE CLIENT_DEST_PORT INTEGER;
DECLARE DRIVER_DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
DECLARE DRIVER_FIRM_ID VARCHAR(32);
BEGIN

  SELECT O.PHONE, O.DRIVER_ID, O.PARK_ID, O.FIRM_ID,
         O.STREET_ID, O.HOUSE,
         O.COST_RATE, O.CLIENT_ID,
         C.COLOR, C.BRAND, C.STATE_NUM
    FROM ORDERS O
    LEFT JOIN DRIVERS D ON D.DRIVER_ID=O.DRIVER_ID
    LEFT JOIN CARS C ON C.CAR_ID=D.CAR_ID
   WHERE ORDER_ID=:ORDER_ID
    INTO :PHONE, :DRIVER_ID, :PARK_ID, :FIRM_ID,
         :FROM_STREET_ID, :FROM_HOUSE,
         :COST_RATE, :CLIENT_ID,
         :COLOR, :BRAND, :STATE_NUM;

  UPDATE ORDERS
     SET DATE_BEGIN=CURRENT_TIMESTAMP
   WHERE ORDER_ID=:ORDER_ID;

  CALC_ID=NULL;

  IF (CLIENT_ID IS NOT NULL) THEN BEGIN

    SELECT CALC_ID
      FROM CLIENTS
     WHERE CLIENT_ID=:CLIENT_ID
      INTO :CALC_ID;

  END

  BALANCE=NULL;

  IF (CALC_ID IS NOT NULL) THEN BEGIN

    EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:CLIENT_ID)
     RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

  END

  FLAG=0;

  FOR SELECT STREET_ID, HOUSE
        FROM ROUTES
       WHERE ORDER_ID=:ORDER_ID
       ORDER BY PRIORITY
        INTO :STREET_ID, :HOUSE DO BEGIN

    IF ((STREET_ID IS NOT NULL) AND (HOUSE IS NOT NULL)) THEN BEGIN

    END ELSE BEGIN

      FLAG=1;

    END
  END

  COST_CASH=NULL;

  IF ((COST_RATE>0.0) AND (FLAG=0)) THEN BEGIN

    IF (BALANCE IS NOT NULL) THEN BEGIN

      IF (BALANCE>=COST_RATE) THEN
        COST_CASH=0.0;
      ELSE
        COST_CASH=COST_RATE-BALANCE;

    END

  END

  IF (PHONE IS NOT NULL)  THEN BEGIN

    IF ((COST_RATE>0.0) AND (FLAG=0)) THEN BEGIN

      IF (COST_CASH IS NULL) THEN

        SELECT CONST_VALUE FROM GET_CONST_VALUE('8D9E6C9F4852AD8142205F027B2A5288') INTO :S;

      ELSE

        SELECT CONST_VALUE FROM GET_CONST_VALUE('9CA9F2761D2BBE974791906824C3C31A') INTO :S;

    END ELSE BEGIN

      SELECT CONST_VALUE FROM GET_CONST_VALUE('93EBB0171E37A0884313759C0DA1EB3D') INTO :S;

    END

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(CLIENT_ID,NULL,PHONE)
     RETURNING_VALUES CLIENT_TYPE_MESSAGE, CLIENT_DEST_PORT;

    IF ((S IS NOT NULL) AND (CLIENT_TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      S=REPLACE_STRING(S,'%COLOR',COLOR);
      S=REPLACE_STRING(S,'%BRAND',BRAND);
      S=REPLACE_STRING(S,'%STATE_NUM',STATE_NUM);
      S=REPLACE_STRING(S,'%COST_RATE',CAST(CAST(COST_RATE AS NUMERIC(15,0)) AS VARCHAR(30)));
      S=REPLACE_STRING(S,'%COST_CASH',CAST(CAST(COST_CASH AS NUMERIC(15,0)) AS VARCHAR(30)));

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:CLIENT_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:CLIENT_TYPE_MESSAGE,:PHONE,NULL,
                                0,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:CLIENT_DEST_PORT,:FIRM_ID);

    END

    SELECT CONST_VALUE FROM GET_CONST_VALUE('F4384929079999BB47A895BFCA5BB382') INTO :S;

    IF ((S IS NOT NULL) AND (CLIENT_TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:CLIENT_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:CLIENT_TYPE_MESSAGE,:PHONE,NULL,
                                0,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:CLIENT_DEST_PORT,:FIRM_ID);

    END

  END

  IF (DRIVER_ID IS NOT NULL) THEN BEGIN

    FOR SELECT IN_MESSAGE_ID, TYPE_MESSAGE
          FROM IN_MESSAGES
         WHERE ORDER_ID=:ORDER_ID
           AND CODE_MESSAGE_ID='618A0B399123BEEA474944099929C541' /* Водитель прибыл */
           AND SENDER_ID=:DRIVER_ID
           AND DESCRIPTION IS NULL
          INTO :IN_MESSAGE_ID, :DRIVER_TYPE_MESSAGE DO BEGIN

      UPDATE IN_MESSAGES
         SET DESCRIPTION=:ORDER_ID
       WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID;

      BREAK;
    END

    SELECT PHONE, FIRM_ID
      FROM ACCOUNTS
     WHERE ACCOUNT_ID=:DRIVER_ID
      INTO :PHONE, :DRIVER_FIRM_ID;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,DRIVER_TYPE_MESSAGE,PHONE)
     RETURNING_VALUES DRIVER_TYPE_MESSAGE, DRIVER_DEST_PORT;

    FLAG=0;
    NUM=0;

    SELECT COUNT(*)
      FROM ROUTES
     WHERE ORDER_ID=:ORDER_ID
      INTO :CNT;

    D=CURRENT_TIMESTAMP;

    FOR SELECT R.STREET_ID, R.HOUSE, R.FLAT, R.PORCH
          FROM ROUTES R
         WHERE R.ORDER_ID=:ORDER_ID
         ORDER BY R.PRIORITY
          INTO :STREET_ID, :HOUSE, :FLAT, :PORCH DO BEGIN

      ADDRESS='';
      S=NULL;

      IF ((STREET_ID IS NOT NULL) AND (HOUSE IS NOT NULL)) THEN BEGIN

        EXECUTE PROCEDURE GET_ADDRESS(STREET_ID,HOUSE,FLAT,PORCH)
         RETURNING_VALUES ADDRESS;

        SELECT CONST_VALUE FROM GET_CONST_VALUE('92009DB6C3EAA9E74B80D333538FE40D') INTO :S;

      END ELSE BEGIN

        FLAG=1;

        SELECT CONST_VALUE FROM GET_CONST_VALUE('7ED5E8A8BBD9870A411517B54D9EB973') INTO :S;

      END

      IF (S IS NOT NULL) THEN BEGIN

        NUM=NUM+1;

        S=REPLACE_STRING(S,'%NUM',NUM);
        S=REPLACE_STRING(S,'%COUNT',CNT);
        S=REPLACE_STRING(S,'%ADDRESS',ADDRESS);

        IF (NUM=CNT) THEN BEGIN

          IF ((FLAG=0) AND (COST_RATE>0.0)) THEN BEGIN

            IF (COST_CASH IS NULL) THEN

              SELECT CONST_VALUE FROM GET_CONST_VALUE('9C8BC7D14DAEAE5C4DC8C1C91B20BCC2') INTO :S1;

            ELSE

              SELECT CONST_VALUE FROM GET_CONST_VALUE('A468782967A1A4D347F85F33D39E348A') INTO :S1;

          END ELSE

            SELECT CONST_VALUE FROM GET_CONST_VALUE('D3F68032AD999D004140A480A8AAF749') INTO :S1;

        END ELSE

          S1=S;


        IF ((S1 IS NOT NULL) AND (DRIVER_TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

          S1=REPLACE_STRING(S1,'%ADDRESS',S);
          S1=REPLACE_STRING(S1,'%COST_RATE',CAST(CAST(COST_RATE AS NUMERIC(15,0)) AS VARCHAR(30)));
          S1=REPLACE_STRING(S1,'%COST_CASH',CAST(CAST(COST_CASH AS NUMERIC(15,0)) AS VARCHAR(30)));

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                    PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                    :S1,NULL,:DRIVER_TYPE_MESSAGE,:PHONE,NULL,
                                    2,NULL,:D,:ORDER_ID,:DRIVER_DEST_PORT,:DRIVER_FIRM_ID);

          D=D+1*(1e0/24/60/60);

        END

      END

    END

    /* need check */
    SELECT d.priority, d.car_id
      FROM drivers d
     WHERE d.driver_id = :DRIVER_ID
      INTO :PRIORITY, :CAR_ID;

    IF ((PARK_ID IS NOT NULL) AND ((PRIORITY<>-1)
    and (:CAR_ID not in (select car_id from car_in_types where car_type_id = '2FC1A2E9B900A144441F4B342A432950'))))  THEN BEGIN

      SELECT STREET_ID, HOUSE
        FROM PARKS
       WHERE PARK_ID=:PARK_ID
        INTO :PARK_STREET_ID, :PARK_HOUSE;

      IF ((PARK_STREET_ID IS NOT NULL) AND (PARK_HOUSE IS NOT NULL)) THEN BEGIN

        IF ((FROM_STREET_ID IS NOT NULL) AND (FROM_HOUSE IS NOT NULL)) THEN BEGIN

          EXECUTE PROCEDURE GET_ROUTE_DISTANCE(PARK_STREET_ID,PARK_HOUSE,FROM_STREET_ID,FROM_HOUSE)
             RETURNING_VALUES ROUTE_DISTANCE;

          IF (ROUTE_DISTANCE>0.0) THEN BEGIN

            IF (DISTANCE>4.0) THEN BEGIN

              DISTANCE=DISTANCE-4.0;

              RECEIPT_TYPE_ID='2448E302595392064D9DF67BDD05C7DB'; /* Компенсация за прогон */

              SUM_RECEIPT=DISTANCE*3.0;

              INSERT INTO RECEIPTS (RECEIPT_ID,RECEIPT_TYPE_ID,ACCOUNT_ID,WHO_CREATE_ID,
                                    SUM_RECEIPT,DATE_RECEIPT,DATE_CREATE,DESCRIPTION,ORDER_ID,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:RECEIPT_TYPE_ID,:DRIVER_ID,:ACCOUNT_ID,
                                    :SUM_RECEIPT,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,NULL,:ORDER_ID,:FIRM_ID);

              SELECT CONST_VALUE FROM GET_CONST_VALUE('6905163E6105BE12488DAF7AAFA32810') INTO :S;

              IF ((S IS NOT NULL) AND (DRIVER_TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

                S=REPLACE_STRING(S,'%DISTANCE',CAST(DISTANCE AS VARCHAR(30)));
                S=REPLACE_STRING(S,'%SUM_RECEIPT',CAST(SUM_RECEIPT AS VARCHAR(30)));

                INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                          TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                          PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                                  VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                          :S,NULL,:DRIVER_TYPE_MESSAGE,:PHONE,NULL,
                                          2,NULL,:D,:ORDER_ID,:DRIVER_DEST_PORT,:DRIVER_FIRM_ID);


              END

            END

          END

        END

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE PR_SELECT_DRIVER
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE DRIVER_ID VARCHAR(32);
DECLARE CAR_ID VARCHAR(32);
DECLARE CNT INTEGER;
DECLARE S VARCHAR(1000);
DECLARE ADDRESS VARCHAR(1000);
DECLARE STREET_ID VARCHAR(32);
DECLARE HOUSE VARCHAR(10);
DECLARE FLAT VARCHAR(10);
DECLARE PORCH VARCHAR(10);
DECLARE LOCALITY VARCHAR(100);
DECLARE PHONE VARCHAR(100);
DECLARE DATE_ACCEPT TIMESTAMP;
DECLARE DATE_ARRIVAL TIMESTAMP;
DECLARE DATE_BEGIN TIMESTAMP;
DECLARE BEFORE_PERIOD INTEGER;
DECLARE ACTION_ID VARCHAR(32);
DECLARE D TIMESTAMP;
DECLARE DESCRIPTION VARCHAR(250);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN

  SELECT O.DRIVER_ID,
         O.STREET_ID, O.HOUSE, O.FLAT, O.PORCH,
         O.DATE_ACCEPT, O.DATE_ARRIVAL, O.BEFORE_PERIOD,
         O.ACTION_ID, O.DATE_BEGIN, O.DESCRIPTION
    FROM ORDERS O
   WHERE O.ORDER_ID=:ORDER_ID
    INTO :DRIVER_ID,
         :STREET_ID, :HOUSE, :FLAT, :PORCH,
         :DATE_ACCEPT, :DATE_ARRIVAL, :BEFORE_PERIOD,
         :ACTION_ID, :DATE_BEGIN, :DESCRIPTION;

  IF (DRIVER_ID IS NOT NULL) THEN BEGIN

    CNT=0;

    SELECT COUNT(*)
      FROM OUT_MESSAGES
     WHERE RECIPIENT_ID=:DRIVER_ID
       AND ORDER_ID=:ORDER_ID
       AND DESCRIPTION=:ACTION_ID
       AND TYPE_MESSAGE=0
       AND DATE_OUT IS NULL
       AND DATE_CREATE>=:DATE_BEGIN
      INTO CNT;

    IF (CNT=0) THEN BEGIN

      SELECT D.CAR_ID, A.PHONE, A.FIRM_ID
        FROM DRIVERS D
        JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
       WHERE D.DRIVER_ID=:DRIVER_ID
        INTO :CAR_ID, :PHONE, :FIRM_ID;

      D=CURRENT_TIMESTAMP;

      UPDATE ORDERS
         SET DRIVER_ID=:DRIVER_ID,
             CAR_ID=:CAR_ID,
             DATE_END=:D,
             WHO_PROCESS_ID=:ACCOUNT_ID
       WHERE ORDER_ID=:ORDER_ID;

      ADDRESS='';

      EXECUTE PROCEDURE GET_ADDRESS(STREET_ID,HOUSE,FLAT,PORCH)
       RETURNING_VALUES ADDRESS;

      IF (DATE_ACCEPT<DATE_ARRIVAL) THEN BEGIN

        IF ((DATE_ACCEPT+(BEFORE_PERIOD*(1e0/24/60)))<DATE_ARRIVAL) THEN BEGIN

          SELECT CONST_VALUE FROM GET_CONST_VALUE('2A773F389AD895B94010252F1DC6D3CC') INTO :S;

        END ELSE BEGIN

          SELECT CONST_VALUE FROM GET_CONST_VALUE('051BE1C8C28F9DB34EAA8DD46E0DA3B4') INTO :S;

        END

      END ELSE BEGIN

        SELECT CONST_VALUE FROM GET_CONST_VALUE('CD5055A23D04B51641F3211814253430') INTO :S;

      END

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL,PHONE)
       RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

      IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        S=REPLACE_STRING(S,'%TIME',FORMAT_DATETIME('hh:nn',DATE_ARRIVAL));
        S=REPLACE_STRING(S,'%ADDRESS',ADDRESS);

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                  PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,:D,
                                  :S,NULL,:TYPE_MESSAGE,:PHONE,:ACTION_ID,
                                  0,NULL,:D,:ORDER_ID,:DEST_PORT,:FIRM_ID);

        IF ((DESCRIPTION IS NOT NULL) AND (TRIM(DESCRIPTION)<>'')) THEN BEGIN

          S=DESCRIPTION;

          D=D+1*(1e0/24/60/60);

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                    PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,:D,
                                    :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                    0,NULL,:D,:ORDER_ID,:DEST_PORT,:FIRM_ID);
        END

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE GET_DEFAULT_LOCALITY
RETURNS
(
   LOCALITY_ID VARCHAR(32),
   NAME VARCHAR(100),
   PREFIX VARCHAR(10)
)
AS
BEGIN

  SELECT CONST_VALUE FROM GET_CONST_VALUE('2148768F6B36AF8C44E4BA1C952128C1') INTO :LOCALITY_ID;

  IF (LOCALITY_ID IS NOT NULL) THEN BEGIN

    SELECT LOCALITY_ID, NAME, PREFIX
      FROM LOCALITIES
     WHERE LOCALITY_ID=:LOCALITY_ID
      INTO :LOCALITY_ID, :NAME, :PREFIX;

  END

END

--

CREATE OR ALTER PROCEDURE GET_ADDRESS
(
  STREET_ID VARCHAR(32),
  HOUSE VARCHAR(10),
  FLAT VARCHAR(10),
  PORCH VARCHAR(10))
RETURNS
(
  ADDRESS VARCHAR(1000)
)
AS
DECLARE STREET_NAME VARCHAR(100);
DECLARE STREET_PREFIX VARCHAR(10);
DECLARE LOCALITY_NAME VARCHAR(100);
DECLARE LOCALITY_PREFIX VARCHAR(10);
DECLARE LOCALITY_ID VARCHAR (32);
DECLARE DEF_LOCALITY_ID VARCHAR (32);
DECLARE DEF_LOCALITY_NAME VARCHAR(100);
DECLARE DEF_LOCALITY_PREFIX VARCHAR(10);
BEGIN

  EXECUTE PROCEDURE GET_DEFAULT_LOCALITY
   RETURNING_VALUES DEF_LOCALITY_ID, DEF_LOCALITY_NAME, DEF_LOCALITY_PREFIX;

  ADDRESS='';

  FOR SELECT S.NAME, S.PREFIX, L.LOCALITY_ID, L.NAME, L.PREFIX
        FROM STREETS S
        JOIN LOCALITIES L ON L.LOCALITY_ID=S.LOCALITY_ID
       WHERE STREET_ID=:STREET_ID
        INTO :STREET_NAME, :STREET_PREFIX, :LOCALITY_ID, :LOCALITY_NAME, :LOCALITY_PREFIX DO BEGIN


    IF (STREET_PREFIX IS NOT NULL) THEN
      ADDRESS=STREET_PREFIX||' ';

    IF (STREET_NAME IS NOT NULL) THEN
      ADDRESS=ADDRESS||STREET_NAME;

    IF (HOUSE IS NOT NULL) THEN
      ADDRESS=ADDRESS||' '||HOUSE;

    IF (FLAT IS NOT NULL) THEN
      ADDRESS=ADDRESS||'-'||FLAT;

    IF (PORCH IS NOT NULL) THEN
      ADDRESS=ADDRESS||' п.'||PORCH;

    IF ((LOCALITY_NAME IS NOT NULL) AND (LOCALITY_ID<>DEF_LOCALITY_ID)) THEN BEGIN

      IF (LOCALITY_PREFIX IS NOT NULL) THEN
        ADDRESS=ADDRESS||', '||LOCALITY_PREFIX||' '||LOCALITY_NAME;

    END

    BREAK;
  END

END

--

CREATE OR ALTER PROCEDURE GET_DEFAULT_STREET
RETURNS
(
  STREET_ID VARCHAR(32)
)
AS
BEGIN

  SELECT CONST_VALUE FROM GET_CONST_VALUE('0AE3E778A0DE834F4E54C1940983EB13') INTO :STREET_ID;

  IF (STREET_ID IS NOT NULL) THEN BEGIN

    SELECT STREET_ID
      FROM STREETS
     WHERE STREET_ID=:STREET_ID
      INTO :STREET_ID;

  END

END

--

CREATE OR ALTER PROCEDURE GET_DEFAULT_FIRM
RETURNS
(
  FIRM_ID VARCHAR(32)
)
AS
BEGIN

  SELECT CONST_VALUE FROM GET_CONST_VALUE('975CA8E9513985E1460CCC04543BE8DB') INTO :FIRM_ID;

  IF (FIRM_ID IS NOT NULL) THEN BEGIN

    SELECT FIRM_ID
      FROM FIRMS
     WHERE FIRM_ID=:FIRM_ID
      INTO :FIRM_ID;

  END

END

--

CREATE OR ALTER PROCEDURE CODE_MAKE_ORDER
(
  SESSION_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  IN_MESSAGE_ID VARCHAR(32)
)
AS
DECLARE CONTACT VARCHAR(100);
DECLARE SENDER_ID VARCHAR(32);
DECLARE S VARCHAR(1000);
DECLARE CNT INTEGER;
DECLARE CONST_VALUE VARCHAR(4000);
DECLARE ORDER_NUM VARCHAR(1000);
DECLARE ACTION_ID VARCHAR(32);
DECLARE RATE_ID VARCHAR(32);
DECLARE CAR_TYPE_ID VARCHAR(32);
DECLARE CLIENT_ID VARCHAR(32);
DECLARE STREET_ID VARCHAR(32);
DECLARE HOUSE VARCHAR(10);
DECLARE FLAT VARCHAR(10);
DECLARE PORCH VARCHAR(10);
DECLARE ADDRESS_DESC VARCHAR(250);
DECLARE LOCKED INTEGER;
DECLARE ORDER_ID VARCHAR(32);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
DECLARE RND INTEGER;
DECLARE TYPE_ACCEPT INTEGER;
DECLARE DISCOUNT_ID VARCHAR(32);
BEGIN
  SELECT CONTACT, SENDER_ID, TYPE_MESSAGE
    FROM IN_MESSAGES
   WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, :TYPE_MESSAGE;

  SELECT COUNT(*)
    FROM BLACKS
   WHERE UPPER(PHONE)=UPPER(:CONTACT)
    INTO :CNT;

  IF ((CONTACT IS NOT NULL) AND (CNT=0)) THEN BEGIN


    EXECUTE PROCEDURE GET_DEFAULT_FIRM
     RETURNING_VALUES FIRM_ID;

    SELECT FIRST 1
           ORDER_ID
      FROM ORDERS
     WHERE FINISHED=0
       AND PHONE=:CONTACT
       AND TYPE_PROCESS=1
       AND DATE_HISTORY IS NULL
       AND DATE_ACCEPT>=DATEADD(MINUTE,-30,CURRENT_TIMESTAMP)
      INTO :ORDER_ID;

    IF (ORDER_ID IS NOT NULL) THEN BEGIN

      UPDATE IN_MESSAGES
         SET ORDER_ID=:ORDER_ID
       WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID;

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE,CONTACT)
       RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

      SELECT CONST_VALUE FROM GET_CONST_VALUE_TYPE_MESSAGE('B19E95F747A3A0F5477326231BB3A053',:TYPE_MESSAGE) INTO :S;

      IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                  PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID,MESSAGE_ID,SOURCE)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                  :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,
                                  1,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID,NULL,NULL);

      END


    END ELSE BEGIN

      SELECT LOCKED, CLIENT_ID, STREET_ID, HOUSE, FLAT, PORCH, ADDRESS_DESC
        FROM CLIENTS C
        JOIN ACCOUNTS A ON A.ACCOUNT_ID=C.CLIENT_ID
       WHERE C.CLIENT_ID=:SENDER_ID
        INTO :LOCKED, :CLIENT_ID, :STREET_ID, :HOUSE, :FLAT, :PORCH, :ADDRESS_DESC;

      IF ((CLIENT_ID IS NULL) OR ((CLIENT_ID IS NOT NULL) AND (LOCKED<>1))) THEN BEGIN

        EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE,CONTACT)
         RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

        SELECT CONST_VALUE FROM GET_CONST_VALUE_TYPE_MESSAGE('CB66FC06A78BB69D430EB7BD1AFA13FA',:TYPE_MESSAGE) INTO :S;

        IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

          RATE_ID=NULL;
          FOR SELECT RATE_ID
                FROM RATES
               ORDER BY PRIORITY
                INTO :RATE_ID DO BEGIN
            BREAK;
          END

          CAR_TYPE_ID=NULL;
          FOR SELECT CAR_TYPE_ID
                FROM CAR_TYPES
               ORDER BY PRIORITY
                INTO :CAR_TYPE_ID DO BEGIN
            BREAK;
          END

          IF ((RATE_ID IS NOT NULL) AND (CAR_TYPE_ID IS NOT NULL)) THEN BEGIN

            EXECUTE PROCEDURE GET_DEFAULT_STREET
             RETURNING_VALUES STREET_ID;

            IF (STREET_ID IS NOT NULL) THEN BEGIN

              ORDER_ID=GET_UNIQUE_ID();
              HOUSE=NULL;
              FLAT=NULL;
              PORCH=NULL;
              ADDRESS_DESC=NULL;

              EXECUTE PROCEDURE GET_ORDER_NUM
                RETURNING_VALUES :ORDER_NUM;

              ACTION_ID='E019DBDE7D55BEC34D12A709EE3FEB0B'; /* Создание */

              TYPE_ACCEPT=0;
              IF (TYPE_MESSAGE IN (0,1)) THEN
                TYPE_ACCEPT=1;

              DISCOUNT_ID = NULL;
              FOR SELECT D.DISCOUNT_ID
                    FROM DISCOUNTS D
                   WHERE D.CLIENT_ID = :CLIENT_ID
                     AND D.DATE_END IS NULL
                   ORDER BY D.PRIORITY DESC
                    INTO :DISCOUNT_ID DO BEGIN
                BREAK;
              END

              INSERT INTO ORDERS (ORDER_ID,ACTION_ID,RATE_ID,CAR_TYPE_ID,WHO_ACCEPT_ID,
                                  CLIENT_ID,STREET_ID,HOUSE,FLAT,PORCH,DESCRIPTION,
                                  ORDER_NUM,PHONE,DATE_ACCEPT,DATE_ARRIVAL,TYPE_ACCEPT,
                                  TYPE_PROCESS,BEFORE_PERIOD,DATE_BEGIN,FINISHED,FIRM_ID,DISCOUNT_ID)
                          VALUES (:ORDER_ID,:ACTION_ID,:RATE_ID,:CAR_TYPE_ID,:ACCOUNT_ID,
                                  :CLIENT_ID,:STREET_ID,:HOUSE,:FLAT,:PORCH,:ADDRESS_DESC,
                                  :ORDER_NUM,:CONTACT,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,:TYPE_ACCEPT,
                                  1,30,CURRENT_TIMESTAMP,0,:FIRM_ID,:DISCOUNT_ID);

              UPDATE IN_MESSAGES
                 SET ORDER_ID=:ORDER_ID
               WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID;

              IF (TYPE_MESSAGE=2) THEN
                ORDER_NUM=NUMBER_TO_WORDS(CAST(ORDER_NUM AS INTEGER),1);

              S=REPLACE_STRING(S,'%ORDER_NUM',ORDER_NUM);

              INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                        TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                        PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID,MESSAGE_ID,SOURCE)
                                VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                        :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,
                                        1,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID,NULL,NULL);

            END

          END

        END

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE GET_EVENT_PARAMS
(
  SESSION_ID VARCHAR(32),
  PROTOCOL INTEGER
)
RETURNS (
    ACCOUNT_ID VARCHAR(32),
    IP VARCHAR(20),
    PORT VARCHAR(10),
    HOST VARCHAR(100),
    PATH VARCHAR(100),
    USE_CRYPTER INTEGER,
    CRYPTER_ALGORITHM INTEGER,
    CRYPTER_MODE INTEGER,
    CRYPTER_KEY VARCHAR(100),
    USE_COMPRESSOR INTEGER,
    COMPRESSOR_LEVEL INTEGER)
AS
DECLARE PARAMS BLOB;
DECLARE SECTION VARCHAR(100);
DECLARE S VARCHAR(1000);
BEGIN
  SELECT ACCOUNT_ID, PARAMS
    FROM SESSIONS
   WHERE SESSION_ID=:SESSION_ID
    INTO :ACCOUNT_ID, :PARAMS;

  IF ((PROTOCOL=0) OR (PROTOCOL IS NULL)) THEN
    SECTION='DefaultUdpEventServer';
  ELSE
    SECTION='FirstHttpServerHandlerEvent';

  IF (CONFIG_EXISTS(PARAMS,SECTION)=1) THEN BEGIN

    S=CONFIG_READ(PARAMS,SECTION,'IP','');
    IP=SUB_STRING(CASE WHEN POSITION(';',S)>0 THEN SUBSTRING(S FROM 1 FOR POSITION(';',S)-1) ELSE S END,1,20);
    S=CONFIG_READ(PARAMS,SECTION,'Port','');
    PORT=SUB_STRING(CASE WHEN POSITION(';',S)>0 THEN SUBSTRING(S FROM 1 FOR POSITION(';',S)-1) ELSE S END,1,10);
    HOST=SUB_STRING(CONFIG_READ(PARAMS,SECTION,'Host',''),1,100);
    PATH=SUB_STRING(CONFIG_READ(PARAMS,SECTION,'Path',''),1,100);
    USE_CRYPTER=CAST(CONFIG_READ(PARAMS,SECTION,'UseCrypter','0') AS INTEGER);
    CRYPTER_ALGORITHM=CAST(CONFIG_READ(PARAMS,SECTION,'CrypterAlgorithm','0') AS INTEGER);
    CRYPTER_MODE=CAST(CONFIG_READ(PARAMS,SECTION,'CrypterMode','0') AS INTEGER);
    CRYPTER_KEY=CONFIG_READ(PARAMS,SECTION,'CrypterKey','');
    USE_COMPRESSOR=CAST(CONFIG_READ(PARAMS,SECTION,'UseCompressor','0') AS INTEGER);
    COMPRESSOR_LEVEL=CAST(CONFIG_READ(PARAMS,SECTION,'CompressorLevel','0') AS INTEGER);

  END

END

--

CREATE OR ALTER PROCEDURE EVENT_REFRESH_ORDERS
(
  APPLICATION_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  SESSION_ID VARCHAR(32),
  PROTOCOL INTEGER
)
AS
DECLARE TEMP INTEGER;
DECLARE SECTION VARCHAR(100);
BEGIN
  SECTION='S_ORDERS';
  FOR SELECT SUCCESS
       FROM SEND_EVENT(0,0,:APPLICATION_ID,:ACCOUNT_ID,NULL,:SESSION_ID,:PROTOCOL,:SECTION,NULL)
       INTO :TEMP DO BEGIN

    EXECUTE PROCEDURE WAIT_FOR(750,50);

  END
END

--

CREATE OR ALTER PROCEDURE EVENT_REFRESH_SHIFTS
(
  APPLICATION_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  SESSION_ID VARCHAR(32),
  PROTOCOL INTEGER
)
AS
DECLARE VARIABLE TEMP INTEGER;
DECLARE VARIABLE SECTION VARCHAR(100);
BEGIN
  SECTION='S_DRIVER_SHIFTS';
  FOR SELECT SUCCESS
       FROM SEND_EVENT(0,0,:APPLICATION_ID,:ACCOUNT_ID,NULL,:SESSION_ID,:PROTOCOL,:SECTION,NULL)
       INTO :TEMP DO BEGIN

    EXECUTE PROCEDURE WAIT_FOR(50,25);

  END
END

--

CREATE OR ALTER PROCEDURE EVENT_REFRESH_PARK_STATES
(
  APPLICATION_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  SESSION_ID VARCHAR(32),
  PROTOCOL INTEGER
)
AS
DECLARE VARIABLE TEMP INTEGER;
DECLARE VARIABLE SECTION VARCHAR(100);
BEGIN
  SECTION='S_DRIVER_PARKS';
  FOR SELECT SUCCESS
       FROM SEND_EVENT(0,0,:APPLICATION_ID,:ACCOUNT_ID,NULL,:SESSION_ID,:PROTOCOL,:SECTION,NULL)
       INTO :TEMP DO BEGIN

    EXECUTE PROCEDURE WAIT_FOR(50,25);

  END
END

--

CREATE OR ALTER PROCEDURE GET_CODE_MESSAGE
(
  TEXT_IN VARCHAR(4000)
)
RETURNS
(
  CODE_MESSAGE_ID VARCHAR(32),
  CODE VARCHAR(100),
  PROC_NAME VARCHAR(100),
  COMMAND_STRING VARCHAR(250),
  ANSWER VARCHAR(4000)
)
AS
DECLARE CODE_POS INTEGER;
DECLARE CODE_TEMP VARCHAR(100);
DECLARE S VARCHAR(100);
DECLARE TEMP VARCHAR(100);
DECLARE TEMP_NEXT VARCHAR(1);
DECLARE L INTEGER;
DECLARE FLAG INTEGER;
DECLARE ACODE_MESSAGE_ID VARCHAR(32);
DECLARE ACODE VARCHAR(100);
DECLARE APROC_NAME VARCHAR(100);
DECLARE ACOMMAND_STRING VARCHAR(250);
DECLARE AANSWER VARCHAR(4000);
BEGIN

  FLAG=0;
  FOR SELECT CODE_MESSAGE_ID, CODE, PROC_NAME, COMMAND_STRING, ANSWER
        FROM CODE_MESSAGES
       WHERE ENABLED=1
        INTO :ACODE_MESSAGE_ID,:ACODE,:APROC_NAME,:ACOMMAND_STRING,:AANSWER DO BEGIN

    CODE_TEMP=ACODE;

    CODE_POS=-1;
    WHILE (CODE_POS<>0) DO BEGIN

      CODE_POS=POSITION(';',CODE_TEMP);
      IF (CODE_POS>0) THEN BEGIN
        S=SUB_STRING(CODE_TEMP,1,CODE_POS-1);
        CODE_TEMP=SUB_STRING(CODE_TEMP,CODE_POS+1,100);
      END ELSE
        S=CODE_TEMP;

      L=STRING_LENGTH(S);

      TEMP=SUB_STRING(TEXT_IN,1,L);

      IF (UPPER(TEMP)=UPPER(S)) THEN BEGIN

        TEMP_NEXT=SUB_STRING(TEXT_IN,L+1,1);

        IF (TEMP_NEXT IN (':','=','-',' ')) THEN BEGIN
          FLAG=1;
          ACODE=S;
          BREAK;
        END

      END

    END

    IF (FLAG=1) THEN BEGIN

      CODE_MESSAGE_ID=ACODE_MESSAGE_ID;
      CODE=ACODE;
      PROC_NAME=APROC_NAME;
      COMMAND_STRING=ACOMMAND_STRING;
      ANSWER=AANSWER;

      SUSPEND;
      BREAK;
    END

  END

END

--

CREATE OR ALTER PROCEDURE GET_CALL_SESSIONS
(
  CALL_ID VARCHAR(32)
)
RETURNS
(
  SESSION_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE DIRECTION INTEGER;
DECLARE APPLICATION_ID VARCHAR(32)='A35F5701A7AA920E40812A71A690910D';
DECLARE FIRM_ID VARCHAR(32);
DECLARE PARAMS BLOB;
DECLARE ENABLED INTEGER;
DECLARE CALLER_ID VARCHAR(32);
DECLARE CNT INTEGER;
DECLARE IP VARCHAR(100);
BEGIN

  SELECT DIRECTION, FIRM_ID, CALLER_ID
    FROM CALLS
   WHERE CALL_ID=:CALL_ID
    INTO :DIRECTION, :FIRM_ID, :CALLER_ID;

  IF (DIRECTION IS NOT NULL) THEN BEGIN

    IF (DIRECTION=0) THEN BEGIN

      SELECT COUNT(*)
        FROM SHIFTS S
        JOIN ACCOUNTS A ON A.ACCOUNT_ID=S.ACCOUNT_ID
        JOIN DRIVERS D ON D.DRIVER_ID=S.ACCOUNT_ID
       WHERE D.DRIVER_ID=:CALLER_ID
         AND A.LOCKED<>1
         AND S.DATE_END IS NULL
        INTO :CNT;

      FOR SELECT GS.SESSION_ID, GS.ACCOUNT_ID, S.PARAMS
            FROM GET_EVENT_SESSIONS(1,:APPLICATION_ID,NULL,NULL) GS
            JOIN DISPATCHERS D ON D.DISPATCHER_ID=GS.ACCOUNT_ID
            JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DISPATCHER_ID
            JOIN SESSIONS S ON S.SESSION_ID=GS.SESSION_ID
           WHERE A.FIRM_ID=:FIRM_ID
           UNION ALL
          SELECT GS.SESSION_ID, GS.ACCOUNT_ID, S.PARAMS
            FROM GET_EVENT_SESSIONS(1,:APPLICATION_ID,NULL,NULL) GS
            JOIN DISPATCHERS D ON D.DISPATCHER_ID=GS.ACCOUNT_ID
            JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DISPATCHER_ID
            JOIN SESSIONS S ON S.SESSION_ID=GS.SESSION_ID
           WHERE A.FIRM_ID<>:FIRM_ID
           UNION ALL
          SELECT GS.SESSION_ID, GS.ACCOUNT_ID, S.PARAMS
            FROM GET_EVENT_SESSIONS(1,:APPLICATION_ID,NULL,NULL) GS
            JOIN DISPATCHERS D ON D.DISPATCHER_ID=GS.ACCOUNT_ID
            JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DISPATCHER_ID
            JOIN SESSIONS S ON S.SESSION_ID=GS.SESSION_ID
           WHERE A.FIRM_ID IS NULL
            INTO :SESSION_ID, :ACCOUNT_ID, :PARAMS DO BEGIN

        ENABLED=CAST(CONFIG_READ(PARAMS,'TaxiPhoneForm','Enabled','0') AS INTEGER);

        IF (ENABLED=1) THEN BEGIN

          IF (CNT>0) THEN BEGIN
            IP=CAST(CONFIG_READ(PARAMS,'DefaultUdpEventServer','IP','') AS VARCHAR(100));
            IF (TRIM(IP)<>'192.168.0.33') THEN
              ENABLED=0;
          END

          IF (ENABLED=1) THEN
            SUSPEND;
        END

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE TASK_DELETE_SESSIONS
(
  SESSION_ID VARCHAR(32),
  TASK_ID VARCHAR(32)
)
AS
DECLARE DELETE_SESSION_ID VARCHAR(32);
BEGIN

  FOR SELECT SESSION_ID
        FROM SESSIONS
       WHERE SESSION_ID NOT IN (SELECT S1.SESSION_ID
                                  FROM (SELECT SESSION_ID, ACCOUNT_ID, APPLICATION_ID, DATE_CHANGE,
                                               CAST(CONFIG_READ(PARAMS,'DefaultUdpEventServer','IP','') AS VARCHAR(100)) AS IP,
                                               CAST(CONFIG_READ(PARAMS,'DefaultUdpEventServer','Port','') AS VARCHAR(100)) AS PORT
                                          FROM SESSIONS) S1
                                  JOIN (SELECT ACCOUNT_ID, APPLICATION_ID,
                                               CAST(CONFIG_READ(PARAMS,'DefaultUdpEventServer','IP','') AS VARCHAR(100)) AS IP,
                                               CAST(CONFIG_READ(PARAMS,'DefaultUdpEventServer','Port','') AS VARCHAR(100)) AS PORT,
                                               MAX(DATE_CHANGE) AS MAX_DATE_CHANGE
                                          FROM SESSIONS
                                         GROUP BY ACCOUNT_ID,APPLICATION_ID,3,4) S2 ON S2.ACCOUNT_ID=S1.ACCOUNT_ID
                                                                                   AND S2.APPLICATION_ID=S1.APPLICATION_ID
                                                                                   AND S2.IP=S1.IP
                                                                                   AND S2.PORT=S1.PORT
                                                                                   AND S2.MAX_DATE_CHANGE=S1.DATE_CHANGE
                                WHERE DATEADD(HOUR,IIF(S1.APPLICATION_ID='A35F5701A7AA920E40812A71A690910D',1,24),DATE_CHANGE)>=CURRENT_TIMESTAMP)
         AND DATEADD(MINUTE,1,DATE_CHANGE)<=CURRENT_TIMESTAMP
        INTO :DELETE_SESSION_ID DO BEGIN

    IN AUTONOMOUS TRANSACTION DO BEGIN

      EXECUTE PROCEDURE EVENT_DELETE_SESSION(DELETE_SESSION_ID,0);

      DELETE FROM SESSIONS
            WHERE SESSION_ID=:DELETE_SESSION_ID;
    END

  END

  EXECUTE PROCEDURE EVENT_CHECK_SESSIONS('A2FB11F34A5F8A0942E878850A400DB9',SESSION_ID,0);

  EXECUTE PROCEDURE EVENT_CHECK_SESSIONS('AF5DFB35AE9C819F41FB2451E2EB0D0D',SESSION_ID,0);


END

--





