/* Создание процедуры определения результата по умолчанию */

CREATE PROCEDURE /*PREFIX*/GET_DEFAULT_RESULT_ID
(
  ORDER_ID VARCHAR(32),
  ACTION_ID VARCHAR(32)
)
RETURNS
(
  RESULT_ID VARCHAR(32)
)
AS
  DECLARE PROC_DETECT VARCHAR(100);
  DECLARE SQL VARCHAR(1000);
  DECLARE DETECTED INTEGER;
  DECLARE ARESULT_ID VARCHAR(32);
BEGIN
  RESULT_ID=NULL;

  FOR SELECT RESULT_ID, PROC_DETECT
        FROM /*PREFIX*/RESULTS
       WHERE PROC_DETECT IS NOT NULL
         AND ACTION_ID=:ACTION_ID
       ORDER BY PRIORITY
        INTO :ARESULT_ID,:PROC_DETECT DO BEGIN

    IF (TRIM(PROC_DETECT)<>'') THEN BEGIN
      DETECTED=0;
      SQL='SELECT DETECTED FROM '||PROC_DETECT||'('''||ORDER_ID||''','''||ACTION_ID||''','''||ARESULT_ID||''');';
      EXECUTE STATEMENT SQL INTO :DETECTED;

      IF (DETECTED=1) THEN BEGIN
        RESULT_ID=ARESULT_ID;
        BREAK;
      END
    END

  END
END

--

/* Фиксация изменений */

COMMIT