CREATE OR ALTER PROCEDURE GET_CLIENT_GROUP_PATH
(
  CLIENT_GROUP_ID VARCHAR(32),
  DELIM VARCHAR(10)
)
RETURNS
(
  PATH VARCHAR(4000)
)
AS
DECLARE NAME VARCHAR(100);
DECLARE PRIOR_PATH VARCHAR(1000);
DECLARE PARENT_ID VARCHAR(32);
BEGIN
  PARENT_ID=NULL;

  SELECT NAME, PARENT_ID
    FROM CLIENT_GROUPS
   WHERE CLIENT_GROUP_ID=:CLIENT_GROUP_ID
    INTO :NAME, :PARENT_ID;

  IF (PARENT_ID IS NOT NULL) THEN BEGIN

    EXECUTE PROCEDURE GET_CLIENT_GROUP_PATH(PARENT_ID,DELIM)
     RETURNING_VALUES PRIOR_PATH;

    PATH=PRIOR_PATH||DELIM||NAME;

  END ELSE BEGIN

    PATH=NAME;

  END

END

--

CREATE OR ALTER PROCEDURE GET_ACCEPTOR_INFO
(
  ACCEPTOR VARCHAR(100)
)
RETURNS
(
  ACCEPTOR_NAME VARCHAR(100),
  ACCEPTOR_GROUP VARCHAR(4000),
  ACCEPTOR_DESCRIPTION VARCHAR(250),
  ACCEPTOR_TYPE INTEGER
)
AS
DECLARE CNT INTEGER;
DECLARE ACCOUNT_ID VARCHAR(32);
DECLARE PHONE VARCHAR(100);
DECLARE USER_NAME VARCHAR(100);
DECLARE SURNAME VARCHAR(100);
DECLARE NAME VARCHAR(100);
DECLARE PATRONYMIC VARCHAR(100);
DECLARE DESCRIPTION VARCHAR(250);
DECLARE IS_ROLE INTEGER;
DECLARE FIRM_SMALL_NAME VARCHAR(250);
DECLARE CLIENT_GROUP_ID VARCHAR(32);
BEGIN
  ACCEPTOR_TYPE=0; /* Unknown */

  SELECT COUNT(*)
    FROM ACCOUNTS
   WHERE ACCOUNT_ID=SUB_STRING(:ACCEPTOR,1,32)
    INTO :CNT;

  IF (CNT=0) THEN BEGIN

    ACCOUNT_ID=NULL;

    FOR SELECT A.ACCOUNT_ID, A.PHONE, A.SURNAME, A.NAME,
               A.PATRONYMIC, A.DESCRIPTION, A.IS_ROLE, F.SMALL_NAME
          FROM ACCOUNTS A
          LEFT JOIN FIRMS F ON F.FIRM_ID=A.FIRM_ID
         WHERE A.USER_NAME=:ACCEPTOR
          INTO :ACCOUNT_ID, :PHONE, :SURNAME, :NAME,
               :PATRONYMIC, :DESCRIPTION, :IS_ROLE, :FIRM_SMALL_NAME DO BEGIN
      USER_NAME=ACCEPTOR;
      BREAK;
    END

    IF (ACCOUNT_ID IS NULL) THEN BEGIN

      FOR SELECT A.ACCOUNT_ID, A.USER_NAME, A.SURNAME, A.NAME,
                 A.PATRONYMIC, A.DESCRIPTION, A.IS_ROLE, F.SMALL_NAME
            FROM ACCOUNTS A
            LEFT JOIN FIRMS F ON F.FIRM_ID=A.FIRM_ID
           WHERE A.PHONE=:ACCEPTOR
            INTO :ACCOUNT_ID, :USER_NAME, :SURNAME, :NAME,
                 :PATRONYMIC, :DESCRIPTION, :IS_ROLE, :FIRM_SMALL_NAME DO BEGIN
        PHONE=ACCEPTOR;
        BREAK;
      END

      IF (ACCOUNT_ID IS NULL) THEN BEGIN

        FOR SELECT A.ACCOUNT_ID, A.USER_NAME, A.SURNAME, A.NAME,
                   A.PATRONYMIC, A.DESCRIPTION, A.IS_ROLE, F.SMALL_NAME
              FROM ACCOUNTS A
              JOIN CLIENTS C ON C.CLIENT_ID=A.ACCOUNT_ID
              JOIN CLIENT_PHONES CP ON CP.CLIENT_ID=C.CLIENT_ID
              LEFT JOIN FIRMS F ON F.FIRM_ID=A.FIRM_ID
             WHERE CP.PHONE=:ACCEPTOR
              INTO :ACCOUNT_ID, :USER_NAME, :SURNAME, :NAME,
                   :PATRONYMIC, :DESCRIPTION, :IS_ROLE, :FIRM_SMALL_NAME DO BEGIN
          PHONE=ACCEPTOR;
          BREAK;
        END

      END

    END

  END ELSE BEGIN

    FOR SELECT A.ACCOUNT_ID, A.PHONE, A.USER_NAME, A.SURNAME, A.NAME,
               A.PATRONYMIC, A.DESCRIPTION, A.IS_ROLE, F.SMALL_NAME
          FROM ACCOUNTS A
          LEFT JOIN FIRMS F ON F.FIRM_ID=A.FIRM_ID
         WHERE A.ACCOUNT_ID=:ACCEPTOR
          INTO :ACCOUNT_ID, :PHONE, :USER_NAME, :SURNAME, :NAME,
               :PATRONYMIC, :DESCRIPTION, :IS_ROLE, :FIRM_SMALL_NAME DO BEGIN
      BREAK;
    END

  END

  IF (ACCOUNT_ID IS NOT NULL) THEN BEGIN

    ACCEPTOR_NAME=TRIM(PHONE||' ('||USER_NAME||')');
    ACCEPTOR_DESCRIPTION=TRIM(SURNAME||' '||NAME||' '||PATRONYMIC);

    SELECT COUNT(*)
      FROM CLIENTS
     WHERE CLIENT_ID=:ACCOUNT_ID
      INTO :CNT;

    IF (CNT>0) THEN BEGIN

      CLIENT_GROUP_ID=NULL;

      SELECT CLIENT_GROUP_ID
        FROM CLIENTS
       WHERE CLIENT_ID=:ACCOUNT_ID
        INTO :CLIENT_GROUP_ID;

      IF (CLIENT_GROUP_ID IS NOT NULL) THEN BEGIN

        EXECUTE PROCEDURE GET_CLIENT_GROUP_PATH(CLIENT_GROUP_ID,'/')
         RETURNING_VALUES ACCEPTOR_GROUP;

      END

      ACCEPTOR_TYPE=1; /* Client */

    END ElSE BEGIN

      SELECT COUNT(*)
        FROM DRIVERS
       WHERE DRIVER_ID=:ACCOUNT_ID
         INTO :CNT;

      IF (CNT>0) THEN BEGIN

        ACCEPTOR_TYPE=2; /* Driver */

      END ELSE BEGIN

        SELECT COUNT(*)
          FROM DISPATCHERS
         WHERE DISPATCHER_ID=:ACCOUNT_ID
           INTO :CNT;

        IF (CNT>0) THEN
          ACCEPTOR_TYPE=3; /* Dispatcher */
        ElSE
          ACCEPTOR_TYPE=4; /* Account */

      END

    END

  END ELSE BEGIN

    ACCEPTOR_NAME=ACCEPTOR;

  END


END

--

CREATE OR ALTER PROCEDURE GET_OLD_CLIENTS
(
  DATE_BEGIN TIMESTAMP,
  DATE_END TIMESTAMP
)
RETURNS
(
  PHONE VARCHAR(100),
  USER_NAME VARCHAR(100),
  SUM_FACT NUMERIC(15,2),
  ORDER_COUNT INTEGER
)
AS
DECLARE SQL VARCHAR(1000);
BEGIN
  SQL='SELECT O.PHONE,A.USER_NAME,SUM(O.COST_FACT) AS SUM_COST_FACT,COUNT(*) AS ORDER_COUNT ';
  SQL=SQL||'FROM ORDERS O JOIN CLIENTS C ON C.CLIENT_ID=O.CLIENT_ID ';
  SQL=SQL||'JOIN ACCOUNTS A ON A.ACCOUNT_ID=C.CLIENT_ID WHERE O.FINISHED=1 ';
  SQL=SQL||'AND O.PARENT_ID IS NULL AND O.RESULT_ID=''6DD8DFDC671DB9A742E418FD268E7DC4'' ';

  IF (DATE_BEGIN IS NOT NULL) THEN
    SQL=SQL||'AND O.DATE_ACCEPT>='''||FORMAT_DATETIME('dd.mm.yyyy hh:nn:ss',DATE_BEGIN)||''' ';

  IF (DATE_END IS NOT NULL) THEN
    SQL=SQL||'AND O.DATE_ACCEPT<'''||FORMAT_DATETIME('dd.mm.yyyy hh:nn:ss',DATE_END)||''' ';

  SQL=SQL||'GROUP BY O.PHONE, A.USER_NAME ORDER BY 3 DESC, 4 DESC';

  FOR EXECUTE STATEMENT SQL
                   INTO :PHONE, :USER_NAME, :SUM_FACT, :ORDER_COUNT DO BEGIN
    SUSPEND;
  END

END

--

DROP PROCEDURE PR_ARRIVAL_DRIVER

--

DROP PROCEDURE GET_ROUTE_DISTANCE

--

DROP EXTERNAL FUNCTION HTTP_GET

--

DECLARE EXTERNAL FUNCTION HTTP_GET
    CSTRING(32767),
    CSTRING(32767),
    CSTRING(32767),
    CSTRING(32767),
    BLOB
RETURNS PARAMETER 5
ENTRY_POINT 'HTTP_GET' MODULE_NAME 'udfibase.dll';

--

CREATE OR ALTER PROCEDURE GET_ROUTE_DISTANCE
(
  LAT1 DOUBLE PRECISION,
  LON1 DOUBLE PRECISION,
  LAT2 DOUBLE PRECISION,
  LON2 DOUBLE PRECISION
)
RETURNS (
  DISTANCE DOUBLE PRECISION
)
AS
DECLARE RET BLOB;
DECLARE S VARCHAR(100);
DECLARE PARAMS VARCHAR(250);
BEGIN
  DISTANCE=0.0;

  PARAMS='?Lat1='||CAST(CAST(LAT1 AS NUMERIC(12,9)) AS VARCHAR(30))||
         '&Lon1='||CAST(CAST(LON1 AS NUMERIC(12,9)) AS VARCHAR(30))||
         '&Lat2='||CAST(CAST(LAT2 AS NUMERIC(12,9)) AS VARCHAR(30))||
         '&Lon2='||CAST(CAST(LON2 AS NUMERIC(12,9)) AS VARCHAR(30));

  RET=HTTP_GET('192.168.0.2','55508','/ingitmap',PARAMS);

  IF (RET IS NOT NULL) THEN BEGIN

    S=SUBSTRING(RET FROM 1 FOR 100);

    DISTANCE=CAST(S AS NUMERIC(15,2));

  END

END

--

DROP PROCEDURE RESTART_TASK_SERVER

--

DROP EXTERNAL FUNCTION EXECUTE_COMMAND

--

DECLARE EXTERNAL FUNCTION EXECUTE_COMMAND
    CSTRING(32767),
    INTEGER,
    INTEGER
RETURNS INTEGER BY VALUE
ENTRY_POINT 'EXECUTE_COMMAND' MODULE_NAME 'udfibase.dll';

--

CREATE OR ALTER PROCEDURE RESTART_TASK_SERVER
AS
DECLARE VARIABLE RET INTEGER;
BEGIN
  RET=EXECUTE_COMMAND('sc stop TaxiTaskServer',0,0);

  RET=SLEEP(2000);

  RET=EXECUTE_COMMAND('sc start TaxiTaskServer',0,0);
END

--

DECLARE EXTERNAL FUNCTION COMPRESS_BLOB
    BLOB,
    INTEGER,
    BLOB
RETURNS PARAMETER 3
ENTRY_POINT 'COMPRESS_BLOB' MODULE_NAME 'udfibase.dll';

--

DECLARE EXTERNAL FUNCTION DECOMPRESS_BLOB
    BLOB,
    BLOB
RETURNS PARAMETER 2
ENTRY_POINT 'DECOMPRESS_BLOB' MODULE_NAME 'udfibase.dll';

--

DECLARE EXTERNAL FUNCTION ENCODE_BLOB
    BLOB,
    CSTRING(32767),
    INTEGER,
    INTEGER,
    BLOB
RETURNS PARAMETER 5
ENTRY_POINT 'ENCODE_BLOB' MODULE_NAME 'udfibase.dll';

--

DECLARE EXTERNAL FUNCTION DECODE_BLOB
    BLOB,
    CSTRING(32767),
    INTEGER,
    INTEGER,
    BLOB
RETURNS PARAMETER 5
ENTRY_POINT 'DECODE_BLOB' MODULE_NAME 'udfibase.dll';

--

DECLARE EXTERNAL FUNCTION HTTP_POST
    CSTRING(32767),
    CSTRING(32767),
    CSTRING(32767),
    BLOB,
    BLOB
RETURNS PARAMETER 5
ENTRY_POINT 'HTTP_POST' MODULE_NAME 'udfibase.dll';

--

DECLARE EXTERNAL FUNCTION MD5
    CSTRING(32767)
RETURNS CSTRING(32)
ENTRY_POINT 'MD5' MODULE_NAME 'udfibase.dll';

--

DECLARE EXTERNAL FUNCTION CHR
    INTEGER
RETURNS CSTRING(1)
ENTRY_POINT 'CHR' MODULE_NAME 'udfibase.dll';

--

DECLARE EXTERNAL FUNCTION CONFIG_EXISTS
    BLOB,
    CSTRING(32767)
RETURNS INTEGER BY VALUE
ENTRY_POINT 'CONFIG_EXISTS' MODULE_NAME 'udfibase.dll';

--

DECLARE EXTERNAL FUNCTION CONFIG_READ
    BLOB,
    CSTRING(32767),
    CSTRING(32767),
    CSTRING(32767)
RETURNS CSTRING(32767)
ENTRY_POINT 'CONFIG_READ' MODULE_NAME 'udfibase.dll';

--

DECLARE EXTERNAL FUNCTION BLOB_TO_STRING
    BLOB,
    INTEGER,
    INTEGER
RETURNS CSTRING(32767)
ENTRY_POINT 'BLOB_TO_STRING' MODULE_NAME 'udfibase.dll';

--

DECLARE EXTERNAL FUNCTION STRING_TO_BLOB
    CSTRING(32767),
    BLOB
RETURNS PARAMETER 2
ENTRY_POINT 'STRING_TO_BLOB' MODULE_NAME 'udfibase.dll';

--

DECLARE EXTERNAL FUNCTION DUPE
    CSTRING(32767),
    INTEGER
RETURNS CSTRING(32767)
ENTRY_POINT 'DUPE' MODULE_NAME 'udfibase.dll';

--

DECLARE EXTERNAL FUNCTION RANDOM_STRING
    INTEGER
RETURNS CSTRING(32767)
ENTRY_POINT 'RANDOM_STRING' MODULE_NAME 'udfibase.dll';

--

DECLARE EXTERNAL FUNCTION RANDOM
    INTEGER
RETURNS INTEGER BY VALUE
ENTRY_POINT 'RANDOM' MODULE_NAME 'udfibase.dll';

--

DECLARE EXTERNAL FUNCTION JOIN_BLOB
    BLOB,
    BLOB,
    BLOB
RETURNS PARAMETER 3
ENTRY_POINT 'JOIN_BLOB' MODULE_NAME 'udfibase.dll';

--

DECLARE EXTERNAL FUNCTION UDP
    CSTRING(32767),
    CSTRING(32767),
    BLOB,
    BLOB
RETURNS PARAMETER 4
ENTRY_POINT 'UDP' MODULE_NAME 'udfibase.dll';

--

DECLARE EXTERNAL FUNCTION PING
    CSTRING(32767),
    INTEGER
RETURNS INTEGER BY VALUE
ENTRY_POINT 'PING' MODULE_NAME 'udfibase.dll';

--

DECLARE EXTERNAL FUNCTION CONFIG_WRITE
    BLOB,
    CSTRING(32767),
    CSTRING(32767),
    CSTRING(32767),
    BLOB
RETURNS PARAMETER 5
ENTRY_POINT 'CONFIG_WRITE' MODULE_NAME 'udfibase.dll';

--

CREATE OR ALTER PROCEDURE GET_CONST_VALUE
(
    CONST_NAME VARCHAR(100)
)
RETURNS (
    CONST_VALUE VARCHAR(4000)
    ) 
AS
BEGIN
  CONST_VALUE=NULL;
  FOR SELECT BLOB_TO_STRING("VALUE",1,4000)
        FROM CONSTS
       WHERE UPPER(NAME)=UPPER(:CONST_NAME)
        INTO :CONST_VALUE DO BEGIN
    BREAK;
  END
  SUSPEND;
END

--

CREATE OR ALTER PROCEDURE GET_EVENT_PARAMS
(
  SESSION_ID VARCHAR(32),
  PROTOCOL INTEGER
)
RETURNS
(
  IP VARCHAR(20),
  PORT VARCHAR(10),
  LISTEN_IP VARCHAR(20),
  HOST VARCHAR(100),
  PATH VARCHAR(100),
  USE_CRYPTER INTEGER,
  CRYPTER_ALGORITHM INTEGER,
  CRYPTER_MODE INTEGER,
  CRYPTER_KEY VARCHAR(100),
  USE_COMPRESSOR INTEGER,
  COMPRESSOR_LEVEL INTEGER
)
AS
DECLARE PARAMS BLOB;
DECLARE SECTION VARCHAR(100);
BEGIN
  SELECT PARAMS
    FROM SESSIONS
   WHERE SESSION_ID=:SESSION_ID
    INTO :PARAMS;

  IF ((PROTOCOL=0) OR (PROTOCOL IS NULL)) THEN
    SECTION='ExternalUdpEventServer';
  ELSE
    SECTION='FirstHttpServerHandlerEvent';

  IF (CONFIG_EXISTS(PARAMS,SECTION)=1) THEN BEGIN

    IP=CONFIG_READ(PARAMS,SECTION,'IP','');
    PORT=CAST(CONFIG_READ(PARAMS,SECTION,'Port','80') AS INTEGER);
    LISTEN_IP=CONFIG_READ(PARAMS,SECTION,'ListenIP','');
    HOST=CONFIG_READ(PARAMS,SECTION,'Host','');
    PATH=CONFIG_READ(PARAMS,SECTION,'Path','');
    USE_CRYPTER=CAST(CONFIG_READ(PARAMS,SECTION,'UseCrypter','0') AS INTEGER);
    CRYPTER_ALGORITHM=CAST(CONFIG_READ(PARAMS,SECTION,'CrypterAlgorithm','0') AS INTEGER);
    CRYPTER_MODE=CAST(CONFIG_READ(PARAMS,SECTION,'CrypterMode','0') AS INTEGER);
    CRYPTER_KEY=CONFIG_READ(PARAMS,SECTION,'CrypterKey','');
    USE_COMPRESSOR=CAST(CONFIG_READ(PARAMS,SECTION,'UseCompressor','0') AS INTEGER);
    COMPRESSOR_LEVEL=CAST(CONFIG_READ(PARAMS,SECTION,'CompressorLevel','0') AS INTEGER);

  END

END

--

CREATE OR ALTER PROCEDURE GET_EVENT_SESSIONS
(
  SORTING INTEGER,
  IN_APPLICATION_ID VARCHAR(32),
  IN_ACCOUNT_ID VARCHAR(32),
  PROTOCOL INTEGER
)
RETURNS (
  SESSION_ID VARCHAR(32),
  APPLICATION_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  DATE_CHANGE TIMESTAMP,
  IP VARCHAR(20),
  PORT VARCHAR(10),
  LISTEN_IP VARCHAR(20),
  HOST VARCHAR(100),
  PATH VARCHAR(100),
  USE_CRYPTER INTEGER,
  CRYPTER_ALGORITHM INTEGER,
  CRYPTER_MODE INTEGER,
  CRYPTER_KEY VARCHAR(100),
  USE_COMPRESSOR INTEGER,
  COMPRESSOR_LEVEL INTEGER)
AS
DECLARE SQL VARCHAR(2000);
BEGIN

  SQL='SELECT SESSION_ID, APPLICATION_ID, ACCOUNT_ID, DATE_CHANGE FROM SESSIONS WHERE ';

  IF (IN_APPLICATION_ID IS NULL) THEN
    SQL=SQL||'APPLICATION_ID IS NOT NULL ';
  ELSE
    SQL=SQL||'APPLICATION_ID='''||IN_APPLICATION_ID||''' ';

  IF (IN_ACCOUNT_ID IS NULL) THEN
    SQL=SQL||'AND ACCOUNT_ID IS NOT NULL ';
  ELSE BEGIN
    SQL=SQL||'AND (ACCOUNT_ID='''||IN_ACCOUNT_ID||''' OR ';
    SQL=SQL||'ACCOUNT_ID IN (SELECT ACCOUNT_ID FROM ACCOUNT_ROLES WHERE ROLE_ID='''||IN_ACCOUNT_ID||''')) ';
  END

  IF (SORTING=0) THEN
    SQL=SQL||'ORDER BY DATE_CHANGE DESC';

  IF (SORTING=1) THEN
    SQL=SQL||'ORDER BY DATE_CHANGE ASC';

  FOR EXECUTE STATEMENT SQL
                   INTO :SESSION_ID, :APPLICATION_ID, :ACCOUNT_ID, :DATE_CHANGE DO BEGIN

    EXECUTE PROCEDURE GET_EVENT_PARAMS (SESSION_ID,PROTOCOL)
     RETURNING_VALUES IP, PORT, LISTEN_IP, HOST, PATH,
                      USE_CRYPTER, CRYPTER_ALGORITHM, CRYPTER_MODE, CRYPTER_KEY,
                      USE_COMPRESSOR, COMPRESSOR_LEVEL;

    IF (IP IS NOT NULL) THEN
      SUSPEND;

  END

END

--

CREATE OR ALTER PROCEDURE SEND_EVENT
(
  SORTING INTEGER,
  FIRST_RECORD INTEGER,
  APPLICATION_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  INCLUDE_SESSION_ID VARCHAR(32),
  EXCLUDE_SESSION_ID VARCHAR(32),
  PROTOCOL INTEGER,
  NAME VARCHAR(100),
  IN_PARAMS BLOB
)
RETURNS (
  SUCCESS INTEGER,
  OUT_PARAMS BLOB
)
AS
DECLARE TEMP BLOB;
DECLARE SESSION_ID VARCHAR(32);
DECLARE IP VARCHAR(20);
DECLARE PORT VARCHAR(10);
DECLARE LISTEN_IP VARCHAR(20);
DECLARE HOST VARCHAR(100);
DECLARE PATH VARCHAR(100);
DECLARE USE_CRYPTER INTEGER;
DECLARE CRYPTER_ALGORITHM INTEGER;
DECLARE CRYPTER_MODE INTEGER;
DECLARE CRYPTER_KEY VARCHAR(100);
DECLARE USE_COMPRESSOR INTEGER;
DECLARE COMPRESSOR_LEVEL INTEGER;
DECLARE RND VARCHAR(4000);
BEGIN

  IF (PROTOCOL=0) THEN
    RND=RANDOM_STRING(32);
  ELSE
    RND=RANDOM_STRING(1024*3); /* for fast reaction */

  FOR SELECT SESSION_ID, IP, PORT, LISTEN_IP, HOST, PATH,
             USE_CRYPTER, CRYPTER_ALGORITHM, CRYPTER_MODE, CRYPTER_KEY,
             USE_COMPRESSOR, COMPRESSOR_LEVEL
        FROM GET_EVENT_SESSIONS(:SORTING,:APPLICATION_ID,:ACCOUNT_ID,:PROTOCOL)
       WHERE ((:EXCLUDE_SESSION_ID IS NULL) OR (SESSION_ID<>:EXCLUDE_SESSION_ID))
         AND ((:INCLUDE_SESSION_ID IS NULL) OR (SESSION_ID=:INCLUDE_SESSION_ID))
        INTO :SESSION_ID, :IP, :PORT, :LISTEN_IP, :HOST, :PATH,
             :USE_CRYPTER, :CRYPTER_ALGORITHM, :CRYPTER_MODE, :CRYPTER_KEY,
             :USE_COMPRESSOR, :COMPRESSOR_LEVEL DO BEGIN

    SUCCESS=0;

    TEMP=CONFIG_WRITE(IN_PARAMS,NAME,'rnd',RND);
    TEMP=CONFIG_WRITE(TEMP,NAME,'SessionId',SESSION_ID);

    IF (USE_COMPRESSOR=1) THEN
      TEMP=COMPRESS_BLOB(TEMP,COMPRESSOR_LEVEL);

    IF (USE_CRYPTER=1) THEN
      TEMP=ENCODE_BLOB(TEMP,CRYPTER_KEY,CRYPTER_ALGORITHM,CRYPTER_MODE);

    IF (PROTOCOL=0) THEN BEGIN

      OUT_PARAMS=UDP(HOST,PORT,TEMP);

      IF ((OUT_PARAMS IS NULL) OR (TRIM(OUT_PARAMS)='')) THEN
        SUCCESS=1;

    END ELSE BEGIN
      OUT_PARAMS=HTTP_POST(HOST,PORT,PATH,TEMP);

      IF (USE_CRYPTER=1) THEN
        OUT_PARAMS=DECODE_BLOB(OUT_PARAMS,CRYPTER_KEY,CRYPTER_ALGORITHM,CRYPTER_MODE);

      IF (USE_COMPRESSOR=1) THEN
        OUT_PARAMS=DECOMPRESS_BLOB(OUT_PARAMS);

      IF (OUT_PARAMS IS NOT NULL) THEN
        SUCCESS=CAST(CONFIG_READ(OUT_PARAMS,NAME,'Success','0') AS INTEGER);

    END

    SUSPEND;

    IF (FIRST_RECORD=1) THEN
      BREAK;

  END

END

--

CREATE OR ALTER PROCEDURE EVENT_ALARM
(
  APPLICATION_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  EXCLUDE_SESSION_ID VARCHAR(32),
  PROTOCOL INTEGER
)
RETURNS
(
  SUCCESS INTEGER
)
AS
DECLARE TEMP INTEGER;
BEGIN
  SUCCESS=0;

  FOR SELECT SUCCESS
       FROM SEND_EVENT(0,0,:APPLICATION_ID,:ACCOUNT_ID,NULL,:EXCLUDE_SESSION_ID,:PROTOCOL,
                       'CBC805C736F597274D7B8588AE15F9C5',NULL)
       INTO :TEMP DO BEGIN

    IF (TEMP=1) THEN
      SUCCESS=TEMP;

  END
END

--

CREATE OR ALTER PROCEDURE I_ALARM
(
  SESSION_ID VARCHAR(32),
  ALARM_ID VARCHAR(32),
  SENDER_ID VARCHAR(32),
  RECIPIENT_ID VARCHAR(32),
  TYPE_ALARM INTEGER,
  DATE_BEGIN TIMESTAMP,
  DATE_END TIMESTAMP,
  CAPTION VARCHAR(100),
  TEXT_ALARM VARCHAR(4000)
)
AS
DECLARE SUCCESS INTEGER;
BEGIN

  IN AUTONOMOUS TRANSACTION DO BEGIN

    INSERT INTO ALARMS (ALARM_ID,SENDER_ID,RECIPIENT_ID,TYPE_ALARM,
                        DATE_BEGIN,DATE_END,CAPTION,TEXT_ALARM)
         VALUES (:ALARM_ID,:SENDER_ID,:RECIPIENT_ID,:TYPE_ALARM,
                 :DATE_BEGIN,:DATE_END,:CAPTION,:TEXT_ALARM);
  END
  
  EXECUTE PROCEDURE EVENT_ALARM('A35F5701A7AA920E40812A71A690910D',RECIPIENT_ID,SESSION_ID,0)
   RETURNING_VALUES SUCCESS;

  
END

--

CREATE OR ALTER PROCEDURE U_ALARM
(
  SESSION_ID VARCHAR(32),
  ALARM_ID VARCHAR(32),
  SENDER_ID VARCHAR(32),
  RECIPIENT_ID VARCHAR(32),
  TYPE_ALARM INTEGER,
  DATE_BEGIN TIMESTAMP,
  DATE_END TIMESTAMP,
  CAPTION VARCHAR(100),
  TEXT_ALARM VARCHAR(4000),
  OLD_ALARM_ID VARCHAR(32)
)
AS
DECLARE SUCCESS INTEGER;
DECLARE OLD_RECIPIENT_ID VARCHAR(32);
BEGIN

  SELECT RECIPIENT_ID
    FROM ALARMS
   WHERE ALARM_ID=:OLD_ALARM_ID
    INTO :OLD_RECIPIENT_ID;

  IN AUTONOMOUS TRANSACTION DO BEGIN

    UPDATE ALARMS
       SET ALARM_ID=:ALARM_ID,
           SENDER_ID=:SENDER_ID,
           RECIPIENT_ID=:RECIPIENT_ID,
           TYPE_ALARM=:TYPE_ALARM,
           DATE_BEGIN=:DATE_BEGIN,
           DATE_END=:DATE_END,
           CAPTION=:CAPTION,
           TEXT_ALARM=:TEXT_ALARM
     WHERE ALARM_ID=:OLD_ALARM_ID;
     
  END
  
  EXECUTE PROCEDURE EVENT_ALARM('A35F5701A7AA920E40812A71A690910D',RECIPIENT_ID,SESSION_ID,0)
   RETURNING_VALUES SUCCESS;

  IF (OLD_RECIPIENT_ID<>RECIPIENT_ID) THEN
    EXECUTE PROCEDURE EVENT_ALARM('A35F5701A7AA920E40812A71A690910D',OLD_RECIPIENT_ID,SESSION_ID,0)
     RETURNING_VALUES SUCCESS;
  
END

--

CREATE OR ALTER PROCEDURE D_ALARM 
(
  SESSION_ID VARCHAR(32),
  OLD_ALARM_ID VARCHAR(32)
)
AS
DECLARE SUCCESS INTEGER;
DECLARE ACCOUNT_ID VARCHAR(32);
BEGIN

  SELECT RECIPIENT_ID
    FROM ALARMS
   WHERE ALARM_ID=:OLD_ALARM_ID
    INTO ACCOUNT_ID;

  IN AUTONOMOUS TRANSACTION DO BEGIN

    DELETE FROM ALARMS
          WHERE ALARM_ID=:OLD_ALARM_ID;
  END

  EXECUTE PROCEDURE EVENT_ALARM('A35F5701A7AA920E40812A71A690910D',ACCOUNT_ID,SESSION_ID,0)
   RETURNING_VALUES SUCCESS;

END

--

CREATE OR ALTER PROCEDURE EVENT_DELETE_SESSION
(
  SESSION_ID VARCHAR(32),
  PROTOCOL INTEGER
)
AS
DECLARE TEMP INTEGER;
DECLARE SECTION VARCHAR(100);
BEGIN
  SECTION='7343F5E621C593A74B03F485E3AAA276';
  FOR SELECT SUCCESS
       FROM SEND_EVENT(0,1,NULL,NULL,:SESSION_ID,NULL,:PROTOCOL,:SECTION,NULL)
       INTO :TEMP DO BEGIN
    BREAK;
  END
END

--

CREATE OR ALTER PROCEDURE D_SESSION
(
  OLD_SESSION_ID VARCHAR(32)
)
AS
BEGIN
  EXECUTE PROCEDURE EVENT_DELETE_SESSION(OLD_SESSION_ID,0);

  DELETE FROM SESSIONS
        WHERE SESSION_ID=:OLD_SESSION_ID;

END

--

CREATE OR ALTER PROCEDURE EVENT_CHECK_SESSIONS
(
  APPLICATION_ID VARCHAR(32),
  SESSION_ID VARCHAR(32),
  PROTOCOL INTEGER
)
AS
DECLARE TEMP INTEGER;
DECLARE SECTION VARCHAR(100);
BEGIN
  SECTION='F4787DCBAE92A1AF4A8416AB98616E3A';
  FOR SELECT SUCCESS
       FROM SEND_EVENT(0,1,:APPLICATION_ID,NULL,NULL,:SESSION_ID,:PROTOCOL,:SECTION,NULL)
       INTO :TEMP DO BEGIN
    BREAK;
  END
END

--

CREATE OR ALTER PROCEDURE TASK_DELETE_SESSIONS
(
  SESSION_ID VARCHAR(32),
  TASK_ID VARCHAR(32)
)
AS
DECLARE
  DELETE_SESSION_ID VARCHAR(32);
BEGIN
  IN AUTONOMOUS TRANSACTION DO BEGIN

    FOR SELECT SESSION_ID
          FROM SESSIONS
         WHERE DATE_CHANGE<(CURRENT_TIMESTAMP-10*60*(1e0/24/60/60))
           AND APPLICATION_ID='A35F5701A7AA920E40812A71A690910D'
           AND SESSION_ID<>:SESSION_ID
          INTO :DELETE_SESSION_ID DO BEGIN

      EXECUTE PROCEDURE EVENT_DELETE_SESSION(DELETE_SESSION_ID,0);

      DELETE FROM SESSIONS
            WHERE SESSION_ID=:DELETE_SESSION_ID;
    END

  END

  EXECUTE PROCEDURE EVENT_CHECK_SESSIONS('A2FB11F34A5F8A0942E878850A400DB9',SESSION_ID,0);

  EXECUTE PROCEDURE EVENT_CHECK_SESSIONS('AF5DFB35AE9C819F41FB2451E2EB0D0D',SESSION_ID,0);

END

--

CREATE OR ALTER PROCEDURE EVENT_REFRESH_TASKS
(
  APPLICATION_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  SESSION_ID VARCHAR(32),
  PROTOCOL INTEGER
)
AS
DECLARE TEMP INTEGER;
DECLARE SECTION VARCHAR(100);
BEGIN
  SECTION='D7624010D2CC9D7549CF137E40AC2424';
  FOR SELECT SUCCESS
       FROM SEND_EVENT(0,0,:APPLICATION_ID,:ACCOUNT_ID,NULL,:SESSION_ID,:PROTOCOL,:SECTION,NULL)
       INTO :TEMP DO BEGIN
    
  END
END

--

CREATE OR ALTER PROCEDURE I_TASK
(
  SESSION_ID VARCHAR(32),
  TASK_ID VARCHAR(32),
  APPLICATION_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  INTERFACE_ID VARCHAR(32),
  NAME VARCHAR(100),
  DESCRIPTION VARCHAR(250),
  DATE_BEGIN TIMESTAMP,
  DATE_END TIMESTAMP,
  SCHEDULE INTEGER,
  PRIORITY INTEGER,
  ENABLED INTEGER,
  PROC_NAME VARCHAR(100),
  COMMAND_STRING VARCHAR(250),
  REPEAT_ENABLED INTEGER,
  REPEAT_TYPE INTEGER,
  REPEAT_VALUE INTEGER,
  REPEAT_COUNT INTEGER,
  DAY_FREQUENCY INTEGER,
  WEEK_FREQUENCY INTEGER,
  MONDAY INTEGER,
  TUESDAY INTEGER,
  WEDNESDAY INTEGER,
  THURSDAY INTEGER,
  FRIDAY INTEGER,
  SATURDAY INTEGER,
  SUNDAY INTEGER,
  MONTH_DAY INTEGER,
  JANUARY INTEGER,
  FEBRUARY INTEGER,
  MARCH INTEGER,
  APRIL INTEGER,
  MAY INTEGER,
  JUNE INTEGER,
  JULY INTEGER,
  AUGUST INTEGER,
  SEPTEMBER INTEGER,
  OCTOBER INTEGER,
  NOVEMBER INTEGER,
  DECEMBER INTEGER,
  DATE_EXECUTE TIMESTAMP,
  RESULT_STRING VARCHAR(250)
)
AS
BEGIN
  IN AUTONOMOUS TRANSACTION DO BEGIN
  
    INSERT INTO TASKS (TASK_ID,APPLICATION_ID,ACCOUNT_ID,INTERFACE_ID,NAME,DESCRIPTION,DATE_BEGIN,
                       DATE_END,SCHEDULE,PRIORITY,ENABLED,PROC_NAME,COMMAND_STRING,REPEAT_ENABLED,
                       REPEAT_TYPE,REPEAT_VALUE,REPEAT_COUNT,DAY_FREQUENCY,WEEK_FREQUENCY,
                       MONDAY,TUESDAY,WEDNESDAY,THURSDAY,FRIDAY,SATURDAY,SUNDAY,MONTH_DAY,
                       JANUARY,FEBRUARY,MARCH,APRIL,MAY,JUNE,JULY,AUGUST,SEPTEMBER,OCTOBER,NOVEMBER,DECEMBER,
                       DATE_EXECUTE,RESULT_STRING)
         VALUES (:TASK_ID,:APPLICATION_ID,:ACCOUNT_ID,:INTERFACE_ID,:NAME,:DESCRIPTION,:DATE_BEGIN,
                 :DATE_END,:SCHEDULE,:PRIORITY,:ENABLED,:PROC_NAME,:COMMAND_STRING,:REPEAT_ENABLED,
                 :REPEAT_TYPE,:REPEAT_VALUE,:REPEAT_COUNT,:DAY_FREQUENCY,:WEEK_FREQUENCY,
                 :MONDAY,:TUESDAY,:WEDNESDAY,:THURSDAY,:FRIDAY,:SATURDAY,:SUNDAY,:MONTH_DAY,
                 :JANUARY,:FEBRUARY,:MARCH,:APRIL,:MAY,:JUNE,:JULY,:AUGUST,:SEPTEMBER,:OCTOBER,:NOVEMBER,:DECEMBER,
                 :DATE_EXECUTE,:RESULT_STRING);
  END

  EXECUTE PROCEDURE EVENT_REFRESH_TASKS(APPLICATION_ID,ACCOUNT_ID,SESSION_ID,0);

END

--

CREATE OR ALTER PROCEDURE U_TASK
(
  SESSION_ID VARCHAR(32),
  TASK_ID VARCHAR(32),
  APPLICATION_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  INTERFACE_ID VARCHAR(32),
  NAME VARCHAR(100),
  DESCRIPTION VARCHAR(250),
  DATE_BEGIN TIMESTAMP,
  DATE_END TIMESTAMP,
  SCHEDULE INTEGER,
  PRIORITY INTEGER,
  ENABLED INTEGER,
  PROC_NAME VARCHAR(100),
  COMMAND_STRING VARCHAR(250),
  REPEAT_ENABLED INTEGER,
  REPEAT_TYPE INTEGER,
  REPEAT_VALUE INTEGER,
  REPEAT_COUNT INTEGER,
  DAY_FREQUENCY INTEGER,
  WEEK_FREQUENCY INTEGER,
  MONDAY INTEGER,
  TUESDAY INTEGER,
  WEDNESDAY INTEGER,
  THURSDAY INTEGER,
  FRIDAY INTEGER,
  SATURDAY INTEGER,
  SUNDAY INTEGER,
  MONTH_DAY INTEGER,
  JANUARY INTEGER,
  FEBRUARY INTEGER,
  MARCH INTEGER,
  APRIL INTEGER,
  MAY INTEGER,
  JUNE INTEGER,
  JULY INTEGER,
  AUGUST INTEGER,
  SEPTEMBER INTEGER,
  OCTOBER INTEGER,
  NOVEMBER INTEGER,
  DECEMBER INTEGER,
  DATE_EXECUTE TIMESTAMP,
  RESULT_STRING VARCHAR(250),
  OLD_TASK_ID VARCHAR(32)
)
AS
DECLARE OLD_APPLICATION_ID VARCHAR(32);
DECLARE OLD_ACCOUNT_ID VARCHAR(32);
BEGIN

  SELECT APPLICATION_ID, ACCOUNT_ID
    FROM TASKS
   WHERE TASK_ID=:OLD_TASK_ID
    INTO :OLD_APPLICATION_ID, :OLD_ACCOUNT_ID;

  IN AUTONOMOUS TRANSACTION DO BEGIN

    UPDATE TASKS
       SET TASK_ID=:TASK_ID,
           APPLICATION_ID=:APPLICATION_ID,
           ACCOUNT_ID=:ACCOUNT_ID,
           INTERFACE_ID=:INTERFACE_ID,
           NAME=:NAME,
           DESCRIPTION=:DESCRIPTION,
           DATE_BEGIN=:DATE_BEGIN,
           DATE_END=:DATE_END,
           SCHEDULE=:SCHEDULE,
           PRIORITY=:PRIORITY,
           ENABLED=:ENABLED,
           PROC_NAME=:PROC_NAME,
           COMMAND_STRING=:COMMAND_STRING,
           REPEAT_ENABLED=:REPEAT_ENABLED,
           REPEAT_TYPE=:REPEAT_TYPE,
           REPEAT_VALUE=:REPEAT_VALUE,
           REPEAT_COUNT=:REPEAT_COUNT,
           DAY_FREQUENCY=:DAY_FREQUENCY,
           WEEK_FREQUENCY=:WEEK_FREQUENCY,
           MONDAY=:MONDAY,
           TUESDAY=:TUESDAY,
           WEDNESDAY=:WEDNESDAY,
           THURSDAY=:THURSDAY,
           FRIDAY=:FRIDAY,
           SATURDAY=:SATURDAY,
           SUNDAY=:SUNDAY,
           MONTH_DAY=:MONTH_DAY,
           JANUARY=:JANUARY,
           FEBRUARY=:FEBRUARY,
           MARCH=:MARCH,
           APRIL=:APRIL,
           MAY=:MAY,
           JUNE=:JUNE,
           JULY=:JULY,
           AUGUST=:AUGUST,
           SEPTEMBER=:SEPTEMBER,
           OCTOBER=:OCTOBER,
           NOVEMBER=:NOVEMBER,
           DECEMBER=:DECEMBER,
           DATE_EXECUTE=:DATE_EXECUTE,
           RESULT_STRING=:RESULT_STRING
     WHERE TASK_ID=:OLD_TASK_ID;
     
  END

  EXECUTE PROCEDURE EVENT_REFRESH_TASKS(APPLICATION_ID,ACCOUNT_ID,SESSION_ID,0);
  
  IF ((OLD_APPLICATION_ID<>APPLICATION_ID) OR (OLD_ACCOUNT_ID<>ACCOUNT_ID)) THEN
    EXECUTE PROCEDURE EVENT_REFRESH_TASKS(OLD_APPLICATION_ID,OLD_ACCOUNT_ID,SESSION_ID,0);
  
END

--

CREATE OR ALTER PROCEDURE D_TASK
(
  SESSION_ID VARCHAR(32),
  OLD_TASK_ID VARCHAR(32)
)
AS
DECLARE APPLICATION_ID VARCHAR(32);
DECLARE ACCOUNT_ID VARCHAR(32);
BEGIN
  SELECT APPLICATION_ID, ACCOUNT_ID
    FROM TASKS
   WHERE TASK_ID=:OLD_TASK_ID
    INTO :APPLICATION_ID, :ACCOUNT_ID;
    
  IN AUTONOMOUS TRANSACTION DO BEGIN

    DELETE FROM TASKS
          WHERE TASK_ID=:OLD_TASK_ID;

  END

  EXECUTE PROCEDURE EVENT_REFRESH_TASKS(APPLICATION_ID,ACCOUNT_ID,SESSION_ID,0);

END

--

CREATE OR ALTER PROCEDURE EVENT_REFRESH_ORDERS
(
  APPLICATION_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  SESSION_ID VARCHAR(32),
  PROTOCOL INTEGER
)
AS
DECLARE TEMP INTEGER;
DECLARE SECTION VARCHAR(100);
BEGIN
  SECTION='S_ORDERS';
  FOR SELECT SUCCESS
       FROM SEND_EVENT(0,0,:APPLICATION_ID,:ACCOUNT_ID,NULL,:SESSION_ID,:PROTOCOL,:SECTION,NULL)
       INTO :TEMP DO BEGIN
  END
END

--

CREATE OR ALTER PROCEDURE PROCESS_RESULT
(
  SESSION_ID VARCHAR(32),
  OLD_ORDER_ID VARCHAR(32),
  NEW_ORDER_ID VARCHAR(32),
  RESULT_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  TYPE_PROCESS INTEGER
)
RETURNS (
  ORDER_ID VARCHAR(32)
)
AS
DECLARE PROC_PROCESS VARCHAR(100);
DECLARE NEXT_ID VARCHAR(100);
DECLARE SQL VARCHAR(1000);
DECLARE AORDER_ID VARCHAR(32);
BEGIN
  ORDER_ID=OLD_ORDER_ID;

  SELECT PROC_PROCESS, NEXT_ID
    FROM RESULTS
   WHERE RESULT_ID=:RESULT_ID
    INTO :PROC_PROCESS, :NEXT_ID;

  IN AUTONOMOUS TRANSACTION DO BEGIN

    UPDATE ORDERS
       SET RESULT_ID=:RESULT_ID,
           DATE_END=CURRENT_TIMESTAMP
     WHERE ORDER_ID=:OLD_ORDER_ID;

  END

  EXECUTE PROCEDURE EVENT_REFRESH_ORDERS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

  IF (NEXT_ID IS NOT NULL) THEN BEGIN

    EXECUTE PROCEDURE CREATE_ORDER_HISTORY(SESSION_ID,OLD_ORDER_ID,NEW_ORDER_ID,ACCOUNT_ID,
                                           NEXT_ID,NULL,TYPE_PROCESS,CURRENT_TIMESTAMP,1);
    ORDER_ID=NEW_ORDER_ID;
  END


  IF (TRIM(PROC_PROCESS)<>'') THEN BEGIN

    SQL='EXECUTE PROCEDURE '||PROC_PROCESS||'('''||SESSION_ID||''','''||ORDER_ID||''','''||ACCOUNT_ID||''');';
    EXECUTE STATEMENT SQL;

  END
END

--

CREATE OR ALTER PROCEDURE LOCK_ORDER
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  LOCKED VARCHAR(32),
  TYPE_PROCESS INTEGER
)
AS
BEGIN

  IN AUTONOMOUS TRANSACTION DO BEGIN

    UPDATE ORDERS
       SET LOCKED=:LOCKED,
           TYPE_PROCESS=:TYPE_PROCESS
     WHERE ORDER_ID=:ORDER_ID;

  END

  EXECUTE PROCEDURE EVENT_REFRESH_ORDERS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

END

--

CREATE OR ALTER PROCEDURE UNLOCK_ORDER
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32)
)
AS
BEGIN

  IN AUTONOMOUS TRANSACTION DO BEGIN

    UPDATE ORDERS
       SET LOCKED=NULL
     WHERE ORDER_ID=:ORDER_ID;

  END

  EXECUTE PROCEDURE EVENT_REFRESH_ORDERS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

END

--

CREATE OR ALTER PROCEDURE PROCESS_ORDER
(
  SESSION_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  TYPE_PROCESS INTEGER
)
AS
DECLARE LOCKED VARCHAR(32);
DECLARE ACTION_ID VARCHAR(32);
DECLARE RESULT_ID VARCHAR(32);
BEGIN
  LOCKED=NULL;

  EXECUTE PROCEDURE CHECK_LOCK_ORDER(ORDER_ID)
   RETURNING_VALUES LOCKED;

  IF (LOCKED IS NULL) THEN BEGIN

    LOCKED=GET_UNIQUE_ID();

    EXECUTE PROCEDURE LOCK_ORDER(SESSION_ID,ORDER_ID,LOCKED,TYPE_PROCESS);

    FOR SELECT ACTION_ID
        FROM ORDERS
       WHERE ORDER_ID=:ORDER_ID
        INTO :ACTION_ID DO BEGIN
      BREAK;
    END

    EXECUTE PROCEDURE GET_DEFAULT_RESULT_ID(ORDER_ID,ACTION_ID)
     RETURNING_VALUES RESULT_ID;

    IF (RESULT_ID IS NOT NULL) THEN BEGIN

      EXECUTE PROCEDURE PROCESS_RESULT(SESSION_ID,ORDER_ID,GET_UNIQUE_ID(),RESULT_ID,ACCOUNT_ID,TYPE_PROCESS)
       RETURNING_VALUES ORDER_ID;

    END

    EXECUTE PROCEDURE UNLOCK_ORDER(SESSION_ID,ORDER_ID);

  END

END

--

CREATE OR ALTER PROCEDURE CODE_PROCESS_ORDER
(
  SESSION_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  IN_MESSAGE_ID VARCHAR(32)
)
AS
DECLARE SENDER_ID VARCHAR(32);
DECLARE CODE VARCHAR(100);
DECLARE CNT INTEGER;
DECLARE SUM_CHARGE NUMERIC(15,2);
DECLARE SUM_RECEIPT NUMERIC(15,2);
DECLARE BALANCE NUMERIC(15,2);
DECLARE MIN_BALANCE NUMERIC(15,2);
DECLARE ORDER_ID VARCHAR(32);
BEGIN
  SELECT IM.SENDER_ID, CM.CODE
    FROM IN_MESSAGES IM
    LEFT JOIN CODE_MESSAGES CM ON CM.CODE_MESSAGE_ID=IM.CODE_MESSAGE_ID
   WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :SENDER_ID, :CODE;

  IF ((SENDER_ID IS NOT NULL) AND (CODE IS NOT NULL)) THEN BEGIN

    SELECT COUNT(*)
      FROM DRIVERS D
      JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
     WHERE D.DRIVER_ID=:SENDER_ID
       AND A.LOCKED<>1
      INTO :CNT;

    IF (CNT>0) THEN BEGIN

      EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:SENDER_ID)
       RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

      SELECT MIN_BALANCE
        FROM DRIVERS
       WHERE DRIVER_ID=:SENDER_ID
        INTO :MIN_BALANCE;

      IF ((MIN_BALANCE IS NULL) OR ((MIN_BALANCE IS NOT NULL) AND (BALANCE>MIN_BALANCE))) THEN BEGIN

        ORDER_ID=NULL;

        FOR SELECT ORDER_ID
              FROM ORDERS
             WHERE DRIVER_ID=:SENDER_ID
               AND PARENT_ID IS NULL
               AND DATE_HISTORY IS NULL
               AND FINISHED<>1
               AND LOCKED IS NULL
             ORDER BY DATE_ACCEPT DESC
              INTO :ORDER_ID DO BEGIN
          BREAK;
        END

        IF (ORDER_ID IS NOT NULL) THEN BEGIN

          UPDATE IN_MESSAGES
             SET ORDER_ID=:ORDER_ID
           WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID;

          EXECUTE PROCEDURE PROCESS_ORDER(SESSION_ID,ACCOUNT_ID,ORDER_ID,0);

        END

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE PR_AUTOMATIC
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
BEGIN

  IN AUTONOMOUS TRANSACTION DO BEGIN

    UPDATE ORDERS
       SET TYPE_PROCESS=0,
           DATE_END=CURRENT_TIMESTAMP,
           WHO_PROCESS_ID=:ACCOUNT_ID
     WHERE ORDER_ID=:ORDER_ID;

  END

  EXECUTE PROCEDURE EVENT_REFRESH_ORDERS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

END

--

CREATE OR ALTER PROCEDURE PR_CREATE_ORDER
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE DATE_BEGIN TIMESTAMP;
DECLARE DATE_ARRIVAL TIMESTAMP;
DECLARE BEFORE_PERIOD INTEGER;
DECLARE DATE_ACCEPT TIMESTAMP;
DECLARE STATUS INTEGER;
BEGIN

  DATE_BEGIN=CURRENT_TIMESTAMP;

  SELECT DATE_ACCEPT, DATE_ARRIVAL, BEFORE_PERIOD,
         (CASE WHEN (FINISHED=0) AND (CURRENT_TIMESTAMP>=(DATE_ARRIVAL-(BEFORE_PERIOD*(1e0/24/60)))) THEN 0
               WHEN (FINISHED=0) AND (CURRENT_TIMESTAMP<(DATE_ARRIVAL-(BEFORE_PERIOD*(1e0/24/60)))) THEN 1
               WHEN FINISHED=1 THEN 2
           END) AS STATUS
    FROM ORDERS
   WHERE ORDER_ID=:ORDER_ID
    INTO :DATE_ACCEPT, :DATE_ARRIVAL, :BEFORE_PERIOD, :STATUS;

  IF (STATUS=1) THEN
    DATE_BEGIN=DATE_ARRIVAL-(BEFORE_PERIOD*(1e0/24/60));

  IN AUTONOMOUS TRANSACTION DO BEGIN

    UPDATE ORDERS
       SET DATE_BEGIN=:DATE_BEGIN,
           TYPE_PROCESS=0
     WHERE ORDER_ID=:ORDER_ID;

  END

  EXECUTE PROCEDURE EVENT_REFRESH_ORDERS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

END

--

CREATE OR ALTER PROCEDURE PR_DOUBLE
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
BEGIN

  IN AUTONOMOUS TRANSACTION DO BEGIN

    UPDATE ORDERS
       SET DATE_END=CURRENT_TIMESTAMP,
           WHO_PROCESS_ID=:ACCOUNT_ID,
           FINISHED=1
     WHERE ORDER_ID=:ORDER_ID;

  END

  EXECUTE PROCEDURE EVENT_REFRESH_ORDERS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

END

--

CREATE OR ALTER PROCEDURE PR_FINISH
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
BEGIN

  IN AUTONOMOUS TRANSACTION DO BEGIN

    UPDATE ORDERS
       SET DATE_END=CURRENT_TIMESTAMP,
           WHO_PROCESS_ID=:ACCOUNT_ID,
           FINISHED=1
     WHERE ORDER_ID=:ORDER_ID;

  END

  EXECUTE PROCEDURE EVENT_REFRESH_ORDERS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

END

--

CREATE OR ALTER PROCEDURE PR_MANUAL
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
BEGIN

  IN AUTONOMOUS TRANSACTION DO BEGIN

    UPDATE ORDERS
       SET TYPE_PROCESS=1,
           DATE_END=CURRENT_TIMESTAMP,
           WHO_PROCESS_ID=:ACCOUNT_ID
     WHERE ORDER_ID=:ORDER_ID;

  END

  EXECUTE PROCEDURE EVENT_REFRESH_ORDERS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

END

--

CREATE OR ALTER PROCEDURE PR_NO_DRIVER
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE ZONE_ID VARCHAR(32);
DECLARE PARK_ID VARCHAR(32);
DECLARE DRIVER_ID VARCHAR(32);
DECLARE CAR_TYPE_ID VARCHAR(32);
DECLARE RESULT_DRIVER_ID VARCHAR(32);
DECLARE RESULT_PARK_ID VARCHAR(32);
DECLARE CAR_ID VARCHAR(32);
DECLARE CNT INTEGER;
BEGIN

  SELECT ZONE_ID, PARK_ID, DRIVER_ID, CAR_TYPE_ID
    FROM ORDERS
   WHERE ORDER_ID=:ORDER_ID
    INTO :ZONE_ID, :PARK_ID, :DRIVER_ID, :CAR_TYPE_ID;

  IF (DRIVER_ID IS NULL) THEN BEGIN

    IF (ZONE_ID IS NOT NULL) THEN BEGIN

      RESULT_PARK_ID=NULL;
      RESULT_DRIVER_ID=NULL;

      IF (PARK_ID IS NULL) THEN BEGIN

        FOR SELECT P.PARK_ID
              FROM ZONE_PARKS ZP
              JOIN PARKS P ON P.PARK_ID=ZP.PARK_ID
             WHERE ZP.ZONE_ID=:ZONE_ID
             ORDER BY ZP.DISTANCE, ZP.PERIOD
              INTO :PARK_ID DO BEGIN

          FOR SELECT PS.DRIVER_ID
                FROM PARK_STATES PS
                JOIN DRIVERS D ON D.DRIVER_ID=PS.DRIVER_ID
               WHERE PS.PARK_ID=:PARK_ID
                 AND PS.DATE_OUT IS NULL
                 AND D.CAR_ID IN (SELECT CAR_ID
                                    FROM CAR_IN_TYPES
                                   WHERE CAR_TYPE_ID=:CAR_TYPE_ID)
               ORDER BY D.PRIORITY, PS.DATE_IN
                INTO :DRIVER_ID DO BEGIN

            SELECT COUNT(*)
              FROM ORDERS
             WHERE DRIVER_ID=:DRIVER_ID
               AND PARENT_ID IS NULL
               AND DATE_HISTORY IS NULL
               AND FINISHED<>1
              INTO :CNT;

            IF (CNT=0) THEN BEGIN
              RESULT_DRIVER_ID=DRIVER_ID;
              BREAK;
            END

          END

          IF (RESULT_DRIVER_ID IS NOT NULL) THEN BEGIN
            RESULT_PARK_ID=PARK_ID;
            BREAK;
          END

        END

      END ELSE BEGIN

        FOR SELECT PS.DRIVER_ID
              FROM PARK_STATES PS
              JOIN DRIVERS D ON D.DRIVER_ID=PS.DRIVER_ID
             WHERE PS.PARK_ID=:PARK_ID
               AND PS.DATE_OUT IS NULL
               AND D.CAR_ID IN (SELECT CAR_ID
                                  FROM CAR_IN_TYPES
                                 WHERE CAR_TYPE_ID=:CAR_TYPE_ID)
             ORDER BY D.PRIORITY, PS.DATE_IN
              INTO :DRIVER_ID DO BEGIN

          SELECT COUNT(*)
            FROM ORDERS
           WHERE DRIVER_ID=:DRIVER_ID
             AND PARENT_ID IS NULL
             AND DATE_HISTORY IS NULL
             AND FINISHED<>1
            INTO :CNT;

          IF (CNT=0) THEN BEGIN
            RESULT_DRIVER_ID=DRIVER_ID;
            RESULT_PARK_ID=PARK_ID;
            BREAK;
          END

        END

      END

      IF (RESULT_DRIVER_ID IS NOT NULL) THEN BEGIN

        SELECT CAR_ID
          FROM DRIVERS
         WHERE DRIVER_ID=:RESULT_DRIVER_ID
          INTO :CAR_ID;

        IN AUTONOMOUS TRANSACTION DO BEGIN

          UPDATE ORDERS
             SET PARK_ID=:RESULT_PARK_ID,
                 DRIVER_ID=:RESULT_DRIVER_ID,
                 CAR_ID=:CAR_ID,
                 DATE_END=CURRENT_TIMESTAMP,
                 WHO_PROCESS_ID=:ACCOUNT_ID
           WHERE ORDER_ID=:ORDER_ID;

        END

        EXECUTE PROCEDURE EVENT_REFRESH_ORDERS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

      END ELSE BEGIN

      /*  EXECUTE PROCEDURE PR_MANUAL(ORDER_ID,ACCOUNT_ID); */

      END

    END ELSE BEGIN

      EXECUTE PROCEDURE PR_MANUAL(SESSION_ID,ORDER_ID,ACCOUNT_ID);

    END

  END

END

--

CREATE OR ALTER PROCEDURE PR_NO_FREE_CARS
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
BEGIN

  IN AUTONOMOUS TRANSACTION DO BEGIN

    UPDATE ORDERS
       SET FINISHED=1
     WHERE ORDER_ID=:ORDER_ID;

  END

  EXECUTE PROCEDURE EVENT_REFRESH_ORDERS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

END

--

CREATE OR ALTER PROCEDURE PR_NO_PARK
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE ZONE_ID VARCHAR(32);
DECLARE PARK_ID VARCHAR(32);
DECLARE DRIVER_ID VARCHAR(32);
DECLARE CNT INTEGER;
DECLARE RESULT_PARK_ID VARCHAR(32);
BEGIN

  SELECT ZONE_ID, DRIVER_ID
    FROM ORDERS
   WHERE ORDER_ID=:ORDER_ID
     INTO :ZONE_ID, :DRIVER_ID;

  IF (DRIVER_ID IS NULL) THEN BEGIN

    IF (ZONE_ID IS NOT NULL) THEN BEGIN

        RESULT_PARK_ID=NULL;

        FOR SELECT P.PARK_ID
              FROM ZONE_PARKS ZP
              JOIN PARKS P ON P.PARK_ID=ZP.PARK_ID
             WHERE ZP.ZONE_ID=:ZONE_ID
             ORDER BY ZP.DISTANCE, ZP.PERIOD
              INTO :PARK_ID DO BEGIN

          FOR SELECT DRIVER_ID
                FROM PARK_STATES
               WHERE PARK_ID=:PARK_ID
                 AND DATE_OUT IS NULL
                INTO :DRIVER_ID DO BEGIN

            SELECT COUNT(*)
              FROM ORDERS
             WHERE DRIVER_ID=:DRIVER_ID
               AND PARENT_ID IS NULL
               AND DATE_HISTORY IS NULL
               AND FINISHED<>1
              INTO :CNT;

            IF (CNT=0) THEN BEGIN
              RESULT_PARK_ID=PARK_ID;
              BREAK;
            END

          END

          IF (RESULT_PARK_ID IS NOT NULL) THEN
            BREAK;

        END

        IF (RESULT_PARK_ID IS NOT NULL) THEN BEGIN

          IN AUTONOMOUS TRANSACTION DO BEGIN

            UPDATE ORDERS
               SET PARK_ID=:RESULT_PARK_ID,
                   DATE_END=CURRENT_TIMESTAMP,
                   WHO_PROCESS_ID=:ACCOUNT_ID
             WHERE ORDER_ID=:ORDER_ID;

          END

          EXECUTE PROCEDURE EVENT_REFRESH_ORDERS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

        END ELSE BEGIN

          EXECUTE PROCEDURE PR_MANUAL(SESSION_ID,ORDER_ID,ACCOUNT_ID);

        END

    END ELSE BEGIN

      EXECUTE PROCEDURE PR_MANUAL(SESSION_ID,ORDER_ID,ACCOUNT_ID);

    END

  END

END

--

CREATE OR ALTER PROCEDURE PR_SEND_ORDER
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
BEGIN

  IN AUTONOMOUS TRANSACTION DO BEGIN

    UPDATE ORDERS
       SET DATE_BEGIN=CURRENT_TIMESTAMP
     WHERE ORDER_ID=:ORDER_ID;

  END

  EXECUTE PROCEDURE EVENT_REFRESH_ORDERS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

END

--

CREATE OR ALTER PROCEDURE EVENT_REFRESH_SHIFTS 
(
  APPLICATION_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  SESSION_ID VARCHAR(32),
  PROTOCOL INTEGER
)
AS
DECLARE TEMP INTEGER;
DECLARE SECTION VARCHAR(100);
BEGIN
  SECTION='S_DRIVER_SHIFTS';
  FOR SELECT SUCCESS
       FROM SEND_EVENT(0,0,:APPLICATION_ID,:ACCOUNT_ID,NULL,:SESSION_ID,:PROTOCOL,:SECTION,NULL)
       INTO :TEMP DO BEGIN
  END
END

--

CREATE OR ALTER PROCEDURE EVENT_REFRESH_PARK_STATES
(
  APPLICATION_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  SESSION_ID VARCHAR(32),
  PROTOCOL INTEGER
)
AS
DECLARE TEMP INTEGER;
DECLARE SECTION VARCHAR(100);
BEGIN
  SECTION='S_DRIVER_PARKS';
  FOR SELECT SUCCESS
       FROM SEND_EVENT(0,0,:APPLICATION_ID,:ACCOUNT_ID,NULL,:SESSION_ID,:PROTOCOL,:SECTION,NULL)
       INTO :TEMP DO BEGIN
  END
END

--

CREATE OR ALTER PROCEDURE CODE_PARK_IN
(
  SESSION_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  IN_MESSAGE_ID VARCHAR(32)
)
AS
DECLARE SENDER_ID VARCHAR(32);
DECLARE CODE VARCHAR(100);
DECLARE TYPE_MESSAGE INTEGER;
BEGIN
  SELECT IM.SENDER_ID, CM.CODE, IM.TYPE_MESSAGE
    FROM IN_MESSAGES IM
    LEFT JOIN CODE_MESSAGES CM ON CM.CODE_MESSAGE_ID=IM.CODE_MESSAGE_ID
   WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :SENDER_ID, :CODE, :TYPE_MESSAGE;

  IF ((SENDER_ID IS NOT NULL) AND (CODE IS NOT NULL)) THEN BEGIN

    EXECUTE PROCEDURE TRY_PARK_IN (SESSION_ID,NULL,ACCOUNT_ID,SENDER_ID,CODE,TYPE_MESSAGE);

  END
END

--

CREATE OR ALTER VIEW S_DRIVERS
(
    DRIVER_ID,
    CALC_ID,
    CAR_ID,
    PHONE_HOME,
    LICENSE,
    CATEGORIES,
    INSURANCE,
    HEALTH_CERT,
    ADDICT_CERT,
    PASSPORT,
    PLACE_BIRTH,
    DATE_BIRTH,
    ADDRESS_RESIDENCE,
    ADDRESS_ACTUAL,
    MIN_BALANCE,
    PRIORITY,
    METHOD_ID,
    DATE_PRIORITY,
    MIN_HOURS,
    DATE_SCHEDULE,
    PHONE,
    DESCRIPTION,
    USER_NAME,
    DATE_CREATE,
    LOCKED,
    SURNAME,
    NAME,
    PATRONYMIC,
    FIRM_ID,
    CAR_STATE_NUM,
    CAR_BRAND,
    CAR_COLOR,
    CAR_CALLSIGN,
    CALC_NAME,
    METHOD_NAME,
    FIRM_SMALL_NAME
)
AS
SELECT D.*,
       A.PHONE,
       A.DESCRIPTION,
       A.USER_NAME,
       A.DATE_CREATE,
       A.LOCKED,
       A.SURNAME,
       A.NAME,
       A.PATRONYMIC,
       A.FIRM_ID,
       CR.STATE_NUM AS CAR_STATE_NUM,
       CR.BRAND AS CAR_BRAND,
       CR.COLOR AS CAR_COLOR,
       CR.CALLSIGN AS CAR_CALLSIGN,
       CL.NAME AS CALC_NAME,
       M.NAME AS METHOD_NAME,
       F.SMALL_NAME AS FIRM_SMALL_NAME
  FROM DRIVERS D
  JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
  JOIN CARS CR ON CR.CAR_ID=D.CAR_ID
  LEFT JOIN CALCS CL ON CL.CALC_ID=D.CALC_ID
  LEFT JOIN METHODS M ON M.METHOD_ID=D.METHOD_ID
  LEFT JOIN FIRMS F ON F.FIRM_ID=A.FIRM_ID

--

CREATE OR ALTER PROCEDURE I_DRIVER
(
  DRIVER_ID VARCHAR(32),
  CALC_ID VARCHAR(32),
  CAR_ID VARCHAR(32),
  METHOD_ID VARCHAR(32),
  PHONE VARCHAR(100),
  PHONE_HOME VARCHAR(100),
  LICENSE VARCHAR(250),
  CATEGORIES VARCHAR(100),
  INSURANCE VARCHAR(250),
  HEALTH_CERT VARCHAR(250),
  DESCRIPTION VARCHAR(250),
  ADDICT_CERT VARCHAR(250),
  PASSPORT VARCHAR(250),
  PLACE_BIRTH VARCHAR(250),
  DATE_BIRTH DATE,
  ADDRESS_RESIDENCE VARCHAR(250),
  ADDRESS_ACTUAL VARCHAR(250),
  MIN_BALANCE NUMERIC(15,2),
  PRIORITY INTEGER,
  DATE_PRIORITY DATE,
  MIN_HOURS INTEGER,
  DATE_SCHEDULE DATE,
  DATE_CREATE TIMESTAMP,
  USER_NAME VARCHAR(100),
  LOCKED INTEGER,
  SURNAME VARCHAR(100),
  NAME VARCHAR(100),
  PATRONYMIC VARCHAR(100),
  FIRM_ID VARCHAR(32)
)
AS
  DECLARE ROLE_ID VARCHAR(32);
  DECLARE CNT INTEGER;
BEGIN

  SELECT COUNT(*)
    FROM ACCOUNTS A
   WHERE UPPER(A.USER_NAME)=UPPER(:USER_NAME)
    INTO :CNT;

  IF (CNT>0) THEN
    EXCEPTION E 'Логин уже существует';

  INSERT INTO ACCOUNTS (ACCOUNT_ID,FIRM_ID,DATE_CREATE,USER_NAME,LOCKED,SURNAME,NAME,PATRONYMIC,IS_ROLE,PHONE,DESCRIPTION)
                VALUES (:DRIVER_ID,:FIRM_ID,:DATE_CREATE,:USER_NAME,:LOCKED,:SURNAME,:NAME,:PATRONYMIC,0,:PHONE,:DESCRIPTION);

  INSERT INTO DRIVERS (DRIVER_ID,CALC_ID,CAR_ID,METHOD_ID,PHONE_HOME,LICENSE,
                       CATEGORIES,INSURANCE,HEALTH_CERT,ADDICT_CERT,
                       PASSPORT,PLACE_BIRTH,DATE_BIRTH,ADDRESS_RESIDENCE,ADDRESS_ACTUAL,
                       MIN_BALANCE,PRIORITY,DATE_PRIORITY,MIN_HOURS,DATE_SCHEDULE)
       VALUES (:DRIVER_ID,:CALC_ID,:CAR_ID,:METHOD_ID,:PHONE_HOME,:LICENSE,
               :CATEGORIES,:INSURANCE,:HEALTH_CERT,:ADDICT_CERT,
               :PASSPORT,:PLACE_BIRTH,:DATE_BIRTH,:ADDRESS_RESIDENCE,:ADDRESS_ACTUAL,
               :MIN_BALANCE,:PRIORITY,:DATE_PRIORITY,:MIN_HOURS,:DATE_SCHEDULE);

  ROLE_ID='3EBE04F48C07BAB246324FBA8551FEF1'; /* Водители */
  INSERT INTO ACCOUNT_ROLES (ROLE_ID,ACCOUNT_ID)
       VALUES (:ROLE_ID,:DRIVER_ID);
END

--

CREATE OR ALTER PROCEDURE U_DRIVER
(
  DRIVER_ID VARCHAR(32),
  CALC_ID VARCHAR(32),
  CAR_ID VARCHAR(32),
  METHOD_ID VARCHAR(32),
  PHONE VARCHAR(100),
  PHONE_HOME VARCHAR(100),
  LICENSE VARCHAR(250),
  CATEGORIES VARCHAR(100),
  INSURANCE VARCHAR(250),
  HEALTH_CERT VARCHAR(250),
  DESCRIPTION VARCHAR(250),
  ADDICT_CERT VARCHAR(250),
  PASSPORT VARCHAR(250),
  PLACE_BIRTH VARCHAR(250),
  DATE_BIRTH DATE,
  ADDRESS_RESIDENCE VARCHAR(250),
  ADDRESS_ACTUAL VARCHAR(250),
  MIN_BALANCE NUMERIC(15,2),
  PRIORITY INTEGER,
  DATE_PRIORITY DATE,
  MIN_HOURS INTEGER,
  DATE_SCHEDULE DATE,
  USER_NAME VARCHAR(100),
  LOCKED INTEGER,
  SURNAME VARCHAR(100),
  NAME VARCHAR(100),
  PATRONYMIC VARCHAR(100),
  FIRM_ID VARCHAR(32),
  OLD_DRIVER_ID VARCHAR(32)
)
AS
  DECLARE CNT INTEGER;
BEGIN

  SELECT COUNT(*)
    FROM ACCOUNTS A
   WHERE UPPER(A.USER_NAME)=UPPER(:USER_NAME)
     AND A.ACCOUNT_ID<>:DRIVER_ID
    INTO :CNT;

  IF (CNT>0) THEN
    EXCEPTION E 'Логин уже существует';

  UPDATE ACCOUNTS
     SET ACCOUNT_ID=:DRIVER_ID,
         FIRM_ID=:FIRM_ID,
         USER_NAME=:USER_NAME,
         LOCKED=:LOCKED,
         SURNAME=:SURNAME,
         NAME=:NAME,
         PATRONYMIC=:PATRONYMIC,
         IS_ROLE=0,
         PHONE=:PHONE,
         DESCRIPTION=:DESCRIPTION
   WHERE ACCOUNT_ID=:OLD_DRIVER_ID;

  UPDATE DRIVERS
     SET DRIVER_ID=:DRIVER_ID,
         CALC_ID=:CALC_ID,
         CAR_ID=:CAR_ID,
         METHOD_ID=:METHOD_ID,
         PHONE_HOME=:PHONE_HOME,
         LICENSE=:LICENSE,
         CATEGORIES=:CATEGORIES,
         INSURANCE=:INSURANCE,
         HEALTH_CERT=:HEALTH_CERT,
         ADDICT_CERT=:ADDICT_CERT,
         PASSPORT=:PASSPORT,
         PLACE_BIRTH=:PLACE_BIRTH,
         DATE_BIRTH=:DATE_BIRTH,
         ADDRESS_RESIDENCE=:ADDRESS_RESIDENCE,
         ADDRESS_ACTUAL=:ADDRESS_ACTUAL,
         MIN_BALANCE=:MIN_BALANCE,
         PRIORITY=:PRIORITY,
         DATE_PRIORITY=:DATE_PRIORITY,
         MIN_HOURS=:MIN_HOURS,
         DATE_SCHEDULE=:DATE_SCHEDULE
   WHERE DRIVER_ID=:OLD_DRIVER_ID;

END

--

CREATE OR ALTER VIEW S_DISPATCHERS
(
    DISPATCHER_ID,
    CALC_ID,
    PHONE_HOME,
    PASSPORT,
    PLACE_BIRTH,
    DATE_BIRTH,
    ADDRESS_RESIDENCE,
    ADDRESS_ACTUAL,
    PHONE,
    DESCRIPTION,
    USER_NAME,
    "PASSWORD",
    DATE_CREATE,
    LOCKED,
    SURNAME,
    NAME,
    PATRONYMIC,
    FIRM_ID,
    CALC_NAME,
    FIRM_SMALL_NAME
)
AS
SELECT D.*,
       A.PHONE,
       A.DESCRIPTION,
       A.USER_NAME,
       A."PASSWORD",
       A.DATE_CREATE,
       A.LOCKED,
       A.SURNAME,
       A.NAME,
       A.PATRONYMIC,
       A.FIRM_ID,
       CL.NAME AS CALC_NAME,
       F.SMALL_NAME AS FIRM_SMALL_NAME
  FROM DISPATCHERS D
  JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DISPATCHER_ID
  LEFT JOIN CALCS CL ON CL.CALC_ID=D.CALC_ID
  LEFT JOIN FIRMS F ON F.FIRM_ID=A.FIRM_ID

--

CREATE OR ALTER PROCEDURE I_DISPATCHER
(
  DISPATCHER_ID VARCHAR(32),
  CALC_ID VARCHAR(32),
  PHONE VARCHAR(100),
  PHONE_HOME VARCHAR(100),
  DESCRIPTION VARCHAR(250),
  PASSPORT VARCHAR(250),
  PLACE_BIRTH VARCHAR(250),
  DATE_BIRTH DATE,
  ADDRESS_RESIDENCE VARCHAR(250),
  ADDRESS_ACTUAL VARCHAR(250),
  USER_NAME VARCHAR(100),
  LOCKED INTEGER,
  SURNAME VARCHAR(100),
  NAME VARCHAR(100),
  PATRONYMIC VARCHAR(100),
  "PASSWORD"  VARCHAR(100),
  FIRM_ID VARCHAR(32)
)
AS
  DECLARE ROLE_ID VARCHAR(32);
BEGIN

  INSERT INTO ACCOUNTS(ACCOUNT_ID,FIRM_ID,DATE_CREATE,USER_NAME,LOCKED,SURNAME,NAME,PATRONYMIC,IS_ROLE,PHONE,DESCRIPTION,"PASSWORD")
               VALUES (:DISPATCHER_ID,:FIRM_ID,CURRENT_TIMESTAMP,:USER_NAME,:LOCKED,:SURNAME,:NAME,:PATRONYMIC,0,:PHONE,:DESCRIPTION,:"PASSWORD");

  INSERT INTO DISPATCHERS (DISPATCHER_ID,CALC_ID,PHONE_HOME,
                           PASSPORT,PLACE_BIRTH,DATE_BIRTH,
                           ADDRESS_RESIDENCE,ADDRESS_ACTUAL)
       VALUES (:DISPATCHER_ID,:CALC_ID,:PHONE_HOME,
               :PASSPORT,:PLACE_BIRTH,:DATE_BIRTH,
               :ADDRESS_RESIDENCE,:ADDRESS_ACTUAL);

  ROLE_ID='FF7F332564F795C8411BF28652B22BEA'; /* Диспетчеры */
  INSERT INTO ACCOUNT_ROLES (ROLE_ID,ACCOUNT_ID)
       VALUES (:ROLE_ID,:DISPATCHER_ID);

END

--

CREATE OR ALTER PROCEDURE U_DISPATCHER
(
  DISPATCHER_ID VARCHAR(32),
  CALC_ID VARCHAR(32),
  PHONE VARCHAR(100),
  PHONE_HOME VARCHAR(100),
  DESCRIPTION VARCHAR(250),
  PASSPORT VARCHAR(250),
  PLACE_BIRTH VARCHAR(250),
  DATE_BIRTH DATE,
  ADDRESS_RESIDENCE VARCHAR(250),
  ADDRESS_ACTUAL VARCHAR(250),
  USER_NAME VARCHAR(100),
  LOCKED INTEGER,
  SURNAME VARCHAR(100),
  NAME VARCHAR(100),
  PATRONYMIC VARCHAR(100),
  "PASSWORD"  VARCHAR(100),
  FIRM_ID VARCHAR(32),
  OLD_DISPATCHER_ID VARCHAR(32)
)
AS
BEGIN

  UPDATE ACCOUNTS
     SET ACCOUNT_ID=:DISPATCHER_ID,
         FIRM_ID=:FIRM_ID,
         USER_NAME=:USER_NAME,
         "PASSWORD"=:"PASSWORD",
         LOCKED=:LOCKED,
         SURNAME=:SURNAME,
         NAME=:NAME,
         PATRONYMIC=:PATRONYMIC,
         IS_ROLE=0,
         PHONE=:PHONE,
         DESCRIPTION=:DESCRIPTION
   WHERE ACCOUNT_ID=:OLD_DISPATCHER_ID;

  UPDATE DISPATCHERS
     SET DISPATCHER_ID=:DISPATCHER_ID,
         CALC_ID=:CALC_ID,
         PHONE_HOME=:PHONE_HOME,
         PASSPORT=:PASSPORT,
         PLACE_BIRTH=:PLACE_BIRTH,
         DATE_BIRTH=:DATE_BIRTH,
         ADDRESS_RESIDENCE=:ADDRESS_RESIDENCE,
         ADDRESS_ACTUAL=:ADDRESS_ACTUAL
   WHERE DISPATCHER_ID=:OLD_DISPATCHER_ID;

END

--

ALTER TABLE ORDERS
ADD FIRM_ID VARCHAR(32)

--

ALTER TABLE ORDERS
ADD FOREIGN KEY (FIRM_ID) REFERENCES FIRMS (FIRM_ID)

--

CREATE OR ALTER VIEW S_ORDERS
(
    ORDER_ID,
    ACTION_ID,
    RATE_ID,
    CAR_TYPE_ID,
    WHO_ACCEPT_ID,
    STREET_ID,
    ZONE_ID,
    PARENT_ID,
    CAR_ID,
    WHO_PROCESS_ID,
    WHO_HISTORY_ID,
    RESULT_ID,
    PARK_ID,
    SOURCE_ID,
    DISCOUNT_ID,
    DRIVER_ID,
    ORDER_NUM,
    PHONE,
    HOUSE,
    FLAT,
    PORCH,
    DATE_ACCEPT,
    DATE_ARRIVAL,
    DATE_BEGIN,
    DATE_END,
    CUSTOMER,
    DESCRIPTION,
    COST_RATE,
    COST_FACT,
    TYPE_ACCEPT,
    TYPE_PROCESS,
    DATE_HISTORY,
    BEFORE_PERIOD,
    FINISHED,
    LOCKED,
    CLIENT_ID,
    COST_GROSS,
    FIRM_ID,
    ACTION_NAME,
    ACTION_BRUSH_COLOR,
    ACTION_FONT_COLOR,
    ACTION_PERIOD,
    RATE_NAME,
    CAR_TYPE_NAME,
    WHO_ACCEPT,
    FIRM_SMALL_NAME,
    STREET_NAME,
    STREET_PREFIX,
    LOCALITY_ID,
    LOCALITY_NAME,
    LOCALITY_PREFIX,
    ZONE_NAME,
    PARENT_ORDER_NUM,
    CLIENT_USER_NAME,
    CLIENT_SURNAME,
    CLIENT_NAME,
    CLIENT_PATRONYMIC,
    CLIENT_FIRM_SMALL_NAME,
    CAR_BRAND,
    CAR_STATE_NUM,
    CAR_COLOR,
    CAR_CALLSIGN,
    WHO_PROCESS,
    WHO_HISTORY,
    RESULT_NAME,
    RESULT_BRUSH_COLOR,
    RESULT_FONT_COLOR,
    PARK_NAME,
    PARK_DESCRIPTION,
    SOURCE_NAME,
    DISCOUNT_NUM,
    DISCOUNT_TYPE_NAME,
    DRIVER_USER_NAME,
    DRIVER_SURNAME,
    DRIVER_NAME,
    DRIVER_PATRONYMIC,
    DRIVER_PHONE,
    STATUS,
    ROUTE_STREET_ID,
    ROUTE_STREET_NAME,
    ROUTE_STREET_PREFIX,
    ROUTE_LOCALITY_ID,
    ROUTE_LOCALITY_NAME,
    ROUTE_LOCALITY_PREFIX,
    ROUTE_HOUSE,
    ROUTE_FLAT,
    ROUTE_PORCH,
    ROUTE_ZONE_ID,
    ROUTE_ZONE_NAME
)
AS
SELECT O.*,
       A.NAME AS ACTION_NAME,
       A.BRUSH_COLOR AS ACTION_BRUSH_COLOR,
       A.FONT_COLOR AS ACTION_FONT_COLOR,
       A.PERIOD AS ACTION_PERIOD,
       R.NAME AS RATE_NAME,
       CT.NAME AS CAR_TYPE_NAME,
       A1.USER_NAME AS WHO_ACCEPT,
       F.SMALL_NAME AS FIRM_SMALL_NAME,
       S1.NAME AS STREET_NAME,
       S1.PREFIX AS STREET_PREFIX,
       L1.LOCALITY_ID,
       L1.NAME AS LOCALITY_NAME,
       L1.PREFIX AS LOCALITY_PREFIX,
       Z1.NAME AS ZONE_NAME,
       OP.ORDER_NUM AS PARENT_ORDER_NUM,
       A5.USER_NAME AS CLIENT_USER_NAME,
       A5.SURNAME AS CLIENT_SURNAME,
       A5.NAME AS CLIENT_NAME,
       A5.PATRONYMIC AS CLIENT_PATRONYMIC,
       F5.SMALL_NAME AS CLIENT_FIRM_SMALL_NAME,
       C.BRAND AS CAR_BRAND,
       C.STATE_NUM AS CAR_STATE_NUM,
       C.COLOR AS CAR_COLOR,
       C.CALLSIGN AS CAR_CALLSIGN,
       A2.USER_NAME AS WHO_PROCESS,
       A4.USER_NAME AS WHO_HISTORY,
       RT.NAME AS RESULT_NAME,
       RT.BRUSH_COLOR AS RESULT_BRUSH_COLOR,
       RT.FONT_COLOR AS RESULT_FONT_COLOR,
       P.NAME AS PARK_NAME,
       P.DESCRIPTION AS PARK_DESCRIPTION,
       S.NAME AS SOURCE_NAME,
       D.NUM AS DISCOUNT_NUM,
       DT.NAME AS DISCOUNT_TYPE_NAME,
       A3.USER_NAME AS DRIVER_USER_NAME,
       A3.SURNAME AS DRIVER_SURNAME,
       A3.NAME AS DRIVER_NAME,
       A3.PATRONYMIC AS DRIVER_PATRONYMIC,
       A3.PHONE AS DRIVER_PHONE,
       (CASE WHEN (O.FINISHED=0) AND (CURRENT_TIMESTAMP>=(O.DATE_ARRIVAL-(O.BEFORE_PERIOD*(1e0/24/60)))) THEN 0
             WHEN (O.FINISHED=0) AND (CURRENT_TIMESTAMP<(O.DATE_ARRIVAL-(O.BEFORE_PERIOD*(1e0/24/60)))) THEN 1
             WHEN O.FINISHED=1 THEN 2
        ELSE 0 END) AS STATUS,
       S2.STREET_ID AS ROUTE_STREET_ID,
       S2.NAME AS ROUTE_STREET_NAME,
       S2.PREFIX AS ROUTE_STREET_PREFIX,
       L2.LOCALITY_ID AS ROUTE_LOCALITY_ID,
       L2.NAME AS ROUTE_LOCALITY_NAME,
       L2.PREFIX AS ROUTE_LOCALITY_PREFIX,
       RO.HOUSE AS ROUTE_HOUSE,
       RO.FLAT AS ROUTE_FLAT,
       RO.PORCH AS ROUTE_PORCH,
       RO.ZONE_ID AS ROUTE_ZONE_ID,
       Z2.NAME AS ROUTE_ZONE_NAME

  FROM ORDERS O
  JOIN ACTIONS A ON A.ACTION_ID=O.ACTION_ID
  JOIN RATES R ON R.RATE_ID=O.RATE_ID
  JOIN CAR_TYPES CT ON CT.CAR_TYPE_ID=O.CAR_TYPE_ID
  JOIN ACCOUNTS A1 ON A1.ACCOUNT_ID=O.WHO_ACCEPT_ID
  LEFT JOIN FIRMS F ON F.FIRM_ID=O.FIRM_ID
  LEFT JOIN STREETS S1 ON S1.STREET_ID=O.STREET_ID
  LEFT JOIN LOCALITIES L1 ON L1.LOCALITY_ID=S1.LOCALITY_ID
  LEFT JOIN ZONES Z1 ON Z1.ZONE_ID=O.ZONE_ID
  LEFT JOIN ORDERS OP ON OP.ORDER_ID=O.PARENT_ID
  LEFT JOIN CLIENTS CL ON CL.CLIENT_ID=O.CLIENT_ID
  LEFT JOIN ACCOUNTS A5 ON A5.ACCOUNT_ID=CL.CLIENT_ID
  LEFT JOIN FIRMS F5 ON F5.FIRM_ID=A5.FIRM_ID
  LEFT JOIN CARS C ON C.CAR_ID=O.CAR_ID
  LEFT JOIN ACCOUNTS A2 ON A2.ACCOUNT_ID=O.WHO_PROCESS_ID
  LEFT JOIN ACCOUNTS A4 ON A4.ACCOUNT_ID=O.WHO_HISTORY_ID
  LEFT JOIN RESULTS RT ON RT.RESULT_ID=O.RESULT_ID
  LEFT JOIN PARKS P ON P.PARK_ID=O.PARK_ID
  LEFT JOIN SOURCES S ON S.SOURCE_ID=O.SOURCE_ID
  LEFT JOIN DISCOUNTS D ON D.DISCOUNT_ID=O.DISCOUNT_ID
  LEFT JOIN DISCOUNT_TYPES DT ON DT.DISCOUNT_TYPE_ID=D.DISCOUNT_TYPE_ID
  LEFT JOIN DRIVERS DR ON DR.DRIVER_ID=O.DRIVER_ID
  LEFT JOIN ACCOUNTS A3 ON A3.ACCOUNT_ID=DR.DRIVER_ID
  LEFT JOIN ROUTES RO ON RO.ORDER_ID=O.ORDER_ID AND 
                         RO.PRIORITY=(SELECT MAX(PRIORITY)
                                        FROM ROUTES
                                       WHERE ORDER_ID=O.ORDER_ID)
  LEFT JOIN STREETS S2 ON S2.STREET_ID=RO.STREET_ID
  LEFT JOIN LOCALITIES L2 ON L2.LOCALITY_ID=S2.LOCALITY_ID
  LEFT JOIN ZONES Z2 ON Z2.ZONE_ID=RO.ZONE_ID

--

CREATE OR ALTER PROCEDURE CREATE_ORDER_HISTORY
(
  SESSION_ID VARCHAR(32),
  OLD_ORDER_ID VARCHAR(32),
  NEW_ORDER_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  ACTION_ID VARCHAR(32),
  RESULT_ID VARCHAR(32),
  TYPE_PROCESS INTEGER,
  DATE_BEGIN TIMESTAMP,
  WITH_DEPENDS INTEGER
)
AS
BEGIN

  IN AUTONOMOUS TRANSACTION DO BEGIN

    INSERT INTO ORDERS (ORDER_ID,PARENT_ID,ACTION_ID,RATE_ID,CAR_TYPE_ID,
                        WHO_ACCEPT_ID,STREET_ID,ZONE_ID,CAR_ID,
                        WHO_PROCESS_ID,RESULT_ID,PARK_ID,SOURCE_ID,DISCOUNT_ID,
                        DRIVER_ID,ORDER_NUM,PHONE,HOUSE,FLAT,PORCH,
                        DATE_ACCEPT,DATE_ARRIVAL,DATE_BEGIN,DATE_END,CUSTOMER,
                        DESCRIPTION,COST_RATE,COST_FACT,TYPE_ACCEPT,
                        TYPE_PROCESS,DATE_HISTORY,WHO_HISTORY_ID,BEFORE_PERIOD,
                        FINISHED,LOCKED,CLIENT_ID,COST_GROSS,FIRM_ID)
    SELECT :NEW_ORDER_ID,NULL,:ACTION_ID,RATE_ID,CAR_TYPE_ID,
           WHO_ACCEPT_ID,STREET_ID,ZONE_ID,CAR_ID,
           NULL,:RESULT_ID,PARK_ID,SOURCE_ID,DISCOUNT_ID,
           DRIVER_ID,ORDER_NUM,PHONE,HOUSE,FLAT,PORCH,
           DATE_ACCEPT,DATE_ARRIVAL,:DATE_BEGIN,NULL,CUSTOMER,
           DESCRIPTION,COST_RATE,COST_FACT,TYPE_ACCEPT,
           :TYPE_PROCESS,NULL,NULL,BEFORE_PERIOD,FINISHED,LOCKED,CLIENT_ID,COST_GROSS,FIRM_ID
      FROM ORDERS
     WHERE ORDER_ID=:OLD_ORDER_ID;

    IF (WITH_DEPENDS IS NOT NULL) THEN BEGIN

      INSERT INTO ROUTES (ROUTE_ID,ORDER_ID,ZONE_ID,STREET_ID,HOUSE,
                          FLAT,PORCH,DISTANCE,COST,PERIOD,AMOUNT,PRIORITY)
      SELECT GET_UNIQUE_ID(),:NEW_ORDER_ID,ZONE_ID,STREET_ID,HOUSE,
             FLAT,PORCH,DISTANCE,COST,PERIOD,AMOUNT,PRIORITY
        FROM ROUTES
       WHERE ORDER_ID=:OLD_ORDER_ID;


      INSERT INTO ORDER_SERVICES (ORDER_ID,SERVICE_ID,COST,
                                  DESCRIPTION,AMOUNT,PRIORITY)
      SELECT :NEW_ORDER_ID,SERVICE_ID,COST,
             DESCRIPTION,AMOUNT,PRIORITY
        FROM ORDER_SERVICES
       WHERE ORDER_ID=:OLD_ORDER_ID;

    END

    UPDATE ORDERS
       SET PARENT_ID=:NEW_ORDER_ID,
           DATE_HISTORY=CURRENT_TIMESTAMP,
           WHO_HISTORY_ID=:ACCOUNT_ID
     WHERE ORDER_ID=:OLD_ORDER_ID;

    UPDATE ORDERS
       SET PARENT_ID=:NEW_ORDER_ID
     WHERE PARENT_ID=:OLD_ORDER_ID;

    UPDATE IN_MESSAGES
       SET ORDER_ID=:NEW_ORDER_ID
     WHERE ORDER_ID=:OLD_ORDER_ID;

    UPDATE OUT_MESSAGES
       SET ORDER_ID=:NEW_ORDER_ID
     WHERE ORDER_ID=:OLD_ORDER_ID;

  END

  EXECUTE PROCEDURE EVENT_REFRESH_ORDERS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

END

--

CREATE OR ALTER PROCEDURE I_ORDER
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACTION_ID VARCHAR(32),
  RATE_ID VARCHAR(32),
  CAR_TYPE_ID VARCHAR(32),
  WHO_ACCEPT_ID VARCHAR(32),
  STREET_ID VARCHAR(32),
  ZONE_ID VARCHAR(32),
  PARENT_ID VARCHAR(32),
  CAR_ID VARCHAR(32),
  WHO_PROCESS_ID VARCHAR(32),
  RESULT_ID VARCHAR(32),
  PARK_ID VARCHAR(32),
  SOURCE_ID VARCHAR(32),
  DISCOUNT_ID VARCHAR(32),
  DRIVER_ID VARCHAR(32),
  ORDER_NUM VARCHAR(10),
  PHONE VARCHAR(100),
  HOUSE VARCHAR(10),
  FLAT VARCHAR(10),
  PORCH VARCHAR(10),
  DATE_ACCEPT TIMESTAMP,
  DATE_ARRIVAL TIMESTAMP,
  DATE_BEGIN TIMESTAMP,
  DATE_END TIMESTAMP,
  CUSTOMER VARCHAR(250),
  DESCRIPTION VARCHAR(250),
  COST_RATE NUMERIC(15,2),
  COST_FACT NUMERIC(15,2),
  TYPE_ACCEPT INTEGER,
  TYPE_PROCESS INTEGER,
  DATE_HISTORY TIMESTAMP,
  WHO_HISTORY_ID VARCHAR(32),
  BEFORE_PERIOD INTEGER,
  FINISHED INTEGER,
  LOCKED VARCHAR(32),
  CLIENT_ID VARCHAR(32),
  COST_GROSS NUMERIC(15,2),
  FIRM_ID VARCHAR(32)
)
AS
BEGIN

  IN AUTONOMOUS TRANSACTION DO BEGIN

    INSERT INTO ORDERS (ORDER_ID,ACTION_ID,RATE_ID,CAR_TYPE_ID,WHO_ACCEPT_ID,
                        STREET_ID,ZONE_ID,PARENT_ID,
                        CAR_ID,WHO_PROCESS_ID,RESULT_ID,PARK_ID,
                        SOURCE_ID,DISCOUNT_ID,DRIVER_ID,ORDER_NUM,PHONE,
                        HOUSE,FLAT,PORCH,
                        DATE_ACCEPT,DATE_ARRIVAL,DATE_BEGIN,DATE_END,CUSTOMER,
                        DESCRIPTION,COST_RATE,COST_FACT,TYPE_ACCEPT,
                        TYPE_PROCESS,DATE_HISTORY,WHO_HISTORY_ID,BEFORE_PERIOD,
                        FINISHED,LOCKED,CLIENT_ID,COST_GROSS,FIRM_ID)
                 VALUES (:ORDER_ID,:ACTION_ID,:RATE_ID,:CAR_TYPE_ID,:WHO_ACCEPT_ID,
                         :STREET_ID,:ZONE_ID,:PARENT_ID,
                         :CAR_ID,:WHO_PROCESS_ID,:RESULT_ID,:PARK_ID,
                         :SOURCE_ID,:DISCOUNT_ID,:DRIVER_ID,:ORDER_NUM,:PHONE,
                         :HOUSE,:FLAT,:PORCH,
                         :DATE_ACCEPT,:DATE_ARRIVAL,:DATE_BEGIN,:DATE_END,:CUSTOMER,
                         :DESCRIPTION,:COST_RATE,:COST_FACT,:TYPE_ACCEPT,
                         :TYPE_PROCESS,:DATE_HISTORY,:WHO_HISTORY_ID,:BEFORE_PERIOD,
                         :FINISHED,:LOCKED,:CLIENT_ID,:COST_GROSS,:FIRM_ID);
  END

  EXECUTE PROCEDURE EVENT_REFRESH_ORDERS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

END

--

ALTER TABLE CHARGES
ADD ORDER_ID VARCHAR(32)

--

ALTER TABLE CHARGES
ADD FOREIGN KEY (ORDER_ID) REFERENCES ORDERS (ORDER_ID)

--

ALTER TABLE CHARGES
ADD FIRM_ID VARCHAR(32)

--

ALTER TABLE CHARGES
ADD FOREIGN KEY (FIRM_ID) REFERENCES FIRMS (FIRM_ID)

--

CREATE OR ALTER VIEW S_CHARGES
(
    CHARGE_ID,
    CHARGE_TYPE_ID,
    ACCOUNT_ID,
    WHO_CREATE_ID,
    SUM_CHARGE,
    DATE_CHARGE,
    DATE_CREATE,
    DESCRIPTION,
    ORDER_ID,
    FIRM_ID,
    CHARGE_TYPE_NAME,
    USER_NAME,
    SURNAME,
    NAME,
    PATRONYMIC,
    WHO_USER_NAME,
    FIRM_SMALL_NAME
)
AS
SELECT C.*,
       CT.NAME AS CHARGE_TYPE_NAME,
       A1.USER_NAME,
       A1.SURNAME,
       A1.NAME,
       A1.PATRONYMIC,
       A2.USER_NAME AS WHO_USER_NAME,
       F.SMALL_NAME AS FIRM_SMALL_NAME
  FROM CHARGES C
  JOIN CHARGE_TYPES CT ON CT.CHARGE_TYPE_ID=C.CHARGE_TYPE_ID
  JOIN ACCOUNTS A1 ON A1.ACCOUNT_ID=C.ACCOUNT_ID
  JOIN ACCOUNTS A2 ON A2.ACCOUNT_ID=C.WHO_CREATE_ID
  LEFT JOIN FIRMS F ON F.FIRM_ID=C.FIRM_ID

--

CREATE OR ALTER PROCEDURE I_CHARGE
(
  CHARGE_ID VARCHAR(32),
  CHARGE_TYPE_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  WHO_CREATE_ID VARCHAR(32),
  SUM_CHARGE NUMERIC(15,2),
  DATE_CHARGE TIMESTAMP,
  DATE_CREATE TIMESTAMP,
  DESCRIPTION VARCHAR(250),
  ORDER_ID VARCHAR(32),
  FIRM_ID VARCHAR(32)
)
AS
BEGIN
  INSERT INTO CHARGES (CHARGE_ID,CHARGE_TYPE_ID,ACCOUNT_ID,WHO_CREATE_ID,
                       SUM_CHARGE,DATE_CHARGE,DATE_CREATE,DESCRIPTION,ORDER_ID,FIRM_ID)
       VALUES (:CHARGE_ID,:CHARGE_TYPE_ID,:ACCOUNT_ID,:WHO_CREATE_ID,
               :SUM_CHARGE,:DATE_CHARGE,:DATE_CREATE,:DESCRIPTION,:ORDER_ID,:FIRM_ID);
END

--

CREATE OR ALTER PROCEDURE U_CHARGE
(
  CHARGE_ID VARCHAR(32),
  CHARGE_TYPE_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  WHO_CREATE_ID VARCHAR(32),
  SUM_CHARGE NUMERIC(15,2),
  DATE_CHARGE TIMESTAMP,
  DATE_CREATE TIMESTAMP,
  DESCRIPTION VARCHAR(250),
  ORDER_ID VARCHAR(32),
  FIRM_ID VARCHAR(32),
  OLD_CHARGE_ID VARCHAR(32)
)
AS
BEGIN
  UPDATE CHARGES
     SET CHARGE_ID=:CHARGE_ID,
         CHARGE_TYPE_ID=:CHARGE_TYPE_ID,
         ACCOUNT_ID=:ACCOUNT_ID,
         WHO_CREATE_ID=:WHO_CREATE_ID,
         SUM_CHARGE=:SUM_CHARGE,
         DATE_CHARGE=:DATE_CHARGE,
         DATE_CREATE=:DATE_CREATE,
         DESCRIPTION=:DESCRIPTION,
         ORDER_ID=:ORDER_ID,
         FIRM_ID=:FIRM_ID
   WHERE CHARGE_ID=:OLD_CHARGE_ID;
END

--

ALTER TABLE RECEIPTS
ADD ORDER_ID VARCHAR(32)

--

ALTER TABLE RECEIPTS
ADD FOREIGN KEY (ORDER_ID) REFERENCES ORDERS (ORDER_ID)

--

ALTER TABLE RECEIPTS
ADD FIRM_ID VARCHAR(32)

--

ALTER TABLE RECEIPTS
ADD FOREIGN KEY (FIRM_ID) REFERENCES FIRMS (FIRM_ID)

--

CREATE OR ALTER VIEW S_RECEIPTS
(
    RECEIPT_ID,
    RECEIPT_TYPE_ID,
    ACCOUNT_ID,
    WHO_CREATE_ID,
    SUM_RECEIPT,
    DATE_RECEIPT,
    DATE_CREATE,
    DESCRIPTION,
    FIRM_ID,
    ORDER_ID,
    RECEIPT_TYPE_NAME,
    USER_NAME,
    SURNAME,
    NAME,
    PATRONYMIC,
    WHO_USER_NAME,
    FIRM_SMALL_NAME
)
AS
SELECT R.*,
       RT.NAME AS RECEIPT_TYPE_NAME,
       A1.USER_NAME,
       A1.SURNAME,
       A1.NAME,
       A1.PATRONYMIC,
       A2.USER_NAME AS WHO_USER_NAME,
       F.SMALL_NAME AS FIRM_SMALL_NAME
  FROM RECEIPTS R
  JOIN RECEIPT_TYPES RT ON RT.RECEIPT_TYPE_ID=R.RECEIPT_TYPE_ID
  JOIN ACCOUNTS A1 ON A1.ACCOUNT_ID=R.ACCOUNT_ID
  JOIN ACCOUNTS A2 ON A2.ACCOUNT_ID=R.WHO_CREATE_ID
  LEFT JOIN FIRMS F ON F.FIRM_ID=R.FIRM_ID

--

CREATE OR ALTER PROCEDURE U_RECEIPT
(
  RECEIPT_ID VARCHAR(32),
  RECEIPT_TYPE_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  WHO_CREATE_ID VARCHAR(32),
  SUM_RECEIPT NUMERIC(15,2),
  DATE_RECEIPT TIMESTAMP,
  DATE_CREATE TIMESTAMP,
  DESCRIPTION VARCHAR(250),
  ORDER_ID VARCHAR(32),
  FIRM_ID VARCHAR(32),
  OLD_RECEIPT_ID VARCHAR(32)
)
AS
BEGIN
  UPDATE RECEIPTS
     SET RECEIPT_ID=:RECEIPT_ID,
         RECEIPT_TYPE_ID=:RECEIPT_TYPE_ID,
         ACCOUNT_ID=:ACCOUNT_ID,
         WHO_CREATE_ID=:WHO_CREATE_ID,
         SUM_RECEIPT=:SUM_RECEIPT,
         DATE_RECEIPT=:DATE_RECEIPT,
         DATE_CREATE=:DATE_CREATE,
         DESCRIPTION=:DESCRIPTION,
         ORDER_ID=:ORDER_ID,
         FIRM_ID=:FIRM_ID
   WHERE RECEIPT_ID=:OLD_RECEIPT_ID;
END

--

CREATE OR ALTER PROCEDURE EXCHANGE_AFTER
(
  MONTH_COUNT INTEGER,
  MODE INTEGER
)
AS
DECLARE VARIABLE DATE_TO TIMESTAMP;
BEGIN

  SELECT DATE_TO
    FROM GET_DATE_TO(:MONTH_COUNT)
    INTO :DATE_TO;

  IF (MODE=1) THEN BEGIN

    DELETE FROM RECEIPTS
          WHERE DATE_RECEIPT<:DATE_TO;

    DELETE FROM CHARGES
          WHERE DATE_CHARGE<:DATE_TO;

  END ELSE BEGIN

    DELETE FROM PARK_STATES
          WHERE DATE_IN<:DATE_TO;

    DELETE FROM SHIFTS
          WHERE DATE_BEGIN<:DATE_TO;

    DELETE FROM OUT_MESSAGES
          WHERE DATE_CREATE<:DATE_TO;

    DELETE FROM IN_MESSAGES
          WHERE DATE_SEND<:DATE_TO;

    DELETE FROM ROUTES
          WHERE ORDER_ID IN (SELECT ORDER_ID FROM ORDERS
                              WHERE DATE_ACCEPT<:DATE_TO);

    DELETE FROM ORDER_SERVICES
          WHERE ORDER_ID IN (SELECT ORDER_ID FROM ORDERS
                              WHERE DATE_ACCEPT<:DATE_TO);

    DELETE FROM ORDERS
          WHERE DATE_ACCEPT<:DATE_TO
            AND PARENT_ID IS NOT NULL
            AND ORDER_ID NOT IN (SELECT ORDER_ID FROM OUT_MESSAGES)
            AND ORDER_ID NOT IN (SELECT ORDER_ID FROM IN_MESSAGES)
            AND ORDER_ID NOT IN (SELECT ORDER_ID FROM CHARGES)
            AND ORDER_ID NOT IN (SELECT ORDER_ID FROM RECEIPTS);


    DELETE FROM ORDERS
          WHERE DATE_ACCEPT<:DATE_TO
            AND PARENT_ID IS NULL
            AND ORDER_ID NOT IN (SELECT ORDER_ID FROM OUT_MESSAGES)
            AND ORDER_ID NOT IN (SELECT ORDER_ID FROM IN_MESSAGES)
            AND ORDER_ID NOT IN (SELECT ORDER_ID FROM CHARGES)
            AND ORDER_ID NOT IN (SELECT ORDER_ID FROM RECEIPTS);

  END

END

--

ALTER TABLE OUT_MESSAGES
ADD FIRM_ID VARCHAR(32)

--

ALTER TABLE OUT_MESSAGES
ADD FOREIGN KEY (FIRM_ID) REFERENCES FIRMS (FIRM_ID)

--

CREATE OR ALTER VIEW S_OUT_MESSAGES
(
    OUT_MESSAGE_ID,
    CREATOR_ID,
    RECIPIENT_ID,
    DATE_CREATE,
    TEXT_OUT,
    DATE_OUT,
    TYPE_MESSAGE,
    CONTACT,
    DESCRIPTION,
    PRIORITY,
    LOCKED,
    DATE_BEGIN,
    DATE_END,
    ORDER_ID,
    CHANNEL,
    DELIVERY,
    DATE_DELIVERY,
    FLASH,
    DEST_PORT,
    FIRM_ID,
    CREATOR_NAME,
    RECIPIENT_USER_NAME,
    RECIPIENT_SURNAME,
    RECIPIENT_NAME,
    RECIPIENT_PATRONYMIC,
    RECIPIENT_PHONE,
    RECIPIENT_EMAIL,
    FIRM_SMALL_NAME
)
AS
SELECT OM.*,
       A1.USER_NAME AS CREATOR_NAME,
       A2.USER_NAME AS RECIPIENT_USER_NAME,
       A2.SURNAME AS RECIPIENT_SURNAME,
       A2.NAME AS RECIPIENT_NAME,
       A2.PATRONYMIC AS RECIPIENT_PATRONYMIC,
       A2.PHONE AS RECIPIENT_PHONE,
       A2.EMAIL AS RECIPIENT_EMAIL,
       F.SMALL_NAME AS FIRM_SMALL_NAME
  FROM OUT_MESSAGES OM
  JOIN ACCOUNTS A1 ON A1.ACCOUNT_ID=OM.CREATOR_ID
  LEFT JOIN ACCOUNTS A2 ON A2.ACCOUNT_ID=OM.RECIPIENT_ID
  LEFT JOIN FIRMS F ON F.FIRM_ID=OM.FIRM_ID

--

CREATE OR ALTER VIEW S_DRIVER_OUT_MESSAGES
(
    OUT_MESSAGE_ID,
    CREATOR_ID,
    RECIPIENT_ID,
    DATE_CREATE,
    TEXT_OUT,
    DATE_OUT,
    TYPE_MESSAGE,
    CONTACT,
    DESCRIPTION,
    PRIORITY,
    LOCKED,
    DATE_BEGIN,
    DATE_END,
    ORDER_ID,
    CHANNEL,
    DELIVERY,
    DATE_DELIVERY,
    FLASH,
    DEST_PORT,
    FIRM_ID,
    CREATOR_NAME,
    RECIPIENT_USER_NAME,
    RECIPIENT_SURNAME,
    RECIPIENT_NAME,
    RECIPIENT_PATRONYMIC,
    RECIPIENT_PHONE,
    RECIPIENT_EMAIL,
    CAR_STATE_NUM,
    CAR_BRAND,
    CAR_COLOR,
    CAR_CALLSIGN,
    FIRM_SMALL_NAME
)
AS
SELECT OM.*,
       A1.USER_NAME AS CREATOR_NAME,
       A2.USER_NAME AS RECIPIENT_USER_NAME,
       A2.SURNAME AS RECIPIENT_SURNAME,
       A2.NAME AS RECIPIENT_NAME,
       A2.PATRONYMIC AS RECIPIENT_PATRONYMIC,
       A2.PHONE AS RECIPIENT_PHONE,
       A2.EMAIL AS RECIPIENT_EMAIL,
       CR.STATE_NUM AS CAR_STATE_NUM,
       CR.BRAND AS CAR_BRAND,
       CR.COLOR AS CAR_COLOR,
       CR.CALLSIGN AS CAR_CALLSIGN,
       F.SMALL_NAME AS FIRM_SMALL_NAME
  FROM OUT_MESSAGES OM
  JOIN DRIVERS D ON D.DRIVER_ID=OM.RECIPIENT_ID
  JOIN CARS CR ON CR.CAR_ID=D.CAR_ID
  JOIN ACCOUNTS A1 ON A1.ACCOUNT_ID=OM.CREATOR_ID
  LEFT JOIN ACCOUNTS A2 ON A2.ACCOUNT_ID=OM.RECIPIENT_ID
  LEFT JOIN FIRMS F ON F.FIRM_ID=OM.FIRM_ID

--

CREATE OR ALTER PROCEDURE CODE_CLIENT_BALANCE
(
  ACCOUNT_ID VARCHAR(32),
  IN_MESSAGE_ID VARCHAR(32)
)
AS
DECLARE CONTACT VARCHAR(100);
DECLARE SENDER_ID VARCHAR(32);
DECLARE S VARCHAR(70);
DECLARE SUM_CHARGE NUMERIC(15,2);
DECLARE SUM_RECEIPT NUMERIC(15,2);
DECLARE BALANCE NUMERIC(15,2);
DECLARE CNT INTEGER;
DECLARE CHARGE_TYPE_ID VARCHAR(32);
DECLARE CONST_VALUE VARCHAR(4000);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN
  SELECT CONTACT, SENDER_ID, TYPE_MESSAGE
    FROM IN_MESSAGES
   WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, :TYPE_MESSAGE;

  IF ((CONTACT IS NOT NULL) AND (SENDER_ID IS NOT NULL)) THEN BEGIN

    EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:SENDER_ID)
     RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

    SELECT COUNT(*)
      FROM CLIENTS C
      JOIN ACCOUNTS A ON A.ACCOUNT_ID=C.CLIENT_ID
     WHERE C.CLIENT_ID=:SENDER_ID
       AND A.LOCKED<>1
      INTO :CNT;

    IF (CNT>0) THEN BEGIN

      SELECT CONST_VALUE FROM GET_CONST_VALUE('2031AA8F2E4B959248967F2838DC5F19') INTO :S;

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE)
       RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

      IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        S=REPLACE_STRING(S,'%BALANCE',CAST(BALANCE AS VARCHAR(30)));

        FIRM_ID=NULL; /* Не понятно чьё сообщение */

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                  LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                  :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                  NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
      END

    END

  END
END

--

CREATE OR ALTER PROCEDURE CODE_DRIVER_BALANCE
(
  ACCOUNT_ID VARCHAR(32),
  IN_MESSAGE_ID VARCHAR(32)
)
AS
DECLARE CONTACT VARCHAR(100);
DECLARE SENDER_ID VARCHAR(32);
DECLARE S VARCHAR(70);
DECLARE SUM_CHARGE NUMERIC(15,2);
DECLARE SUM_RECEIPT NUMERIC(15,2);
DECLARE BALANCE NUMERIC(15,2);
DECLARE CNT INTEGER;
DECLARE CHARGE_TYPE_ID VARCHAR(32);
DECLARE CONST_VALUE VARCHAR(4000);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN
  SELECT IM.CONTACT, IM.SENDER_ID, IM.TYPE_MESSAGE, A.FIRM_ID
    FROM IN_MESSAGES IM
    LEFT JOIN ACCOUNTS A ON A.ACCOUNT_ID=IM.SENDER_ID
   WHERE IM.IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, :TYPE_MESSAGE, :FIRM_ID;

  IF ((CONTACT IS NOT NULL) AND (SENDER_ID IS NOT NULL)) THEN BEGIN

    EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:SENDER_ID)
     RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

    SELECT COUNT(*)
      FROM DRIVERS D
      JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
     WHERE D.DRIVER_ID=:SENDER_ID
       AND A.LOCKED<>1
      INTO :CNT;

    IF (CNT>0) THEN BEGIN

      SELECT CONST_VALUE FROM GET_CONST_VALUE('2031AA8F2E4B959248967F2838DC5F19') INTO :S;

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE)
       RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

      IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        S=REPLACE_STRING(S,'%BALANCE',CAST(BALANCE AS VARCHAR(30)));

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                  LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                  :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                  NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
      END

    END

  END
END

--

CREATE OR ALTER PROCEDURE CODE_FREE_ORDERS
(
  ACCOUNT_ID VARCHAR(32),
  IN_MESSAGE_ID VARCHAR(32)
)
AS
DECLARE CONTACT VARCHAR(100);
DECLARE SENDER_ID VARCHAR(32);
DECLARE ZONE_ID VARCHAR(32);
DECLARE S VARCHAR(1000);
DECLARE S1 VARCHAR(1000);
DECLARE F VARCHAR(1000);
DECLARE PARK_ID VARCHAR(32);
DECLARE PARK_NAME VARCHAR(100);
DECLARE SUM_CHARGE NUMERIC(15,2);
DECLARE SUM_RECEIPT NUMERIC(15,2);
DECLARE BALANCE NUMERIC(15,2);
DECLARE MIN_BALANCE NUMERIC(15,2);
DECLARE DRIVER_COUNT INTEGER;
DECLARE ORDER_COUNT INTEGER;
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN
  SELECT IM.CONTACT, IM.SENDER_ID, IM.TYPE_MESSAGE, A.FIRM_ID
    FROM IN_MESSAGES IM
    LEFT JOIN ACCOUNTS A ON A.ACCOUNT_ID=IM.SENDER_ID
   WHERE IM.IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, :TYPE_MESSAGE, :FIRM_ID;

  IF ((CONTACT IS NOT NULL) AND (SENDER_ID IS NOT NULL)) THEN BEGIN

    SELECT COUNT(*)
      FROM DRIVERS D
      JOIN  ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
     WHERE D.DRIVER_ID=:SENDER_ID
       AND A.LOCKED<>1
      INTO :DRIVER_COUNT;

    IF (DRIVER_COUNT>0) THEN BEGIN

      EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:SENDER_ID)
       RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

      SELECT MIN_BALANCE
        FROM DRIVERS
       WHERE DRIVER_ID=:SENDER_ID
        INTO :MIN_BALANCE;

      IF ((MIN_BALANCE IS NULL) OR ((MIN_BALANCE IS NOT NULL) AND (BALANCE>MIN_BALANCE))) THEN BEGIN
 
        S='';

        SELECT CONST_VALUE FROM GET_CONST_VALUE('C34718E32AF1B4264975480EE24B7A8D') INTO :F;

        IF (F IS NOT NULL) THEN BEGIN

          FOR SELECT ZONE_ID
                FROM ZONES
               ORDER BY PRIORITY
                INTO :ZONE_ID DO BEGIN

            PARK_NAME=NULL;

            FOR SELECT ZP.PARK_ID, P.NAME
                  FROM ZONE_PARKS ZP
                  JOIN PARKS P ON P.PARK_ID=ZP.PARK_ID
                 WHERE ZP.ZONE_ID=:ZONE_ID
                 ORDER BY ZP.DISTANCE, ZP.PERIOD
                  INTO :PARK_ID, :PARK_NAME DO BEGIN
              BREAK;
            END

            IF (PARK_ID IS NOT NULL) THEN BEGIN

              SELECT COUNT(*)
               FROM PARK_STATES
              WHERE DATE_OUT IS NULL
                AND PARK_ID=:PARK_ID
               INTO :DRIVER_COUNT;

              IF (PARK_NAME IS NOT NULL) THEN BEGIN

                SELECT COUNT(*)
                  FROM ORDERS
                 WHERE ZONE_ID=:ZONE_ID
                   AND PARENT_ID IS NULL
                   AND FINISHED=0
                   AND CURRENT_TIMESTAMP>=(DATE_ARRIVAL-(BEFORE_PERIOD*(1e0/24/60)))
                   AND DRIVER_ID IS NULL
                  INTO :ORDER_COUNT;

                IF (ORDER_COUNT>DRIVER_COUNT) THEN BEGIN

                  ORDER_COUNT=ORDER_COUNT-DRIVER_COUNT;

                  S1=F;
                  S1=REPLACE_STRING(S1,'%PARK_NAME',PARK_NAME);
                  S1=REPLACE_STRING(S1,'%COUNT',CAST(ORDER_COUNT AS VARCHAR(10)));

                  S=S||S1;
                END

              END

            END

          END

          IF (S='') THEN BEGIN

            S=NULL;

            SELECT CONST_VALUE FROM GET_CONST_VALUE('015792E550DCA1544E8E5F0773FEBA3D') INTO :S;

          END

          EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE)
           RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

          IF ((S IS NOT NULL) AND (S<>'') AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

            INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                      TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                      LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                              VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                      :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                      NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
          END


        END

      END

    END

  END
END

--

CREATE OR ALTER PROCEDURE CODE_GET_LOGINS
(
  ACCOUNT_ID VARCHAR(32),
  IN_MESSAGE_ID VARCHAR(32)
)
AS
DECLARE CONTACT VARCHAR(100);
DECLARE USER_NAME VARCHAR(100);
DECLARE SENDER_ID VARCHAR(32);
DECLARE CNT INTEGER;
DECLARE S VARCHAR(1000);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN
  SELECT IM.CONTACT, IM.SENDER_ID, IM.TYPE_MESSAGE, A.FIRM_ID, A.USER_NAME
    FROM IN_MESSAGES IM
    LEFT JOIN ACCOUNTS A ON A.ACCOUNT_ID=IM.SENDER_ID
   WHERE IM.IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, :TYPE_MESSAGE, :FIRM_ID, :USER_NAME;

  IF ((CONTACT IS NOT NULL) AND (SENDER_ID IS NOT NULL)) THEN BEGIN

    S=:USER_NAME;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      SELECT COUNT(*)
        FROM DRIVERS
       WHERE DRIVER_ID=:SENDER_ID
        INTO :CNT;

      IF (CNT>0) THEN
        S=S||' http://ataxi24.ru/files/taxi.jar';

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,
                                2,NULL,CURRENT_TIMESTAMP,NULL,:DEST_PORT,:FIRM_ID);

    END

  END

END

--

CREATE OR ALTER PROCEDURE CODE_INCIDENT
(
  SESSION_ID VARCHAR(32),
  IN_MESSAGE_ID VARCHAR(32)
)
AS
DECLARE ACCOUNT_ID VARCHAR(100);
DECLARE CONTACT VARCHAR(100);
DECLARE SENDER_ID VARCHAR(32);
DECLARE TEXT_IN VARCHAR(4000);
DECLARE CNT INTEGER;
DECLARE SUM_CHARGE NUMERIC(15,2);
DECLARE SUM_RECEIPT NUMERIC(15,2);
DECLARE BALANCE NUMERIC(15,2);
DECLARE MIN_BALANCE NUMERIC(15,2);
DECLARE USER_NAME VARCHAR(100);
DECLARE S VARCHAR(250);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE SURNAME VARCHAR(100);
DECLARE NAME VARCHAR(100);
DECLARE PATRONYMIC VARCHAR(100);
DECLARE DEST_PORT INTEGER;
DECLARE SUCCESS INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN
  SELECT IM.CONTACT, IM.SENDER_ID, IM.TEXT_IN, IM.TYPE_MESSAGE
    FROM IN_MESSAGES IM
    LEFT JOIN CODE_MESSAGES CM ON CM.CODE_MESSAGE_ID=IM.CODE_MESSAGE_ID
   WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, :TEXT_IN, :TYPE_MESSAGE;

  SELECT ACCOUNT_ID
    FROM SESSIONS
   WHERE SESSION_ID=:SESSION_ID
    INTO :ACCOUNT_ID;

  IF ((CONTACT IS NOT NULL) AND (SENDER_ID IS NOT NULL) AND (TEXT_IN IS NOT NULL)) THEN BEGIN

    SELECT COUNT(*)
      FROM DRIVERS D
      JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
     WHERE D.DRIVER_ID=:SENDER_ID
       AND A.LOCKED<>1
      INTO :CNT;

    IF (CNT>0) THEN BEGIN

      EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:SENDER_ID)
       RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

      SELECT D.MIN_BALANCE, A.USER_NAME, A.SURNAME, A.NAME, A.PATRONYMIC, A.FIRM_ID
        FROM DRIVERS D
        JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
        JOIN CARS C ON C.CAR_ID=D.CAR_ID
       WHERE D.DRIVER_ID=:SENDER_ID
        INTO :MIN_BALANCE, :USER_NAME, :SURNAME, :NAME, :PATRONYMIC, :FIRM_ID;
        
      SELECT COUNT(*)
        FROM SHIFTS
       WHERE ACCOUNT_ID=:SENDER_ID
         AND DATE_END IS NULL
        INTO :CNT;

      IF ((CNT>0) AND ((MIN_BALANCE IS NULL) OR ((MIN_BALANCE IS NOT NULL) AND (BALANCE>MIN_BALANCE)))) THEN BEGIN

        S=USER_NAME||' - ';
        IF (SURNAME IS NOT NULL) THEN
          S=S||' '||SURNAME;
        IF (NAME IS NOT NULL) THEN
          S=S||' '||NAME;
        IF (PATRONYMIC IS NOT NULL) THEN
          S=S||' '||PATRONYMIC;

        IN AUTONOMOUS TRANSACTION DO BEGIN

          INSERT INTO ALARMS (ALARM_ID,SENDER_ID,RECIPIENT_ID,TYPE_ALARM,
                              DATE_BEGIN,DATE_END,
                              CAPTION,TEXT_ALARM)
                      VALUES (GET_UNIQUE_ID(),'CA25F4C3A6DA8C334D20D3C4F2A2EF62',NULL,1,
                              CURRENT_TIMESTAMP,CURRENT_TIMESTAMP+5*(1e0/24/60),
                              'Черезвычайное проишествие',:S);
        END

        EXECUTE PROCEDURE EVENT_ALARM('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0)
         RETURNING_VALUES SUCCESS;

        IF (SUCCESS=1) THEN BEGIN

          SELECT CONST_VALUE FROM GET_CONST_VALUE('7B7B35D636E1B840426877D1EB07428F') INTO :S;

          EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE)
           RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

          IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

            S=REPLACE_STRING(S,'%CODE',TEXT_IN);

            INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                      TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                      LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                              VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                      :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,0,
                                      NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
          END

        END

      END

    END

  END
END

--

CREATE OR ALTER PROCEDURE CODE_LOSE
(
  SESSION_ID VARCHAR(32),
  IN_MESSAGE_ID VARCHAR(32)
)
AS
DECLARE ACCOUNT_ID VARCHAR(32);
DECLARE CONTACT VARCHAR(100);
DECLARE SENDER_ID VARCHAR(32);
DECLARE TEXT_IN VARCHAR(4000);
DECLARE CNT INTEGER;
DECLARE SUM_CHARGE NUMERIC(15,2);
DECLARE SUM_RECEIPT NUMERIC(15,2);
DECLARE BALANCE NUMERIC(15,2);
DECLARE MIN_BALANCE NUMERIC(15,2);
DECLARE USER_NAME VARCHAR(100);
DECLARE S VARCHAR(250);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE SURNAME VARCHAR(100);
DECLARE NAME VARCHAR(100);
DECLARE PATRONYMIC VARCHAR(100);
DECLARE DEST_PORT INTEGER;
DECLARE SUCCESS INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN
  SELECT IM.CONTACT, IM.SENDER_ID, IM.TEXT_IN, IM.TYPE_MESSAGE
    FROM IN_MESSAGES IM
    LEFT JOIN CODE_MESSAGES CM ON CM.CODE_MESSAGE_ID=IM.CODE_MESSAGE_ID
   WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, :TEXT_IN, :TYPE_MESSAGE;

  SELECT ACCOUNT_ID
    FROM SESSIONS
   WHERE SESSION_ID=:SESSION_ID
    INTO :ACCOUNT_ID;

  IF ((CONTACT IS NOT NULL) AND (SENDER_ID IS NOT NULL) AND (TEXT_IN IS NOT NULL)) THEN BEGIN

    SELECT COUNT(*)
      FROM DRIVERS D
      JOIN  ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
     WHERE D.DRIVER_ID=:SENDER_ID
       AND A.LOCKED<>1
      INTO :CNT;

    IF (CNT>0) THEN BEGIN

      EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:SENDER_ID)
       RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

      SELECT D.MIN_BALANCE, A.USER_NAME, A.SURNAME, A.NAME, A.PATRONYMIC, A.FIRM_ID
        FROM DRIVERS D
        JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
        JOIN CARS C ON C.CAR_ID=D.CAR_ID
       WHERE D.DRIVER_ID=:SENDER_ID
        INTO :MIN_BALANCE, :USER_NAME, :SURNAME, :NAME, :PATRONYMIC, :FIRM_ID;

      SELECT COUNT(*)
        FROM SHIFTS
       WHERE ACCOUNT_ID=:SENDER_ID
         AND DATE_END IS NULL
        INTO :CNT;

      IF ((CNT>0) AND ((MIN_BALANCE IS NULL) OR ((MIN_BALANCE IS NOT NULL) AND (BALANCE>MIN_BALANCE)))) THEN BEGIN

        S=USER_NAME||' - ';
        IF (SURNAME IS NOT NULL) THEN
          S=S||' '||SURNAME;
        IF (NAME IS NOT NULL) THEN
          S=S||' '||NAME;
        IF (PATRONYMIC IS NOT NULL) THEN
          S=S||' '||PATRONYMIC;

        IN AUTONOMOUS TRANSACTION DO BEGIN

          INSERT INTO ALARMS (ALARM_ID,SENDER_ID,RECIPIENT_ID,TYPE_ALARM,
                              DATE_BEGIN,DATE_END,CAPTION,TEXT_ALARM)
                      VALUES (GET_UNIQUE_ID(),'CA25F4C3A6DA8C334D20D3C4F2A2EF62',NULL,0,
                              CURRENT_TIMESTAMP,CURRENT_TIMESTAMP+5*(1e0/24/60),'Водитель заблудился',:S);
        END

        EXECUTE PROCEDURE EVENT_ALARM('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0)
         RETURNING_VALUES SUCCESS;

        IF (SUCCESS=1) THEN BEGIN

          SELECT CONST_VALUE FROM GET_CONST_VALUE('AB84E2116D3485A847EEE59DB47CE27B') INTO :S;

          EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE)
           RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

          IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

            S=REPLACE_STRING(S,'%CODE',TEXT_IN);

            INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                      TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                      LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                              VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                      :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                      NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
          END

        END

      END

    END

  END
END

--

CREATE OR ALTER PROCEDURE CODE_MAKE_ORDER
(
  SESSION_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  IN_MESSAGE_ID VARCHAR(32)
)
AS
DECLARE CONTACT VARCHAR(100);
DECLARE SENDER_ID VARCHAR(32);
DECLARE S VARCHAR(70);
DECLARE CNT INTEGER;
DECLARE CONST_VALUE VARCHAR(4000);
DECLARE ORDER_NUM VARCHAR(10);
DECLARE ACTION_ID VARCHAR(32);
DECLARE RATE_ID VARCHAR(32);
DECLARE CAR_TYPE_ID VARCHAR(32);
DECLARE CLIENT_ID VARCHAR(32);
DECLARE STREET_ID VARCHAR(32);
DECLARE HOUSE VARCHAR(10);
DECLARE FLAT VARCHAR(10);
DECLARE PORCH VARCHAR(10);
DECLARE ADDRESS_DESC VARCHAR(250);
DECLARE LOCKED INTEGER;
DECLARE ORDER_ID VARCHAR(32);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN
  SELECT CONTACT, SENDER_ID, TYPE_MESSAGE
    FROM IN_MESSAGES
   WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, TYPE_MESSAGE;

  SELECT COUNT(*)
    FROM BLACKS
   WHERE UPPER(PHONE)=UPPER(:CONTACT)
    INTO :CNT;

  IF ((CONTACT IS NOT NULL) AND (CNT=0)) THEN BEGIN

    SELECT LOCKED, CLIENT_ID, STREET_ID, HOUSE, FLAT, PORCH, ADDRESS_DESC
      FROM CLIENTS C
      JOIN ACCOUNTS A ON A.ACCOUNT_ID=C.CLIENT_ID
     WHERE C.CLIENT_ID=:SENDER_ID
      INTO :LOCKED, :CLIENT_ID, :STREET_ID, :HOUSE, :FLAT, :PORCH, :ADDRESS_DESC;

    IF ((CLIENT_ID IS NULL) OR ((CLIENT_ID IS NOT NULL) AND (LOCKED<>1))) THEN BEGIN

      SELECT CONST_VALUE FROM GET_CONST_VALUE('CB66FC06A78BB69D430EB7BD1AFA13FA') INTO :S;

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE)
       RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

      IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        STREET_ID='FA27330C653381FA4EDE11ECF0959DD6';  /* Красноярск - .*/
        HOUSE=NULL;
        FLAT=NULL;
        PORCH=NULL;
        ADDRESS_DESC=NULL;

        EXECUTE PROCEDURE GET_ORDER_NUM
         RETURNING_VALUES :ORDER_NUM;

        ACTION_ID='E019DBDE7D55BEC34D12A709EE3FEB0B'; /* Создание */

        RATE_ID=NULL;
        FOR SELECT RATE_ID
             FROM RATES
            ORDER BY PRIORITY
             INTO :RATE_ID DO BEGIN
          BREAK;
        END

        CAR_TYPE_ID=NULL;
        FOR SELECT CAR_TYPE_ID
              FROM CAR_TYPES
             ORDER BY PRIORITY
              INTO :CAR_TYPE_ID DO BEGIN
          BREAK;
        END

        IF ((RATE_ID IS NOT NULL) AND (CAR_TYPE_ID IS NOT NULL)) THEN BEGIN

          ORDER_ID=GET_UNIQUE_ID();

          IN AUTONOMOUS TRANSACTION DO BEGIN

            INSERT INTO ORDERS (ORDER_ID,ACTION_ID,RATE_ID,CAR_TYPE_ID,WHO_ACCEPT_ID,
                                CLIENT_ID,STREET_ID,HOUSE,FLAT,PORCH,DESCRIPTION,
                                ORDER_NUM,PHONE,DATE_ACCEPT,DATE_ARRIVAL,TYPE_ACCEPT,
                                TYPE_PROCESS,BEFORE_PERIOD,DATE_BEGIN,FINISHED)
                        VALUES (:ORDER_ID,:ACTION_ID,:RATE_ID,:CAR_TYPE_ID,:ACCOUNT_ID,
                                :CLIENT_ID,:STREET_ID,:HOUSE,:FLAT,:PORCH,:ADDRESS_DESC,
                                :ORDER_NUM,:CONTACT,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,1,
                                1,30,CURRENT_TIMESTAMP,0);

            UPDATE IN_MESSAGES
               SET ORDER_ID=:ORDER_ID
             WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID;

            S=REPLACE_STRING(S,'%ORDER_NUM',ORDER_NUM);

            FIRM_ID='C49DF004D660BBAF434839044848F5B8'; /* АТакси */

            INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                      TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                      PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                              VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                      :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,
                                      1,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
          END

          EXECUTE PROCEDURE EVENT_REFRESH_ORDERS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

        END

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE CODE_PARK_OUT
(
  SESSION_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  IN_MESSAGE_ID VARCHAR(32)
)
AS
DECLARE CONTACT VARCHAR(100);
DECLARE SENDER_ID VARCHAR(32);
DECLARE S VARCHAR(1000);
DECLARE PARK_NAME VARCHAR(100);
DECLARE PARK_STATE_ID VARCHAR(32);
DECLARE CNT INTEGER;
DECLARE D TIMESTAMP;
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN
  SELECT IM.CONTACT, IM.SENDER_ID, IM.TYPE_MESSAGE, A.FIRM_ID
    FROM IN_MESSAGES IM
    LEFT JOIN ACCOUNTS A ON A.ACCOUNT_ID=IM.SENDER_ID
   WHERE IM.IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, :TYPE_MESSAGE, :FIRM_ID;

  IF ((CONTACT IS NOT NULL) AND (SENDER_ID IS NOT NULL)) THEN BEGIN

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    SELECT COUNT(*)
      FROM DRIVERS D
      JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
     WHERE D.DRIVER_ID=:SENDER_ID
       AND A.LOCKED<>1
      INTO :CNT;

    IF (CNT>0) THEN BEGIN

      SELECT COUNT(*)
        FROM ORDERS
       WHERE DRIVER_ID=:SENDER_ID
         AND PARENT_ID IS NULL
         AND DATE_HISTORY IS NULL
         AND FINISHED<>1
        INTO :CNT;

      IF (CNT>0) THEN BEGIN

        SELECT CONST_VALUE FROM GET_CONST_VALUE('7E75E7A3DA4FAB8D443F2D7384B3DF46') INTO :S;

        IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                    LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                    :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                    NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
        END

      END ELSE BEGIN

        IN AUTONOMOUS TRANSACTION DO BEGIN

          FOR SELECT P.NAME, PS.PARK_STATE_ID
                FROM PARK_STATES PS
                JOIN PARKS P ON P.PARK_ID=PS.PARK_ID
               WHERE PS.DRIVER_ID=:SENDER_ID
                 AND PS.DATE_OUT IS NULL
                INTO :PARK_NAME, :PARK_STATE_ID DO BEGIN

            D=CURRENT_TIMESTAMP;

            UPDATE PARK_STATES
               SET DATE_OUT=:D
             WHERE PARK_STATE_ID=:PARK_STATE_ID;

            SELECT CONST_VALUE FROM GET_CONST_VALUE('F5FAEFF5369FA2E2496554FFACF900A3') INTO :S;

            IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

              S=REPLACE_STRING(S,'%PARK_NAME',PARK_NAME);
              S=REPLACE_STRING(S,'%TIME_DATE',FORMAT_DATETIME('hh:nn:ss dd.mm.yyyy',D));

              INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                        TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                        LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                                VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                        :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                        NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
            END

            BREAK;

          END

        END

        EXECUTE PROCEDURE EVENT_REFRESH_PARK_STATES('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

      END

    END

  END
END

--

CREATE OR ALTER PROCEDURE CODE_PARK_QUEUE
(
  ACCOUNT_ID VARCHAR(32),
  IN_MESSAGE_ID VARCHAR(32)
)
AS
DECLARE CONTACT VARCHAR(100);
DECLARE SENDER_ID VARCHAR(32);
DECLARE S VARCHAR(1000);
DECLARE CNT INTEGER;
DECLARE D TIMESTAMP;
DECLARE DATE_IN TIMESTAMP;
DECLARE DRIVER_ID VARCHAR(32);
DECLARE PARK_NAME VARCHAR(100);
DECLARE PARK_ID VARCHAR(32);
DECLARE SUM_CHARGE NUMERIC(15,2);
DECLARE SUM_RECEIPT NUMERIC(15,2);
DECLARE BALANCE NUMERIC(15,2);
DECLARE MIN_BALANCE NUMERIC(15,2);
DECLARE MINUTES INTEGER;
DECLARE COUNTER INTEGER;
DECLARE PRIORITY INTEGER;
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN
  SELECT IM.CONTACT, IM.SENDER_ID, IM.TYPE_MESSAGE, A.FIRM_ID
    FROM IN_MESSAGES IM
    LEFT JOIN ACCOUNTS A ON A.ACCOUNT_ID=IM.SENDER_ID
   WHERE IM.IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, :TYPE_MESSAGE, :FIRM_ID;

  IF ((CONTACT IS NOT NULL) AND (SENDER_ID IS NOT NULL)) THEN BEGIN

    SELECT COUNT(*)
      FROM DRIVERS D
      JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
     WHERE D.DRIVER_ID=:SENDER_ID
       AND A.LOCKED<>1
      INTO :CNT;

    IF (CNT>0) THEN BEGIN

      EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:SENDER_ID)
       RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

      SELECT MIN_BALANCE
        FROM DRIVERS
       WHERE DRIVER_ID=:SENDER_ID
        INTO :MIN_BALANCE;

      IF ((MIN_BALANCE IS NULL) OR ((MIN_BALANCE IS NOT NULL) AND (BALANCE>MIN_BALANCE))) THEN BEGIN

        PARK_ID=NULL;
        PARK_NAME=NULL;

        FOR SELECT PS.PARK_ID, P.NAME
              FROM PARK_STATES PS
              JOIN PARKS P ON P.PARK_ID=PS.PARK_ID
             WHERE DRIVER_ID=:SENDER_ID
               AND DATE_OUT IS NULL
              INTO :PARK_ID, :PARK_NAME DO BEGIN
          BREAK;
        END

        IF (PARK_ID IS NOT NULL) THEN BEGIN

          D=NULL;
          COUNTER=0;

          FOR SELECT DATE_IN, DRIVER_ID
                FROM PARK_STATES
               WHERE DATE_OUT IS NULL
                 AND PARK_ID=:PARK_ID
               ORDER BY DATE_IN
                INTO :DATE_IN, :DRIVER_ID DO BEGIN

            COUNTER=COUNTER+1;

            IF (DRIVER_ID=SENDER_ID) THEN BEGIN
              D=CURRENT_TIMESTAMP;
              MINUTES=CAST((D-DATE_IN)*(1e0*24*60) AS INTEGER);
              PRIORITY=COUNTER;
            END

          END

          IF (D IS NOT NULL) THEN BEGIN

            SELECT CONST_VALUE FROM GET_CONST_VALUE('A92208254FCBA05643224EB1F4508300') INTO :S;

            EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE)
             RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

            IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

              S=REPLACE_STRING(S,'%PRIORITY',CAST(PRIORITY AS VARCHAR(10)));
              S=REPLACE_STRING(S,'%COUNTER',CAST(COUNTER AS VARCHAR(10)));
              S=REPLACE_STRING(S,'%PARK_NAME',PARK_NAME);
              S=REPLACE_STRING(S,'%MINUTES',CAST(MINUTES AS VARCHAR(10)));

              INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                        TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                        LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                                VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                        :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                        NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
            END

          END

        END

      END

    END

  END
END

--

CREATE OR ALTER PROCEDURE CODE_SHIFT_CLOSE
(
  SESSION_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  IN_MESSAGE_ID VARCHAR(32)
)
AS
DECLARE CONTACT VARCHAR(100);
DECLARE SENDER_ID VARCHAR(32);
DECLARE S VARCHAR(1000);
DECLARE CNT INTEGER;
DECLARE D TIMESTAMP;
DECLARE DATE_BEGIN TIMESTAMP;
DECLARE SHIFT_ID VARCHAR(32);
DECLARE HOURS NUMERIC(10,1);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN
  SELECT IM.CONTACT, IM.SENDER_ID, IM.TYPE_MESSAGE, A.FIRM_ID
    FROM IN_MESSAGES IM
    LEFT JOIN ACCOUNTS A ON A.ACCOUNT_ID=IM.SENDER_ID
   WHERE IM.IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO CONTACT, SENDER_ID, :TYPE_MESSAGE, :FIRM_ID;

  IF ((CONTACT IS NOT NULL) AND (SENDER_ID IS NOT NULL)) THEN BEGIN

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    SELECT COUNT(*)
      FROM DRIVERS
     WHERE DRIVER_ID=:SENDER_ID
      INTO :CNT;

    IF (CNT>0) THEN BEGIN

      SELECT COUNT(*)
        FROM ORDERS
       WHERE DRIVER_ID=:SENDER_ID
         AND PARENT_ID IS NULL
         AND DATE_HISTORY IS NULL
         AND FINISHED<>1
        INTO :CNT;

      IF (CNT>0) THEN BEGIN

        SELECT CONST_VALUE FROM GET_CONST_VALUE('0A2F3602D3FD9A0E476E367410F37492') INTO :S;

        IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                    LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                             VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                     :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                     NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
        END

      END ELSE BEGIN

        IN AUTONOMOUS TRANSACTION DO BEGIN

          FOR SELECT DATE_BEGIN, SHIFT_ID
                FROM SHIFTS
               WHERE ACCOUNT_ID=:SENDER_ID
                 AND DATE_END IS NULL
                INTO :DATE_BEGIN, :SHIFT_ID DO BEGIN

            D=CURRENT_TIMESTAMP;

            UPDATE PARK_STATES
               SET DATE_OUT=:D
             WHERE DRIVER_ID=:SENDER_ID
               AND DATE_OUT IS NULL;

            UPDATE SHIFTS
               SET DATE_END=:D
             WHERE SHIFT_ID=:SHIFT_ID
               AND DATE_END IS NULL;

            HOURS=CAST((D-DATE_BEGIN)*(1e0*24) AS NUMERIC(10,1));

            SELECT CONST_VALUE FROM GET_CONST_VALUE('5D8701DF0DEDB7A6491181074CE5A88D') INTO :S;

            IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

              S=REPLACE_STRING(S,'%TIME_DATE',FORMAT_DATETIME('hh:nn:ss dd.mm.yyyy',D));
              S=REPLACE_STRING(S,'%HOURS',CAST(HOURS AS VARCHAR(30)));

              INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                        TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                        LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                                VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                        :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                        NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
            END

          END

          EXECUTE PROCEDURE EVENT_REFRESH_SHIFTS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

          EXECUTE PROCEDURE EVENT_REFRESH_PARK_STATES('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

        END

      END

    END

  END
END

--

CREATE OR ALTER PROCEDURE CODE_TEST
(
  ACCOUNT_ID VARCHAR(32),
  IN_MESSAGE_ID VARCHAR(32)
)
AS
DECLARE CONTACT VARCHAR(100);
DECLARE SENDER_ID VARCHAR(32);
DECLARE S VARCHAR(70);
DECLARE CNT INTEGER;
DECLARE MSEC BIGINT;
DECLARE DAYS INTEGER;
DECLARE HOURS INTEGER;
DECLARE MINUTES INTEGER;
DECLARE SECONDS INTEGER;
DECLARE D TIMESTAMP;
DECLARE UPTIME VARCHAR(100);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN
  SELECT IM.CONTACT, IM.SENDER_ID, IM.TYPE_MESSAGE, A.FIRM_ID
    FROM IN_MESSAGES IM
    LEFT JOIN ACCOUNTS A ON A.ACCOUNT_ID=IM.SENDER_ID
   WHERE IM.IN_MESSAGE_ID=:IN_MESSAGE_ID
    INTO :CONTACT, :SENDER_ID, :TYPE_MESSAGE, :FIRM_ID;

  IF ((CONTACT IS NOT NULL) AND (SENDER_ID IS NOT NULL)) THEN BEGIN

    SELECT COUNT(*)
      FROM ACCOUNT_ROLES
     WHERE ROLE_ID IN ('3AC5EA48DEA3A72A4380D9CC5923471F','FF7F332564F795C8411BF28652B22BEA') /* Администраторы, Диспетчеры */
       AND ACCOUNT_ID=:SENDER_ID
      INTO CNT;

    IF (CNT>0) THEN BEGIN

      SELECT CONST_VALUE FROM GET_CONST_VALUE('DD5F7C07EB2CBC6B4CE52043B3BF395D') INTO :S;

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(SENDER_ID,TYPE_MESSAGE)
       RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

      IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        MSEC=SYSTEM_UPTIME();
        DAYS=MSEC/(1000*60*60*24);
        MSEC=MSEC-(DAYS*1000*60*60*24);
        HOURS=MSEC/(1000*60*60);
        MSEC=MSEC-(HOURS*1000*60*60);
        MINUTES=MSEC/(1000*60);
        MSEC=MSEC-(MINUTES*1000*60);
        SECONDS=MSEC/1000;
        D=CAST((CAST(HOURS AS VARCHAR(2))||':'||CAST(MINUTES AS VARCHAR(2))||':'||CAST(SECONDS AS VARCHAR(2))) AS TIME);

        UPTIME=CAST(DAYS AS VARCHAR(10))||'-'||/*PERFIX*/FORMAT_DATETIME('hh:nn:ss',D);

        S=REPLACE_STRING(S,'%UPTIME',UPTIME);

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                  LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:SENDER_ID,CURRENT_TIMESTAMP,
                                  :S,NULL,0,:CONTACT,NULL,0,
                                  NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
      END
    END

  END

END

--

CREATE OR ALTER PROCEDURE CREATE_PAYMENT
(
  RECEIPT_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  WHO_CREATE_ID VARCHAR(32),
  SUM_RECEIPT NUMERIC(15,2),
  DATE_RECEIPT TIMESTAMP,
  DESCRIPTION VARCHAR(250
)
)
RETURNS (
  PAYMENT_EXISTS INTEGER)
AS
DECLARE S VARCHAR(70);
DECLARE RECEIPT_TYPE_ID VARCHAR(32);
DECLARE CHARGE_TYPE_ID VARCHAR(32);
DECLARE DATE_CREATE TIMESTAMP;
DECLARE ASUM_CHARGE NUMERIC(15,2);
DECLARE ASUM_RECEIPT NUMERIC(15,2);
DECLARE BALANCE NUMERIC(15,2);
DECLARE PHONE VARCHAR(100);
DECLARE CNT INTEGER;
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE SUM_CHARGE NUMERIC(15,2);
DECLARE FIRM_ID VARCHAR(32);
BEGIN
  PAYMENT_EXISTS=0;

  RECEIPT_TYPE_ID='2E0EEFF564858A6F48C8BE486202114A'; /* Наличными через платежку */

  FIRM_ID='C49DF004D660BBAF434839044848F5B8'; /* АТакси */

  SELECT COUNT(*)
    FROM RECEIPTS
   WHERE ACCOUNT_ID=:ACCOUNT_ID
     AND WHO_CREATE_ID=:WHO_CREATE_ID
     AND RECEIPT_TYPE_ID=:RECEIPT_TYPE_ID
     AND DESCRIPTION=:DESCRIPTION
    INTO :CNT;

  IF (CNT=0) THEN BEGIN

    DATE_CREATE=CURRENT_TIMESTAMP;
    DATE_RECEIPT=DATE_RECEIPT+8*60*60*(1e0/24/60/60);  /* Stupid difference between krasplat and our server */

    INSERT INTO RECEIPTS (RECEIPT_ID,RECEIPT_TYPE_ID,ACCOUNT_ID,WHO_CREATE_ID,
                          SUM_RECEIPT,DATE_RECEIPT,DATE_CREATE,DESCRIPTION,FIRM_ID)
         VALUES (:RECEIPT_ID,:RECEIPT_TYPE_ID,:ACCOUNT_ID,:WHO_CREATE_ID,
                 :SUM_RECEIPT,:DATE_RECEIPT,:DATE_CREATE,:DESCRIPTION,:FIRM_ID);

    CHARGE_TYPE_ID='E49F54CE241196A946067CD38FCB502B'; /* Удержание за Платежку */

    SUM_CHARGE=SUM_RECEIPT*0.15;

    INSERT INTO CHARGES (CHARGE_ID,CHARGE_TYPE_ID,ACCOUNT_ID,WHO_CREATE_ID,
                         SUM_CHARGE,DATE_CHARGE,DATE_CREATE,DESCRIPTION,FIRM_ID)
       VALUES (GET_UNIQUE_ID(),:CHARGE_TYPE_ID,:ACCOUNT_ID,:WHO_CREATE_ID,
               :SUM_CHARGE,:DATE_RECEIPT,:DATE_CREATE,NULL,:FIRM_ID);

    EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:ACCOUNT_ID)
     RETURNING_VALUES :ASUM_CHARGE, :ASUM_RECEIPT, :BALANCE;

    BALANCE=ASUM_RECEIPT-ASUM_CHARGE;

    SELECT PHONE, FIRM_ID
      FROM ACCOUNTS
     WHERE ACCOUNT_ID=:ACCOUNT_ID
      INTO :PHONE, :FIRM_ID;

    SELECT COUNT(*)
      FROM CLIENTS
     WHERE CLIENT_ID=:ACCOUNT_ID
      INTO :CNT;

    IF (CNT>0) THEN
      FIRM_ID=NULL; /* Не понятно чьё сообщение */

    SELECT CONST_VALUE FROM GET_CONST_VALUE('2031AA8F2E4B959248967F2838DC5F19') INTO :S;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(ACCOUNT_ID,NULL)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      S=REPLACE_STRING(S,'%BALANCE',CAST(BALANCE AS VARCHAR(30)));

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:WHO_CREATE_ID,:ACCOUNT_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,2,
                                NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
    END

  END ELSE BEGIN

    PAYMENT_EXISTS=1;

  END

END

--

CREATE OR ALTER PROCEDURE D_DRIVER_PARK
(
  SESSION_ID VARCHAR(32),
  DRIVER_ID VARCHAR(32),
  PARK_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  DATE_OUT TIMESTAMP
)
AS
DECLARE S VARCHAR(1000);
DECLARE PARK_NAME VARCHAR(100);
DECLARE CONTACT VARCHAR(100);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN

  IN AUTONOMOUS TRANSACTION DO BEGIN

    UPDATE PARK_STATES
       SET DATE_OUT=:DATE_OUT
     WHERE DRIVER_ID=:DRIVER_ID
       AND PARK_ID=:PARK_ID
       AND DATE_OUT IS NULL;

  END

  EXECUTE PROCEDURE EVENT_REFRESH_PARK_STATES('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

  SELECT PHONE, FIRM_ID
    FROM ACCOUNTS
   WHERE ACCOUNT_ID=:DRIVER_ID
    INTO :CONTACT, :FIRM_ID;

  SELECT CONST_VALUE FROM GET_CONST_VALUE('C0B2DFF0FD07BC1C43047D31AECDC8A2') INTO :S;

  EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL)
   RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

  IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

    SELECT NAME
      FROM PARKS
     WHERE PARK_ID=:PARK_ID
      INTO :PARK_NAME;

    S=REPLACE_STRING(S,'%PARK_NAME',PARK_NAME);
    S=REPLACE_STRING(S,'%TIME_DATE',FORMAT_DATETIME('hh:nn:ss dd.mm.yyyy',DATE_OUT));

    INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                              TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                              LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                      VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                              :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                              NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
  END

END

--

CREATE OR ALTER PROCEDURE D_DRIVER_SHIFT
(
  SESSION_ID VARCHAR(32),
  SHIFT_ID VARCHAR(32),
  DRIVER_ID VARCHAR(32),
  PARK_ID VARCHAR(32),
  DATE_END TIMESTAMP,
  ACCOUNT_ID VARCHAR(32),
  LOCKED INTEGER
)
AS
DECLARE S VARCHAR(1000);
DECLARE CONTACT VARCHAR(100);
DECLARE HOURS NUMERIC(10,1);
DECLARE D TIMESTAMP;
DECLARE DATE_BEGIN TIMESTAMP;
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN

  SELECT PHONE, FIRM_ID
    FROM ACCOUNTS
   WHERE ACCOUNT_ID=:DRIVER_ID
    INTO :CONTACT, :FIRM_ID;

  UPDATE ACCOUNTS
     SET LOCKED=:LOCKED
   WHERE ACCOUNT_ID=:DRIVER_ID;

  IN AUTONOMOUS TRANSACTION DO BEGIN

    UPDATE SHIFTS
       SET DATE_END=:DATE_END
     WHERE ACCOUNT_ID=:DRIVER_ID
       AND SHIFT_ID=:SHIFT_ID;

    IF (PARK_ID IS NOT NULL) THEN BEGIN

      UPDATE PARK_STATES
         SET DATE_OUT=:DATE_END
       WHERE DRIVER_ID=:DRIVER_ID
         AND PARK_ID=:PARK_ID
         AND DATE_OUT IS NULL;

    END ELSE BEGIN

      UPDATE PARK_STATES
         SET DATE_OUT=:DATE_END
       WHERE DRIVER_ID=:DRIVER_ID
         AND DATE_OUT IS NULL;

    END

    SELECT DATE_BEGIN
      FROM SHIFTS
     WHERE SHIFT_ID=:SHIFT_ID
      INTO :DATE_BEGIN;

  END

  EXECUTE PROCEDURE EVENT_REFRESH_SHIFTS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

  EXECUTE PROCEDURE EVENT_REFRESH_PARK_STATES('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

  D=CURRENT_TIMESTAMP;

  HOURS=CAST((D-DATE_BEGIN)*(1e0*24) AS NUMERIC(10,1));

  SELECT CONST_VALUE FROM GET_CONST_VALUE('7032584355F3A3C44394DAA17D8A9BA9') INTO :S;

  EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL)
   RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

  IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

    S=REPLACE_STRING(S,'%TIME_DATE',FORMAT_DATETIME('hh:nn:ss dd.mm.yyyy',D));
    S=REPLACE_STRING(S,'%HOURS',CAST(HOURS AS VARCHAR(30)));

    INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                              TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                              LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                      VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                              :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                              NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
  END

END

--

CREATE OR ALTER PROCEDURE D_ORDER
(
  SESSION_ID VARCHAR(32),
  OLD_ORDER_ID VARCHAR(32)
)
AS
BEGIN
  IN AUTONOMOUS TRANSACTION DO BEGIN

    DELETE FROM IN_MESSAGES
          WHERE ORDER_ID IN (SELECT ORDER_ID FROM ORDERS
                              WHERE PARENT_ID=:OLD_ORDER_ID);

    DELETE FROM OUT_MESSAGES
          WHERE ORDER_ID IN (SELECT ORDER_ID FROM ORDERS
                              WHERE PARENT_ID=:OLD_ORDER_ID);

    DELETE FROM CHARGES
          WHERE ORDER_ID IN (SELECT ORDER_ID FROM ORDERS
                              WHERE PARENT_ID=:OLD_ORDER_ID);

    DELETE FROM RECEIPTS
          WHERE ORDER_ID IN (SELECT ORDER_ID FROM ORDERS
                              WHERE PARENT_ID=:OLD_ORDER_ID);

    DELETE FROM ROUTES
          WHERE ORDER_ID IN (SELECT ORDER_ID FROM ORDERS
                              WHERE PARENT_ID=:OLD_ORDER_ID);

    DELETE FROM ORDER_SERVICES
          WHERE ORDER_ID IN (SELECT ORDER_ID FROM ORDERS
                              WHERE PARENT_ID=:OLD_ORDER_ID);

    DELETE FROM ORDERS
          WHERE PARENT_ID=:OLD_ORDER_ID;

    DELETE FROM IN_MESSAGES
          WHERE ORDER_ID=:OLD_ORDER_ID;

    DELETE FROM OUT_MESSAGES
          WHERE ORDER_ID=:OLD_ORDER_ID;

    DELETE FROM ROUTES
          WHERE ORDER_ID=:OLD_ORDER_ID;

    DELETE FROM ORDER_SERVICES
          WHERE ORDER_ID=:OLD_ORDER_ID;

    DELETE FROM ORDERS
          WHERE ORDER_ID=:OLD_ORDER_ID;

  END

  EXECUTE PROCEDURE EVENT_REFRESH_ORDERS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

END

--

CREATE OR ALTER PROCEDURE I_DRIVER_PARK
(
  SESSION_ID VARCHAR(32),
  DRIVER_ID VARCHAR(32),
  PARK_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  DATE_IN TIMESTAMP
)
AS
DECLARE SUM_CHARGE NUMERIC(15,2);
DECLARE SUM_RECEIPT NUMERIC(15,2);
DECLARE BALANCE NUMERIC(15,2);
DECLARE MIN_BALANCE NUMERIC(15,2);
DECLARE CONTACT VARCHAR(100);
DECLARE PARK_NAME VARCHAR(100);
DECLARE PARK_DESCRIPTION VARCHAR(250);
DECLARE PRIORITY INTEGER;
DECLARE S VARCHAR(1000);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN

  EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:DRIVER_ID)
   RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

  SELECT MIN_BALANCE
    FROM DRIVERS
   WHERE DRIVER_ID=:DRIVER_ID
    INTO :MIN_BALANCE;

  IF ((MIN_BALANCE IS NULL) OR ((MIN_BALANCE IS NOT NULL) AND (BALANCE>MIN_BALANCE))) THEN BEGIN

    SELECT PHONE, FIRM_ID
      FROM ACCOUNTS
     WHERE ACCOUNT_ID=:DRIVER_ID
      INTO :CONTACT, :FIRM_ID;

    IN AUTONOMOUS TRANSACTION DO BEGIN

      INSERT INTO PARK_STATES(PARK_STATE_ID,DRIVER_ID,PARK_ID,DATE_IN)
           VALUES (GET_UNIQUE_ID(),:DRIVER_ID,:PARK_ID,:DATE_IN);

      SELECT COUNT(*)
        FROM PARK_STATES
       WHERE PARK_ID=:PARK_ID
         AND DATE_OUT IS NULL
        INTO PRIORITY;

    END

    EXECUTE PROCEDURE EVENT_REFRESH_PARK_STATES('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

    SELECT CONST_VALUE FROM GET_CONST_VALUE('D98222D30163A3FE4B647ABF4A2C179F') INTO :S;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      SELECT NAME, DESCRIPTION
        FROM PARKS
       WHERE PARK_ID=:PARK_ID
        INTO :PARK_NAME, :PARK_DESCRIPTION;

      S=REPLACE_STRING(S,'%PRIORITY',CAST(PRIORITY AS VARCHAR(10)));
      S=REPLACE_STRING(S,'%PARK_NAME',PARK_NAME);
      S=REPLACE_STRING(S,'%PARK_DESCRIPTION',PARK_DESCRIPTION);
      S=REPLACE_STRING(S,'%BALANCE',CAST(BALANCE AS VARCHAR(30)));

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,1,
                                NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
    END

  END
END

--

CREATE OR ALTER PROCEDURE I_DRIVER_SHIFT
(
  SESSION_ID VARCHAR(32),
  SHIFT_ID VARCHAR(32),
  DRIVER_ID VARCHAR(32),
  PARK_ID VARCHAR(32),
  DATE_BEGIN TIMESTAMP,
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE SUM_CHARGE NUMERIC(15,2);
DECLARE SUM_RECEIPT NUMERIC(15,2);
DECLARE BALANCE NUMERIC(15,2);
DECLARE MIN_BALANCE NUMERIC(15,2);
DECLARE PARK_NAME VARCHAR(100);
DECLARE PARK_DESCRIPTION VARCHAR(250);
DECLARE PRIORITY INTEGER;
DECLARE S VARCHAR(1000);
DECLARE CONTACT VARCHAR(100);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN

  EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL)
   RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

  EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:DRIVER_ID)
   RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

  SELECT MIN_BALANCE
    FROM DRIVERS
   WHERE DRIVER_ID=:DRIVER_ID
    INTO :MIN_BALANCE;
    
  IF ((MIN_BALANCE IS NULL) OR ((MIN_BALANCE IS NOT NULL) AND (BALANCE>MIN_BALANCE))) THEN BEGIN

    IN AUTONOMOUS TRANSACTION DO BEGIN

      INSERT INTO SHIFTS (SHIFT_ID,ACCOUNT_ID,DATE_BEGIN)
           VALUES (:SHIFT_ID,:DRIVER_ID,:DATE_BEGIN);

      SELECT PHONE, FIRM_ID
        FROM ACCOUNTS
       WHERE ACCOUNT_ID=:DRIVER_ID
        INTO :CONTACT, :FIRM_ID;

      IF (PARK_ID IS NOT NULL) THEN BEGIN

        UPDATE PARK_STATES
           SET DATE_OUT=:DATE_BEGIN
         WHERE DRIVER_ID=:DRIVER_ID
           AND DATE_OUT IS NULL;

        INSERT INTO PARK_STATES(PARK_STATE_ID,DRIVER_ID,PARK_ID,DATE_IN)
             VALUES (GET_UNIQUE_ID(),:DRIVER_ID,:PARK_ID,:DATE_BEGIN);

        SELECT COUNT(*)
          FROM PARK_STATES
         WHERE PARK_ID=:PARK_ID
           AND DATE_OUT IS NULL
          INTO PRIORITY;

        SELECT CONST_VALUE FROM GET_CONST_VALUE('D98222D30163A3FE4B647ABF4A2C179F') INTO :S;

        IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

          SELECT NAME, DESCRIPTION
            FROM PARKS
           WHERE PARK_ID=:PARK_ID
            INTO :PARK_NAME, :PARK_DESCRIPTION;

          S=REPLACE_STRING(S,'%PRIORITY',CAST(PRIORITY AS VARCHAR(10)));
          S=REPLACE_STRING(S,'%PARK_NAME',PARK_NAME);
          S=REPLACE_STRING(S,'%PARK_DESCRIPTION',PARK_DESCRIPTION);
          S=REPLACE_STRING(S,'%BALANCE',CAST(BALANCE AS VARCHAR(30)));

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                    LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                    :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,0,
                                    NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);
        END

      END ELSE BEGIN

        SELECT CONST_VALUE FROM GET_CONST_VALUE('C83CCF38CF6CAB374FAB6FA49754B07F') INTO :S;

        IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

          S=REPLACE_STRING(S,'%BALANCE',CAST(BALANCE AS VARCHAR(30)));

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                    LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                    :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,0,
                                    NULL,CURRENT_TIMESTAMP,:DEST_PORT,:FIRM_ID);

        END

      END

    END

    EXECUTE PROCEDURE EVENT_REFRESH_SHIFTS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

    EXECUTE PROCEDURE EVENT_REFRESH_PARK_STATES('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

  END

END

--

CREATE OR ALTER PROCEDURE I_OUT_MESSAGE
(
  OUT_MESSAGE_ID VARCHAR(32),
  CREATOR_ID VARCHAR(32),
  RECIPIENT_ID VARCHAR(32),
  DATE_CREATE TIMESTAMP,
  TEXT_OUT VARCHAR(4000),
  DATE_OUT TIMESTAMP,
  TYPE_MESSAGE INTEGER,
  CONTACT VARCHAR(100),
  DESCRIPTION VARCHAR(250),
  PRIORITY INTEGER,
  LOCKED VARCHAR(32),
  DATE_BEGIN TIMESTAMP,
  DATE_END TIMESTAMP,
  ORDER_ID VARCHAR(32),
  CHANNEL VARCHAR(100),
  DELIVERY INTEGER,
  DATE_DELIVERY TIMESTAMP,
  FLASH INTEGER,
  DEST_PORT INTEGER,
  FIRM_ID VARCHAR(32)
)
AS
BEGIN
  INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                      TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                      PRIORITY,DATE_BEGIN,DATE_END,ORDER_ID,CHANNEL,
                                      DELIVERY,DATE_DELIVERY,FLASH,DEST_PORT,FIRM_ID)
       VALUES (:OUT_MESSAGE_ID,:CREATOR_ID,:RECIPIENT_ID,:DATE_CREATE,
               :TEXT_OUT,:DATE_OUT,:TYPE_MESSAGE,:CONTACT,:DESCRIPTION,
               :PRIORITY,:DATE_BEGIN,:DATE_END,:ORDER_ID,:CHANNEL,
               :DELIVERY,:DATE_DELIVERY,:FLASH,:DEST_PORT,:FIRM_ID);
END

--

CREATE OR ALTER PROCEDURE I_RECEIPT
(
  RECEIPT_ID VARCHAR(32),
  RECEIPT_TYPE_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  WHO_CREATE_ID VARCHAR(32),
  SUM_RECEIPT NUMERIC(15,2),
  DATE_RECEIPT TIMESTAMP,
  DATE_CREATE TIMESTAMP,
  DESCRIPTION VARCHAR(250),
  ORDER_ID VARCHAR(32),
  FIRM_ID VARCHAR(32)
)
AS
DECLARE S VARCHAR(70);
DECLARE CNT INTEGER;
DECLARE ASUM_CHARGE NUMERIC(15,2);
DECLARE ASUM_RECEIPT NUMERIC(15,2);
DECLARE BALANCE NUMERIC(15,2);
DECLARE PHONE VARCHAR(100);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE OUT_MESSAGE_FIRM_ID VARCHAR(32);
BEGIN
  INSERT INTO RECEIPTS (RECEIPT_ID,RECEIPT_TYPE_ID,ACCOUNT_ID,WHO_CREATE_ID,
                        SUM_RECEIPT,DATE_RECEIPT,DATE_CREATE,DESCRIPTION,ORDER_ID,FIRM_ID)
       VALUES (:RECEIPT_ID,:RECEIPT_TYPE_ID,:ACCOUNT_ID,:WHO_CREATE_ID,
               :SUM_RECEIPT,:DATE_RECEIPT,:DATE_CREATE,:DESCRIPTION,:ORDER_ID,:FIRM_ID);

  EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(ACCOUNT_ID)
   RETURNING_VALUES ASUM_CHARGE, ASUM_RECEIPT, BALANCE;

  SELECT PHONE, FIRM_ID
    FROM ACCOUNTS
   WHERE ACCOUNT_ID=:ACCOUNT_ID
    INTO :PHONE, :OUT_MESSAGE_FIRM_ID;

  SELECT COUNT(*)
    FROM CLIENTS
   WHERE CLIENT_ID=:ACCOUNT_ID
    INTO :CNT;

  IF (CNT>0) THEN
    OUT_MESSAGE_FIRM_ID=NULL; /* Не понятно чьё сообщение */

  IF (PHONE IS NOT NULL) THEN BEGIN

    SELECT CONST_VALUE FROM GET_CONST_VALUE('2031AA8F2E4B959248967F2838DC5F19') INTO :S;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(ACCOUNT_ID,NULL)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    IF (S IS NOT NULL) THEN BEGIN

      S=REPLACE_STRING(S,'%BALANCE',CAST(BALANCE AS VARCHAR(30)));

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:WHO_CREATE_ID,:ACCOUNT_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,2,
                                NULL,CURRENT_TIMESTAMP,:DEST_PORT,:OUT_MESSAGE_FIRM_ID);
    END
  END

END

--

CREATE OR ALTER PROCEDURE PR_ANOTHER_DRIVER
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE PHONE VARCHAR(100);
DECLARE DRIVER_ID VARCHAR(32);
DECLARE PARK_ID VARCHAR(32);
DECLARE S VARCHAR(1000);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN

  SELECT DRIVER_ID
    FROM ORDERS
   WHERE ORDER_ID=:ORDER_ID
    INTO :DRIVER_ID;

  PARK_ID=NULL;

  FOR SELECT PARK_ID
        FROM ORDERS
       WHERE PARENT_ID=:ORDER_ID
       ORDER BY DATE_HISTORY
        INTO :PARK_ID DO BEGIN
    BREAK;
  END

  IN AUTONOMOUS TRANSACTION DO BEGIN

    UPDATE ORDERS
       SET TYPE_PROCESS=0,
           DATE_END=CURRENT_TIMESTAMP,
           WHO_PROCESS_ID=:ACCOUNT_ID,
           PARK_ID=:PARK_ID,
           DRIVER_ID=NULL,
           CAR_ID=NULL
     WHERE ORDER_ID=:ORDER_ID;

  END

  EXECUTE PROCEDURE EVENT_REFRESH_ORDERS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

  IF (DRIVER_ID IS NOT NULL) THEN BEGIN

    SELECT PHONE, FIRM_ID
      FROM ACCOUNTS
     WHERE ACCOUNT_ID=:DRIVER_ID
      INTO :PHONE, :FIRM_ID;

    SELECT CONST_VALUE FROM GET_CONST_VALUE('A82FFC060D399C82436CB3D669239B0B') INTO :S;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                0,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
    END

  END

END

--

CREATE OR ALTER PROCEDURE PR_ARRIVAL_DRIVER
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE PHONE VARCHAR(100);
DECLARE DRIVER_ID VARCHAR(32);
DECLARE PARK_ID VARCHAR(32);
DECLARE PARK_STREET_ID VARCHAR(32);
DECLARE PARK_HOUSE VARCHAR(10);
DECLARE FROM_STREET_ID VARCHAR(32);
DECLARE FROM_HOUSE VARCHAR(10);
DECLARE RECEIPT_TYPE_ID VARCHAR(32);
DECLARE COST_RATE NUMERIC(15,2);
DECLARE COST_CASH NUMERIC(15,2);
DECLARE COLOR VARCHAR(100);
DECLARE BRAND VARCHAR(100);
DECLARE STATE_NUM VARCHAR(50);
DECLARE PREFIX VARCHAR(10);
DECLARE STREET VARCHAR(100);
DECLARE HOUSE VARCHAR(10);
DECLARE FLAT VARCHAR(10);
DECLARE PORCH VARCHAR(10);
DECLARE LOCALITY VARCHAR(100);
DECLARE CLIENT_ID VARCHAR(32);
DECLARE CALC_ID VARCHAR(32);
DECLARE SUM_CHARGE NUMERIC(15,2);
DECLARE SUM_RECEIPT NUMERIC(15,2);
DECLARE BALANCE NUMERIC(15,2);
DECLARE S VARCHAR(1000);
DECLARE S1 VARCHAR(1000);
DECLARE ADDRESS VARCHAR(1000);
DECLARE NUM INTEGER;
DECLARE CNT INTEGER;
DECLARE FLAG INTEGER;
DECLARE D TIMESTAMP;
DECLARE LAT1 DOUBLE PRECISION;
DECLARE LON1 DOUBLE PRECISION;
DECLARE LAT2 DOUBLE PRECISION;
DECLARE LON2 DOUBLE PRECISION;
DECLARE ROUTE_DISTANCE DOUBLE PRECISION;
DECLARE DISTANCE NUMERIC(15,2);
DECLARE CLIENT_TYPE_MESSAGE INTEGER;
DECLARE DRIVER_TYPE_MESSAGE INTEGER;
DECLARE IN_MESSAGE_ID VARCHAR(32);
DECLARE CLIENT_DEST_PORT INTEGER;
DECLARE DRIVER_DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
DECLARE DRIVER_FIRM_ID VARCHAR(32);
BEGIN

  SELECT O.PHONE, O.DRIVER_ID, O.PARK_ID, O.FIRM_ID,
         O.STREET_ID, O.HOUSE,
         O.COST_RATE, O.CLIENT_ID,
         C.COLOR, C.BRAND, C.STATE_NUM
    FROM ORDERS O
    LEFT JOIN DRIVERS D ON D.DRIVER_ID=O.DRIVER_ID
    LEFT JOIN CARS C ON C.CAR_ID=D.CAR_ID
   WHERE ORDER_ID=:ORDER_ID
    INTO :PHONE, :DRIVER_ID, :PARK_ID, :FIRM_ID,
         :FROM_STREET_ID, :FROM_HOUSE,
         :COST_RATE, :CLIENT_ID,
         :COLOR, :BRAND, :STATE_NUM;

  IN AUTONOMOUS TRANSACTION DO BEGIN

    UPDATE ORDERS
       SET DATE_BEGIN=CURRENT_TIMESTAMP
     WHERE ORDER_ID=:ORDER_ID;

  END

  EXECUTE PROCEDURE EVENT_REFRESH_ORDERS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

  CALC_ID=NULL;

  IF (CLIENT_ID IS NOT NULL) THEN BEGIN

    SELECT CALC_ID
      FROM CLIENTS
     WHERE CLIENT_ID=:CLIENT_ID
      INTO :CALC_ID;

  END

  BALANCE=NULL;

  IF (CALC_ID IS NOT NULL) THEN BEGIN

    EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:CLIENT_ID)
     RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

  END

  FLAG=0;

  FOR SELECT STREET_ID, HOUSE
        FROM ROUTES
       WHERE ORDER_ID=:ORDER_ID
       ORDER BY PRIORITY
        INTO :STREET, :HOUSE DO BEGIN

    IF ((STREET IS NOT NULL) AND (HOUSE IS NOT NULL)) THEN BEGIN

    END ELSE BEGIN

      FLAG=1;

    END
  END

  COST_CASH=NULL;

  IF ((COST_RATE>0.0) AND (FLAG=0)) THEN BEGIN

    IF (BALANCE IS NOT NULL) THEN BEGIN

      IF (BALANCE>=COST_RATE) THEN
        COST_CASH=0.0;
      ELSE
        COST_CASH=COST_RATE-BALANCE;

    END

  END

  IF (SUBSTR(PHONE,1,3)='+79')  THEN BEGIN

    IF ((COST_RATE>0.0) AND (FLAG=0)) THEN BEGIN

      IF (COST_CASH IS NULL) THEN

        SELECT CONST_VALUE FROM GET_CONST_VALUE('8D9E6C9F4852AD8142205F027B2A5288') INTO :S;

      ELSE

        SELECT CONST_VALUE FROM GET_CONST_VALUE('9CA9F2761D2BBE974791906824C3C31A') INTO :S;

    END ELSE BEGIN

      SELECT CONST_VALUE FROM GET_CONST_VALUE('93EBB0171E37A0884313759C0DA1EB3D') INTO :S;

    END

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(CLIENT_ID,NULL)
     RETURNING_VALUES CLIENT_TYPE_MESSAGE, CLIENT_DEST_PORT;

    IF ((S IS NOT NULL) AND (CLIENT_TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      S=REPLACE_STRING(S,'%COLOR',COLOR);
      S=REPLACE_STRING(S,'%BRAND',BRAND);
      S=REPLACE_STRING(S,'%STATE_NUM',STATE_NUM);
      S=REPLACE_STRING(S,'%COST_RATE',CAST(CAST(COST_RATE AS NUMERIC(15,0)) AS VARCHAR(30)));
      S=REPLACE_STRING(S,'%COST_CASH',CAST(CAST(COST_CASH AS NUMERIC(15,0)) AS VARCHAR(30)));


      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:CLIENT_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:CLIENT_TYPE_MESSAGE,:PHONE,NULL,
                                0,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:CLIENT_DEST_PORT,:FIRM_ID);

    END

    SELECT CONST_VALUE FROM GET_CONST_VALUE('F4384929079999BB47A895BFCA5BB382') INTO :S;

    IF ((S IS NOT NULL) AND (CLIENT_TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:CLIENT_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:CLIENT_TYPE_MESSAGE,:PHONE,NULL,
                                0,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:CLIENT_DEST_PORT,:FIRM_ID);

    END

  END

  IF (DRIVER_ID IS NOT NULL) THEN BEGIN

    FOR SELECT IN_MESSAGE_ID, TYPE_MESSAGE
          FROM IN_MESSAGES
         WHERE ORDER_ID=:ORDER_ID
           AND CODE_MESSAGE_ID='618A0B399123BEEA474944099929C541' /* Водитель прибыл */
           AND SENDER_ID=:DRIVER_ID
           AND DESCRIPTION IS NULL
          INTO :IN_MESSAGE_ID, :DRIVER_TYPE_MESSAGE DO BEGIN

      UPDATE IN_MESSAGES
         SET DESCRIPTION=:ORDER_ID
       WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID;

      BREAK;
    END

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,DRIVER_TYPE_MESSAGE)
     RETURNING_VALUES DRIVER_TYPE_MESSAGE, DRIVER_DEST_PORT;

    SELECT PHONE, FIRM_ID
      FROM ACCOUNTS
     WHERE ACCOUNT_ID=:DRIVER_ID
      INTO :PHONE, :DRIVER_FIRM_ID;

    FLAG=0;
    NUM=0;

    SELECT COUNT(*)
      FROM ROUTES
     WHERE ORDER_ID=:ORDER_ID
      INTO :CNT;

    D=CURRENT_TIMESTAMP;

    FOR SELECT S.PREFIX, S.NAME, R.HOUSE, R.FLAT, R.PORCH, L.NAME
          FROM ROUTES R
          LEFT JOIN STREETS S ON S.STREET_ID=R.STREET_ID
          LEFT JOIN LOCALITIES L ON L.LOCALITY_ID=S.LOCALITY_ID
         WHERE R.ORDER_ID=:ORDER_ID
         ORDER BY R.PRIORITY
          INTO :PREFIX, :STREET, :HOUSE, :FLAT, :PORCH, :LOCALITY DO BEGIN

      ADDRESS='';
      S=NULL;

      IF ((STREET IS NOT NULL) AND (HOUSE IS NOT NULL)) THEN BEGIN

        IF (PREFIX IS NOT NULL) THEN
          ADDRESS=PREFIX||' ';

        IF (STREET IS NOT NULL) THEN
          ADDRESS=ADDRESS||STREET;

        IF (HOUSE IS NOT NULL) THEN
          ADDRESS=ADDRESS||' '||HOUSE;

        IF (FLAT IS NOT NULL) THEN
          ADDRESS=ADDRESS||'-'||FLAT;

        IF (PORCH IS NOT NULL) THEN
          ADDRESS=ADDRESS||' п.'||PORCH;

        IF ((LOCALITY IS NOT NULL) AND (LOCALITY<>'Красноярск')) THEN
          ADDRESS=ADDRESS||', '||LOCALITY;

        SELECT CONST_VALUE FROM GET_CONST_VALUE('92009DB6C3EAA9E74B80D333538FE40D') INTO :S;

      END ELSE BEGIN

        FLAG=1;

        SELECT CONST_VALUE FROM GET_CONST_VALUE('7ED5E8A8BBD9870A411517B54D9EB973') INTO :S;

      END

      IF (S IS NOT NULL) THEN BEGIN

        NUM=NUM+1;

        S=REPLACE_STRING(S,'%NUM',NUM);
        S=REPLACE_STRING(S,'%COUNT',CNT);
        S=REPLACE_STRING(S,'%ADDRESS',ADDRESS);

        IF (NUM=CNT) THEN BEGIN

          IF ((FLAG=0) AND (COST_RATE>0.0)) THEN BEGIN

            IF (COST_CASH IS NULL) THEN

              SELECT CONST_VALUE FROM GET_CONST_VALUE('9C8BC7D14DAEAE5C4DC8C1C91B20BCC2') INTO :S1;

            ELSE

              SELECT CONST_VALUE FROM GET_CONST_VALUE('A468782967A1A4D347F85F33D39E348A') INTO :S1;

          END ELSE

            SELECT CONST_VALUE FROM GET_CONST_VALUE('D3F68032AD999D004140A480A8AAF749') INTO :S1;

        END ELSE

          S1=S;


        IF ((S1 IS NOT NULL) AND (DRIVER_TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

          S1=REPLACE_STRING(S1,'%ADDRESS',S);
          S1=REPLACE_STRING(S1,'%COST_RATE',CAST(CAST(COST_RATE AS NUMERIC(15,0)) AS VARCHAR(30)));
          S1=REPLACE_STRING(S1,'%COST_CASH',CAST(CAST(COST_CASH AS NUMERIC(15,0)) AS VARCHAR(30)));

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                    PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                    :S1,NULL,:DRIVER_TYPE_MESSAGE,:PHONE,NULL,
                                    2,NULL,:D,:ORDER_ID,:DRIVER_DEST_PORT,:DRIVER_FIRM_ID);

          D=D+1*(1e0/24/60/60);

        END

      END

    END

    IF (PARK_ID IS NOT NULL) THEN BEGIN

      SELECT STREET_ID, HOUSE
        FROM PARKS
       WHERE PARK_ID=:PARK_ID
        INTO :PARK_STREET_ID, :PARK_HOUSE;

      IF ((PARK_STREET_ID IS NOT NULL) AND (PARK_HOUSE IS NOT NULL)) THEN BEGIN

        SELECT LAT, LON
          FROM MAP_OBJECTS
         WHERE STREET_ID=:PARK_STREET_ID
           AND HOUSE=:PARK_HOUSE
          INTO :LAT1, :LON1;

        IF ((LAT1 IS NOT NULL) AND (LON1 IS NOT NULL) AND
            (FROM_STREET_ID IS NOT NULL) AND (FROM_HOUSE IS NOT NULL)) THEN BEGIN

          SELECT LAT, LON
            FROM MAP_OBJECTS
           WHERE STREET_ID=:FROM_STREET_ID
             AND HOUSE=:FROM_HOUSE
            INTO :LAT2, :LON2;

          IF ((LAT2 IS NOT NULL) AND (LON2 IS NOT NULL)) THEN BEGIN

            EXECUTE PROCEDURE GET_ROUTE_DISTANCE(:LAT1,:LON1,:LAT2,:LON2)
             RETURNING_VALUES :ROUTE_DISTANCE;

            IF ((ROUTE_DISTANCE IS NOT NULL) AND (ROUTE_DISTANCE>0.0)) THEN BEGIN

              DISTANCE=CAST((ROUTE_DISTANCE/1000) AS NUMERIC(15,2));

              IF (DISTANCE>5.0) THEN BEGIN

                DISTANCE=DISTANCE-5.0;

                RECEIPT_TYPE_ID='2448E302595392064D9DF67BDD05C7DB'; /* Компенсация за прогон */

                SUM_RECEIPT=DISTANCE*2.5;

                INSERT INTO RECEIPTS (RECEIPT_ID,RECEIPT_TYPE_ID,ACCOUNT_ID,WHO_CREATE_ID,
                                      SUM_RECEIPT,DATE_RECEIPT,DATE_CREATE,DESCRIPTION,ORDER_ID,FIRM_ID)
                              VALUES (GET_UNIQUE_ID(),:RECEIPT_TYPE_ID,:DRIVER_ID,:ACCOUNT_ID,
                                      :SUM_RECEIPT,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,NULL,:ORDER_ID,:FIRM_ID);

                SELECT CONST_VALUE FROM GET_CONST_VALUE('6905163E6105BE12488DAF7AAFA32810') INTO :S;

                IF ((S IS NOT NULL) AND (DRIVER_TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

                  S=REPLACE_STRING(S,'%DISTANCE',CAST(DISTANCE AS VARCHAR(30)));
                  S=REPLACE_STRING(S,'%SUM_RECEIPT',CAST(SUM_RECEIPT AS VARCHAR(30)));

                  INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                            TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                            PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                                    VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                            :S,NULL,:DRIVER_TYPE_MESSAGE,:PHONE,NULL,
                                            2,NULL,:D,:ORDER_ID,:DRIVER_DEST_PORT,:DRIVER_FIRM_ID);


                END

              END

            END

          END

        END

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE PR_CHANGE_ROUTE
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE PHONE VARCHAR(100);
DECLARE DRIVER_ID VARCHAR(32);
DECLARE S VARCHAR(1000);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE IN_MESSAGE_ID VARCHAR(32);
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN

  SELECT DRIVER_ID
    FROM ORDERS
   WHERE ORDER_ID=:ORDER_ID
    INTO :DRIVER_ID;

  IN AUTONOMOUS TRANSACTION DO BEGIN

    UPDATE ORDERS
       SET TYPE_PROCESS=1,
           DATE_END=CURRENT_TIMESTAMP,
           WHO_PROCESS_ID=:ACCOUNT_ID
     WHERE ORDER_ID=:ORDER_ID;

  END

  EXECUTE PROCEDURE EVENT_REFRESH_ORDERS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

  IF (DRIVER_ID IS NOT NULL) THEN BEGIN

    FOR SELECT IN_MESSAGE_ID, TYPE_MESSAGE
          FROM IN_MESSAGES
         WHERE ORDER_ID=:ORDER_ID
           AND CODE_MESSAGE_ID='F42D57842950B923481A9B2D02B925CB' /* Клиент хочет сменить маршрут */
           AND SENDER_ID=:DRIVER_ID
           AND DESCRIPTION IS NULL
          INTO :IN_MESSAGE_ID, :TYPE_MESSAGE DO BEGIN

      UPDATE IN_MESSAGES
         SET DESCRIPTION=:ORDER_ID
       WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID;

      BREAK;
    END

    SELECT PHONE, FIRM_ID
      FROM ACCOUNTS
     WHERE ACCOUNT_ID=:DRIVER_ID
      INTO :PHONE, :FIRM_ID;

    SELECT CONST_VALUE FROM GET_CONST_VALUE('2A7354AFB1FDB1D041F8FB2D06FFBC70') INTO :S;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,TYPE_MESSAGE)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
    END

  END

END

--

CREATE OR ALTER PROCEDURE PR_CLIENT_IN_CAR
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE PHONE VARCHAR(100);
DECLARE DRIVER_ID VARCHAR(32);
DECLARE S VARCHAR(1000);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE IN_MESSAGE_ID VARCHAR(32);
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN

  SELECT DRIVER_ID
    FROM ORDERS
   WHERE ORDER_ID=:ORDER_ID
    INTO :DRIVER_ID;

  IN AUTONOMOUS TRANSACTION DO BEGIN

    UPDATE ORDERS
       SET DATE_BEGIN=CURRENT_TIMESTAMP
     WHERE ORDER_ID=:ORDER_ID;

  END

  EXECUTE PROCEDURE EVENT_REFRESH_ORDERS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

  IF (DRIVER_ID IS NOT NULL) THEN BEGIN

    FOR SELECT IN_MESSAGE_ID, TYPE_MESSAGE
          FROM IN_MESSAGES
         WHERE ORDER_ID=:ORDER_ID
           AND CODE_MESSAGE_ID='3FD0D3ABD5E0B697483FF8520EDDBD6D' /* Клиент сел в машину */
           AND SENDER_ID=:DRIVER_ID
           AND DESCRIPTION IS NULL
          INTO :IN_MESSAGE_ID, :TYPE_MESSAGE DO BEGIN

      UPDATE IN_MESSAGES
         SET DESCRIPTION=:ORDER_ID
       WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID;

      BREAK;
    END

    SELECT PHONE, FIRM_ID
      FROM ACCOUNTS
     WHERE ACCOUNT_ID=:DRIVER_ID
      INTO :PHONE, :FIRM_ID;

    SELECT CONST_VALUE FROM GET_CONST_VALUE('620D357394B89B18454EB58DD5CE9F19') INTO :S;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,TYPE_MESSAGE)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
    END

  END

END

--

CREATE OR ALTER PROCEDURE PR_CONFIRM_ORDER
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE PHONE VARCHAR(100);
DECLARE DRIVER_ID VARCHAR(32);
DECLARE PARK_ID VARCHAR(32);
DECLARE RECIPIENT_ID VARCHAR(32);
DECLARE S VARCHAR(1000);
DECLARE FIRM_ID VARCHAR(32);
BEGIN

  SELECT PHONE, DRIVER_ID, PARK_ID, FIRM_ID
    FROM ORDERS
   WHERE ORDER_ID=:ORDER_ID
    INTO :PHONE, :DRIVER_ID, :PARK_ID, :FIRM_ID;

  IN AUTONOMOUS TRANSACTION DO BEGIN

    UPDATE ORDERS
       SET DATE_BEGIN=CURRENT_TIMESTAMP
     WHERE ORDER_ID=:ORDER_ID;

  END

  EXECUTE PROCEDURE EVENT_REFRESH_ORDERS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

  IF ((PHONE IS NOT NULL) AND (DRIVER_ID IS NOT NULL)) THEN BEGIN

    UPDATE IN_MESSAGES
       SET DESCRIPTION=:ORDER_ID
     WHERE ORDER_ID=:ORDER_ID
       AND CODE_MESSAGE_ID='A87C64B41C87907A4B8C58C5F6A19E2F' /* Водитель принял заказ */
       AND SENDER_ID=:DRIVER_ID
       AND DESCRIPTION IS NULL;

    IN AUTONOMOUS TRANSACTION DO BEGIN

      UPDATE PARK_STATES
         SET DATE_OUT=CURRENT_TIMESTAMP
       WHERE DRIVER_ID=:DRIVER_ID
         AND PARK_ID=:PARK_ID
         AND DATE_OUT IS NULL;

    END

    EXECUTE PROCEDURE EVENT_REFRESH_PARK_STATES('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

    IF (SUBSTR(PHONE,1,3)='+79')  THEN BEGIN

      RECIPIENT_ID=NULL;

      FOR SELECT ACCOUNT_ID
            FROM ACCOUNTS
           WHERE PHONE=:PHONE
            INTO :RECIPIENT_ID DO BEGIN

        IF (RECIPIENT_ID IS NOT NULL) THEN
          BREAK;
      END

      SELECT CONST_VALUE FROM GET_CONST_VALUE('1C12AF5D5D57ACD045A724F8E3FF90ED') INTO :S;

      IF (S IS NOT NULL) THEN BEGIN

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                  PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:RECIPIENT_ID,CURRENT_TIMESTAMP,
                                  :S,NULL,0,:PHONE,NULL,
                                  2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:FIRM_ID);
      END
    END

    SELECT PHONE, FIRM_ID
      FROM ACCOUNTS
     WHERE ACCOUNT_ID=:DRIVER_ID
      INTO :PHONE, :FIRM_ID;

    SELECT CONST_VALUE FROM GET_CONST_VALUE('723E98B898F89A8941B6CAAB092221AE') INTO :S;

    IF (S IS NOT NULL) THEN BEGIN

      RECIPIENT_ID=DRIVER_ID;

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:RECIPIENT_ID,CURRENT_TIMESTAMP,
                                :S,NULL,0,:PHONE,NULL,
                                2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:FIRM_ID);
    END

  END

END

--

CREATE OR ALTER PROCEDURE PR_FULL_CALC
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE COST_RATE NUMERIC(15,2);
DECLARE COST_FACT NUMERIC(15,2);
DECLARE NON_CASH NUMERIC(15,2);
DECLARE PARENT_SUM NUMERIC(15,2);
DECLARE PHONE VARCHAR(100);
DECLARE DRIVER_ID VARCHAR(32);
DECLARE SUM_CHARGE NUMERIC(15,2);
DECLARE SUM_RECEIPT NUMERIC(15,2);
DECLARE BALANCE NUMERIC(15,2);
DECLARE MIN_BALANCE NUMERIC(15,2);
DECLARE CHARGE_TYPE_ID VARCHAR(32);
DECLARE RECEIPT_TYPE_ID VARCHAR(32);
DECLARE CLIENT_ID VARCHAR(32);
DECLARE PARENT_ID VARCHAR(32);
DECLARE CALC_ID VARCHAR(32);
DECLARE S VARCHAR(1000);
DECLARE CODE VARCHAR(100);
DECLARE CNT INTEGER;
DECLARE DESCRIPTION VARCHAR(250);
DECLARE USER_NAME VARCHAR(100);
DECLARE CLIENT_TYPE_MESSAGE INTEGER;
DECLARE DRIVER_TYPE_MESSAGE INTEGER;
DECLARE CLIENT_DEST_PORT INTEGER;
DECLARE DRIVER_DEST_PORT INTEGER;
DECLARE IN_MESSAGE_ID VARCHAR(32);
DECLARE FIRM_ID VARCHAR(32);
DECLARE DRIVER_FIRM_ID VARCHAR(32);
BEGIN

  DRIVER_FIRM_ID=NULL;

  SELECT PHONE, DRIVER_ID, COST_RATE, COST_FACT, CLIENT_ID, FIRM_ID
    FROM ORDERS
   WHERE ORDER_ID=:ORDER_ID
    INTO :PHONE, :DRIVER_ID, :COST_RATE, :COST_FACT, :CLIENT_ID, :FIRM_ID;

  IF (DRIVER_ID IS NOT NULL) THEN BEGIN

    SELECT FIRM_ID
      FROM ACCOUNTS
     WHERE ACCOUNT_ID=:DRIVER_ID
      INTO :DRIVER_FIRM_ID;

    FOR SELECT IN_MESSAGE_ID, TYPE_MESSAGE
          FROM IN_MESSAGES
         WHERE ORDER_ID=:ORDER_ID
           AND CODE_MESSAGE_ID='0388BCC17DE1A1754B566F18AEEED771' /* Клиент рассчитался полностью */
           AND SENDER_ID=:DRIVER_ID
           AND DESCRIPTION IS NULL
          INTO :IN_MESSAGE_ID, :DRIVER_TYPE_MESSAGE DO BEGIN

      UPDATE IN_MESSAGES
         SET DESCRIPTION=:ORDER_ID
       WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID;

      BREAK;
    END

  END

  IF ((COST_FACT IS NULL) OR (COST_FACT<=0.0))  THEN
    COST_FACT=:COST_RATE;

  IF (COST_FACT<=0.0) THEN BEGIN

    IF (DRIVER_ID IS NOT NULL) THEN BEGIN

      SELECT CONST_VALUE FROM GET_CONST_VALUE('4BB5C780923E872D436DA3DA31C9E0B0') INTO :S;

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,DRIVER_TYPE_MESSAGE)
       RETURNING_VALUES DRIVER_TYPE_MESSAGE, DRIVER_DEST_PORT;

      IF ((S IS NOT NULL) AND (DRIVER_TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        SELECT PHONE
          FROM ACCOUNTS
         WHERE ACCOUNT_ID=:DRIVER_ID
          INTO :PHONE;

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                  PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                  :S,NULL,:DRIVER_TYPE_MESSAGE,:PHONE,NULL,
                                  2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DRIVER_DEST_PORT,:DRIVER_FIRM_ID);
      END

    END

    EXECUTE PROCEDURE PR_MANUAL(SESSION_ID,ORDER_ID,ACCOUNT_ID);

  END ELSE BEGIN

    IN AUTONOMOUS TRANSACTION DO BEGIN

      UPDATE ORDERS
         SET FINISHED=1,
             DATE_END=CURRENT_TIMESTAMP,
             WHO_PROCESS_ID=:ACCOUNT_ID,
             COST_FACT=:COST_FACT
       WHERE ORDER_ID=:ORDER_ID;

    END

    EXECUTE PROCEDURE EVENT_REFRESH_ORDERS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

    EXECUTE PROCEDURE CREATE_ROUTE_HISTORY(ORDER_ID);

    IF (DRIVER_ID IS NOT NULL) THEN BEGIN

      CALC_ID=NULL;

      IF (CLIENT_ID IS NOT NULL) THEN BEGIN

        SELECT C.CALC_ID, A.USER_NAME
          FROM CLIENTS C
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=C.CLIENT_ID
         WHERE CLIENT_ID=:CLIENT_ID
          INTO :CALC_ID, :USER_NAME;

        SELECT COUNT(*)
          FROM CLIENT_CHILDS
         WHERE CHILD_ID=:CLIENT_ID
          INTO :CNT;

        IF (CNT>0) THEN BEGIN

          PARENT_SUM=2.0;

          IF ((COST_FACT>150.0) AND (COST_FACT<=250.0)) THEN
            PARENT_SUM=5.0;

          IF ((COST_FACT>250.0) AND (COST_FACT<=350.0)) THEN
            PARENT_SUM=10.0;

          IF (COST_FACT>350.0) THEN
            PARENT_SUM=20.0;

          SUM_RECEIPT=PARENT_SUM/CNT;

          FOR SELECT CLIENT_ID
                FROM CLIENT_CHILDS

               WHERE CHILD_ID=:CLIENT_ID
                INTO :PARENT_ID DO BEGIN

           RECEIPT_TYPE_ID='9958D6ED64ADAAB94AEF470DA7B5F4F7'; /* Поездка дочернего клиента */

           DESCRIPTION=USER_NAME;

           INSERT INTO RECEIPTS (RECEIPT_ID,RECEIPT_TYPE_ID,ACCOUNT_ID,WHO_CREATE_ID,
                                 SUM_RECEIPT,DATE_RECEIPT,DATE_CREATE,DESCRIPTION,ORDER_ID,FIRM_ID)
                         VALUES (GET_UNIQUE_ID(),:RECEIPT_TYPE_ID,:PARENT_ID,:ACCOUNT_ID,
                                :SUM_RECEIPT,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,:DESCRIPTION,:ORDER_ID,:DRIVER_FIRM_ID);

          END
        END

      END

      BALANCE=NULL;

      IF (CALC_ID IS NOT NULL) THEN BEGIN

        EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:CLIENT_ID)
         RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

      END

      NON_CASH=NULL;

      IF ((BALANCE IS NOT NULL) AND (BALANCE<>0.0)) THEN BEGIN

        IF (BALANCE>=COST_FACT) THEN BEGIN
          NON_CASH=COST_FACT;
          BALANCE=BALANCE-NON_CASH;
        END ELSE BEGIN
          NON_CASH=BALANCE;
          BALANCE=0.0;
        END

      END

      IF (NON_CASH IS NOT NULL) THEN BEGIN

        CHARGE_TYPE_ID='757B9CAF2D3CA5144A7E2A23472990E5'; /* Поездка */

        SUM_CHARGE=NON_CASH;

        INSERT INTO CHARGES (CHARGE_ID,WHO_CREATE_ID,CHARGE_TYPE_ID,ACCOUNT_ID,
                             SUM_CHARGE,DATE_CHARGE,DATE_CREATE,DESCRIPTION,ORDER_ID,FIRM_ID)
                     VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:CHARGE_TYPE_ID,:CLIENT_ID,
                             :SUM_CHARGE,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,NULL,:ORDER_ID,:DRIVER_FIRM_ID);


      END

      IF (SUBSTR(PHONE,1,3)='+79')  THEN BEGIN

        IF (NON_CASH IS NOT NULL) THEN BEGIN

          SELECT CONST_VALUE FROM GET_CONST_VALUE('56140344A440BE774C9007D49CD574E9') INTO :S;

        END ELSE BEGIN

          SELECT CONST_VALUE FROM GET_CONST_VALUE('05B75340B170BF5141FC63F5CDF7FCD6') INTO :S;

        END

        EXECUTE PROCEDURE GET_TYPE_MESSAGE(CLIENT_ID,NULL)
         RETURNING_VALUES CLIENT_TYPE_MESSAGE, CLIENT_DEST_PORT;

        IF ((S IS NOT NULL) AND (CLIENT_TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

          S=REPLACE_STRING(S,'%BALANCE',CAST(CAST(BALANCE AS NUMERIC(15,0)) AS VARCHAR(30)));

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                    PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:CLIENT_ID,CURRENT_TIMESTAMP,
                                    :S,NULL,:CLIENT_TYPE_MESSAGE,:PHONE,NULL,
                                    2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:CLIENT_DEST_PORT,:FIRM_ID);
        END

        SELECT CONST_VALUE FROM GET_CONST_VALUE('E9FFA9589ABD8C174474572B72017BCC') INTO :S;

        IF ((S IS NOT NULL) AND (CLIENT_TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                    PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:CLIENT_ID,CURRENT_TIMESTAMP,
                                    :S,NULL,:CLIENT_TYPE_MESSAGE,:PHONE,NULL,
                                    2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:CLIENT_DEST_PORT,:FIRM_ID);
        END

      END

      CHARGE_TYPE_ID='E1BC9789DA9DB2B041C0784EBE92BFC9'; /* Выполнение заказа */

      SELECT RET_SUM
        FROM GET_DRIVER_SUM(:DRIVER_ID,:COST_FACT)
        INTO :SUM_CHARGE;

      IF (FIRM_ID=DRIVER_FIRM_ID) THEN BEGIN

        INSERT INTO CHARGES (CHARGE_ID,WHO_CREATE_ID,CHARGE_TYPE_ID,ACCOUNT_ID,
                             SUM_CHARGE,DATE_CHARGE,DATE_CREATE,DESCRIPTION,ORDER_ID,FIRM_ID)
                     VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:CHARGE_TYPE_ID,:DRIVER_ID,
                             :SUM_CHARGE,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,NULL,:ORDER_ID,:FIRM_ID);

      END ELSE BEGIN

        INSERT INTO CHARGES (CHARGE_ID,WHO_CREATE_ID,CHARGE_TYPE_ID,ACCOUNT_ID,
                             SUM_CHARGE,DATE_CHARGE,DATE_CREATE,DESCRIPTION,ORDER_ID,FIRM_ID)
                     VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:CHARGE_TYPE_ID,:DRIVER_ID,
                             :SUM_CHARGE/2,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,NULL,:ORDER_ID,:FIRM_ID);

        INSERT INTO CHARGES (CHARGE_ID,WHO_CREATE_ID,CHARGE_TYPE_ID,ACCOUNT_ID,
                             SUM_CHARGE,DATE_CHARGE,DATE_CREATE,DESCRIPTION,ORDER_ID,FIRM_ID)
                     VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:CHARGE_TYPE_ID,:DRIVER_ID,
                             :SUM_CHARGE/2,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,NULL,:ORDER_ID,:DRIVER_FIRM_ID);
      END

      IF (NON_CASH IS NOT NULL) THEN BEGIN

        RECEIPT_TYPE_ID='3F91C48D888F81974941D256C0815B03'; /* Компенсация за поездку */

        SUM_RECEIPT=NON_CASH;

        INSERT INTO RECEIPTS (RECEIPT_ID,RECEIPT_TYPE_ID,ACCOUNT_ID,WHO_CREATE_ID,
                              SUM_RECEIPT,DATE_RECEIPT,DATE_CREATE,DESCRIPTION,ORDER_ID,FIRM_ID)
                      VALUES (GET_UNIQUE_ID(),:RECEIPT_TYPE_ID,:DRIVER_ID,:ACCOUNT_ID,
                              :SUM_RECEIPT,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,NULL,:ORDER_ID,:DRIVER_FIRM_ID);

      END

      EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:DRIVER_ID)
       RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

      SELECT MIN_BALANCE
        FROM DRIVERS
       WHERE DRIVER_ID=:DRIVER_ID
        INTO :MIN_BALANCE;

      IF ((MIN_BALANCE IS NULL) OR ((MIN_BALANCE IS NOT NULL) AND (BALANCE>MIN_BALANCE))) THEN BEGIN

        SELECT CONST_VALUE FROM GET_CONST_VALUE('16835607B30CA79F4CE883B53AFE972D') INTO :S;

      END ELSE BEGIN

        IN AUTONOMOUS TRANSACTION DO BEGIN

          UPDATE SHIFTS
             SET DATE_END=CURRENT_TIMESTAMP
           WHERE ACCOUNT_ID=:DRIVER_ID
             AND DATE_END IS NULL;

        END

        EXECUTE PROCEDURE EVENT_REFRESH_SHIFTS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

        SELECT CONST_VALUE FROM GET_CONST_VALUE('634880F305E9AA434245E3E596697001') INTO :S;

      END

      SELECT PHONE
        FROM ACCOUNTS
       WHERE ACCOUNT_ID=:DRIVER_ID
        INTO :PHONE;

      IF ((S IS NOT NULL) AND (DRIVER_TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        S=REPLACE_STRING(S,'%BALANCE',CAST(BALANCE AS VARCHAR(30)));

        IF (NON_CASH IS NULL) THEN
          NON_CASH=0.0;

        S=REPLACE_STRING(S,'%NON_CASH',CAST(CAST(NON_CASH AS NUMERIC(15,0)) AS VARCHAR(30)));

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                  PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                  :S,NULL,:DRIVER_TYPE_MESSAGE,:PHONE,NULL,
                                  2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DRIVER_DEST_PORT,:DRIVER_FIRM_ID);
      END

      FOR SELECT TRIM(SUB_STRING(IM.TEXT_IN,2,100))
            FROM IN_MESSAGES IM
            JOIN CODE_MESSAGES CM ON CM.CODE_MESSAGE_ID=IM.CODE_MESSAGE_ID
           WHERE IM.SENDER_ID=:DRIVER_ID
             AND IM.ORDER_ID=:ORDER_ID
             AND IM.CODE_MESSAGE_ID='0388BCC17DE1A1754B566F18AEEED771' /* Клиент рассчитался полностью */
             AND CM.ENABLED=1
           ORDER BY IM.DATE_IN DESC
            INTO :CODE DO BEGIN

        SELECT COUNT(*)
          FROM CODE_MESSAGES
         WHERE CODE=:CODE
          INTO :CNT;

        IF (CNT=1) THEN BEGIN

          EXECUTE PROCEDURE TRY_PARK_IN(SESSION_ID,ORDER_ID,ACCOUNT_ID,DRIVER_ID,CODE,DRIVER_TYPE_MESSAGE);

        END ELSE BEGIN

          EXECUTE PROCEDURE QUERY_PARK_STATES (ORDER_ID,ACCOUNT_ID,DRIVER_ID,PHONE,DRIVER_TYPE_MESSAGE);

        END

        BREAK;
      END

    END

  END
END

--

CREATE OR ALTER PROCEDURE PR_PARTY_CALC
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE PHONE VARCHAR(100);
DECLARE DRIVER_ID VARCHAR(32);
DECLARE S VARCHAR(1000);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE IN_MESSAGE_ID VARCHAR(32);
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN

  SELECT DRIVER_ID
    FROM ORDERS
   WHERE ORDER_ID=:ORDER_ID
    INTO :DRIVER_ID;

  IN AUTONOMOUS TRANSACTION DO BEGIN

    UPDATE ORDERS
       SET TYPE_PROCESS=1,
           DATE_END=CURRENT_TIMESTAMP,
           WHO_PROCESS_ID=:ACCOUNT_ID
     WHERE ORDER_ID=:ORDER_ID;

  END

  EXECUTE PROCEDURE EVENT_REFRESH_ORDERS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

  IF (DRIVER_ID IS NOT NULL) THEN BEGIN

    FOR SELECT IN_MESSAGE_ID, TYPE_MESSAGE
          FROM IN_MESSAGES
         WHERE ORDER_ID=:ORDER_ID
           AND CODE_MESSAGE_ID='E0D06394F6BC81BA481D1F94D12B3FB4' /* Клиент отказался платить */
           AND SENDER_ID=:DRIVER_ID
           AND DESCRIPTION IS NULL
          INTO :IN_MESSAGE_ID, :TYPE_MESSAGE DO BEGIN

      UPDATE IN_MESSAGES
         SET DESCRIPTION=:ORDER_ID
       WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID;

      BREAK;
    END

    SELECT PHONE, FIRM_ID
      FROM ACCOUNTS
     WHERE ACCOUNT_ID=:DRIVER_ID
      INTO :PHONE, :FIRM_ID;

    SELECT CONST_VALUE FROM GET_CONST_VALUE('8B477D56F777966345EBC1130AF01C55') INTO :S;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,TYPE_MESSAGE)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
    END

  END

END

--

CREATE OR ALTER PROCEDURE PR_REFUSE_CLIENT_COME_OUT
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE DRIVER_ID VARCHAR(32);
DECLARE PARK_ID VARCHAR(32);
DECLARE PARK_NAME VARCHAR(100);
DECLARE PHONE VARCHAR(100);
DECLARE PARK_STATE_ID VARCHAR(32);
DECLARE DATE_IN TIMESTAMP;
DECLARE S VARCHAR(1000);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE IN_MESSAGE_ID VARCHAR(32);
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN

  SELECT DRIVER_ID, PARK_ID
    FROM ORDERS
   WHERE ORDER_ID=:ORDER_ID
    INTO :DRIVER_ID, :PARK_ID;

  IN AUTONOMOUS TRANSACTION DO BEGIN

    UPDATE ORDERS
       SET DATE_END=CURRENT_TIMESTAMP,
           WHO_PROCESS_ID=:ACCOUNT_ID,
           FINISHED=1
     WHERE ORDER_ID=:ORDER_ID;

  END

  EXECUTE PROCEDURE EVENT_REFRESH_ORDERS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

  IF (DRIVER_ID IS NOT NULL) THEN BEGIN

    FOR SELECT IN_MESSAGE_ID, TYPE_MESSAGE
          FROM IN_MESSAGES
         WHERE ORDER_ID=:ORDER_ID
           AND CODE_MESSAGE_ID='9273E67428E797614B153E4C799D6F48' /* Клиент отказался от заказа */
           AND SENDER_ID=:DRIVER_ID
           AND DESCRIPTION IS NULL
          INTO :IN_MESSAGE_ID, :TYPE_MESSAGE DO BEGIN

      UPDATE IN_MESSAGES
         SET DESCRIPTION=:ORDER_ID
       WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID;

      BREAK;
    END

    IF (PARK_ID IS NOT NULL) THEN BEGIN

      IN AUTONOMOUS TRANSACTION DO BEGIN

        FOR SELECT PS.PARK_STATE_ID, P.NAME, PS.DATE_IN
              FROM PARK_STATES PS
              JOIN PARKS P ON P.PARK_ID=PS.PARK_ID
             WHERE PS.PARK_ID=:PARK_ID
               AND PS.DATE_OUT IS NULL
             ORDER BY PS.DATE_IN
              INTO :PARK_STATE_ID, :PARK_NAME, :DATE_IN DO BEGIN

          DATE_IN=DATE_IN-1*(1e0/24/60/60);

          INSERT INTO PARK_STATES (PARK_STATE_ID,DRIVER_ID,PARK_ID,DATE_IN,DATE_OUT)
                           VALUES (GET_UNIQUE_ID(),:DRIVER_ID,:PARK_ID,:DATE_IN,NULL);

          BREAK;
        END

        IF (PARK_NAME IS NULL) THEN BEGIN

          INSERT INTO PARK_STATES (PARK_STATE_ID,DRIVER_ID,PARK_ID,DATE_IN,DATE_OUT)
                           VALUES (GET_UNIQUE_ID(),:DRIVER_ID,:PARK_ID,CURRENT_TIMESTAMP,NULL);

          SELECT NAME
            FROM PARKS
           WHERE PARK_ID=:PARK_ID
            INTO :PARK_NAME;

        END

      END

      EXECUTE PROCEDURE EVENT_REFRESH_PARK_STATES('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

      SELECT PHONE, FIRM_ID
        FROM ACCOUNTS
       WHERE ACCOUNT_ID=:DRIVER_ID
        INTO :PHONE, :FIRM_ID;

      SELECT CONST_VALUE FROM GET_CONST_VALUE('13D70B96F52BBE8D4E115CCC194F3B10') INTO :S;

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,TYPE_MESSAGE)
       RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

      IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        S=REPLACE_STRING(S,'%PARK_NAME',PARK_NAME);

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                  PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                  :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                  2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE PR_REFUSE_CLIENT_CONFIRM
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE DRIVER_ID VARCHAR(32);
DECLARE PHONE VARCHAR(100);
DECLARE S VARCHAR(1000);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN

  SELECT DRIVER_ID
    FROM ORDERS
   WHERE ORDER_ID=:ORDER_ID
    INTO :DRIVER_ID;

  IN AUTONOMOUS TRANSACTION DO BEGIN

    UPDATE ORDERS
       SET DATE_END=CURRENT_TIMESTAMP,
           WHO_PROCESS_ID=:ACCOUNT_ID,
           FINISHED=1
     WHERE ORDER_ID=:ORDER_ID;

  END

  EXECUTE PROCEDURE EVENT_REFRESH_ORDERS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

  IF (DRIVER_ID IS NOT NULL) THEN BEGIN

    SELECT PHONE, FIRM_ID
      FROM ACCOUNTS
     WHERE ACCOUNT_ID=:DRIVER_ID
      INTO :PHONE, :FIRM_ID;

    SELECT CONST_VALUE FROM GET_CONST_VALUE('C40297F408B0AF3A45776489F11FC512') INTO :S;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                0,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
    END

  END

END

--

CREATE OR ALTER PROCEDURE PR_REFUSE_CLIENT_DRIVE_OUT
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE DRIVER_ID VARCHAR(32);
DECLARE PARK_ID VARCHAR(32);
DECLARE PARK_NAME VARCHAR(100);
DECLARE PHONE VARCHAR(100);
DECLARE PARK_STATE_ID VARCHAR(32);
DECLARE DATE_IN TIMESTAMP;
DECLARE S VARCHAR(1000);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN

  SELECT DRIVER_ID, PARK_ID
    FROM ORDERS
   WHERE ORDER_ID=:ORDER_ID
    INTO :DRIVER_ID, :PARK_ID;

  IN AUTONOMOUS TRANSACTION DO BEGIN

    UPDATE ORDERS
       SET DATE_END=CURRENT_TIMESTAMP,
           WHO_PROCESS_ID=:ACCOUNT_ID,
           FINISHED=1
     WHERE ORDER_ID=:ORDER_ID;

  END

  EXECUTE PROCEDURE EVENT_REFRESH_ORDERS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

  IF (DRIVER_ID IS NOT NULL) THEN BEGIN

    IF (PARK_ID IS NOT NULL) THEN BEGIN

      IN AUTONOMOUS TRANSACTION DO BEGIN

        FOR SELECT PS.PARK_STATE_ID, P.NAME, PS.DATE_IN
              FROM PARK_STATES PS
              JOIN PARKS P ON P.PARK_ID=PS.PARK_ID
             WHERE PS.PARK_ID=:PARK_ID
               AND PS.DATE_OUT IS NULL
             ORDER BY PS.DATE_IN
              INTO :PARK_STATE_ID, :PARK_NAME, :DATE_IN DO BEGIN

          DATE_IN=DATE_IN-1*(1e0/24/60/60);

          INSERT INTO PARK_STATES (PARK_STATE_ID,DRIVER_ID,PARK_ID,DATE_IN,DATE_OUT)
                           VALUES (GET_UNIQUE_ID(),:DRIVER_ID,:PARK_ID,:DATE_IN,NULL);

          BREAK;
        END

        IF (PARK_NAME IS NULL) THEN BEGIN

          INSERT INTO PARK_STATES (PARK_STATE_ID,DRIVER_ID,PARK_ID,DATE_IN,DATE_OUT)
                           VALUES (GET_UNIQUE_ID(),:DRIVER_ID,:PARK_ID,CURRENT_TIMESTAMP,NULL);

          SELECT NAME
            FROM PARKS
           WHERE PARK_ID=:PARK_ID
            INTO :PARK_NAME;

        END

      END

      EXECUTE PROCEDURE EVENT_REFRESH_PARK_STATES('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

      SELECT PHONE, FIRM_ID
        FROM ACCOUNTS
       WHERE ACCOUNT_ID=:DRIVER_ID
        INTO :PHONE, :FIRM_ID;

      SELECT CONST_VALUE FROM GET_CONST_VALUE('7604B1762FDB97EC406174FB54FA13EA') INTO :S;

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL)
       RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

      IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        S=REPLACE_STRING(S,'%PARK_NAME',PARK_NAME);

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                  PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                  :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                  0,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE PR_REFUSE_DRIVER_COME_OUT
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE DRIVER_ID VARCHAR(32);
DECLARE PHONE VARCHAR(100);
DECLARE S VARCHAR(1000);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE IN_MESSAGE_ID VARCHAR(32);
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN

  SELECT DRIVER_ID
    FROM ORDERS
   WHERE ORDER_ID=:ORDER_ID
    INTO :DRIVER_ID;

  IN AUTONOMOUS TRANSACTION DO BEGIN

    UPDATE ORDERS
       SET TYPE_PROCESS=1,
           DATE_END=CURRENT_TIMESTAMP,
           WHO_PROCESS_ID=:ACCOUNT_ID
     WHERE ORDER_ID=:ORDER_ID;

  END

  EXECUTE PROCEDURE EVENT_REFRESH_ORDERS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

  IF (DRIVER_ID IS NOT NULL) THEN BEGIN


    FOR SELECT IN_MESSAGE_ID, TYPE_MESSAGE
          FROM IN_MESSAGES
         WHERE ORDER_ID=:ORDER_ID
           AND CODE_MESSAGE_ID='2D41BEAE73EE84B04F4E6210C399BB63' /* Водитель отказалася от заказа */
           AND SENDER_ID=:DRIVER_ID
           AND DESCRIPTION IS NULL
          INTO :IN_MESSAGE_ID, :TYPE_MESSAGE DO BEGIN

      UPDATE IN_MESSAGES
         SET DESCRIPTION=:ORDER_ID
       WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID;

      BREAK;
    END

    SELECT PHONE, FIRM_ID
      FROM ACCOUNTS
     WHERE ACCOUNT_ID=:DRIVER_ID
      INTO :PHONE, :FIRM_ID;

    SELECT CONST_VALUE FROM GET_CONST_VALUE('2C0BBC7EF7418D934C32D8969D7F2D8C') INTO :S;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,TYPE_MESSAGE)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
    END

  END

END

--

CREATE OR ALTER PROCEDURE PR_REFUSE_DRIVER_CONFIRM
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE DRIVER_ID VARCHAR(32);
DECLARE PARK_ID VARCHAR(32);
DECLARE PHONE VARCHAR(100);
DECLARE S VARCHAR(1000);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE IN_MESSAGE_ID VARCHAR(32);
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN

  SELECT DRIVER_ID
    FROM ORDERS
   WHERE ORDER_ID=:ORDER_ID
    INTO :DRIVER_ID;

  PARK_ID=NULL;

  FOR SELECT PARK_ID
        FROM ORDERS
       WHERE PARENT_ID=:ORDER_ID
       ORDER BY DATE_HISTORY
        INTO :PARK_ID DO BEGIN
    BREAK;
  END

  IN AUTONOMOUS TRANSACTION DO BEGIN

    UPDATE ORDERS
       SET DATE_BEGIN=CURRENT_TIMESTAMP,
           PARK_ID=:PARK_ID,
           DRIVER_ID=NULL,
           CAR_ID=NULL
     WHERE ORDER_ID=:ORDER_ID;

  END

  EXECUTE PROCEDURE EVENT_REFRESH_ORDERS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

  IF (DRIVER_ID IS NOT NULL) THEN BEGIN

    FOR SELECT IN_MESSAGE_ID, TYPE_MESSAGE
          FROM IN_MESSAGES
         WHERE ORDER_ID=:ORDER_ID
           AND CODE_MESSAGE_ID='2D41BEAE73EE84B04F4E6210C399BB63' /* Водитель отказалася от заказа */
           AND SENDER_ID=:DRIVER_ID
           AND DESCRIPTION IS NULL
          INTO :IN_MESSAGE_ID, :TYPE_MESSAGE DO BEGIN

      UPDATE IN_MESSAGES
         SET DESCRIPTION=:ORDER_ID
       WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID;

      BREAK;
    END

    IN AUTONOMOUS TRANSACTION DO BEGIN

      UPDATE PARK_STATES
         SET DATE_OUT=CURRENT_TIMESTAMP
       WHERE DATE_OUT IS NULL
         AND DRIVER_ID=:DRIVER_ID;

    END

    EXECUTE PROCEDURE EVENT_REFRESH_PARK_STATES('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

    SELECT PHONE, FIRM_ID
      FROM ACCOUNTS
     WHERE ACCOUNT_ID=:DRIVER_ID
      INTO :PHONE, :FIRM_ID;

    SELECT CONST_VALUE FROM GET_CONST_VALUE('14AB0F225BEFBBB14E0A5296BEB471A3') INTO :S;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,TYPE_MESSAGE)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
    END

  END

END

--

CREATE OR ALTER PROCEDURE PR_REFUSE_DRIVER_DRIVE_OUT
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE DRIVER_ID VARCHAR(32);
DECLARE PARK_ID VARCHAR(32);
DECLARE PHONE VARCHAR(100);
DECLARE S VARCHAR(1000);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE IN_MESSAGE_ID VARCHAR(32);
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN

  SELECT DRIVER_ID
    FROM ORDERS
   WHERE ORDER_ID=:ORDER_ID
    INTO :DRIVER_ID;

  PARK_ID=NULL;

  FOR SELECT PARK_ID
        FROM ORDERS
       WHERE PARENT_ID=:ORDER_ID
       ORDER BY DATE_HISTORY
        INTO :PARK_ID DO BEGIN
    BREAK;
  END

  IN AUTONOMOUS TRANSACTION DO BEGIN

    UPDATE ORDERS
       SET DATE_BEGIN=CURRENT_TIMESTAMP,
           PARK_ID=:PARK_ID,
           DRIVER_ID=NULL,
           CAR_ID=NULL
     WHERE ORDER_ID=:ORDER_ID;

  END

  EXECUTE PROCEDURE EVENT_REFRESH_ORDERS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

  IF (DRIVER_ID IS NOT NULL) THEN BEGIN

    FOR SELECT IN_MESSAGE_ID, TYPE_MESSAGE
          FROM IN_MESSAGES
         WHERE ORDER_ID=:ORDER_ID
           AND CODE_MESSAGE_ID='2D41BEAE73EE84B04F4E6210C399BB63' /* Водитель отказалася от заказа */
           AND SENDER_ID=:DRIVER_ID
           AND DESCRIPTION IS NULL
          INTO :IN_MESSAGE_ID, :TYPE_MESSAGE DO BEGIN

      UPDATE IN_MESSAGES
         SET DESCRIPTION=:ORDER_ID
       WHERE IN_MESSAGE_ID=:IN_MESSAGE_ID;

      BREAK;
    END

    SELECT PHONE, FIRM_ID
      FROM ACCOUNTS
     WHERE ACCOUNT_ID=:DRIVER_ID
      INTO :PHONE, :FIRM_ID;

    SELECT CONST_VALUE FROM GET_CONST_VALUE('7D5B6BED096187764ECE40FC7D5CB943') INTO :S;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,TYPE_MESSAGE)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
    END

  END

END

--

CREATE OR ALTER PROCEDURE PR_SELECT_DRIVER
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE DRIVER_ID VARCHAR(32);
DECLARE CAR_ID VARCHAR(32);
DECLARE CNT INTEGER;
DECLARE S VARCHAR(1000);
DECLARE ADDRESS VARCHAR(1000);
DECLARE PREFIX VARCHAR(10);
DECLARE STREET VARCHAR(100);
DECLARE HOUSE VARCHAR(10);
DECLARE FLAT VARCHAR(10);
DECLARE PORCH VARCHAR(10);
DECLARE LOCALITY VARCHAR(100);
DECLARE PHONE VARCHAR(100);
DECLARE DATE_ACCEPT TIMESTAMP;
DECLARE DATE_ARRIVAL TIMESTAMP;
DECLARE DATE_BEGIN TIMESTAMP;
DECLARE BEFORE_PERIOD INTEGER;
DECLARE ACTION_ID VARCHAR(32);
DECLARE D TIMESTAMP;
DECLARE DESCRIPTION VARCHAR(250);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN

  SELECT O.DRIVER_ID,
         S.PREFIX, S.NAME, O.HOUSE, O.FLAT, O.PORCH, L.NAME,
         O.DATE_ACCEPT, O.DATE_ARRIVAL, O.BEFORE_PERIOD,
         O.ACTION_ID, O.DATE_BEGIN, O.DESCRIPTION
    FROM ORDERS O
    JOIN STREETS S ON S.STREET_ID=O.STREET_ID
    JOIN LOCALITIES L ON L.LOCALITY_ID=S.LOCALITY_ID
   WHERE O.ORDER_ID=:ORDER_ID
    INTO :DRIVER_ID,
         :PREFIX, :STREET, :HOUSE, :FLAT, :PORCH, :LOCALITY,
         :DATE_ACCEPT, :DATE_ARRIVAL, :BEFORE_PERIOD,
         :ACTION_ID, :DATE_BEGIN, :DESCRIPTION;

  IF (DRIVER_ID IS NOT NULL) THEN BEGIN

    CNT=0;

    SELECT COUNT(*)
      FROM OUT_MESSAGES
     WHERE RECIPIENT_ID=:DRIVER_ID
       AND ORDER_ID=:ORDER_ID
       AND DESCRIPTION=:ACTION_ID
       AND TYPE_MESSAGE=0
       AND DATE_OUT IS NULL
       AND DATE_CREATE>=:DATE_BEGIN
      INTO CNT;

    IF (CNT=0) THEN BEGIN

      SELECT D.CAR_ID, A.PHONE, A.FIRM_ID
        FROM DRIVERS D
        JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
       WHERE D.DRIVER_ID=:DRIVER_ID
        INTO :CAR_ID, :PHONE, :FIRM_ID;

      D=CURRENT_TIMESTAMP;

      IN AUTONOMOUS TRANSACTION DO BEGIN

        UPDATE ORDERS
           SET DRIVER_ID=:DRIVER_ID,
               CAR_ID=:CAR_ID,
               DATE_END=:D,
               WHO_PROCESS_ID=:ACCOUNT_ID
         WHERE ORDER_ID=:ORDER_ID;

      END

      EXECUTE PROCEDURE EVENT_REFRESH_ORDERS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

      ADDRESS='';

      IF (PREFIX IS NOT NULL) THEN
        ADDRESS=PREFIX||' ';

      ADDRESS=ADDRESS||STREET||' '||HOUSE;

      IF (FLAT IS NOT NULL) THEN
        ADDRESS=ADDRESS||'-'||FLAT;

      IF (PORCH IS NOT NULL) THEN
        ADDRESS=ADDRESS||' п.'||PORCH;

      IF ((LOCALITY IS NOT NULL) AND (LOCALITY<>'Красноярск')) THEN
        ADDRESS=ADDRESS||', '||LOCALITY;

      IF (DATE_ACCEPT<DATE_ARRIVAL) THEN BEGIN

        IF ((DATE_ACCEPT+(BEFORE_PERIOD*(1e0/24/60)))<DATE_ARRIVAL) THEN BEGIN

          SELECT CONST_VALUE FROM GET_CONST_VALUE('2A773F389AD895B94010252F1DC6D3CC') INTO :S;

        END ELSE BEGIN

          SELECT CONST_VALUE FROM GET_CONST_VALUE('051BE1C8C28F9DB34EAA8DD46E0DA3B4') INTO :S;

        END

      END ELSE BEGIN

        SELECT CONST_VALUE FROM GET_CONST_VALUE('CD5055A23D04B51641F3211814253430') INTO :S;

      END

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL)
       RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

      IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        S=REPLACE_STRING(S,'%TIME',FORMAT_DATETIME('hh:nn',DATE_ARRIVAL));
        S=REPLACE_STRING(S,'%ADDRESS',ADDRESS);

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                  PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,:D,
                                  :S,NULL,:TYPE_MESSAGE,:PHONE,:ACTION_ID,
                                  0,NULL,:D,:ORDER_ID,:DEST_PORT,:FIRM_ID);

        IF ((DESCRIPTION IS NOT NULL) AND (TRIM(DESCRIPTION)<>'')) THEN BEGIN

          S=DESCRIPTION;

          D=D+1*(1e0/24/60/60);

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                    PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,:D,
                                    :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                    0,NULL,:D,:ORDER_ID,:DEST_PORT,:FIRM_ID);
        END

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE QUERY_PARK_STATES
(
  ORDER_ID VARCHAR(32),
  CREATOR_ID VARCHAR(32),
  RECIPIENT_ID VARCHAR(32),
  CONTACT VARCHAR(100),
  TYPE_MESSAGE INTEGER
)
AS
  DECLARE S VARCHAR(1000);
  DECLARE F VARCHAR(1000);
  DECLARE S1 VARCHAR(1000);
  DECLARE PARK_NAME VARCHAR(100);
  DECLARE CNT INTEGER;
  DECLARE DEST_PORT INTEGER;
  DECLARE FIRM_ID VARCHAR(32);
BEGIN
  IF ((CREATOR_ID IS NOT NULL) AND (CONTACT IS NOT NULL)) THEN BEGIN

    S='';

    SELECT CONST_VALUE FROM GET_CONST_VALUE('A3D890F68FF0BDCC4B42C3135174ABEF') INTO :F;

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(CREATOR_ID,TYPE_MESSAGE)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    IF ((F IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

      FOR SELECT P.NAME,
                 (SELECT COUNT(*)
                    FROM PARK_STATES PS
                   WHERE PS.DATE_OUT IS NULL
                     AND PS.PARK_ID=P.PARK_ID)
            FROM PARKS P
           ORDER BY P.PRIORITY
            INTO :PARK_NAME, :CNT DO BEGIN

        S1=F;
        S1=REPLACE_STRING(S1,'%PARK_NAME',PARK_NAME);
        S1=REPLACE_STRING(S1,'%COUNT',CAST(CNT AS VARCHAR(10)));
        S=S||S1;

      END

      SELECT FIRM_ID
        FROM ACCOUNTS
       WHERE ACCOUNT_ID=:CREATOR_ID
        INTO :FIRM_ID;

      INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                        VALUES (GET_UNIQUE_ID(),:CREATOR_ID,:RECIPIENT_ID,CURRENT_TIMESTAMP,
                               :S,NULL,:TYPE_MESSAGE,:CONTACT,NULL,
                               1,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
    END

  END

END

--

CREATE OR ALTER PROCEDURE TASK_BALANCE_REMINDER
(
  TASK_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE DRIVER_ID VARCHAR(32);
DECLARE PHONE VARCHAR(100);
DECLARE NAME VARCHAR(100);
DECLARE PATRONYMIC VARCHAR(100);
DECLARE S VARCHAR(1000);
DECLARE S1 VARCHAR(1000);
DECLARE D TIMESTAMP;
DECLARE CNT INTEGER;
DECLARE SUM_CHARGE NUMERIC(15,2);
DECLARE SUM_RECEIPT NUMERIC(15,2);
DECLARE BALANCE NUMERIC(15,2);
DECLARE MIN_BALANCE NUMERIC(15,2);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN

  SELECT CONST_VALUE FROM GET_CONST_VALUE('F0532713CEE09A984B2D52D050A58EF0') INTO :S;

  IF (S IS NOT NULL) THEN BEGIN

    D=CURRENT_TIMESTAMP;

    FOR SELECT D.DRIVER_ID, A.PHONE, A.NAME, A.PATRONYMIC, A.FIRM_ID
          FROM DRIVERS D
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
         WHERE A.LOCKED<>1
          INTO :DRIVER_ID, :PHONE, :NAME, :PATRONYMIC, :FIRM_ID DO BEGIN

      EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:DRIVER_ID)
       RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

      IF (BALANCE<0) THEN BEGIN

        EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL)
         RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

        IF (TYPE_MESSAGE IS NOT NULL) THEN BEGIN
        
          S1=S;
          S1=REPLACE_STRING(S1,'%BALANCE',CAST(BALANCE AS VARCHAR(30)));
          S1=REPLACE_STRING(S1,'-','');

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                    LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                    :S1,NULL,:TYPE_MESSAGE,:PHONE,NULL,2,
                                    NULL,:D,:DEST_PORT,:FIRM_ID);

          D=D+5*(1e0/24/60/60);
        END

      END

    END

  END

END

--

DROP PROCEDURE TASK_DRIVE_LOCK

--

CREATE OR ALTER PROCEDURE TASK_CHANGE_PRIORITY
(
  TASK_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE DRIVER_ID VARCHAR(32);
DECLARE PHONE VARCHAR(100);
DECLARE NAME VARCHAR(100);
DECLARE PATRONYMIC VARCHAR(100);
DECLARE S VARCHAR(1000);
DECLARE S1 VARCHAR(1000);
DECLARE D TIMESTAMP;
DECLARE CNT INTEGER;
DECLARE NEW_PRIORITY INTEGER;
DECLARE PRIORITY INTEGER;
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN

  SELECT CONST_VALUE FROM GET_CONST_VALUE('6C5F5E35B4F0B54A470F466044C8EB3F') INTO :S;

  IF (S IS NOT NULL) THEN BEGIN

    D=CURRENT_TIMESTAMP;

    FOR SELECT D.DRIVER_ID, D.PRIORITY,
               A.PHONE, A.NAME, A.PATRONYMIC, A.FIRM_ID
          FROM DRIVERS D
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
         WHERE A.LOCKED<>1
           AND D.DATE_PRIORITY IS NOT NULL
           AND D.DATE_PRIORITY<=CURRENT_DATE
          INTO :DRIVER_ID, :PRIORITY,
               :PHONE, :NAME, :PATRONYMIC, :FIRM_ID DO BEGIN

      SELECT COUNT(*)
        FROM ORDERS
       WHERE DRIVER_ID=:DRIVER_ID
         AND FINISHED=1
         AND PARENT_ID IS NULL
         AND RESULT_ID IN ('6DD8DFDC671DB9A742E418FD268E7DC4','E03D43E2E5B4AEEE4416B997D888FC71','B01126058AE48A354BBF0472888819A3')
         AND DATE_ACCEPT>=(CURRENT_TIMESTAMP-7*24*60*60*(1e0/24/60/60))
        INTO :CNT;

      IF ((CNT>=0) AND (CNT<=30)) THEN
        NEW_PRIORITY=2;

      IF (CNT>30) THEN
        NEW_PRIORITY=1;

      IF (PRIORITY<>NEW_PRIORITY) THEN BEGIN

        PRIORITY=NEW_PRIORITY;

        UPDATE DRIVERS
           SET PRIORITY=:PRIORITY
         WHERE DRIVER_ID=:DRIVER_ID;


        EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL)
         RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

        IF (TYPE_MESSAGE IS NOT NULL) THEN BEGIN

          S1=S;
          S1=REPLACE_STRING(S1,'%PRIORITY',PRIORITY);
          S1=REPLACE_STRING(S1,'%ORDER_COUNT',CNT);

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                    LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                    :S1,NULL,:TYPE_MESSAGE,:PHONE,NULL,2,
                                    NULL,:D,:DEST_PORT,:FIRM_ID);
          D=D+5*(1e0/24/60/60);
          
        END

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE TASK_DRIVER_LOCK
(
  TASK_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE DRIVER_ID VARCHAR(32);
DECLARE S VARCHAR(1000);
DECLARE S1 VARCHAR(1000);
DECLARE D TIMESTAMP;
DECLARE DATE_END TIMESTAMP;
DECLARE PHONE VARCHAR(100);
DECLARE CNT INTEGER;
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN

  SELECT CONST_VALUE FROM GET_CONST_VALUE('2D1BA9876918B7CE42515B204A6020AB') INTO :S;

  IF (S IS NOT NULL) THEN BEGIN

    D=CURRENT_TIMESTAMP;

    FOR SELECT D.DRIVER_ID, A.PHONE, A.FIRM_ID
          FROM DRIVERS D
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
         WHERE A.LOCKED<>1
          INTO :DRIVER_ID, :PHONE, :FIRM_ID DO BEGIN

      SELECT MAX(DATE_END)
        FROM SHIFTS
       WHERE ACCOUNT_ID=:DRIVER_ID
        INTO :DATE_END;

      SELECT COUNT(*)
        FROM SHIFTS
       WHERE ACCOUNT_ID=:DRIVER_ID
         AND DATE_END IS NULL
        INTO :CNT;

      IF ((CNT=0) AND (DATE_END IS NOT NULL) AND
          (DATE_END<(CURRENT_TIMESTAMP-7*24*60*60*(1e0/24/60/60)))) THEN BEGIN

        UPDATE ACCOUNTS
           SET LOCKED=1
         WHERE ACCOUNT_ID=:DRIVER_ID;

        EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL)
         RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

        IF (TYPE_MESSAGE IS NOT NULL) THEN BEGIN

          S1=S;

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                    LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                    :S1,NULL,:TYPE_MESSAGE,:PHONE,NULL,2,
                                    NULL,:D,:DEST_PORT,:FIRM_ID);
          D=D+5*(1e0/24/60/60);
          
        END

      END

    END

  END

END

--

UPDATE TASKS
SET PROC_NAME='TASK_DRIVER_LOCK'
WHERE PROC_NAME='TASK_DRIVE_LOCK'

--

CREATE OR ALTER PROCEDURE TASK_HAPPY_BIRTHDAY
(
  TASK_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE RECIPIENT_ID VARCHAR(32);
DECLARE PHONE VARCHAR(100);
DECLARE NAME VARCHAR(100);
DECLARE PATRONYMIC VARCHAR(100);
DECLARE S VARCHAR(1000);
DECLARE S1 VARCHAR(1000);
DECLARE D TIMESTAMP;
DECLARE CURRENT_DAY INTEGER;
DECLARE CURRENT_MONTH INTEGER;
DECLARE RECEIPT_TYPE_ID VARCHAR(32);
DECLARE SUM_RECEIPT NUMERIC(15,0);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN

  D=CURRENT_TIMESTAMP;

  CURRENT_DAY=EXTRACT(DAY FROM D);
  CURRENT_MONTH=EXTRACT(MONTH FROM D);

  SELECT CONST_VALUE FROM GET_CONST_VALUE('8CDCC7F96A988CA2432AA812964351F3') INTO :S;

  IF (S IS NOT NULL) THEN BEGIN

    FOR SELECT A.ACCOUNT_ID, A.PHONE, A.NAME, A.PATRONYMIC, A.FIRM_ID
          FROM DISPATCHERS D
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DISPATCHER_ID
         WHERE A.LOCKED<>1
           AND EXTRACT(DAY FROM D.DATE_BIRTH)=:CURRENT_DAY
           AND EXTRACT(MONTH FROM D.DATE_BIRTH)=:CURRENT_MONTH
          INTO :RECIPIENT_ID, :PHONE, :NAME, :PATRONYMIC, :FIRM_ID DO BEGIN


      EXECUTE PROCEDURE GET_TYPE_MESSAGE(RECIPIENT_ID,NULL)
       RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

      IF (TYPE_MESSAGE IS NOT NULL) THEN BEGIN

        S1=S;
        S1=REPLACE_STRING(S1,'%NAME',NAME);
        S1=REPLACE_STRING(S1,'%PATRONYMIC',PATRONYMIC);

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                  LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:RECIPIENT_ID,CURRENT_TIMESTAMP,
                                  :S1,NULL,:TYPE_MESSAGE,:PHONE,NULL,2,
                                  NULL,:D,:DEST_PORT,:FIRM_ID);

        D=D+5*(1e0/24/60/60);
        
      END
    END

  END

  SELECT CONST_VALUE FROM GET_CONST_VALUE('AF2D42CDBD398AFC4E0A988E3C57EF84') INTO :S;

  RECEIPT_TYPE_ID='771A20E1595D97694D7905B0A3D70FF9'; /* День рождения водителя */

  SELECT SUM_RECEIPT
    FROM RECEIPT_TYPES
   WHERE RECEIPT_TYPE_ID=:RECEIPT_TYPE_ID
    INTO :SUM_RECEIPT;

  IF ((S IS NOT NULL) AND (SUM_RECEIPT IS NOT NULL)) THEN BEGIN

    FOR SELECT A.ACCOUNT_ID, A.PHONE, A.NAME, A.PATRONYMIC, A.FIRM_ID
          FROM DRIVERS D
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
         WHERE A.LOCKED<>1
           AND EXTRACT(DAY FROM D.DATE_BIRTH)=:CURRENT_DAY
           AND EXTRACT(MONTH FROM D.DATE_BIRTH)=:CURRENT_MONTH
          INTO :RECIPIENT_ID, :PHONE, :NAME, :PATRONYMIC, :FIRM_ID DO BEGIN

     INSERT INTO RECEIPTS (RECEIPT_ID,RECEIPT_TYPE_ID,ACCOUNT_ID,WHO_CREATE_ID,
                           SUM_RECEIPT,DATE_RECEIPT,DATE_CREATE,DESCRIPTION,FIRM_ID)
                   VALUES (GET_UNIQUE_ID(),:RECEIPT_TYPE_ID,:RECIPIENT_ID,:ACCOUNT_ID,
                           :SUM_RECEIPT,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,NULL,:FIRM_ID);

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(RECIPIENT_ID,NULL)
       RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

      IF (TYPE_MESSAGE IS NOT NULL) THEN BEGIN

        S1=S;
        S1=REPLACE_STRING(S1,'%NAME',NAME);
        S1=REPLACE_STRING(S1,'%PATRONYMIC',PATRONYMIC);
        S1=REPLACE_STRING(S1,'%SUM_RECEIPT',SUM_RECEIPT);

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                  LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:RECIPIENT_ID,CURRENT_TIMESTAMP,
                                  :S1,NULL,:TYPE_MESSAGE,:PHONE,NULL,2,
                                  NULL,:D,:DEST_PORT,:FIRM_ID);

        D=D+5*(1e0/24/60/60);
      END

    END

  END

  SELECT CONST_VALUE FROM GET_CONST_VALUE('3796835EECA2A1024C539A9BC0DAAD01') INTO :S;

  RECEIPT_TYPE_ID='9088327EC6DB8B544CF127CDCA60BFBA'; /* День рождения клиента */

  SELECT SUM_RECEIPT
    FROM RECEIPT_TYPES
   WHERE RECEIPT_TYPE_ID=:RECEIPT_TYPE_ID
    INTO :SUM_RECEIPT;
    
  IF ((S IS NOT NULL) AND (SUM_RECEIPT IS NOT NULL)) THEN BEGIN

    FOR SELECT A.ACCOUNT_ID, A.PHONE, A.NAME, A.PATRONYMIC
          FROM CLIENTS C
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=C.CLIENT_ID
         WHERE A.LOCKED<>1
           AND EXTRACT(DAY FROM C.DATE_BIRTH)=:CURRENT_DAY
           AND EXTRACT(MONTH FROM C.DATE_BIRTH)=:CURRENT_MONTH
           AND C.CALC_ID IS NOT NULL
          INTO :RECIPIENT_ID, :PHONE, :NAME, :PATRONYMIC DO BEGIN

      FIRM_ID=NULL; /* Кто будет начислять непонятно */

      INSERT INTO RECEIPTS (RECEIPT_ID,RECEIPT_TYPE_ID,ACCOUNT_ID,WHO_CREATE_ID,
                            SUM_RECEIPT,DATE_RECEIPT,DATE_CREATE,DESCRIPTION,FIRM_ID)
                    VALUES (GET_UNIQUE_ID(),:RECEIPT_TYPE_ID,:RECIPIENT_ID,:ACCOUNT_ID,
                            :SUM_RECEIPT,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,NULL,:FIRM_ID);

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(RECIPIENT_ID,NULL)
       RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

      IF (TYPE_MESSAGE IS NOT NULL) THEN BEGIN

        S1=S;
        S1=REPLACE_STRING(S1,'%NAME',NAME);
        S1=REPLACE_STRING(S1,'%PATRONYMIC',PATRONYMIC);
        S1=REPLACE_STRING(S1,'%SUM_RECEIPT',SUM_RECEIPT);

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                  LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:RECIPIENT_ID,CURRENT_TIMESTAMP,
                                  :S1,NULL,:TYPE_MESSAGE,:PHONE,NULL,2,
                                  NULL,:D,:DEST_PORT,:FIRM_ID);

        D=D+5*(1e0/24/60/60);

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE TASK_SHIFT_CHARGE
(
  TASK_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE DRIVER_ID VARCHAR(32);
DECLARE PHONE VARCHAR(100);
DECLARE NAME VARCHAR(100);
DECLARE PATRONYMIC VARCHAR(100);
DECLARE S VARCHAR(1000);
DECLARE S1 VARCHAR(1000);
DECLARE D TIMESTAMP;
DECLARE DAY_HOUR INTEGER;
DECLARE WEEK_DAY INTEGER;
DECLARE CNT INTEGER;
DECLARE SUM_CHARGE NUMERIC(15,2);
DECLARE CHARGE_TYPE_ID VARCHAR(32);
DECLARE SUM_RECEIPT NUMERIC(15,2);
DECLARE BALANCE NUMERIC(15,2);
DECLARE MIN_BALANCE NUMERIC(15,2);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN

  SELECT CONST_VALUE FROM GET_CONST_VALUE('118C2CC432E5B9B44A9BF94757EC2EDE') INTO :S;

  IF (S IS NOT NULL) THEN BEGIN

    D=CURRENT_TIMESTAMP;

    FOR SELECT D.DRIVER_ID, A.PHONE, A.NAME, A.PATRONYMIC,
               D.MIN_BALANCE, A.FIRM_ID
          FROM DRIVERS D
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
         WHERE A.LOCKED<>1
           AND D.DATE_SCHEDULE IS NOT NULL
           AND D.DATE_SCHEDULE<=CURRENT_DATE
          INTO :DRIVER_ID, :PHONE, :NAME, :PATRONYMIC,
               :MIN_BALANCE, :FIRM_ID DO BEGIN

      WEEK_DAY=EXTRACT(WEEKDAY FROM CURRENT_TIMESTAMP)-1;
      IF (WEEK_DAY<0) THEN
        WEEK_DAY=6;

      DAY_HOUR=EXTRACT(HOUR FROM CURRENT_TIMESTAMP);

      SELECT COUNT(*)
        FROM DRIVER_WEEK_SCHEDULES
       WHERE WEEK_DAY=:WEEK_DAY
         AND DAY_HOUR=:DAY_HOUR
         AND DRIVER_ID=:DRIVER_ID
        INTO :CNT;

      IF (CNT>0) THEN BEGIN

        SELECT COUNT(*)
          FROM SHIFTS
         WHERE DATE_END IS NULL
           AND ACCOUNT_ID=:DRIVER_ID
           AND DATE_BEGIN<=CURRENT_TIMESTAMP
          INTO :CNT;

        IF (CNT=0) THEN BEGIN

          EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:DRIVER_ID)
           RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

          IF ((MIN_BALANCE IS NULL) OR ((MIN_BALANCE IS NOT NULL) AND (BALANCE>MIN_BALANCE))) THEN BEGIN

            SUM_CHARGE=NULL;
            CHARGE_TYPE_ID='CF012E53C5C9A03E4A7F03194B84DA49'; /* Не выполнение графика */

            SELECT SUM_CHARGE
              FROM CHARGE_TYPES
             WHERE CHARGE_TYPE_ID=:CHARGE_TYPE_ID
              INTO :SUM_CHARGE;

            EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL)
             RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

            IF ((SUM_CHARGE IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

              INSERT INTO CHARGES (CHARGE_ID,WHO_CREATE_ID,CHARGE_TYPE_ID,ACCOUNT_ID,
                                   SUM_CHARGE,DATE_CHARGE,DATE_CREATE,DESCRIPTION,FIRM_ID)
                           VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:CHARGE_TYPE_ID,:DRIVER_ID,
                                   :SUM_CHARGE,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,NULL,:FIRM_ID);

              S1=S;
              S1=REPLACE_STRING(S1,'%SUM_CHARGE',CAST(SUM_CHARGE AS VARCHAR(30)));

              INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                        TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                        PRIORITY,LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                                VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                        :S1,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                        1,NULL,:D,:DEST_PORT,:FIRM_ID);

              D=D+5*(1e0/24/60/60);

            END

          END

        END

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE TASK_SHIFT_CLOSE
(
  SESSION_ID VARCHAR(32),
  TASK_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE DRIVER_ID VARCHAR(32);
DECLARE PHONE VARCHAR(100);
DECLARE NAME VARCHAR(100);
DECLARE PATRONYMIC VARCHAR(100);
DECLARE S VARCHAR(1000);
DECLARE S1 VARCHAR(1000);
DECLARE D TIMESTAMP;
DECLARE D1 TIMESTAMP;
DECLARE SHIFT_BEGIN TIMESTAMP;
DECLARE PARK_IN TIMESTAMP;
DECLARE PARK_OUT TIMESTAMP;
DECLARE CNT INTEGER;
DECLARE DATE_END TIMESTAMP;
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN

  SELECT CONST_VALUE FROM GET_CONST_VALUE('4D39D8318FB6B77F42241D2B1336B192') INTO :S;

  IF (S IS NOT NULL) THEN BEGIN

    D=CURRENT_TIMESTAMP;

    FOR SELECT D.DRIVER_ID, A.PHONE, A.NAME, A.PATRONYMIC, A.FIRM_ID
          FROM DRIVERS D
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
         WHERE A.LOCKED<>1
          INTO :DRIVER_ID, :PHONE, :NAME, :PATRONYMIC, :FIRM_ID DO BEGIN

      SELECT MAX(DATE_BEGIN)
        FROM SHIFTS
       WHERE DATE_END IS NULL
         AND ACCOUNT_ID=:DRIVER_ID
        INTO :SHIFT_BEGIN;

      IF (SHIFT_BEGIN IS NOT NULL) THEN BEGIN

        D1=CURRENT_TIMESTAMP-90*60*(1e0/24/60/60);

        SELECT MAX(DATE_IN), MAX(DATE_OUT)
          FROM PARK_STATES
         WHERE DRIVER_ID=:DRIVER_ID
          INTO :PARK_IN, :PARK_OUT;

        IF (PARK_IN IS NULL) THEN BEGIN
          PARK_IN=SHIFT_BEGIN;
          PARK_OUT=PARK_IN;
        END

        SELECT COUNT(*)
          FROM PARK_STATES
         WHERE DRIVER_ID=:DRIVER_ID
           AND DATE_OUT IS NULL
          INTO :CNT;
                                 
        IF ((CNT=0) AND (D1>PARK_IN) AND (D1>PARK_OUT) AND (D1>SHIFT_BEGIN)) THEN BEGIN

          SELECT COUNT(*)
            FROM ORDERS
           WHERE DRIVER_ID=:DRIVER_ID
             AND FINISHED<>1
             AND PARENT_ID IS NULL
            INTO :CNT;

          IF (CNT=0) THEN BEGIN

            SELECT MAX(DATE_END)
              FROM ORDERS
             WHERE DRIVER_ID=:DRIVER_ID
               AND FINISHED=1
               AND PARENT_ID IS NULL
               AND DATE_END IS NOT NULL
              INTO :DATE_END;

            IF (DATE_END IS NULL) THEN
              DATE_END=SHIFT_BEGIN;

            IF (D1>DATE_END) THEN BEGIN

              IN AUTONOMOUS TRANSACTION DO BEGIN

                UPDATE SHIFTS
                   SET DATE_END=CURRENT_TIMESTAMP
                 WHERE DATE_END IS NULL
                   AND ACCOUNT_ID=:DRIVER_ID;

              END

              EXECUTE PROCEDURE EVENT_REFRESH_SHIFTS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

              EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL)
               RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

              IF (TYPE_MESSAGE IS NOT NULL) THEN BEGIN
                S1=S;

                INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                          TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                          LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                                  VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                          :S1,NULL,:TYPE_MESSAGE,:PHONE,NULL,2,
                                          NULL,:D,:DEST_PORT,:FIRM_ID);

                D=D+5*(1e0/24/60/60);
              END

            END

          END

        END

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE TASK_SHIFT_LOCK
(
  TASK_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE DRIVER_ID VARCHAR(32);
DECLARE PHONE VARCHAR(100);
DECLARE NAME VARCHAR(100);
DECLARE PATRONYMIC VARCHAR(100);
DECLARE S VARCHAR(1000);
DECLARE S1 VARCHAR(1000);
DECLARE D TIMESTAMP;
DECLARE DAY_HOUR INTEGER;
DECLARE WEEK_DAY INTEGER;
DECLARE CNT INTEGER;
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN

  SELECT CONST_VALUE FROM GET_CONST_VALUE('21EF7AF84E37B7D64BAA8AE4CA871855') INTO :S;

  IF (S IS NOT NULL) THEN BEGIN

    D=CURRENT_TIMESTAMP;

    FOR SELECT D.DRIVER_ID, A.PHONE, A.NAME, A.PATRONYMIC, A.FIRM_ID
          FROM DRIVERS D
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
         WHERE A.LOCKED<>1
           AND D.DATE_SCHEDULE IS NOT NULL
           AND D.DATE_SCHEDULE<=CURRENT_DATE
          INTO :DRIVER_ID, :PHONE, :NAME, :PATRONYMIC, :FIRM_ID DO BEGIN

      WEEK_DAY=EXTRACT(WEEKDAY FROM CURRENT_TIMESTAMP)-1;
      IF (WEEK_DAY<0) THEN
        WEEK_DAY=6;

      DAY_HOUR=EXTRACT(HOUR FROM CURRENT_TIMESTAMP);

      SELECT COUNT(*)
        FROM DRIVER_WEEK_SCHEDULES
       WHERE WEEK_DAY=:WEEK_DAY
         AND DAY_HOUR=:DAY_HOUR
         AND DRIVER_ID=:DRIVER_ID
        INTO :CNT;

      IF (CNT>0) THEN BEGIN

        SELECT COUNT(*)
          FROM SHIFTS
         WHERE DATE_END IS NULL
           AND ACCOUNT_ID=:DRIVER_ID
           AND DATE_BEGIN<=CURRENT_TIMESTAMP
          INTO :CNT;

        EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL)
         RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

        IF ((CNT=0) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

          UPDATE ACCOUNTS
             SET LOCKED=1
           WHERE ACCOUNT_ID=:DRIVER_ID;

          S1=S;

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                    PRIORITY,LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                    :S1,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                    1,NULL,:D,:DEST_PORT,:FIRM_ID);

          D=D+5*(1e0/24/60/60);

        END

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE TASK_SHIFT_REMINDER
(
  TASK_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32)
)
AS
DECLARE DRIVER_ID VARCHAR(32);
DECLARE PHONE VARCHAR(100);
DECLARE NAME VARCHAR(100);
DECLARE PATRONYMIC VARCHAR(100);
DECLARE S VARCHAR(1000);
DECLARE S1 VARCHAR(1000);
DECLARE D TIMESTAMP;
DECLARE DTIME TIMESTAMP;
DECLARE DAY_HOUR INTEGER;
DECLARE WEEK_DAY INTEGER;
DECLARE CNT INTEGER;
DECLARE SUM_CHARGE NUMERIC(15,2);
DECLARE SUM_RECEIPT NUMERIC(15,2);
DECLARE BALANCE NUMERIC(15,2);
DECLARE MIN_BALANCE NUMERIC(15,2);
DECLARE TYPE_MESSAGE INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN

  SELECT CONST_VALUE FROM GET_CONST_VALUE('FDBF450952CB8E8A40A38BD5122034B3') INTO :S;

  IF (S IS NOT NULL) THEN BEGIN

    D=CURRENT_TIMESTAMP;

    FOR SELECT D.DRIVER_ID, A.PHONE, A.NAME, A.PATRONYMIC, D.MIN_BALANCE, A.FIRM_ID
          FROM DRIVERS D
          JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
         WHERE A.LOCKED<>1
           AND D.DATE_SCHEDULE IS NOT NULL
           AND D.DATE_SCHEDULE<=CURRENT_DATE
          INTO :DRIVER_ID, :PHONE, :NAME, :PATRONYMIC, :MIN_BALANCE, :FIRM_ID DO BEGIN

      WEEK_DAY=EXTRACT(WEEKDAY FROM CURRENT_TIMESTAMP)-1;
      IF (WEEK_DAY<0) THEN
        WEEK_DAY=6;

      DAY_HOUR=EXTRACT(HOUR FROM CURRENT_TIMESTAMP)+1;
      IF (DAY_HOUR>23) THEN BEGIN
        DAY_HOUR=0;
        WEEK_DAY=WEEK_DAY+1;
        IF (WEEK_DAY>6) THEN
          WEEK_DAY=0;
      END

      SELECT COUNT(*)
        FROM DRIVER_WEEK_SCHEDULES
       WHERE WEEK_DAY=:WEEK_DAY
         AND DAY_HOUR=:DAY_HOUR
         AND DRIVER_ID=:DRIVER_ID
        INTO :CNT;

      IF (CNT>0) THEN BEGIN

        SELECT COUNT(*)
          FROM SHIFTS
         WHERE DATE_END IS NULL
           AND ACCOUNT_ID=:DRIVER_ID
           AND DATE_BEGIN<=CURRENT_TIMESTAMP
          INTO :CNT;

        IF (CNT=0) THEN BEGIN

          EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(DRIVER_ID)
           RETURNING_VALUES SUM_CHARGE, SUM_RECEIPT, BALANCE;

          EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,NULL)
           RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

          IF (((MIN_BALANCE IS NULL) OR ((MIN_BALANCE IS NOT NULL) AND (BALANCE>MIN_BALANCE))) AND
             (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

            DTIME=CAST((CAST(DAY_HOUR AS VARCHAR(2))||':00') AS TIME);

            S1=S;
            S1=REPLACE_STRING(S1,'%NAME',NAME);
            S1=REPLACE_STRING(S1,'%PATRONYMIC',PATRONYMIC);
            S1=REPLACE_STRING(S1,'%TIME',FORMAT_DATETIME('hh:nn',DTIME));

            INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                      TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,PRIORITY,
                                      LOCKED,DATE_BEGIN,DEST_PORT,FIRM_ID)
                              VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                      :S1,NULL,:TYPE_MESSAGE,:PHONE,NULL,1,
                                      NULL,:D,:DEST_PORT,:FIRM_ID);

            D=D+5*(1e0/24/60/60);

          END

        END

      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE TRY_PARK_IN
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACCOUNT_ID VARCHAR(32),
  DRIVER_ID VARCHAR(32),
  CODE VARCHAR(100),
  TYPE_MESSAGE INTEGER
)
AS
DECLARE S VARCHAR(1000);
DECLARE PHONE VARCHAR(100);
DECLARE CNT INTEGER;
DECLARE SUM_CHARGE NUMERIC(15,2);
DECLARE SUM_RECEIPT NUMERIC(15,2);
DECLARE BALANCE NUMERIC(15,2);
DECLARE MIN_BALANCE NUMERIC(15,2);
DECLARE D TIMESTAMP;
DECLARE PARK_ID VARCHAR(32);
DECLARE PARK_NAME VARCHAR(100);
DECLARE PARK_DESCRIPTION VARCHAR(250);
DECLARE PRIORITY INTEGER;
DECLARE DEST_PORT INTEGER;
DECLARE FIRM_ID VARCHAR(32);
BEGIN

  IF ((DRIVER_ID IS NOT NULL) AND (CODE IS NOT NULL)) THEN BEGIN

    EXECUTE PROCEDURE GET_TYPE_MESSAGE(DRIVER_ID,TYPE_MESSAGE)
     RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

    SELECT A.PHONE, A.FIRM_ID
      FROM DRIVERS D
      JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
     WHERE D.DRIVER_ID=:DRIVER_ID
       AND A.LOCKED<>1
      INTO :PHONE, :FIRM_ID;

    IF (PHONE IS NOT NULL) THEN BEGIN

      EXECUTE PROCEDURE GET_ACCOUNT_BALANCE(:DRIVER_ID)
       RETURNING_VALUES :SUM_CHARGE, :SUM_RECEIPT, :BALANCE;

      SELECT MIN_BALANCE
        FROM DRIVERS
       WHERE DRIVER_ID=:DRIVER_ID
        INTO :MIN_BALANCE;

      IF ((MIN_BALANCE IS NULL) OR ((MIN_BALANCE IS NOT NULL) AND (BALANCE>MIN_BALANCE))) THEN BEGIN

        SELECT COUNT(*)
          FROM ORDERS
         WHERE DRIVER_ID=:DRIVER_ID
           AND PARENT_ID IS NULL
           AND DATE_HISTORY IS NULL
           AND FINISHED<>1
          INTO :CNT;

        IF (CNT>0) THEN BEGIN

          SELECT CONST_VALUE FROM GET_CONST_VALUE('764B2BA8498AB18345852AA2FE39F4D9') INTO :S;

          IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

            INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                      TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                      PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                              VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                      :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                      2,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
          END

        END ELSE BEGIN

          IN AUTONOMOUS TRANSACTION DO BEGIN

            UPDATE PARK_STATES
               SET DATE_OUT=CURRENT_TIMESTAMP
             WHERE DRIVER_ID=:DRIVER_ID
               AND DATE_OUT IS NULL;

            SELECT COUNT(*)
              FROM SHIFTS
             WHERE ACCOUNT_ID=:DRIVER_ID
               AND DATE_END IS NULL
              INTO :CNT;

            D=CURRENT_TIMESTAMP;

            IF (CNT=0) THEN BEGIN

              INSERT INTO SHIFTS (SHIFT_ID,ACCOUNT_ID,DATE_BEGIN,DATE_END)
                          VALUES (GET_UNIQUE_ID(),:DRIVER_ID,:D,NULL);

            END

            PARK_ID=NULL;
            PARK_NAME=NULL;

            FOR SELECT P.PARK_ID, P.NAME, P.DESCRIPTION
                  FROM PARKS P
                 WHERE (((P.MAX_COUNT IS NOT NULL) AND
                         (P.MAX_COUNT> (SELECT COUNT(*)
                                          FROM PARK_STATES
                                         WHERE DATE_OUT IS NULL
                                           AND PARK_ID=P.PARK_ID)))
                        OR (P.MAX_COUNT IS NULL))
                   AND P.NAME=:CODE
                  INTO :PARK_ID, :PARK_NAME, :PARK_DESCRIPTION  DO BEGIN
              BREAK;
            END

            IF (PARK_ID IS NOT NULL) THEN BEGIN

              INSERT INTO PARK_STATES (PARK_STATE_ID,PARK_ID,DRIVER_ID,DATE_IN,DATE_OUT)
                               VALUES (GET_UNIQUE_ID(),:PARK_ID,:DRIVER_ID,:D,NULL);

              SELECT COUNT(*)
                FROM PARK_STATES
               WHERE PARK_ID=:PARK_ID
                 AND DATE_OUT IS NULL
                INTO PRIORITY;

              SELECT CONST_VALUE FROM GET_CONST_VALUE('80627FCA459EA3574F6BA8730F32946F') INTO :S;

              IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

                S=REPLACE_STRING(S,'%PRIORITY',CAST(PRIORITY AS VARCHAR(10)));
                S=REPLACE_STRING(S,'%PARK_NAME',PARK_NAME);
                S=REPLACE_STRING(S,'%PARK_DESCRIPTION',PARK_DESCRIPTION);
                S=REPLACE_STRING(S,'%BALANCE',CAST(BALANCE AS VARCHAR(30)));

                INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                          TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                          PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                                  VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                          :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                          1,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
              END

            END ELSE BEGIN

              SELECT CONST_VALUE FROM GET_CONST_VALUE('18B1E217D3789DDF4BCE1EEE9C7AB7A5') INTO :S;

              IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

                INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                          TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                          PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                                  VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                          :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                          1,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
              END

            END

          END

          EXECUTE PROCEDURE EVENT_REFRESH_SHIFTS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

          EXECUTE PROCEDURE EVENT_REFRESH_PARK_STATES('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

        END

      END ELSE BEGIN

        SELECT CONST_VALUE FROM GET_CONST_VALUE('0690BD9649C89DD8472558C3270F35D6') INTO :S;

        IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

          INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                    TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                    PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                            VALUES (GET_UNIQUE_ID(),:ACCOUNT_ID,:DRIVER_ID,CURRENT_TIMESTAMP,
                                    :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                    1,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
        END

      END

    END

  END
END

--

CREATE OR ALTER PROCEDURE U_ORDER
(
  SESSION_ID VARCHAR(32),
  ORDER_ID VARCHAR(32),
  ACTION_ID VARCHAR(32),
  RATE_ID VARCHAR(32),
  CAR_TYPE_ID VARCHAR(32),
  WHO_ACCEPT_ID VARCHAR(32),
  STREET_ID VARCHAR(32),
  ZONE_ID VARCHAR(32),
  PARENT_ID VARCHAR(32),
  CAR_ID VARCHAR(32),
  WHO_PROCESS_ID VARCHAR(32),
  RESULT_ID VARCHAR(32),
  PARK_ID VARCHAR(32),
  SOURCE_ID VARCHAR(32),
  DISCOUNT_ID VARCHAR(32),
  DRIVER_ID VARCHAR(32),
  ORDER_NUM VARCHAR(10),
  PHONE VARCHAR(100),
  HOUSE VARCHAR(10),
  FLAT VARCHAR(10),
  PORCH VARCHAR(10),
  DATE_ACCEPT TIMESTAMP,
  DATE_ARRIVAL TIMESTAMP,
  DATE_BEGIN TIMESTAMP,
  DATE_END TIMESTAMP,
  CUSTOMER VARCHAR(250),
  DESCRIPTION VARCHAR(250),
  COST_RATE NUMERIC(18,2),
  COST_FACT NUMERIC(18,2),
  TYPE_ACCEPT INTEGER,
  TYPE_PROCESS INTEGER,
  DATE_HISTORY TIMESTAMP,
  WHO_HISTORY_ID VARCHAR(32),
  BEFORE_PERIOD INTEGER,
  FINISHED INTEGER,
  LOCKED VARCHAR(32),
  CLIENT_ID VARCHAR(32),
  COST_GROSS NUMERIC(18,2),
  FIRM_ID VARCHAR(32),
  OLD_ORDER_ID VARCHAR(32)
)
AS
  DECLARE RECIPIENT_ID VARCHAR(32);
  DECLARE OLD_COST_RATE NUMERIC(15,2);
  DECLARE S VARCHAR(70);
  DECLARE TYPE_MESSAGE INTEGER;
  DECLARE DEST_PORT INTEGER;
BEGIN
  IN AUTONOMOUS TRANSACTION DO BEGIN

    UPDATE ORDERS
       SET ORDER_ID=:ORDER_ID,
           ACTION_ID=:ACTION_ID,
           RATE_ID=:RATE_ID,
           CAR_TYPE_ID=:CAR_TYPE_ID,
           WHO_ACCEPT_ID=:WHO_ACCEPT_ID,
           STREET_ID=:STREET_ID,
           ZONE_ID=:ZONE_ID,
           PARENT_ID=:PARENT_ID,
           CAR_ID=:CAR_ID,
           WHO_PROCESS_ID=:WHO_PROCESS_ID,
           RESULT_ID=:RESULT_ID,
           PARK_ID=:PARK_ID,
           SOURCE_ID=:SOURCE_ID,
           DISCOUNT_ID=:DISCOUNT_ID,
           DRIVER_ID=:DRIVER_ID,
           ORDER_NUM=:ORDER_NUM,
           PHONE=:PHONE,
           HOUSE=:HOUSE,
           FLAT=:FLAT,
           PORCH=:PORCH,
           DATE_ACCEPT=:DATE_ACCEPT,
           DATE_ARRIVAL=:DATE_ARRIVAL,
           DATE_BEGIN=:DATE_BEGIN,
           DATE_END=:DATE_END,
           CUSTOMER=:CUSTOMER,
           DESCRIPTION=:DESCRIPTION,
           COST_RATE=:COST_RATE,
           COST_FACT=:COST_FACT,
           TYPE_ACCEPT=:TYPE_ACCEPT,
           TYPE_PROCESS=:TYPE_PROCESS,
           DATE_HISTORY=:DATE_HISTORY,
           WHO_HISTORY_ID=:WHO_HISTORY_ID,
           BEFORE_PERIOD=:BEFORE_PERIOD,
           FINISHED=:FINISHED,
           LOCKED=:LOCKED,
           CLIENT_ID=:CLIENT_ID,
           COST_GROSS=:COST_GROSS,
           FIRM_ID=:FIRM_ID
     WHERE ORDER_ID=:OLD_ORDER_ID;

  END

  EXECUTE PROCEDURE EVENT_REFRESH_ORDERS('A35F5701A7AA920E40812A71A690910D',NULL,SESSION_ID,0);

  OLD_COST_RATE=NULL;

  FOR SELECT COST_RATE
        FROM ORDERS
       WHERE PARENT_ID=:OLD_ORDER_ID
         AND DATE_HISTORY IS NOT NULL
       ORDER BY DATE_HISTORY DESC
        INTO :OLD_COST_RATE DO BEGIN

    IF (OLD_COST_RATE IS NOT NULL) THEN
      BREAK;

  END

  IF ((COST_RATE IS NOT NULL) AND (OLD_COST_RATE<>COST_RATE) AND (WHO_PROCESS_ID IS NOT NULL)) THEN BEGIN

    IF (SUBSTR(PHONE,1,3)='+79')  THEN BEGIN

      RECIPIENT_ID=NULL;

      FOR SELECT ACCOUNT_ID
            FROM ACCOUNTS
           WHERE PHONE=:PHONE
            INTO :RECIPIENT_ID DO BEGIN

        IF (RECIPIENT_ID IS NOT NULL) THEN
          BREAK;
      END

      SELECT CONST_VALUE FROM GET_CONST_VALUE('6F6E5F38806C896B43AC16E69914EFFA') INTO :S;

      EXECUTE PROCEDURE GET_TYPE_MESSAGE(RECIPIENT_ID,NULL)
       RETURNING_VALUES TYPE_MESSAGE, DEST_PORT;

      IF ((S IS NOT NULL) AND (TYPE_MESSAGE IS NOT NULL)) THEN BEGIN

        S=REPLACE_STRING(S,'%COST_RATE',CAST(COST_RATE AS VARCHAR(30)));

        INSERT INTO OUT_MESSAGES (OUT_MESSAGE_ID,CREATOR_ID,RECIPIENT_ID,DATE_CREATE,
                                  TEXT_OUT,DATE_OUT,TYPE_MESSAGE,CONTACT,DESCRIPTION,
                                  PRIORITY,LOCKED,DATE_BEGIN,ORDER_ID,DEST_PORT,FIRM_ID)
                          VALUES (GET_UNIQUE_ID(),:WHO_PROCESS_ID,:RECIPIENT_ID,CURRENT_TIMESTAMP,
                                  :S,NULL,:TYPE_MESSAGE,:PHONE,NULL,
                                  1,NULL,CURRENT_TIMESTAMP,:ORDER_ID,:DEST_PORT,:FIRM_ID);
      END

    END

  END

END

--

CREATE OR ALTER PROCEDURE U_OUT_MESSAGE
(
  OUT_MESSAGE_ID VARCHAR(32),
  CREATOR_ID VARCHAR(32),
  RECIPIENT_ID VARCHAR(32),
  DATE_CREATE TIMESTAMP,
  TEXT_OUT VARCHAR(4000),
  DATE_OUT TIMESTAMP,
  TYPE_MESSAGE INTEGER,
  CONTACT VARCHAR(100),
  DESCRIPTION VARCHAR(250),
  PRIORITY INTEGER,
  LOCKED VARCHAR(32),
  DATE_BEGIN TIMESTAMP,
  DATE_END TIMESTAMP,
  ORDER_ID VARCHAR(32),
  CHANNEL VARCHAR(100),
  DELIVERY INTEGER,
  DATE_DELIVERY TIMESTAMP,
  FLASH INTEGER,
  DEST_PORT INTEGER,
  FIRM_ID VARCHAR(32),
  OLD_OUT_MESSAGE_ID VARCHAR(32)
)
AS
BEGIN
  UPDATE OUT_MESSAGES
     SET OUT_MESSAGE_ID=:OUT_MESSAGE_ID,
         CREATOR_ID=:CREATOR_ID,
         RECIPIENT_ID=:RECIPIENT_ID,
         DATE_CREATE=:DATE_CREATE,
         TEXT_OUT=:TEXT_OUT,
         DATE_OUT=:DATE_OUT,
         TYPE_MESSAGE=:TYPE_MESSAGE,
         CONTACT=:CONTACT,
         DESCRIPTION=:DESCRIPTION,
         PRIORITY=:PRIORITY,
         LOCKED=:LOCKED,
         DATE_BEGIN=:DATE_BEGIN,
         DATE_END=:DATE_END,
         ORDER_ID=:ORDER_ID,
         CHANNEL=:CHANNEL,
         DELIVERY=:DELIVERY,
         DATE_DELIVERY=:DATE_DELIVERY,
         FLASH=:FLASH,
         DEST_PORT=:DEST_PORT,
         FIRM_ID=:FIRM_ID
   WHERE OUT_MESSAGE_ID=:OLD_OUT_MESSAGE_ID;
END

--

ALTER TABLE IN_MESSAGES
ADD FIRM_ID VARCHAR(32)

--

ALTER TABLE IN_MESSAGES
ADD FOREIGN KEY (FIRM_ID) REFERENCES FIRMS (FIRM_ID)

--

CREATE OR ALTER VIEW S_IN_MESSAGES
(
    IN_MESSAGE_ID,
    SENDER_ID,
    CODE_MESSAGE_ID,
    DATE_SEND,
    TEXT_IN,
    DATE_IN,
    TYPE_MESSAGE,
    CONTACT,
    ORDER_ID,
    CHANNEL,
    DESCRIPTION,
    FIRM_ID,
    SENDER_USER_NAME,
    SENDER_SURNAME,
    SENDER_NAME,
    SENDER_PATRONYMIC,
    CODE,
    FIRM_SMALL_NAME
)
AS
SELECT IM.*,
       A.USER_NAME AS SENDER_USER_NAME,
       A.SURNAME AS SENDER_SURNAME,
       A.NAME AS SENDER_NAME,
       A.PATRONYMIC AS SENDER_PATRONYMIC,
       CM.CODE,
       F.SMALL_NAME AS FIRM_SMALL_NAME
  FROM IN_MESSAGES IM
  LEFT JOIN ACCOUNTS A ON A.ACCOUNT_ID=IM.SENDER_ID
  LEFT JOIN CODE_MESSAGES CM ON CM.CODE_MESSAGE_ID=IM.CODE_MESSAGE_ID
  LEFT JOIN FIRMS F ON F.FIRM_ID=IM.FIRM_ID

--

CREATE OR ALTER VIEW S_DRIVER_IN_MESSAGES
(
    IN_MESSAGE_ID,
    SENDER_ID,
    CODE_MESSAGE_ID,
    DATE_SEND,
    TEXT_IN,
    DATE_IN,
    TYPE_MESSAGE,
    CONTACT,
    ORDER_ID,
    CHANNEL,
    DESCRIPTION,
    FIRM_ID,
    SENDER_USER_NAME,
    SENDER_SURNAME,
    SENDER_NAME,
    SENDER_PATRONYMIC,
    CODE,
    CAR_STATE_NUM,
    CAR_BRAND,
    CAR_COLOR,
    CAR_CALLSIGN,
    FIRM_SMALL_NAME
)
AS
SELECT IM.*,
       A.USER_NAME AS SENDER_USER_NAME,
       A.SURNAME AS SENDER_SURNAME,
       A.NAME AS SENDER_NAME,
       A.PATRONYMIC AS SENDER_PATRONYMIC,
       CM.CODE,
       CR.STATE_NUM AS CAR_STATE_NUM,
       CR.BRAND AS CAR_BRAND,
       CR.COLOR AS CAR_COLOR,
       CR.CALLSIGN AS CAR_CALLSIGN,
       F.SMALL_NAME AS FIRM_SMALL_NAME
  FROM IN_MESSAGES IM
  JOIN DRIVERS D ON D.DRIVER_ID=IM.SENDER_ID
  JOIN CARS CR ON CR.CAR_ID=D.CAR_ID
  LEFT JOIN ACCOUNTS A ON A.ACCOUNT_ID=IM.SENDER_ID
  LEFT JOIN CODE_MESSAGES CM ON CM.CODE_MESSAGE_ID=IM.CODE_MESSAGE_ID
  LEFT JOIN FIRMS F ON F.FIRM_ID=IM.FIRM_ID

--

CREATE OR ALTER PROCEDURE I_IN_MESSAGE
(
  IN_MESSAGE_ID VARCHAR(32),
  SENDER_ID VARCHAR(32),
  CODE_MESSAGE_ID VARCHAR(32),
  DATE_SEND TIMESTAMP,
  TEXT_IN VARCHAR(4000),
  DATE_IN TIMESTAMP,
  TYPE_MESSAGE INTEGER,
  CONTACT VARCHAR(100),
  ORDER_ID VARCHAR(32),
  CHANNEL VARCHAR(100),
  DESCRIPTION VARCHAR(250),
  FIRM_ID VARCHAR(32)
)
AS
DECLARE CNT INTEGER;
BEGIN
  IF (DATE_IN IS NULL) THEN BEGIN
    DATE_IN=CURRENT_TIMESTAMP;
  END

  IF (SENDER_ID IS NOT NULL) THEN BEGIN

    IF (FIRM_ID IS NOT NULL) THEN BEGIN

      SELECT COUNT(*)
        FROM CLIENTS
       WHERE CLIENT_ID=:SENDER_ID
        INTO :CNT;

      IF (CNT>0) THEN
        FIRM_ID=NULL; /* Не понятно чьё сообщение */

    END

  END

  INSERT INTO IN_MESSAGES (IN_MESSAGE_ID,SENDER_ID,CODE_MESSAGE_ID,DATE_SEND,
                           TEXT_IN,DATE_IN,TYPE_MESSAGE,CONTACT,ORDER_ID,CHANNEL,
                           DESCRIPTION,FIRM_ID)
       VALUES (:IN_MESSAGE_ID,:SENDER_ID,:CODE_MESSAGE_ID,:DATE_SEND,
               :TEXT_IN,:DATE_IN,:TYPE_MESSAGE,:CONTACT,:ORDER_ID,:CHANNEL,
               :DESCRIPTION,:FIRM_ID);
END

--

CREATE OR ALTER PROCEDURE U_IN_MESSAGE
(
  IN_MESSAGE_ID VARCHAR(32),
  SENDER_ID VARCHAR(32),
  CODE_MESSAGE_ID VARCHAR(32),
  DATE_SEND TIMESTAMP,
  TEXT_IN VARCHAR(4000),
  DATE_IN TIMESTAMP,
  TYPE_MESSAGE INTEGER,
  CONTACT VARCHAR(100),
  ORDER_ID VARCHAR(32),
  CHANNEL VARCHAR(100),
  DESCRIPTION VARCHAR(250),
  FIRM_ID VARCHAR(32),
  OLD_IN_MESSAGE_ID VARCHAR(32)
)
AS
BEGIN
  UPDATE IN_MESSAGES
     SET IN_MESSAGE_ID=:IN_MESSAGE_ID,
         SENDER_ID=:SENDER_ID,
         CODE_MESSAGE_ID=:CODE_MESSAGE_ID,
         DATE_SEND=:DATE_SEND,
         TEXT_IN=:TEXT_IN,
         DATE_IN=:DATE_IN,
         TYPE_MESSAGE=:TYPE_MESSAGE,
         CONTACT=:CONTACT,
         ORDER_ID=:ORDER_ID,
         CHANNEL=:CHANNEL,
         DESCRIPTION=:DESCRIPTION,
         FIRM_ID=:FIRM_ID
   WHERE IN_MESSAGE_ID=:OLD_IN_MESSAGE_ID;
END

--












-----------------------------------------

/* Создание таблицы вызовов */

CREATE TABLE CALLS
(
  CALL_ID VARCHAR(32) NOT NULL,
  LINE_ID VARCHAR(32) NOT NULL,
  CALL_TYPE INTEGER NOT NULL,
  CREATOR_ID VARCHAR(32) NOT NULL,
  DATE_CREATE TIMESTAMP NOT NULL,
  CALLER_ID VARCHAR(32),
  CALLER_PHONE VARCHAR(100),
  ACCEPTOR_ID VARCHAR(32),
  ACCEPTOR_PHONE VARCHAR(100),
  DATE_BEGIN TIMESTAMP,
  END_TYPE INTEGER,
  DATE_END TIMESTAMP,
  DATA_FORMAT VARCHAR(),
  DATA BLOB,
  PLACE INTEGER,
  PRIMARY KEY (CALL_ID,LINE_ID),
  FOREIGN KEY (CREATOR_ID) REFERENCES ACCOUNTS (ACCOUNT_ID),
  FOREIGN KEY (CALLER_ID) REFERENCES ACCOUNTS (ACCOUNT_ID),
  FOREIGN KEY (ACCEPTOR_ID) REFERENCES ACCOUNTS (ACCOUNT_ID)
)

--

/* Создание просмотра вызовов */

CREATE VIEW S_CALLS
(
  CALL_ID,
  LINE_ID,
  CALL_TYPE,
  CREATOR_ID,
  DATE_CREATE,
  CALLER_ID,
  CALLER_PHONE,
  ACCEPTOR_ID,
  ACCEPTOR_PHONE,
  DATE_BEGIN,
  DATE_END,
  END_TYPE,
  DATA_TYPE,
  DATA,
  PLACE,
  CREATOR_NAME,
  CALLER_NAME,
  ACCEPTOR_NAME
)
AS
SELECT C.*,
       A1.USER_NAME AS CREATOR_NAME,
       A2.USER_NAME AS CALLER_NAME,
       A3.USER_NAME AS ACCEPTOR_NAME
  FROM CALLS C
  JOIN ACCOUNTS A1 ON A1.ACCOUNT_ID=C.CREATOR_ID
  LEFT JOIN ACCOUNTS A2 ON A2.ACCOUNT_ID=C.CALLER_ID
  LEFT JOIN ACCOUNTS A3 ON A3.ACCOUNT_ID=C.ACCEPTOR_ID

--

/* Создание процедуры добавления вызова */

CREATE OR ALTER PROCEDURE I_CALL
(
  CALL_ID VARCHAR(32),
  LINE_ID VARCHAR(32),
  CALL_TYPE INTEGER,
  CREATOR_ID VARCHAR(32),
  DATE_CREATE TIMESTAMP,
  CALLER_ID VARCHAR(32),
  CALLER_PHONE VARCHAR(100),
  ACCEPTOR_ID VARCHAR(32),
  ACCEPTOR_PHONE VARCHAR(100),
  DATE_BEGIN TIMESTAMP,
  DATE_END TIMESTAMP,
  END_TYPE INTEGER,
  DATA_TYPE INTEGER,
  DATA BLOB,
  PLACE INTEGER
)
AS
BEGIN
  INSERT INTO CALLS (CALL_ID,LINE_ID,CALL_TYPE,CREATOR_ID,DATE_CREATE,
                     CALLER_ID,CALLER_PHONE,ACCEPTOR_ID,ACCEPTOR_PHONE,
                     DATE_BEGIN,DATE_END,END_TYPE,DATA,DATA_TYPE,PLACE)
       VALUES (:CALL_ID,:LINE_ID,:CALL_TYPE,:CREATOR_ID,:DATE_CREATE,
               :CALLER_ID,:CALLER_PHONE,:ACCEPTOR_ID,:ACCEPTOR_PHONE,
               :DATE_BEGIN,:DATE_END,:END_TYPE,:DATA,:DATA_TYPE,:PLACE);
END

--

/* Создание процедуры изменения вызова */

CREATE OR ALTER PROCEDURE U_CALL
(
  CALL_ID VARCHAR(32),
  LINE_ID VARCHAR(32),
  CALL_TYPE INTEGER,
  CREATOR_ID VARCHAR(32),
  DATE_CREATE TIMESTAMP,
  CALLER_ID VARCHAR(32),
  CALLER_PHONE VARCHAR(100),
  ACCEPTOR_ID VARCHAR(32),
  ACCEPTOR_PHONE VARCHAR(100),
  DATE_BEGIN TIMESTAMP,
  DATE_END TIMESTAMP,
  END_TYPE INTEGER,
  DATA BLOB,
  DATA_TYPE INTEGER,
  PLACE INTEGER,
  OLD_CALL_ID VARCHAR(32),
  OLD_LINE_ID VARCHAR(32)
)
AS
BEGIN
  UPDATE CALLS
     SET CALL_ID=:CALL_ID,
         LINE_ID=:LINE_ID,
         CALL_TYPE=:CALL_TYPE,
         CREATOR_ID=:CREATOR_ID,
         DATE_CREATE=:DATE_CREATE,
         CALLER_ID=:CALLER_ID,
         CALLER_PHONE=:CALLER_PHONE,
         ACCEPTOR_ID=:ACCEPTOR_ID,
         ACCEPTOR_PHONE=:ACCEPTOR_PHONE,
         DATE_BEGIN=:DATE_BEGIN,
         DATE_END=:DATE_END,
         END_TYPE=:END_TYPE,
         DATA=:DATA,
         DATA_TYPE=:DATA_TYPE,
         PLACE=:PLACE
   WHERE CALL_ID=:OLD_CALL_ID
     AND LINE_ID=:OLD_LINE_ID;
END

--

/* Создание процедуры удаления вызова */

CREATE OR ALTER PROCEDURE D_CALL
(
  OLD_CALL_ID VARCHAR(32),
  OLD_LINE_ID VARCHAR(32)
)
AS
BEGIN
  DELETE FROM CALLS
        WHERE CALL_ID=:OLD_CALL_ID
          AND LINE_ID=:OLD_LINE_ID;
END;

--

CREATE OR ALTER PROCEDURE GET_CALL_PARAMS
(
  SESSION_ID VARCHAR(32),
  PROTOCOL INTEGER
)
RETURNS
(
  CLIENT_IP VARCHAR(20),
  CLIENT_PORT VARCHAR(10),
  CLIENT_LISTEN_IP VARCHAR(20),
  CLIENT_HOST VARCHAR(100),
  CLIENT_PATH VARCHAR(100),
  CLIENT_USE_CRYPTER INTEGER,
  CLIENT_CRYPTER_ALGORITHM INTEGER,
  CLIENT_CRYPTER_MODE INTEGER,
  CLIENT_CRYPTER_KEY VARCHAR(100),
  CLIENT_USE_COMPRESSOR INTEGER,
  CLIENT_COMPRESSOR_LEVEL INTEGER,
  SERVER_IP VARCHAR(20),
  SERVER_PORT VARCHAR(10),
  SERVER_LISTEN_IP VARCHAR(20),
  SERVER_HOST VARCHAR(100),
  SERVER_PATH VARCHAR(100),
  SERVER_USE_CRYPTER INTEGER,
  SERVER_CRYPTER_ALGORITHM INTEGER,
  SERVER_CRYPTER_MODE INTEGER,
  SERVER_CRYPTER_KEY VARCHAR(100),
  SERVER_USE_COMPRESSOR INTEGER,
  SERVER_COMPRESSOR_LEVEL INTEGER
)
AS
BEGIN

  EXECUTE PROCEDURE GET_EVENT_PARAMS (SESSION_ID,PROTOCOL)
   RETURNING_VALUES CLIENT_IP, CLIENT_PORT, CLIENT_LISTEN_IP, CLIENT_HOST, CLIENT_PATH,
                    CLIENT_USE_CRYPTER, CLIENT_CRYPTER_ALGORITHM, CLIENT_CRYPTER_MODE,
                    CLIENT_CRYPTER_KEY, CLIENT_USE_COMPRESSOR, CLIENT_COMPRESSOR_LEVEL;

  FOR SELECT IP, PORT, LISTEN_IP, HOST, PATH,
             USE_CRYPTER, CRYPTER_ALGORITHM, CRYPTER_MODE,
             CRYPTER_KEY, USE_COMPRESSOR, COMPRESSOR_LEVEL
        FROM GET_EVENT_SESSIONS (0,'750E719A91AD99E64229AB86C291E3EE',NULL,:PROTOCOL)
        INTO SERVER_IP, SERVER_PORT, SERVER_LISTEN_IP, SERVER_HOST, SERVER_PATH,
             SERVER_USE_CRYPTER, SERVER_CRYPTER_ALGORITHM, SERVER_CRYPTER_MODE,
             SERVER_CRYPTER_KEY, SERVER_USE_COMPRESSOR, SERVER_COMPRESSOR_LEVEL DO BEGIN
             
    BREAK;
  END

END

--

CREATE OR ALTER PROCEDURE EVENT_CALL_INVITE
(
  APPLICATION_ID VARCHAR(32),
  PROTOCOL INTEGER,
  SESSION_ID VARCHAR(32),
  LINE_ID VARCHAR(32),
  CLIENT_PORT INTEGER,
  CALL_TYPE INTEGER,
  CREATOR_ID VARCHAR(32),
  CALLER_ID VARCHAR(32),
  CALLER_PHONE VARCHAR(100),
  ACCEPTOR VARCHAR(100),
  ACCEPTOR_TYPE INTEGER
)
AS
DECLARE TEMP INTEGER;
DECLARE SECTION VARCHAR(100);
DECLARE IN_PARAMS BLOB;
BEGIN
  SECTION='A6F419FB25B7BDB94FEEA83F5BDE0B95';

  IN_PARAMS=CONFIG_WRITE(IN_PARAMS,SECTION,'SessionId',SESSION_ID);
  IN_PARAMS=CONFIG_WRITE(IN_PARAMS,SECTION,'LineId',LINE_ID);
  IN_PARAMS=CONFIG_WRITE(IN_PARAMS,SECTION,'ClientPort',CAST(CLIENT_PORT AS VARCHAR(10)));
  IN_PARAMS=CONFIG_WRITE(IN_PARAMS,SECTION,'CallType',CAST(CALL_TYPE AS VARCHAR(10)));
  IN_PARAMS=CONFIG_WRITE(IN_PARAMS,SECTION,'CreatorId',CREATOR_ID);
  IN_PARAMS=CONFIG_WRITE(IN_PARAMS,SECTION,'CallerId',CALLER_ID);
  IN_PARAMS=CONFIG_WRITE(IN_PARAMS,SECTION,'CallerPhone',CALLER_PHONE);
  IN_PARAMS=CONFIG_WRITE(IN_PARAMS,SECTION,'Acceptor',ACCEPTOR);
  IN_PARAMS=CONFIG_WRITE(IN_PARAMS,SECTION,'AcceptorType',ACCEPTOR_TYPE);

  FOR SELECT SUCCESS
       FROM SEND_EVENT(0,1,:APPLICATION_ID,NULL,NULL,:SESSION_ID,:PROTOCOL,:SECTION,:IN_PARAMS)
       INTO :TEMP DO BEGIN
    BREAK;
  END
END

--

CREATE OR ALTER PROCEDURE CALL_INVITE
(
  SESSION_ID VARCHAR(32),
  LINE_ID VARCHAR(32),
  CLIENT_PORT INTEGER,
  CALL_TYPE INTEGER,
  CALLER_ID VARCHAR(32),
  CALLER_PHONE VARCHAR(100),
  ACCEPTOR VARCHAR(100),
  ACCEPTOR_TYPE INTEGER
)
RETURNS
(
  SERVER_HOST VARCHAR(100)
)
AS
DECLARE CREATOR_ID VARCHAR(32);
DECLARE APPLICATION_ID VARCHAR(32)='750E719A91AD99E64229AB86C291E3EE';
BEGIN

  SELECT ACCOUNT_ID
    FROM SESSIONS
   WHERE SESSION_ID=:SESSION_ID
    INTO :CREATOR_ID;

  IF (CALLER_ID IS NULL) THEN BEGIN

    IF (CALLER_PHONE IS NOT NULL) THEN BEGIN

      FOR SELECT C.CLIENT_ID
            FROM CLIENTS C
            JOIN ACCOUNTS A ON A.ACCOUNT_ID=C.CLIENT_ID
           WHERE A.PHONE=:CALLER_PHONE
            INTO :CALLER_ID DO BEGIN
        IF (CALLER_ID IS NOT NULL) THEN
          BREAK;
      END

      IF (CALLER_ID IS NULL) THEN BEGIN

        FOR SELECT D.DRIVER_ID
              FROM DRIVERS D
              JOIN ACCOUNTS A ON A.ACCOUNT_ID=D.DRIVER_ID
             WHERE A.PHONE=:CALLER_PHONE
              INTO :CALLER_ID DO BEGIN
          IF (CALLER_ID IS NOT NULL) THEN
            BREAK;
        END

      END

    END

    IF (CALLER_ID IS NULL) THEN
      CALLER_ID=CREATOR_ID;

  END

  FOR SELECT HOST
        FROM GET_EVENT_SESSIONS(0,:APPLICATION_ID,NULL,0)
        INTO :SERVER_HOST DO BEGIN
    BREAK;
  END

  IF (SERVER_HOST IS NOT NULL) THEN BEGIN

    EXECUTE PROCEDURE EVENT_CALL_INVITE(APPLICATION_ID,0,
                                        SESSION_ID,LINE_ID,CLIENT_PORT,CALL_TYPE,CREATOR_ID,
                                        CALLER_ID,CALLER_PHONE,ACCEPTOR,ACCEPTOR_TYPE);

  END

END;

--

--- END-------------------------

