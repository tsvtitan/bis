unit BisTaxiDriverInMessagesFm;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, StdCtrls, ExtCtrls, ComCtrls, BisFm, ActnList, DB,
  BisDataFrm, BisDataGridFrm, BisDataGridFm, BisFieldNames;

type
  TBisTaxiDriverInMessagesFrame=class(TBisDataGridFrame)
  private
    function GetNewSenderName(FieldName: TBisFieldName; DataSet: TDataSet): Variant;
  public
    constructor Create(AOwner: TComponent); override;
  end;

  TBisTaxiDriverInMessagesForm = class(TBisDataGridForm)
  protected
    class function GetDataFrameClass: TBisDataFrameClass; override;
  end;

  TBisTaxiDriverInMessagesFormIface=class(TBisDataGridFormIface)
  public
    constructor Create(AOwner: TComponent); override;
  end;

var
  BisTaxiDriverInMessagesForm: TBisTaxiDriverInMessagesForm;

implementation

{$R *.dfm}

uses DateUtils,
     BisUtils, BisConsts, BisVariants, BisOrders, BisCore, BisFilterGroups;

{ TBisTaxiDriverInMessagesFrame }

constructor TBisTaxiDriverInMessagesFrame.Create(AOwner: TComponent);
var
  D: TDateTime;
begin
  inherited Create(AOwner);

  FilterClass:=nil;
  InsertClass:=nil;
  UpdateClass:=nil;
  DeleteClass:=nil;
  with Provider do begin
    ProviderName:='S_DRIVER_IN_MESSAGES';
    with FieldNames do begin
      AddKey('IN_MESSAGE_ID');
      AddInvisible('SENDER_ID');
      AddInvisible('SENDER_NAME');
      AddInvisible('CODE_MESSAGE_ID');
      AddInvisible('CODE');
      AddInvisible('TYPE_MESSAGE');
      AddInvisible('CAR_CALLSIGN');
      Add('DATE_IN','Дата получения',110);
      Add('TEXT_IN','Текст сообщения',100);
      Add('DATE_SEND','Дата отправки',110);
      Add('CONTACT','Контакт',100);
      AddCalculate('NEW_SENDER_NAME','Водитель',GetNewSenderName,ftString,150,100);
      Add('CAR_COLOR','Цвет автомобиля',80);
      Add('CAR_BRAND','Марка автомобиля',80);
      Add('CAR_STATE_NUM','Гос. номер автомобиля',80);
      
    end;
    Orders.Add('DATE_IN',otDesc);
  end;

  D:=Core.ServerDate;

  with CreateFilterMenuItem('Сегодня') do begin
    with FilterGroups.AddVisible do begin
      Filters.Add('DATE_IN',fcEqualGreater,DateOf(D));
      Filters.Add('DATE_IN',fcLess,IncDay(DateOf(D)));
    end;
    Checked:=true;
  end;

  with CreateFilterMenuItem('Архив') do begin
    FilterGroups.AddVisible.Filters.Add('DATE_IN',fcLess,DateOf(D));
  end;

end;

function TBisTaxiDriverInMessagesFrame.GetNewSenderName(FieldName: TBisFieldName; DataSet: TDataSet): Variant;
var
  S1, S2: String;
begin
  Result:=Null;
  if DataSet.Active and not DataSet.IsEmpty then begin
    S1:=DataSet.FieldByName('SENDER_NAME').AsString;
    S2:=DataSet.FieldByName('CAR_CALLSIGN').AsString;
    Result:=FormatEx('%s - %s',[S2,S1]);
    if Trim(Result)='-' then
      Result:=Null;
  end;
end;

{ TBisTaxiDriverInMessagesFormIface }

constructor TBisTaxiDriverInMessagesFormIface.Create(AOwner: TComponent);
begin
  inherited Create(AOwner);
  FormClass:=TBisTaxiDriverInMessagesForm;
  Permissions.Enabled:=true;
  Available:=true;
  ChangeFrameProperties:=false;
end;

{ TBisTaxiDriverInMessagesForm }

class function TBisTaxiDriverInMessagesForm.GetDataFrameClass: TBisDataFrameClass;
begin
  Result:=TBisTaxiDriverInMessagesFrame;
end;

end.
